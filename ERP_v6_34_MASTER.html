<!--
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                                                                                          â•‘
â•‘   ERP EMEUTRANS - SISTEMA INTEGRADO DE GESTÃƒO LOGÃSTICA GLOBAL                           â•‘
â•‘   VersÃ£o: 6.34 MASTER                                                                    â•‘
â•‘   Data CriaÃ§Ã£o: 20/12/2024                                                               â•‘
â•‘   Ãšltima ActualizaÃ§Ã£o: 23/12/2024                                                        â•‘
â•‘                                                                                          â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                                                          â•‘
â•‘   ğŸ†• ALTERAÃ‡Ã•ES v6.34 (23/12/2024) - VERSÃƒO ESTÃVEL TESTADA:                             â•‘
â•‘   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                        â•‘
â•‘                                                                                          â•‘
â•‘   ğŸ“‹ FATURAÃ‡ÃƒO AUTOMÃTICA:                                                               â•‘
â•‘   âœ… Trigger C52 chamado apÃ³s guardar CMR em Base64                                      â•‘
â•‘   âœ… processarCMRAnexado procura em erpReservasExecutadas PRIMEIRO                       â•‘
â•‘   âœ… Busca de cliente melhorada (clienteId + clienteNumero + numero)                     â•‘
â•‘   âœ… AtualizaÃ§Ã£o de erpReservasExecutadas apÃ³s criar fatura                              â•‘
â•‘                                                                                          â•‘
â•‘   ğŸ“Š REGRAS DE IVA:                                                                      â•‘
â•‘   âœ… IVA calculado com obterRegraIVA() baseado nos LOCAIS de carga/descarga              â•‘
â•‘   âœ… PT â†’ PT = 23% IVA                                                                   â•‘
â•‘   âœ… PT â†’ EUR (Espanha, FranÃ§a, etc.) = 0% IVA Isento                                    â•‘
â•‘   âœ… Artigo de isenÃ§Ã£o preenchido automaticamente                                        â•‘
â•‘                                                                                          â•‘
â•‘   ğŸ“§ EMAIL ENVIADO:                                                                      â•‘
â•‘   âœ… emailEnviado guardado em TODAS as fontes (erpReservasExecutadas, erpReservas, etc.) â•‘
â•‘   âœ… Coluna "Email Enviado" mostra âœ… corretamente apÃ³s envio                            â•‘
â•‘                                                                                          â•‘
â•‘   ğŸ‘¤ FICHA DE CLIENTE:                                                                   â•‘
â•‘   âœ… Clicar no nome do cliente abre ficha REAL (clientesVerFichaCompleta)                â•‘
â•‘   âœ… Aceita clienteId como string ('C0001') ou nÃºmero                                    â•‘
â•‘                                                                                          â•‘
â•‘   ğŸ§¹ MANUTENÃ‡ÃƒO LOCALSTORAGE:                                                            â•‘
â•‘   âœ… BotÃ£o "Limpar TODO o LocalStorage" - apaga tudo                                     â•‘
â•‘   âœ… BotÃ£o "Limpar SÃ³ Reservas" - mantÃ©m clientes                                        â•‘
â•‘   âœ… BotÃ£o "Limpar Ficheiros CMR" - liberta espaÃ§o                                       â•‘
â•‘   âœ… BotÃ£o "Ver EspaÃ§o Usado" - diagnÃ³stico de uso                                       â•‘
â•‘                                                                                          â•‘
â•‘   ğŸ§ª DADOS DE TESTE INCLUÃDOS:                                                           â•‘
â•‘   â†’ C0001 (Manual): Lisboaâ†’Porto (23%) + Portoâ†’Madrid (0%)                               â•‘
â•‘   â†’ C0002 (AutomÃ¡tica): SetÃºbalâ†’Lisboa (23%) + Lisboaâ†’Paris (0%)                         â•‘
â•‘   â†’ C0003 (Manual): Portoâ†’Braga (23%) + Bragaâ†’Barcelona (0%)                             â•‘
â•‘   â†’ C0004 (Manual): Coimbraâ†’Aveiro (23%) + Aveiroâ†’BordÃ©us (0%)                            â•‘
â•‘                                                                                          â•‘
â•‘   ğŸ†• ALTERAÃ‡Ã•ES v6.33 (23/12/2024) - CORREÃ‡Ã•ES VISUAIS E DOWNLOAD:                       â•‘
â•‘   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                        â•‘
â•‘   âœ… CORRIGIDO: Badge verde agora aparece JUNTO ao campo (nÃ£o em baixo)                  â•‘
â•‘   âœ… CORRIGIDO: Abrir ficheiro agora faz DOWNLOAD (nÃ£o abre em branco)                   â•‘
â•‘   âœ… MELHORADO: Badge mostra na mesma linha do campo CMR                                 â•‘
â•‘                                                                                          â•‘
â•‘   ğŸ†• ALTERAÃ‡Ã•ES v6.32 (23/12/2024) - FICHEIROS PERSISTENTES:                             â•‘
â•‘   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                        â•‘
â•‘   âœ… Ficheiros CMR guardados em Base64 no localStorage                                   â•‘
â•‘   âœ… Ficheiros persistem entre sessÃµes                                                   â•‘
â•‘                                                                                          â•‘
â•‘   ğŸ†• ALTERAÃ‡Ã•ES v6.31 (23/12/2024) - LIMPEZA DE DADOS:                                   â•‘
â•‘   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                        â•‘
â•‘   âœ… BotÃ£o "Limpar CMRs" para corrigir dados corrompidos                                 â•‘
â•‘   âœ… Badges verde/laranja para indicar estado do ficheiro                                â•‘
â•‘                                                                                          â•‘
â•‘   ğŸ†• ALTERAÃ‡Ã•ES v6.28 (23/12/2024) - VERSÃƒO SIMPLES:                                     â•‘
â•‘   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                        â•‘
â•‘   âœ… ficheiroAnexado() completamente reescrita - FUNÃ‡ÃƒO AUTO-CONTIDA                     â•‘
â•‘      - NÃƒO chama nenhuma outra funÃ§Ã£o (processarCMRAnexado removida)                     â•‘
â•‘      - NÃƒO usa arrays em memÃ³ria (reservas, todasReservas)                               â•‘
â•‘      - Vai DIRETAMENTE ao localStorage                                                   â•‘
â•‘      - Usa comparaÃ§Ã£o ESTRITA (===) do nÃºmero da reserva                                 â•‘
â•‘      - Usa break para sair do loop apÃ³s encontrar                                        â•‘
â•‘   âœ… guardarReservaAtual() corrigida para PRESERVAR campos CMR                           â•‘
â•‘      - Campos cmrCarga, cmrDescarga nÃ£o sÃ£o perdidos ao guardar                          â•‘
â•‘      - Todos os campos de faturaÃ§Ã£o sÃ£o preservados                                      â•‘
â•‘                                                                                          â•‘
â•‘   ğŸ†• ALTERAÃ‡Ã•ES v6.23 (23/12/2024):                                                      â•‘
â•‘   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                        â•‘
â•‘   âœ… CORREÃ‡ÃƒO: Regras IVA conforme Excel do Ruben                                        â•‘
â•‘      â†’ Cliente PT + EURâ†’EUR = 23% (estava 0%, agora corrigido)                           â•‘
â•‘      â†’ ResÃ­duos EURâ†’EUR = 6% (estava correto)                                            â•‘
â•‘   âœ… CORREÃ‡ÃƒO: DetecÃ§Ã£o de zonas IVA melhorada                                           â•‘
â•‘      â†’ Lista expandida com 100+ cidades/regiÃµes europeias                                â•‘
â•‘      â†’ PTâ†’EUR agora detecta corretamente Espanha, FranÃ§a, etc = 0% IVA                   â•‘
â•‘      â†’ Cidades como Vizcaya, Vitoria, Barcelona detectadas como EUR                      â•‘
â•‘   âœ… CORREÃ‡ÃƒO: FunÃ§Ã£o emitirFatura robusta                                               â•‘
â•‘      â†’ Procura cliente em mÃºltiplas fontes                                               â•‘
â•‘      â†’ Usa tipoCliente default '21111' se nÃ£o existir                                    â•‘
â•‘      â†’ Trata campos undefined sem erros                                                  â•‘
â•‘   âœ… CORREÃ‡ÃƒO: CMR anexado apenas Ã  reserva especÃ­fica                                   â•‘
â•‘      â†’ CMR Carga/Descarga sÃ³ Ã© adicionado Ã  reserva que estÃ¡ aberta                      â•‘
â•‘      â†’ NÃ£o afeta outras reservas (bug anterior corrigido)                                â•‘
â•‘      â†’ Usa ID E nÃºmero exactos para identificar a reserva                                â•‘
â•‘   âœ… CORREÃ‡ÃƒO: Regra de envio de emails com faturas                                      â•‘
â•‘      â†’ Email sÃ³ Ã© enviado quando TODAS as reservas da fatura tÃªm CMR Descarga            â•‘
â•‘      â†’ Se fatura tem 2 reservas, sÃ³ envia quando as 2 tiverem CMR                        â•‘
â•‘      â†’ Mostra progresso: "2/3 CMRs recebidos, aguardando mais 1"                         â•‘
â•‘   âœ… CORREÃ‡ÃƒO: Campo NÂº Reserva na fatura alargado                                       â•‘
â•‘      â†’ Largura 12% para caber "2025-10000"                                               â•‘
â•‘   âœ… CORREÃ‡ÃƒO: Campos da fatura correspondem aos da reserva                              â•‘
â•‘      â†’ Adicionados campos DescriÃ§Ã£o e NÂº Bultos                                          â•‘
â•‘                                                                                          â•‘
â•‘   ğŸ†• ALTERAÃ‡Ã•ES v6.22 (23/12/2024):                                                      â•‘
â•‘   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                        â•‘
â•‘   âœ… CORREÃ‡ÃƒO: Peso Ã© INDICATIVO - nÃ£o obriga â‚¬/TON                                      â•‘
â•‘      â†’ Campo valor sempre editÃ¡vel (peso Ã© sÃ³ informaÃ§Ã£o)                                â•‘
â•‘      â†’ Se Peso + â‚¬/TON preenchidos â†’ calcula automaticamente                             â•‘
â•‘      â†’ Se sÃ³ valor preenchido â†’ usa valor direto                                         â•‘
â•‘   âœ… CORREÃ‡ÃƒO: Coluna Reserva/CMR alargada na fatura (10% vs 8%)                         â•‘
â•‘      â†’ Cabe "2025-10000" (5 dÃ­gitos)                                                     â•‘
â•‘      â†’ NÃºmero sem "RES-" (jÃ¡ estÃ¡ no cabeÃ§alho)                                          â•‘
â•‘   âœ… CORREÃ‡ÃƒO: BotÃ£o PrÃ©-visualizar funciona corretamente                                â•‘
â•‘      â†’ Procura cliente em mÃºltiplas fontes                                               â•‘
â•‘      â†’ Usa dados do formulÃ¡rio se cliente nÃ£o encontrado                                 â•‘
â•‘   âœ… CORREÃ‡ÃƒO: Regras IVA expandidas para destino Fora UE                                â•‘
â•‘      â†’ PTâ†’FORA_UE = 0% (Isento)                                                          â•‘
â•‘      â†’ EURâ†’FORA_UE = 0% (Isento)                                                         â•‘
â•‘      â†’ Todas combinaÃ§Ãµes com FORA_UE adicionadas                                         â•‘
â•‘   âœ… CORREÃ‡ÃƒO: Grid linhas fatura ajustado para novos tamanhos                           â•‘
â•‘                                                                                          â•‘
â•‘   ğŸ†• ALTERAÃ‡Ã•ES v6.21 (23/12/2024):                                                      â•‘
â•‘   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                        â•‘
â•‘   âœ… CORREÃ‡ÃƒO CRÃTICA: Dados de TESTE jÃ¡ nÃ£o sÃ£o misturados com reservas reais           â•‘
â•‘      â†’ PrÃ©-FaturaÃ§Ã£o e faturarSelecionadas usam APENAS localStorage                      â•‘
â•‘      â†’ Array 'reservas' (dados de teste) Ã© ignorado                                      â•‘
â•‘   âœ… REGRA DE IVA IMPLEMENTADA: NÃ£o pode misturar COM IVA e SEM IVA                      â•‘
â•‘      â†’ toggleReserva() verifica regime de IVA baseado no local de descarga               â•‘
â•‘      â†’ Portugal = COM_IVA (23%), Fora = SEM_IVA (0% isento)                              â•‘
â•‘      â†’ Alerta se tentar misturar regimes diferentes                                      â•‘
â•‘      â†’ Badge visual mostra regime de cada reserva (IVA 23% ou Isento)                    â•‘
â•‘   âœ… CORREÃ‡ÃƒO: Valores aparecem corretamente na PrÃ©-FaturaÃ§Ã£o                            â•‘
â•‘      â†’ MÃºltiplos campos verificados: preco, valorFixo, pesoÃ—precoTon                     â•‘
â•‘   âœ… CORREÃ‡ÃƒO: "Cundefined" removido - verifica campos cliente correctamente             â•‘
â•‘   âœ… MELHORIA: "Selecionar Todas" desativado para evitar mistura de IVA                  â•‘
â•‘   âœ… MELHORIA: Limpar SeleÃ§Ã£o tambÃ©m limpa variÃ¡vel regimeIVASelecionado                 â•‘
â•‘                                                                                          â•‘
â•‘   ğŸ†• ALTERAÃ‡Ã•ES v6.20 (23/12/2024):                                                      â•‘
â•‘   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                        â•‘
â•‘   âœ… CORREÃ‡ÃƒO CRÃTICA: Reservas deixam de desaparecer ao anexar CMR                      â•‘
â•‘      â†’ guardarDados() sobrescrevia erpReservasExecutadas com dados de teste              â•‘
â•‘      â†’ Agora usa guardarReservasLS() que preserva TODAS as reservas                      â•‘
â•‘      â†’ Corrigido em processarCMRCarga() e processarCMRDescarga()                         â•‘
â•‘   âœ… CORREÃ‡ÃƒO: FaturaÃ§Ã£o manual agora cria linhas corretamente                           â•‘
â•‘      â†’ IDs dos campos corrigidos (faturaNIF, faturaMorada)                               â•‘
â•‘      â†’ Adicionado setTimeout para garantir que modal estÃ¡ carregado                      â•‘
â•‘      â†’ Logging detalhado para diagnÃ³stico                                                â•‘
â•‘   âœ… MELHORIA: todasReservas Ã© atualizado e guardado quando CMR Ã© anexado                â•‘
â•‘      â†’ Reserva Ã© adicionada se nÃ£o existir no array                                      â•‘
â•‘                                                                                          â•‘
â•‘   ğŸ†• ALTERAÃ‡Ã•ES v6.19 (23/12/2024):                                                      â•‘
â•‘   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                        â•‘
â•‘   âœ… CORREÃ‡ÃƒO CRÃTICA: CMR sÃ³ Ã© marcado quando FICHEIRO Ã© anexado                        â•‘
â•‘      â†’ Campos cmrCarga/cmrDescarga nÃ£o sÃ£o mais preenchidos com texto de ref             â•‘
â•‘      â†’ Nova flag cmrCargaAnexado e cmrDescargaAnexado (boolean)                          â•‘
â•‘      â†’ VerificaÃ§Ã£o: flag === true OU nome tem extensÃ£o (.pdf, .jpg, etc)                 â•‘
â•‘   âœ… CORREÃ‡ÃƒO: PrÃ©-FaturaÃ§Ã£o sÃ³ mostra reservas MANUAIS com CMR CARGA anexado            â•‘
â•‘      â†’ Reservas AUTOMÃTICAS sÃ£o faturadas pelo trigger C52, nÃ£o aparecem aqui            â•‘
â•‘      â†’ Carrega reservas de TODAS as fontes (array + localStorage)                        â•‘
â•‘   âœ… CORREÃ‡ÃƒO: Controlo de FaturaÃ§Ã£o mostra âŒ quando CMR nÃ£o foi anexado                 â•‘
â•‘      â†’ Verifica flag ou extensÃ£o de ficheiro para mostrar âœ…                             â•‘
â•‘   âœ… CORREÃ‡ÃƒO: faturarSelecionadas() carrega reservas de todas as fontes                 â•‘
â•‘      â†’ Array local + todasReservas + localStorage (erpReservas + erpReservasExecutadas)  â•‘
â•‘      â†’ Linhas da fatura agora sÃ£o criadas corretamente                                   â•‘
â•‘   âœ… MELHORIA: processarCMRCarga/Descarga marcam flag quando ficheiro Ã© anexado          â•‘
â•‘                                                                                          â•‘
â•‘   ğŸ†• ALTERAÃ‡Ã•ES v6.18 (23/12/2024):                                                      â•‘
â•‘   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                        â•‘
â•‘   âœ… CORREÃ‡ÃƒO: Campo "Reserva/CMR" na fatura mostra NÂº Reserva (nÃ£o nome ficheiro)       â•‘
â•‘      â†’ VariÃ¡vel numeroReservaLinha criada para usar na linha da fatura                   â•‘
â•‘      â†’ Campo cmr da linha agora usa nÃºmero da reserva                                    â•‘
â•‘   âœ… CORREÃ‡ÃƒO: PrÃ©-FaturaÃ§Ã£o - faturar manualmente encontra cliente e valores            â•‘
â•‘      â†’ FunÃ§Ã£o faturarSelecionadas() completamente reescrita                              â•‘
â•‘      â†’ Procura reservas em mÃºltiplas fontes (reservas, todasReservas, localStorage)      â•‘
â•‘      â†’ Procura cliente por ID, nÃºmero ou nome                                            â•‘
â•‘      â†’ Se cliente nÃ£o existe no dropdown, adiciona temporariamente                       â•‘
â•‘      â†’ ObtÃ©m valores de mÃºltiplos campos (preco, valorFixo, pesoCargaÃ—precoTon)          â•‘
â•‘   âœ… NOVO: Controlo de FaturaÃ§Ã£o - 2 novas colunas adicionadas                           â•‘
â•‘      â†’ Coluna "CMR DESCARGA" - âœ… se CMR de descarga recebido                            â•‘
â•‘      â†’ Coluna "EMAIL ENVIADO" - âœ… se email foi enviado (apÃ³s fatura + CMR descarga)     â•‘
â•‘      â†’ Tooltips explicativos em cada cÃ©lula                                              â•‘
â•‘   âœ… MELHORIA: CabeÃ§alho da tabela Controlo de FaturaÃ§Ã£o                                 â•‘
â•‘      â†’ 9 colunas agora: Reserva, Fatura, Cliente, Valor, Estado, CMR Carga,              â•‘
â•‘        CMR Descarga, Email Enviado, Data                                                 â•‘
â•‘                                                                                          â•‘
â•‘   ğŸ†• ALTERAÃ‡Ã•ES v6.17 (23/12/2024):                                                      â•‘
â•‘   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                        â•‘
â•‘   âœ… CORREÃ‡ÃƒO: Preview de fatura automÃ¡tica com TODOS os dados                           â•‘
â•‘      â†’ NÂº Cliente: obtido do documento ou procurado pelo nome                            â•‘
â•‘      â†’ Contribuinte: obtido do documento ou do cliente                                   â•‘
â•‘      â†’ Data Vencimento: obtida do documento                                              â•‘
â•‘      â†’ Morada: obtida do documento ou construÃ­da do cliente                              â•‘
â•‘   âœ… CORREÃ‡ÃƒO: CabeÃ§alho azul no Controlo de FaturaÃ§Ã£o                                   â•‘
â•‘      â†’ Adicionado CSS especÃ­fico para #tabelaControloFaturacao                           â•‘
â•‘      â†’ thead th com background-color: #1e3a5f !important                                 â•‘
â•‘      â†’ position: sticky e z-index para manter fixo durante scroll                        â•‘
â•‘   âœ… MELHORIA: gerarPreviewDocumento() mais robusto                                      â•‘
â•‘      â†’ Procura cliente por ID, nÃºmero ou nome                                            â•‘
â•‘      â†’ Usa dados do documento se cliente nÃ£o encontrado                                  â•‘
â•‘      â†’ VariÃ¡veis separadas para nifCliente, moradaCliente, vencimentoDoc                 â•‘
â•‘                                                                                          â•‘
â•‘   ğŸ†• ALTERAÃ‡Ã•ES v6.16 (23/12/2024):                                                      â•‘
â•‘   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                        â•‘
â•‘   âœ… CORREÃ‡ÃƒO CRÃTICA: Fatura automÃ¡tica com TODOS os dados preenchidos                  â•‘
â•‘      â†’ NÂº Cliente: obtido do formulÃ¡rio ou da ficha                                      â•‘
â•‘      â†’ Contribuinte/NIF: obtido do formulÃ¡rio ou da ficha                                â•‘
â•‘      â†’ Data Vencimento: calculada com base no prazo de pagamento do cliente              â•‘
â•‘      â†’ Morada: obtida do formulÃ¡rio ou da ficha                                          â•‘
â•‘      â†’ Linha da fatura com: CMR, Local Carga/Descarga, Ref Cliente, LDM, Peso, etc      â•‘
â•‘      â†’ Valor calculado corretamente                                                      â•‘
â•‘   âœ… CORREÃ‡ÃƒO: CabeÃ§alho azul no Controlo de FaturaÃ§Ã£o                                   â•‘
â•‘      â†’ CabeÃ§alho agora visÃ­vel com position: sticky em cada TH                           â•‘
â•‘      â†’ Borda adicionada Ã  tabela para melhor visualizaÃ§Ã£o                                â•‘
â•‘   âœ… MELHORIA: Fatura compatÃ­vel com layout A4 (gerarPreviewFatura)                      â•‘
â•‘      â†’ Campos: cliente, nif, morada, vencimento todos preenchidos                        â•‘
â•‘      â†’ Campos de linha: cmr, localCarga, localDescarga, refCliente, ldm, peso, etc      â•‘
â•‘                                                                                          â•‘
â•‘   ğŸ†• ALTERAÃ‡Ã•ES v6.15 (23/12/2024):                                                      â•‘
â•‘   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                        â•‘
â•‘   âœ… CORREÃ‡ÃƒO CRÃTICA: FaturaÃ§Ã£o AutomÃ¡tica nÃ£o funcionava                               â•‘
â•‘      â†’ Problema: modo_faturacao nÃ£o era encontrado no cliente                            â•‘
â•‘      â†’ SoluÃ§Ã£o: Procurar modo faturaÃ§Ã£o em mÃºltiplas fontes:                             â•‘
â•‘         1. Campo do formulÃ¡rio (cliente_modo_faturacao)                                  â•‘
â•‘         2. Campo da reserva guardada (modoFaturacao)                                     â•‘
â•‘         3. Cliente do mÃ³dulo Clientes (clientesLista)                                    â•‘
â•‘         4. Cliente do mÃ³dulo FaturaÃ§Ã£o (clientes)                                        â•‘
â•‘      â†’ Agora clientes com modo "AutomÃ¡tica" (ex: C0002) criam fatura imediata           â•‘
â•‘   âœ… NOVA FUNÃ‡ÃƒO: gerarNumeroDocumento()                                                 â•‘
â•‘      â†’ Gera nÃºmero de fatura usando sÃ©rie FT corretamente                                â•‘
â•‘      â†’ Incrementa contador automaticamente                                               â•‘
â•‘   âœ… MELHORIA: CriaÃ§Ã£o de fatura sem cliente completo                                    â•‘
â•‘      â†’ Se cliente nÃ£o encontrado, usa dados da reserva                                   â•‘
â•‘      â†’ Permite faturaÃ§Ã£o automÃ¡tica mesmo sem ficha de cliente completa                  â•‘
â•‘   âœ… MELHORIA: ObtenÃ§Ã£o de preÃ§o mais robusta                                            â•‘
â•‘      â†’ Tenta: formulÃ¡rio â†’ reserva.preco â†’ pesoÃ—precoTon â†’ valor/total                   â•‘
â•‘   âœ… MELHORIA: Guardar reserva em mÃºltiplos locais                                       â•‘
â•‘      â†’ reservas[] + todasReservas[] + erpReservas + erpReservasExecutadas                â•‘
â•‘      â†’ Garante sincronizaÃ§Ã£o entre mÃ³dulos                                               â•‘
â•‘   âœ… CORREÃ‡ÃƒO: Logs de debug melhorados                                                  â•‘
â•‘      â†’ Console mostra todas as etapas de procura do modo de faturaÃ§Ã£o                    â•‘
â•‘                                                                                          â•‘
â•‘   ğŸ†• ALTERAÃ‡Ã•ES v6.14 (22/12/2024):                                                      â•‘
â•‘   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                        â•‘
â•‘   âœ… NOVO: PÃ¡gina "Controlo de FaturaÃ§Ã£o" no menu Financeiro                             â•‘
â•‘      â†’ Listagem de TODAS as reservas com estado de faturaÃ§Ã£o                             â•‘
â•‘      â†’ CabeÃ§alho azul escuro fixo: NÂº RESERVA | NÂº FATURA | CLIENTE | VALOR              â•‘
â•‘      â†’ NÂº Reserva clicÃ¡vel â†’ abre a reserva                                              â•‘
â•‘      â†’ NÂº Fatura clicÃ¡vel â†’ abre a fatura                                                â•‘
â•‘      â†’ Cliente clicÃ¡vel â†’ abre a ficha do cliente                                        â•‘
â•‘      â†’ EstatÃ­sticas: Total, Faturadas, Pendentes, Sem CMR                                â•‘
â•‘      â†’ Filtros por estado, cliente, data e pesquisa                                      â•‘
â•‘      â†’ ExportaÃ§Ã£o para Excel/CSV                                                         â•‘
â•‘   âœ… MELHORIA: FaturaÃ§Ã£o AutomÃ¡tica (Trigger C52)                                        â•‘
â•‘      â†’ CMR Carga recebido â†’ Fatura criada IMEDIATAMENTE                                  â•‘
â•‘      â†’ NÂº Fatura vai para o campo verde na SecÃ§Ã£o 1 da reserva                           â•‘
â•‘      â†’ Feedback visual (campo pisca verde)                                               â•‘
â•‘      â†’ Reserva marcada como faturada automaticamente                                     â•‘
â•‘      â†’ Dados guardados em localStorage                                                   â•‘
â•‘   âœ… MELHORIA: FaturaÃ§Ã£o Manual                                                          â•‘
â•‘      â†’ CMR Carga recebido â†’ Reserva vai para PrÃ©-FaturaÃ§Ã£o                               â•‘
â•‘      â†’ Utilizador seleciona e clica "Emitir Fatura"                                      â•‘
â•‘      â†’ NÂº Fatura atualizado em todas as reservas selecionadas                            â•‘
â•‘      â†’ Controlo de FaturaÃ§Ã£o atualizado automaticamente                                  â•‘
â•‘   âœ… REGRA EMAILS - ENVIO SEMPRE AUTOMÃTICO:                                             â•‘
â•‘      â†’ TRIGGER: FATURA + CMR DESCARGA (ambos presentes)                                  â•‘
â•‘      â†’ CenÃ¡rio 1: CMR Descarga chega SEM fatura â†’ nÃ£o envia (espera fatura)              â•‘
â•‘      â†’ CenÃ¡rio 2: CMR Descarga chega COM fatura â†’ ENVIA automaticamente                  â•‘
â•‘      â†’ CenÃ¡rio 3: Fatura emitida SEM CMR Descarga â†’ nÃ£o envia (espera CMR)               â•‘
â•‘      â†’ CenÃ¡rio 4: Fatura emitida COM CMR Descarga â†’ ENVIA automaticamente                â•‘
â•‘      â†’ C41+C44 (Contab.+Financ.) recebem: Fatura + CMR(s) num sÃ³ ficheiro                â•‘
â•‘      â†’ C47 (LogÃ­stica) recebe: sÃ³ CMR                                                    â•‘
â•‘   âœ… CORREÃ‡ÃƒO: Campos numero_fatura e faturaNumero sincronizados                         â•‘
â•‘      â†’ Compatibilidade entre formulÃ¡rio e listagens                                      â•‘
â•‘                                                                                          â•‘
â•‘   ğŸ†• ALTERAÃ‡Ã•ES v6.13 (22/12/2024):                                                      â•‘
â•‘   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                        â•‘
â•‘   âœ… CORREÃ‡ÃƒO: Mapa de Recolhas agora carrega corretamente                               â•‘
â•‘      â†’ Modal Ã© aberto ANTES de criar o mapa Leaflet                                      â•‘
â•‘      â†’ Leaflet precisa do container visÃ­vel para calcular dimensÃµes                      â•‘
â•‘      â†’ Adicionado invalidateSize() apÃ³s abertura do modal                                â•‘
â•‘   âœ… CORREÃ‡ÃƒO: ValidaÃ§Ã£o de cidades na rota                                              â•‘
â•‘      â†’ Verifica se cidades de Carga (R32) e Descarga (R51) estÃ£o preenchidas            â•‘
â•‘      â†’ Verifica se cidades sÃ£o diferentes (evita mostrar 0 km)                           â•‘
â•‘      â†’ Mostra mensagem clara ao utilizador se houver problema                            â•‘
â•‘   âœ… NOVO: BotÃ£o "Ver Local de Carga" na SecÃ§Ã£o 3                                        â•‘
â•‘      â†’ Pesquisa empresas usando GOOGLE MAPS Places API                                   â•‘
â•‘      â†’ Base de dados completa de empresas/negÃ³cios (como Nervacero, etc)                â•‘
â•‘      â†’ Mostra rating, horÃ¡rios e detalhes da empresa                                     â•‘
â•‘      â†’ BotÃ£o "Preencher FormulÃ¡rio" preenche campos R26-R34 automaticamente             â•‘
â•‘   âœ… NOVO: BotÃ£o "Ver Local de Descarga" na SecÃ§Ã£o 4                                     â•‘
â•‘      â†’ Mesmas funcionalidades do botÃ£o de Carga                                          â•‘
â•‘      â†’ BotÃ£o "Preencher FormulÃ¡rio" preenche campos R45-R53 automaticamente             â•‘
â•‘   âœ… FALLBACK: Se Google Maps indisponÃ­vel, usa OpenStreetMap Nominatim                  â•‘
â•‘   âœ… NOVO: Seletor de tipo de mapa nos modais de pesquisa                                â•‘
â•‘      â†’ ğŸ—ºï¸ Mapa (OpenStreetMap)                                                           â•‘
â•‘      â†’ ğŸ›°ï¸ SatÃ©lite (Esri World Imagery)                                                  â•‘
â•‘      â†’ ğŸ”ï¸ Terreno (OpenTopoMap)                                                          â•‘
â•‘      â†’ ğŸŒ HÃ­brido (SatÃ©lite + Labels)                                                    â•‘
â•‘   âœ… NOVO: BotÃ£o "LER ORDEM DE CARGA" na SecÃ§Ã£o 1                                        â•‘
â•‘      â†’ Upload de PDF ou imagem da ordem de carga                                         â•‘
â•‘      â†’ OCR automÃ¡tico com Tesseract.js (imagens) e PDF.js (PDFs)                        â•‘
â•‘      â†’ MULTI-IDIOMA: PT, EN, ES, FR, DE, PL, IT, NL                                     â•‘
â•‘      â†’ Reconhece termos em alemÃ£o, francÃªs, polaco, etc.                                â•‘
â•‘      â†’ Identifica 500+ cidades e 24 paÃ­ses europeus                                      â•‘
â•‘      â†’ Preenchimento automÃ¡tico dos campos da reserva                                    â•‘
â•‘      â†’ Permite ediÃ§Ã£o manual antes de confirmar                                          â•‘
â•‘                                                                                          â•‘
â•‘   ğŸ†• ALTERAÃ‡Ã•ES v6.12 (22/12/2024):                                                      â•‘
â•‘   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                        â•‘
â•‘   âœ… INTEGRAÃ‡ÃƒO: OpenRouteService para rotas de camiÃµes (GRATUITO!)                      â•‘
â•‘      â†’ API Key configurada e funcional                                                   â•‘
â•‘      â†’ Rotas otimizadas para veÃ­culos pesados (HGV)                                      â•‘
â•‘      â†’ Considera peso, altura, largura e carga por eixo                                  â•‘
â•‘      â†’ 2.000 requests/dia GRÃTIS                                                         â•‘
â•‘   âœ… INTEGRAÃ‡ÃƒO: Leaflet para mapas interativos                                          â•‘
â•‘      â†’ Mapa real do OpenStreetMap                                                        â•‘
â•‘      â†’ Zoom, pan, marcadores clicÃ¡veis                                                   â•‘
â•‘      â†’ Popups com informaÃ§Ã£o detalhada                                                   â•‘
â•‘   âœ… MELHORIA: BotÃ£o "Ver Mapa" com mapa REAL                                            â•‘
â•‘      â†’ Rota desenhada no mapa interativo                                                 â•‘
â•‘      â†’ Marcadores de origem (A) e destino (B)                                            â•‘
â•‘      â†’ Label de distÃ¢ncia no centro da rota                                              â•‘
â•‘   âœ… MELHORIA: Painel "Recolhas" com mapa REAL                                           â•‘
â•‘      â†’ Recolhas pendentes com marcador ğŸ“¦                                                â•‘
â•‘      â†’ Viaturas com matrÃ­cula visÃ­vel ğŸš›                                                 â•‘
â•‘      â†’ Popup clicÃ¡vel para atribuir viatura                                              â•‘
â•‘   âœ… FALLBACK: SVG automÃ¡tico se APIs indisponÃ­veis                                      â•‘
â•‘                                                                                          â•‘
â•‘   ğŸ†• ALTERAÃ‡Ã•ES v6.10 (22/12/2024):                                                      â•‘
â•‘   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                        â•‘
â•‘   âœ… CORREÃ‡ÃƒO: Campo NÂº Reserva maior (suporta >10.000 reservas anuais)                  â•‘
â•‘   âœ… CORREÃ‡ÃƒO: Janela Motivo Bloqueio mais compacta                                      â•‘
â•‘   âœ… CORREÃ‡ÃƒO: QR Code movido para SecÃ§Ã£o 1 (ao lado do R3) - antigo REMOVIDO            â•‘
â•‘   âœ… CORREÃ‡ÃƒO: BotÃµes ANEXAR funcionais apÃ³s criar reserva                               â•‘
â•‘      â†’ CMR Carga, CMR Descarga, Fotos, Ordem Carga funcionam apÃ³s bloqueio               â•‘
â•‘      â†’ Inputs type=file nÃ£o sÃ£o bloqueados                                               â•‘
â•‘   âœ… CORREÃ‡ÃƒO: BotÃµes de aÃ§Ã£o ATIVOS apÃ³s criar reserva                                  â•‘
â•‘      â†’ Enviar Etiquetas, CMR, Mensagens funcionais apÃ³s bloqueio                         â•‘
â•‘      â†’ Motorista, Trator, Reboque funcionais apÃ³s bloqueio                               â•‘
â•‘   âœ… CORREÃ‡ÃƒO: BotÃµes especÃ­ficos BLOQUEADOS apÃ³s criar reserva:                         â•‘
â•‘      â†’ Cliente (âš™ï¸), Comercial (ğŸ‘¤), Equipa LogÃ­stica (ğŸ‘¥), Empresa Descarga (âš™ï¸)        â•‘
â•‘                                                                                          â•‘
â•‘   ğŸ†• ALTERAÃ‡Ã•ES v6.9 (22/12/2024):                                                       â•‘
â•‘   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                        â•‘
â•‘   âœ… CORREÃ‡ÃƒO CRÃTICA: Removido localStorage.clear() do login                            â•‘
â•‘      â†’ Reservas agora PERSISTEM entre sessÃµes!                                           â•‘
â•‘   âœ… CORREÃ‡ÃƒO CRÃTICA: Todos os campos guardados (60+ campos)                            â•‘
â•‘   âœ… CORREÃ‡ÃƒO CRÃTICA: FunÃ§Ã£o preencherReservaNoFormulario preenchimento completo        â•‘
â•‘   âœ… CORREÃ‡ÃƒO: Cliente bloqueado NÃƒO PERMITE criar reserva                               â•‘
â•‘   âœ… CORREÃ‡ÃƒO: GeraÃ§Ã£o de nÂº reserva evita duplicados                                    â•‘
â•‘   âœ… CORREÃ‡ÃƒO: localStorage com verificaÃ§Ã£o e try-catch                                  â•‘
â•‘   âœ… CORREÃ‡ÃƒO: 5 reservas de teste criadas automaticamente se nÃ£o existirem              â•‘
â•‘   âœ… CORREÃ‡ÃƒO: Regras R16-R25 bidirecionais implementadas                                â•‘
â•‘      - R16+R17+R19+R20+R21 preenchidos â†’ R23+R24+R25 bloqueados (cinzentos)              â•‘
â•‘      - R23+R24+R25 preenchidos â†’ R16+R17+R19+R20+R21 opcionais                           â•‘
â•‘   âœ… CORREÃ‡ÃƒO: NavegaÃ§Ã£o ENTER salta campos desabilitados                                â•‘
â•‘   âœ… CORREÃ‡ÃƒO: Campos e botÃµes bloqueados apÃ³s criar reserva                             â•‘
â•‘   âœ… CORREÃ‡ÃƒO: QR Code reposicionado (nÃ£o obstrui botÃµes)                                â•‘
â•‘   âœ… MELHORIA: Painel de Recolhas sincronizado com reservas reais                        â•‘
â•‘   âœ… MELHORIA: Mapa SVG de Portugal melhorado com viaturas e recolhas                    â•‘
â•‘   âœ… MELHORIA: Logs detalhados na consola para debug de reservas                         â•‘
â•‘                                                                                          â•‘
â•‘   ğŸ†• ALTERAÃ‡Ã•ES v6.8 (22/12/2024):                                                       â•‘
â•‘   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                        â•‘
â•‘   âœ… 10 clientes de teste com numeraÃ§Ã£o C0001-C0010                                      â•‘
â•‘   âœ… Todos os clientes com moradas completas e dados preenchidos                         â•‘
â•‘   âœ… InterligaÃ§Ã£o Clientes â†” LogÃ­stica/Reservas funcional                                â•‘
â•‘   âœ… FunÃ§Ã£o recarregarClientesReservas() - atualiza lista ao abrir reservas              â•‘
â•‘   âœ… Clientes aparecem no dropdown R4 (Cliente) nas Reservas                             â•‘
â•‘   âœ… Dados do cliente preenchidos automaticamente ao selecionar (botÃ£o âš™ï¸)               â•‘
â•‘   âœ… CORREÃ‡ÃƒO: window.clientesLista exportado para acesso global                         â•‘
â•‘   âœ… CORREÃ‡ÃƒO: Clientes inicializados automaticamente ao arrancar ERP                    â•‘
â•‘                                                                                          â•‘
â•‘   ğŸ†• ALTERAÃ‡Ã•ES v6.7 (22/12/2024):                                                       â•‘
â•‘   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                        â•‘
â•‘   âœ… HERE Maps integrado - Rotas profissionais para camiÃµes                              â•‘
â•‘   âœ… Geocoding - Pesquisar empresa por nome â†’ morada                                     â•‘
â•‘   âœ… RestriÃ§Ãµes veÃ­culos pesados (altura, peso, eixos, ADR)                              â•‘
â•‘   âœ… TrÃ¢nsito em tempo real                                                              â•‘
â•‘   âœ… Frotcom GPS API - Estrutura bidirecional (envia/recebe)                             â•‘
â•‘   âœ… PosiÃ§Ã£o frota em tempo real                                                         â•‘
â•‘   âœ… Envio de mensagens/ordens para motoristas                                           â•‘
â•‘   âœ… ReceÃ§Ã£o de confirmaÃ§Ãµes e telemetria                                                â•‘
â•‘   âœ… Fallback SVG quando APIs indisponÃ­veis                                              â•‘
â•‘                                                                                          â•‘
â•‘   ğŸ†• ALTERAÃ‡Ã•ES v6.6 (22/12/2024):                                                       â•‘
â•‘   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                        â•‘
â•‘   âœ… Motor de busca global do mÃ³dulo Clientes funcional                                  â•‘
â•‘   âœ… BotÃ£o "Lista de Clientes" funcional                                                 â•‘
â•‘   âœ… BotÃ£o verde "HistÃ³rico Emails" funcional com modal completo                         â•‘
â•‘   âœ… 4 contadores clicÃ¡veis - mostram entidades ao clicar                                â•‘
â•‘   âœ… Modal de HistÃ³rico de Emails com filtros e pesquisa                                 â•‘
â•‘   âœ… Modal de Clientes Filtrados por estado/faturaÃ§Ã£o                                    â•‘
â•‘   âœ… FunÃ§Ã£o de reenvio de emails                                                         â•‘
â•‘                                                                                          â•‘
â•‘   ğŸ†• ALTERAÃ‡Ã•ES v6.4 (21/12/2024):                                                       â•‘
â•‘   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                        â•‘
â•‘   âœ… HISTÃ“RICO DE RESERVAS - Regista TODAS as alteraÃ§Ãµes                                 â•‘
â•‘   âœ… Reserva faturada = TODOS os campos bloqueados (exceto R62 IncidÃªncias)              â•‘
â•‘   âœ… Campo R62 (IncidÃªncias) SEMPRE livre para ediÃ§Ã£o/anexos                             â•‘
â•‘   âœ… BotÃ£o "ğŸ“œ HistÃ³rico" para ver todas as alteraÃ§Ãµes da reserva                        â•‘
â•‘   âœ… PermissÃ£o especial: Admin pode desbloquear reservas faturadas                       â•‘
â•‘   âœ… TRIGGER C52 - Modo FaturaÃ§Ã£o implementado (MemÃ³ria Descritiva secÃ§Ã£o 4)             â•‘
â•‘   âœ… FaturaÃ§Ã£o AutomÃ¡tica: CMR Carga â†’ cria fatura; CMR Descarga â†’ envia emails          â•‘
â•‘   âœ… FaturaÃ§Ã£o Manual: Reservas vÃ£o para PrÃ©-FaturaÃ§Ã£o apÃ³s CMR completo                 â•‘
â•‘   âœ… Emails automÃ¡ticos: C41 (Contab.) + C44 (Financ.) + C47 (LogÃ­stica)                 â•‘
â•‘   âœ… Campos de email dos clientes agora sÃ£o salvos corretamente                          â•‘
â•‘                                                                                          â•‘
â•‘   ğŸ†• ALTERAÃ‡Ã•ES v6.3 (21/12/2024):                                                       â•‘
â•‘   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                        â•‘
â•‘   âœ… MigraÃ§Ã£o para biblioteca i18next (CDN)                                              â•‘
â•‘   âœ… Sistema de traduÃ§Ã£o profissional com fallback para PT                               â•‘
â•‘   âœ… 30 idiomas suportados (PT, EN, ES, FR, DE, IT, + 24 outros)                         â•‘
â•‘   âœ… Idioma do utilizador aplicado automaticamente no login                              â•‘
â•‘                                                                                          â•‘
â•‘   ğŸ“‹ MÃ“DULOS TRADUZIDOS:                                                                 â•‘
â•‘   âœ… Menu Lateral (todas as 7 secÃ§Ãµes)                                                   â•‘
â•‘   âœ… CotaÃ§Ãµes (Header, KPIs, Tabela, Modal, Filtros)                                     â•‘
â•‘   âœ… Reservas (Header, SecÃ§Ãµes 1-6, BotÃµes)                                              â•‘
â•‘   âœ… Agenda 1 (Header, Filtros, BotÃµes de AÃ§Ã£o)                                          â•‘
â•‘   âœ… Agenda 2 (Header, Contadores)                                                       â•‘
â•‘   âœ… Agenda 3 (Header, Selectores, BotÃµes de AÃ§Ã£o)                                       â•‘
â•‘   âœ… Clientes (Header, KPIs, Tabela, FormulÃ¡rio)                                         â•‘
â•‘   âœ… Fornecedores (Header, KPIs, Tabela)                                                 â•‘
â•‘   âœ… Faturas (Header, Filtros, Tabela)                                                   â•‘
â•‘                                                                                          â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                                                          â•‘
â•‘   âš ï¸  PRAZO CRÃTICO: 31/12/2024                                                          â•‘
â•‘   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                        â•‘
â•‘   MÃ³dulos que TÃŠM de estar funcionais:                                                   â•‘
â•‘   â€¢ LOGÃSTICA completo (CotaÃ§Ãµes âœ…, Reservas âœ…, Agendas âœ…)                             â•‘
â•‘   â€¢ FINANCEIRO completo (Clientes âœ…, jÃ¡ quase pronto)                                   â•‘
â•‘   â€¢ ADMINISTRAÃ‡ÃƒO âœ… (ArmazÃ©ns, Utilizadores, Comerciais, Equipas, Rotas, PermissÃµes)                                                   â•‘
â•‘   â€¢ PORTAL CENTRAL âœ… (Login + PermissÃµes)                                               â•‘
â•‘                                                                                          â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                                                          â•‘
â•‘   âœ… PORTAL CENTRAL INTEGRADO v6.0:                                                      â•‘
â•‘   â€¢ EcrÃ£ de login obrigatÃ³rio                                                            â•‘
â•‘   â€¢ Sistema de utilizadores com perfis                                                   â•‘
â•‘   â€¢ PermissÃµes por mÃ³dulo e aÃ§Ã£o                                                         â•‘
â•‘   â€¢ SessÃ£o segura com expiraÃ§Ã£o (8h)                                                     â•‘
â•‘   â€¢ Menu dinÃ¢mico baseado em permissÃµes                                                  â•‘
â•‘   â€¢ Multi-idioma (11 idiomas)                                                            â•‘
â•‘   â€¢ CSS prefixado com 'portal-'                                                          â•‘
â•‘   â€¢ JS prefixado com 'portal'                                                            â•‘
â•‘                                                                                          â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                                                          â•‘
â•‘   ğŸ”¢ CAMPOS NUMERADOS v6.0 (21/12/2024):                                                 â•‘
â•‘   â€¢ Clientes (C1-C68) ........ 66 campos                                                 â•‘
â•‘   â€¢ Fornecedores (F1-F36) .... 34 campos                                                 â•‘
â•‘   â€¢ Reservas (R1-R74) ........ 70 campos                                                 â•‘
â•‘   â€¢ CotaÃ§Ãµes (CT1-CT16) ...... 16 campos                                                 â•‘
â•‘   â€¢ Faturas (FT1-FT18) ....... 18 campos                                                 â•‘
â•‘   â€¢ GestÃ£o Frota (GF1-GF19) .. 22 campos                                                 â•‘
â•‘   â€¢ Agendas (A1/A2/A3/AA) .... 25 campos (atributo title)                                â•‘
â•‘   TOTAL: 251 campos identificados por cÃ³digo                                             â•‘
â•‘                                                                                          â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                                                          â•‘
â•‘   âœ… MÃ“DULO RESERVAS INTEGRADO v5.2:                                                     â•‘
â•‘   â€¢ Layout original mantido (70 campos, 6 secÃ§Ãµes)                                       â•‘
â•‘   â€¢ CSS prefixado com 'reservas-' para evitar conflitos                                  â•‘
â•‘   â€¢ Todas as funÃ§Ãµes originais preservadas                                               â•‘
â•‘   â€¢ Modais: Motorista, Trator, Reboque, Recolhas, Mapa, Etiquetas                        â•‘
â•‘   â€¢ GPS Frotcom integrado (mapa Portugal)                                                â•‘
â•‘   â€¢ localStorage para persistÃªncia de dados                                              â•‘
â•‘   â€¢ QR Code para etiquetas                                                               â•‘
â•‘                                                                                          â•‘
â•‘   âœ… MÃ“DULO AGENDA 1 INTEGRADO v5.2:                                                     â•‘
â•‘   â€¢ Layout original mantido (tabela com 24 colunas)                                      â•‘
â•‘   â€¢ CSS prefixado com 'agenda1-' para evitar conflitos                                   â•‘
â•‘   â€¢ Funcionalidades: Grupagens, Cargas Diretas, Destinos                                 â•‘
â•‘   â€¢ Drag-and-drop para reordenar reservas                                                â•‘
â•‘   â€¢ OrdenaÃ§Ã£o por colunas                                                                â•‘
â•‘   â€¢ Filtros: Estado, Prioridade, Pesquisa                                                â•‘
â•‘   â€¢ SeleÃ§Ã£o de Motorista/Trator/Reboque por modal                                        â•‘
â•‘   â€¢ Zoom com Ctrl+Scroll                                                                 â•‘
â•‘   â€¢ Envio de mensagens GPS Frotcom                                                       â•‘
â•‘   â€¢ NavegaÃ§Ã£o por teclado (Enter/Setas)                                                  â•‘
â•‘                                                                                          â•‘
â•‘   âœ… MÃ“DULO AGENDA 2 INTEGRADO v5.3:                                                     â•‘
â•‘   â€¢ Layout original mantido (tabela com 19 colunas)                                      â•‘
â•‘   â€¢ CSS prefixado com 'agenda2-' para evitar conflitos                                   â•‘
â•‘   â€¢ Funcionalidades: Grupagens, Cargas Diretas                                           â•‘
â•‘   â€¢ 2 Tabs: Listagem + Dashboards AnalÃ­ticos                                             â•‘
â•‘   â€¢ Filtros: Tipo, Intermodal, Rota, Estado, Datas, Pesquisa                             â•‘
â•‘   â€¢ Booking editÃ¡vel (Navio/Comboio)                                                     â•‘
â•‘   â€¢ Exportar Excel                                                                       â•‘
â•‘   â€¢ Modal "Passar para Agenda 3"                                                         â•‘
â•‘   â€¢ GrÃ¡ficos Chart.js                                                                    â•‘
â•‘   â€¢ Zoom com Ctrl+Scroll                                                                 â•‘
â•‘   â€¢ NavegaÃ§Ã£o por teclado (Enter/Setas) em TODOS os campos                               â•‘
â•‘                                                                                          â•‘
â•‘   âœ… MÃ“DULO AGENDA 3 INTEGRADO v5.4:                                                     â•‘
â•‘   â€¢ Layout original mantido (tabela com 25 colunas)                                      â•‘
â•‘   â€¢ CSS prefixado com 'agenda3-' para evitar conflitos                                   â•‘
â•‘   â€¢ Funcionalidades: DistribuiÃ§Ãµes, Grupagens, Entregas                                  â•‘
â•‘   â€¢ Drag-and-drop para reordenar reservas                                                â•‘
â•‘   â€¢ Filtros: Estado, Prioridade, Complementar, Pesquisa                                  â•‘
â•‘   â€¢ CMR Carga/Descarga com timer de arquivamento                                         â•‘
â•‘   â€¢ GPS Frotcom integrado (frota tratores/reboques)                                      â•‘
â•‘   â€¢ Modal "Enviar Ord. ArmazÃ©m"                                                          â•‘
â•‘   â€¢ Devolver Ã  Origem / Reverter Reserva                                                 â•‘
â•‘   â€¢ localStorage para sincronizaÃ§Ã£o com Agenda Arquivo                                   â•‘
â•‘   â€¢ Zoom com Ctrl+Scroll                                                                 â•‘
â•‘   â€¢ NavegaÃ§Ã£o por teclado (Enter/Setas) em TODOS os campos                               â•‘
â•‘                                                                                          â•‘
â•‘   âœ… MÃ“DULO AGENDA ARQUIVO INTEGRADO v5.5:                                               â•‘
â•‘   â€¢ Layout original mantido (3 tabs: Arquivo, Dashboards, SLA)                           â•‘
â•‘   â€¢ CSS prefixado com 'agendaarquivo-' para evitar conflitos                             â•‘
â•‘   â€¢ Funcionalidades: Consulta histÃ³rico de grupagens/reservas/devoluÃ§Ãµes                 â•‘
â•‘   â€¢ Filtros: Data, ArmazÃ©m, Comercial, Equipa, Cliente, Tipo, Pesquisa                   â•‘
â•‘   â€¢ KPIs: Grupagens, Reservas, LDM, Km, â‚¬/Km, Valores complementares                     â•‘
â•‘   â€¢ Dashboards com grÃ¡ficos Chart.js                                                     â•‘
â•‘   â€¢ SLA por motorista e armazÃ©m                                                          â•‘
â•‘   â€¢ SincronizaÃ§Ã£o automÃ¡tica com localStorage da Agenda 3                                â•‘
â•‘   â€¢ Modo consulta (dados bloqueados)                                                     â•‘
â•‘   â€¢ NavegaÃ§Ã£o por teclado (Enter/Setas) em TODOS os campos                               â•‘
â•‘                                                                                          â•‘
â•‘   âœ… MÃ“DULO COTAÃ‡Ã•ES INTEGRADO v5.6:                                                     â•‘
â•‘   â€¢ Layout moderno com cards e tabela                                                    â•‘
â•‘   â€¢ CSS prefixado com 'cotacoes-' para evitar conflitos                                  â•‘
â•‘   â€¢ Funcionalidades: Criar, editar, duplicar, eliminar cotaÃ§Ãµes                          â•‘
â•‘   â€¢ Campos: NÂº Cliente, Nome, DescriÃ§Ã£o, Local Carga/Descarga, Km, â‚¬/Km, â‚¬/Viagem        â•‘
â•‘   â€¢ CÃ¡lculo automÃ¡tico: (Km Ã— â‚¬/Km) + â‚¬/Viagem + Extras = Total                          â•‘
â•‘   â€¢ Estados: Pendente, Aceite, Recusada, Convertida, Expirada                            â•‘
â•‘   â€¢ Modal "Converter em Reserva" para cotaÃ§Ãµes aceites                                   â•‘
â•‘   â€¢ Filtros: Cliente, Estado, Data                                                       â•‘
â•‘   â€¢ KPIs: Total, Pendentes, Aceites, Recusadas, Valor Total                              â•‘
â•‘   â€¢ OrdenaÃ§Ã£o por colunas                                                                â•‘
â•‘   â€¢ localStorage para persistÃªncia                                                       â•‘
â•‘   â€¢ NavegaÃ§Ã£o por teclado (Enter/Setas) em TODOS os campos                               â•‘
â•‘                                                                                          â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                                                          â•‘
â•‘   ğŸ“¦ MÃ“DULOS INTEGRADOS:                                                                 â•‘
â•‘   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                        â•‘
â•‘   â€¢ CotaÃ§Ãµes ............... âœ… INTEGRADO v5.6                                           â•‘
â•‘   â€¢ Clientes ............... âœ… INTEGRADO v5.7                                           â•‘
â•‘   â€¢ Fornecedores ........... âœ… INTEGRADO v5.9 (Layout Original)                         â•‘
â•‘   â€¢ Reservas ............... âœ… INTEGRADO                                                â•‘
â•‘   â€¢ Agenda 1 ............... âœ… INTEGRADO                                                â•‘
â•‘   â€¢ Agenda 2 ............... âœ… INTEGRADO                                                â•‘
â•‘   â€¢ Agenda 3 ............... âœ… INTEGRADO                                                â•‘
â•‘   â€¢ Agenda Arquivo ......... âœ… INTEGRADO                                                â•‘
â•‘                                                                                          â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                                                          â•‘
â•‘   ğŸ†• MÃ“DULOS A CRIAR DE RAIZ:                                                            â•‘
â•‘   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                        â•‘
â•‘   â€¢ CotaÃ§Ãµes ............... Novo (campos: NÂº Cliente, DescriÃ§Ã£o, Local Carga,           â•‘
â•‘                              Local Descarga, km, â‚¬/km, Total, â‚¬/Viagem)                  â•‘
â•‘   â€¢ Clientes ............... Fichas completas                                            â•‘
â•‘   â€¢ Utilizadores ........... Criar user + password + idioma                              â•‘
â•‘   â€¢ PermissÃµes ............. Atribuir a cada utilizador                                  â•‘
â•‘                                                                                          â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                                                          â•‘
â•‘   ğŸ“‹ ESTRATÃ‰GIA DE TRABALHO:                                                             â•‘
â•‘   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                        â•‘
â•‘   FASE 1 - INTEGRAÃ‡ÃƒO (Prioridade mÃ¡xima)                                                â•‘
â•‘   1. Integrar Reservas (formulÃ¡rio jÃ¡ feito)                                             â•‘
â•‘   2. Integrar Agendas 1, 2, 3 e Arquivo (70% prontas)                                    â•‘
â•‘   3. Completar os 30% que faltam nas Agendas                                             â•‘
â•‘   4. Testar tudo junto                                                                   â•‘
â•‘                                                                                          â•‘
â•‘   FASE 2 - CONSTRUÃ‡ÃƒO                                                                    â•‘
â•‘   5. MÃ³dulo CotaÃ§Ãµes (novo)                                                              â•‘
â•‘   6. MÃ³dulo Clientes (fichas completas)                                                  â•‘
â•‘   7. FunÃ§Ãµes de AdministraÃ§Ã£o necessÃ¡rias                                                â•‘
â•‘                                                                                          â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                                                          â•‘
â•‘   ğŸ’¾ GESTÃƒO DE VERSÃ•ES E CONVERSAS:                                                      â•‘
â•‘   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                        â•‘
â•‘   â€¢ Este ficheiro HTML Ã© a "fonte de verdade" do projeto                                 â•‘
â•‘   â€¢ Guardar SEMPRE o ficheiro antes de terminar conversa                                 â•‘
â•‘   â€¢ Versionar: v5.0 â†’ v5.2 â†’ v5.2 (etc.)                                                 â•‘
â•‘   â€¢ Nova conversa = enviar ficheiro + resumo do estado                                   â•‘
â•‘                                                                                          â•‘
â•‘   TEMPLATE PARA INICIAR NOVA CONVERSA:                                                   â•‘
â•‘   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                  â•‘
â•‘   "ContinuaÃ§Ã£o do ERP Emeutrans v5.X                                                     â•‘
â•‘    Ãšltimo mÃ³dulo feito: [nome]                                                           â•‘
â•‘    PrÃ³ximo passo: [tarefa]                                                               â•‘
â•‘    Prazo: 31/12 para LogÃ­stica + Financeiro completos"                                   â•‘
â•‘                                                                                          â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                                                          â•‘
â•‘   ğŸ“‹ ESTRUTURA DO MENU LATERAL (7 SECÃ‡Ã•ES - ACORDEÃƒO):                                   â•‘
â•‘   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                        â•‘
â•‘   â€¢ SÃ³ os tÃ­tulos sÃ£o visÃ­veis                                                           â•‘
â•‘   â€¢ Clicar no tÃ­tulo expande/colapsa os sub-itens                                        â•‘
â•‘   â€¢ Seta â–¼ indica estado aberto/fechado                                                  â•‘
â•‘                                                                                          â•‘
â•‘   â•â•â•â•â•â•â•â•â•â•â• 1. âš™ï¸ ADMINISTRAÃ‡ÃƒO â•â•â•â•â•â•â•â•â•â•â•                                            â•‘
â•‘   â€¢ Dashboard Geral ........ ğŸš§ AnÃ¡lise de todos os mÃ³dulos                              â•‘
â•‘   â€¢ ConfiguraÃ§Ãµes .......... âœ… COMPLETO                                                 â•‘
â•‘   â€¢ Utilizadores ........... ğŸš§ Criar user + password + idioma                           â•‘
â•‘   â€¢ PermissÃµes ............. ğŸš§ Atribuir a cada utilizador                               â•‘
â•‘   â€¢ Comerciais ............. ğŸš§ GestÃ£o de comerciais                                     â•‘
â•‘   â€¢ Equipas ................ ğŸš§ Criar e gerir equipas                                    â•‘
â•‘   â€¢ Rotas .................. ğŸš§ DefiniÃ§Ã£o de rotas                                       â•‘
â•‘   â€¢ ArmazÃ©ns ............... ğŸš§ Criar e gerir armazÃ©ns                                   â•‘
â•‘   â€¢ Agenda Arquivo ......... ğŸš§ HistÃ³rico de agendas (70% PRONTO - INTEGRAR)             â•‘
â•‘   â€¢ Logs / HistÃ³rico ....... ğŸš§ Registo de aÃ§Ãµes                                         â•‘
â•‘   â€¢ Backup ................. ğŸš§ SeguranÃ§a de dados                                       â•‘
â•‘                                                                                          â•‘
â•‘   â•â•â•â•â•â•â•â•â•â•â• 2. ğŸš› LOGÃSTICA â•â•â•â•â•â•â•â•â•â•â•                                                â•‘
â•‘   â€¢ CotaÃ§Ãµes ............... ğŸš§ Propostas de preÃ§o (A CRIAR)                             â•‘
â•‘   â€¢ Reservas ............... ğŸš§ FormulÃ¡rio JÃ FEITO (INTEGRAR)                           â•‘
â•‘   â€¢ Agenda 1 ............... ğŸš§ 70% PRONTO (INTEGRAR)                                    â•‘
â•‘   â€¢ Agenda 2 ............... ğŸš§ 70% PRONTO (INTEGRAR)                                    â•‘
â•‘   â€¢ Agenda 3 ............... ğŸš§ 70% PRONTO (INTEGRAR)                                    â•‘
â•‘                                                                                          â•‘
â•‘   â•â•â•â•â•â•â•â•â•â•â• 3. ğŸ’° FINANCEIRO â•â•â•â•â•â•â•â•â•â•â•                                               â•‘
â•‘   â€¢ Dashboard .............. âœ… COMPLETO                                                 â•‘
â•‘   â€¢ Clientes ............... ğŸš§ Fichas completas (A CRIAR)                               â•‘
â•‘   â€¢ Faturas ................ âœ… COMPLETO (IVA por tipo cliente)                          â•‘
â•‘   â€¢ PrÃ©-FaturaÃ§Ã£o .......... âœ… COMPLETO (PesoÃ—â‚¬/TON + LDM+Valor)                        â•‘
â•‘   â€¢ Notas de CrÃ©dito ....... âœ… COMPLETO (IVA bloqueado)                                 â•‘
â•‘   â€¢ Recibos ................ ğŸ”’ BLOQUEADO v4.3                                           â•‘
â•‘   â€¢ Contas Correntes ....... ğŸ”’ BLOQUEADO v4.6                                           â•‘
â•‘                                                                                          â•‘
â•‘   â•â•â•â•â•â•â•â•â•â•â• 4. ğŸ­ FORNECEDORES â•â•â•â•â•â•â•â•â•â•â•                                             â•‘
â•‘   â€¢ Fichas Fornecedores .... ğŸš§ Dados e contactos                                        â•‘
â•‘   â€¢ Compras ................ ğŸš§ Encomendas/pedidos                                       â•‘
â•‘   â€¢ Faturas ................ ğŸš§ Faturas recebidas                                        â•‘
â•‘   â€¢ Notas de CrÃ©dito ....... ğŸš§ NC de fornecedores                                       â•‘
â•‘   â€¢ Pagamentos ............. ğŸš§ Registos de pagamento                                    â•‘
â•‘   â€¢ Contas Correntes ....... ğŸš§ Saldos a fornecedores                                    â•‘
â•‘                                                                                          â•‘
â•‘   â•â•â•â•â•â•â•â•â•â•â• 5. ğŸ“Š CONTROLO DE CUSTOS â•â•â•â•â•â•â•â•â•â•â•                                       â•‘
â•‘   â€¢ GestÃ£o de Frota ........ ğŸš§ VisÃ£o geral                                              â•‘
â•‘   â€¢ VeÃ­culos ............... ğŸš§ Fichas dos veÃ­culos                                      â•‘
â•‘   â€¢ Motoristas ............. ğŸš§ Custos por motorista                                     â•‘
â•‘   â€¢ CombustÃ­vel ............ ğŸš§ Registos e anÃ¡lise                                       â•‘
â•‘   â€¢ ManutenÃ§Ã£o ............. ğŸš§ Oficina, pneus, revisÃµes                                 â•‘
â•‘   â€¢ Portagens .............. ğŸš§ Via Verde, SCUT                                          â•‘
â•‘                                                                                          â•‘
â•‘   â•â•â•â•â•â•â•â•â•â•â• 6. ğŸ“š CONTABILIDADE â•â•â•â•â•â•â•â•â•â•â•                                            â•‘
â•‘   â€¢ Dashboard .............. ğŸš§ Resumo contabilÃ­stico                                    â•‘
â•‘   â€¢ SÃ©ries Documentos ...... âœ… COMPLETO v4.7                                            â•‘
â•‘   â€¢ SAF-T .................. ğŸš§ ExportaÃ§Ã£o fiscal                                        â•‘
â•‘   â€¢ RelatÃ³rios ............. ğŸš§ BalanÃ§os, mapas                                          â•‘
â•‘                                                                                          â•‘
â•‘   â•â•â•â•â•â•â•â•â•â•â• 7. ğŸ‘¥ RECURSOS HUMANOS â•â•â•â•â•â•â•â•â•â•â•                                         â•‘
â•‘   â€¢ FuncionÃ¡rios ........... ğŸš§ Fichas pessoais                                          â•‘
â•‘   â€¢ Contratos .............. ğŸš§ Documentos laborais                                      â•‘
â•‘   â€¢ SalÃ¡rios ............... ğŸš§ Processamento                                            â•‘
â•‘   â€¢ FÃ©rias ................. ğŸš§ MarcaÃ§Ãµes e saldos                                       â•‘
â•‘   â€¢ Documentos ............. ğŸš§ CertidÃµes, seguros                                       â•‘
â•‘                                                                                          â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                                                          â•‘
â•‘   ğŸŒ MULTI-IDIOMA: i18next (suporta todas as lÃ­nguas)                                    â•‘
â•‘   ğŸ” PERMISSÃ•ES: Definidas pela AdministraÃ§Ã£o ao criar utilizador                        â•‘
â•‘   ğŸ—£ï¸ IDIOMA: Definido pela AdministraÃ§Ã£o ao criar utilizador                             â•‘
â•‘                                                                                          â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                                                          â•‘
â•‘   ğŸ”’ MÃ“DULO CONTAS CORRENTES - BLOQUEADO v4.6 (20/12/2024)                               â•‘
â•‘   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                             â•‘
â•‘   FUNCIONALIDADES COMPLETAS:                                                             â•‘
â•‘   â€¢ âœ… RESUMO: SÃ³ clientes com saldo em dÃ­vida                                           â•‘
â•‘   â€¢ âœ… Motor de busca avanÃ§ado (cliente, saldo min/max)                                  â•‘
â•‘   â€¢ âœ… Clique no nome do cliente â†’ extrato sÃ³ faturas pendentes                          â•‘
â•‘   â€¢ âœ… EXTRATO: Filtros (cliente, data inÃ­cio, data fim, condiÃ§Ã£o)                       â•‘
â•‘   â€¢ âœ… CondiÃ§Ã£o: Faturas em dÃ­vida / Extrato completo / SÃ³ recebidas                     â•‘
â•‘   â€¢ âœ… EMAIL: Emails contabilidade + financeiro da ficha                                 â•‘
â•‘   â€¢ âœ… EMAIL: Escolher outros emails da ficha do cliente                                 â•‘
â•‘   â€¢ âœ… EMAIL: Adicionar emails manualmente                                               â•‘
â•‘   â€¢ âœ… EMAIL: Textos prÃ©-definidos (lembrete, cobranÃ§a, urgente, informativo)            â•‘
â•‘   â€¢ âœ… EMAIL: Caixa em branco para texto personalizado                                   â•‘
â•‘   â€¢ âœ… VENCIMENTOS: MÃ©dia de dias de pagamento por cliente                               â•‘
â•‘   â€¢ âœ… VENCIMENTOS: Taxa de pontualidade                                                 â•‘
â•‘   â€¢ âœ… Resumo com totais (clientes em dÃ­vida, faturado, pago, saldo)                     â•‘
â•‘   â€¢ âœ… IMPRIMIR: BotÃ£o imprimir no Resumo (por cliente)                                  â•‘
â•‘   â€¢ âœ… IMPRIMIR: BotÃ£o imprimir no Extrato Detalhado                                     â•‘
â•‘   â€¢ âœ… IMPRIMIR: BotÃ£o imprimir na AnÃ¡lise de Vencimentos (por cliente)                  â•‘
â•‘                                                                                          â•‘
â•‘   âš ï¸  NÃƒO ALTERAR CÃ“DIGO DAS CONTAS CORRENTES SEM AUTORIZAÃ‡ÃƒO âš ï¸                         â•‘
â•‘   Backup: ERP_EMEUTRANS_v4_6_BACKUP_CC_COMPLETO.html                                     â•‘
â•‘                                                                                          â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                                                          â•‘
â•‘   ğŸ”’ MÃ“DULO RECIBOS - BLOQUEADO v4.3 (20/12/2024)                                        â•‘
â•‘   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                                     â•‘
â•‘   FUNCIONALIDADES COMPLETAS:                                                             â•‘
â•‘   â€¢ âœ… Motor de busca GLOBAL (header) + filtros locais                                   â•‘
â•‘   â€¢ âœ… BotÃµes Ver / PDF / Email na listagem                                              â•‘
â•‘   â€¢ âœ… Preview antes de emitir (botÃ£o verde)                                             â•‘
â•‘   â€¢ âœ… Layout recibo: Tabela verde com 7 colunas                                         â•‘
â•‘       (NÂº Cliente, Contribuinte, MÃ©todo, Documento, Valor Doc, Valor Pago, Valor)        â•‘
â•‘   â€¢ âœ… Data de emissÃ£o por baixo do tÃ­tulo RECIBO                                        â•‘
â•‘   â€¢ âœ… Conta Destino em caixa verde alface                                               â•‘
â•‘   â€¢ âœ… Pagamentos parciais (campo Valor a Receber editÃ¡vel)                              â•‘
â•‘   â€¢ âœ… Linha TOTAL no fim da tabela                                                      â•‘
â•‘   â€¢ âœ… Envio de email (Contabilidade + Financeiro)                                       â•‘
â•‘   â€¢ âœ… Pergunta enviar email apÃ³s emitir                                                 â•‘
â•‘   â€¢ âœ… Extrato com detalhes: Valor Fatura | Pago | Pendente                              â•‘
â•‘   â€¢ âœ… Clique no cliente abre Ficha de Cliente                                           â•‘
â•‘                                                                                          â•‘
â•‘   âš ï¸  NÃƒO ALTERAR CÃ“DIGO DOS RECIBOS SEM AUTORIZAÃ‡ÃƒO âš ï¸                                  â•‘
â•‘   Backup: ERP_EMEUTRANS_v4_3_BACKUP_RECIBOS_COMPLETO.html                                â•‘
â•‘                                                                                          â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                                                          â•‘
â•‘   âœ… MÃ“DULO SÃ‰RIES DE DOCUMENTOS - COMPLETO v4.7 (20/12/2024)                            â•‘
â•‘   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                         â•‘
â•‘   FUNCIONALIDADES COMPLETAS:                                                             â•‘
â•‘   â€¢ âœ… Listagem de todas as sÃ©ries com estatÃ­sticas                                      â•‘
â•‘   â€¢ âœ… Resumo: sÃ©ries ativas/inativas, docs emitidos por tipo                            â•‘
â•‘   â€¢ âœ… Criar nova sÃ©rie (tipo, cÃ³digo, prefixo, ano, estado)                             â•‘
â•‘   â€¢ âœ… Editar sÃ©rie existente                                                            â•‘
â•‘   â€¢ âœ… Ativar/Desativar sÃ©rie                                                            â•‘
â•‘   â€¢ âœ… Resetar numeraÃ§Ã£o (sÃ³ se nÃ£o tiver docs emitidos)                                 â•‘
â•‘   â€¢ âœ… Eliminar sÃ©rie (sÃ³ se nÃ£o tiver docs emitidos)                                    â•‘
â•‘   â€¢ âœ… MudanÃ§a de ano (atualiza todas as sÃ©ries e reinicia numeraÃ§Ã£o)                    â•‘
â•‘   â€¢ âœ… HistÃ³rico de alteraÃ§Ãµes                                                           â•‘
â•‘   â€¢ âœ… ValidaÃ§Ã£o de sÃ©rie ativa antes de emitir documentos                               â•‘
â•‘   â€¢ âœ… Ano dinÃ¢mico em todos os documentos (FT, NC, RC)                                  â•‘
â•‘   â€¢ âœ… IntegraÃ§Ã£o com Faturas, Notas de CrÃ©dito, Recibos                                 â•‘
â•‘                                                                                          â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                                                          â•‘
â•‘   ğŸ“ TODO - PRÃ“XIMAS TAREFAS:                                                            â•‘
â•‘                                                                                          â•‘
â•‘   1. [X] MÃ³dulo Recibos - COMPLETO E BLOQUEADO v4.3                                      â•‘
â•‘   2. [X] MÃ³dulo Contas Correntes - COMPLETO E BLOQUEADO v4.6                             â•‘
â•‘   3. [X] MÃ³dulo SÃ©ries de Documentos - COMPLETO v4.7                                     â•‘
â•‘   4. [X] Integrar mÃ³dulo Reservas existente âœ…                                           â•‘
â•‘   5. [X] Integrar Agenda 1, 2, 3 e Arquivo existentes âœ…                                 â•‘
â•‘   6. [X] Integrar mÃ³dulo Clientes completo âœ…                                            â•‘
â•‘   7. [X] MÃ³dulo Fornecedores - COMPLETO E BLOQUEADO v5.9 ğŸ”’                              â•‘
â•‘   8. [ ] Integrar mÃ³dulo Porta Central                                                   â•‘
â•‘   9. [ ] Desenvolver mÃ³dulo RH                                                           â•‘
â•‘   10.[ ] Desenvolver mÃ³dulo Contabilidade (SAF-T, relatÃ³rios)                            â•‘
â•‘                                                                                          â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                                                          â•‘
â•‘   âš ï¸  REGRAS DE LAYOUT - LER ANTES DE ALTERAR  âš ï¸                                        â•‘
â•‘                                                                                          â•‘
â•‘   1. O layout da fatura A4 estÃ¡ BLOQUEADO e nÃ£o deve ser alterado                        â•‘
â•‘   2. Todas as janelas de fatura DEVEM usar a funÃ§Ã£o gerarPreviewDocumento()              â•‘
â•‘   3. NÃƒO criar funÃ§Ãµes alternativas para gerar faturas                                   â•‘
â•‘   4. NÃƒO duplicar o cÃ³digo de layout em outros locais                                    â•‘
â•‘   5. Qualquer alteraÃ§Ã£o pode afetar a impressÃ£o e validade fiscal                        â•‘
â•‘   6. A ficha de cliente replica EXACTAMENTE o mÃ³dulo GestÃ£o de Clientes                  â•‘
â•‘   7. PrÃ©-FaturaÃ§Ã£o suporta linhas mistas (PesoÃ—â‚¬/TON e LDM+Valor)                        â•‘
â•‘                                                                                          â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                                                          â•‘
â•‘   ğŸ”’ SECÃ‡Ã•ES BLOQUEADAS - NÃƒO ALTERAR:                                                   â•‘
â•‘                                                                                          â•‘
â•‘   CSS:                                                                                   â•‘
â•‘   â€¢ Linhas ~170-550  â†’ Layout Fatura A4                                                  â•‘
â•‘   â€¢ Linhas ~550-850  â†’ Estilos de ImpressÃ£o (@media print)                               â•‘
â•‘                                                                                          â•‘
â•‘   JAVASCRIPT - FICHA CLIENTE:                                                            â•‘
â•‘   â€¢ criarModalFichaCliente()   â†’ Modal da ficha de cliente (1400px)                      â•‘
â•‘   â€¢ preencherFichaCliente()    â†’ ConteÃºdo completo (69 campos, 7 secÃ§Ãµes)                â•‘
â•‘                                                                                          â•‘
â•‘   JAVASCRIPT - DOCUMENTOS:                                                               â•‘
â•‘   â€¢ gerarPreviewDocumento()    â†’ Layout unificado de todos os documentos                 â•‘
â•‘   â€¢ verFatura(), verNotaCredito(), verRecibo(), etc.                                     â•‘
â•‘                                                                                          â•‘
â•‘   JAVASCRIPT - PRÃ‰-FATURAÃ‡ÃƒO:                                                            â•‘
â•‘   â€¢ renderizarPreFaturacao()   â†’ Lista reservas (PesoÃ—â‚¬/TON e LDM+Valor)                 â•‘
â•‘   â€¢ toggleReserva()            â†’ SelecÃ§Ã£o com validaÃ§Ã£o cliente/IVA                      â•‘
â•‘   â€¢ selecionarTodas()          â†’ Selecciona mesmo cliente/IVA                            â•‘
â•‘   â€¢ faturarSelecionadas()      â†’ Cria fatura com linhas mistas                           â•‘
â•‘   â€¢ reporReservasTeste()       â†’ 12 reservas teste (5 peso, 7 valor fixo)                â•‘
â•‘                                                                                          â•‘
â•‘   JAVASCRIPT - NOTAS DE CRÃ‰DITO:                                                         â•‘
â•‘   â€¢ renderizarNotasCredito()      â†’ Lista NC com filtros globais e especÃ­ficos           â•‘
â•‘   â€¢ filtrarNotasCredito()         â†’ Aplicar filtros (6 campos)                           â•‘
â•‘   â€¢ abrirNovaNC()                 â†’ Modal nova NC com reset completo                     â•‘
â•‘   â€¢ seleccionarClienteNC()        â†’ Seleccionar cliente e carregar faturas               â•‘
â•‘   â€¢ carregarFaturasClienteNC()    â†’ Lista faturas do cliente                             â•‘
â•‘   â€¢ actualizarTotaisFaturasNC()   â†’ Calcular totais e detectar IVA automaticamente       â•‘
â•‘   â€¢ verificarMotivoNC()           â†’ Configurar IVA baseado no motivo                     â•‘
â•‘   â€¢ verificarFaturasEmAbertoNC()  â†’ Detectar modo manual (cliente sem faturas)           â•‘
â•‘   â€¢ calcularTotaisNC()            â†’ Calcular valor final NC com regras IVA               â•‘
â•‘   â€¢ previewNC()                   â†’ Gerar preview documento NC                           â•‘
â•‘   â€¢ emitirNC()                    â†’ Emitir NC final com todas as validaÃ§Ãµes              â•‘
â•‘   â€¢ reporNCTeste()                â†’ 5 NC de teste                                        â•‘
â•‘                                                                                          â•‘
â•‘   JAVASCRIPT - CONTAS CORRENTES (BLOQUEADO v4.6):                                        â•‘
â•‘   â€¢ renderizarCCResumo()          â†’ Lista clientes com saldo em dÃ­vida                   â•‘
â•‘   â€¢ filtrarResumoCC()             â†’ Filtros: cliente, saldo min/max, pesquisa global     â•‘
â•‘   â€¢ limparFiltrosResumoCC()       â†’ Reset filtros do resumo                              â•‘
â•‘   â€¢ preencherSelectExtrato()      â†’ Carregar lista de clientes no select                 â•‘
â•‘   â€¢ verExtratoClienteDivida()     â†’ Abrir extrato com condiÃ§Ã£o "em dÃ­vida"               â•‘
â•‘   â€¢ verExtratoCliente()           â†’ Abrir extrato completo do cliente                    â•‘
â•‘   â€¢ carregarExtrato()             â†’ Gerar extrato com filtros (data, condiÃ§Ã£o)           â•‘
â•‘   â€¢ limparFiltrosExtrato()        â†’ Reset filtros do extrato                             â•‘
â•‘   â€¢ abrirEmailExtrato()           â†’ Modal de envio de email com textos prÃ©-definidos     â•‘
â•‘   â€¢ selecionarTextoExtrato()      â†’ Carregar texto prÃ©-definido (lembrete, cobranÃ§a...)  â•‘
â•‘   â€¢ adicionarEmailManualExtrato() â†’ Adicionar emails manualmente                         â•‘
â•‘   â€¢ removerEmailManualExtrato()   â†’ Remover email manual da lista                        â•‘
â•‘   â€¢ enviarEmailExtrato()          â†’ Simular envio de email                               â•‘
â•‘   â€¢ renderizarVencimentos()       â†’ Calcular estatÃ­sticas de pagamento por cliente       â•‘
â•‘   â€¢ filtrarVencimentos()          â†’ Filtros: cliente, dias min/max, pontualidade         â•‘
â•‘   â€¢ limparFiltrosVencimentos()    â†’ Reset filtros de vencimentos                         â•‘
â•‘   â€¢ imprimirResumoCliente()       â†’ Imprimir resumo de um cliente                        â•‘
â•‘   â€¢ imprimirExtrato()             â†’ Imprimir extrato detalhado                           â•‘
â•‘   â€¢ imprimirVencimentosCliente()  â†’ Imprimir anÃ¡lise de vencimentos de um cliente        â•‘
â•‘   â€¢ mudarTabCC()                  â†’ Navegar entre tabs (Resumo/Extrato/Vencimentos)      â•‘
â•‘                                                                                          â•‘
â•‘   âš ï¸  NÃƒO ALTERAR CÃ“DIGO DAS CONTAS CORRENTES SEM AUTORIZAÃ‡ÃƒO âš ï¸                         â•‘
â•‘                                                                                          â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-->
<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ERP Emeutrans v6.14 (22/12/2024)</title>
  <!-- VersÃ£o do Layout: 5.0 - 20/12/2024 - Menu Lateral Reorganizado -->
  <meta name="layout-version" content="5.0">
  <meta name="layout-date" content="2024-12-20">
  <meta name="layout-locked" content="false">
  <meta name="menu-version" content="5.0-REORGANIZADO">
  <meta name="ficha-cliente-version" content="1.0-COMPLETA">
  <meta name="pre-faturacao-version" content="1.0-MISTA">
  <meta name="contas-correntes-version" content="4.6-BLOQUEADO">
  <meta name="series-documentos-version" content="4.7-COMPLETO">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Varela+Round&family=Inter:wght@400;500;600;700&display=swap');
    
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Inter', 'Segoe UI', sans-serif; background: #f1f5f9; }
    
    /* Cores da marca Emeutrans */
    :root {
      --verde-emeutrans: #B5BD00;
      --laranja-emeutrans: #FF6600;
      --azul-emeutrans: #307FE2;
    }
    
    .sidebar { width: 260px; background: linear-gradient(180deg, #065f46 0%, #064e3b 100%); min-height: 100vh; position: fixed; left: 0; top: 0; z-index: 100; }
    .main-content { margin-left: 260px; min-height: 100vh; }
    
    .nav-item { display: flex; align-items: center; gap: 12px; padding: 14px 24px; color: #a7f3d0; cursor: pointer; transition: all 0.2s; border-left: 3px solid transparent; }
    .nav-item:hover { background: rgba(255,255,255,0.1); color: #fff; }
    .nav-item.active { background: rgba(16, 185, 129, 0.2); color: #10b981; border-left-color: #10b981; }
    
    /* Menu AcordeÃ£o */
    .menu-section { border-bottom: 1px solid rgba(255,255,255,0.1); }
    .menu-title { 
      display: flex; 
      align-items: center; 
      justify-content: space-between;
      padding: 16px 20px; 
      color: #fff; 
      cursor: pointer; 
      transition: all 0.2s;
      font-weight: 600;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .menu-title:hover { background: rgba(255,255,255,0.1); }
    .menu-title.active { background: rgba(16, 185, 129, 0.15); color: #10b981; }
    .menu-arrow { 
      font-size: 10px; 
      transition: transform 0.3s ease;
      opacity: 0.7;
    }
    .menu-title.active .menu-arrow { transform: rotate(180deg); }
    .menu-items { 
      overflow: hidden;
      background: rgba(0,0,0,0.15);
      display: block !important;
      visibility: visible !important;
    }
    .sidebar .menu-section .menu-items.menu-collapsed { 
      display: none !important;
      visibility: hidden !important;
    }
    .menu-items .nav-item {
      padding: 10px 20px 10px 36px;
      font-size: 13px;
    }
    
    .card { background: white; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .card-header { padding: 20px 24px; border-bottom: 1px solid #e2e8f0; }
    .card-body { padding: 24px; }
    
    .stat-card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .stat-value { font-size: 28px; font-weight: 700; }
    .stat-label { font-size: 12px; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; }
    
    .btn { padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s; border: none; }
    .btn-primary { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; }
    .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(16,185,129,0.4); }
    .btn-success { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; }
    .btn-danger { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; }
    .btn-warning { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; }
    .btn-info { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; }
    .btn-warning { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; }
    .btn-warning:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(245,158,11,0.4); }
    .btn-secondary { background: #e2e8f0; color: #475569; }
    .btn-secondary:hover { background: #cbd5e1; }
    .btn-sm { padding: 6px 12px; font-size: 13px; }
    
    .form-group { margin-bottom: 16px; }
    .form-group label { display: block; margin-bottom: 6px; font-weight: 600; color: #374151; font-size: 14px; }
    .form-group input, .form-group select, .form-group textarea { 
      width: 100%; padding: 10px 14px; border: 2px solid #e2e8f0; border-radius: 8px; 
      font-size: 14px; transition: border-color 0.2s; 
    }
    .form-group input:focus, .form-group select:focus { outline: none; border-color: #10b981; }
    .form-group input:disabled, .form-group select:disabled { background: #f1f5f9; color: #64748b; }
    
    .table-container { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; }
    th { background: #f8fafc; padding: 12px 16px; text-align: left; font-weight: 600; color: #475569; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; }
    td { padding: 14px 16px; border-bottom: 1px solid #e2e8f0; color: #1e293b; font-size: 14px; }
    tr:hover { background: #f8fafc; }
    
    .badge { padding: 4px 12px; border-radius: 20px; font-size: 11px; font-weight: 600; }
    .badge-success { background: #dcfce7; color: #166534; }
    .badge-warning { background: #fef3c7; color: #92400e; }
    .badge-danger { background: #fee2e2; color: #991b1b; }
    .badge-info { background: #dbeafe; color: #1e40af; }
    .badge-purple { background: #f3e8ff; color: #7c3aed; }
    
    .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
    .modal-overlay.active { display: flex; }
    #modalPreviewFatura.active { z-index: 2000; } /* Preview sempre por cima */
    .modal-content { background: white; border-radius: 16px; max-width: 1100px; width: 95%; max-height: 90vh; overflow-y: auto; }
    .modal-header { padding: 20px 24px; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; background: linear-gradient(135deg, #065f46 0%, #064e3b 100%); color: white; border-radius: 16px 16px 0 0; }
    .modal-header h3 { font-size: 20px; font-weight: 700; }
    .modal-body { padding: 24px; }
    .modal-footer { padding: 16px 24px; border-top: 1px solid #e2e8f0; display: flex; justify-content: flex-end; gap: 12px; background: #f8fafc; }
    
    /* NavegaÃ§Ã£o tipo Excel nas cÃ©lulas da fatura */
    .excel-cell { 
      border: 1px solid #e2e8f0; 
      padding: 8px 10px; 
      font-size: 13px; 
      transition: all 0.15s;
    }
    .excel-cell:focus { 
      outline: none; 
      border-color: #10b981; 
      box-shadow: 0 0 0 3px rgba(16,185,129,0.2);
      background: #f0fdf4;
    }
    .excel-row { 
      display: grid; 
      grid-template-columns: 100px 110px 110px 90px 90px 50px 50px 70px 60px 80px 60px 30px;
      gap: 2px; 
      margin-bottom: 2px;
      background: #f8fafc;
      border-radius: 4px;
      padding: 4px;
    }
    .excel-header {
      display: grid; 
      grid-template-columns: 100px 110px 110px 90px 90px 50px 50px 70px 60px 80px 60px 30px;
      gap: 2px;
      background: #065f46;
      color: white;
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      border-radius: 6px;
      padding: 8px 4px;
      margin-bottom: 4px;
    }
    .excel-header span { padding: 4px 6px; text-align: center; }
    
    .totais-box { background: linear-gradient(135deg, #065f46 0%, #064e3b 100%); color: white; border-radius: 12px; padding: 20px; margin-top: 20px; }
    .totais-linha { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.2); }
    .totais-linha:last-child { border-bottom: none; font-size: 20px; font-weight: 700; padding-top: 12px; }
    
    .tab-container { display: flex; gap: 4px; background: #f1f5f9; padding: 4px; border-radius: 10px; margin-bottom: 24px; }
    .tab-btn { padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s; border: none; background: transparent; color: #64748b; }
    .tab-btn.active { background: white; color: #065f46; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    
    .filter-bar { display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap; }
    .filter-bar select, .filter-bar input { padding: 8px 14px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; }
    
    /* Layout de impressÃ£o da fatura */
    .fatura-preview { 
      background: white; 
      border: 1px solid #e2e8f0; 
      border-radius: 8px;
      padding: 40px;
      font-family: 'Inter', sans-serif;
      max-width: 210mm;
      margin: 0 auto;
    }
    .fatura-header { 
      display: flex; 
      justify-content: space-between; 
      align-items: flex-start;
      padding-bottom: 20px;
      border-bottom: 3px solid #065f46;
      margin-bottom: 20px;
    }
    .fatura-logo { max-width: 180px; }
    .fatura-info { text-align: right; font-size: 12px; color: #475569; }
    .fatura-titulo { font-size: 28px; font-weight: 700; color: #065f46; margin-bottom: 5px; }
    .fatura-numero { font-size: 16px; color: #1e293b; font-weight: 600; }
    
    .fatura-dados { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px; }
    .fatura-dados-box { background: #f8fafc; padding: 15px; border-radius: 8px; }
    .fatura-dados-titulo { font-weight: 700; color: #065f46; margin-bottom: 10px; font-size: 12px; text-transform: uppercase; }
    
    .fatura-tabela { width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 11px; }
    .fatura-tabela th { background: #065f46; color: white; padding: 10px 8px; text-align: left; font-size: 10px; text-transform: uppercase; }
    .fatura-tabela td { padding: 10px 8px; border-bottom: 1px solid #e2e8f0; }
    .fatura-tabela tr:nth-child(even) { background: #f8fafc; }
    
    .fatura-totais { margin-left: auto; width: 300px; }
    .fatura-totais-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e2e8f0; }
    .fatura-totais-row.total { background: #065f46; color: white; padding: 12px; border-radius: 6px; font-weight: 700; font-size: 16px; }
    
    .fatura-footer { margin-top: 30px; padding-top: 20px; border-top: 1px solid #e2e8f0; font-size: 10px; color: #64748b; }
    .fatura-qr { width: 80px; height: 80px; }
    
    /* Checkbox estilizado */
    .checkbox-container { display: flex; align-items: center; gap: 8px; cursor: pointer; }
    .checkbox-container input { width: 18px; height: 18px; cursor: pointer; }
    
    /* â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
       â•‘                                                                              â•‘
       â•‘   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•—      â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â•‘
       â•‘   â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—â•‘
       â•‘   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â•‘
       â•‘   â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–„â–„ â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•  â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â•‘
       â•‘   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â•‘
       â•‘   â•šâ•â•â•â•â•â• â•šâ•â•â•â•â•â•â• â•šâ•â•â•â•â•â•  â•šâ•â•â–€â–€â•â•  â•šâ•â•â•â•â•â• â•šâ•â•â•â•â•â•â•â•šâ•â•  â•šâ•â•â•šâ•â•â•â•â•â•  â•šâ•â•â•â•â•â• â•‘
       â•‘                                                                              â•‘
       â•‘   âš ï¸  LAYOUT FATURA A4 - BLOQUEADO - NÃƒO ALTERAR âš ï¸                          â•‘
       â•‘                                                                              â•‘
       â•‘   Este layout foi aprovado em: 19/12/2024                                    â•‘
       â•‘   VersÃ£o: 3.0 FINAL                                                          â•‘
       â•‘                                                                              â•‘
       â•‘   REGRAS:                                                                    â•‘
       â•‘   â€¢ NÃ£o modificar nenhum estilo abaixo sem autorizaÃ§Ã£o                       â•‘
       â•‘   â€¢ Todas as janelas de fatura DEVEM usar este mesmo layout                  â•‘
       â•‘   â€¢ A funÃ§Ã£o gerarPreviewFatura() Ã© a ÃšNICA fonte do layout                  â•‘
       â•‘   â€¢ Qualquer alteraÃ§Ã£o pode afetar a impressÃ£o e validade fiscal             â•‘
       â•‘                                                                              â•‘
       â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    
    /* ========== INÃCIO LAYOUT FATURA A4 - BLOQUEADO ========== */
    .fatura-a4 {
      width: 210mm;
      min-height: 297mm;
      background: white;
      padding: 10mm 12mm 8mm 12mm;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      position: relative;
      display: flex;
      flex-direction: column;
      margin: 0 auto;
    }
    
    .fatura-a4 .fatura-cabecalho {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 4mm;
    }
    
    .fatura-a4 .empresa-dados { max-width: 55%; }
    
    .fatura-a4 .empresa-logo {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 5px;
    }
    
    .fatura-a4 .empresa-logo .barras {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    
    .fatura-a4 .empresa-logo .barra {
      height: 9px;
      min-height: 9px;
      border-radius: 0 5px 5px 0;
    }
    
    .fatura-a4 .barra-verde { width: 55px; background-color: #B5BD00; }
    .fatura-a4 .barra-laranja { width: 45px; background-color: #FF6600; margin-left: 5px; }
    .fatura-a4 .barra-azul { width: 35px; background-color: #307FE2; margin-left: 10px; }
    
    .fatura-a4 .empresa-logo .nome {
      font-family: 'Varela Round', sans-serif;
      font-size: 32px;
      font-weight: bold;
      color: #000000;
    }
    
    .fatura-a4 .empresa-dados p {
      font-size: 9pt;
      color: #000000;
      line-height: 1.5;
    }
    
    .fatura-a4 .fatura-numero-box { text-align: right; }
    
    .fatura-a4 .fatura-titulo-a4 {
      font-size: 22pt;
      font-weight: 700;
      color: #065f46;
      letter-spacing: 1px;
    }
    
    .fatura-a4 .fatura-numero-a4 {
      font-size: 12pt;
      font-weight: 600;
      color: #000000;
      font-family: 'Courier New', monospace;
    }
    
    .fatura-a4 .fatura-copia {
      font-size: 9pt;
      color: #000000;
      margin-top: 2px;
      font-style: italic;
    }
    
    .fatura-a4 .cliente-box {
      border: 1px solid #94a3b8;
      padding: 6px 12px;
      margin-bottom: 3mm;
      min-height: 22mm;
      width: 50%;
      max-width: 93mm;
      margin-left: auto;
      background: #fafafa;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }
    
    .fatura-a4 .cliente-box-titulo {
      font-size: 7pt;
      color: #000000;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 3px;
      font-weight: 600;
    }
    
    .fatura-a4 .cliente-nome {
      font-size: 11pt;
      font-weight: 600;
      color: #000000;
      margin-bottom: 2px;
    }
    
    .fatura-a4 .cliente-morada {
      font-size: 9pt;
      color: #000000;
      line-height: 1.3;
    }
    
    .fatura-a4 .info-linha {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr 1fr;
      gap: 8px;
      background: #f1f5f9;
      padding: 5px 10px;
      margin-bottom: 3mm;
      border-radius: 3px;
    }
    
    /* Tabela especÃ­fica para NC - cabeÃ§alho verde, dados por baixo */
    .fatura-a4 .tabela-nc-info {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 3mm;
      font-size: 8pt;
    }
    
    .fatura-a4 .tabela-nc-info thead th {
      background: #065f46 !important;
      background-color: #065f46 !important;
      color: white !important;
      padding: 10px 12px;
      text-align: center;
      font-weight: 600;
      font-size: 8pt;
      text-transform: uppercase;
      letter-spacing: 0.3px;
      border: none;
      -webkit-print-color-adjust: exact !important;
      print-color-adjust: exact !important;
    }
    
    .fatura-a4 .tabela-nc-info tbody td {
      padding: 10px 12px;
      text-align: center;
      border-bottom: 1px solid #e2e8f0;
      background: white;
      font-size: 9pt;
      font-weight: 500;
    }
    
    .fatura-a4 .info-item { text-align: center; }
    
    .fatura-a4 .info-item-label {
      font-size: 7pt;
      color: #000000;
      text-transform: uppercase;
      letter-spacing: 0.3px;
      font-weight: 500;
    }
    
    .fatura-a4 .info-item-valor {
      font-size: 9pt;
      font-weight: 600;
      color: #000000;
    }
    
    .fatura-a4 .tabela-container {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    
    .fatura-a4 .fatura-tabela-a4 {
      width: 100%;
      border-collapse: collapse;
      font-size: 7pt;
    }
    
    .fatura-a4 .fatura-tabela-a4 thead { 
      background: #065f46; 
      background-color: #065f46;
    }
    
    .fatura-a4 .fatura-tabela-a4 th {
      color: white;
      background: #065f46;
      background-color: #065f46;
      padding: 10px 5px;
      text-align: left;
      font-size: 8pt;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.3px;
      border-right: 1px solid rgba(255,255,255,0.2);
      vertical-align: bottom;
    }
    
    .fatura-a4 .fatura-tabela-a4 th:last-child { border-right: none; }
    .fatura-a4 .fatura-tabela-a4 th.text-right { text-align: right; }
    .fatura-a4 .fatura-tabela-a4 th.text-center { text-align: center; }
    
    .fatura-a4 .fatura-tabela-a4 td {
      padding: 6px 4px;
      border-bottom: 1px solid #e2e8f0;
      color: #000000;
      vertical-align: top;
      font-size: 8pt;
      line-height: 1.3;
    }
    
    .fatura-a4 .fatura-tabela-a4 tr:nth-child(even) { background: #f8fafc; }
    .fatura-a4 .fatura-tabela-a4 td.text-right { text-align: right; }
    .fatura-a4 .fatura-tabela-a4 td.text-center { text-align: center; }
    .fatura-a4 .fatura-tabela-a4 td.valor { font-weight: 600; color: #000000; }
    
    .fatura-a4 .morada-cell {
      font-size: 7pt;
      line-height: 1.2;
    }
    
    .fatura-a4 .morada-cell .empresa {
      font-weight: 600;
      color: #000000;
      margin-bottom: 1px;
    }
    
    .fatura-a4 .morada-cell .endereco { color: #000000; }
    
    /* SecÃ§Ã£o inferior - fica sempre no fundo da pÃ¡gina */
    .fatura-a4 .fatura-inferior {
      margin-top: auto;
    }
    
    /* Layout principal: Esquerda (Obs + IBAN empilhados) + Direita (Totais) */
    .fatura-a4 .inferior-row {
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
      gap: 5mm;
    }
    
    /* Coluna esquerda: ObservaÃ§Ãµes + IBAN empilhados */
    .fatura-a4 .coluna-esquerda {
      flex: 1;
      max-width: 55%;
      display: flex;
      flex-direction: column;
      gap: 0;
    }
    
    .fatura-a4 .observacoes-box {
      border: 1px solid #e2e8f0;
      border-bottom: none;
      padding: 8px 10px;
      background: #fafafa;
    }
    
    .fatura-a4 .observacoes-titulo {
      font-size: 7pt;
      color: #000000;
      text-transform: uppercase;
      margin-bottom: 4px;
      font-weight: 600;
    }
    
    .fatura-a4 .observacoes-texto {
      font-size: 8pt;
      color: #000000;
      line-height: 1.4;
    }
    
    .fatura-a4 .dados-bancarios {
      padding: 8px 10px;
      background: #f0fdf4;
      border: 1px solid #bbf7d0;
      border-radius: 0 0 3px 3px;
    }
    
    .fatura-a4 .dados-bancarios-titulo {
      font-size: 7pt;
      color: #000000;
      text-transform: uppercase;
      margin-bottom: 2px;
      font-weight: 600;
    }
    
    .fatura-a4 .dados-bancarios-iban {
      font-size: 9pt;
      font-weight: 600;
      color: #000000;
      font-family: 'Courier New', monospace;
      letter-spacing: 0.5px;
    }
    
    /* Coluna direita: Totais */
    .fatura-a4 .coluna-direita {
      width: 70mm;
      display: flex;
      flex-direction: column;
    }
    
    .fatura-a4 .totais-box-a4 { 
      width: 100%;
    }
    
    .fatura-a4 .totais-linha-a4 {
      display: flex;
      justify-content: space-between;
      padding: 5px 6px;
      font-size: 9pt;
      border-bottom: 1px solid #e2e8f0;
    }
    
    .fatura-a4 .totais-linha-label { color: #000000; }
    .fatura-a4 .totais-linha-valor { font-weight: 600; color: #000000; }
    
    .fatura-a4 .total-box-final {
      background: #065f46;
      color: white;
      border-radius: 3px;
      padding: 8px 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 11pt;
      font-weight: 700;
      margin-top: auto;
    }
    
    .fatura-a4 .total-box-final .totais-linha-label,
    .fatura-a4 .total-box-final .totais-linha-valor { color: white; }
    
    .fatura-a4 .isencao-box {
      padding: 8px 10px;
      background: #fef3c7;
      border-left: 3px solid #f59e0b;
      font-size: 8pt;
      color: #000000;
      margin-top: 2mm;
    }
    
    .fatura-a4 .qr-section {
      display: flex;
      justify-content: flex-end;
      margin-top: 3mm;
    }
    
    .fatura-a4 .qr-box { text-align: center; }
    
    .fatura-a4 .qr-code {
      width: 20mm;
      height: 20mm;
      border: 1px solid #e2e8f0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: white;
    }
    
    .fatura-a4 .qr-label {
      font-size: 6pt;
      color: #000000;
      margin-top: 2px;
    }
    
    .fatura-a4 .fatura-rodape {
      margin-top: 3mm;
      padding-top: 3mm;
      border-top: 1px solid #e2e8f0;
      text-align: center;
    }
    
    .fatura-a4 .rodape-legal {
      font-size: 6pt;
      color: #000000;
      line-height: 1.2;
      margin-bottom: 1px;
    }
    
    .fatura-a4 .rodape-licenca {
      font-size: 5pt;
      color: #000000;
    }
    /* ========== FIM LAYOUT FATURA A4 - BLOQUEADO ========== */
    
    /* â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
       â•‘   ESTILOS DE IMPRESSÃƒO - BLOQUEADO - NÃƒO ALTERAR                             â•‘
       â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    @media print {
      /* ========== RESET PARA IMPRESSÃƒO ========== */
      html, body {
        margin: 0 !important;
        padding: 0 !important;
        background: white !important;
        width: 210mm !important;
        height: 297mm !important;
        overflow: visible !important;
      }
      
      /* Esconder TUDO na pÃ¡gina */
      body > * {
        display: none !important;
      }
      
      .sidebar, 
      .main-content {
        display: none !important; 
      }
      
      .modal-overlay {
        display: none !important;
      }
      
      /* ========== MOSTRAR O MODAL DE PREVIEW ========== */
      #modalPreviewFatura {
        display: block !important;
        visibility: visible !important;
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        width: 210mm !important;
        height: 297mm !important;
        margin: 0 !important;
        padding: 0 !important;
        background: white !important;
        overflow: visible !important;
        z-index: 999999 !important;
      }
      
      #modalPreviewFatura .modal-content {
        display: block !important;
        visibility: visible !important;
        position: static !important;
        width: 210mm !important;
        max-width: none !important;
        height: auto !important;
        max-height: none !important;
        margin: 0 !important;
        padding: 0 !important;
        border-radius: 0 !important;
        box-shadow: none !important;
        overflow: visible !important;
        background: white !important;
      }
      
      #modalPreviewFatura .modal-header,
      #modalPreviewFatura .modal-footer {
        display: none !important;
        height: 0 !important;
        overflow: hidden !important;
      }
      
      #modalPreviewFatura .modal-body {
        display: block !important;
        visibility: visible !important;
        padding: 0 !important;
        margin: 0 !important;
        background: white !important;
        overflow: visible !important;
      }
      
      /* ========== PÃGINA A4 ========== */
      @page { 
        size: A4 portrait; 
        margin: 0;
      }
      
      /* ========== A FATURA ========== */
      .fatura-a4 { 
        display: flex !important;
        visibility: visible !important;
        flex-direction: column !important;
        width: 210mm !important;
        height: 297mm !important;
        min-height: 297mm !important;
        max-height: 297mm !important;
        margin: 0 !important;
        padding: 10mm 12mm 8mm 12mm !important;
        background: white !important;
        box-shadow: none !important;
        overflow: hidden !important;
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
        color-adjust: exact !important;
      }
      
      /* ========== LOGOTIPO - BARRAS SEPARADAS ========== */
      .fatura-a4 .empresa-logo .barras {
        display: flex !important;
        flex-direction: column !important;
        gap: 6px !important;
      }
      
      .fatura-a4 .barra-verde,
      .fatura-a4 .barra-laranja,
      .fatura-a4 .barra-azul {
        display: block !important;
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
        color-adjust: exact !important;
      }
      
      .fatura-a4 .barra-verde { 
        background-color: #B5BD00 !important;
        height: 9px !important;
        width: 55px !important;
        border-radius: 0 5px 5px 0 !important;
      }
      .fatura-a4 .barra-laranja { 
        background-color: #FF6600 !important;
        height: 9px !important;
        width: 45px !important;
        margin-left: 5px !important;
        border-radius: 0 5px 5px 0 !important;
      }
      .fatura-a4 .barra-azul { 
        background-color: #307FE2 !important;
        height: 9px !important;
        width: 35px !important;
        margin-left: 10px !important;
        border-radius: 0 5px 5px 0 !important;
      }
      
      /* ========== CORES ========== */
      .fatura-a4 .info-linha {
        background: #f1f5f9 !important;
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
      }
      
      .fatura-a4 .cliente-box {
        background: #fafafa !important;
        border: 1px solid #94a3b8 !important;
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
      }
      
      .fatura-a4 .fatura-tabela-a4 thead {
        background: #065f46 !important;
        background-color: #065f46 !important;
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
        color-adjust: exact !important;
      }
      
      .fatura-a4 .fatura-tabela-a4 th {
        color: white !important;
        background: #065f46 !important;
        background-color: #065f46 !important;
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
        color-adjust: exact !important;
      }
      
      .fatura-a4 .fatura-tabela-a4 tr:nth-child(even) {
        background: #f8fafc !important;
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
      }
      
      /* Estilos de impressÃ£o para tabela NC */
      .fatura-a4 .tabela-nc-info thead th {
        background: #065f46 !important;
        background-color: #065f46 !important;
        color: white !important;
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
        color-adjust: exact !important;
      }
      
      .fatura-a4 .tabela-nc-info tbody td {
        background: white !important;
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
      }
      
      .fatura-a4 .isencao-box {
        background: #fef3c7 !important;
        border-left: 3px solid #f59e0b !important;
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
      }
      
      /* ========== NOVO LAYOUT INFERIOR ========== */
      .fatura-a4 .inferior-row {
        display: flex !important;
        justify-content: space-between !important;
        align-items: flex-end !important;
        gap: 5mm !important;
      }
      
      .fatura-a4 .coluna-esquerda {
        flex: 1 !important;
        max-width: 55% !important;
        display: flex !important;
        flex-direction: column !important;
      }
      
      .fatura-a4 .coluna-direita {
        width: 70mm !important;
        display: flex !important;
        flex-direction: column !important;
      }
      
      .fatura-a4 .observacoes-box {
        background: #fafafa !important;
        border: 1px solid #e2e8f0 !important;
        border-bottom: none !important;
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
      }
      
      .fatura-a4 .dados-bancarios {
        background: #f0fdf4 !important;
        border: 1px solid #bbf7d0 !important;
        border-radius: 0 0 3px 3px !important;
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
      }
      
      .fatura-a4 .totais-box-a4 {
        width: 100% !important;
      }
      
      .fatura-a4 .total-box-final {
        background: #065f46 !important;
        color: white !important;
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
        color-adjust: exact !important;
        display: flex !important;
        justify-content: space-between !important;
        align-items: center !important;
        padding: 8px 10px !important;
        border-radius: 3px !important;
        font-size: 11pt !important;
        font-weight: 700 !important;
        margin-top: auto !important;
      }
      
      .fatura-a4 .total-box-final .totais-linha-label,
      .fatura-a4 .total-box-final .totais-linha-valor {
        color: white !important;
      }
      
      .fatura-a4 .fatura-inferior {
        margin-top: auto !important;
      }
    }
    /* ========== FIM ESTILOS IMPRESSÃƒO - BLOQUEADO ========== */
    
    /* PrÃ©-faturaÃ§Ã£o */
    .pre-fat-row { display: flex; align-items: center; padding: 12px; background: #f8fafc; border-radius: 8px; margin-bottom: 8px; }
    .pre-fat-row:hover { background: #e2e8f0; }
    .pre-fat-row.selected { background: #dcfce7; border: 2px solid #10b981; }
    
    /* Alertas de vencimento */
    .alerta-vencimento { background: #fef3c7; border-left: 4px solid #f59e0b; padding: 12px 16px; border-radius: 0 8px 8px 0; margin-bottom: 12px; }
    .alerta-vencido { background: #fee2e2; border-left: 4px solid #ef4444; }
    
    @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    .animate-fade-in { animation: fadeIn 0.3s ease-out; }
    
    .avatar { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; color: white; background: #10b981; }
    
    .search-box { position: relative; }
    .search-box input { padding-left: 40px; }
    .search-box::before { content: 'ğŸ”'; position: absolute; left: 14px; top: 50%; transform: translateY(-50%); }
    
    /* Email confirmado */
    .email-enviado { color: #10b981; }
    .email-pendente { color: #f59e0b; }
    
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    /* MÃ“DULO RESERVAS - CSS ORIGINAL (NÃƒO ALTERAR)                                     */
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .reservas-container { max-width: 1400px; margin: 0 auto; background: #fff; border-radius: 16px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); overflow: hidden; }
    .reservas-header { background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); color: white; padding: 25px 40px; position: relative; }
    .reservas-header h1 { font-size: 28px; text-align: center; }
    .reservas-header p { font-size: 13px; opacity: 0.9; text-align: center; margin-top: 5px; }
    .reservas-qr-container { position: absolute; top: 70px; right: 20px; background: white; padding: 8px; border-radius: 8px; text-align: center; display: none; box-shadow: 0 2px 10px rgba(0,0,0,0.15); z-index: 5; }
    .reservas-qr-container canvas { display: block; }
    .reservas-qr-container span { font-size: 10px; color: #333; display: block; margin-top: 5px; }
    .reservas-fatura-banner { background: linear-gradient(135deg, #27ae60, #2ecc71); color: white; padding: 12px 25px; display: flex; justify-content: space-between; align-items: center; }
    .reservas-fatura-banner.bloqueada { background: linear-gradient(135deg, #e74c3c, #c0392b); }
    .reservas-fatura-banner .numero { font-weight: bold; font-size: 16px; }
    .reservas-form-content { padding: 30px; }
    .reservas-section-box { background: #f8f9fa; border: 2px solid #e9ecef; border-radius: 12px; padding: 25px; margin-bottom: 25px; }
    .reservas-section-box:hover { border-color: #667eea; }
    .reservas-section-box.bloqueada { opacity: 0.6; pointer-events: none; }
    .reservas-section-box.bloqueada input, .reservas-section-box.bloqueada textarea, .reservas-section-box.bloqueada select { background: #e9ecef !important; }
    .reservas-section-box h2 { color: #1e3c72; font-size: 20px; margin-bottom: 18px; padding-bottom: 10px; border-bottom: 3px solid #667eea; }
    .reservas-section-box h3 { color: #495057; font-size: 16px; margin: 20px 0 12px 0; padding-left: 10px; border-left: 4px solid #667eea; }
    .reservas-grid-2 { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
    .reservas-grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; }
    .reservas-grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; }
    .reservas-grid-5 { display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px; }
    .reservas-form-group { margin-bottom: 15px; }
    .reservas-form-group label { display: block; margin-bottom: 6px; font-weight: 600; color: #495057; font-size: 13px; }
    .reservas-campo-num { background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 2px 7px; border-radius: 10px; font-size: 10px; margin-right: 5px; }
    .reservas-form-group input, .reservas-form-group textarea, .reservas-form-group select { width: 100%; padding: 10px 12px; border: 2px solid #dee2e6; border-radius: 8px; font-size: 13px; background: white; }
    .reservas-form-group input:focus, .reservas-form-group textarea:focus, .reservas-form-group select:focus { outline: none; border-color: #667eea; }
    .reservas-form-group input:disabled { background: #e9ecef; }
    .reservas-form-group textarea { resize: vertical; min-height: 70px; }
    .reservas-motivo-bloqueio { background: #fff3cd; border: 2px solid #ffc107; border-radius: 8px; padding: 6px 10px; font-size: 11px; color: #856404; min-height: 32px; max-height: 36px; overflow: hidden; }
    .reservas-motivo-bloqueio.bloqueado { background: #f8d7da; border-color: #dc3545; color: #721c24; }
    .reservas-input-group { display: flex; gap: 6px; }
    .reservas-input-group input { flex: 1; }
    .reservas-btn { padding: 10px 16px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 13px; transition: all 0.3s; }
    .reservas-btn-blue { background: linear-gradient(135deg, #667eea, #764ba2); color: white; }
    .reservas-btn-orange { background: linear-gradient(135deg, #ff6b35, #ff8c42); color: white; }
    .reservas-btn-green { background: linear-gradient(135deg, #11998e, #38ef7d); color: white; }
    .reservas-btn-navy { background: linear-gradient(135deg, #1e3c72, #2a5298); color: white; }
    .reservas-btn-red { background: linear-gradient(135deg, #e74c3c, #c0392b); color: white; }
    .reservas-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
    .reservas-btn:disabled { background: #ccc; cursor: not-allowed; transform: none; }
    .reservas-action-buttons { display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap; }
    .reservas-submit-btn { padding: 16px; background: linear-gradient(135deg, #11998e, #38ef7d); color: white; border: none; border-radius: 10px; font-size: 17px; font-weight: 700; cursor: pointer; }
    .reservas-submit-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(17,153,142,0.4); }
    .reservas-file-list { list-style: none; margin-top: 12px; padding: 0; }
    .reservas-file-list li { padding: 10px 12px; background: #f8f9fa; border: 2px solid #dee2e6; border-radius: 8px; display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
    .reservas-historico-box { background: #f8f9fa; border: 2px solid #e9ecef; border-radius: 8px; padding: 12px; margin-top: 10px; max-height: 180px; overflow-y: auto; }
    .reservas-historico-item { padding: 8px; border-bottom: 1px solid #dee2e6; font-size: 12px; }
    .reservas-historico-item:last-child { border-bottom: none; }
    .reservas-historico-item .data { color: #6c757d; font-size: 11px; }
    .reservas-modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; justify-content: center; align-items: center; }
    .reservas-modal-overlay.active { display: flex; }
    .reservas-modal-content { background: white; padding: 25px; border-radius: 12px; max-width: 550px; width: 90%; }
    .reservas-modal-content h3 { margin-bottom: 15px; color: #1e3c72; }
    .reservas-modal-buttons { display: flex; gap: 12px; margin-top: 18px; }
    .reservas-modal-buttons button { flex: 1; padding: 12px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; }
    @media (max-width: 768px) { .reservas-grid-2, .reservas-grid-3, .reservas-grid-4, .reservas-grid-5 { grid-template-columns: 1fr; } .reservas-action-buttons { flex-direction: column; } }
    
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    /* MÃ“DULO AGENDA 1 v29 - CSS ORIGINAL (NÃƒO ALTERAR)                               */
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    #page-agenda1 { padding: 0 !important; }
    .agenda1-wrapper { height: calc(100vh - 60px); display: flex; flex-direction: column; background: #f1f5f9; overflow: hidden; }

    
    
    
    .agenda1-table-container::-webkit-scrollbar { height: 10px; width: 10px; }
    .agenda1-table-container::-webkit-scrollbar-track { background: #e2e8f0; }
    .agenda1-table-container::-webkit-scrollbar-thumb { background: #64748b; border-radius: 5px; }
    
    /* Tabela responsiva - ocupa 100% do ecrÃ£ */
    
    
    /* Linhas e cÃ©lulas maiores e mais legÃ­veis */
    .agenda1-compact-row td { 
      padding: 6px 8px !important; 
      font-size: 13px !important; 
      line-height: 1.4 !important; 
      height: auto !important; 
      min-height: 32px !important;
      color: #1e293b !important;
      font-weight: 500 !important;
    }
    .agenda1-compact-header { 
      background-color: #1e3a5f !important; 
      color: white !important;
    }
    .agenda1-compact-header th { 
      padding: 8px 6px !important; 
      font-size: 12px !important; 
      font-weight: 700 !important; 
      background-color: #1e3a5f !important;
      color: white !important;
      white-space: nowrap;
    }
    
    .agenda1-row-alert { background-color: #fef3c7 !important; }
    .agenda1-row-sum { background-color: #fed7aa !important; font-weight: bold; }
    .agenda1-row-group-header { background-color: #bbf7d0 !important; min-height: 42px !important; }
    .agenda1-row-group-header td { padding: 8px 12px !important; font-size: 14px !important; font-weight: 700 !important; height: 42px !important; }
    .agenda1-row-blank { background-color: #cbd5e1 !important; height: 8px !important; }
    .agenda1-row-selected { background-color: #bfdbfe !important; }
    .agenda1-row-normal { background-color: #ffffff !important; }
    
    /* Colunas de recolha - letras MAIORES e MAIS ESCURAS */
    .agenda1-col-recolha { 
      font-size: 13px !important; 
      font-weight: 700 !important; 
      color: #000000 !important;
    }
    .agenda1-col-recolha-vazio {
      font-size: 12px !important;
      font-weight: 600 !important;
      color: #64748b !important;
    }
    
    /* CÃ©lulas da tabela - tamanho uniforme e legÃ­vel */
    .agenda1-compact-row td {
      font-size: 13px !important;
      padding: 6px 8px !important;
      color: #1e293b !important;
      font-weight: 500 !important;
    }
    
    .agenda1-drag-handle { cursor: grab; user-select: none; }
    .agenda1-drag-handle:active { cursor: grabbing; }
    .agenda1-dragging { opacity: 0.4; background-color: #fef3c7 !important; }
    .agenda1-drag-over { border-top: 3px solid #3b82f6 !important; }
    
    .agenda1-modal-overlay { backdrop-filter: blur(4px); }
    @keyframes agenda1FadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes agenda1SlideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes agenda1Spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    .agenda1-modal-overlay { animation: agenda1FadeIn 0.2s ease-out; }
    .agenda1-modal-content { animation: agenda1SlideUp 0.3s ease-out; }
    .animate-spin { animation: agenda1Spin 1s linear infinite; }
    
    .agenda1-custom-checkbox { width: 14px; height: 14px; cursor: pointer; }
    .agenda1-zoom-container { transform-origin: top left; }
    .agenda1-btn-disabled { opacity: 0.5; cursor: not-allowed; pointer-events: none; }
    .agenda1-reserva-link { cursor: pointer; text-decoration: underline; }
    .agenda1-reserva-link:hover { color: #1d4ed8; }
    
    /* CabeÃ§alhos clicÃ¡veis para ordenar */
    .agenda1-sortable-header {
      cursor: pointer;
      user-select: none;
    }
    .agenda1-sortable-header:hover {
      background-color: #334155 !important;
    }
    
    /* BotÃ£o ordenar grupo */
    .agenda1-btn-ordenar-grupo {
      background: #7c3aed;
      color: white;
      border: none;
      padding: 3px 10px;
      border-radius: 4px;
      font-size: clamp(9px, 0.7vw, 12px);
      font-weight: bold;
      cursor: pointer;
      margin-right: 12px;
    }
    .agenda1-btn-ordenar-grupo:hover {
      background: #6d28d9;
    }
    
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    /* MÃ“DULO AGENDA 2 v6 - CSS ORIGINAL (NÃƒO ALTERAR)                                 */
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    #page-agenda2 { padding: 0 !important; }
    .agenda2-wrapper { height: calc(100vh - 60px); display: flex; flex-direction: column; background: #f1f5f9; overflow: hidden; }
    
    .agenda2-table-container { overflow: auto; }
    .agenda2-table-container::-webkit-scrollbar { height: 10px; width: 10px; }
    .agenda2-table-container::-webkit-scrollbar-track { background: #e2e8f0; }
    .agenda2-table-container::-webkit-scrollbar-thumb { background: #64748b; border-radius: 5px; }
    
    /* CabeÃ§alho da tabela ESTÃTICO */
    #agenda2ReservasTable thead {
      position: sticky;
      top: 0;
      z-index: 30;
    }
    #agenda2ReservasTable thead th {
      background-color: #1e3a5f !important;
      color: white !important;
    }
    
    /* RodapÃ© da tabela ESTÃTICO */
    #agenda2ReservasTable tfoot {
      position: sticky;
      bottom: 0;
      z-index: 30;
    }
    
    .agenda2-compact-row td { 
      padding: 4px 6px !important; 
      font-size: 13px !important; 
      line-height: 1.4 !important; 
      height: auto !important; 
      min-height: 28px !important;
      color: #0f172a !important; 
    }
    .agenda2-compact-header th { 
      padding: 6px 4px !important; 
      font-size: 11px !important; 
      font-weight: 700 !important; 
      background-color: #1e3a5f !important;
      color: white !important;
    }
    
    .agenda2-row-sum { background-color: #fed7aa !important; font-weight: bold; }
    .agenda2-row-total { background-color: #1e3a5f !important; color: white !important; }
    .agenda2-row-total td { color: white !important; font-weight: bold !important; }
    .agenda2-row-group-header-grupagem { background-color: #bbf7d0 !important; min-height: 42px !important; }
    .agenda2-row-group-header-cargadireta { background-color: #99f6e4 !important; min-height: 42px !important; }
    .agenda2-row-group-header-grupagem td, .agenda2-row-group-header-cargadireta td { padding: 8px 12px !important; font-size: 14px !important; font-weight: 700 !important; height: 42px !important; }
    .agenda2-row-nao-enviado { border-left: 4px solid #f59e0b !important; }
    .agenda2-row-enviado { border-left: 4px solid #10b981 !important; }
    .agenda2-row-normal { background-color: #ffffff !important; }
    .agenda2-row-reserva-grupagem { background-color: #dcfce7 !important; }
    .agenda2-row-reserva-cd { background-color: #ccfbf1 !important; }
    
    .agenda2-modal-overlay { backdrop-filter: blur(4px); }
    @keyframes agenda2FadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes agenda2SlideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    .agenda2-modal-overlay { animation: agenda2FadeIn 0.2s ease-out; }
    .agenda2-modal-content { animation: agenda2SlideUp 0.3s ease-out; }
    
    .agenda2-zoom-container { transform-origin: top left; }
    
    .agenda2-booking-input-enabled { 
      border: 2px solid #10b981 !important; 
      background: #ecfdf5 !important;
    }
    .agenda2-booking-input-disabled { 
      border: 1px solid #cbd5e1 !important; 
      background: #f1f5f9 !important;
      color: #64748b !important;
      cursor: not-allowed;
    }
    
    .agenda2-btn-gravar { background: #10b981; color: white; }
    .agenda2-btn-gravar:hover { background: #059669; }
    .agenda2-btn-editar { background: #3b82f6; color: white; }
    .agenda2-btn-editar:hover { background: #2563eb; }
    
    .agenda2-tab-btn { transition: all 0.2s; }
    .agenda2-tab-btn.active { background: #1e3a5f; color: white; }
    .agenda2-tab-btn:not(.active) { background: #e2e8f0; color: #475569; }
    .agenda2-tab-btn:not(.active):hover { background: #cbd5e1; }
    
    .agenda2-analytic-card {
      background: white;
      border-radius: 8px;
      padding: 16px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .agenda2-analytic-value {
      font-size: 24px;
      font-weight: 700;
      color: #1e3a5f;
    }
    .agenda2-analytic-label {
      font-size: 12px;
      color: #64748b;
      text-transform: uppercase;
    }
    .agenda2-comparison-up { color: #10b981; }
    .agenda2-comparison-down { color: #ef4444; }
    
    .agenda2-btn-expand {
      min-width: 50px;
      transition: all 0.2s;
    }
    
    .agenda2-sortable-header {
      cursor: pointer;
      user-select: none;
      position: relative;
    }
    .agenda2-sortable-header:hover {
      background-color: #334155 !important;
    }
    .agenda2-sort-indicator {
      margin-left: 4px;
      font-size: 10px;
    }
    
    .agenda2-chart-container {
      position: relative;
      height: 250px;
      background: white;
      border-radius: 8px;
      padding: 16px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    /* Input editÃ¡vel com navegaÃ§Ã£o por teclado */
    .agenda2-input-nav {
      font-size: 12px;
      padding: 4px 8px;
      border: 1px solid #cbd5e1;
      border-radius: 4px;
      background: white;
    }
    .agenda2-input-nav:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
    }
  
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       AGENDA 3 - CSS PREFIXADO (Integrado v5.4)
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    
    .agenda3-table-container::-webkit-scrollbar { height: 10px; width: 10px; }
    .agenda3-table-container::-webkit-scrollbar-track { background: #e2e8f0; }
    .agenda3-table-container::-webkit-scrollbar-thumb { background: #64748b; border-radius: 5px; }
    .agenda3-table { border-collapse: collapse; border-spacing: 0; table-layout: fixed; width: 100%; }
    .agenda3-compact-row td { padding: 4px 6px !important; font-size: clamp(11px, 0.85vw, 14px) !important; line-height: 1.4 !important; height: auto !important; min-height: 28px !important; color: #0f172a !important; }
    .agenda3-compact-header th { padding: 6px 4px !important; font-size: clamp(9px, 0.7vw, 12px) !important; font-weight: 700 !important; }
    .agenda3-row-sum { background-color: #fed7aa !important; font-weight: bold; }
    .agenda3-row-group-header-fechada { background-color: #bbf7d0 !important; min-height: 42px !important; border-left: 4px solid #22c55e !important; }
    .agenda3-row-group-header-aberta { background-color: #fef3c7 !important; min-height: 42px !important; border-left: 4px solid #f59e0b !important; }
    .agenda3-row-group-header-fechada td, .agenda3-row-group-header-aberta td { padding: 8px 12px !important; font-size: clamp(12px, 0.9vw, 15px) !important; font-weight: 700 !important; height: 42px !important; }
    .agenda3-row-blank { background-color: #cbd5e1 !important; height: 12px !important; }
    .agenda3-row-selected { background-color: #bfdbfe !important; }
    .agenda3-row-normal { background-color: #ffffff !important; }
    .agenda3-row-complementar { background-color: #dcfce7 !important; }
    .agenda3-estado-em-transito { background-color: #facc15 !important; color: #1e293b; }
    .agenda3-estado-no-cliente { background-color: #fb923c !important; color: white; }
    .agenda3-estado-entregue { background-color: #22c55e !important; color: white; }
    .agenda3-valor-complementar { background-color: #dcfce7 !important; color: #166534 !important; font-weight: bold; }
    .agenda3-valor-indicativo { color: #94a3b8 !important; }
    .agenda3-col-entrega { font-size: clamp(12px, 0.9vw, 15px) !important; font-weight: 800 !important; color: #000000 !important; }
    .agenda3-drag-handle { cursor: grab; user-select: none; font-size: 16px; color: #64748b; }
    .agenda3-drag-handle:active { cursor: grabbing; }
    .agenda3-dragging { opacity: 0.5; background-color: #fef3c7 !important; }
    .agenda3-drag-over { border-top: 3px solid #3b82f6 !important; background-color: #eff6ff !important; }
    .agenda3-modal-overlay { backdrop-filter: blur(4px); animation: agenda3FadeIn 0.2s ease-out; }
    .agenda3-modal-content { animation: agenda3SlideUp 0.3s ease-out; }
    @keyframes agenda3FadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes agenda3SlideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    .agenda3-custom-checkbox { width: 14px; height: 14px; cursor: pointer; }
    .agenda3-zoom-container { transform-origin: top left; }
    .agenda3-btn-disabled { opacity: 0.5; cursor: not-allowed; pointer-events: none; }
    .agenda3-reserva-link { cursor: pointer; text-decoration: underline; }
    .agenda3-reserva-link:hover { color: #1d4ed8; }
    .agenda3-sortable-header { cursor: pointer; user-select: none; }
    .agenda3-sortable-header:hover { background-color: #334155 !important; }
    .agenda3-badge-destino { padding: 4px 12px; border-radius: 4px; font-size: 13px; font-weight: bold; }
    .agenda3-badge-armazem { background-color: #f59e0b; color: #1e293b; }
    .agenda3-badge-direto { background-color: #22c55e; color: white; }
    .agenda3-dist-btn { transition: all 0.2s; }
    .agenda3-dist-btn:hover { transform: scale(1.05); }
    .agenda3-ordenacao-input { width: 40px; text-align: center; font-size: 12px; border: 1px solid #cbd5e1; border-radius: 4px; padding: 2px 4px; }
    .agenda3-ordenacao-input:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2); }
  
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       AGENDA ARQUIVO - CSS PREFIXADO (Integrado v5.5)
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    
    .agendaarquivo-header-main { background: linear-gradient(135deg, #059669 0%, #047857 100%); }
    .agendaarquivo-tab-active { background: #065f46; border-bottom: 3px solid #fbbf24; }
    .agendaarquivo-tab-inactive { background: #047857; opacity: 0.7; }
    .agendaarquivo-tab-inactive:hover { opacity: 0.9; }
    .agendaarquivo-card { background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .agendaarquivo-kpi-card { transition: transform 0.2s; }
    .agendaarquivo-kpi-card:hover { transform: translateY(-2px); }
    .agendaarquivo-table-header { background: #1e293b; color: white; }
    .agendaarquivo-row-grupagem { background: #ecfdf5; }
    .agendaarquivo-row-devolucao { background: #fef3c7; }
    .agendaarquivo-row-reserva { background: #f0f9ff; }
    .agendaarquivo-row-complementar { background: #dcfce7 !important; }
    .agendaarquivo-row-sum { background-color: #fed7aa !important; font-weight: bold; }
    .agendaarquivo-row-group-header { background-color: #bbf7d0 !important; border-left: 4px solid #22c55e !important; }
    .agendaarquivo-badge-enviada { background: #3b82f6; color: white; }
    .agendaarquivo-badge-devolucao { background: #f59e0b; color: white; }
    .agendaarquivo-badge-arquivada { background: #10b981; color: white; }
    .agendaarquivo-badge-fechada { background: #22c55e; color: white; }
    .agendaarquivo-locked-overlay { position: relative; }
    .agendaarquivo-locked-icon { position: absolute; top: 5px; right: 5px; color: #94a3b8; }
    .agendaarquivo-chart-container { position: relative; height: 250px; }
    .agendaarquivo-filter-input { border: 1px solid #cbd5e1; border-radius: 4px; padding: 4px 8px; font-size: 12px; }
    .agendaarquivo-filter-input:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2); }
    .agendaarquivo-section-title { border-left: 4px solid #059669; padding-left: 10px; }
    .agendaarquivo-valor-complementar { background-color: #dcfce7 !important; color: #166534 !important; font-weight: bold; }
    .agendaarquivo-table-container::-webkit-scrollbar { height: 8px; width: 8px; }
    .agendaarquivo-table-container::-webkit-scrollbar-track { background: #f1f5f9; }
    .agendaarquivo-table-container::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 4px; }
    .agendaarquivo-table-container::-webkit-scrollbar-thumb:hover { background: #64748b; }
    @media print { 
      .agendaarquivo-no-print { display: none !important; } 
      .agendaarquivo-card { break-inside: avoid; }
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       COTAÃ‡Ã•ES - CSS PREFIXADO (Integrado v5.6)
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    
    .cotacoes-container { padding: 0; }
    .cotacoes-header-main { background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); padding: 20px 24px; border-radius: 12px 12px 0 0; }
    .cotacoes-card { background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); overflow: hidden; }
    .cotacoes-stats-row { display: grid; grid-template-columns: repeat(5, 1fr); gap: 16px; margin-bottom: 20px; }
    .cotacoes-stat-card { background: white; border-radius: 10px; padding: 16px 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border-left: 4px solid; transition: transform 0.2s; }
    .cotacoes-stat-card:hover { transform: translateY(-2px); }
    .cotacoes-stat-card.total { border-left-color: #8b5cf6; }
    .cotacoes-stat-card.pendentes { border-left-color: #f59e0b; }
    .cotacoes-stat-card.aceites { border-left-color: #10b981; }
    .cotacoes-stat-card.recusadas { border-left-color: #ef4444; }
    .cotacoes-stat-card.valor { border-left-color: #3b82f6; }
    .cotacoes-stat-label { font-size: 12px; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px; }
    .cotacoes-stat-value { font-size: 26px; font-weight: 700; color: #1e293b; }
    .cotacoes-toolbar { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; padding: 16px 20px; background: #f8fafc; border-bottom: 1px solid #e2e8f0; }
    .cotacoes-filter-input { border: 1px solid #cbd5e1; border-radius: 6px; padding: 8px 12px; font-size: 13px; min-width: 140px; transition: all 0.2s; }
    .cotacoes-filter-input:focus { outline: none; border-color: #8b5cf6; box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.15); }
    .cotacoes-filter-select { border: 1px solid #cbd5e1; border-radius: 6px; padding: 8px 12px; font-size: 13px; min-width: 130px; background: white; cursor: pointer; }
    .cotacoes-filter-select:focus { outline: none; border-color: #8b5cf6; }
    .cotacoes-btn { padding: 8px 16px; border-radius: 6px; font-size: 13px; font-weight: 500; cursor: pointer; border: none; transition: all 0.2s; display: inline-flex; align-items: center; gap: 6px; }
    .cotacoes-btn-primary { background: #8b5cf6; color: white; }
    .cotacoes-btn-primary:hover { background: #7c3aed; }
    .cotacoes-btn-success { background: #10b981; color: white; }
    .cotacoes-btn-success:hover { background: #059669; }
    .cotacoes-btn-secondary { background: #e2e8f0; color: #475569; }
    .cotacoes-btn-secondary:hover { background: #cbd5e1; }
    .cotacoes-btn-danger { background: #ef4444; color: white; }
    .cotacoes-btn-danger:hover { background: #dc2626; }
    .cotacoes-btn-sm { padding: 5px 10px; font-size: 12px; }
    .cotacoes-table-container { overflow-x: auto; max-height: 500px; overflow-y: auto; }
    .cotacoes-table { width: 100%; border-collapse: collapse; font-size: 13px; }
    .cotacoes-table thead { position: sticky; top: 0; z-index: 10; }
    .cotacoes-table th { background: #1e293b; color: white; padding: 12px 10px; text-align: left; font-weight: 600; white-space: nowrap; cursor: pointer; user-select: none; }
    .cotacoes-table th:hover { background: #334155; }
    .cotacoes-table td { padding: 10px; border-bottom: 1px solid #e2e8f0; vertical-align: middle; }
    .cotacoes-table tbody tr { transition: background 0.15s; }
    .cotacoes-table tbody tr:hover { background: #f1f5f9; }
    .cotacoes-table tbody tr.selected { background: #ede9fe !important; }
    .cotacoes-table input, .cotacoes-table select { width: 100%; border: 1px solid #cbd5e1; border-radius: 4px; padding: 6px 8px; font-size: 12px; background: white; }
    .cotacoes-table input:focus, .cotacoes-table select:focus { outline: none; border-color: #8b5cf6; box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.2); }
    .cotacoes-table input[readonly] { background: #f1f5f9; color: #64748b; cursor: not-allowed; }
    .cotacoes-badge { padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.3px; }
    .cotacoes-badge-pendente { background: #fef3c7; color: #92400e; }
    .cotacoes-badge-aceite { background: #d1fae5; color: #065f46; }
    .cotacoes-badge-recusada { background: #fee2e2; color: #991b1b; }
    .cotacoes-badge-convertida { background: #dbeafe; color: #1e40af; }
    .cotacoes-badge-expirada { background: #f3f4f6; color: #6b7280; }
    .cotacoes-actions { display: flex; gap: 4px; justify-content: center; }
    .cotacoes-action-btn { width: 28px; height: 28px; border: none; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 14px; transition: all 0.2s; }
    .cotacoes-action-btn.edit { background: #e0e7ff; color: #4f46e5; }
    .cotacoes-action-btn.edit:hover { background: #c7d2fe; }
    .cotacoes-action-btn.convert { background: #d1fae5; color: #059669; }
    .cotacoes-action-btn.convert:hover { background: #a7f3d0; }
    .cotacoes-action-btn.duplicate { background: #fef3c7; color: #d97706; }
    .cotacoes-action-btn.duplicate:hover { background: #fde68a; }
    .cotacoes-action-btn.delete { background: #fee2e2; color: #dc2626; }
    .cotacoes-action-btn.delete:hover { background: #fecaca; }
    .cotacoes-action-btn.pdf { background: #dbeafe; color: #2563eb; }
    .cotacoes-action-btn.pdf:hover { background: #bfdbfe; }
    .cotacoes-modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center; }
    .cotacoes-modal { background: white; border-radius: 12px; width: 90%; max-width: 800px; max-height: 90vh; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
    .cotacoes-modal-header { background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; padding: 20px 24px; display: flex; justify-content: space-between; align-items: center; }
    .cotacoes-modal-header h3 { font-size: 18px; font-weight: 600; margin: 0; }
    .cotacoes-modal-close { background: rgba(255,255,255,0.2); border: none; color: white; width: 32px; height: 32px; border-radius: 8px; cursor: pointer; font-size: 18px; transition: background 0.2s; }
    .cotacoes-modal-close:hover { background: rgba(255,255,255,0.3); }
    .cotacoes-modal-body { padding: 24px; overflow-y: auto; max-height: calc(90vh - 140px); }
    .cotacoes-modal-footer { padding: 16px 24px; background: #f8fafc; border-top: 1px solid #e2e8f0; display: flex; justify-content: flex-end; gap: 12px; }
    .cotacoes-form-row { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-bottom: 16px; }
    .cotacoes-form-row.cols-3 { grid-template-columns: repeat(3, 1fr); }
    .cotacoes-form-row.cols-4 { grid-template-columns: repeat(4, 1fr); }
    .cotacoes-form-group { display: flex; flex-direction: column; gap: 6px; }
    .cotacoes-form-group label { font-size: 13px; font-weight: 500; color: #475569; }
    .cotacoes-form-group label span.required { color: #ef4444; }
    .cotacoes-form-group input, .cotacoes-form-group select, .cotacoes-form-group textarea { border: 1px solid #cbd5e1; border-radius: 6px; padding: 10px 12px; font-size: 14px; transition: all 0.2s; }
    .cotacoes-form-group input:focus, .cotacoes-form-group select:focus, .cotacoes-form-group textarea:focus { outline: none; border-color: #8b5cf6; box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.15); }
    .cotacoes-form-section { margin-bottom: 24px; }
    .cotacoes-form-section h4 { font-size: 14px; font-weight: 600; color: #1e293b; margin-bottom: 16px; padding-bottom: 8px; border-bottom: 2px solid #8b5cf6; display: flex; align-items: center; gap: 8px; }
    .cotacoes-calculo-box { background: #f5f3ff; border: 2px solid #8b5cf6; border-radius: 10px; padding: 20px; margin-top: 20px; }
    .cotacoes-calculo-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px dashed #c4b5fd; }
    .cotacoes-calculo-row:last-child { border-bottom: none; }
    .cotacoes-calculo-row.total { background: #8b5cf6; color: white; margin: 12px -20px -20px; padding: 16px 20px; border-radius: 0 0 8px 8px; font-size: 18px; font-weight: 700; }
    .cotacoes-empty-state { text-align: center; padding: 60px 20px; color: #64748b; }
    .cotacoes-empty-state span { font-size: 64px; display: block; margin-bottom: 16px; }
    .cotacoes-contador { font-size: 13px; color: #64748b; margin-left: auto; }
    .cotacoes-row-highlight { animation: cotacoesHighlight 2s ease-out; }
    @keyframes cotacoesHighlight { 0%, 30% { background: #fef3c7; } 100% { background: transparent; } }
    .cotacoes-input-group { display: flex; gap: 4px; }
    .cotacoes-input-group input { flex: 1; }
    .cotacoes-input-group button { flex-shrink: 0; }
    @media print { .cotacoes-no-print { display: none !important; } }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       CLIENTES - CSS PREFIXADO (Integrado v5.7)
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    
    .clientes-container { max-width: 100%; margin: 0; background: #fff; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); overflow: hidden; }
    .clientes-header { background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); color: white; padding: 20px 24px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; border-radius: 12px 12px 0 0; }
    .clientes-header h1 { font-size: 22px; font-weight: 700; margin: 0; }
    .clientes-header p { font-size: 12px; opacity: 0.9; margin: 4px 0 0; }
    .clientes-header-right { display: flex; gap: 12px; align-items: center; }
    .clientes-module-badge { background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); padding: 6px 16px; border-radius: 20px; font-weight: 600; font-size: 10px; text-transform: uppercase; }
    .clientes-sap-status { background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%); padding: 6px 14px; border-radius: 20px; font-size: 10px; display: flex; align-items: center; gap: 5px; }
    .clientes-nav-tabs { display: flex; background: #f8f9fa; border-bottom: 2px solid #e9ecef; padding: 0 20px; }
    .clientes-nav-tab { padding: 12px 20px; cursor: pointer; font-weight: 600; color: #666; border-bottom: 3px solid transparent; transition: all 0.3s ease; font-size: 13px; }
    .clientes-nav-tab:hover { color: #2980b9; background: #fff; }
    .clientes-nav-tab.active { color: #2980b9; border-bottom-color: #2980b9; background: #fff; }
    .clientes-main-content { padding: 20px; }
    .clientes-view-section { display: none; }
    .clientes-view-section.active { display: block; }
    .clientes-stats-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 12px; margin-bottom: 20px; }
    .clientes-stat-card { background: #f8f9fa; border: 2px solid #e9ecef; border-radius: 10px; padding: 16px; text-align: center; transition: all 0.3s ease; cursor: pointer; }
    .clientes-stat-card:hover { border-color: #3498db; background: #eef7ff; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(52, 152, 219, 0.2); }
    .clientes-stat-card:hover { border-color: #2980b9; transform: translateY(-2px); }
    .clientes-stat-card-icon { font-size: 26px; margin-bottom: 6px; }
    .clientes-stat-card-value { font-size: 22px; font-weight: 700; color: #1e3c72; }
    .clientes-stat-card-label { font-size: 10px; color: #666; text-transform: uppercase; margin-top: 4px; }
    .clientes-toolbar { display: flex; gap: 12px; margin-bottom: 16px; flex-wrap: wrap; align-items: center; }
    .clientes-search-box { flex: 1; min-width: 250px; position: relative; }
    .clientes-search-box input { width: 100%; padding: 10px 16px 10px 40px; border: 2px solid #dee2e6; border-radius: 8px; font-size: 13px; }
    .clientes-search-box input:focus { outline: none; border-color: #2980b9; }
    .clientes-search-box::before { content: "ğŸ”"; position: absolute; left: 12px; top: 50%; transform: translateY(-50%); font-size: 14px; }
    .clientes-btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 12px; transition: all 0.3s ease; display: inline-flex; align-items: center; gap: 5px; }
    .clientes-btn-azul { background: linear-gradient(135deg, #2980b9 0%, #3498db 100%); color: white; }
    .clientes-btn-azul:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(41, 128, 185, 0.4); }
    .clientes-btn-laranja { background: linear-gradient(135deg, #e67e22 0%, #f39c12 100%); color: white; }
    .clientes-btn-laranja:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(230, 126, 34, 0.4); }
    .clientes-btn-verde { background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%); color: white; }
    .clientes-btn-verde:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(39, 174, 96, 0.4); }
    .clientes-btn-vermelho { background: linear-gradient(135deg, #c0392b 0%, #e74c3c 100%); color: white; }
    .clientes-btn-vermelho:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(192, 57, 43, 0.4); }
    .clientes-btn-sm { padding: 5px 10px; font-size: 10px; }
    .clientes-table-container { background: #f8f9fa; border: 2px solid #e9ecef; border-radius: 10px; overflow: hidden; }
    .clientes-table { width: 100%; border-collapse: collapse; font-size: 13px; }
    .clientes-table thead { background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); color: white; }
    .clientes-table th { padding: 12px 14px; text-align: left; font-weight: 600; font-size: 11px; text-transform: uppercase; }
    .clientes-table td { padding: 10px 14px; border-bottom: 1px solid #e9ecef; vertical-align: middle; font-size: 12px; }
    .clientes-table tbody tr { background: white; transition: all 0.3s ease; }
    .clientes-table tbody tr:hover { background: #f0f7ff; }
    .clientes-table-actions { display: flex; gap: 5px; }
    .clientes-badge { padding: 4px 8px; border-radius: 12px; font-size: 10px; font-weight: 600; }
    .clientes-badge-success { background: #d4edda; color: #155724; }
    .clientes-badge-danger { background: #f8d7da; color: #721c24; }
    .clientes-badge-secondary { background: #e9ecef; color: #495057; }
    .clientes-section-box { background: #f8f9fa; border: 2px solid #e9ecef; border-radius: 10px; padding: 16px; margin-bottom: 16px; }
    .clientes-section-box:hover { border-color: #2980b9; }
    .clientes-section-box h2 { color: #1e3c72; font-size: 14px; margin-bottom: 12px; padding-bottom: 6px; border-bottom: 3px solid #2980b9; }
    .clientes-form-group { margin-bottom: 0; }
    .clientes-form-group label { display: block; margin-bottom: 3px; font-weight: 600; color: #495057; font-size: 10px; }
    .clientes-form-group input, .clientes-form-group textarea, .clientes-form-group select { width: 100%; padding: 7px 9px; border: 2px solid #dee2e6; border-radius: 6px; font-size: 12px; transition: all 0.3s ease; background: white; }
    .clientes-form-group input:focus, .clientes-form-group textarea:focus, .clientes-form-group select:focus { outline: none; border-color: #2980b9; }
    .clientes-form-group input:disabled, .clientes-form-group input[readonly] { background-color: #e9ecef; }
    .clientes-form-group textarea { resize: vertical; min-height: 50px; }
    .clientes-input-btn-group { display: flex; gap: 4px; }
    .clientes-input-btn-group input { flex: 1; }
    .clientes-input-btn-group button { padding: 7px 9px; border: none; border-radius: 6px; cursor: pointer; font-size: 11px; white-space: nowrap; }
    .clientes-checkbox-inline { display: flex; align-items: center; gap: 5px; padding: 7px 9px; background: white; border: 2px solid #dee2e6; border-radius: 6px; cursor: pointer; font-size: 11px; }
    .clientes-checkbox-inline:hover { border-color: #2980b9; }
    .clientes-checkbox-inline input[type="checkbox"] { width: 14px; height: 14px; accent-color: #2980b9; }
    .clientes-radio-group { display: flex; gap: 8px; flex-wrap: wrap; }
    .clientes-radio-wrapper { display: flex; align-items: center; gap: 5px; padding: 7px 10px; background: white; border: 2px solid #dee2e6; border-radius: 6px; cursor: pointer; font-size: 11px; }
    .clientes-radio-wrapper:hover { border-color: #2980b9; }
    .clientes-radio-wrapper.selected { border-color: #2980b9; background: #f0f7ff; }
    .clientes-radio-wrapper input[type="radio"] { width: 14px; height: 14px; accent-color: #2980b9; }
    .clientes-morada-box { background: white; border: 2px solid #e9ecef; border-radius: 8px; padding: 12px; }
    .clientes-morada-box h4 { color: #1e3c72; font-size: 12px; margin-bottom: 10px; padding-bottom: 5px; border-bottom: 2px solid #2980b9; display: flex; justify-content: space-between; align-items: center; }
    .clientes-responsavel-box { background: white; border: 2px solid #e9ecef; border-radius: 8px; padding: 10px; }
    .clientes-responsavel-box h4 { color: #1e3c72; font-size: 11px; margin-bottom: 8px; padding-bottom: 4px; border-bottom: 2px solid #2980b9; }
    .clientes-form-actions { display: flex; gap: 12px; margin-top: 16px; }
    .clientes-btn-guardar { flex: 2; padding: 12px 20px; background: linear-gradient(135deg, #2980b9 0%, #3498db 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 700; text-transform: uppercase; }
    .clientes-btn-guardar:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(41, 128, 185, 0.4); }
    .clientes-btn-alterar { flex: 1; padding: 12px 20px; background: linear-gradient(135deg, #e67e22 0%, #f39c12 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 700; }
    .clientes-btn-alterar:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(230, 126, 34, 0.4); }
    .clientes-alert { padding: 10px 14px; border-radius: 8px; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; font-size: 12px; }
    .clientes-alert-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .clientes-alert-error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    .clientes-alert-info { background: #cce5ff; color: #004085; border: 1px solid #b8daff; }
    .clientes-alert-close { margin-left: auto; background: none; border: none; font-size: 16px; cursor: pointer; }
    .clientes-sap-info { background: #e8f5e9; border: 1px solid #c8e6c9; border-radius: 6px; padding: 6px 10px; font-size: 10px; color: #2e7d32; margin-top: 8px; }
    .clientes-sap-info::before { content: "ğŸ”— "; }
    .clientes-modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; justify-content: center; align-items: center; }
    .clientes-modal-overlay.active { display: flex; }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    /* MÃ“DULO FORNECEDORES v5.9 - CSS PREFIXADO (LAYOUT ORIGINAL)                       */
    /* Prefixo: fornecedores-                                                           */
    /* â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—   */
    /* â•‘  ğŸ”’ MÃ“DULO BLOQUEADO - NÃƒO ALTERAR SEM AUTORIZAÃ‡ÃƒO ğŸ”’                      â•‘   */
    /* â•‘  VersÃ£o: 5.9 | Data: 21/12/2024                                            â•‘   */
    /* â•‘  Este mÃ³dulo estÃ¡ completo e testado.                                      â•‘   */
    /* â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   */
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    
    .fornecedores-container { max-width: 100%; margin: 0 auto; background: #fff; border-radius: 16px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); overflow: hidden; }
    
    .fornecedores-header { background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); color: white; padding: 30px 40px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px; }
    .fornecedores-header-left h1 { font-size: 32px; font-weight: 600; margin-bottom: 5px; display: flex; align-items: center; gap: 12px; }
    .fornecedores-header-left p { font-size: 14px; opacity: 0.9; }
    .fornecedores-header-right { display: flex; gap: 15px; align-items: center; }
    .fornecedores-module-badge { background: linear-gradient(135deg, #c0392b 0%, #e74c3c 100%); padding: 8px 20px; border-radius: 20px; font-weight: 600; font-size: 12px; text-transform: uppercase; letter-spacing: 1px; color: white; }
    .fornecedores-sap-status { background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%); padding: 8px 16px; border-radius: 20px; font-size: 11px; display: flex; align-items: center; gap: 6px; color: white; }
    .fornecedores-sap-status::before { content: ""; width: 8px; height: 8px; background: #fff; border-radius: 50%; animation: fornecedoresPulse 2s infinite; }
    @keyframes fornecedoresPulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    
    .fornecedores-nav-tabs { display: flex; background: #f8f9fa; border-bottom: 2px solid #e9ecef; padding: 0 40px; }
    .fornecedores-nav-tab { padding: 18px 30px; cursor: pointer; font-weight: 600; color: #666; border-bottom: 3px solid transparent; transition: all 0.3s ease; display: flex; align-items: center; gap: 8px; }
    .fornecedores-nav-tab:hover { color: #c0392b; background: #fff; }
    .fornecedores-nav-tab.active { color: #c0392b; border-bottom-color: #c0392b; background: #fff; }
    
    .fornecedores-main-content { padding: 40px; }
    .fornecedores-view-section { display: none; }
    .fornecedores-view-section.active { display: block; }
    
    .fornecedores-stats-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
    .fornecedores-stat-card { background: #f8f9fa; border: 2px solid #e9ecef; border-radius: 12px; padding: 25px; text-align: center; transition: all 0.3s ease; }
    .fornecedores-stat-card:hover { border-color: #c0392b; box-shadow: 0 4px 12px rgba(192, 57, 43, 0.15); transform: translateY(-2px); }
    .fornecedores-stat-card-icon { font-size: 36px; margin-bottom: 10px; }
    .fornecedores-stat-card-value { font-size: 32px; font-weight: 700; color: #1e3c72; }
    .fornecedores-stat-card-label { font-size: 13px; color: #666; text-transform: uppercase; letter-spacing: 1px; margin-top: 5px; }
    
    .fornecedores-toolbar { display: flex; gap: 15px; margin-bottom: 25px; flex-wrap: wrap; align-items: center; }
    .fornecedores-search-box { flex: 1; min-width: 300px; position: relative; }
    .fornecedores-search-box input { width: 100%; padding: 14px 20px 14px 50px; border: 2px solid #dee2e6; border-radius: 10px; font-size: 15px; transition: all 0.3s ease; }
    .fornecedores-search-box input:focus { outline: none; border-color: #c0392b; box-shadow: 0 0 0 3px rgba(192, 57, 43, 0.1); }
    .fornecedores-search-box::before { content: "ğŸ”"; position: absolute; left: 18px; top: 50%; transform: translateY(-50%); font-size: 18px; }
    
    .fornecedores-btn { padding: 14px 28px; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; font-size: 14px; transition: all 0.3s ease; display: inline-flex; align-items: center; gap: 8px; text-decoration: none; }
    .fornecedores-btn-vermelho { background: linear-gradient(135deg, #c0392b 0%, #e74c3c 100%); color: white; }
    .fornecedores-btn-vermelho:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(192, 57, 43, 0.4); }
    .fornecedores-btn-amarelo { background: linear-gradient(135deg, #f39c12 0%, #f1c40f 100%); color: #333; }
    .fornecedores-btn-amarelo:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(243, 156, 18, 0.4); }
    .fornecedores-btn-sm { padding: 10px 18px; font-size: 13px; }
    .fornecedores-btn-icon { padding: 10px 14px; min-width: auto; }
    
    .fornecedores-table-container { background: #f8f9fa; border: 2px solid #e9ecef; border-radius: 12px; overflow: hidden; }
    .fornecedores-table { width: 100%; border-collapse: collapse; }
    .fornecedores-table thead { background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); color: white; }
    .fornecedores-table th { padding: 18px 20px; text-align: left; font-weight: 600; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px; }
    .fornecedores-table td { padding: 16px 20px; border-bottom: 1px solid #e9ecef; vertical-align: middle; }
    .fornecedores-table tbody tr { background: white; transition: all 0.3s ease; }
    .fornecedores-table tbody tr:hover { background: #fef5f5; }
    .fornecedores-table tbody tr:last-child td { border-bottom: none; }
    .fornecedores-table-actions { display: flex; gap: 8px; }
    
    .fornecedores-badge { padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; }
    .fornecedores-badge-success { background: #d4edda; color: #155724; }
    .fornecedores-badge-danger { background: #f8d7da; color: #721c24; }
    .fornecedores-badge-warning { background: #fff3cd; color: #856404; }
    .fornecedores-badge-secondary { background: #e9ecef; color: #495057; }
    
    .fornecedores-section-box { background: #f8f9fa; border: 2px solid #e9ecef; border-radius: 12px; padding: 25px; margin-bottom: 25px; transition: all 0.3s ease; }
    .fornecedores-section-box:hover { border-color: #c0392b; box-shadow: 0 4px 12px rgba(192, 57, 43, 0.1); }
    .fornecedores-section-box h2 { color: #1e3c72 !important; font-size: 20px !important; font-weight: 600; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 3px solid #c0392b; display: flex; align-items: center; gap: 10px; }
    .fornecedores-section-box h3 { color: #495057 !important; font-size: 16px !important; font-weight: 600; margin: 20px 0 12px 0; padding-left: 10px; border-left: 4px solid #c0392b; }
    
    .fornecedores-grid-morada { display: grid; grid-template-columns: 2fr 0.5fr 1fr 1fr; gap: 15px; }
    .fornecedores-grid-morada-2 { display: grid; grid-template-columns: 1fr 1fr 0.8fr 1fr; gap: 15px; }
    .fornecedores-grid-contactos-1 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; }
    .fornecedores-grid-contactos-2 { display: grid; grid-template-columns: repeat(5, 1fr); gap: 15px; margin-top: 15px; }
    .fornecedores-grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; }
    .fornecedores-grid-6 { display: grid; grid-template-columns: repeat(6, 1fr); gap: 15px; }
    
    .fornecedores-form-group { margin-bottom: 15px; }
    .fornecedores-form-group label { display: block; margin-bottom: 6px; font-weight: 600; color: #495057; font-size: 13px; }
    .fornecedores-form-group input, .fornecedores-form-group textarea, .fornecedores-form-group select { width: 100%; padding: 10px 12px; border: 2px solid #dee2e6; border-radius: 8px; font-size: 14px; transition: all 0.3s ease; background: white; }
    .fornecedores-form-group input:focus, .fornecedores-form-group textarea:focus, .fornecedores-form-group select:focus { outline: none; border-color: #c0392b; box-shadow: 0 0 0 3px rgba(192, 57, 43, 0.1); }
    .fornecedores-form-group input:disabled, .fornecedores-form-group input[readonly] { background-color: #e9ecef; cursor: not-allowed; }
    .fornecedores-form-group textarea { resize: vertical; min-height: 80px; }
    
    .fornecedores-input-button-wrapper { display: flex; gap: 8px; }
    .fornecedores-input-button-wrapper input { flex: 1; }
    .fornecedores-input-button-wrapper button { padding: 10px 14px; background: linear-gradient(135deg, #c0392b 0%, #e74c3c 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; transition: all 0.3s ease; }
    .fornecedores-input-button-wrapper button:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(192, 57, 43, 0.4); }
    
    .fornecedores-iban-wrapper { display: flex; gap: 8px; align-items: center; }
    .fornecedores-iban-wrapper input { flex: 1; }
    .fornecedores-btn-anexar { padding: 8px 12px; font-size: 12px; background: linear-gradient(135deg, #f39c12 0%, #f1c40f 100%); color: #333; border: none; border-radius: 6px; cursor: pointer; transition: all 0.3s ease; }
    .fornecedores-btn-anexar:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(243, 156, 18, 0.4); }
    .fornecedores-btn-abrir { padding: 8px 12px; font-size: 12px; background: linear-gradient(135deg, #c0392b 0%, #e74c3c 100%); color: white; border: none; border-radius: 6px; cursor: pointer; transition: all 0.3s ease; }
    .fornecedores-btn-abrir:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(192, 57, 43, 0.4); }
    
    .fornecedores-checkbox-wrapper { display: flex; align-items: center; gap: 10px; padding: 12px; background: white; border: 2px solid #dee2e6; border-radius: 8px; cursor: pointer; transition: all 0.3s ease; }
    .fornecedores-checkbox-wrapper:hover { border-color: #c0392b; background: #fef5f5; }
    .fornecedores-checkbox-wrapper input[type="checkbox"] { width: 20px; height: 20px; cursor: pointer; accent-color: #c0392b; pointer-events: auto; }
    .fornecedores-checkbox-wrapper span { cursor: pointer; font-size: 14px; user-select: none; }
    
    .fornecedores-form-actions { display: flex; gap: 15px; margin-top: 25px; }
    .fornecedores-btn-guardar { flex: 2; padding: 16px 30px; background: linear-gradient(135deg, #c0392b 0%, #e74c3c 100%); color: white; border: none; border-radius: 10px; cursor: pointer; font-size: 16px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; transition: all 0.3s ease; }
    .fornecedores-btn-guardar:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(192, 57, 43, 0.4); }
    .fornecedores-btn-alterar { flex: 1; padding: 16px 30px; background: linear-gradient(135deg, #f39c12 0%, #f1c40f 100%); color: #333; border: none; border-radius: 10px; cursor: pointer; font-size: 16px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; transition: all 0.3s ease; }
    .fornecedores-btn-alterar:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(243, 156, 18, 0.4); }
    
    .fornecedores-sap-info { background: #e8f5e9; border: 1px solid #c8e6c9; border-radius: 8px; padding: 10px 15px; font-size: 12px; color: #2e7d32; margin-top: 10px; display: flex; align-items: center; gap: 8px; }
    .fornecedores-sap-info::before { content: "ğŸ”—"; }
    
    .fornecedores-empty-state { text-align: center; padding: 80px 20px; background: #f8f9fa; border: 2px dashed #dee2e6; border-radius: 12px; }
    .fornecedores-empty-state-icon { font-size: 72px; margin-bottom: 20px; }
    .fornecedores-empty-state h3 { font-size: 24px; color: #333; margin-bottom: 10px; }
    .fornecedores-empty-state p { color: #666; margin-bottom: 25px; }
    
    .fornecedores-alert { padding: 14px 18px; border-radius: 10px; margin-bottom: 20px; display: flex; align-items: center; gap: 12px; animation: fornecedoresSlideIn 0.3s ease; }
    @keyframes fornecedoresSlideIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    .fornecedores-alert-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .fornecedores-alert-error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    .fornecedores-alert-info { background: #cce5ff; color: #004085; border: 1px solid #b8daff; }
    .fornecedores-alert-close { margin-left: auto; background: none; border: none; font-size: 20px; cursor: pointer; opacity: 0.5; }
    .fornecedores-alert-close:hover { opacity: 1; }
    
    .fornecedores-modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; justify-content: center; align-items: center; }
    .fornecedores-modal-overlay.active { display: flex; }
    .fornecedores-modal-content { background: white; padding: 30px; border-radius: 16px; max-width: 400px; text-align: center; }
    .fornecedores-modal-icon { font-size: 48px; margin-bottom: 15px; }
    .fornecedores-modal-buttons { display: flex; gap: 15px; margin-top: 25px; }
    
    .fornecedores-detail-header { background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); color: white; padding: 25px; border-radius: 12px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px; }
    .fornecedores-detail-header h2 { font-size: 26px; margin-bottom: 5px; }
    .fornecedores-detail-header p { opacity: 0.9; }
    .fornecedores-detail-section { background: #f8f9fa; border: 2px solid #e9ecef; border-radius: 12px; padding: 20px; margin-bottom: 15px; }
    .fornecedores-detail-section h3 { color: #1e3c72; font-size: 16px; margin-bottom: 15px; padding-bottom: 8px; border-bottom: 2px solid #e9ecef; }
    .fornecedores-detail-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px; }
    .fornecedores-detail-item { background: white; padding: 15px; border-radius: 8px; border: 1px solid #e9ecef; }
    .fornecedores-detail-label { font-size: 11px; color: #666; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px; }
    .fornecedores-detail-value { font-weight: 600; color: #333; font-size: 14px; }
    .clientes-modal-content { background: white; padding: 20px; border-radius: 12px; max-width: 380px; text-align: center; }
    .clientes-tipo-pais-badge { display: inline-block; padding: 3px 8px; border-radius: 10px; font-size: 9px; font-weight: 600; text-transform: uppercase; }
    .clientes-tipo-nacional { background: #d4edda; color: #155724; }
    .clientes-tipo-europeu { background: #cce5ff; color: #004085; }
    .clientes-tipo-terceiro { background: #fff3cd; color: #856404; }
  

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       MÃ“DULO GESTÃƒO DE FROTA v5.8 - CSS PREFIXADO
       Prefixo: frota-
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    
    .frota-container { max-width: 100%; margin: 0; background: #fff; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); overflow: hidden; }
    .frota-header { background: linear-gradient(135deg, #2c3e50, #34495e); color: white; padding: 20px 24px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; border-radius: 12px 12px 0 0; }
    .frota-header h1 { font-size: 22px; font-weight: 700; margin: 0; }
    .frota-header p { font-size: 12px; opacity: 0.9; margin: 4px 0 0; }
    .frota-header-right { display: flex; gap: 12px; align-items: center; }
    .frota-module-badge { background: linear-gradient(135deg, #e74c3c, #c0392b); padding: 6px 16px; border-radius: 20px; font-weight: 600; font-size: 10px; text-transform: uppercase; }
    .frota-module-badge.frota-reboque { background: linear-gradient(135deg, #9b59b6, #8e44ad); }
    .frota-sap-status { background: linear-gradient(135deg, #27ae60, #2ecc71); padding: 6px 14px; border-radius: 20px; font-size: 10px; display: flex; align-items: center; gap: 5px; }
    
    .frota-nav-tabs { display: flex; background: #f8f9fa; border-bottom: 2px solid #e9ecef; padding: 0 10px; flex-wrap: nowrap; overflow-x: auto; }
    .frota-nav-tab { padding: 10px 10px; cursor: pointer; font-weight: 600; color: #666; border-bottom: 3px solid transparent; font-size: 10px; user-select: none; transition: all 0.2s ease; white-space: nowrap; }
    .frota-nav-tab:hover { color: #e74c3c; background: #fff; }
    .frota-nav-tab.active { color: #e74c3c; border-bottom-color: #e74c3c; background: #fff; }
    .frota-nav-tab.frota-reboque:hover { color: #9b59b6; }
    .frota-nav-tab.frota-reboque.active { color: #9b59b6; border-bottom-color: #9b59b6; }
    .frota-nav-tab.frota-dragging { opacity: 0.5; background: #dee2e6; transform: scale(0.95); }
    .frota-nav-tab.frota-drag-over { border-left: 3px solid #e74c3c; background: #fff5f5; }
    .frota-nav-tab.frota-drag-over.frota-reboque { border-left-color: #9b59b6; background: #f9f5fc; }
    .frota-nav-tab .frota-drag-handle { cursor: grab; margin-right: 3px; opacity: 0.5; font-size: 8px; }
    .frota-nav-tab:hover .frota-drag-handle { opacity: 1; }
    .frota-nav-tab.frota-dragging .frota-drag-handle { cursor: grabbing; }
    
    .frota-main-content { padding: 20px; }
    .frota-view-section { display: none; }
    .frota-view-section.active { display: block; }
    
    .frota-stats-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin-bottom: 20px; }
    .frota-stat-card { background: #f8f9fa; border: 2px solid #e9ecef; border-radius: 10px; padding: 15px; text-align: center; transition: all 0.3s ease; }
    .frota-stat-card:hover { border-color: #e74c3c; transform: translateY(-2px); }
    .frota-stat-card.frota-reboque:hover { border-color: #9b59b6; }
    .frota-stat-card-icon { font-size: 24px; margin-bottom: 5px; }
    .frota-stat-card-value { font-size: 22px; font-weight: 700; color: #2c3e50; }
    .frota-stat-card-label { font-size: 9px; color: #666; text-transform: uppercase; margin-top: 4px; }
    
    .frota-toolbar { display: flex; gap: 12px; margin-bottom: 18px; flex-wrap: wrap; align-items: center; }
    .frota-search-box { flex: 1; min-width: 200px; position: relative; }
    .frota-search-box input { width: 100%; padding: 10px 15px 10px 40px; border: 2px solid #dee2e6; border-radius: 8px; font-size: 13px; }
    .frota-search-box input:focus { outline: none; border-color: #e74c3c; }
    .frota-search-box::before { content: "ğŸ”"; position: absolute; left: 12px; top: 50%; transform: translateY(-50%); font-size: 14px; }
    
    .frota-btn { padding: 10px 18px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 12px; display: inline-flex; align-items: center; gap: 5px; transition: all 0.2s ease; }
    .frota-btn-vermelho { background: linear-gradient(135deg, #e74c3c, #c0392b); color: white; }
    .frota-btn-vermelho:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(231, 76, 60, 0.4); }
    .frota-btn-roxo { background: linear-gradient(135deg, #9b59b6, #8e44ad); color: white; }
    .frota-btn-roxo:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(155, 89, 182, 0.4); }
    .frota-btn-laranja { background: linear-gradient(135deg, #e67e22, #f39c12); color: white; }
    .frota-btn-laranja:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(230, 126, 34, 0.4); }
    .frota-btn-verde { background: linear-gradient(135deg, #27ae60, #2ecc71); color: white; }
    .frota-btn-verde:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(39, 174, 96, 0.4); }
    .frota-btn-azul { background: linear-gradient(135deg, #2980b9, #3498db); color: white; }
    .frota-btn-azul:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(41, 128, 185, 0.4); }
    .frota-btn-sm { padding: 6px 10px; font-size: 10px; }
    .frota-btn-icon { padding: 7px 10px; }
    
    .frota-table-container { background: #f8f9fa; border: 2px solid #e9ecef; border-radius: 10px; overflow: hidden; }
    .frota-table { width: 100%; border-collapse: collapse; }
    .frota-table thead { background: linear-gradient(135deg, #2c3e50, #34495e); color: white; }
    .frota-table thead.frota-reboque { background: linear-gradient(135deg, #9b59b6, #8e44ad); }
    .frota-table th { padding: 12px 10px; text-align: left; font-weight: 600; font-size: 10px; text-transform: uppercase; }
    .frota-table td { padding: 10px; border-bottom: 1px solid #e9ecef; font-size: 12px; }
    .frota-table tbody tr { background: white; }
    .frota-table tbody tr:hover { background: #fff5f5; }
    .frota-table-actions { display: flex; gap: 5px; }
    
    .frota-badge { padding: 4px 8px; border-radius: 12px; font-size: 10px; font-weight: 600; }
    .frota-badge-success { background: #d4edda; color: #155724; }
    .frota-badge-danger { background: #f8d7da; color: #721c24; }
    .frota-badge-warning { background: #fff3cd; color: #856404; }
    .frota-badge-info { background: #cce5ff; color: #004085; }
    .frota-badge-purple { background: #e8daef; color: #6c3483; }
    .frota-badge-secondary { background: #e9ecef; color: #495057; }
    
    .frota-section-box { background: #f8f9fa; border: 2px solid #e9ecef; border-radius: 10px; padding: 18px; margin-bottom: 18px; transition: all 0.2s ease; }
    .frota-section-box:hover { border-color: #e74c3c; }
    .frota-section-box.frota-reboque:hover { border-color: #9b59b6; }
    .frota-section-box h2 { color: #2c3e50; font-size: 15px; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 3px solid #e74c3c; }
    .frota-section-box.frota-reboque h2 { border-bottom-color: #9b59b6; }
    
    .frota-form-group { margin-bottom: 0; }
    .frota-form-group label { display: block; margin-bottom: 3px; font-weight: 600; color: #495057; font-size: 10px; }
    .frota-form-group input, .frota-form-group textarea, .frota-form-group select { width: 100%; padding: 7px 9px; border: 2px solid #dee2e6; border-radius: 6px; font-size: 12px; background: white; }
    .frota-form-group input:focus, .frota-form-group textarea:focus, .frota-form-group select:focus { outline: none; border-color: #e74c3c; }
    .frota-form-group input:disabled { background-color: #e9ecef; }
    .frota-form-group textarea { resize: vertical; min-height: 50px; }
    
    .frota-input-btn-group { display: flex; gap: 4px; }
    .frota-input-btn-group input { flex: 1; }
    
    .frota-radio-group { display: flex; gap: 8px; flex-wrap: wrap; }
    .frota-radio-wrapper { display: flex; align-items: center; gap: 5px; padding: 6px 10px; background: white; border: 2px solid #dee2e6; border-radius: 6px; cursor: pointer; font-size: 11px; transition: all 0.2s ease; }
    .frota-radio-wrapper:hover { border-color: #e74c3c; }
    .frota-radio-wrapper.selected { border-color: #e74c3c; background: #fff5f5; }
    .frota-radio-wrapper input { width: 14px; height: 14px; accent-color: #e74c3c; }
    
    .frota-form-actions { display: flex; gap: 12px; margin-top: 18px; }
    .frota-btn-guardar { flex: 2; padding: 12px 20px; background: linear-gradient(135deg, #e74c3c, #c0392b); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 700; transition: all 0.2s ease; }
    .frota-btn-guardar:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(231, 76, 60, 0.4); }
    .frota-btn-guardar.frota-reboque { background: linear-gradient(135deg, #9b59b6, #8e44ad); }
    .frota-btn-guardar.frota-reboque:hover { box-shadow: 0 4px 12px rgba(155, 89, 182, 0.4); }
    
    .frota-alert { padding: 10px 14px; border-radius: 8px; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; font-size: 12px; }
    .frota-alert-success { background: #d4edda; color: #155724; }
    .frota-alert-error { background: #f8d7da; color: #721c24; }
    .frota-alert-warning { background: #fff3cd; color: #856404; }
    .frota-alert-close { margin-left: auto; background: none; border: none; font-size: 16px; cursor: pointer; }
    
    .frota-alerta-vencimento { background: linear-gradient(135deg, #e74c3c, #c0392b); color: white; padding: 12px 15px; border-radius: 10px; margin-bottom: 15px; display: flex; align-items: center; gap: 12px; }
    .frota-alerta-vencimento-icon { font-size: 24px; }
    .frota-alerta-vencimento-text h4 { margin-bottom: 3px; font-size: 13px; }
    .frota-alerta-vencimento-text p { font-size: 11px; }
    
    .frota-intervencao-item { background: white; border: 2px solid #e9ecef; border-radius: 8px; padding: 12px; margin-bottom: 8px; }
    .frota-intervencao-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px solid #e9ecef; }
    
    .frota-modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; justify-content: center; align-items: center; backdrop-filter: blur(4px); }
    .frota-modal-overlay.active { display: flex; }
    .frota-modal-content { background: white; padding: 22px; border-radius: 12px; max-width: 500px; width: 95%; animation: frotaSlideUp 0.3s ease-out; }
    @keyframes frotaSlideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    /* PORTAL CENTRAL v6.0 - CSS PREFIXADO                                              */
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    
    /* Login Screen */
    .portal-login-container { 
      min-height: 100vh; 
      display: flex; 
      align-items: center; 
      justify-content: center;
      background: linear-gradient(135deg, #0f172a 0%, #1e3a5f 50%, #0f172a 100%);
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 99999;
    }
    .portal-login-container.portal-hidden { display: none; }
    
    .portal-login-box { 
      background: white; 
      border-radius: 20px; 
      padding: 50px; 
      width: 100%; 
      max-width: 440px;
      box-shadow: 0 25px 80px rgba(0,0,0,0.5);
      animation: portalFadeIn 0.5s ease-out;
    }
    
    @keyframes portalFadeIn { 
      from { opacity: 0; transform: translateY(20px); } 
      to { opacity: 1; transform: translateY(0); } 
    }
    
    .portal-login-logo { text-align: center; margin-bottom: 30px; }
    .portal-login-logo-icon { font-size: 50px; margin-bottom: 15px; }
    .portal-login-logo h1 { font-size: 24px; font-weight: 700; color: #1e293b; margin: 0; }
    .portal-login-logo p { font-size: 14px; color: #64748b; margin-top: 5px; }
    
    .portal-form-group { margin-bottom: 20px; }
    .portal-form-group label { 
      display: block; 
      margin-bottom: 8px; 
      font-weight: 600; 
      color: #374151; 
      font-size: 14px; 
    }
    .portal-form-group input, 
    .portal-form-group select { 
      width: 100%; 
      padding: 14px 18px; 
      border: 2px solid #e2e8f0; 
      border-radius: 10px; 
      font-size: 15px; 
      transition: all 0.2s;
      box-sizing: border-box;
    }
    .portal-form-group input:focus, 
    .portal-form-group select:focus { 
      outline: none; 
      border-color: #3b82f6; 
      box-shadow: 0 0 0 4px rgba(59,130,246,0.1); 
    }
    
    .portal-btn { 
      padding: 14px 24px; 
      border-radius: 10px; 
      font-weight: 600; 
      cursor: pointer; 
      transition: all 0.2s; 
      border: none;
      width: 100%;
      font-size: 16px;
    }
    .portal-btn-primary { 
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); 
      color: white; 
    }
    .portal-btn-primary:hover { 
      transform: translateY(-2px); 
      box-shadow: 0 8px 20px rgba(59,130,246,0.4); 
    }
    
    .portal-login-demo { 
      text-align: center; 
      color: #94a3b8; 
      font-size: 13px; 
      margin-top: 25px;
      padding-top: 20px;
      border-top: 1px solid #e2e8f0;
    }
    .portal-login-demo code {
      background: #f1f5f9;
      padding: 2px 8px;
      border-radius: 4px;
      font-family: monospace;
      color: #475569;
    }
    
    .portal-login-error {
      background: #fee2e2;
      color: #dc2626;
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 14px;
      display: none;
    }
    .portal-login-error.portal-show { display: block; }
    
    /* ERP Container - esconde atÃ© login */
    .portal-erp-container { display: none; }
    .portal-erp-container.portal-active { display: block; }
    
    /* User Header Bar */
    .portal-user-bar {
      position: fixed;
      top: 0;
      left: 280px;
      right: 0;
      height: 50px;
      background: linear-gradient(135deg, #1e3a5f 0%, #0f172a 100%);
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 20px;
      z-index: 1000;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .portal-user-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .portal-user-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: linear-gradient(135deg, #3b82f6, #8b5cf6);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 700;
      font-size: 14px;
      cursor: pointer;
    }
    
    .portal-user-details {
      color: white;
    }
    .portal-user-name { font-weight: 600; font-size: 14px; }
    .portal-user-role { font-size: 11px; opacity: 0.8; }
    
    .portal-user-actions {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    .portal-idioma-select {
      background: rgba(255,255,255,0.1);
      color: white;
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 6px;
      padding: 6px 10px;
      font-size: 12px;
      cursor: pointer;
    }
    .portal-idioma-select option { color: #1e293b; }
    
    .portal-btn-logout {
      background: rgba(239, 68, 68, 0.2);
      color: #fca5a5;
      border: 1px solid rgba(239, 68, 68, 0.3);
      padding: 6px 14px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .portal-btn-logout:hover {
      background: rgba(239, 68, 68, 0.4);
      color: white;
    }
    
    /* Ajustar main-content para dar espaÃ§o Ã  user bar */
    .portal-erp-container.portal-active .main-content {
      padding-top: 60px;
    }
    
    /* PermissÃµes - esconder elementos sem permissÃ£o */
    .portal-no-permission { display: none !important; }
    
    /* Menu items com permissÃ£o bloqueada */
    .portal-menu-blocked {
      opacity: 0.4;
      pointer-events: none;
    }
    .portal-menu-blocked::after {
      content: 'ğŸ”’';
      margin-left: 8px;
      font-size: 10px;
    }


    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       MÃ“DULO ADMINISTRAÃ‡ÃƒO - CSS v6.1
       Prefixo: admin-
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    
    /* Container principal */
    .admin-container { padding: 0; }
    
    /* Header com gradiente */
    .admin-header {
      padding: 24px 32px;
      border-radius: 16px 16px 0 0;
      margin-bottom: 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .admin-header-armazens { background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); }
    .admin-header-utilizadores { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); }
    .admin-header-comerciais { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
    .admin-header-equipas { background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%); }
    .admin-header-rotas { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
    .admin-header-permissoes { background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); }
    
    .admin-header h2 {
      color: white;
      font-size: 1.75rem;
      font-weight: 700;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .admin-header p {
      color: rgba(255,255,255,0.85);
      margin: 4px 0 0 0;
      font-size: 0.95rem;
    }
    
    .admin-btn-novo {
      background: white;
      color: #1e293b;
      padding: 10px 20px;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      border: none;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.2s;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }
    .admin-btn-novo:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    
    /* KPIs */
    .admin-kpis {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      padding: 20px 24px;
      background: #f8fafc;
      border-bottom: 1px solid #e2e8f0;
    }
    .admin-kpi-card {
      background: white;
      padding: 16px 20px;
      border-radius: 12px;
      border: 1px solid #e2e8f0;
      display: flex;
      align-items: center;
      gap: 14px;
    }
    .admin-kpi-icon {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
    }
    .admin-kpi-icon.indigo { background: #eef2ff; }
    .admin-kpi-icon.blue { background: #eff6ff; }
    .admin-kpi-icon.amber { background: #fffbeb; }
    .admin-kpi-icon.cyan { background: #ecfeff; }
    .admin-kpi-icon.green { background: #ecfdf5; }
    .admin-kpi-icon.purple { background: #faf5ff; }
    .admin-kpi-icon.red { background: #fef2f2; }
    .admin-kpi-icon.gray { background: #f1f5f9; }
    
    .admin-kpi-info h4 {
      color: #64748b;
      font-size: 0.8rem;
      font-weight: 500;
      margin: 0 0 4px 0;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .admin-kpi-info .valor {
      color: #1e293b;
      font-size: 1.5rem;
      font-weight: 700;
      margin: 0;
    }
    
    /* Card principal */
    .admin-card {
      background: white;
      border-radius: 0 0 16px 16px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
      overflow: hidden;
    }
    
    /* Toolbar */
    .admin-toolbar {
      padding: 16px 24px;
      display: flex;
      align-items: center;
      gap: 12px;
      border-bottom: 1px solid #e2e8f0;
      flex-wrap: wrap;
    }
    .admin-search {
      flex: 1;
      min-width: 250px;
      position: relative;
    }
    .admin-search input {
      width: 100%;
      padding: 10px 16px 10px 42px;
      border: 1px solid #e2e8f0;
      border-radius: 10px;
      font-size: 0.9rem;
      transition: all 0.2s;
    }
    .admin-search input:focus {
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59,130,246,0.15);
      outline: none;
    }
    .admin-search::before {
      content: 'ğŸ”';
      position: absolute;
      left: 14px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 1rem;
    }
    
    .admin-filter {
      padding: 10px 16px;
      border: 1px solid #e2e8f0;
      border-radius: 10px;
      font-size: 0.9rem;
      background: white;
      cursor: pointer;
      min-width: 140px;
    }
    .admin-filter:focus {
      border-color: #3b82f6;
      outline: none;
    }
    
    .admin-counter {
      color: #64748b;
      font-size: 0.85rem;
      background: #f1f5f9;
      padding: 8px 14px;
      border-radius: 8px;
    }
    
    /* Tabela */
    .admin-table-container {
      overflow-x: auto;
    }
    .admin-table {
      width: 100%;
      border-collapse: collapse;
    }
    .admin-table th {
      background: #f8fafc;
      padding: 14px 16px;
      text-align: left;
      font-size: 0.8rem;
      font-weight: 600;
      color: #64748b;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: 2px solid #e2e8f0;
      white-space: nowrap;
    }
    .admin-table td {
      padding: 14px 16px;
      border-bottom: 1px solid #f1f5f9;
      font-size: 0.9rem;
      color: #334155;
    }
    .admin-table tr:hover {
      background: #f8fafc;
    }
    .admin-table tr:last-child td {
      border-bottom: none;
    }
    
    /* Badges */
    .admin-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 600;
    }
    .admin-badge-ativo { background: #dcfce7; color: #166534; }
    .admin-badge-inativo { background: #fef3c7; color: #92400e; }
    .admin-badge-bloqueado { background: #fee2e2; color: #991b1b; }
    .admin-badge-manutencao { background: #e0e7ff; color: #3730a3; }
    .admin-badge-nacional { background: #dbeafe; color: #1e40af; }
    .admin-badge-internacional { background: #fae8ff; color: #86198f; }
    
    /* AÃ§Ãµes */
    .admin-actions {
      display: flex;
      gap: 6px;
    }
    .admin-btn-action {
      width: 32px;
      height: 32px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      font-size: 0.9rem;
    }
    .admin-btn-edit {
      background: #eff6ff;
      color: #2563eb;
    }
    .admin-btn-edit:hover { background: #dbeafe; }
    .admin-btn-delete {
      background: #fef2f2;
      color: #dc2626;
    }
    .admin-btn-delete:hover { background: #fee2e2; }
    .admin-btn-view {
      background: #f0fdf4;
      color: #16a34a;
    }
    .admin-btn-view:hover { background: #dcfce7; }
    
    /* Empty state */
    .admin-empty {
      padding: 60px 20px;
      text-align: center;
    }
    .admin-empty-icon {
      font-size: 4rem;
      margin-bottom: 16px;
      opacity: 0.5;
    }
    .admin-empty h4 {
      color: #64748b;
      font-size: 1.1rem;
      margin: 0 0 8px 0;
    }
    .admin-empty p {
      color: #94a3b8;
      font-size: 0.9rem;
      margin: 0;
    }
    
    /* Modal */
    .admin-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 10000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .admin-modal.active {
      display: flex;
    }
    .admin-modal-content {
      background: white;
      border-radius: 16px;
      max-width: 700px;
      width: 100%;
      max-height: 90vh;
      overflow: hidden;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    .admin-modal-header {
      padding: 20px 24px;
      border-bottom: 1px solid #e2e8f0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .admin-modal-header h3 {
      margin: 0;
      font-size: 1.25rem;
      color: #1e293b;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .admin-modal-close {
      width: 36px;
      height: 36px;
      border: none;
      background: #f1f5f9;
      border-radius: 10px;
      cursor: pointer;
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }
    .admin-modal-close:hover {
      background: #e2e8f0;
    }
    .admin-modal-body {
      padding: 24px;
      max-height: calc(90vh - 160px);
      overflow-y: auto;
    }
    .admin-modal-footer {
      padding: 16px 24px;
      border-top: 1px solid #e2e8f0;
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      background: #f8fafc;
    }
    
    /* Form */
    .admin-form-row {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
      margin-bottom: 16px;
    }
    .admin-form-row.full {
      grid-template-columns: 1fr;
    }
    .admin-form-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .admin-form-group label {
      font-size: 0.85rem;
      font-weight: 600;
      color: #475569;
    }
    .admin-form-group label .required {
      color: #ef4444;
    }
    .admin-form-group input,
    .admin-form-group select,
    .admin-form-group textarea {
      padding: 10px 14px;
      border: 1px solid #e2e8f0;
      border-radius: 10px;
      font-size: 0.9rem;
      transition: all 0.2s;
    }
    .admin-form-group input:focus,
    .admin-form-group select:focus,
    .admin-form-group textarea:focus {
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59,130,246,0.15);
      outline: none;
    }
    .admin-form-group textarea {
      resize: vertical;
      min-height: 80px;
    }
    .admin-form-group .input-with-btn {
      display: flex;
      gap: 8px;
    }
    .admin-form-group .input-with-btn input {
      flex: 1;
    }
    .admin-form-group .input-with-btn button {
      padding: 10px 14px;
      border: 1px solid #e2e8f0;
      background: #f8fafc;
      border-radius: 10px;
      cursor: pointer;
      font-size: 1rem;
      transition: all 0.2s;
    }
    .admin-form-group .input-with-btn button:hover {
      background: #e2e8f0;
    }
    
    /* Checkbox list */
    .admin-checkbox-list {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
      max-height: 200px;
      overflow-y: auto;
      padding: 12px;
      background: #f8fafc;
      border-radius: 10px;
      border: 1px solid #e2e8f0;
    }
    .admin-checkbox-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: white;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .admin-checkbox-item:hover {
      background: #eff6ff;
    }
    .admin-checkbox-item input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }
    .admin-checkbox-item label {
      cursor: pointer;
      font-size: 0.9rem;
      color: #334155;
    }
    
    /* BotÃµes */
    .admin-btn {
      padding: 10px 20px;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      border: none;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    .admin-btn-primary {
      background: #3b82f6;
      color: white;
    }
    .admin-btn-primary:hover { background: #2563eb; }
    .admin-btn-success {
      background: #10b981;
      color: white;
    }
    .admin-btn-success:hover { background: #059669; }
    .admin-btn-secondary {
      background: #e2e8f0;
      color: #475569;
    }
    .admin-btn-secondary:hover { background: #cbd5e1; }
    .admin-btn-danger {
      background: #ef4444;
      color: white;
    }
    .admin-btn-danger:hover { background: #dc2626; }
    
    /* SecÃ§Ã£o de permissÃµes */
    .admin-perm-section {
      margin-bottom: 20px;
    }
    .admin-perm-section h4 {
      font-size: 0.9rem;
      font-weight: 600;
      color: #1e293b;
      margin: 0 0 12px 0;
      padding-bottom: 8px;
      border-bottom: 2px solid #e2e8f0;
    }
    .admin-perm-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 8px;
    }
    .admin-perm-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 14px;
      background: #f8fafc;
      border-radius: 10px;
      border: 1px solid #e2e8f0;
      cursor: pointer;
      transition: all 0.2s;
    }
    .admin-perm-item:hover {
      border-color: #3b82f6;
      background: #eff6ff;
    }
    .admin-perm-item input {
      width: 18px;
      height: 18px;
    }
    .admin-perm-item span {
      font-size: 0.9rem;
      color: #334155;
    }
    
    /* Tabs de permissÃµes */
    .admin-tabs {
      display: flex;
      gap: 4px;
      padding: 16px 24px;
      background: #f8fafc;
      border-bottom: 1px solid #e2e8f0;
    }
    .admin-tab {
      padding: 10px 20px;
      border: none;
      background: transparent;
      font-weight: 500;
      color: #64748b;
      cursor: pointer;
      border-radius: 10px;
      transition: all 0.2s;
    }
    .admin-tab:hover {
      background: #e2e8f0;
    }
    .admin-tab.active {
      background: white;
      color: #1e293b;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .admin-tab-content {
      display: none;
      padding: 24px;
    }
    .admin-tab-content.active {
      display: block;
    }
    
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       CONTROLO DE FATURAÃ‡ÃƒO - Tabela com cabeÃ§alho azul fixo (9 colunas)
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    #tabelaControloFaturacao {
      width: 100%;
      border-collapse: collapse;
    }
    
    #tabelaControloFaturacao thead tr {
      background-color: #1e3a5f !important;
    }
    
    #tabelaControloFaturacao thead th {
      background-color: #1e3a5f !important;
      color: white !important;
      padding: 12px 8px !important;
      font-weight: 600 !important;
      font-size: 11px !important;
      border: none !important;
      position: sticky;
      top: 0;
      z-index: 10;
      white-space: nowrap;
    }
    
    #tabelaControloFaturacao tbody tr {
      border-bottom: 1px solid #e2e8f0;
    }
    
    #tabelaControloFaturacao tbody tr:hover {
      background-color: #f8fafc;
    }
    
    #tabelaControloFaturacao tbody td {
      padding: 10px 8px;
      font-size: 13px;
    }

  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <!-- i18next - Biblioteca de InternacionalizaÃ§Ã£o -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/i18next/23.7.6/i18next.min.js"></script>
  
  <!-- HERE Maps API v3 - Mapas Profissionais -->
  <script src="https://js.api.here.com/v3/3.1/mapsjs-core.js"></script>
  <script src="https://js.api.here.com/v3/3.1/mapsjs-service.js"></script>
  <script src="https://js.api.here.com/v3/3.1/mapsjs-ui.js"></script>
  <script src="https://js.api.here.com/v3/3.1/mapsjs-mapevents.js"></script>
  <link rel="stylesheet" href="https://js.api.here.com/v3/3.1/mapsjs-ui.css">
  
  <!-- Leaflet + OpenRouteService - Mapas Gratuitos para CamiÃµes -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  
  <!-- Google Maps Places API para pesquisa de empresas -->
  <script>
    // ConfiguraÃ§Ã£o Google Maps Places API
    // API Key da EMEUTRANS - Ativa atÃ© 2025
    var googleMapsConfig = {
        apiKey: 'AIzaSyDd3DrTRZ-GG55BOWZ_wlTLQEjbeLfzF5Y',
        loaded: false
    };
    
    // Carregar Google Maps dinamicamente
    function carregarGoogleMaps(callback) {
        if (googleMapsConfig.loaded && window.google && window.google.maps) {
            if (callback) callback();
            return;
        }
        
        // Verificar se jÃ¡ estÃ¡ a carregar
        if (document.getElementById('google-maps-script')) {
            // Aguardar carregamento
            const checkInterval = setInterval(function() {
                if (window.google && window.google.maps && window.google.maps.places) {
                    clearInterval(checkInterval);
                    googleMapsConfig.loaded = true;
                    if (callback) callback();
                }
            }, 100);
            return;
        }
        
        // Criar callback global
        window.googleMapsCallback = function() {
            googleMapsConfig.loaded = true;
            console.log('âœ… Google Maps Places API carregado');
            if (callback) callback();
        };
        
        // Adicionar script
        const script = document.createElement('script');
        script.id = 'google-maps-script';
        script.src = 'https://maps.googleapis.com/maps/api/js?key=' + googleMapsConfig.apiKey + '&libraries=places&callback=googleMapsCallback';
        script.async = true;
        script.defer = true;
        document.head.appendChild(script);
    }
  </script>
  
  <!-- Tesseract.js para OCR de imagens -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
  
  <!-- PDF.js para leitura de PDFs -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script>
    // Configurar worker do PDF.js
    if (typeof pdfjsLib !== 'undefined') {
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    }
  </script>
</head>
<body>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <!-- PORTAL CENTRAL v6.0 - ECRÃƒ DE LOGIN                                              -->
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  
  <div id="portalLoginScreen" class="portal-login-container">
    <div class="portal-login-box">
      <div class="portal-login-logo">
        <div class="flex items-center justify-center gap-3 mb-4">
          <div class="flex flex-col gap-1.5">
            <div class="w-10 h-2 rounded-r-full" style="background: #B5BD00;"></div>
            <div class="w-8 h-2 rounded-r-full ml-1" style="background: #FF6600;"></div>
            <div class="w-6 h-2 rounded-r-full ml-2" style="background: #307FE2;"></div>
          </div>
          <div>
            <h1 style="font-size: 28px; font-weight: 700; color: #1e293b; margin: 0;">Emeutrans</h1>
          </div>
        </div>
        <p style="color: #64748b; font-size: 14px;">Sistema Integrado de GestÃ£o LogÃ­stica</p>
      </div>
      
      <div id="portalLoginError" class="portal-login-error">
        <span id="portalLoginErrorMsg">Credenciais invÃ¡lidas</span>
      </div>
      
      <form onsubmit="portalFazerLogin(event)">
        <div class="portal-form-group">
          <label>ğŸ‘¤ Utilizador / Email</label>
          <input type="text" id="portalLoginUser" placeholder="Introduza o seu utilizador" required>
        </div>
        
        <div class="portal-form-group">
          <label>ğŸ”’ Password</label>
          <input type="password" id="portalLoginPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required>
        </div>
        
        <div class="portal-form-group">
          <label>ğŸŒ Idioma</label>
          <select id="portalLoginIdioma">
            <option value="pt">ğŸ‡µğŸ‡¹ PortuguÃªs</option>
            <option value="en">ğŸ‡¬ğŸ‡§ English</option>
            <option value="es">ğŸ‡ªğŸ‡¸ EspaÃ±ol</option>
            <option value="fr">ğŸ‡«ğŸ‡· FranÃ§ais</option>
            <option value="de">ğŸ‡©ğŸ‡ª Deutsch</option>
            <option value="it">ğŸ‡®ğŸ‡¹ Italiano</option>
            <option value="nl">ğŸ‡³ğŸ‡± Nederlands</option>
            <option value="pl">ğŸ‡µğŸ‡± Polski</option>
            <option value="ro">ğŸ‡·ğŸ‡´ RomÃ¢nÄƒ</option>
            <option value="bg">ğŸ‡§ğŸ‡¬ Ğ‘ÑŠĞ»Ğ³Ğ°Ñ€ÑĞºĞ¸</option>
            <option value="cs">ğŸ‡¨ğŸ‡¿ ÄŒeÅ¡tina</option>
            <option value="hu">ğŸ‡­ğŸ‡º Magyar</option>
            <option value="el">ğŸ‡¬ğŸ‡· Î•Î»Î»Î·Î½Î¹ÎºÎ¬</option>
            <option value="sv">ğŸ‡¸ğŸ‡ª Svenska</option>
            <option value="da">ğŸ‡©ğŸ‡° Dansk</option>
            <option value="fi">ğŸ‡«ğŸ‡® Suomi</option>
            <option value="no">ğŸ‡³ğŸ‡´ Norsk</option>
            <option value="hr">ğŸ‡­ğŸ‡· Hrvatski</option>
            <option value="sk">ğŸ‡¸ğŸ‡° SlovenÄina</option>
            <option value="sl">ğŸ‡¸ğŸ‡® SlovenÅ¡Äina</option>
            <option value="lt">ğŸ‡±ğŸ‡¹ LietuviÅ³</option>
            <option value="lv">ğŸ‡±ğŸ‡» LatvieÅ¡u</option>
            <option value="et">ğŸ‡ªğŸ‡ª Eesti</option>
            <option value="uk">ğŸ‡ºğŸ‡¦ Ğ£ĞºÑ€Ğ°Ñ—Ğ½ÑÑŒĞºĞ°</option>
            <option value="ru">ğŸ‡·ğŸ‡º Ğ ÑƒÑÑĞºĞ¸Ğ¹</option>
            <option value="tr">ğŸ‡¹ğŸ‡· TÃ¼rkÃ§e</option>
            <option value="ar">ğŸ‡¸ğŸ‡¦ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
            <option value="zh">ğŸ‡¨ğŸ‡³ ä¸­æ–‡</option>
            <option value="ja">ğŸ‡¯ğŸ‡µ æ—¥æœ¬èª</option>
            <option value="ko">ğŸ‡°ğŸ‡· í•œêµ­ì–´</option>
          </select>
        </div>
        
        <button type="submit" class="portal-btn portal-btn-primary" style="margin-top: 10px;">
          ğŸš€ Entrar no Sistema
        </button>
      </form>
      
      <!-- BOTÃƒO DE ENTRADA DIRETA (para testes) -->
      <div style="margin-top: 15px; padding-top: 15px; border-top: 1px dashed #ddd;">
        <button type="button"
                onclick="document.getElementById('portalLoginScreen').style.display='none'; document.getElementById('portalErpContainer').style.display='block'; document.getElementById('portalErpContainer').classList.add('portal-active'); window.portalUtilizadorAtual={id:1,username:'admin',nome:'Administrador Sistema',email:'admin@emeutrans.pt',perfil:'Administrador',idioma:'pt',passwordTrocada:true}; window.portalIdiomaAtual='pt'; var a=document.getElementById('portalUserAvatar'); var n=document.getElementById('portalUserName'); var r=document.getElementById('portalUserRole'); if(a)a.textContent='AD'; if(n)n.textContent='Administrador Sistema'; if(r)r.textContent='Administrador'; alert('âœ… Entrada bem sucedida!\n\nğŸ“Œ VERSÃƒO: 6.14 (22/12/2024)\nğŸ” Controlo FaturaÃ§Ã£o INCLUÃDO');"
                style="width: 100%; padding: 12px; background: linear-gradient(135deg, #10b981, #059669); color: white; border: none; border-radius: 8px; font-size: 15px; font-weight: 600; cursor: pointer;">
          âš¡ ENTRAR DIRETAMENTE (Admin)
        </button>
        <p style="font-size: 11px; color: #888; text-align: center; margin-top: 8px;">Clique aqui se o login normal nÃ£o funcionar</p>
      </div>
      
      <div class="portal-login-demo">
        <p style="margin-bottom: 8px;">ğŸ”‘ <strong>Utilizadores Demo:</strong></p>
        <p><code>admin</code> / <code>admin123</code> â†’ Administrador</p>
        <p><code>operador</code> / <code>oper123</code> â†’ Operador LogÃ­stica</p>
        <p><code>faturacao</code> / <code>fat123</code> â†’ FaturaÃ§Ã£o</p>
        <p style="margin-top: 10px;">
          <button type="button" onclick="localStorage.removeItem('erpSessaoPortal'); alert('âœ… SessÃ£o limpa! Tente fazer login novamente.'); location.reload();" 
                  style="font-size: 11px; padding: 4px 10px; background: #ef4444; color: white; border: none; border-radius: 4px; cursor: pointer;">
            ğŸ—‘ï¸ Limpar SessÃ£o (se tiver problemas)
          </button>
        </p>
      </div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <!-- MODAL TROCAR PASSWORD (Primeiro Login)                                           -->
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  
  <div id="portalTrocarPasswordModal" class="portal-hidden" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 100001; display: none; align-items: center; justify-content: center;">
    <div style="background: white; border-radius: 16px; padding: 32px; max-width: 450px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
      <div style="text-align: center; margin-bottom: 24px;">
        <span style="font-size: 4rem;">ğŸ”</span>
        <h2 style="color: #1e293b; margin: 16px 0 8px 0;">Trocar Password</h2>
        <p style="color: #64748b; font-size: 0.95rem;">Por razÃµes de seguranÃ§a, deve definir uma nova password pessoal.</p>
      </div>
      
      <div style="margin-bottom: 20px;">
        <label style="display: block; font-weight: 600; color: #475569; margin-bottom: 6px;">Nova Password <span style="color: #ef4444;">*</span></label>
        <div style="display: flex; gap: 8px;">
          <input type="password" id="portalNovaPassword1" placeholder="MÃ­nimo 6 caracteres" style="flex: 1; padding: 12px 16px; border: 1px solid #e2e8f0; border-radius: 10px; font-size: 1rem;">
          <button type="button" onclick="portalToggleNovaPassword(1)" style="padding: 12px; border: 1px solid #e2e8f0; background: #f8fafc; border-radius: 10px; cursor: pointer;">ğŸ‘ï¸</button>
        </div>
      </div>
      
      <div style="margin-bottom: 24px;">
        <label style="display: block; font-weight: 600; color: #475569; margin-bottom: 6px;">Confirmar Password <span style="color: #ef4444;">*</span></label>
        <div style="display: flex; gap: 8px;">
          <input type="password" id="portalNovaPassword2" placeholder="Repita a password" style="flex: 1; padding: 12px 16px; border: 1px solid #e2e8f0; border-radius: 10px; font-size: 1rem;">
          <button type="button" onclick="portalToggleNovaPassword(2)" style="padding: 12px; border: 1px solid #e2e8f0; background: #f8fafc; border-radius: 10px; cursor: pointer;">ğŸ‘ï¸</button>
        </div>
      </div>
      
      <div id="portalTrocarPasswordErro" style="display: none; background: #fef2f2; border: 1px solid #fecaca; color: #dc2626; padding: 12px; border-radius: 10px; margin-bottom: 16px; font-size: 0.9rem;"></div>
      
      <button onclick="portalConfirmarNovaPassword()" style="width: 100%; padding: 14px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; border-radius: 10px; font-size: 1rem; font-weight: 600; cursor: pointer;">
        âœ… Confirmar Nova Password
      </button>
      
      <p style="text-align: center; margin-top: 16px; color: #94a3b8; font-size: 0.8rem;">
        âš ï¸ A password serÃ¡ guardada de forma segura no sistema.
      </p>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <!-- ERP CONTAINER - SÃ³ visÃ­vel apÃ³s login                                            -->
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  
  <div id="portalErpContainer" class="portal-erp-container">
  
    <!-- Barra do Utilizador (topo) -->
    <div class="portal-user-bar">
      <div class="portal-user-info">
        <div class="portal-user-avatar" id="portalUserAvatar">AD</div>
        <div class="portal-user-details">
          <div class="portal-user-name" id="portalUserName">Administrador</div>
          <div class="portal-user-role" id="portalUserRole">Administrador</div>
        </div>
      </div>
      <div class="portal-user-actions">
        <select class="portal-idioma-select" id="portalIdiomaSelect" onchange="portalMudarIdioma(this.value)">
          <option value="pt">ğŸ‡µğŸ‡¹ PT</option>
          <option value="en">ğŸ‡¬ğŸ‡§ EN</option>
          <option value="es">ğŸ‡ªğŸ‡¸ ES</option>
          <option value="fr">ğŸ‡«ğŸ‡· FR</option>
          <option value="de">ğŸ‡©ğŸ‡ª DE</option>
          <option value="it">ğŸ‡®ğŸ‡¹ IT</option>
          <option value="nl">ğŸ‡³ğŸ‡± NL</option>
          <option value="pl">ğŸ‡µğŸ‡± PL</option>
          <option value="ro">ğŸ‡·ğŸ‡´ RO</option>
          <option value="bg">ğŸ‡§ğŸ‡¬ BG</option>
          <option value="cs">ğŸ‡¨ğŸ‡¿ CS</option>
          <option value="hu">ğŸ‡­ğŸ‡º HU</option>
          <option value="el">ğŸ‡¬ğŸ‡· EL</option>
          <option value="sv">ğŸ‡¸ğŸ‡ª SV</option>
          <option value="da">ğŸ‡©ğŸ‡° DA</option>
          <option value="fi">ğŸ‡«ğŸ‡® FI</option>
          <option value="no">ğŸ‡³ğŸ‡´ NO</option>
          <option value="hr">ğŸ‡­ğŸ‡· HR</option>
          <option value="sk">ğŸ‡¸ğŸ‡° SK</option>
          <option value="sl">ğŸ‡¸ğŸ‡® SL</option>
          <option value="lt">ğŸ‡±ğŸ‡¹ LT</option>
          <option value="lv">ğŸ‡±ğŸ‡» LV</option>
          <option value="et">ğŸ‡ªğŸ‡ª ET</option>
          <option value="uk">ğŸ‡ºğŸ‡¦ UK</option>
          <option value="ru">ğŸ‡·ğŸ‡º RU</option>
          <option value="tr">ğŸ‡¹ğŸ‡· TR</option>
          <option value="ar">ğŸ‡¸ğŸ‡¦ AR</option>
          <option value="zh">ğŸ‡¨ğŸ‡³ ZH</option>
          <option value="ja">ğŸ‡¯ğŸ‡µ JA</option>
          <option value="ko">ğŸ‡°ğŸ‡· KO</option>
        </select>
        <button class="portal-btn-logout" onclick="portalFazerLogout()">
          ğŸšª Sair
        </button>
      </div>
    </div>

  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="p-6 border-b border-emerald-700">
      <!-- Logo Emeutrans - Barras separadas -->
      <div class="flex items-center gap-3">
        <div class="flex flex-col gap-2">
          <div class="w-12 h-2.5 rounded-r-full" style="background: #B5BD00;"></div>
          <div class="w-10 h-2.5 rounded-r-full ml-1" style="background: #FF6600;"></div>
          <div class="w-8 h-2.5 rounded-r-full ml-2" style="background: #307FE2;"></div>
        </div>
        <div>
          <h1 class="text-lg font-bold text-white">Emeutrans</h1>
          <p class="text-emerald-300 text-xs">Sistema ERP</p>
        </div>
      </div>
    </div>
    
    <nav class="py-4 overflow-y-auto" style="max-height: calc(100vh - 180px);">
      
      <!-- â•â•â•â•â•â•â•â•â•â•â• 1. ADMINISTRAÃ‡ÃƒO â•â•â•â•â•â•â•â•â•â•â• -->
      <div class="menu-section">
        <div class="menu-title" onclick="toggleMenu('menu-administracao')">
          <span>âš™ï¸ AdministraÃ§Ã£o</span>
          <span class="menu-arrow">â–¼</span>
        </div>
        <div id="menu-administracao" class="menu-items menu-collapsed" style="display: none;">
          <div class="nav-item" onclick="navegarPara('dashboard')">
            <span>ğŸ“Š</span>
            <span>Dashboard Geral</span>
          </div>
          <div class="nav-item" onclick="navegarPara('configuracoes')">
            <span>ğŸ”§</span>
            <span>ConfiguraÃ§Ãµes</span>
          </div>
          <div class="nav-item" onclick="navegarPara('utilizadores')">
            <span>ğŸ‘¤</span>
            <span>Utilizadores</span>
          </div>
          <div class="nav-item" onclick="navegarPara('permissoes')">
            <span>ğŸ”</span>
            <span>PermissÃµes</span>
          </div>
          <div class="nav-item" onclick="navegarPara('comerciais')">
            <span>ğŸ’¼</span>
            <span>Comerciais</span>
          </div>
          <div class="nav-item" onclick="navegarPara('equipas')">
            <span>ğŸ‘¥</span>
            <span>Equipas</span>
          </div>
          <div class="nav-item" onclick="navegarPara('rotas')">
            <span>ğŸ›£ï¸</span>
            <span>Rotas</span>
          </div>
          <div class="nav-item" onclick="navegarPara('armazens')">
            <span>ğŸ¢</span>
            <span>ArmazÃ©ns</span>
          </div>
          <div class="nav-item" onclick="navegarPara('agendaarquivo')">
            <span>ğŸ—„ï¸</span>
            <span>Agenda Arquivo</span>
          </div>
          <div class="nav-item" onclick="navegarPara('logs')">
            <span>ğŸ“œ</span>
            <span>Logs / HistÃ³rico</span>
          </div>
          <div class="nav-item" onclick="navegarPara('backup')">
            <span>ğŸ’¾</span>
            <span>Backup</span>
          </div>
        </div>
      </div>
      
      <!-- â•â•â•â•â•â•â•â•â•â•â• 2. LOGÃSTICA â•â•â•â•â•â•â•â•â•â•â• -->
      <div class="menu-section">
        <div class="menu-title" onclick="toggleMenu('menu-logistica')">
          <span>ğŸš› LogÃ­stica</span>
          <span class="menu-arrow">â–¼</span>
        </div>
        <div id="menu-logistica" class="menu-items menu-collapsed" style="display: none;">
          <div class="nav-item" onclick="navegarPara('cotacoes')">
            <span>ğŸ’¶</span>
            <span>CotaÃ§Ãµes</span>
          </div>
          <div class="nav-item" onclick="navegarPara('reservas')">
            <span>ğŸ“¦</span>
            <span>Reservas</span>
          </div>
          <div class="nav-item" onclick="abrirListaReservas()">
            <span>ğŸ“‹</span>
            <span>HistÃ³rico Reservas</span>
          </div>
          <div class="nav-item" onclick="navegarPara('agenda1')">
            <span>ğŸ“…</span>
            <span>Agenda 1</span>
          </div>
          <div class="nav-item" onclick="navegarPara('agenda2')">
            <span>ğŸ“…</span>
            <span>Agenda 2</span>
          </div>
          <div class="nav-item" onclick="navegarPara('agenda3')">
            <span>ğŸ“…</span>
            <span>Agenda 3</span>
          </div>
        </div>
      </div>
      
      <!-- â•â•â•â•â•â•â•â•â•â•â• 3. FINANCEIRO â•â•â•â•â•â•â•â•â•â•â• -->
      <div class="menu-section">
        <div class="menu-title" onclick="toggleMenu('menu-financeiro')">
          <span>ğŸ’° Financeiro</span>
          <span class="menu-arrow">â–¼</span>
        </div>
        <div id="menu-financeiro" class="menu-items menu-collapsed" style="display: none;">
          <div class="nav-item" onclick="navegarPara('dashboardfinanceiro')">
            <span>ğŸ“Š</span>
            <span>Dashboard</span>
          </div>
          <div class="nav-item" onclick="navegarPara('clientes')">
            <span>ğŸ‘¥</span>
            <span>Clientes</span>
          </div>
          <div class="nav-item" onclick="navegarPara('faturas')">
            <span>ğŸ“„</span>
            <span>Faturas</span>
          </div>
          <div class="nav-item" onclick="navegarPara('prefaturacao')">
            <span>ğŸ“‹</span>
            <span>PrÃ©-FaturaÃ§Ã£o</span>
          </div>
          <div class="nav-item" onclick="navegarPara('controlofaturacao')">
            <span>ğŸ”</span>
            <span>Controlo FaturaÃ§Ã£o</span>
          </div>
          <div class="nav-item" onclick="navegarPara('notascredito')">
            <span>ğŸ“‘</span>
            <span>Notas de CrÃ©dito</span>
          </div>
          <div class="nav-item" onclick="navegarPara('recibos')">
            <span>ğŸ§¾</span>
            <span>Recibos</span>
          </div>
          <div class="nav-item" onclick="navegarPara('contascorrentes')">
            <span>ğŸ“’</span>
            <span>Contas Correntes</span>
          </div>
        </div>
      </div>
      
      <!-- â•â•â•â•â•â•â•â•â•â•â• 4. FORNECEDORES â•â•â•â•â•â•â•â•â•â•â• -->
      <div class="menu-section">
        <div class="menu-title" onclick="toggleMenu('menu-fornecedores')">
          <span>ğŸ­ Fornecedores</span>
          <span class="menu-arrow">â–¼</span>
        </div>
        <div id="menu-fornecedores" class="menu-items menu-collapsed" style="display: none;">
          <div class="nav-item" onclick="navegarPara('fichasfornecedores')">
            <span>ğŸ“‡</span>
            <span>Fichas Fornecedores</span>
          </div>
          <div class="nav-item" onclick="navegarPara('compras')">
            <span>ğŸ›’</span>
            <span>Compras</span>
          </div>
          <div class="nav-item" onclick="navegarPara('faturasfornecedores')">
            <span>ğŸ“„</span>
            <span>Faturas</span>
          </div>
          <div class="nav-item" onclick="navegarPara('ncfornecedores')">
            <span>ğŸ“‘</span>
            <span>Notas de CrÃ©dito</span>
          </div>
          <div class="nav-item" onclick="navegarPara('pagamentos')">
            <span>ğŸ’³</span>
            <span>Pagamentos</span>
          </div>
          <div class="nav-item" onclick="navegarPara('ccfornecedores')">
            <span>ğŸ“’</span>
            <span>Contas Correntes</span>
          </div>
        </div>
      </div>
      
      <!-- â•â•â•â•â•â•â•â•â•â•â• 5. CONTROLO DE CUSTOS â•â•â•â•â•â•â•â•â•â•â• -->
      <div class="menu-section">
        <div class="menu-title" onclick="toggleMenu('menu-custos')">
          <span>ğŸ“Š Controlo de Custos</span>
          <span class="menu-arrow">â–¼</span>
        </div>
        <div id="menu-custos" class="menu-items menu-collapsed" style="display: none;">
          <div class="nav-item" onclick="navegarPara('gestaofrota')">
            <span>ğŸšš</span>
            <span>GestÃ£o de Frota</span>
          </div>
          <div class="nav-item" onclick="navegarPara('veiculos')">
            <span>ğŸš›</span>
            <span>VeÃ­culos</span>
          </div>
          <div class="nav-item" onclick="navegarPara('motoristas')">
            <span>ğŸ§‘â€âœˆï¸</span>
            <span>Motoristas</span>
          </div>
          <div class="nav-item" onclick="navegarPara('combustivel')">
            <span>â›½</span>
            <span>CombustÃ­vel</span>
          </div>
          <div class="nav-item" onclick="navegarPara('manutencao')">
            <span>ğŸ”§</span>
            <span>ManutenÃ§Ã£o</span>
          </div>
          <div class="nav-item" onclick="navegarPara('portagens')">
            <span>ğŸ›£ï¸</span>
            <span>Portagens</span>
          </div>
        </div>
      </div>
      
      <!-- â•â•â•â•â•â•â•â•â•â•â• 6. CONTABILIDADE â•â•â•â•â•â•â•â•â•â•â• -->
      <div class="menu-section">
        <div class="menu-title" onclick="toggleMenu('menu-contabilidade')">
          <span>ğŸ“š Contabilidade</span>
          <span class="menu-arrow">â–¼</span>
        </div>
        <div id="menu-contabilidade" class="menu-items menu-collapsed" style="display: none;">
          <div class="nav-item" onclick="navegarPara('dashboardcontabilidade')">
            <span>ğŸ“Š</span>
            <span>Dashboard</span>
          </div>
          <div class="nav-item" onclick="navegarPara('series')">
            <span>ğŸ”¢</span>
            <span>SÃ©ries Documentos</span>
          </div>
          <div class="nav-item" onclick="navegarPara('saft')">
            <span>ğŸ“</span>
            <span>SAF-T</span>
          </div>
          <div class="nav-item" onclick="navegarPara('relatorios')">
            <span>ğŸ“ˆ</span>
            <span>RelatÃ³rios</span>
          </div>
        </div>
      </div>
      
      <!-- â•â•â•â•â•â•â•â•â•â•â• 7. RECURSOS HUMANOS â•â•â•â•â•â•â•â•â•â•â• -->
      <div class="menu-section">
        <div class="menu-title" onclick="toggleMenu('menu-rh')">
          <span>ğŸ‘¥ Recursos Humanos</span>
          <span class="menu-arrow">â–¼</span>
        </div>
        <div id="menu-rh" class="menu-items menu-collapsed" style="display: none;">
          <div class="nav-item" onclick="navegarPara('funcionarios')">
            <span>ğŸ‘·</span>
            <span>FuncionÃ¡rios</span>
          </div>
          <div class="nav-item" onclick="navegarPara('contratos')">
            <span>ğŸ“</span>
            <span>Contratos</span>
          </div>
          <div class="nav-item" onclick="navegarPara('salarios')">
            <span>ğŸ’µ</span>
            <span>SalÃ¡rios</span>
          </div>
          <div class="nav-item" onclick="navegarPara('ferias')">
            <span>ğŸ–ï¸</span>
            <span>FÃ©rias</span>
          </div>
          <div class="nav-item" onclick="navegarPara('documentosrh')">
            <span>ğŸ“‚</span>
            <span>Documentos</span>
          </div>
        </div>
      </div>
      
    </nav>
    
    <div class="absolute bottom-0 left-0 right-0 p-4 border-t border-emerald-700">
      <div class="flex items-center gap-3">
        <div class="avatar">ERP</div>
        <div>
          <p class="text-white text-sm font-semibold">Emeutrans</p>
          <p class="text-emerald-300 text-xs">Sistema Integrado</p>
        </div>
      </div>
    </div>
  </aside>

  <!-- MAIN CONTENT -->
  <main class="main-content">
    
    <!-- HEADER -->
    <header class="bg-white border-b border-slate-200 px-8 py-4 flex items-center justify-between sticky top-0 z-50">
      <div>
        <h2 class="text-2xl font-bold text-slate-800" id="pageTitle">Dashboard FaturaÃ§Ã£o</h2>
        <p class="text-slate-500 text-sm" id="pageSubtitle">VisÃ£o geral financeira</p>
      </div>
      <div class="flex items-center gap-4">
        <div class="search-box relative">
          <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400">ğŸ”</span>
          <input type="text" id="pesquisaGlobal" placeholder="Pesquisar em toda a pÃ¡gina..." 
                 class="border-2 border-slate-200 rounded-lg pl-10 pr-10 py-2 w-80 focus:border-emerald-500 focus:ring-2 focus:ring-emerald-200 transition-all" 
                 oninput="pesquisarGlobal(this.value)"
                 onkeydown="if(event.key==='Escape'){this.value='';pesquisarGlobal('');}">
          <button onclick="document.getElementById('pesquisaGlobal').value='';pesquisarGlobal('');" 
                  class="absolute right-3 top-1/2 transform -translate-y-1/2 text-slate-400 hover:text-slate-600" 
                  title="Limpar pesquisa (ESC)">âœ•</button>
        </div>
        <!-- BotÃµes dinÃ¢micos por pÃ¡gina -->
        <div id="headerBotoes">
          <button onclick="abrirNovaFatura()" class="btn btn-primary" id="btnHeaderNovaFatura">â• Nova Fatura</button>
        </div>
      </div>
    </header>

    <!-- PAGE: DASHBOARD -->
    <section id="page-dashboard" class="p-8 animate-fade-in">
      
      <!-- ğŸ§ª PAINEL DE DADOS DE TESTE v6.34 -->
      <div id="painelDadosTeste" class="mb-6 bg-gradient-to-r from-amber-50 to-orange-50 border-2 border-amber-400 rounded-xl p-6 shadow-lg">
        <div class="flex items-start justify-between">
          <div class="flex items-start gap-4">
            <div class="text-4xl">ğŸ§ª</div>
            <div>
              <h3 class="text-xl font-bold text-amber-800 mb-2">VERSÃƒO 6.34 - DADOS DE TESTE PARA FATURAÃ‡ÃƒO</h3>
              <p class="text-amber-700 mb-4">8 reservas prÃ©-configuradas para testar regras de IVA (23% e 0%)</p>
              
              <div class="grid grid-cols-2 gap-4 text-sm">
                <div class="bg-white/70 rounded-lg p-3">
                  <p class="font-bold text-amber-800 mb-2">ğŸ“‹ FATURAÃ‡ÃƒO MANUAL:</p>
                  <ul class="space-y-1 text-amber-700">
                    <li>â€¢ <strong>C0001</strong> - Transp. RÃ¡pidos Norte</li>
                    <li class="ml-4 text-xs">RES-001: Lisboaâ†’Porto (23%) | RES-002: Portoâ†’Madrid (0%)</li>
                    <li>â€¢ <strong>C0003</strong> - Mercadorias IbÃ©ricas</li>
                    <li class="ml-4 text-xs">RES-005: Portoâ†’Braga (23%) | RES-006: Bragaâ†’Barcelona (0%)</li>
                    <li>â€¢ <strong>C0004</strong> - Distrib. Expressa Porto</li>
                    <li class="ml-4 text-xs">RES-007: Coimbraâ†’Aveiro (23%) | RES-008: Aveiroâ†’Bordeaux (0%)</li>
                  </ul>
                </div>
                <div class="bg-white/70 rounded-lg p-3">
                  <p class="font-bold text-orange-800 mb-2">âš¡ FATURAÃ‡ÃƒO AUTOMÃTICA:</p>
                  <ul class="space-y-1 text-orange-700">
                    <li>â€¢ <strong>C0002</strong> - LogÃ­stica Centro Sul</li>
                    <li class="ml-4 text-xs">RES-003: SetÃºbalâ†’Lisboa (23%) | RES-004: Lisboaâ†’Paris (0%)</li>
                  </ul>
                  <p class="mt-3 font-bold text-orange-800">ğŸ“Œ COMO TESTAR:</p>
                  <ol class="space-y-1 text-orange-700 text-xs">
                    <li>1. Ir a <strong>Reservas â†’ Executadas</strong></li>
                    <li>2. Clicar numa reserva</li>
                    <li>3. SecÃ§Ã£o 5: Anexar CMR de Carga</li>
                    <li>4. Verificar IVA na fatura</li>
                  </ol>
                </div>
              </div>
              
              <!-- BotÃµes de ManutenÃ§Ã£o -->
              <div class="mt-4 pt-4 border-t border-amber-300 flex flex-wrap gap-3">
                <button onclick="limparLocalStorageCompleto()" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 text-sm font-bold">
                  ğŸ—‘ï¸ Limpar TODO o LocalStorage
                </button>
                <button onclick="limparApenasReservas()" class="px-4 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 text-sm font-bold">
                  ğŸ§¹ Limpar SÃ³ Reservas
                </button>
                <button onclick="limparApenasChavesCMR()" class="px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 text-sm font-bold">
                  ğŸ“ Limpar Ficheiros CMR
                </button>
                <button onclick="verEspacoLocalStorage()" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 text-sm font-bold">
                  ğŸ“Š Ver EspaÃ§o Usado
                </button>
              </div>
            </div>
          </div>
          <button onclick="document.getElementById('painelDadosTeste').style.display='none'" class="text-amber-600 hover:text-amber-800 text-2xl">âœ•</button>
        </div>
      </div>
      
      <!-- Alertas de Vencimento -->
      <div id="alertasVencimento" class="mb-6">
        <!-- Preenchido por JS -->
      </div>
      
      <!-- Stats Row 1 -->
      <div class="grid grid-cols-4 gap-6 mb-6">
        <div class="stat-card">
          <p class="stat-label">Faturado (MÃªs)</p>
          <p class="stat-value text-emerald-600" id="statFaturadoMes">â‚¬0</p>
          <p class="text-emerald-600 text-sm mt-2">ğŸ“ˆ Este mÃªs</p>
        </div>
        <div class="stat-card">
          <p class="stat-label">Por Receber</p>
          <p class="stat-value text-amber-600" id="statPorReceber">â‚¬0</p>
          <p class="text-amber-600 text-sm mt-2">â³ Faturas pendentes</p>
        </div>
        <div class="stat-card">
          <p class="stat-label">Vencido</p>
          <p class="stat-value text-red-600" id="statVencido">â‚¬0</p>
          <p class="text-red-600 text-sm mt-2">âš ï¸ Requer atenÃ§Ã£o</p>
        </div>
        <div class="stat-card">
          <p class="stat-label">Recebido (MÃªs)</p>
          <p class="stat-value text-blue-600" id="statRecebidoMes">â‚¬0</p>
          <p class="text-blue-600 text-sm mt-2">âœ… Pagamentos recebidos</p>
        </div>
      </div>
      
      <!-- Stats Row 2 -->
      <div class="grid grid-cols-4 gap-6 mb-8">
        <div class="stat-card">
          <p class="stat-label">Faturas Emitidas</p>
          <p class="stat-value text-slate-700" id="statNumFaturas">0</p>
        </div>
        <div class="stat-card">
          <p class="stat-label">Notas de CrÃ©dito</p>
          <p class="stat-value text-purple-600" id="statNumNC">0</p>
        </div>
        <div class="stat-card">
          <p class="stat-label">Recibos Emitidos</p>
          <p class="stat-value text-cyan-600" id="statNumRecibos">0</p>
        </div>
        <div class="stat-card">
          <p class="stat-label">Taxa CobranÃ§a</p>
          <p class="stat-value text-emerald-600" id="statTaxaCobranca">0%</p>
        </div>
      </div>
      
      <!-- GrÃ¡fico e Tabela -->
      <div class="grid grid-cols-3 gap-6">
        <div class="card col-span-2">
          <div class="card-header">
            <h3 class="font-bold text-lg text-slate-800">ğŸ“ˆ FaturaÃ§Ã£o Mensal</h3>
          </div>
          <div class="card-body">
            <canvas id="chartFaturacao" height="120"></canvas>
          </div>
        </div>
        
        <div class="card">
          <div class="card-header">
            <h3 class="font-bold text-lg text-slate-800">â° Faturas a Vencer</h3>
          </div>
          <div class="card-body p-0">
            <table>
              <thead>
                <tr>
                  <th>Fatura</th>
                  <th>Valor</th>
                  <th>Vence</th>
                </tr>
              </thead>
              <tbody id="tabelaVencer">
              </tbody>
            </table>
          </div>
        </div>
      </div>
      
      <!-- Ãšltimas Faturas -->
      <div class="card mt-6">
        <div class="card-header flex justify-between items-center">
          <h3 class="font-bold text-lg text-slate-800">ğŸ“„ Ãšltimas Faturas</h3>
          <button onclick="navegarPara('faturas')" class="text-emerald-600 hover:underline text-sm font-semibold">Ver todas â†’</button>
        </div>
        <div class="card-body p-0">
          <table>
            <thead>
              <tr>
                <th>NÃºmero</th>
                <th>Data</th>
                <th>Cliente</th>
                <th>Valor</th>
                <th>Estado</th>
                <th>Email</th>
                <th>AÃ§Ãµes</th>
              </tr>
            </thead>
            <tbody id="tabelaUltimasFaturas">
            </tbody>
          </table>
        </div>
      </div>
      
    </section>

    <!-- PAGE: FATURAS -->
    <section id="page-faturas" class="p-8 hidden">
      <div class="card">
        <div class="card-header flex justify-between items-center">
          <h3 class="font-bold text-lg text-slate-800" data-i18n="invoices_management">ğŸ“„ GestÃ£o de Faturas</h3>
          <div class="flex gap-2">
            <button onclick="reporFaturasTeste()" class="btn btn-secondary btn-sm" title="Repor faturas de teste com IVA correcto">ğŸ”„ Repor Teste</button>
            <button onclick="exportarFaturas()" class="btn btn-secondary btn-sm" data-i18n="export">ğŸ“¥ Exportar</button>
            <button onclick="abrirNovaFatura()" class="btn btn-primary" data-i18n="new_invoice">â• Nova Fatura</button>
          </div>
        </div>
        <div class="card-body">
          
          <!-- Filtros -->
          <div class="filter-bar">
            <input type="text" id="filtroNumero" data-i18n-placeholder="invoice_number_ph" placeholder="NÂº Fatura..." onkeyup="filtrarFaturas()">
            <input type="text" id="filtroCliente" data-i18n-placeholder="customer" placeholder="Cliente..." onkeyup="filtrarFaturas()">
            <select id="filtroEstado" onchange="filtrarFaturas()">
              <option value="" data-i18n="all_statuses">Todos os estados</option>
              <option value="Pendente" data-i18n="status_pending">Pendente</option>
              <option value="Pago" data-i18n="status_paid">Pago</option>
              <option value="Parcial" data-i18n="status_partial">Parcialmente Pago</option>
              <option value="Vencido" data-i18n="status_overdue">Vencido</option>
            </select>
            <select id="filtroTipoFaturacao" onchange="filtrarFaturas()">
              <option value="" data-i18n="all_types">Todos os tipos</option>
              <option value="automatica" data-i18n="automatic">AutomÃ¡tica</option>
              <option value="manual" data-i18n="manual_with_booking">Manual c/ Reserva</option>
              <option value="avulso" data-i18n="standalone">Avulso (s/ Reserva)</option>
            </select>
            <input type="date" id="filtroDataDe" onchange="filtrarFaturas()" data-i18n-title="date_from" title="Data de">
            <input type="date" id="filtroDataAte" onchange="filtrarFaturas()" data-i18n-title="date_to" title="Data atÃ©">
            <button onclick="limparFiltros()" class="btn btn-secondary btn-sm" data-i18n="clear">âœ– Limpar</button>
            <span id="contadorFaturas" class="text-sm text-slate-500 ml-4"></span>
          </div>
          
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th data-i18n="number">NÃºmero</th>
                  <th data-i18n="date">Data</th>
                  <th data-i18n="due_date">Vencimento</th>
                  <th data-i18n="customer">Cliente</th>
                  <th data-i18n="type">Tipo</th>
                  <th data-i18n="base">Base</th>
                  <th data-i18n="vat">IVA</th>
                  <th data-i18n="total">Total</th>
                  <th data-i18n="paid">Pago</th>
                  <th data-i18n="balance">Saldo</th>
                  <th data-i18n="status">Estado</th>
                  <th data-i18n="email">Email</th>
                  <th data-i18n="actions">AÃ§Ãµes</th>
                </tr>
              </thead>
              <tbody id="tabelaFaturas">
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <!-- PAGE: PRÃ‰-FATURAÃ‡ÃƒO -->
    <section id="page-prefaturacao" class="p-8 hidden">
      <div class="card">
        <div class="card-header flex justify-between items-center">
          <h3 class="font-bold text-lg text-slate-800">ğŸ“‹ PrÃ©-FaturaÃ§Ã£o (Reservas Executadas)</h3>
          <div class="flex gap-2">
            <button onclick="reporReservasTeste()" class="btn btn-secondary btn-sm" title="Repor dados de teste">ğŸ”„ Repor Teste</button>
            <span class="text-sm text-slate-500" id="countSelecionadas">0 selecionadas</span>
            <button onclick="faturarSelecionadas()" class="btn btn-primary" id="btnFaturarSelecionadas" disabled>ğŸ“„ Faturar Selecionadas</button>
          </div>
        </div>
        <div class="card-body">
          
          <div class="mb-4 p-4 bg-blue-50 rounded-lg text-blue-800 text-sm">
            ğŸ’¡ <strong>Dica:</strong> Selecione uma ou mais reservas do mesmo cliente para criar uma fatura agrupada. 
            As reservas sÃ³ aparecem aqui apÃ³s receberem o CMR de Carga e CMR de Descarga.
          </div>
          
          <!-- Filtros -->
          <div class="filter-bar mb-4">
            <select id="filtroClientePreFat" onchange="filtrarPreFaturacao()">
              <option value="">Todos os clientes</option>
            </select>
            <input type="date" id="filtroDataPreFat" onchange="filtrarPreFaturacao()">
            <button onclick="limparFiltrosPreFat()" class="btn btn-secondary btn-sm">âœ– Limpar</button>
            <button onclick="selecionarTodas()" class="btn btn-secondary btn-sm">â˜‘ï¸ Selecionar Todas</button>
            <button onclick="deselecionarTodas()" class="btn btn-secondary btn-sm">â˜ Limpar SeleÃ§Ã£o</button>
          </div>
          
          <div id="listaPreFaturacao">
            <!-- Preenchido por JS -->
          </div>
          
        </div>
      </div>
    </section>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <!-- ğŸ” PAGE: CONTROLO DE FATURAÃ‡ÃƒO v1.0 (22/12/2024)                                  -->
    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <!-- Esta listagem permite verificar se alguma reserva nÃ£o foi faturada.               -->
    <!-- Campos clicÃ¡veis: NÂº Reserva â†’ abre reserva | NÂº Fatura â†’ abre fatura            -->
    <!--                   Cliente â†’ abre ficha cliente                                    -->
    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <section id="page-controlofaturacao" class="p-8 hidden">
      <div class="card">
        <div class="card-header flex justify-between items-center" style="background: linear-gradient(135deg, #1e3a5f, #2d5a87); color: white; border-radius: 8px 8px 0 0;">
          <h3 class="font-bold text-lg">ğŸ” Controlo de FaturaÃ§Ã£o</h3>
          <div class="flex gap-2 items-center">
            <button onclick="exportarControloFaturacao()" class="btn btn-sm" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3);">
              ğŸ“¥ Exportar
            </button>
            <button onclick="renderizarControloFaturacao()" class="btn btn-sm" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3);">
              ğŸ”„ Atualizar
            </button>
          </div>
        </div>
        <div class="card-body">
          
          <!-- Avisos informativos -->
          <div class="mb-4 p-4 bg-blue-50 rounded-lg text-blue-800 text-sm">
            ğŸ’¡ <strong>Controlo de FaturaÃ§Ã£o:</strong> Esta listagem mostra todas as reservas e o seu estado de faturaÃ§Ã£o.
            <br>Clique no <strong>NÂº Reserva</strong> para abrir a reserva, no <strong>NÂº Fatura</strong> para ver a fatura, ou no <strong>Cliente</strong> para abrir a ficha.
          </div>
          
          <!-- EstatÃ­sticas -->
          <div class="grid grid-cols-4 gap-4 mb-4">
            <div class="p-4 bg-slate-50 rounded-lg text-center">
              <div class="text-2xl font-bold text-slate-800" id="ctrlTotalReservas">0</div>
              <div class="text-sm text-slate-500">Total Reservas</div>
            </div>
            <div class="p-4 bg-green-50 rounded-lg text-center">
              <div class="text-2xl font-bold text-green-600" id="ctrlFaturadas">0</div>
              <div class="text-sm text-green-600">Faturadas</div>
            </div>
            <div class="p-4 bg-amber-50 rounded-lg text-center">
              <div class="text-2xl font-bold text-amber-600" id="ctrlPendentes">0</div>
              <div class="text-sm text-amber-600">Pendentes</div>
            </div>
            <div class="p-4 bg-red-50 rounded-lg text-center">
              <div class="text-2xl font-bold text-red-600" id="ctrlSemCMR">0</div>
              <div class="text-sm text-red-600">Sem CMR Carga</div>
            </div>
          </div>
          
          <!-- Filtros -->
          <div class="filter-bar mb-4">
            <select id="filtroCtrlEstado" onchange="filtrarControloFaturacao()">
              <option value="">Todos os Estados</option>
              <option value="faturada">âœ… Faturadas</option>
              <option value="pendente">â³ Pendentes (com CMR)</option>
              <option value="semcmr">âŒ Sem CMR Carga</option>
            </select>
            <select id="filtroCtrlCliente" onchange="filtrarControloFaturacao()">
              <option value="">Todos os Clientes</option>
            </select>
            <input type="date" id="filtroCtrlDataDe" onchange="filtrarControloFaturacao()" title="Data de">
            <input type="date" id="filtroCtrlDataAte" onchange="filtrarControloFaturacao()" title="Data atÃ©">
            <input type="text" id="filtroCtrlPesquisa" placeholder="Pesquisar..." oninput="filtrarControloFaturacao()">
            <button onclick="limparFiltrosControlo()" class="btn btn-secondary btn-sm">âœ– Limpar</button>
          </div>
          
          <!-- Tabela de Controlo -->
          <div class="table-container" style="max-height: 600px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 8px;">
            <table id="tabelaControloFaturacao" style="width: 100%; border-collapse: collapse;">
              <thead>
                <tr style="background-color: #1e3a5f !important;">
                  <th style="padding: 14px 12px; color: white !important; font-weight: 600; text-align: left; border: none; min-width: 130px; position: sticky; top: 0; background-color: #1e3a5f !important; z-index: 10;">NÂº RESERVA</th>
                  <th style="padding: 14px 12px; color: white !important; font-weight: 600; text-align: left; border: none; min-width: 120px; position: sticky; top: 0; background-color: #1e3a5f !important; z-index: 10;">NÂº FATURA</th>
                  <th style="padding: 14px 12px; color: white !important; font-weight: 600; text-align: left; border: none; min-width: 180px; position: sticky; top: 0; background-color: #1e3a5f !important; z-index: 10;">CLIENTE</th>
                  <th style="padding: 14px 12px; color: white !important; font-weight: 600; text-align: right; border: none; min-width: 100px; position: sticky; top: 0; background-color: #1e3a5f !important; z-index: 10;">VALOR</th>
                  <th style="padding: 14px 12px; color: white !important; font-weight: 600; text-align: center; border: none; min-width: 90px; position: sticky; top: 0; background-color: #1e3a5f !important; z-index: 10;">ESTADO</th>
                  <th style="padding: 14px 8px; color: white !important; font-weight: 600; text-align: center; border: none; min-width: 70px; position: sticky; top: 0; background-color: #1e3a5f !important; z-index: 10;">CMR<br>CARGA</th>
                  <th style="padding: 14px 8px; color: white !important; font-weight: 600; text-align: center; border: none; min-width: 70px; position: sticky; top: 0; background-color: #1e3a5f !important; z-index: 10;">CMR<br>DESCARGA</th>
                  <th style="padding: 14px 8px; color: white !important; font-weight: 600; text-align: center; border: none; min-width: 70px; position: sticky; top: 0; background-color: #1e3a5f !important; z-index: 10;">EMAIL<br>ENVIADO</th>
                  <th style="padding: 14px 12px; color: white !important; font-weight: 600; text-align: center; border: none; min-width: 90px; position: sticky; top: 0; background-color: #1e3a5f !important; z-index: 10;">DATA</th>
                </tr>
              </thead>
              <tbody id="tbodyControloFaturacao" style="background: white;">
                <tr><td colspan="9" class="text-center text-slate-500 py-8">A carregar dados...</td></tr>
              </tbody>
            </table>
          </div>
          
        </div>
      </div>
    </section>

    <!-- PAGE: NOTAS DE CRÃ‰DITO -->
    <section id="page-notascredito" class="p-8 hidden">
      <div class="card">
        <div class="card-header flex justify-between items-center">
          <h3 class="font-bold text-lg text-slate-800">ğŸ“‘ Notas de CrÃ©dito</h3>
          <div class="flex gap-2 items-center">
            <select id="selectPerfilTeste" onchange="mudarPerfilUtilizador(this.value)" class="text-xs border rounded px-2 py-1" title="Testar permissÃµes">
              <option value="admin">ğŸ‘¤ Admin</option>
              <option value="gestor">ğŸ‘¤ Gestor</option>
              <option value="operador">ğŸ‘¤ Operador</option>
            </select>
            <span id="permissaoNCIndicador" class="text-xs px-2 py-1 rounded"></span>
            <button onclick="reporNCTeste()" class="btn btn-secondary btn-sm" title="Repor dados de teste">ğŸ”„ Repor Teste</button>
            <button onclick="abrirNovaNC()" class="btn btn-primary" id="btnNovaNC">â• Nova Nota de CrÃ©dito</button>
          </div>
        </div>
        <div class="card-body">
          <!-- Aviso de permissÃ£o -->
          <div id="avisoPermissaoNC" class="mb-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg text-yellow-800 text-sm hidden">
            âš ï¸ <strong>Acesso Restrito:</strong> Apenas utilizadores com perfil <strong>Administrador</strong> ou <strong>Gestor</strong> podem emitir Notas de CrÃ©dito.
          </div>
          
          <!-- Motor de Busca NC -->
          <div class="filter-bar mb-4">
            <input type="text" id="filtroNCNumero" placeholder="NÂº NC..." oninput="filtrarNotasCredito()" class="w-32">
            <input type="text" id="filtroNCCliente" placeholder="Cliente..." oninput="filtrarNotasCredito()">
            <input type="text" id="filtroNCFatura" placeholder="NÂº Fatura..." oninput="filtrarNotasCredito()" class="w-32">
            <select id="filtroNCMotivo" onchange="filtrarNotasCredito()">
              <option value="">Todos os motivos</option>
              <option value="DevoluÃ§Ã£o">DevoluÃ§Ã£o</option>
              <option value="Erro">Erro faturaÃ§Ã£o</option>
              <option value="Desconto comercial">Desconto comercial</option>
              <option value="Desconto pronto pagamento">Desconto pronto pagamento</option>
              <option value="DiferenÃ§a">DiferenÃ§a preÃ§o</option>
              <option value="AnulaÃ§Ã£o">AnulaÃ§Ã£o</option>
            </select>
            <input type="date" id="filtroNCDataDe" onchange="filtrarNotasCredito()" title="Data de">
            <input type="date" id="filtroNCDataAte" onchange="filtrarNotasCredito()" title="Data atÃ©">
            <button onclick="limparFiltrosNC()" class="btn btn-secondary btn-sm">âœ– Limpar</button>
            <span id="contadorNC" class="text-sm text-slate-500 ml-4"></span>
          </div>
          
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>NÃºmero</th>
                  <th>Data</th>
                  <th>Fatura Ref.</th>
                  <th>Cliente</th>
                  <th>Motivo</th>
                  <th>Valor</th>
                  <th>Estado</th>
                  <th>AÃ§Ãµes</th>
                </tr>
              </thead>
              <tbody id="tabelaNC">
                <tr><td colspan="8" class="text-center text-slate-500 py-8">Nenhuma nota de crÃ©dito emitida</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <!-- PAGE: RECIBOS -->
    <section id="page-recibos" class="p-8 hidden">
      <div class="card">
        <div class="card-header flex justify-between items-center">
          <h3 class="font-bold text-lg text-slate-800">ğŸ§¾ Recibos</h3>
          <div class="flex items-center gap-2">
            <button onclick="reporRecibosTeste()" class="btn btn-secondary btn-sm" title="Repor dados de teste">ğŸ”„ Repor Teste</button>
            <button onclick="abrirNovoRecibo()" class="btn btn-primary">â• Novo Recibo</button>
          </div>
        </div>
        <div class="card-body">
          <!-- Motor de Busca Recibos -->
          <div class="filter-bar mb-4">
            <input type="text" id="filtroReciboNumero" placeholder="NÂº Recibo..." oninput="filtrarRecibos()" class="w-32">
            <input type="text" id="filtroReciboCliente" placeholder="Cliente..." oninput="filtrarRecibos()">
            <input type="text" id="filtroReciboFatura" placeholder="NÂº Fatura..." oninput="filtrarRecibos()" class="w-32">
            <select id="filtroReciboMetodo" onchange="filtrarRecibos()">
              <option value="">Todos os mÃ©todos</option>
              <option value="TransferÃªncia">TransferÃªncia</option>
              <option value="Cheque">Cheque</option>
              <option value="NumerÃ¡rio">NumerÃ¡rio</option>
              <option value="MB Way">MB Way</option>
              <option value="Multibanco">Multibanco</option>
            </select>
            <input type="date" id="filtroReciboDataDe" onchange="filtrarRecibos()" title="Data de">
            <input type="date" id="filtroReciboDataAte" onchange="filtrarRecibos()" title="Data atÃ©">
            <button onclick="limparFiltrosRecibos()" class="btn btn-secondary btn-sm">âœ– Limpar</button>
            <span id="contadorRecibos" class="text-sm text-slate-500 ml-4"></span>
          </div>
          
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>NÃºmero</th>
                  <th>Data</th>
                  <th>Cliente</th>
                  <th>Fatura(s)</th>
                  <th>MÃ©todo</th>
                  <th>Conta Destino</th>
                  <th>Valor</th>
                  <th style="min-width: 120px;">AÃ§Ãµes</th>
                </tr>
              </thead>
              <tbody id="tabelaRecibos">
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <!-- ğŸ”’ PAGE: CONTAS CORRENTES - BLOQUEADO v4.6 (20/12/2024) - NÃƒO ALTERAR ğŸ”’          -->
    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <section id="page-contascorrentes" class="p-8 hidden">
      <div class="card">
        <div class="card-header">
          <h3 class="font-bold text-lg text-slate-800">ğŸ“’ Contas Correntes de Clientes</h3>
        </div>
        <div class="card-body">
          
          <div class="tab-container">
            <button class="tab-btn active" onclick="mudarTabCC('resumo')">Resumo</button>
            <button class="tab-btn" onclick="mudarTabCC('extrato')">Extrato Detalhado</button>
            <button class="tab-btn" onclick="mudarTabCC('vencimentos')">AnÃ¡lise Vencimentos</button>
          </div>
          
          <!-- Tab Resumo -->
          <div id="tab-cc-resumo" class="tab-content active">
            <div class="mb-4 p-4 bg-amber-50 rounded-lg text-amber-800 text-sm">
              ğŸ’¡ <strong>Nota:</strong> Este resumo mostra apenas clientes com saldo em dÃ­vida. Clique no nome do cliente para ver o extrato de faturas pendentes.
            </div>
            
            <!-- Motor de Busca AvanÃ§ado -->
            <div class="mb-4 p-4 bg-slate-50 rounded-lg">
              <div class="grid grid-cols-4 gap-4">
                <div class="form-group">
                  <label>ğŸ” Pesquisar Cliente</label>
                  <input type="text" id="filtroResumoCliente" placeholder="Nome ou NIF..." oninput="filtrarResumoCC()">
                </div>
                <div class="form-group">
                  <label>Saldo MÃ­nimo (â‚¬)</label>
                  <input type="number" id="filtroResumoSaldoMin" placeholder="0.00" step="0.01" oninput="filtrarResumoCC()">
                </div>
                <div class="form-group">
                  <label>Saldo MÃ¡ximo (â‚¬)</label>
                  <input type="number" id="filtroResumoSaldoMax" placeholder="Sem limite" step="0.01" oninput="filtrarResumoCC()">
                </div>
                <div class="form-group">
                  <label>&nbsp;</label>
                  <button onclick="limparFiltrosResumoCC()" class="btn btn-secondary w-full">ğŸ—‘ï¸ Limpar Filtros</button>
                </div>
              </div>
            </div>
            
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>Cliente</th>
                    <th>NIF</th>
                    <th>Total Faturado</th>
                    <th>Total Pago</th>
                    <th>Saldo em DÃ­vida</th>
                    <th>AÃ§Ãµes</th>
                  </tr>
                </thead>
                <tbody id="tabelaCCResumo">
                </tbody>
              </table>
            </div>
            <div id="resumoCCTotais" class="mt-4 p-4 bg-slate-100 rounded-lg"></div>
          </div>
          
          <!-- Tab Extrato -->
          <div id="tab-cc-extrato" class="tab-content">
            <div class="mb-4 p-4 bg-slate-50 rounded-lg">
              <div class="grid grid-cols-7 gap-4">
                <div class="form-group">
                  <label>Cliente</label>
                  <select id="extratoCliente" onchange="carregarExtrato()">
                    <option value="">-- Selecione --</option>
                  </select>
                </div>
                <div class="form-group">
                  <label>Data InÃ­cio</label>
                  <input type="date" id="extratoDataDe" onchange="carregarExtrato()">
                </div>
                <div class="form-group">
                  <label>Data Fim</label>
                  <input type="date" id="extratoDataAte" onchange="carregarExtrato()">
                </div>
                <div class="form-group">
                  <label>CondiÃ§Ã£o</label>
                  <select id="extratoCondicao" onchange="carregarExtrato()">
                    <option value="divida">Faturas em dÃ­vida</option>
                    <option value="completo">Extrato completo</option>
                    <option value="pagas">SÃ³ faturas recebidas com recibos</option>
                  </select>
                </div>
                <div class="form-group">
                  <label>&nbsp;</label>
                  <button onclick="limparFiltrosExtrato()" class="btn btn-secondary w-full">âœ– Limpar Filtros</button>
                </div>
                <div class="form-group">
                  <label>&nbsp;</label>
                  <button onclick="abrirEmailExtrato()" class="btn btn-info w-full">ğŸ“§ Enviar Extrato</button>
                </div>
                <div class="form-group">
                  <label>&nbsp;</label>
                  <button onclick="imprimirExtrato()" class="btn btn-secondary w-full">ğŸ–¨ï¸ Imprimir</button>
                </div>
              </div>
            </div>
            
            <!-- Resumo do Extrato -->
            <div id="extratoResumoCliente" class="mb-4 hidden">
              <div class="grid grid-cols-4 gap-4">
                <div class="p-3 bg-slate-100 rounded-lg text-center">
                  <div class="text-xs text-slate-500">Total Faturado</div>
                  <div id="extratoTotalFaturado" class="text-lg font-bold text-slate-700">â‚¬0,00</div>
                </div>
                <div class="p-3 bg-emerald-100 rounded-lg text-center">
                  <div class="text-xs text-emerald-600">Total Pago</div>
                  <div id="extratoTotalPago" class="text-lg font-bold text-emerald-700">â‚¬0,00</div>
                </div>
                <div class="p-3 bg-amber-100 rounded-lg text-center">
                  <div class="text-xs text-amber-600">Saldo Pendente</div>
                  <div id="extratoSaldoPendente" class="text-lg font-bold text-amber-700">â‚¬0,00</div>
                </div>
                <div class="p-3 bg-blue-100 rounded-lg text-center">
                  <div class="text-xs text-blue-600">NÂº Faturas Pendentes</div>
                  <div id="extratoNumFaturas" class="text-lg font-bold text-blue-700">0</div>
                </div>
              </div>
            </div>
            
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th class="text-left">Data</th>
                    <th class="text-left">Documento</th>
                    <th class="text-left">DescriÃ§Ã£o</th>
                    <th class="text-left">Ref. Cliente</th>
                    <th class="text-right">Valor do Documento</th>
                    <th class="text-right">DÃ©bito</th>
                    <th class="text-right">CrÃ©dito</th>
                    <th class="text-right">Valor em DÃ­vida</th>
                    <th class="text-right">Saldo</th>
                  </tr>
                </thead>
                <tbody id="tabelaExtrato">
                  <tr><td colspan="9" class="text-center text-slate-500 py-8">Selecione um cliente</td></tr>
                </tbody>
              </table>
            </div>
          </div>
          
          <!-- Tab Vencimentos (AnÃ¡lise Interna) -->
          <div id="tab-cc-vencimentos" class="tab-content">
            <div class="mb-4 p-4 bg-blue-50 rounded-lg text-blue-800 text-sm">
              ğŸ“Š <strong>AnÃ¡lise de Pagamentos:</strong> Mostra a mÃ©dia de dias de pagamento por cliente e estatÃ­sticas de pontualidade. Apenas clientes com movimentos sÃ£o apresentados.
            </div>
            
            <!-- Filtros AnÃ¡lise Vencimentos -->
            <div class="mb-4 p-4 bg-slate-50 rounded-lg">
              <div class="grid grid-cols-5 gap-4">
                <div class="form-group">
                  <label>ğŸ” Pesquisar Cliente</label>
                  <input type="text" id="filtroVencimentosCliente" placeholder="Nome do cliente..." oninput="filtrarVencimentos()">
                </div>
                <div class="form-group">
                  <label>MÃ©dia Dias MÃ­n.</label>
                  <input type="number" id="filtroVencimentosDiasMin" placeholder="0" oninput="filtrarVencimentos()">
                </div>
                <div class="form-group">
                  <label>MÃ©dia Dias MÃ¡x.</label>
                  <input type="number" id="filtroVencimentosDiasMax" placeholder="Sem limite" oninput="filtrarVencimentos()">
                </div>
                <div class="form-group">
                  <label>Taxa Pontualidade</label>
                  <select id="filtroVencimentosPontualidade" onchange="filtrarVencimentos()">
                    <option value="">Todas</option>
                    <option value="100">100% (Excelente)</option>
                    <option value="80">â‰¥80% (Bom)</option>
                    <option value="50">â‰¥50% (Regular)</option>
                    <option value="0"><50% (Mau)</option>
                  </select>
                </div>
                <div class="form-group">
                  <label>&nbsp;</label>
                  <button onclick="limparFiltrosVencimentos()" class="btn btn-secondary w-full">âœ– Limpar Filtros</button>
                </div>
              </div>
            </div>
            
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>Cliente</th>
                    <th>NÂº Faturas</th>
                    <th>Faturas Pagas</th>
                    <th>MÃ©dia Dias Pagamento</th>
                    <th>Melhor</th>
                    <th>Pior</th>
                    <th>Taxa Pontualidade</th>
                    <th>AÃ§Ãµes</th>
                  </tr>
                </thead>
                <tbody id="tabelaVencimentos">
                </tbody>
              </table>
            </div>
          </div>
          
        </div>
      </div>
    </section>
    
    <!-- MODAL: Enviar Email Extrato -->
    <div id="modalEmailExtrato" class="modal-overlay">
      <div class="modal-content" style="max-width: 700px;">
        <div class="modal-header">
          <h3>ğŸ“§ Enviar Extrato por Email</h3>
          <button onclick="fecharModal('modalEmailExtrato')" class="text-white hover:text-gray-200 text-2xl">&times;</button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="emailExtratoClienteId">
          
          <div class="mb-4 p-3 bg-blue-50 rounded-lg" id="emailExtratoClienteInfo">
            <!-- Info do cliente -->
          </div>
          
          <div class="grid grid-cols-2 gap-4 mb-4">
            <div>
              <label class="font-semibold text-sm text-slate-700 mb-2 block">ğŸ“‹ Emails Contabilidade</label>
              <div id="emailsExtratoContabilidade" class="p-3 bg-slate-50 rounded-lg text-sm max-h-32 overflow-y-auto">
              </div>
            </div>
            <div>
              <label class="font-semibold text-sm text-slate-700 mb-2 block">ğŸ’° Emails Financeiro</label>
              <div id="emailsExtratoFinanceiro" class="p-3 bg-slate-50 rounded-lg text-sm max-h-32 overflow-y-auto">
              </div>
            </div>
          </div>
          
          <div class="mb-4">
            <label class="font-semibold text-sm text-slate-700 mb-2 block">ğŸ“§ Outros Emails da Ficha do Cliente</label>
            <div id="emailsExtratoOutros" class="p-3 bg-slate-50 rounded-lg text-sm max-h-32 overflow-y-auto">
            </div>
          </div>
          
          <div class="mb-4">
            <label class="font-semibold text-sm text-slate-700 mb-2 block">âœï¸ Adicionar Emails Manualmente</label>
            <div class="flex gap-2">
              <input type="text" id="emailExtratoManual" placeholder="email@exemplo.com" class="flex-1">
              <button onclick="adicionarEmailManualExtrato()" class="btn btn-secondary">+ Adicionar</button>
            </div>
            <div id="emailsExtratoManuais" class="mt-2 flex flex-wrap gap-2">
            </div>
          </div>
          
          <div class="mb-4">
            <label class="font-semibold text-sm text-slate-700 mb-2 block">ğŸ“ Texto do Email</label>
            <div class="grid grid-cols-2 gap-2 mb-2">
              <button onclick="selecionarTextoExtrato('lembrete')" class="btn btn-outline text-xs">Lembrete AmigÃ¡vel</button>
              <button onclick="selecionarTextoExtrato('cobranca')" class="btn btn-outline text-xs">Aviso de CobranÃ§a</button>
              <button onclick="selecionarTextoExtrato('urgente')" class="btn btn-outline text-xs">CobranÃ§a Urgente</button>
              <button onclick="selecionarTextoExtrato('informativo')" class="btn btn-outline text-xs">Extrato Informativo</button>
            </div>
            <textarea id="emailExtratoTexto" rows="6" placeholder="Digite aqui o texto do email ou selecione um modelo acima..."></textarea>
          </div>
          
          <div class="mb-4">
            <label class="font-semibold text-sm text-slate-700 mb-2 block">ğŸ“ Anexos</label>
            <div class="p-3 bg-slate-50 rounded-lg text-sm">
              <label class="checkbox-container">
                <input type="checkbox" id="anexarExtratoCliente" checked>
                <span>Extrato do Cliente (PDF)</span>
              </label>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button onclick="fecharModal('modalEmailExtrato')" class="btn btn-secondary">Cancelar</button>
          <button onclick="enviarEmailExtrato()" class="btn btn-primary">ğŸ“§ Enviar Email</button>
        </div>
      </div>
    </div>

    <!-- PAGE: SÃ‰RIES -->
    <!-- PAGE: SÃ‰RIES DE DOCUMENTOS -->
    <section id="page-series" class="p-8 hidden">
      <div class="card">
        <div class="card-header flex justify-between items-center">
          <h3 class="font-bold text-lg text-slate-800">ğŸ”¢ SÃ©ries de Documentos</h3>
          <div class="flex gap-2">
            <button onclick="abrirNovaSerie()" class="btn btn-primary">â• Nova SÃ©rie</button>
            <button onclick="verificarMudancaAno()" class="btn btn-secondary">ğŸ“… MudanÃ§a de Ano</button>
          </div>
        </div>
        <div class="card-body">
          
          <!-- Resumo de EstatÃ­sticas -->
          <div id="seriesResumo" class="grid grid-cols-6 gap-4 mb-6">
            <!-- Preenchido por JS -->
          </div>
          
          <!-- Info -->
          <div class="mb-4 p-4 bg-blue-50 rounded-lg text-blue-800 text-sm">
            ğŸ’¡ <strong>Dica:</strong> As sÃ©ries controlam a numeraÃ§Ã£o automÃ¡tica de todos os documentos. Cada tipo de documento tem a sua prÃ³pria sÃ©rie. A numeraÃ§Ã£o Ã© sequencial e reinicia a cada ano.
          </div>
          
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Tipo Documento</th>
                  <th>SÃ©rie</th>
                  <th>Prefixo</th>
                  <th>PrÃ³ximo NÂº</th>
                  <th>Ano</th>
                  <th>Docs Emitidos</th>
                  <th>Estado</th>
                  <th>AÃ§Ãµes</th>
                </tr>
              </thead>
              <tbody id="tabelaSeries">
              </tbody>
            </table>
          </div>
          
          <!-- HistÃ³rico -->
          <div class="mt-6">
            <h4 class="font-semibold text-slate-700 mb-3">ğŸ“œ HistÃ³rico de AlteraÃ§Ãµes</h4>
            <div id="seriesHistorico" class="max-h-48 overflow-y-auto bg-slate-50 rounded-lg p-3 text-sm">
              <p class="text-slate-400 italic">Sem alteraÃ§Ãµes registadas</p>
            </div>
          </div>
          
        </div>
      </div>
    </section>
    
    <!-- MODAL: Nova/Editar SÃ©rie -->
    <div id="modalSerie" class="modal-overlay">
      <div class="modal-content" style="max-width: 550px;">
        <div class="modal-header">
          <h3 id="modalSerieTitulo">â• Nova SÃ©rie</h3>
          <button onclick="fecharModal('modalSerie')" class="text-white hover:text-gray-200 text-2xl">&times;</button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="serieEditarId">
          
          <div class="grid grid-cols-2 gap-4 mb-4">
            <div class="form-group">
              <label>Tipo de Documento *</label>
              <select id="serieTipo" onchange="sugerirPrefixoSerie()">
                <option value="">-- Selecione --</option>
                <option value="Fatura">Fatura</option>
                <option value="Fatura Simplificada">Fatura Simplificada</option>
                <option value="Fatura-Recibo">Fatura-Recibo</option>
                <option value="Nota CrÃ©dito">Nota de CrÃ©dito</option>
                <option value="Nota DÃ©bito">Nota de DÃ©bito</option>
                <option value="Recibo">Recibo</option>
                <option value="Guia Transporte">Guia de Transporte</option>
                <option value="Guia Remessa">Guia de Remessa</option>
                <option value="OrÃ§/CotaÃ§Ã£o">OrÃ§/CotaÃ§Ã£o</option>
                <option value="RequisiÃ§Ã£o">RequisiÃ§Ã£o</option>
                <option value="Pagamento Fornecedor">Pagamento a Fornecedor</option>
                <option value="DÃ©bito Fornecedor">DÃ©bito a Fornecedor</option>
              </select>
            </div>
            <div class="form-group">
              <label>CÃ³digo da SÃ©rie * <small class="text-slate-400">(2-4 letras)</small></label>
              <input type="text" id="serieCodigo" placeholder="Ex: FT, NC, RC" maxlength="4" style="text-transform: uppercase;">
            </div>
          </div>
          
          <div class="grid grid-cols-3 gap-4 mb-4">
            <div class="form-group">
              <label>Prefixo</label>
              <input type="text" id="seriePrefixo" placeholder="Ex: FT" maxlength="10">
            </div>
            <div class="form-group">
              <label>PrÃ³ximo NÃºmero *</label>
              <input type="number" id="serieProxNum" value="1" min="1">
            </div>
            <div class="form-group">
              <label>Ano *</label>
              <input type="number" id="serieAno" value="2025" min="2020" max="2099">
            </div>
          </div>
          
          <div class="form-group mb-4">
            <label>Estado</label>
            <div class="flex gap-4 mt-2">
              <label class="flex items-center gap-2 cursor-pointer">
                <input type="radio" name="serieEstado" value="Ativo" checked>
                <span class="text-emerald-600 font-medium">âœ… Ativo</span>
              </label>
              <label class="flex items-center gap-2 cursor-pointer">
                <input type="radio" name="serieEstado" value="Inativo">
                <span class="text-red-600 font-medium">âŒ Inativo</span>
              </label>
            </div>
          </div>
          
          <div class="p-3 bg-amber-50 rounded-lg text-amber-800 text-sm">
            âš ï¸ <strong>AtenÃ§Ã£o:</strong> Alterar o prÃ³ximo nÃºmero pode causar problemas de sequÃªncia. Use apenas quando necessÃ¡rio.
          </div>
          
        </div>
        <div class="modal-footer">
          <button onclick="fecharModal('modalSerie')" class="btn btn-secondary">Cancelar</button>
          <button onclick="guardarSerie()" class="btn btn-primary">ğŸ’¾ Guardar</button>
        </div>
      </div>
    </div>
    
    <!-- MODAL: MudanÃ§a de Ano -->
    <div id="modalMudancaAno" class="modal-overlay">
      <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
          <h3>ğŸ“… MudanÃ§a de Ano</h3>
          <button onclick="fecharModal('modalMudancaAno')" class="text-white hover:text-gray-200 text-2xl">&times;</button>
        </div>
        <div class="modal-body">
          <div class="mb-4 p-4 bg-amber-50 rounded-lg text-amber-800">
            <p class="font-semibold mb-2">âš ï¸ Esta operaÃ§Ã£o irÃ¡:</p>
            <ul class="list-disc list-inside text-sm space-y-1">
              <li>Atualizar o ano de todas as sÃ©ries ativas</li>
              <li>Reiniciar a numeraÃ§Ã£o para 1</li>
              <li>Manter o histÃ³rico do ano anterior</li>
            </ul>
          </div>
          
          <div class="grid grid-cols-2 gap-4 mb-4">
            <div class="form-group">
              <label>Ano Atual</label>
              <input type="text" id="mudancaAnoAtual" readonly class="bg-slate-100">
            </div>
            <div class="form-group">
              <label>Novo Ano *</label>
              <input type="number" id="mudancaNovoAno" min="2020" max="2099">
            </div>
          </div>
          
          <div class="form-group mb-4">
            <label class="flex items-center gap-2 cursor-pointer">
              <input type="checkbox" id="mudancaConfirmar">
              <span class="text-sm">Confirmo que pretendo mudar o ano e reiniciar todas as numeraÃ§Ãµes</span>
            </label>
          </div>
          
        </div>
        <div class="modal-footer">
          <button onclick="fecharModal('modalMudancaAno')" class="btn btn-secondary">Cancelar</button>
          <button onclick="executarMudancaAno()" class="btn btn-warning">ğŸ“… Executar MudanÃ§a</button>
        </div>
      </div>
    </div>

    <!-- PAGE: CONFIGURAÃ‡Ã•ES -->
    <section id="page-configuracoes" class="p-8 hidden">
      <div class="card">
        <div class="card-header">
          <h3 class="font-bold text-lg text-slate-800">âš™ï¸ ConfiguraÃ§Ãµes de FaturaÃ§Ã£o</h3>
        </div>
        <div class="card-body">
          
          <div class="tab-container">
            <button class="tab-btn active" onclick="mudarTabConfig('empresa')">Dados Empresa</button>
            <button class="tab-btn" onclick="mudarTabConfig('geral')">Geral</button>
            <button class="tab-btn" onclick="mudarTabConfig('iva')">CÃ³digos IVA</button>
            <button class="tab-btn" onclick="mudarTabConfig('emails')">Emails AutomÃ¡ticos</button>
            <button class="tab-btn" onclick="mudarTabConfig('textos')">Textos PadrÃ£o</button>
            <button class="tab-btn" onclick="mudarTabConfig('diagnostico')" style="background: #fef3c7; border-color: #f59e0b;">ğŸ”§ DiagnÃ³stico</button>
          </div>
          
          <!-- Tab Dados Empresa (NOVA) -->
          <div id="tab-cfg-empresa" class="tab-content active">
            <div class="mb-4 p-4 bg-emerald-50 rounded-lg text-emerald-800 text-sm">
              ğŸ¢ <strong>Dados da Empresa:</strong> Estes dados aparecem no cabeÃ§alho e rodapÃ© de todas as faturas emitidas.
            </div>
            
            <div class="grid grid-cols-2 gap-6">
              <div class="form-group">
                <label>Nome da Empresa *</label>
                <input type="text" id="cfgEmpresaNome" placeholder="Ex: Emeutrans Lda">
              </div>
              <div class="form-group">
                <label>NIF / Contribuinte *</label>
                <input type="text" id="cfgEmpresaNIF" placeholder="Ex: PT515996149">
              </div>
              <div class="form-group">
                <label>Morada *</label>
                <input type="text" id="cfgEmpresaMorada" placeholder="Ex: Rua da Empresa, NÂº 100, ArmazÃ©m 5">
              </div>
              <div class="form-group">
                <label>Localidade / CÃ³digo Postal *</label>
                <input type="text" id="cfgEmpresaLocalidade" placeholder="Ex: 4400-000 Vila Nova de Gaia">
              </div>
              <div class="form-group">
                <label>Telefone</label>
                <input type="text" id="cfgEmpresaTelefone" placeholder="Ex: +351 220 000 000">
              </div>
              <div class="form-group">
                <label>Email</label>
                <input type="email" id="cfgEmpresaEmail" placeholder="Ex: geral@emeutrans.pt">
              </div>
              <div class="form-group">
                <label>IBAN *</label>
                <input type="text" id="cfgEmpresaIBAN" placeholder="Ex: PT50 0035 0000 00000000000 97">
              </div>
              <div class="form-group">
                <label>Capital Social</label>
                <input type="text" id="cfgEmpresaCapital" placeholder="Ex: 125.000â‚¬">
              </div>
              <div class="form-group">
                <label>Registo Comercial</label>
                <input type="text" id="cfgEmpresaRC" placeholder="Ex: Matriculada C.R.C. Vila Nova de Gaia">
              </div>
              <div class="form-group">
                <label>CertificaÃ§Ã£o Software AT</label>
                <input type="text" id="cfgEmpresaCertificacao" placeholder="Ex: Programa certificado nÂº 0000/AT">
              </div>
            </div>
            
            <div class="mt-6 flex gap-4">
              <button onclick="guardarDadosEmpresa()" class="btn btn-success">ğŸ’¾ Guardar Dados da Empresa</button>
              <button onclick="carregarDadosEmpresaForm()" class="btn btn-secondary">ğŸ”„ Repor Valores Guardados</button>
              <button onclick="reporDadosFabricaEmpresa()" class="btn btn-warning">ğŸ­ Repor Dados de FÃ¡brica</button>
            </div>
          </div>
          
          <!-- Tab Geral -->
          <div id="tab-cfg-geral" class="tab-content">
            <div class="grid grid-cols-2 gap-6">
              <div class="form-group">
                <label>Prazo de Pagamento PadrÃ£o (dias)</label>
                <input type="number" id="cfgPrazoPagamento" value="30">
              </div>
              <div class="form-group">
                <label>Dias Aviso Antes Vencimento</label>
                <input type="number" id="cfgDiasAviso" value="5">
              </div>
              <div class="form-group">
                <label>Moeda</label>
                <select id="cfgMoeda">
                  <option value="EUR">EUR (â‚¬)</option>
                </select>
              </div>
              <div class="form-group">
                <label>Casas Decimais PreÃ§os</label>
                <select id="cfgDecimais">
                  <option value="2">2 decimais</option>
                  <option value="3">3 decimais</option>
                </select>
              </div>
              <div class="form-group">
                <label>MÃ¡ximo Linhas por Fatura</label>
                <input type="number" id="cfgMaxLinhas" value="30">
              </div>
              <div class="form-group">
                <label>IBAN da Empresa</label>
                <input type="text" id="cfgIBAN" placeholder="PT50 0000 0000 0000 0000 0000 0">
              </div>
            </div>
            <div class="mt-6">
              <button onclick="guardarConfigFaturacao()" class="btn btn-success">ğŸ’¾ Guardar ConfiguraÃ§Ãµes</button>
            </div>
          </div>
          
          <!-- Tab CÃ³digos IVA -->
          <div id="tab-cfg-iva" class="tab-content">
            <div class="mb-4 p-4 bg-blue-50 rounded-lg text-blue-800 text-sm">
              ğŸ’¡ <strong>AplicaÃ§Ã£o AutomÃ¡tica:</strong> O sistema aplica automaticamente o cÃ³digo de IVA correto baseado no tipo de cliente e locais de carga/descarga.
            </div>
            
            <h4 class="font-bold text-slate-700 mb-3">ğŸ‡µğŸ‡¹ Cliente PortuguÃªs (Nacional - 21111)</h4>
            <table class="mb-6">
              <thead>
                <tr>
                  <th>Mercadoria</th>
                  <th>Carga</th>
                  <th>Descarga</th>
                  <th>Conta RazÃ£o</th>
                  <th>IVA</th>
                  <th>Artigo</th>
                  <th>Conta IVA</th>
                </tr>
              </thead>
              <tbody>
                <tr><td>Normal</td><td>PT</td><td>PT</td><td>72113</td><td>23%</td><td>IVA Liquidado O.B.S. Taxa Normal</td><td>2433113</td></tr>
                <tr><td>Normal</td><td>PT</td><td>EUR</td><td>72122</td><td>0%</td><td>Art. 14Âº nÂº1 AlÃ­nea q CIVA</td><td>2433110</td></tr>
                <tr><td>Normal</td><td>EUR</td><td>PT</td><td>72113</td><td>23%</td><td>IVA Liquidado O.B.S. Taxa Normal</td><td>2433113</td></tr>
                <tr><td>Normal</td><td>EUR</td><td>EUR</td><td>72113</td><td>23%</td><td>IVA Liquidado O.B.S. Taxa Normal</td><td>2433113</td></tr>
                <tr><td>ResÃ­duos</td><td>PT</td><td>PT</td><td>72111</td><td>6%</td><td>IVA Liquidado O.B.S. Tx Red.</td><td>2433111</td></tr>
                <tr><td>ResÃ­duos</td><td>PT</td><td>EUR</td><td>72122</td><td>0%</td><td>Art. 14Âº nÂº1 AlÃ­nea q CIVA</td><td>2433110</td></tr>
                <tr><td>ResÃ­duos</td><td>EUR</td><td>PT</td><td>72111</td><td>6%</td><td>IVA Liquidado O.B.S. Tx Red.</td><td>2433111</td></tr>
                <tr><td>ResÃ­duos</td><td>EUR</td><td>EUR</td><td>72111</td><td>6%</td><td>IVA Liquidado O.B.S. Tx Red.</td><td>2433111</td></tr>
              </tbody>
            </table>
            
            <h4 class="font-bold text-slate-700 mb-3">ğŸ‡ªğŸ‡º Cliente Europeu (IntraComunitÃ¡rio - 21112)</h4>
            <table class="mb-6">
              <thead>
                <tr>
                  <th>Mercadoria</th>
                  <th>Carga</th>
                  <th>Descarga</th>
                  <th>Conta RazÃ£o</th>
                  <th>IVA</th>
                  <th>Artigo</th>
                  <th>Conta IVA</th>
                </tr>
              </thead>
              <tbody>
                <tr><td>Normal/ResÃ­duos</td><td>*</td><td>*</td><td>72123</td><td>0%</td><td>Art 6.Âº CIVA nÂº6 a) - Ã  contrÃ¡rio</td><td>2433110</td></tr>
              </tbody>
            </table>
            
            <h4 class="font-bold text-slate-700 mb-3">ğŸŒ Cliente Externo (Fora UE - 21113)</h4>
            <table>
              <thead>
                <tr>
                  <th>Mercadoria</th>
                  <th>Carga</th>
                  <th>Descarga</th>
                  <th>Conta RazÃ£o</th>
                  <th>IVA</th>
                  <th>Artigo</th>
                  <th>Conta IVA</th>
                </tr>
              </thead>
              <tbody>
                <tr><td>Normal/ResÃ­duos</td><td>*</td><td>*</td><td>72131</td><td>0%</td><td>Art. 14Âº nÂº1 a) p CIVA</td><td>2433310</td></tr>
              </tbody>
            </table>
          </div>
          
          <!-- Tab Emails -->
          <div id="tab-cfg-emails" class="tab-content">
            <div class="space-y-4">
              <div class="flex items-center justify-between p-4 bg-slate-50 rounded-lg">
                <div>
                  <p class="font-semibold">Enviar Fatura + CMR por Email (AutomÃ¡tico)</p>
                  <p class="text-sm text-slate-500">Envia quando o CMR de descarga chega (faturaÃ§Ã£o automÃ¡tica)</p>
                </div>
                <label class="relative inline-flex items-center cursor-pointer">
                  <input type="checkbox" class="sr-only peer" checked id="cfgEnvioAutomatico">
                  <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-checked:bg-emerald-600 after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:after:translate-x-full"></div>
                </label>
              </div>
              <div class="flex items-center justify-between p-4 bg-slate-50 rounded-lg">
                <div>
                  <p class="font-semibold">Aviso 5 dias antes do Vencimento</p>
                  <p class="text-sm text-slate-500">Envia extrato com todas as faturas pendentes</p>
                </div>
                <label class="relative inline-flex items-center cursor-pointer">
                  <input type="checkbox" class="sr-only peer" checked id="cfgAvisoVencimento">
                  <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-checked:bg-emerald-600 after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:after:translate-x-full"></div>
                </label>
              </div>
              <div class="flex items-center justify-between p-4 bg-slate-50 rounded-lg">
                <div>
                  <p class="font-semibold">Aviso de Fatura Vencida</p>
                  <p class="text-sm text-slate-500">Envia quando a fatura passa do vencimento</p>
                </div>
                <label class="relative inline-flex items-center cursor-pointer">
                  <input type="checkbox" class="sr-only peer" checked id="cfgAvisoVencido">
                  <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-checked:bg-emerald-600 after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:after:translate-x-full"></div>
                </label>
              </div>
            </div>
          </div>
          
          <!-- Tab Textos -->
          <div id="tab-cfg-textos" class="tab-content">
            <div class="form-group">
              <label>Texto Email Aviso Vencimento</label>
              <textarea id="cfgTextoAvisoVencimento" rows="4" class="w-full">Estimado Cliente,

Informamos que a(s) seguinte(s) fatura(s) encontra(m)-se prÃ³xima(s) do vencimento. Agradecemos a regularizaÃ§Ã£o atempada.

Segue em anexo o extrato de conta corrente atualizado.

Com os melhores cumprimentos,
Emeutrans Lda</textarea>
            </div>
            <div class="form-group">
              <label>Texto RodapÃ© Fatura</label>
              <textarea id="cfgTextoRodape" rows="2" class="w-full">Obrigado pela preferÃªncia. Para qualquer esclarecimento, nÃ£o hesite em contactar-nos.</textarea>
            </div>
            <div class="mt-4">
              <button onclick="guardarConfigFaturacao()" class="btn btn-success">ğŸ’¾ Guardar</button>
            </div>
          </div>
          
          <!-- Tab DiagnÃ³stico -->
          <div id="tab-cfg-diagnostico" class="tab-content">
            <div class="mb-4 p-4 bg-amber-50 rounded-lg text-amber-800 text-sm">
              ğŸ”§ <strong>DiagnÃ³stico do Sistema:</strong> Use estas ferramentas para identificar e reportar problemas.
            </div>
            
            <!-- BotÃµes de AcÃ§Ã£o -->
            <div class="grid grid-cols-3 gap-4 mb-6">
              <div class="p-4 bg-blue-50 border border-blue-200 rounded-lg text-center">
                <span class="text-4xl mb-2 block">ğŸ“‹</span>
                <h4 class="font-semibold text-blue-800 mb-2">Exportar DiagnÃ³stico</h4>
                <p class="text-blue-600 text-sm mb-3">Gera ficheiro JSON completo com estado do sistema, dados e erros.</p>
                <button onclick="gerarDiagnostico()" class="btn btn-primary">ğŸ“¥ Exportar DiagnÃ³stico</button>
              </div>
              <div class="p-4 bg-green-50 border border-green-200 rounded-lg text-center">
                <span class="text-4xl mb-2 block">ğŸ“</span>
                <h4 class="font-semibold text-green-800 mb-2">Exportar Logs</h4>
                <p class="text-green-600 text-sm mb-3">Exporta logs em formato texto simples para anÃ¡lise.</p>
                <button onclick="exportarLogsTexto()" class="btn btn-success">ğŸ“„ Exportar Logs .txt</button>
              </div>
              <div class="p-4 bg-red-50 border border-red-200 rounded-lg text-center">
                <span class="text-4xl mb-2 block">ğŸ—‘ï¸</span>
                <h4 class="font-semibold text-red-800 mb-2">Limpar Logs</h4>
                <p class="text-red-600 text-sm mb-3">Remove todos os logs guardados no sistema.</p>
                <button onclick="limparLogs()" class="btn btn-danger">ğŸ—‘ï¸ Limpar Logs</button>
              </div>
            </div>
            
            <!-- InformaÃ§Ã£o do Sistema -->
            <div class="mb-6 p-4 bg-slate-50 border border-slate-200 rounded-lg">
              <h4 class="font-semibold text-slate-800 mb-3">ğŸ“Š InformaÃ§Ã£o do Sistema</h4>
              <div class="grid grid-cols-4 gap-4 text-sm">
                <div>
                  <span class="text-slate-500">VersÃ£o ERP:</span>
                  <span class="font-semibold">4.1</span>
                </div>
                <div>
                  <span class="text-slate-500">Navegador:</span>
                  <span class="font-semibold" id="diagNavegador">-</span>
                </div>
                <div>
                  <span class="text-slate-500">Online:</span>
                  <span class="font-semibold" id="diagOnline">-</span>
                </div>
                <div>
                  <span class="text-slate-500">LocalStorage:</span>
                  <span class="font-semibold" id="diagStorage">-</span>
                </div>
              </div>
            </div>
            
            <!-- Painel de Logs -->
            <div class="mb-4">
              <div class="flex justify-between items-center mb-3">
                <h4 class="font-semibold text-slate-800">ğŸ“‹ Ãšltimos Logs do Sistema</h4>
                <button onclick="renderizarPainelLogs()" class="btn btn-secondary btn-sm">ğŸ”„ Actualizar</button>
              </div>
              <div id="painelLogs" class="border rounded-lg p-4 bg-white">
                <div class="text-center text-slate-500 py-4">
                  A carregar logs...
                </div>
              </div>
            </div>
            
            <!-- InstruÃ§Ãµes -->
            <div class="p-4 bg-blue-50 border border-blue-200 rounded-lg">
              <h4 class="font-semibold text-blue-800 mb-2">ğŸ“ Como Reportar um Problema:</h4>
              <ol class="text-blue-700 text-sm space-y-1 list-decimal list-inside">
                <li>Clique em <strong>"Exportar DiagnÃ³stico"</strong> para gerar o ficheiro JSON</li>
                <li>Se houver erros, tire tambÃ©m um <strong>screenshot da consola F12</strong></li>
                <li>Descreva o que estava a fazer quando o erro ocorreu</li>
                <li>Envie o ficheiro de diagnÃ³stico + screenshot + descriÃ§Ã£o</li>
              </ol>
            </div>
          </div>
          
        </div>
      </div>
    </section>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <!-- â•‘                    MÃ“DULOS FUTUROS - PÃGINAS PLACEHOLDER                      â•‘ -->
    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->

    <!-- PAGE: RESERVAS -->
    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <!-- ğŸ“¦ PAGE: RESERVAS - MÃ“DULO INTEGRADO v5.2 (LAYOUT ORIGINAL)                      -->
    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <section id="page-reservas" class="p-8 hidden">
      <!-- O formulÃ¡rio de reservas abre diretamente aqui com o layout original -->
      <div class="reservas-container">
        <div class="reservas-header">
            <div style="display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:15px;">
                <div>
                    <h1 data-i18n="bookings_open_cargo">ğŸ“‹ Abertura de Reserva de Carga</h1>
                    <p data-i18n="required_fields_note">Os campos com (*) sÃ£o obrigatÃ³rios</p>
                </div>
                <div style="display:flex;gap:10px;flex-wrap:wrap;">
                    <button type="button" onclick="novaReservaLimpa()" style="padding:10px 20px;background:linear-gradient(135deg,#27ae60,#2ecc71);color:white;border:none;border-radius:8px;cursor:pointer;font-weight:600;font-size:14px;">â• Nova Reserva</button>
                    <button type="button" onclick="abrirListaReservas()" style="padding:10px 20px;background:linear-gradient(135deg,#3498db,#2980b9);color:white;border:none;border-radius:8px;cursor:pointer;font-weight:600;font-size:14px;">ğŸ“‹ Ver Reservas</button>
                </div>
            </div>
            <!-- QR Code movido para SecÃ§Ã£o 1 (v6.10) -->
        </div>

        <div class="reservas-fatura-banner" id="faturaBanner">
            <div><span data-i18n="invoice_number">ğŸ“„ NÂº Fatura:</span> <span class="numero" id="numFaturaDisplay">-</span></div>
            <div id="statusFatura" data-i18n="booking_editable">ğŸ”“ Reserva EditÃ¡vel</div>
        </div>

        <div class="reservas-form-content">
            <form id="formReserva" action="javascript:void(0)" onsubmit="return false;">
                
                <!-- SECÃ‡ÃƒO 1: Dados do Cliente -->
                <section class="reservas-section-box" id="secao1">
                    <h2 data-i18n="section1_customer_data">ğŸ‘¤ SecÃ§Ã£o 1 - Dados do Cliente</h2>
                    
                    <!-- BotÃ£o Ler Ordem de Carga (v6.13) -->
                    <div style="margin-bottom:15px; padding:12px; background:linear-gradient(135deg,#667eea11,#764ba211); border:2px dashed #667eea; border-radius:10px;">
                        <div style="display:flex; align-items:center; gap:15px; flex-wrap:wrap;">
                            <button type="button" onclick="abrirModalOrdemCarga()" style="background:linear-gradient(135deg,#667eea,#764ba2); color:white; padding:12px 25px; border:none; border-radius:8px; font-weight:bold; cursor:pointer; display:flex; align-items:center; gap:10px; font-size:14px; box-shadow:0 4px 15px rgba(102,126,234,0.4);">
                                ğŸ“„ LER ORDEM DE CARGA
                            </button>
                            <span style="color:#667eea; font-size:13px;">
                                <strong>NOVO!</strong> Anexe a ordem de carga (PDF/Imagem) e o sistema preenche automaticamente os campos.
                            </span>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 170px 130px 150px 220px 80px; gap: 12px; margin-bottom: 15px; align-items: end;">
                        <div class="reservas-form-group" style="margin-bottom:0;">
                            <label><span class="reservas-campo-num">R1</span> NÂº Reserva:</label>
                            <input type="text" id="numero_reserva" value="Auto" disabled style="font-size:12px; font-weight:bold;">
                        </div>
                        <div class="reservas-form-group" style="margin-bottom:0;">
                            <label><span class="reservas-campo-num">R2</span> Data:</label>
                            <input type="date" id="data_abertura" readonly style="font-size:11px; background:#e9ecef; cursor:not-allowed;" title="Data preenchida automaticamente pelo sistema">
                        </div>
                        <div class="reservas-form-group" style="margin-bottom:0;">
                            <label style="color:#27ae60;"><span class="reservas-campo-num" style="background:linear-gradient(135deg,#27ae60,#2ecc71);">F</span> NÂº Fatura:</label>
                            <input type="text" id="numero_fatura" value="-" disabled style="font-size:11px; background:#e8f5e9; border-color:#27ae60; font-weight:bold; color:#27ae60;">
                        </div>
                        <div class="reservas-form-group" style="margin-bottom:0;">
                            <label><span class="reservas-campo-num">R3</span> Bloqueio: <span style="font-size:9px;color:#6c757d;">(clique)</span></label>
                            <div class="reservas-motivo-bloqueio" id="motivoBloqueio" onclick="expandirMotivoBloqueio()" style="cursor:pointer; max-height:36px; overflow:hidden; text-overflow:ellipsis; padding:6px 8px; font-size:11px;" title="Clique para ver o histÃ³rico completo">
                                <span id="motivoTexto">âœ… Sem bloqueio</span>
                            </div>
                        </div>
                        <div style="text-align:center;">
                            <div id="reservaQRCode" style="width:70px; height:70px; margin:0 auto; background:#fff; border:1px solid #ddd; border-radius:4px; display:flex; align-items:center; justify-content:center; font-size:9px; color:#999;">QR</div>
                        </div>
                    </div>

                    <div class="reservas-form-group">
                        <label><span class="reservas-campo-num">R4</span> * Cliente:</label>
                        <div class="reservas-input-group">
                            <input type="text" id="cliente" required list="listaClientesReservas">
                            <datalist id="listaClientesReservas"></datalist>
                            <button type="button" id="btnClienteConfig" class="reservas-btn reservas-btn-blue" onclick="preencherCliente()">âš™ï¸</button>
                        </div>
                    </div>
                    
                    <!-- Campos adicionais do cliente -->
                    <div style="display: grid; grid-template-columns: 120px 150px 180px; gap: 12px; margin-bottom: 15px;">
                        <div class="reservas-form-group" style="margin-bottom:0;">
                            <label><span class="reservas-campo-num" style="background:#6c757d;">NÂº</span> NÂº Cliente:</label>
                            <input type="text" id="cliente_numero" readonly style="font-size:11px; background:#e9ecef; font-weight:bold;">
                        </div>
                        <div class="reservas-form-group" style="margin-bottom:0;">
                            <label><span class="reservas-campo-num" style="background:#6c757d;">NIF</span> NIF/Contrib.:</label>
                            <input type="text" id="cliente_nif" readonly style="font-size:11px; background:#e9ecef;">
                        </div>
                        <div class="reservas-form-group" style="margin-bottom:0;">
                            <label><span class="reservas-campo-num" style="background:#e67e22;">C52</span> Modo FaturaÃ§Ã£o:</label>
                            <input type="text" id="cliente_modo_faturacao" readonly style="font-size:11px; background:#fff3cd; border-color:#e67e22; font-weight:bold; color:#856404;">
                        </div>
                    </div>

                    <h3>Morada do Cliente</h3>
                    <div class="reservas-grid-5" style="margin-bottom:12px;">
                        <div class="reservas-form-group" style="margin-bottom:0;"><label><span class="reservas-campo-num">R5</span> * Rua:</label><input type="text" id="cliente_rua" required></div>
                        <div class="reservas-form-group" style="margin-bottom:0;"><label><span class="reservas-campo-num">R6</span> * NÂº:</label><input type="text" id="cliente_nr" required></div>
                        <div class="reservas-form-group" style="margin-bottom:0;"><label><span class="reservas-campo-num">R7</span> * Localidade:</label><input type="text" id="cliente_local" required></div>
                        <div class="reservas-form-group" style="margin-bottom:0;"><label><span class="reservas-campo-num">R8</span> * CP:</label><input type="text" id="cliente_cp" required></div>
                        <div class="reservas-form-group" style="margin-bottom:0;"><label><span class="reservas-campo-num">R9</span> * Cidade:</label><input type="text" id="cliente_cidade" required></div>
                    </div>
                    <div class="reservas-grid-4">
                        <div class="reservas-form-group"><label><span class="reservas-campo-num">R10</span> * Concelho:</label><input type="text" id="cliente_concelho" required></div>
                        <div class="reservas-form-group"><label><span class="reservas-campo-num">R11</span> * PaÃ­s:</label><input type="text" id="cliente_pais" required></div>
                        <div class="reservas-form-group"><label><span class="reservas-campo-num">R12</span> * Telefone:</label><input type="tel" id="cliente_tel" required></div>
                        <div class="reservas-form-group"><label><span class="reservas-campo-num">R13</span> * Freguesia:</label><input type="text" id="cliente_freg" required></div>
                    </div>
                    <div class="reservas-grid-2">
                        <div class="reservas-form-group"><label><span class="reservas-campo-num">R14</span> * Comercial:</label><div class="reservas-input-group"><input type="text" id="comercial" required><button type="button" id="btnComercial" class="reservas-btn reservas-btn-orange" onclick="abrirModalComerciais()">ğŸ‘¤</button></div></div>
                        <div class="reservas-form-group"><label><span class="reservas-campo-num">R15</span> * Equipa LogÃ­stica:</label><div class="reservas-input-group"><input type="text" id="equipa" required><button type="button" id="btnEquipaLogistica" class="reservas-btn reservas-btn-orange" onclick="abrirModalEquipas()">ğŸ‘¥</button></div></div>
                    </div>
                </section>

                <!-- SECÃ‡ÃƒO 2: Detalhes da Carga -->
                <section class="reservas-section-box" id="secao2">
                    <h2 data-i18n="section2_cargo_details">ğŸ“¦ SecÃ§Ã£o 2 - Detalhes da Carga</h2>
                    <div class="reservas-grid-4">
                        <div class="reservas-form-group"><label><span class="reservas-campo-num">R16</span> * LDM (metros):</label><input type="number" id="ldm" step="0.1" required oninput="atualizarObrigatoriedadeCampos()"></div>
                        <div class="reservas-form-group"><label id="labelR17"><span class="reservas-campo-num">R17</span> <span id="astR17" style="color:#e74c3c;font-weight:bold;">*</span> NÂº Bultos:</label><input type="number" id="num_bultos" oninput="atualizarObrigatoriedadeCampos()"></div>
                        <div class="reservas-form-group"><label><span class="reservas-campo-num">R18</span> * DescriÃ§Ã£o:</label><input type="text" id="descricao_carga" required oninput="atualizarObrigatoriedadeCampos()"></div>
                        <div class="reservas-form-group"><label id="labelR19"><span class="reservas-campo-num">R19</span> <span id="astR19" style="color:#e74c3c;font-weight:bold;">*</span> Peso (kg):</label><input type="number" id="peso" step="0.1" oninput="atualizarObrigatoriedadeCampos()"></div>
                    </div>
                    <div class="reservas-grid-3">
                        <div class="reservas-form-group"><label><span class="reservas-campo-num">R20</span> * PreÃ§o (â‚¬):</label><input type="number" id="preco" step="0.01" required oninput="atualizarObrigatoriedadeCampos()"></div>
                        <div class="reservas-form-group"><label id="labelR21"><span class="reservas-campo-num">R21</span> <span id="astR21" style="color:#e74c3c;font-weight:bold;">*</span> NÂº Volumes:</label><input type="number" id="volumes" oninput="atualizarObrigatoriedadeCampos()"></div>
                        <div class="reservas-form-group"><label><span class="reservas-campo-num">R22</span> * Tipo Mercadoria:</label><input type="text" id="tipo_merc" required></div>
                    </div>
                    <div class="reservas-grid-3">
                        <div class="reservas-form-group"><label><span class="reservas-campo-num">R23</span> Ton. Carga:</label><input type="number" id="ton_carga" step="0.1" oninput="atualizarObrigatoriedadeCampos()"></div>
                        <div class="reservas-form-group"><label><span class="reservas-campo-num">R24</span> Ton. Descarga:</label><input type="number" id="ton_descarga" step="0.1" oninput="atualizarObrigatoriedadeCampos()"></div>
                        <div class="reservas-form-group"><label><span class="reservas-campo-num">R25</span> PreÃ§o/Ton (â‚¬):</label><input type="number" id="preco_ton" step="0.01" oninput="atualizarObrigatoriedadeCampos()"></div>
                    </div>
                </section>

                <!-- SECÃ‡ÃƒO 3: Local de Carga -->
                <section class="reservas-section-box" id="secao3">
                    <h2 data-i18n="section3_loading_location">ğŸšš SecÃ§Ã£o 3 - Local de Carga</h2>
                    <div class="reservas-action-buttons">
                        <button type="button" class="reservas-btn reservas-btn-blue" onclick="copiarMoradaCarga()" data-i18n="copy_customer_address">ğŸ“‹ Copiar Morada Cliente</button>
                        <button type="button" class="reservas-btn reservas-btn-orange" onclick="mensagemMotoristaCarga()" data-i18n="driver_message">ğŸ’¬ Mensagem Motorista</button>
                        <button type="button" class="reservas-btn reservas-btn-green" onclick="abrirPainelRecolhas()" data-i18n="collections">ğŸ“¦ Recolhas</button>
                        <button type="button" class="reservas-btn reservas-btn-green" onclick="abrirModalLocalCarga()" style="background:linear-gradient(135deg,#1e8449,#27ae60);">ğŸ—ºï¸ Ver Local de Carga</button>
                    </div>
                    <div class="reservas-form-group"><label><span class="reservas-campo-num">R26</span> * Empresa de Carga:</label><input type="text" id="empresa_carga" required></div>
                    <h3>Morada de Carga</h3>
                    <div class="reservas-grid-4">
                        <div class="reservas-form-group"><label><span class="reservas-campo-num">R27</span> * Rua:</label><input type="text" id="carga_rua" required></div>
                        <div class="reservas-form-group"><label><span class="reservas-campo-num">R28</span> * NÂº:</label><input type="text" id="carga_nr" required></div>
                        <div class="reservas-form-group"><label><span class="reservas-campo-num">R29</span> * Localidade:</label><input type="text" id="carga_local" required></div>
                        <div class="reservas-form-group"><label><span class="reservas-campo-num">R30</span> * Freguesia:</label><input type="text" id="carga_freg" required></div>
                    </div>
                    <div class="reservas-grid-4">
                        <div class="reservas-form-group"><label><span class="reservas-campo-num">R31</span> * CP:</label><input type="text" id="carga_cp" required></div>
                        <div class="reservas-form-group"><label><span class="reservas-campo-num">R32</span> * Cidade:</label><input type="text" id="carga_cidade" required></div>
                        <div class="reservas-form-group"><label><span class="reservas-campo-num">R33</span> * Concelho:</label><input type="text" id="carga_concelho" required></div>
                        <div class="reservas-form-group"><label><span class="reservas-campo-num">R34</span> * PaÃ­s:</label><input type="text" id="carga_pais" required></div>
                    </div>
                    <h3>LogÃ­stica</h3>
                    <div class="reservas-grid-4">
                        <div class="reservas-form-group"><label><span class="reservas-campo-num">R35</span> Motorista:</label><div class="reservas-input-group"><input type="text" id="motorista_carga" placeholder="Preenchido via Agenda 1"><button type="button" class="reservas-btn reservas-btn-orange" onclick="selecionarMotorista('motorista_carga')">ğŸ‘¤</button></div></div>
                        <div class="reservas-form-group"><label><span class="reservas-campo-num">R36</span> Trator:</label><div class="reservas-input-group"><input type="text" id="trator_carga" placeholder="Preenchido via Agenda 1"><button type="button" class="reservas-btn reservas-btn-orange" onclick="selecionarTrator('trator_carga')">ğŸš›</button></div></div>
                        <div class="reservas-form-group"><label><span class="reservas-campo-num">R37</span> Reboque:</label><div class="reservas-input-group"><input type="text" id="reboque_carga" placeholder="Preenchido via Agenda 1"><button type="button" class="reservas-btn reservas-btn-orange" onclick="selecionarReboque('reboque_carga')">ğŸš›</button></div></div>
                        <div class="reservas-form-group"><label><span class="reservas-campo-num">R38</span> * Ref. CombustÃ­vel:</label><input type="text" id="ref_comb" required></div>
                    </div>
                    <h3>Contactos e Datas</h3>
                    <div class="reservas-grid-3">
                        <div class="reservas-form-group"><label><span class="reservas-campo-num">R39</span> Contacto:</label><input type="text" id="contacto_carga"></div>
                        <div class="reservas-form-group"><label><span class="reservas-campo-num">R40</span> Telefone:</label><input type="tel" id="tel_carga"></div>
                        <div class="reservas-form-group"><label><span class="reservas-campo-num">R41</span> * Data Solicitada:</label><input type="date" id="data_carga_sol" required></div>
                    </div>
                    <div class="reservas-grid-3">
                        <div class="reservas-form-group"><label><span class="reservas-campo-num">R42</span> Data Efetiva:</label><input type="datetime-local" id="data_carga_ef" readonly style="background:#e9ecef; cursor:not-allowed;" title="Preenchido automaticamente quando o CMR de Carga Ã© anexado"></div>
                        <div class="reservas-form-group"><label><span class="reservas-campo-num">R43</span> * Ref. Carga:</label><input type="text" id="ref_carga" required></div>
                        <div class="reservas-form-group"><label><span class="reservas-campo-num">R44</span> * Ref. Cliente:</label><input type="text" id="ref_cliente" required></div>
                    </div>
                </section>

                <!-- SECÃ‡ÃƒO 4: Local de Descarga -->
                <section class="reservas-section-box" id="secao4">
                    <h2 data-i18n="section4_unloading_location">ğŸ“ SecÃ§Ã£o 4 - Local de Descarga</h2>
                    <div class="reservas-action-buttons">
                        <button type="button" class="reservas-btn reservas-btn-blue" onclick="copiarMoradaDescarga()" data-i18n="copy_customer_address">ğŸ“‹ Copiar Morada Cliente</button>
                        <button type="button" class="reservas-btn reservas-btn-orange" onclick="mensagemMotoristaDescarga()" data-i18n="driver_message">ğŸ’¬ Mensagem Motorista</button>
                        <button type="button" class="reservas-btn reservas-btn-green" onclick="abrirModalLocalDescarga()" style="background:linear-gradient(135deg,#1e8449,#27ae60);">ğŸ—ºï¸ Ver Local de Descarga</button>
                    </div>
                    <div class="reservas-form-group"><label><span class="reservas-campo-num">R45</span> * Empresa de Descarga:</label><div class="reservas-input-group"><input type="text" id="empresa_descarga" required><button type="button" id="btnEmpresaDescarga" class="reservas-btn reservas-btn-orange">âš™ï¸</button></div></div>
                    <h3>Morada de Descarga</h3>
                    <div class="reservas-grid-4">
                        <div class="reservas-form-group"><label><span class="reservas-campo-num">R46</span> * Rua:</label><input type="text" id="descarga_rua" required></div>
                        <div class="reservas-form-group"><label><span class="reservas-campo-num">R47</span> * NÂº:</label><input type="text" id="descarga_nr" required></div>
                        <div class="reservas-form-group"><label><span class="reservas-campo-num">R48</span> * Localidade:</label><input type="text" id="descarga_local" required></div>
                        <div class="reservas-form-group"><label><span class="reservas-campo-num">R49</span> * Freguesia:</label><input type="text" id="descarga_freg" required></div>
                    </div>
                    <div class="reservas-grid-4">
                        <div class="reservas-form-group"><label><span class="reservas-campo-num">R50</span> * CP:</label><input type="text" id="descarga_cp" required></div>
                        <div class="reservas-form-group"><label><span class="reservas-campo-num">R51</span> * Cidade:</label><input type="text" id="descarga_cidade" required></div>
                        <div class="reservas-form-group"><label><span class="reservas-campo-num">R52</span> * Concelho:</label><input type="text" id="descarga_concelho" required></div>
                        <div class="reservas-form-group"><label><span class="reservas-campo-num">R53</span> * PaÃ­s:</label><input type="text" id="descarga_pais" required></div>
                    </div>
                    <h3>LogÃ­stica</h3>
                    <div class="reservas-grid-4">
                        <div class="reservas-form-group"><label><span class="reservas-campo-num">R54</span> Motorista:</label><div class="reservas-input-group"><input type="text" id="motorista_descarga" placeholder="Preenchido via Agenda 1"><button type="button" class="reservas-btn reservas-btn-orange" onclick="selecionarMotorista('motorista_descarga')">ğŸ‘¤</button></div></div>
                        <div class="reservas-form-group"><label><span class="reservas-campo-num">R55</span> Trator:</label><div class="reservas-input-group"><input type="text" id="trator_descarga" placeholder="Preenchido via Agenda 1"><button type="button" class="reservas-btn reservas-btn-orange" onclick="selecionarTrator('trator_descarga')">ğŸš›</button></div></div>
                        <div class="reservas-form-group"><label><span class="reservas-campo-num">R56</span> Reboque:</label><div class="reservas-input-group"><input type="text" id="reboque_descarga" placeholder="Preenchido via Agenda 1"><button type="button" class="reservas-btn reservas-btn-orange" onclick="selecionarReboque('reboque_descarga')">ğŸš›</button></div></div>
                        <div class="reservas-form-group"><label><span class="reservas-campo-num">R57</span> * Ref. Descarga:</label><input type="text" id="ref_descarga" required></div>
                    </div>
                    <h3>Contactos e Datas</h3>
                    <div class="reservas-grid-4">
                        <div class="reservas-form-group"><label><span class="reservas-campo-num">R58</span> Contacto:</label><input type="text" id="contacto_descarga"></div>
                        <div class="reservas-form-group"><label><span class="reservas-campo-num">R59</span> Telefone:</label><input type="tel" id="tel_descarga"></div>
                        <div class="reservas-form-group"><label><span class="reservas-campo-num">R60</span> * Data Solicitada:</label><input type="date" id="data_descarga_sol" required></div>
                        <div class="reservas-form-group"><label><span class="reservas-campo-num">R61</span> Data Efetiva:</label><input type="datetime-local" id="data_descarga_ef" readonly style="background:#e9ecef; cursor:not-allowed;" title="Preenchido automaticamente quando o CMR de Descarga Ã© anexado"></div>
                    </div>
                    <div style="margin-top: 18px; display: flex; gap: 12px;">
                        <button type="button" class="reservas-btn reservas-btn-blue" onclick="alert('Criar CMR')">ğŸ“„ Criar CMR</button>
                        <button type="button" class="reservas-btn reservas-btn-green" onclick="abrirMapaRotaIntegrado()">ğŸ—ºï¸ Ver Mapa</button>
                        <button type="button" class="reservas-btn reservas-btn-navy" onclick="enviarEtiquetas()">ğŸ·ï¸ Enviar Etiquetas</button>
                    </div>
                </section>

                <!-- SECÃ‡ÃƒO 5: DocumentaÃ§Ã£o e IncidÃªncias -->
                <section class="reservas-section-box" id="secao5" style="opacity:1!important;pointer-events:auto!important;">
                    <h2 data-i18n="section5_documentation">ğŸ“„ SecÃ§Ã£o 5 - DocumentaÃ§Ã£o e IncidÃªncias</h2>
                    
                    <!-- Campo 62: IncidÃªncias da Reserva -->
                    <div class="reservas-form-group">
                        <label><span class="reservas-campo-num">R62</span> IncidÃªncias da Reserva:</label>
                        <div style="display: flex; gap: 10px;">
                            <textarea id="incidencias" rows="4" style="flex:1; width:100%; padding:10px 12px; border:2px solid #dee2e6; border-radius:8px; font-size:13px;" placeholder="Escreva a incidÃªncia..."></textarea>
                            <div style="display: flex; flex-direction: column; gap: 8px;">
                                <input type="file" id="anexo_inc" style="display:none;" multiple onchange="ficheiroInc(this)">
                                <button type="button" class="reservas-btn reservas-btn-orange" onclick="document.getElementById('anexo_inc').click()">ğŸ“ Anexar</button>
                                <button type="button" class="reservas-btn reservas-btn-orange" onclick="abrirInc()">ğŸ“‚ Abrir</button>
                                <button type="button" class="reservas-btn reservas-btn-green" onclick="guardarIncidencia()">ğŸ’¾ Guardar</button>
                            </div>
                        </div>
                        <div class="reservas-historico-box" id="historicoInc"><p style="color:#6c757d;font-style:italic;">Nenhuma incidÃªncia registada.</p></div>
                    </div>
                    
                    <!-- Campo 63: Anexos de Documentos -->
                    <div class="reservas-form-group">
                        <label><span class="reservas-campo-num">R63</span> Anexos de Documentos:</label>
                        <ul class="reservas-file-list">
                            <li>
                                <span>ğŸ“„</span>
                                <label style="flex:1;">CMR de Carga</label>
                                <input type="file" id="cmr_carga" style="display:none;" onchange="ficheiroAnexado(this,'CMR Carga')">
                                <button type="button" class="reservas-btn reservas-btn-orange" onclick="document.getElementById('cmr_carga').click()">ğŸ“ Anexar</button>
                                <button type="button" class="reservas-btn reservas-btn-orange" style="margin-left:5px;" onclick="abrirFicheiro('cmr_carga')">ğŸ“‚ Abrir</button>
                                <button type="button" class="reservas-btn" style="margin-left:5px; background:#dc3545; color:white;" onclick="apagarAnexo('cmr_carga', 'CMR de Carga')">ğŸ—‘ï¸ Apagar</button>
                            </li>
                            <li>
                                <span>ğŸ“„</span>
                                <label style="flex:1;">CMR de Descarga</label>
                                <input type="file" id="cmr_descarga" style="display:none;" onchange="ficheiroAnexado(this,'CMR Descarga')">
                                <button type="button" class="reservas-btn reservas-btn-orange" onclick="document.getElementById('cmr_descarga').click()">ğŸ“ Anexar</button>
                                <button type="button" class="reservas-btn reservas-btn-orange" style="margin-left:5px;" onclick="abrirFicheiro('cmr_descarga')">ğŸ“‚ Abrir</button>
                                <button type="button" class="reservas-btn" style="margin-left:5px; background:#dc3545; color:white;" onclick="apagarAnexo('cmr_descarga', 'CMR de Descarga')">ğŸ—‘ï¸ Apagar</button>
                            </li>
                            <li>
                                <span>ğŸ“·</span>
                                <label style="flex:1;">Fotos de Carga</label>
                                <input type="file" id="fotos_carga" style="display:none;" multiple accept="image/*" onchange="ficheiroAnexado(this,'Fotos Carga')">
                                <button type="button" class="reservas-btn reservas-btn-orange" onclick="document.getElementById('fotos_carga').click()">ğŸ“ Anexar</button>
                                <button type="button" class="reservas-btn reservas-btn-orange" style="margin-left:5px;" onclick="abrirFicheiro('fotos_carga')">ğŸ“‚ Abrir</button>
                                <button type="button" class="reservas-btn" style="margin-left:5px; background:#dc3545; color:white;" onclick="apagarAnexo('fotos_carga', 'Fotos de Carga')">ğŸ—‘ï¸ Apagar</button>
                            </li>
                            <li>
                                <span>ğŸ“·</span>
                                <label style="flex:1;">Fotos de Descarga</label>
                                <input type="file" id="fotos_descarga" style="display:none;" multiple accept="image/*" onchange="ficheiroAnexado(this,'Fotos Descarga')">
                                <button type="button" class="reservas-btn reservas-btn-orange" onclick="document.getElementById('fotos_descarga').click()">ğŸ“ Anexar</button>
                                <button type="button" class="reservas-btn reservas-btn-orange" style="margin-left:5px;" onclick="abrirFicheiro('fotos_descarga')">ğŸ“‚ Abrir</button>
                                <button type="button" class="reservas-btn" style="margin-left:5px; background:#dc3545; color:white;" onclick="apagarAnexo('fotos_descarga', 'Fotos de Descarga')">ğŸ—‘ï¸ Apagar</button>
                            </li>
                            <li>
                                <span>ğŸ“‹</span>
                                <label style="flex:1;">Ordem de Carga</label>
                                <input type="file" id="ordem_carga" style="display:none;" onchange="ficheiroAnexado(this,'Ordem Carga')">
                                <button type="button" class="reservas-btn reservas-btn-orange" onclick="document.getElementById('ordem_carga').click()">ğŸ“ Anexar</button>
                                <button type="button" class="reservas-btn reservas-btn-orange" style="margin-left:5px;" onclick="abrirFicheiro('ordem_carga')">ğŸ“‚ Abrir</button>
                                <button type="button" class="reservas-btn" style="margin-left:5px; background:#dc3545; color:white;" onclick="apagarAnexo('ordem_carga', 'Ordem de Carga')">ğŸ—‘ï¸ Apagar</button>
                                            </li>
                                        </ul>
                                        
                                        <!-- v6.31: BotÃ£o para limpar CMRs corrompidos -->
                                        <div style="margin-top: 15px; padding-top: 15px; border-top: 2px dashed #e2e8f0;">
                                            <button type="button" onclick="limparTodosCMRsStorage()" 
                                                style="background: linear-gradient(135deg, #ef4444, #b91c1c); color: white; border: none; padding: 10px 20px; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px;"
                                                title="Limpar TODOS os registos de CMR de TODAS as reservas. Use apenas se os dados estÃ£o corrompidos.">
                                                ğŸ§¹ Limpar Todos os CMRs (Corrigir Dados)
                                            </button>
                                            <p style="font-size: 11px; color: #64748b; margin-top: 8px; line-height: 1.4;">
                                                âš ï¸ Use apenas se os CMRs aparecem em reservas erradas.<br>
                                                Isto apaga TODOS os registos de ficheiros anexados.
                                            </p>
                                        </div>
                                    </div>
                                </section>

                <!-- SECÃ‡ÃƒO 6: SubcontrataÃ§Ã£o -->
                <section class="reservas-section-box" id="secao6">
                    <h2>ğŸ¤ SecÃ§Ã£o 6 - SubcontrataÃ§Ã£o</h2>
                    <div class="reservas-grid-2">
                        <div class="reservas-form-group"><label><span class="reservas-campo-num">R64</span> Transportador:</label><div class="reservas-input-group"><input type="text" id="transp_sub"><button type="button" class="reservas-btn reservas-btn-blue">ğŸ”</button></div></div>
                        <div class="reservas-form-group"><label><span class="reservas-campo-num">R65</span> NÂº Fornecedor:</label><input type="text" id="num_forn" readonly></div>
                    </div>
                    <div class="reservas-grid-3">
                        <div class="reservas-form-group"><label><span class="reservas-campo-num">R66</span> Trator (Sub):</label><div class="reservas-input-group"><input type="text" id="trator_sub"><button type="button" class="reservas-btn reservas-btn-blue">ğŸš›</button></div></div>
                        <div class="reservas-form-group"><label><span class="reservas-campo-num">R67</span> Reboque (Sub):</label><div class="reservas-input-group"><input type="text" id="reboque_sub"><button type="button" class="reservas-btn reservas-btn-blue">ğŸš›</button></div></div>
                        <div class="reservas-form-group"><label><span class="reservas-campo-num">R68</span> Motorista (Sub):</label><div class="reservas-input-group"><input type="text" id="motorista_sub"><button type="button" class="reservas-btn reservas-btn-blue">ğŸ‘¤</button></div></div>
                    </div>
                    <div class="reservas-grid-2">
                        <div class="reservas-form-group"><label><span class="reservas-campo-num">R69</span> Quem Contratou:</label><div class="reservas-input-group"><input type="text" id="quem_contratou"><button type="button" class="reservas-btn reservas-btn-orange" onclick="document.getElementById('quem_contratou').value='JoÃ£o Silva'">ğŸ‘¤</button></div></div>
                        <div class="reservas-form-group"><label><span class="reservas-campo-num">R70</span> PreÃ§o Acordado (â‚¬):</label><div class="reservas-input-group"><input type="number" id="preco_acordado" step="0.01"><button type="button" class="reservas-btn reservas-btn-orange" onclick="document.getElementById('preco_acordado').value=document.getElementById('preco').value">ğŸ’°</button></div></div>
                    </div>
                    
                    <!-- BOTÃ•ES CRIAR E ALTERAR RESERVA - DENTRO DA SECÃ‡ÃƒO 6 -->
                    <div style="display: flex; gap: 15px; margin-top: 25px; padding-top: 20px; border-top: 2px solid #dee2e6;">
                        <button type="submit" class="reservas-submit-btn" id="btnCriar" style="flex:1; margin:0;" data-i18n="create_booking">âœ“ Criar Reserva</button>
                        <button type="button" id="btnAlterar" onclick="alterarReserva()" style="flex:1; padding: 16px; background: linear-gradient(135deg, #ff6b35, #ff8c42); color: white; border: none; border-radius: 10px; font-size: 17px; font-weight: 700; cursor: pointer;" data-i18n="edit_booking">âœï¸ Alterar Reserva</button>
                        <button type="button" id="btnHistorico" onclick="mostrarHistoricoReserva()" style="flex:0.7; padding: 16px; background: linear-gradient(135deg, #6f42c1, #8969c7); color: white; border: none; border-radius: 10px; font-size: 17px; font-weight: 700; cursor: pointer;" title="Ver histÃ³rico de alteraÃ§Ãµes desta reserva">ğŸ“œ HistÃ³rico</button>
                    </div>
                </section>
            </form>
        </div>
      </div>
    </section>

    <!-- MODAIS DO MÃ“DULO RESERVAS -->
    
    <!-- Modal Mensagem Motorista -->
    <div class="reservas-modal-overlay" id="modalMsg">
        <div class="reservas-modal-content">
            <h3>ğŸ’¬ Mensagem para Motorista</h3>
            <div id="msgConteudo"></div>
            <div class="reservas-modal-buttons">
                <button style="background:linear-gradient(135deg,#11998e,#38ef7d);color:white;" onclick="enviarMsg(true)">âœ… Sim</button>
                <button style="background:linear-gradient(135deg,#e74c3c,#c0392b);color:white;" onclick="enviarMsg(false)">âŒ NÃ£o</button>
                <button style="background:#6c757d;color:white;" onclick="fecharModalReservas('modalMsg')">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Modal Etiquetas -->
    <div class="reservas-modal-overlay" id="modalEtiq">
        <div class="reservas-modal-content">
            <h3>ğŸ·ï¸ Etiquetas</h3>
            <div id="etiqConteudo" style="background:#f8f9fa;padding:15px;border-radius:8px;margin:15px 0;">
                <p><strong>NÂº Reserva:</strong> <span id="etiqNum">-</span></p>
                <p><strong>Origem:</strong> <span id="etiqOrig">-</span></p>
                <p><strong>Destino:</strong> <span id="etiqDest">-</span></p>
                <div id="etiqQR" style="margin-top:12px;text-align:center;"></div>
            </div>
            <div class="reservas-modal-buttons">
                <button style="background:linear-gradient(135deg,#11998e,#38ef7d);color:white;" onclick="alert('Etiquetas enviadas para impressÃ£o!');fecharModalReservas('modalEtiq')">ğŸ–¨ï¸ Imprimir</button>
                <button style="background:#6c757d;color:white;" onclick="fecharModalReservas('modalEtiq')">Fechar</button>
            </div>
        </div>
    </div>

    <!-- Modal Motivo Bloqueio Expandido -->
    <div class="reservas-modal-overlay" id="modalBloqueio">
        <div class="reservas-modal-content" style="max-width:700px;">
            <h3>âš ï¸ HistÃ³rico de Bloqueio do Cliente</h3>
            <div id="bloqueioConteudo" style="background:#fff3cd;padding:20px;border-radius:8px;margin:15px 0;max-height:400px;overflow-y:auto;border:2px solid #ffc107;">
                <p style="color:#856404;">Nenhum bloqueio registado.</p>
            </div>
            <div class="reservas-modal-buttons">
                <button style="background:#6c757d;color:white;" onclick="fecharModalReservas('modalBloqueio')">Fechar</button>
            </div>
        </div>
    </div>

    <!-- Modal Painel de Recolhas com GPS Frotcom -->
    <div class="reservas-modal-overlay" id="modalRecolhas" onclick="if(event.target===this)fecharModalReservas('modalRecolhas')">
        <div class="reservas-modal-content" style="max-width:95%; width:1200px; max-height:90vh; position:relative;">
            <button onclick="fecharModalReservas('modalRecolhas')" style="position:absolute; top:10px; right:15px; background:#e74c3c; color:white; border:none; width:35px; height:35px; border-radius:50%; font-size:20px; cursor:pointer; z-index:10;">&times;</button>
            <h3>ğŸ“¦ Painel de Recolhas Pendentes - GPS Frotcom</h3>
            <div style="display:grid; grid-template-columns: 350px 1fr; gap:20px; margin:15px 0;">
                <div style="background:#f8f9fa; border-radius:8px; padding:15px; max-height:500px; overflow-y:auto;">
                    <h4 style="margin-bottom:15px; color:#1e3c72;">ğŸ”´ Recolhas Sem CMR de Carga</h4>
                    <div id="listaRecolhasPendentes"></div>
                </div>
                <div style="background:#e9ecef; border-radius:8px; overflow:hidden; position:relative; height:500px;">
                    <div id="mapaRecolhas" style="width:100%; height:100%;"></div>
                    <div style="position:absolute; bottom:10px; left:10px; background:white; padding:10px; border-radius:6px; font-size:11px; box-shadow:0 2px 10px rgba(0,0,0,0.2);">
                        <strong>Legenda:</strong><br>
                        ğŸ”´ Recolha Pendente<br>
                        ğŸš› Viatura (com matrÃ­cula)
                    </div>
                </div>
            </div>
            <div class="reservas-modal-buttons" style="margin-top:15px;">
                <button style="background:#6c757d;color:white;padding:12px 30px;border:none;border-radius:8px;font-weight:bold;cursor:pointer;" onclick="fecharModalReservas('modalRecolhas')">Fechar</button>
            </div>
        </div>
    </div>

    <!-- Modal Ler Ordem de Carga (v6.13 - OCR) -->
    <div class="reservas-modal-overlay" id="modalOrdemCarga" onclick="if(event.target===this)fecharModalReservas('modalOrdemCarga')">
        <div class="reservas-modal-content" style="max-width:95%; width:1000px; max-height:90vh; position:relative; overflow-y:auto;">
            <button onclick="fecharModalReservas('modalOrdemCarga')" style="position:absolute; top:10px; right:15px; background:#e74c3c; color:white; border:none; width:35px; height:35px; border-radius:50%; font-size:20px; cursor:pointer; z-index:10;">&times;</button>
            <h3>ğŸ“„ Ler Ordem de Carga <span style="font-size:12px;background:#667eea;color:white;padding:3px 10px;border-radius:12px;margin-left:10px;">OCR AutomÃ¡tico</span></h3>
            
            <!-- Zona de Upload -->
            <div id="zonaUploadOrdem" style="border:3px dashed #667eea; border-radius:12px; padding:40px; text-align:center; margin:20px 0; background:#f8f9ff; cursor:pointer; transition:all 0.3s;" onclick="document.getElementById('inputOrdemCarga').click()" ondragover="event.preventDefault();this.style.background='#e8edff';this.style.borderColor='#4285f4';" ondragleave="this.style.background='#f8f9ff';this.style.borderColor='#667eea';" ondrop="handleDropOrdemCarga(event)">
                <input type="file" id="inputOrdemCarga" accept=".pdf,.png,.jpg,.jpeg,.gif,.bmp,.webp" style="display:none;" onchange="processarOrdemCarga(this.files[0])">
                <div style="font-size:50px; margin-bottom:15px;">ğŸ“¤</div>
                <div style="font-size:18px; font-weight:bold; color:#667eea; margin-bottom:10px;">Arraste o ficheiro aqui ou clique para selecionar</div>
                <div style="font-size:14px; color:#666;">Formatos aceites: PDF, PNG, JPG, JPEG, GIF, BMP, WEBP</div>
                <div style="font-size:12px; color:#999; margin-top:10px;">Tamanho mÃ¡ximo: 10 MB</div>
            </div>
            
            <!-- Barra de Progresso -->
            <div id="progressoOrdemCarga" style="display:none; margin:20px 0;">
                <div style="display:flex; align-items:center; gap:15px; margin-bottom:10px;">
                    <div class="spinner" style="width:24px; height:24px; border:3px solid #e9ecef; border-top-color:#667eea; border-radius:50%; animation:spin 1s linear infinite;"></div>
                    <span id="statusOrdemCarga" style="font-size:14px; color:#667eea;">A processar documento...</span>
                </div>
                <div style="background:#e9ecef; border-radius:10px; height:20px; overflow:hidden;">
                    <div id="barraProgressoOrdem" style="background:linear-gradient(135deg,#667eea,#764ba2); height:100%; width:0%; transition:width 0.3s; border-radius:10px;"></div>
                </div>
                <style>@keyframes spin { to { transform: rotate(360deg); } }</style>
            </div>
            
            <!-- Preview do Documento -->
            <div id="previewOrdemCarga" style="display:none; margin:20px 0;">
                <h4 style="color:#1e3c72; margin-bottom:10px;">ğŸ“‹ Preview do Documento</h4>
                <div id="previewContainer" style="max-height:200px; overflow:auto; border:1px solid #ddd; border-radius:8px; padding:10px; background:white;">
                </div>
            </div>
            
            <!-- Texto ExtraÃ­do -->
            <div id="textoExtraidoContainer" style="display:none; margin:20px 0;">
                <h4 style="color:#1e3c72; margin-bottom:10px;">ğŸ“ Texto ExtraÃ­do <span style="font-size:12px; color:#666;">(pode editar se necessÃ¡rio)</span></h4>
                <textarea id="textoExtraido" style="width:100%; height:150px; padding:12px; border:2px solid #ddd; border-radius:8px; font-family:monospace; font-size:12px; resize:vertical;"></textarea>
                <button onclick="reprocessarTexto()" style="margin-top:10px; background:#f39c12; color:white; padding:8px 20px; border:none; border-radius:6px; cursor:pointer; font-weight:bold;">ğŸ”„ Reprocessar Texto</button>
            </div>
            
            <!-- Campos Identificados -->
            <div id="camposIdentificados" style="display:none; margin:20px 0;">
                <h4 style="color:#27ae60; margin-bottom:15px;">âœ… Campos Identificados</h4>
                <div style="display:grid; grid-template-columns: repeat(2, 1fr); gap:15px;">
                    <!-- Coluna 1 - Dados Gerais e Carga -->
                    <div style="background:#f8f9fa; padding:15px; border-radius:8px;">
                        <h5 style="color:#1e3c72; margin-bottom:12px; border-bottom:2px solid #667eea; padding-bottom:5px;">ğŸ“‹ Dados Gerais</h5>
                        <div class="campo-identificado" style="margin-bottom:8px;">
                            <label style="font-size:12px; color:#666; display:block;">Cliente (R4):</label>
                            <input type="text" id="ocr_cliente" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:5px; font-size:13px;">
                        </div>
                        <div class="campo-identificado" style="margin-bottom:8px;">
                            <label style="font-size:12px; color:#666; display:block;">ReferÃªncia:</label>
                            <input type="text" id="ocr_referencia" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:5px; font-size:13px;">
                        </div>
                        <div class="campo-identificado" style="margin-bottom:8px;">
                            <label style="font-size:12px; color:#666; display:block;">LDM (R16):</label>
                            <input type="text" id="ocr_ldm" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:5px; font-size:13px;">
                        </div>
                        <div class="campo-identificado" style="margin-bottom:8px;">
                            <label style="font-size:12px; color:#666; display:block;">NÂº Bultos (R17):</label>
                            <input type="text" id="ocr_bultos" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:5px; font-size:13px;">
                        </div>
                        <div class="campo-identificado" style="margin-bottom:8px;">
                            <label style="font-size:12px; color:#666; display:block;">Peso (R18):</label>
                            <input type="text" id="ocr_peso" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:5px; font-size:13px;">
                        </div>
                        
                        <h5 style="color:#1e3c72; margin:15px 0 12px 0; border-bottom:2px solid #27ae60; padding-bottom:5px;">ğŸšš Local de Carga</h5>
                        <div class="campo-identificado" style="margin-bottom:8px;">
                            <label style="font-size:12px; color:#666; display:block;">Empresa Carga (R26):</label>
                            <input type="text" id="ocr_empresa_carga" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:5px; font-size:13px;">
                        </div>
                        <div class="campo-identificado" style="margin-bottom:8px;">
                            <label style="font-size:12px; color:#666; display:block;">Morada Carga:</label>
                            <input type="text" id="ocr_morada_carga" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:5px; font-size:13px;">
                        </div>
                        <div class="campo-identificado" style="margin-bottom:8px;">
                            <label style="font-size:12px; color:#666; display:block;">CP Carga (R31):</label>
                            <input type="text" id="ocr_cp_carga" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:5px; font-size:13px;">
                        </div>
                        <div class="campo-identificado" style="margin-bottom:8px;">
                            <label style="font-size:12px; color:#666; display:block;">Cidade Carga (R32):</label>
                            <input type="text" id="ocr_cidade_carga" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:5px; font-size:13px;">
                        </div>
                        <div class="campo-identificado" style="margin-bottom:8px;">
                            <label style="font-size:12px; color:#666; display:block;">Data Carga (R40):</label>
                            <input type="date" id="ocr_data_carga" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:5px; font-size:13px;">
                        </div>
                        <div class="campo-identificado" style="margin-bottom:8px;">
                            <label style="font-size:12px; color:#666; display:block;">Hora Carga (R41):</label>
                            <input type="time" id="ocr_hora_carga" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:5px; font-size:13px;">
                        </div>
                    </div>
                    
                    <!-- Coluna 2 - Descarga -->
                    <div style="background:#f8f9fa; padding:15px; border-radius:8px;">
                        <h5 style="color:#1e3c72; margin-bottom:12px; border-bottom:2px solid #e67e22; padding-bottom:5px;">ğŸ“ Local de Descarga</h5>
                        <div class="campo-identificado" style="margin-bottom:8px;">
                            <label style="font-size:12px; color:#666; display:block;">Empresa Descarga (R45):</label>
                            <input type="text" id="ocr_empresa_descarga" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:5px; font-size:13px;">
                        </div>
                        <div class="campo-identificado" style="margin-bottom:8px;">
                            <label style="font-size:12px; color:#666; display:block;">Morada Descarga:</label>
                            <input type="text" id="ocr_morada_descarga" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:5px; font-size:13px;">
                        </div>
                        <div class="campo-identificado" style="margin-bottom:8px;">
                            <label style="font-size:12px; color:#666; display:block;">CP Descarga (R50):</label>
                            <input type="text" id="ocr_cp_descarga" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:5px; font-size:13px;">
                        </div>
                        <div class="campo-identificado" style="margin-bottom:8px;">
                            <label style="font-size:12px; color:#666; display:block;">Cidade Descarga (R51):</label>
                            <input type="text" id="ocr_cidade_descarga" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:5px; font-size:13px;">
                        </div>
                        <div class="campo-identificado" style="margin-bottom:8px;">
                            <label style="font-size:12px; color:#666; display:block;">PaÃ­s Descarga (R53):</label>
                            <input type="text" id="ocr_pais_descarga" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:5px; font-size:13px;">
                        </div>
                        <div class="campo-identificado" style="margin-bottom:8px;">
                            <label style="font-size:12px; color:#666; display:block;">Data Descarga (R59):</label>
                            <input type="date" id="ocr_data_descarga" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:5px; font-size:13px;">
                        </div>
                        <div class="campo-identificado" style="margin-bottom:8px;">
                            <label style="font-size:12px; color:#666; display:block;">Hora Descarga (R60):</label>
                            <input type="time" id="ocr_hora_descarga" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:5px; font-size:13px;">
                        </div>
                        
                        <h5 style="color:#1e3c72; margin:15px 0 12px 0; border-bottom:2px solid #9b59b6; padding-bottom:5px;">ğŸ“ ObservaÃ§Ãµes</h5>
                        <div class="campo-identificado">
                            <label style="font-size:12px; color:#666; display:block;">ObservaÃ§Ãµes (R68):</label>
                            <textarea id="ocr_observacoes" style="width:100%; height:80px; padding:8px; border:1px solid #ddd; border-radius:5px; font-size:13px; resize:vertical;"></textarea>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- BotÃµes de AÃ§Ã£o -->
            <div class="reservas-modal-buttons" style="margin-top:20px; display:flex; gap:10px; justify-content:center; flex-wrap:wrap;">
                <button id="btnPreencherReserva" onclick="preencherReservaComOCR()" style="display:none; background:linear-gradient(135deg,#27ae60,#2ecc71); color:white; padding:14px 30px; border:none; border-radius:8px; font-weight:bold; cursor:pointer; font-size:15px;">
                    âœ… PREENCHER RESERVA
                </button>
                <button onclick="limparOrdemCarga()" style="background:#f39c12; color:white; padding:12px 25px; border:none; border-radius:8px; font-weight:bold; cursor:pointer;">
                    ğŸ—‘ï¸ Limpar
                </button>
                <button onclick="fecharModalReservas('modalOrdemCarga')" style="background:#6c757d; color:white; padding:12px 25px; border:none; border-radius:8px; font-weight:bold; cursor:pointer;">
                    Fechar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Ver Local de Carga (v6.13 - Google Maps) -->
    <div class="reservas-modal-overlay" id="modalLocalCarga" onclick="if(event.target===this)fecharModalReservas('modalLocalCarga')">
        <div class="reservas-modal-content" style="max-width:95%; width:1100px; max-height:90vh; position:relative;">
            <button onclick="fecharModalReservas('modalLocalCarga')" style="position:absolute; top:10px; right:15px; background:#e74c3c; color:white; border:none; width:35px; height:35px; border-radius:50%; font-size:20px; cursor:pointer; z-index:10;">&times;</button>
            <h3>ğŸšš Pesquisar Local de Carga <span style="font-size:12px;background:#4285f4;color:white;padding:3px 10px;border-radius:12px;margin-left:10px;">Google Maps</span></h3>
            
            <!-- Motor de Busca -->
            <div style="background:#f8f9fa; padding:15px; border-radius:8px; margin-bottom:15px;">
                <div style="display:flex; gap:10px; align-items:center;">
                    <input type="text" id="pesquisaLocalCarga" placeholder="Digite o nome da empresa (ex: Nervacero, Continente, IKEA...)" style="flex:1; padding:12px 15px; border:2px solid #ddd; border-radius:8px; font-size:14px;">
                    <select id="paisPesquisaCarga" style="padding:12px; border:2px solid #ddd; border-radius:8px; font-size:14px;">
                        <option value="pt">ğŸ‡µğŸ‡¹ Portugal</option>
                        <option value="es">ğŸ‡ªğŸ‡¸ Espanha</option>
                        <option value="fr">ğŸ‡«ğŸ‡· FranÃ§a</option>
                        <option value="de">ğŸ‡©ğŸ‡ª Alemanha</option>
                        <option value="it">ğŸ‡®ğŸ‡¹ ItÃ¡lia</option>
                        <option value="nl">ğŸ‡³ğŸ‡± Holanda</option>
                        <option value="be">ğŸ‡§ğŸ‡ª BÃ©lgica</option>
                        <option value="">ğŸŒ Todos</option>
                    </select>
                    <button onclick="pesquisarLocalMapa('carga')" style="background:linear-gradient(135deg,#4285f4,#34a853); color:white; padding:12px 25px; border:none; border-radius:8px; font-weight:bold; cursor:pointer; display:flex; align-items:center; gap:8px;">
                        ğŸ” Pesquisar
                    </button>
                </div>
                <div id="statusPesquisaCarga" style="margin-top:10px; font-size:13px; color:#666;"></div>
            </div>
            
            <div style="display:grid; grid-template-columns: 1fr 350px; gap:20px;">
                <!-- Mapa -->
                <div style="background:#e9ecef; border-radius:8px; overflow:hidden; position:relative; height:450px;">
                    <!-- Controlos de tipo de mapa -->
                    <div style="position:absolute; top:10px; right:10px; z-index:1000; display:flex; gap:5px; background:white; padding:5px; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.2);">
                        <button onclick="alterarTipoMapa('carga', 'mapa')" id="btnMapaCarga_mapa" style="padding:6px 12px; border:none; border-radius:5px; cursor:pointer; font-size:12px; font-weight:bold; background:#4285f4; color:white;" title="Mapa">ğŸ—ºï¸ Mapa</button>
                        <button onclick="alterarTipoMapa('carga', 'satelite')" id="btnMapaCarga_satelite" style="padding:6px 12px; border:none; border-radius:5px; cursor:pointer; font-size:12px; font-weight:bold; background:#e9ecef; color:#333;" title="SatÃ©lite">ğŸ›°ï¸ SatÃ©lite</button>
                        <button onclick="alterarTipoMapa('carga', 'terreno')" id="btnMapaCarga_terreno" style="padding:6px 12px; border:none; border-radius:5px; cursor:pointer; font-size:12px; font-weight:bold; background:#e9ecef; color:#333;" title="Terreno">ğŸ”ï¸ Terreno</button>
                        <button onclick="alterarTipoMapa('carga', 'hibrido')" id="btnMapaCarga_hibrido" style="padding:6px 12px; border:none; border-radius:5px; cursor:pointer; font-size:12px; font-weight:bold; background:#e9ecef; color:#333;" title="HÃ­brido">ğŸŒ HÃ­brido</button>
                    </div>
                    <div id="mapaLocalCarga" style="width:100%; height:100%;"></div>
                </div>
                
                <!-- Resultados e Detalhes -->
                <div style="display:flex; flex-direction:column; gap:15px;">
                    <!-- Lista de Resultados -->
                    <div style="background:#f8f9fa; border-radius:8px; padding:15px; max-height:200px; overflow-y:auto;">
                        <h4 style="margin-bottom:10px; color:#1e3c72; font-size:14px;">ğŸ“‹ Resultados da Pesquisa</h4>
                        <div id="resultadosPesquisaCarga" style="font-size:13px;">
                            <p style="color:#999; text-align:center; padding:20px;">Pesquise uma empresa para ver resultados</p>
                        </div>
                    </div>
                    
                    <!-- Detalhes do Local Selecionado -->
                    <div style="background:white; border-radius:8px; padding:15px; border:2px solid #27ae60; flex:1;">
                        <h4 style="margin-bottom:10px; color:#27ae60; font-size:14px;">âœ… Local Selecionado</h4>
                        <div id="detalheLocalCarga" style="font-size:13px;">
                            <p style="color:#999;">Nenhum local selecionado</p>
                        </div>
                        <button id="btnPreencherCarga" onclick="preencherFormularioCarga()" style="display:none; width:100%; margin-top:15px; background:linear-gradient(135deg,#27ae60,#2ecc71); color:white; padding:12px; border:none; border-radius:8px; font-weight:bold; cursor:pointer; font-size:14px;">
                            ğŸ“ PREENCHER FORMULÃRIO (R26-R34)
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="reservas-modal-buttons" style="margin-top:15px;">
                <button style="background:#6c757d;color:white;padding:12px 30px;border:none;border-radius:8px;font-weight:bold;cursor:pointer;" onclick="fecharModalReservas('modalLocalCarga')">Fechar</button>
            </div>
        </div>
    </div>

    <!-- Modal Ver Local de Descarga (v6.13 - Google Maps) -->
    <div class="reservas-modal-overlay" id="modalLocalDescarga" onclick="if(event.target===this)fecharModalReservas('modalLocalDescarga')">
        <div class="reservas-modal-content" style="max-width:95%; width:1100px; max-height:90vh; position:relative;">
            <button onclick="fecharModalReservas('modalLocalDescarga')" style="position:absolute; top:10px; right:15px; background:#e74c3c; color:white; border:none; width:35px; height:35px; border-radius:50%; font-size:20px; cursor:pointer; z-index:10;">&times;</button>
            <h3>ğŸ“ Pesquisar Local de Descarga <span style="font-size:12px;background:#4285f4;color:white;padding:3px 10px;border-radius:12px;margin-left:10px;">Google Maps</span></h3>
            
            <!-- Motor de Busca -->
            <div style="background:#f8f9fa; padding:15px; border-radius:8px; margin-bottom:15px;">
                <div style="display:flex; gap:10px; align-items:center;">
                    <input type="text" id="pesquisaLocalDescarga" placeholder="Digite o nome da empresa (ex: Nervacero, Worten, Amazon...)" style="flex:1; padding:12px 15px; border:2px solid #ddd; border-radius:8px; font-size:14px;">
                    <select id="paisPesquisaDescarga" style="padding:12px; border:2px solid #ddd; border-radius:8px; font-size:14px;">
                        <option value="pt">ğŸ‡µğŸ‡¹ Portugal</option>
                        <option value="es">ğŸ‡ªğŸ‡¸ Espanha</option>
                        <option value="fr">ğŸ‡«ğŸ‡· FranÃ§a</option>
                        <option value="de">ğŸ‡©ğŸ‡ª Alemanha</option>
                        <option value="it">ğŸ‡®ğŸ‡¹ ItÃ¡lia</option>
                        <option value="nl">ğŸ‡³ğŸ‡± Holanda</option>
                        <option value="be">ğŸ‡§ğŸ‡ª BÃ©lgica</option>
                        <option value="">ğŸŒ Todos</option>
                    </select>
                    <button onclick="pesquisarLocalMapa('descarga')" style="background:linear-gradient(135deg,#4285f4,#34a853); color:white; padding:12px 25px; border:none; border-radius:8px; font-weight:bold; cursor:pointer; display:flex; align-items:center; gap:8px;">
                        ğŸ” Pesquisar
                    </button>
                </div>
                <div id="statusPesquisaDescarga" style="margin-top:10px; font-size:13px; color:#666;"></div>
            </div>
            
            <div style="display:grid; grid-template-columns: 1fr 350px; gap:20px;">
                <!-- Mapa -->
                <div style="background:#e9ecef; border-radius:8px; overflow:hidden; position:relative; height:450px;">
                    <!-- Controlos de tipo de mapa -->
                    <div style="position:absolute; top:10px; right:10px; z-index:1000; display:flex; gap:5px; background:white; padding:5px; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.2);">
                        <button onclick="alterarTipoMapa('descarga', 'mapa')" id="btnMapaDescarga_mapa" style="padding:6px 12px; border:none; border-radius:5px; cursor:pointer; font-size:12px; font-weight:bold; background:#4285f4; color:white;" title="Mapa">ğŸ—ºï¸ Mapa</button>
                        <button onclick="alterarTipoMapa('descarga', 'satelite')" id="btnMapaDescarga_satelite" style="padding:6px 12px; border:none; border-radius:5px; cursor:pointer; font-size:12px; font-weight:bold; background:#e9ecef; color:#333;" title="SatÃ©lite">ğŸ›°ï¸ SatÃ©lite</button>
                        <button onclick="alterarTipoMapa('descarga', 'terreno')" id="btnMapaDescarga_terreno" style="padding:6px 12px; border:none; border-radius:5px; cursor:pointer; font-size:12px; font-weight:bold; background:#e9ecef; color:#333;" title="Terreno">ğŸ”ï¸ Terreno</button>
                        <button onclick="alterarTipoMapa('descarga', 'hibrido')" id="btnMapaDescarga_hibrido" style="padding:6px 12px; border:none; border-radius:5px; cursor:pointer; font-size:12px; font-weight:bold; background:#e9ecef; color:#333;" title="HÃ­brido">ğŸŒ HÃ­brido</button>
                    </div>
                    <div id="mapaLocalDescarga" style="width:100%; height:100%;"></div>
                </div>
                
                <!-- Resultados e Detalhes -->
                <div style="display:flex; flex-direction:column; gap:15px;">
                    <!-- Lista de Resultados -->
                    <div style="background:#f8f9fa; border-radius:8px; padding:15px; max-height:200px; overflow-y:auto;">
                        <h4 style="margin-bottom:10px; color:#1e3c72; font-size:14px;">ğŸ“‹ Resultados da Pesquisa</h4>
                        <div id="resultadosPesquisaDescarga" style="font-size:13px;">
                            <p style="color:#999; text-align:center; padding:20px;">Pesquise uma empresa para ver resultados</p>
                        </div>
                    </div>
                    
                    <!-- Detalhes do Local Selecionado -->
                    <div style="background:white; border-radius:8px; padding:15px; border:2px solid #e67e22; flex:1;">
                        <h4 style="margin-bottom:10px; color:#e67e22; font-size:14px;">âœ… Local Selecionado</h4>
                        <div id="detalheLocalDescarga" style="font-size:13px;">
                            <p style="color:#999;">Nenhum local selecionado</p>
                        </div>
                        <button id="btnPreencherDescarga" onclick="preencherFormularioDescarga()" style="display:none; width:100%; margin-top:15px; background:linear-gradient(135deg,#e67e22,#f39c12); color:white; padding:12px; border:none; border-radius:8px; font-weight:bold; cursor:pointer; font-size:14px;">
                            ğŸ“ PREENCHER FORMULÃRIO (R45-R53)
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="reservas-modal-buttons" style="margin-top:15px;">
                <button style="background:#6c757d;color:white;padding:12px 30px;border:none;border-radius:8px;font-weight:bold;cursor:pointer;" onclick="fecharModalReservas('modalLocalDescarga')">Fechar</button>
            </div>
        </div>
    </div>

    <!-- Modal Ver Mapa Rota com HERE Maps + GPS Frotcom -->
    <div class="reservas-modal-overlay" id="modalMapaRota" onclick="if(event.target===this)fecharModalReservas('modalMapaRota')">
        <div class="reservas-modal-content" style="max-width:95%; width:1200px; max-height:90vh; position:relative;">
            <button onclick="fecharModalReservas('modalMapaRota')" style="position:absolute; top:10px; right:15px; background:#e74c3c; color:white; border:none; width:35px; height:35px; border-radius:50%; font-size:20px; cursor:pointer; z-index:10;">&times;</button>
            <h3>ğŸ—ºï¸ Rota Carga â†’ Descarga <span id="rotaFonteIndicador" style="font-size:12px;background:#667eea;color:white;padding:3px 10px;border-radius:12px;margin-left:10px;">HERE Maps</span></h3>
            <div style="display:grid; grid-template-columns: 1fr 320px; gap:20px; margin:15px 0;">
                <div style="background:#e9ecef; border-radius:8px; overflow:hidden; position:relative; height:480px;">
                    <div id="mapaRota" style="width:100%; height:100%;"></div>
                    <!-- Indicador de trÃ¢nsito -->
                    <div id="rotaTransitoIndicador" style="position:absolute;bottom:10px;left:10px;background:rgba(255,255,255,0.95);padding:8px 15px;border-radius:8px;font-size:12px;display:none;">
                        ğŸš¦ <span id="rotaTransitoTexto">TrÃ¢nsito normal</span>
                    </div>
                </div>
                <div style="background:#f8f9fa; border-radius:8px; padding:20px;">
                    <h4 style="margin-bottom:15px; color:#1e3c72; border-bottom:2px solid #667eea; padding-bottom:10px;">ğŸ“Š Detalhes da Rota</h4>
                    <div style="margin-bottom:15px;"><label style="font-size:11px; color:#6c757d;">ORIGEM</label><div id="rotaOrigem" style="font-weight:bold; font-size:13px; color:#27ae60;">-</div></div>
                    <div style="margin-bottom:15px;"><label style="font-size:11px; color:#6c757d;">DESTINO</label><div id="rotaDestino" style="font-weight:bold; font-size:13px; color:#e74c3c;">-</div></div>
                    <div style="background:white; border-radius:8px; padding:12px; margin-bottom:10px; border-left:4px solid #667eea;"><label style="font-size:10px; color:#6c757d;">DISTÃ‚NCIA</label><div id="rotaDistancia" style="font-size:22px; font-weight:bold; color:#1e3c72;">- km</div></div>
                    <div style="background:white; border-radius:8px; padding:12px; margin-bottom:10px; border-left:4px solid #27ae60;"><label style="font-size:10px; color:#6c757d;">TEMPO ESTIMADO</label><div id="rotaTempo" style="font-size:22px; font-weight:bold; color:#27ae60;">-</div></div>
                    <div style="background:white; border-radius:8px; padding:12px; margin-bottom:10px; border-left:4px solid #f39c12;"><label style="font-size:10px; color:#6c757d;">PORTAGENS</label><div id="rotaPortagens" style="font-size:22px; font-weight:bold; color:#f39c12;">- â‚¬</div></div>
                    <div style="background:white; border-radius:8px; padding:12px; margin-bottom:10px; border-left:4px solid #e74c3c;"><label style="font-size:10px; color:#6c757d;">COMBUSTÃVEL (32L/100km)</label><div id="rotaCombustivel" style="font-size:22px; font-weight:bold; color:#e74c3c;">- â‚¬</div></div>
                    <div style="background:#1e3c72; color:white; border-radius:8px; padding:12px; text-align:center;"><label style="font-size:10px; opacity:0.8;">CUSTO TOTAL ESTIMADO</label><div id="rotaCustoTotal" style="font-size:26px; font-weight:bold;">- â‚¬</div></div>
                    
                    <!-- SecÃ§Ã£o Frotcom GPS -->
                    <div style="margin-top:15px; padding-top:15px; border-top:2px dashed #dee2e6;">
                        <h5 style="margin-bottom:10px; color:#1e3c72; font-size:13px;">ğŸ“¡ GPS Frotcom</h5>
                        <div id="frotcomVeiculoAtribuido" style="background:white; border-radius:8px; padding:10px; font-size:12px; color:#666;">
                            Nenhum veÃ­culo atribuÃ­do
                        </div>
                        <button onclick="abrirSelecionarVeiculoFrotcom()" style="width:100%;margin-top:10px;padding:10px;background:#17a2b8;color:white;border:none;border-radius:6px;font-weight:bold;cursor:pointer;font-size:12px;">
                            ğŸš› Selecionar VeÃ­culo
                        </button>
                        <button id="btnEnviarRotaGPS" onclick="enviarRotaParaGPS()" style="width:100%;margin-top:8px;padding:10px;background:#28a745;color:white;border:none;border-radius:6px;font-weight:bold;cursor:pointer;font-size:12px;display:none;">
                            ğŸ“² Enviar Rota para GPS
                        </button>
                    </div>
                </div>
            </div>
            <div class="reservas-modal-buttons" style="margin-top:15px; display:flex; gap:10px; flex-wrap:wrap;">
                <button style="background:#27ae60;color:white;padding:12px 25px;border:none;border-radius:8px;font-weight:bold;cursor:pointer;" onclick="exportarRotaPDF()">ğŸ“„ Exportar PDF</button>
                <button style="background:#3498db;color:white;padding:12px 25px;border:none;border-radius:8px;font-weight:bold;cursor:pointer;" onclick="recalcularRota()">ğŸ”„ Recalcular</button>
                <button style="background:#6c757d;color:white;padding:12px 25px;border:none;border-radius:8px;font-weight:bold;cursor:pointer;" onclick="fecharModalReservas('modalMapaRota')">Fechar</button>
            </div>
        </div>
    </div>

    <!-- Modal Selecionar Motorista -->
    <div class="reservas-modal-overlay" id="modalMotorista" onclick="if(event.target===this)fecharModalReservas('modalMotorista')">
        <div class="reservas-modal-content" style="max-width:600px; position:relative;">
            <button onclick="fecharModalReservas('modalMotorista')" style="position:absolute; top:10px; right:15px; background:#e74c3c; color:white; border:none; width:35px; height:35px; border-radius:50%; font-size:20px; cursor:pointer; z-index:10;">&times;</button>
            <h3>ğŸ‘¤ Selecionar Motorista</h3>
            <div style="margin:15px 0;">
                <input type="text" id="pesquisaMotorista" placeholder="ğŸ” Pesquisar motorista..." style="width:100%; padding:12px; border:2px solid #dee2e6; border-radius:8px; font-size:14px;" oninput="filtrarMotoristas()">
            </div>
            <div id="listaMotoristas" style="max-height:350px; overflow-y:auto;"></div>
        </div>
    </div>

    <!-- Modal Selecionar Trator -->
    <div class="reservas-modal-overlay" id="modalTrator" onclick="if(event.target===this)fecharModalReservas('modalTrator')">
        <div class="reservas-modal-content" style="max-width:600px; position:relative;">
            <button onclick="fecharModalReservas('modalTrator')" style="position:absolute; top:10px; right:15px; background:#e74c3c; color:white; border:none; width:35px; height:35px; border-radius:50%; font-size:20px; cursor:pointer; z-index:10;">&times;</button>
            <h3>ğŸš› Selecionar Trator</h3>
            <div style="margin:15px 0;">
                <input type="text" id="pesquisaTrator" placeholder="ğŸ” Pesquisar matrÃ­cula..." style="width:100%; padding:12px; border:2px solid #dee2e6; border-radius:8px; font-size:14px;" oninput="filtrarTratores()">
            </div>
            <div id="listaTratores" style="max-height:350px; overflow-y:auto;"></div>
        </div>
    </div>

    <!-- Modal Selecionar Reboque -->
    <div class="reservas-modal-overlay" id="modalReboque" onclick="if(event.target===this)fecharModalReservas('modalReboque')">
        <div class="reservas-modal-content" style="max-width:600px; position:relative;">
            <button onclick="fecharModalReservas('modalReboque')" style="position:absolute; top:10px; right:15px; background:#e74c3c; color:white; border:none; width:35px; height:35px; border-radius:50%; font-size:20px; cursor:pointer; z-index:10;">&times;</button>
            <h3>ğŸš› Selecionar Reboque</h3>
            <div style="margin:15px 0;">
                <input type="text" id="pesquisaReboque" placeholder="ğŸ” Pesquisar matrÃ­cula..." style="width:100%; padding:12px; border:2px solid #dee2e6; border-radius:8px; font-size:14px;" oninput="filtrarReboques()">
            </div>
            <div id="listaReboques" style="max-height:350px; overflow-y:auto;"></div>
        </div>
    </div>

    <!-- PAGE: AGENDA 1 -->
    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <!-- ğŸ“… PAGE: AGENDA 1 - MÃ“DULO INTEGRADO v5.2 (LAYOUT ORIGINAL v29 COMPLETO)         -->
    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <section id="page-agenda1" class="hidden">
      <div class="agenda1-wrapper">
<!-- CabeÃ§alho -->
  <div class="bg-[#1e3a5f] text-white px-4 py-1 flex items-center justify-between flex-shrink-0">
    <h1 class="text-sm font-bold tracking-wide" data-i18n="agenda1_header">AGENDA 1</h1>
    <div class="flex items-center gap-4 text-xs">
      <span><span data-i18n="groupings">Grupagens</span>: <strong id="agenda1CountGrupagens">0</strong></span>
      <span><span data-i18n="direct_loads">Cargas Diretas</span>: <strong id="agenda1CountDiretas">0</strong></span>
      <span id="agenda1ZoomLevel" class="bg-white/20 px-2 py-0.5 rounded">100%</span>
    </div>
  </div>

  <!-- Filtros -->
  <div class="bg-white border-b border-slate-300 px-3 py-1.5 flex items-center gap-3 flex-shrink-0">
    <select id="agenda1FilterEstado" title="A1-1 Filtro Estado" onchange="agenda1RenderTable()" class="text-xs px-2 py-1 border border-slate-300 rounded bg-white">
      <option value="" data-i18n="status_all">Estado: Todos</option>
      <option value="No Cliente">No Cliente</option>
      <option value="Em TrÃ¢nsito">Em TrÃ¢nsito</option>
      <option value="Entregue">Entregue</option>
      <option value="Cancelada">Cancelada</option>
    </select>
    <select id="agenda1FilterPrioridade" title="A1-2 Filtro Prioridade" onchange="agenda1RenderTable()" class="text-xs px-2 py-1 border border-slate-300 rounded bg-white">
      <option value="">Prioridade: Todas</option>
      <option value="Baixa">Baixa</option>
      <option value="Normal">Normal</option>
      <option value="Alta">Alta</option>
      <option value="Urgente">Urgente</option>
    </select>
    <div class="flex-1 max-w-md">
      <input type="text" id="agenda1SearchInput" title="A1-3 Pesquisa" placeholder="ğŸ” Pesquisar..." oninput="agenda1RenderTable()" class="w-full text-xs px-2 py-1 border border-slate-300 rounded">
    </div>
    <div id="agenda1CountDisplay" class="text-xs text-slate-600 bg-slate-100 px-2 py-1 rounded">0 reservas</div>
    <div id="agenda1SelectedCount" class="text-xs text-blue-600 bg-blue-50 px-2 py-1 rounded hidden">0 selecionadas</div>
  </div>

  <!-- Barra de AÃ§Ãµes -->
  <div class="bg-slate-50 border-b border-slate-300 px-3 py-1 flex items-center gap-2 flex-shrink-0 flex-wrap">
    <button onclick="agenda1SelectAll()" class="text-xs bg-slate-200 hover:bg-slate-300 px-2 py-1 rounded" data-i18n="select_all">â˜‘ Selec. Todas</button>
    <button onclick="agenda1DeselectAll()" class="text-xs bg-slate-200 hover:bg-slate-300 px-2 py-1 rounded" data-i18n="clear_selection">â˜ Limpar</button>
    <div class="border-l border-slate-300 h-4 mx-1"></div>
    <button onclick="agenda1InserirLinhaEmBranco()" class="text-xs bg-slate-200 hover:bg-slate-300 px-2 py-1 rounded" data-i18n="blank_line">â• Linha Branco</button>
    <button onclick="agenda1RemoverLinhasEmBranco()" class="text-xs bg-slate-200 hover:bg-slate-300 px-2 py-1 rounded" data-i18n="remove_blanks">âœ• Remover Brancos</button>
    <div class="border-l border-slate-300 h-4 mx-1"></div>
    <button id="agenda1BtnCargaDireta" onclick="agenda1AbrirModalCargaDireta()" class="text-xs bg-teal-600 hover:bg-teal-700 text-white px-2 py-1 rounded font-semibold btn-disabled" disabled data-i18n="direct_load">ğŸš› Carga Direta</button>
    <button onclick="agenda1AbrirModalGrupagem()" class="text-xs bg-green-600 hover:bg-green-700 text-white px-2 py-1 rounded font-semibold" data-i18n="create_grouping">ğŸ“¦ Criar Grupagem</button>
    <button onclick="agenda1AbrirGrupagemModal()" class="text-xs bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded" data-i18n="open_grouping">ğŸ”“ Abrir Grupagem</button>
    <button onclick="agenda1AbrirAnularCDModal()" class="text-xs bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded" data-i18n="cancel_direct_load">ğŸ—‘ Anular C.Direta</button>
    <button onclick="agenda1FecharGrupagem()" class="text-xs bg-green-700 hover:bg-green-800 text-white px-2 py-1 rounded" data-i18n="close_grouping">ğŸ”’ Fechar Grupagem</button>
    <div class="border-l border-slate-300 h-4 mx-1"></div>
    <span class="text-xs text-slate-500" data-i18n="destination">Destino:</span>
    <button id="agenda1BtnDiretoClientes" onclick="agenda1AbrirDestinoModal('clientes')" class="text-xs bg-cyan-600 hover:bg-cyan-700 text-white px-2 py-1 rounded" data-i18n="direct_customers">ğŸšš DIRETO CLIENTES</button>
    <button id="agenda1BtnDiretoArmazem" onclick="agenda1AbrirDestinoModal('armazem')" class="text-xs bg-amber-600 hover:bg-amber-700 text-white px-2 py-1 rounded" data-i18n="direct_warehouse">ğŸ­ DIRETO ARMAZÃ‰M</button>
    <div class="border-l border-slate-300 h-4 mx-1"></div>
    <button onclick="agenda1EnviarOrdenacao()" class="text-xs bg-indigo-600 hover:bg-indigo-700 text-white px-2 py-1 rounded" data-i18n="send_warehouse_order">ğŸ“‹ Enviar Ord. ArmazÃ©m</button>
    <button onclick="agenda1AbrirAgenda2Modal()" class="text-xs bg-blue-700 hover:bg-blue-800 text-white px-2 py-1 rounded font-semibold" data-i18n="pass_agenda2">â¡ PASSAR AGENDA 2</button>
  </div>

  <!-- Tabela -->
  <div class="flex-1 overflow-hidden p-2">
    <div class="h-full bg-white rounded border border-slate-300 overflow-hidden">
      <div id="agenda1ZoomContainer" class="agenda1-zoom-container h-full">
        <div class="agenda1-table-container h-full overflow-auto" id="agenda1TableContainer">
          <table class="w-full" id="agenda1ReservasTable" style="table-layout:fixed;">
            <thead class="sticky top-0 z-20">
              <tr class="bg-[#1e3a5f] text-white agenda1-compact-header">
                <th style="width:1.8%" class="px-0 py-1 text-center border-r border-slate-600"><input type="checkbox" id="agenda1SelectAllCheckbox" onchange="agenda1ToggleSelectAll()" class="agenda1-custom-checkbox"></th>
                <th style="width:1.5%" class="px-0 py-1 text-center border-r border-slate-600">â˜°</th>
                <th style="width:4.5%" class="px-1 py-1 text-left border-r border-slate-600 agenda1-sortable-header" onclick="agenda1SortBy('numeroReserva')">NÂº Res</th>
                <th style="width:2%" class="px-0 py-1 text-center border-r border-slate-600 bg-blue-700" title="Mensagem ao Motorista">MSG</th>
                <th style="width:5.5%" class="px-1 py-1 text-left border-r border-slate-600 agenda1-sortable-header" onclick="agenda1SortBy('comercial')">Comercial</th>
                <th style="width:5%" class="px-1 py-1 text-left border-r border-slate-600 agenda1-sortable-header" onclick="agenda1SortBy('dataCarga')">Dt.Carga</th>
                <th style="width:8%" class="px-1 py-1 text-left border-r border-slate-600 agenda1-sortable-header" onclick="agenda1SortBy('cliente')">Cliente</th>
                <th style="width:2%" class="px-0 py-1 text-center border-r border-slate-600" title="CMR Carga">CC</th>
                <th style="width:2%" class="px-0 py-1 text-center border-r border-slate-600" title="CMR Descarga">CD</th>
                <th style="width:3%" class="px-1 py-1 text-right border-r border-slate-600 agenda1-sortable-header" onclick="agenda1SortBy('ldm')">LDM</th>
                <th style="width:3.5%" class="px-1 py-1 text-right border-r border-slate-600 agenda1-sortable-header" onclick="agenda1SortBy('peso')">Peso</th>
                <th style="width:3%" class="px-1 py-1 text-right border-r border-slate-600 agenda1-sortable-header" onclick="agenda1SortBy('quantidadeBultos')">Bul</th>
                <th style="width:5%" class="px-1 py-1 text-left border-r border-slate-600 agenda1-sortable-header" onclick="agenda1SortBy('cidadeCarga')">Cid.Carga</th>
                <th style="width:5.5%" class="px-1 py-1 text-left border-r border-slate-600 agenda1-sortable-header" onclick="agenda1SortBy('codigoPostalCarga')">CP.Carga</th>
                <th style="width:5.5%" class="px-1 py-1 text-left border-r border-slate-600 agenda1-sortable-header" onclick="agenda1SortBy('codigoPostalDescarga')">CP.Desc</th>
                <th style="width:5%" class="px-1 py-1 text-left border-r border-slate-600 agenda1-sortable-header" onclick="agenda1SortBy('cidadeDescarga')">Cid.Desc</th>
                <th style="width:2.8%" class="px-0 py-1 text-center border-r border-slate-600 bg-purple-700 agenda1-sortable-header" onclick="agenda1SortBy('ordemCarga')">Ord</th>
                <th style="width:4%" class="px-1 py-1 text-center border-r border-slate-600 agenda1-sortable-header" onclick="agenda1SortBy('prioridadeCarga')">Prior</th>
                <th style="width:5%" class="px-1 py-1 text-left border-r border-slate-600 agenda1-sortable-header" onclick="agenda1SortBy('dataEntrega')">Dt.Entreg</th>
                <th style="width:6.5%" class="px-1 py-1 text-left border-r border-slate-600 bg-amber-700 agenda1-sortable-header" onclick="agenda1SortBy('motoristaRecolha')">Mot.Recolha</th>
                <th style="width:5.5%" class="px-1 py-1 text-left border-r border-slate-600 bg-amber-700 agenda1-sortable-header" onclick="agenda1SortBy('tratorRecolha')">Trat.Recolha</th>
                <th style="width:5.5%" class="px-1 py-1 text-left border-r border-slate-600 bg-amber-700 agenda1-sortable-header" onclick="agenda1SortBy('reboqueRecolha')">Reb.Recolha</th>
                <th style="width:4.5%" class="px-1 py-1 text-right border-r border-slate-600 agenda1-sortable-header" onclick="agenda1SortBy('valorServico')">Valor â‚¬</th>
                <th style="width:4%" class="px-1 py-1 text-center agenda1-sortable-header" onclick="agenda1SortBy('estadoReserva')">Estado</th>
              </tr>
            </thead>
            <tbody id="agenda1TableBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Modais -->
  <div id="agenda1ModalContainer"></div>
      </div>
    </section>

    <!-- Modal Container Agenda 1 -->
    <div id="agenda1ModalContainer"></div>


    <!-- PAGE: AGENDA 2 - MÃ“DULO COMPLETO v6 -->
    <section id="page-agenda2" class="hidden">
      <div class="agenda2-wrapper">
        
        <!-- CabeÃ§alho -->
        <div class="bg-[#1e3a5f] text-white px-4 py-1 flex items-center justify-between flex-shrink-0">
          <h1 class="text-sm font-bold tracking-wide" data-i18n="agenda2_header">AGENDA 2 <span class="text-xs font-normal opacity-70" id="agenda2NomeEquipa">Lisboa</span></h1>
          <div class="flex items-center gap-4 text-xs">
            <span><span data-i18n="groupings">Grupagens</span>: <strong id="agenda2CountGrupagens">0</strong></span>
            <span><span data-i18n="direct_loads">Cargas Diretas</span>: <strong id="agenda2CountDiretas">0</strong></span>
            <span class="bg-blue-500 px-2 py-0.5 rounded"><span data-i18n="ship">Navio</span>: <strong id="agenda2CountNavio">0</strong></span>
            <span class="bg-purple-500 px-2 py-0.5 rounded"><span data-i18n="train">Comboio</span>: <strong id="agenda2CountComboio">0</strong></span>
            <span class="bg-amber-500 px-2 py-0.5 rounded">âš ï¸ <span data-i18n="pending_send">Por enviar</span>: <strong id="agenda2CountPorEnviar">0</strong></span>
            <span id="agenda2ZoomLevel" class="bg-white/20 px-2 py-0.5 rounded">100%</span>
          </div>
        </div>

        <!-- Tabs -->
        <div class="bg-slate-200 px-3 py-1 flex items-center gap-2 flex-shrink-0 border-b border-slate-300">
          <button onclick="agenda2MostrarTab('listagem')" class="agenda2-tab-btn active text-xs px-4 py-1.5 rounded font-semibold" id="agenda2TabListagem">ğŸ“‹ Listagem</button>
          <button onclick="agenda2MostrarTab('dashboards')" class="agenda2-tab-btn text-xs px-4 py-1.5 rounded font-semibold" id="agenda2TabDashboards">ğŸ“Š Dashboards AnalÃ­ticos</button>
          <div class="flex-1"></div>
          <button onclick="agenda2ExportarExcel()" class="text-xs bg-emerald-600 hover:bg-emerald-700 text-white px-3 py-1.5 rounded font-semibold">ğŸ“¥ Exportar Excel</button>
          <button onclick="agenda2AbrirAgenda3Modal()" class="text-xs bg-green-600 hover:bg-green-700 text-white px-3 py-1.5 rounded font-semibold">â¡ PASSAR AGENDA 3</button>
        </div>

        <!-- Filtros -->
        <div id="agenda2FiltrosArea" class="bg-white border-b border-slate-300 px-3 py-1.5 flex items-center gap-3 flex-shrink-0 flex-wrap">
          <select id="agenda2FilterTipo" title="A2-1 Filtro Tipo" onchange="agenda2RenderTable()" class="text-xs px-2 py-1 border border-slate-300 rounded bg-white agenda2-input-nav">
            <option value="">Tipo: Todos</option>
            <option value="grupagem">Grupagens</option>
            <option value="cargadireta">Cargas Diretas</option>
          </select>
          <select id="agenda2FilterIntermodal" title="A2-2 Filtro Intermodal" onchange="agenda2RenderTable()" class="text-xs px-2 py-1 border border-slate-300 rounded bg-white agenda2-input-nav">
            <option value="">Intermodal: Todos</option>
            <option value="Rodovia PrÃ³pria">Rodovia PrÃ³pria</option>
            <option value="Rodovia Contratada">Rodovia Contratada</option>
            <option value="Navio">Navio</option>
            <option value="Comboio">Comboio</option>
          </select>
          <select id="agenda2FilterRota" title="A2-3 Filtro Rota" onchange="agenda2RenderTable()" class="text-xs px-2 py-1 border border-slate-300 rounded bg-white agenda2-input-nav">
            <option value="">Rota: Todas</option>
            <option value="Portugal Â» Alemanha">Portugal Â» Alemanha</option>
            <option value="Portugal Â» Holanda">Portugal Â» Holanda</option>
            <option value="Portugal Â» Barcelona">Portugal Â» Barcelona</option>
            <option value="Portugal Â» Madrid">Portugal Â» Madrid</option>
          </select>
          <select id="agenda2FilterEnviado" title="A2-4 Filtro Enviado" onchange="agenda2RenderTable()" class="text-xs px-2 py-1 border border-slate-300 rounded bg-white agenda2-input-nav">
            <option value="">Estado: Todos</option>
            <option value="nao">âš ï¸ Por Enviar</option>
            <option value="sim">âœ“ JÃ¡ Enviados</option>
          </select>
          <div class="border-l border-slate-300 h-5 mx-1"></div>
          <label class="text-xs text-slate-600">De:</label>
          <input type="date" id="agenda2FilterDataInicio" title="A2-5 Data InÃ­cio" onchange="agenda2RenderTable()" class="text-xs px-2 py-1 border border-slate-300 rounded agenda2-input-nav">
          <label class="text-xs text-slate-600">AtÃ©:</label>
          <input type="date" id="agenda2FilterDataFim" title="A2-6 Data Fim" onchange="agenda2RenderTable()" class="text-xs px-2 py-1 border border-slate-300 rounded agenda2-input-nav">
          <button onclick="agenda2LimparTodosFiltros()" class="text-xs bg-slate-300 hover:bg-slate-400 px-2 py-1 rounded font-bold" title="Limpar todos os filtros">âœ•</button>
          <div class="border-l border-slate-300 h-5 mx-1"></div>
          <div class="flex-1 max-w-xs">
            <input type="text" id="agenda2SearchInput" title="A2-7 Pesquisa" placeholder="ğŸ” Pesquisar..." oninput="agenda2RenderTable()" class="w-full text-xs px-2 py-1 border border-slate-300 rounded agenda2-input-nav">
          </div>
          <div id="agenda2CountDisplay" class="text-xs text-slate-600 bg-slate-100 px-2 py-1 rounded">0 itens</div>
        </div>

        <!-- Ãrea Principal -->
        <div class="flex-1 overflow-hidden p-2">
          
          <!-- TAB: Listagem -->
          <div id="agenda2AreaListagem" class="h-full bg-white rounded border border-slate-300 overflow-hidden">
            <div id="agenda2ZoomContainer" class="agenda2-zoom-container h-full">
              <div class="agenda2-table-container h-full overflow-auto" id="agenda2TableContainer">
                <table class="w-full" id="agenda2ReservasTable" style="table-layout:fixed;">
                  <thead class="sticky top-0 z-20">
                    <tr class="bg-[#1e3a5f] text-white agenda2-compact-header">
                      <th style="width:4%" class="px-1 py-1 text-left border-r border-slate-600 agenda2-sortable-header" onclick="agenda2OrdenarPor('numero')">NÂº <span class="agenda2-sort-indicator" id="agenda2-sort-numero"></span></th>
                      <th style="width:5%" class="px-1 py-1 text-left border-r border-slate-600 agenda2-sortable-header" onclick="agenda2OrdenarPor('tipo')">Tipo <span class="agenda2-sort-indicator" id="agenda2-sort-tipo"></span></th>
                      <th style="width:7%" class="px-1 py-1 text-left border-r border-slate-600 agenda2-sortable-header" onclick="agenda2OrdenarPor('rota')">Rota <span class="agenda2-sort-indicator" id="agenda2-sort-rota"></span></th>
                      <th style="width:5%" class="px-1 py-1 text-left border-r border-slate-600 agenda2-sortable-header" onclick="agenda2OrdenarPor('intermodal')">Intermodal <span class="agenda2-sort-indicator" id="agenda2-sort-intermodal"></span></th>
                      <th style="width:7%" class="px-1 py-1 text-left border-r border-slate-600">Fornecedor</th>
                      <th style="width:6%" class="px-1 py-1 text-left border-r border-slate-600">Motorista</th>
                      <th style="width:5%" class="px-1 py-1 text-left border-r border-slate-600">Trator</th>
                      <th style="width:5%" class="px-1 py-1 text-left border-r border-slate-600">Reboque</th>
                      <th style="width:4%" class="px-1 py-1 text-right border-r border-slate-600 agenda2-sortable-header" onclick="agenda2OrdenarPor('ldm')">LDM <span class="agenda2-sort-indicator" id="agenda2-sort-ldm"></span></th>
                      <th style="width:4%" class="px-1 py-1 text-right border-r border-slate-600 agenda2-sortable-header" onclick="agenda2OrdenarPor('peso')">Peso <span class="agenda2-sort-indicator" id="agenda2-sort-peso"></span></th>
                      <th style="width:3%" class="px-1 py-1 text-right border-r border-slate-600">Bul</th>
                      <th style="width:5%" class="px-1 py-1 text-right border-r border-slate-600 agenda2-sortable-header" onclick="agenda2OrdenarPor('valor')">Valor â‚¬ <span class="agenda2-sort-indicator" id="agenda2-sort-valor"></span></th>
                      <th style="width:4%" class="px-1 py-1 text-right border-r border-slate-600 bg-amber-700">â‚¬/LDM</th>
                      <th style="width:4%" class="px-1 py-1 text-right border-r border-slate-600">KM</th>
                      <th style="width:4%" class="px-1 py-1 text-right border-r border-slate-600 bg-amber-700">â‚¬/KM</th>
                      <th style="width:8%" class="px-1 py-1 text-left border-r border-slate-600 bg-green-700">Booking</th>
                      <th style="width:6%" class="px-1 py-1 text-center border-r border-slate-600">Destino</th>
                      <th style="width:7%" class="px-1 py-1 text-center border-r border-slate-600 bg-purple-700">Enviado Para</th>
                      <th style="width:5%" class="px-1 py-1 text-center">AcÃ§Ãµes</th>
                    </tr>
                  </thead>
                  <tbody id="agenda2TableBody"></tbody>
                  <tfoot class="sticky bottom-0 z-20">
                    <tr class="agenda2-row-total agenda2-compact-row" id="agenda2RowTotais">
                      <td colspan="8" class="text-right pr-4 font-bold">TOTAIS:</td>
                      <td class="text-right font-bold" id="agenda2TotalLDM">0</td>
                      <td class="text-right font-bold" id="agenda2TotalPeso">0</td>
                      <td class="text-right font-bold" id="agenda2TotalBultos">0</td>
                      <td class="text-right font-bold" id="agenda2TotalValor">0 â‚¬</td>
                      <td class="text-right font-bold" id="agenda2TotalEuroLDM">0 â‚¬</td>
                      <td class="text-right font-bold" id="agenda2TotalKM">0</td>
                      <td colspan="5"></td>
                    </tr>
                  </tfoot>
                </table>
              </div>
            </div>
          </div>
          
          <!-- TAB: Dashboards -->
          <div id="agenda2AreaDashboards" class="h-full overflow-auto hidden">
            <div class="bg-white rounded border border-slate-300 p-3 mb-3">
              <div class="flex items-center gap-4 flex-wrap">
                <div>
                  <label class="text-xs font-semibold text-slate-600">De:</label>
                  <input type="date" id="agenda2DataInicio" class="text-xs border rounded px-2 py-1 ml-1 agenda2-input-nav" onchange="agenda2AtualizarDashboards()">
                </div>
                <div>
                  <label class="text-xs font-semibold text-slate-600">AtÃ©:</label>
                  <input type="date" id="agenda2DataFim" class="text-xs border rounded px-2 py-1 ml-1 agenda2-input-nav" onchange="agenda2AtualizarDashboards()">
                </div>
                <div class="border-l border-slate-300 h-6 mx-2"></div>
                <span class="text-xs text-slate-500">Comparar com:</span>
                <select id="agenda2PeriodoComparacao" class="text-xs border rounded px-2 py-1 agenda2-input-nav" onchange="agenda2AtualizarDashboards()">
                  <option value="mes">MÃªs Anterior</option>
                  <option value="trimestre">Trimestre Anterior</option>
                  <option value="semestre">Semestre Anterior</option>
                  <option value="ano">Ano Anterior</option>
                </select>
                <button onclick="agenda2AtualizarDashboards()" class="text-xs bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700">ğŸ”„ Atualizar</button>
              </div>
            </div>
            
            <!-- Cards Resumo -->
            <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-3 mb-4">
              <div class="agenda2-analytic-card">
                <div class="agenda2-analytic-label">Total Grupagens</div>
                <div class="agenda2-analytic-value" id="agenda2DashTotalGrupagens">0</div>
                <div class="text-xs mt-1" id="agenda2DashCompGrupagens"></div>
              </div>
              <div class="agenda2-analytic-card">
                <div class="agenda2-analytic-label">Total Cargas Diretas</div>
                <div class="agenda2-analytic-value" id="agenda2DashTotalCD">0</div>
                <div class="text-xs mt-1" id="agenda2DashCompCD"></div>
              </div>
              <div class="agenda2-analytic-card">
                <div class="agenda2-analytic-label">Viagens Navio</div>
                <div class="agenda2-analytic-value text-blue-600" id="agenda2DashTotalNavio">0</div>
              </div>
              <div class="agenda2-analytic-card">
                <div class="agenda2-analytic-label">Viagens Comboio</div>
                <div class="agenda2-analytic-value text-purple-600" id="agenda2DashTotalComboio">0</div>
              </div>
              <div class="agenda2-analytic-card">
                <div class="agenda2-analytic-label">Valor Total</div>
                <div class="agenda2-analytic-value text-green-600" id="agenda2DashValorTotal">0 â‚¬</div>
                <div class="text-xs mt-1" id="agenda2DashCompValor"></div>
              </div>
              <div class="agenda2-analytic-card">
                <div class="agenda2-analytic-label">PreÃ§o MÃ©dio/LDM</div>
                <div class="agenda2-analytic-value text-amber-600" id="agenda2DashMediaLDM">0 â‚¬</div>
              </div>
            </div>
            
            <!-- GrÃ¡ficos -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
              <div class="agenda2-chart-container">
                <h3 class="font-bold text-slate-800 mb-2 text-sm">ğŸ“Š DistribuiÃ§Ã£o por Intermodal</h3>
                <canvas id="agenda2ChartIntermodal"></canvas>
              </div>
              <div class="agenda2-chart-container">
                <h3 class="font-bold text-slate-800 mb-2 text-sm">ğŸ“Š Valor por Rota</h3>
                <canvas id="agenda2ChartRotas"></canvas>
              </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
              <div class="agenda2-chart-container">
                <h3 class="font-bold text-slate-800 mb-2 text-sm">ğŸ“Š Grupagens vs Cargas Diretas</h3>
                <canvas id="agenda2ChartTipos"></canvas>
              </div>
              <div class="agenda2-chart-container">
                <h3 class="font-bold text-slate-800 mb-2 text-sm">ğŸ“Š Estado de Envio para Agenda 3</h3>
                <canvas id="agenda2ChartEnvio"></canvas>
              </div>
            </div>
            
            <!-- Tabelas AnÃ¡lise -->
            <div class="bg-white rounded border border-slate-300 p-4 mb-4">
              <h3 class="font-bold text-slate-800 mb-3">ğŸ“Š AnÃ¡lise por Rota (Grupagens)</h3>
              <table class="w-full text-sm">
                <thead><tr class="bg-slate-100">
                  <th class="text-left p-2 border">Rota</th>
                  <th class="text-right p-2 border">Qtd</th>
                  <th class="text-right p-2 border">LDM Total</th>
                  <th class="text-right p-2 border">Valor Total</th>
                  <th class="text-right p-2 border font-bold text-amber-700">â‚¬/LDM MÃ©dio</th>
                </tr></thead>
                <tbody id="agenda2TbodyRotas"></tbody>
              </table>
            </div>
            
            <div class="bg-white rounded border border-slate-300 p-4">
              <h3 class="font-bold text-slate-800 mb-3">ğŸš› AnÃ¡lise Cargas Diretas por Origem/Destino</h3>
              <table class="w-full text-sm">
                <thead><tr class="bg-slate-100">
                  <th class="text-left p-2 border">Origem â†’ Destino</th>
                  <th class="text-right p-2 border">NÂº Cargas</th>
                  <th class="text-right p-2 border">KM Total</th>
                  <th class="text-right p-2 border">Valor Total</th>
                  <th class="text-right p-2 border font-bold text-amber-700">â‚¬/KM MÃ©dio</th>
                </tr></thead>
                <tbody id="agenda2TbodyCDRotas"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Modal Container Agenda 2 -->
      <div id="agenda2ModalContainer"></div>
    </section>

    <!-- PAGE: AGENDA 3 - v20 INTEGRADO -->
    <section id="page-agenda3" class="hidden" style="display: none; flex-direction: column; height: calc(100vh - 0px); overflow: hidden;">
      
      <!-- CabeÃ§alho Roxo -->
      <div class="bg-[#7c3aed] text-white px-4 py-1 flex items-center justify-between flex-shrink-0">
        <h1 class="text-sm font-bold tracking-wide" data-i18n="agenda3_header">AGENDA 3 - DISTRIBUIÃ‡ÃƒO E ENTREGA</h1>
        <div class="flex items-center gap-4 text-xs">
          <span><span data-i18n="distributions">DistribuiÃ§Ãµes</span>: <strong id="agenda3CountDistribuicoes">0</strong></span>
          <span><span data-i18n="bookings">Reservas</span>: <strong id="agenda3CountReservas">0</strong></span>
          <span id="agenda3ZoomLevel" class="bg-white/20 px-2 py-0.5 rounded">100%</span>
        </div>
      </div>

      <!-- Barra Motorista/Trator/Reboque Entrega -->
      <div class="bg-[#1e3a5f] text-white px-3 py-2 flex items-center gap-4 flex-shrink-0">
        <div class="flex items-center gap-2">
          <label class="text-xs font-semibold" data-i18n="delivery_driver">ğŸ‘¤ Motorista Entrega:</label>
          <select id="agenda3MotoristaEntrega" title="A3-1 Motorista Entrega" class="text-xs px-2 py-1 rounded bg-white text-slate-800 font-bold min-w-[150px]" onchange="agenda3ValidarEnvio()">
            <option value="" data-i18n="select_option">-- Selecione --</option>
            <option value="Carlos Ferreira">Carlos Ferreira</option>
            <option value="Francisco Alves">Francisco Alves</option>
            <option value="JosÃ© Rodrigues">JosÃ© Rodrigues</option>
            <option value="Rui Martins">Rui Martins</option>
            <option value="Manuel Costa">Manuel Costa</option>
          </select>
        </div>
        <div class="flex items-center gap-2">
          <label class="text-xs font-semibold" data-i18n="delivery_tractor">ğŸš› Trator Entrega:</label>
          <select id="agenda3TratorEntrega" title="A3-2 Trator Entrega" class="text-xs px-2 py-1 rounded bg-white text-slate-800 font-bold min-w-[120px]" onchange="agenda3ValidarEnvio()">
            <option value="" data-i18n="select_option">-- Selecione --</option>
            <option value="AA-00-BB">AA-00-BB</option>
            <option value="EE-22-FF">EE-22-FF</option>
            <option value="MN-70-OP">MN-70-OP</option>
            <option value="YY-30-ZZ">YY-30-ZZ</option>
          </select>
        </div>
        <div class="flex items-center gap-2">
          <label class="text-xs font-semibold">ğŸš Reboque Entrega:</label>
          <select id="agenda3ReboqueEntrega" title="A3-3 Reboque Entrega" class="text-xs px-2 py-1 rounded bg-white text-slate-800 font-bold min-w-[120px]" onchange="agenda3ValidarEnvio()">
            <option value="">-- Selecione --</option>
            <option value="CC-11-DD">CC-11-DD</option>
            <option value="GG-33-HH">GG-33-HH</option>
            <option value="QR-80-ST">QR-80-ST</option>
            <option value="OP-45-QR">OP-45-QR</option>
          </select>
        </div>
      </div>

      <!-- Barra de Filtros -->
      <div class="bg-white border-b border-slate-300 px-3 py-1.5 flex items-center gap-3 flex-shrink-0">
        <select id="agenda3FilterEstado" title="A3-4 Filtro Estado" onchange="agenda3RenderTable()" class="text-xs px-2 py-1 border border-slate-300 rounded bg-white">
          <option value="">Estado: Todos</option>
          <option value="Em TrÃ¢nsito">Em TrÃ¢nsito</option>
          <option value="No Cliente">No Cliente</option>
          <option value="Entregue">Entregue</option>
        </select>
        <select id="agenda3FilterPrioridade" title="A3-5 Filtro Prioridade" onchange="agenda3RenderTable()" class="text-xs px-2 py-1 border border-slate-300 rounded bg-white">
          <option value="">Prioridade: Todas</option>
          <option value="Baixa">Baixa</option>
          <option value="Normal">Normal</option>
          <option value="Alta">Alta</option>
          <option value="Urgente">Urgente</option>
        </select>
        <label class="flex items-center gap-1 text-xs">
          <input type="checkbox" id="agenda3FilterComplementar" title="A3-6 Filtro Complementar" onchange="agenda3RenderTable()" class="agenda3-custom-checkbox">
          <span class="text-green-700 font-semibold">SÃ³ Complementares</span>
        </label>
        <div class="flex-1 max-w-md">
          <input type="text" id="agenda3SearchInput" title="A3-7 Pesquisa" placeholder="ğŸ” Pesquisar..." oninput="agenda3RenderTable()" class="w-full text-xs px-2 py-1 border border-slate-300 rounded">
        </div>
        <div id="agenda3CountDisplay" class="text-xs text-slate-600 bg-slate-100 px-2 py-1 rounded">0 reservas</div>
        <div id="agenda3SelectedCount" class="text-xs text-blue-600 bg-blue-50 px-2 py-1 rounded hidden">0 selecionadas</div>
      </div>

      <!-- Barra de AÃ§Ãµes -->
      <div class="bg-slate-50 border-b border-slate-300 px-3 py-1 flex items-center gap-2 flex-shrink-0 flex-wrap">
        <button onclick="agenda3AbrirGrupagem()" class="text-xs bg-amber-500 hover:bg-amber-600 text-white px-2 py-1 rounded font-semibold" data-i18n="open_grouping">ğŸ”“ Abrir Grupagem</button>
        <button onclick="agenda3CriarGrupagem()" class="text-xs bg-green-600 hover:bg-green-700 text-white px-2 py-1 rounded font-semibold" data-i18n="create_grouping">ğŸ“¦ Criar Grupagem</button>
        <button onclick="agenda3FecharGrupagem()" class="text-xs bg-green-700 hover:bg-green-800 text-white px-2 py-1 rounded font-semibold" data-i18n="close_grouping">ğŸ”’ Fechar Grupagem</button>
        <div class="border-l border-slate-300 h-4 mx-1"></div>
        <button onclick="agenda3InserirLinhaEmBranco()" class="text-xs bg-slate-200 hover:bg-slate-300 px-2 py-1 rounded" data-i18n="blank_line">â• Linha Branco</button>
        <button onclick="agenda3RemoverLinhasEmBranco()" class="text-xs bg-slate-200 hover:bg-slate-300 px-2 py-1 rounded" data-i18n="remove_blanks">âœ• Remover Brancos</button>
        <div class="border-l border-slate-300 h-4 mx-1"></div>
        <button onclick="agenda3SelectAll()" class="text-xs bg-slate-200 hover:bg-slate-300 px-2 py-1 rounded" data-i18n="select_all">â˜‘ Selec. Todas</button>
        <button onclick="agenda3DeselectAll()" class="text-xs bg-slate-200 hover:bg-slate-300 px-2 py-1 rounded" data-i18n="clear_selection">â˜ Limpar</button>
        <div class="border-l border-slate-300 h-4 mx-1"></div>
        <button id="agenda3BtnEnviarOrdem" onclick="agenda3EnviarOrdemArmazem()" class="text-xs bg-purple-600 hover:bg-purple-700 text-white px-2 py-1 rounded font-semibold agenda3-btn-disabled" disabled data-i18n="send_warehouse_order">ğŸ“¦ Enviar Ord. ArmazÃ©m</button>
        <div class="border-l border-slate-300 h-4 mx-1"></div>
        <button onclick="agenda3DevolverOrigem()" class="text-xs bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded" data-i18n="return_to_origin">â†© Devolver Ã  Origem</button>
        <button onclick="agenda3AbrirReverterModal()" class="text-xs bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded" data-i18n="revert_booking">ğŸ”„ Reverter Reserva</button>
      </div>

      <!-- Barra de DistribuiÃ§Ãµes -->
      <div class="bg-white border-b border-slate-300 px-3 py-2 flex items-center gap-2 flex-shrink-0 overflow-x-auto">
        <span class="text-xs font-semibold text-slate-600">DistribuiÃ§Ãµes:</span>
        <div id="agenda3ListaDistribuicoes" class="flex gap-2"></div>
      </div>

      <!-- Tabela Principal -->
      <div class="flex-1 overflow-auto agenda3-table-container" id="agenda3TableContainer">
        <div id="agenda3ZoomContainer" class="agenda3-zoom-container min-w-full">
          <table id="agenda3MainTable" class="agenda3-table w-full">
            <thead class="bg-slate-700 text-white sticky top-0 z-10 agenda3-compact-header">
              <tr>
                <th class="w-8 text-center"><input type="checkbox" id="agenda3CheckAll" onchange="agenda3ToggleAll(this)" class="agenda3-custom-checkbox"></th>
                <th class="w-6 text-center">â˜°</th>
                <th class="w-20 text-left">NÂº Res</th>
                <th class="w-6 text-center">MSG</th>
                <th class="w-20 text-center">âœ“</th>
                <th class="w-24 text-left">Comercial</th>
                <th class="w-20 text-left">Dt.Carga</th>
                <th class="w-32 text-left">Cliente</th>
                <th class="w-6 text-center">CC</th>
                <th class="w-6 text-center">CD</th>
                <th class="w-12 text-right">LDM</th>
                <th class="w-14 text-right">Peso</th>
                <th class="w-10 text-right">Bul</th>
                <th class="w-20 text-left">Cid.Carga</th>
                <th class="w-16 text-left">CP.Carga</th>
                <th class="w-16 text-left">CP.Desc</th>
                <th class="w-20 text-left">Cid.Desc</th>
                <th class="w-10 text-center">Ord</th>
                <th class="w-14 text-center">Prior</th>
                <th class="w-20 text-left">Dt.Entreg</th>
                <th class="w-24 text-left">Mot.Recolha</th>
                <th class="w-20 text-left">Trat.Recolha</th>
                <th class="w-20 text-left">Reb.Recolha</th>
                <th class="w-20 text-right">Valor â‚¬</th>
                <th class="w-24 text-center">Estado</th>
              </tr>
            </thead>
            <tbody id="agenda3TableBody"></tbody>
          </table>
        </div>
      </div>

      <!-- RodapÃ© TOTAIS -->
      <div class="bg-slate-800 text-white px-4 py-2 flex items-center justify-between flex-shrink-0">
        <div class="flex items-center gap-6 text-xs">
          <span>TOTAIS:</span>
          <span>LDM: <strong id="agenda3TotalLDM">0.0</strong></span>
          <span>Peso: <strong id="agenda3TotalPeso">0</strong></span>
          <span>Bultos: <strong id="agenda3TotalBultos">0</strong></span>
        </div>
        <div class="flex items-center gap-4 text-xs">
          <span class="bg-green-600 px-3 py-1 rounded">Valor Complementar: <strong id="agenda3TotalValorComplementar">0,00 â‚¬</strong></span>
        </div>
      </div>

      <!-- Modal Agenda 3 -->
      <div id="agenda3Modal" class="fixed inset-0 bg-black/50 z-50 hidden agenda3-modal-overlay flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-2xl max-w-3xl w-full max-h-[90vh] overflow-auto agenda3-modal-content">
          <div id="agenda3ModalHeader" class="bg-purple-700 text-white px-4 py-3 rounded-t-lg font-bold text-lg flex justify-between items-center">
            <span id="agenda3ModalTitle">Modal</span>
            <button onclick="agenda3FecharModal()" class="text-white/70 hover:text-white text-2xl">&times;</button>
          </div>
          <div id="agenda3ModalBody" class="p-4"></div>
        </div>
      </div>

    </section>

    <!-- PAGE: AGENDA ARQUIVO -->
    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         AGENDA ARQUIVO - MÃ“DULO COMPLETO (Integrado v5.5)
         â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <section id="page-agendaarquivo" class="hidden" style="display: none; flex-direction: column; height: calc(100vh - 0px); overflow: hidden;">
      
      <!-- HEADER INTERNO -->
      <header class="agendaarquivo-header-main text-white p-3 shadow-lg agendaarquivo-no-print">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-4">
            <h1 class="text-lg font-bold flex items-center gap-2">
              ğŸ—„ï¸ AGENDA ARQUIVO
              <span class="text-xs bg-white/20 px-2 py-0.5 rounded">ğŸ”’ Apenas Consulta</span>
            </h1>
            <div class="flex items-center gap-2 text-xs bg-white/10 px-3 py-1 rounded">
              <span>ğŸ“¦ Grupagens: <strong id="agendaArquivoCountGrupagens">0</strong></span>
              <span class="mx-2">|</span>
              <span>ğŸ“‹ Reservas: <strong id="agendaArquivoCountReservas">0</strong></span>
              <span class="mx-2">|</span>
              <span>â†©ï¸ DevoluÃ§Ãµes: <strong id="agendaArquivoCountDevolucoes">0</strong></span>
            </div>
          </div>
          <div class="flex items-center gap-2">
            <button onclick="agendaArquivoRecarregarDados()" class="px-3 py-1.5 bg-yellow-500 hover:bg-yellow-600 text-white rounded text-xs font-semibold">
              ğŸ”„ Atualizar Dados
            </button>
            <button onclick="agendaArquivoLimparTodosDados()" class="px-3 py-1.5 bg-red-500 hover:bg-red-600 text-white rounded text-xs font-semibold">
              ğŸ—‘ï¸ Limpar Tudo
            </button>
            <button onclick="agendaArquivoExportarExcel()" class="px-3 py-1.5 bg-white/20 hover:bg-white/30 rounded text-xs font-semibold">
              ğŸ“¥ Exportar Excel
            </button>
            <button onclick="window.print()" class="px-3 py-1.5 bg-white/20 hover:bg-white/30 rounded text-xs font-semibold">
              ğŸ–¨ï¸ Imprimir
            </button>
            <button onclick="agendaArquivoVerLocalStorage()" class="px-3 py-1.5 bg-slate-600 hover:bg-slate-700 rounded text-xs font-semibold">
              ğŸ” Debug
            </button>
          </div>
        </div>
      </header>

      <!-- TABS DE NAVEGAÃ‡ÃƒO -->
      <div class="flex agendaarquivo-no-print">
        <button onclick="agendaArquivoMudarTab('arquivo')" id="agendaArquivoTabArquivo" class="agendaarquivo-tab-active text-white px-6 py-2 font-semibold text-xs">
          ğŸ“ Arquivo
        </button>
        <button onclick="agendaArquivoMudarTab('dashboards')" id="agendaArquivoTabDashboards" class="agendaarquivo-tab-inactive text-white px-6 py-2 font-semibold text-xs">
          ğŸ“Š Dashboards
        </button>
        <button onclick="agendaArquivoMudarTab('sla')" id="agendaArquivoTabSLA" class="agendaarquivo-tab-inactive text-white px-6 py-2 font-semibold text-xs">
          â±ï¸ SLA / Performance
        </button>
      </div>

      <!-- CONTEÃšDO PRINCIPAL -->
      <main class="p-4 overflow-y-auto" style="flex: 1;">
        
        <!-- TAB: ARQUIVO -->
        <div id="agendaArquivoContentArquivo">
          
          <!-- FILTROS -->
          <div class="agendaarquivo-card p-4 mb-4">
            <div class="flex items-center gap-4 flex-wrap">
              <div>
                <label class="block text-xs font-semibold text-slate-600 mb-1">ğŸ“… Data InÃ­cio</label>
                <input type="date" id="agendaArquivoFiltroDataInicio" title="AA1 Data InÃ­cio" class="agendaarquivo-filter-input" onchange="agendaArquivoAplicarFiltros()">
              </div>
              <div>
                <label class="block text-xs font-semibold text-slate-600 mb-1">ğŸ“… Data Fim</label>
                <input type="date" id="agendaArquivoFiltroDataFim" title="AA2 Data Fim" class="agendaarquivo-filter-input" onchange="agendaArquivoAplicarFiltros()">
              </div>
              <div>
                <label class="block text-xs font-semibold text-slate-600 mb-1">ğŸ­ ArmazÃ©m</label>
                <select id="agendaArquivoFiltroArmazem" title="AA3 ArmazÃ©m" class="agendaarquivo-filter-input" onchange="agendaArquivoAplicarFiltros()">
                  <option value="">Todos</option>
                  <option value="ArmazÃ©m Holanda">ArmazÃ©m Holanda</option>
                  <option value="ArmazÃ©m Alemanha">ArmazÃ©m Alemanha</option>
                  <option value="ArmazÃ©m FranÃ§a">ArmazÃ©m FranÃ§a</option>
                  <option value="ArmazÃ©m Loureiro">ArmazÃ©m Loureiro</option>
                </select>
              </div>
              <div>
                <label class="block text-xs font-semibold text-slate-600 mb-1">ğŸ‘¤ Comercial</label>
                <select id="agendaArquivoFiltroComercial" title="AA4 Comercial" class="agendaarquivo-filter-input" onchange="agendaArquivoAplicarFiltros()">
                  <option value="">Todos</option>
                </select>
              </div>
              <div>
                <label class="block text-xs font-semibold text-slate-600 mb-1">ğŸ‘¥ Equipa</label>
                <select id="agendaArquivoFiltroEquipa" title="AA5 Equipa" class="agendaarquivo-filter-input" onchange="agendaArquivoAplicarFiltros()">
                  <option value="">Todas</option>
                </select>
              </div>
              <div>
                <label class="block text-xs font-semibold text-slate-600 mb-1">ğŸ¢ Cliente</label>
                <select id="agendaArquivoFiltroCliente" title="AA6 Cliente" class="agendaarquivo-filter-input" onchange="agendaArquivoAplicarFiltros()">
                  <option value="">Todos</option>
                </select>
              </div>
              <div>
                <label class="block text-xs font-semibold text-slate-600 mb-1">ğŸ“‹ Tipo</label>
                <select id="agendaArquivoFiltroTipo" title="AA7 Tipo" class="agendaarquivo-filter-input" onchange="agendaArquivoAplicarFiltros()">
                  <option value="">Todos</option>
                  <option value="grupagem">Grupagens Enviadas</option>
                  <option value="reserva">Reservas Arquivadas</option>
                  <option value="devolucao">DevoluÃ§Ãµes</option>
                </select>
              </div>
              <div>
                <label class="block text-xs font-semibold text-slate-600 mb-1">ğŸ” Pesquisar</label>
                <input type="text" id="agendaArquivoFiltroPesquisa" title="AA8 Pesquisa" class="agendaarquivo-filter-input w-40" placeholder="NÂº reserva, cliente..." oninput="agendaArquivoAplicarFiltros()">
              </div>
              <div class="ml-auto">
                <button onclick="agendaArquivoLimparFiltros()" class="px-3 py-1.5 bg-slate-200 hover:bg-slate-300 rounded text-xs font-semibold">
                  âœ• Limpar Filtros
                </button>
              </div>
            </div>
          </div>

          <!-- RESUMO RÃPIDO - LINHA 1 -->
          <div class="grid grid-cols-9 gap-2 mb-2">
            <div class="agendaarquivo-card p-3 agendaarquivo-kpi-card">
              <p class="text-[10px] text-slate-500 font-semibold">ğŸ“¦ GRUPAGENS</p>
              <p class="text-xl font-bold text-emerald-600" id="agendaArquivoKpiTotalGrupagens">0</p>
            </div>
            <div class="agendaarquivo-card p-3 agendaarquivo-kpi-card">
              <p class="text-[10px] text-slate-500 font-semibold">ğŸ“‹ RESERVAS</p>
              <p class="text-xl font-bold text-blue-600" id="agendaArquivoKpiTotalReservas">0</p>
            </div>
            <div class="agendaarquivo-card p-3 agendaarquivo-kpi-card">
              <p class="text-[10px] text-slate-500 font-semibold">ğŸ“Š MÃ‰DIA RES/GRUP</p>
              <p class="text-xl font-bold text-indigo-600" id="agendaArquivoKpiMediaReservas">0</p>
            </div>
            <div class="agendaarquivo-card p-3 agendaarquivo-kpi-card">
              <p class="text-[10px] text-slate-500 font-semibold">â†©ï¸ DEVOLUÃ‡Ã•ES</p>
              <p class="text-xl font-bold text-amber-600" id="agendaArquivoKpiTotalDevolucoes">0</p>
            </div>
            <div class="agendaarquivo-card p-3 agendaarquivo-kpi-card">
              <p class="text-[10px] text-slate-500 font-semibold">ğŸ“¦ LDM TOTAL</p>
              <p class="text-xl font-bold text-purple-600" id="agendaArquivoKpiTotalLDM">0</p>
            </div>
            <div class="agendaarquivo-card p-3 agendaarquivo-kpi-card">
              <p class="text-[10px] text-slate-500 font-semibold">ğŸ“¦ BULTOS</p>
              <p class="text-xl font-bold text-orange-600" id="agendaArquivoKpiTotalBultos">0</p>
            </div>
            <div class="agendaarquivo-card p-3 agendaarquivo-kpi-card">
              <p class="text-[10px] text-slate-500 font-semibold">âš–ï¸ PESO (kg)</p>
              <p class="text-xl font-bold text-slate-600" id="agendaArquivoKpiTotalPeso">0</p>
            </div>
            <div class="agendaarquivo-card p-3 agendaarquivo-kpi-card">
              <p class="text-[10px] text-slate-500 font-semibold">ğŸ’° VALOR TOTAL</p>
              <p class="text-xl font-bold text-green-600" id="agendaArquivoKpiValorTotal">0 â‚¬</p>
            </div>
            <div class="agendaarquivo-card p-3 agendaarquivo-kpi-card border-2 border-green-400">
              <p class="text-[10px] text-green-600 font-semibold">ğŸ’š COMPLEMENTARES</p>
              <p class="text-xl font-bold text-green-700" id="agendaArquivoKpiValorComplementar">0 â‚¬</p>
            </div>
          </div>
          
          <!-- RESUMO RÃPIDO - LINHA 2 (KPIs de Km e MÃ©dias) -->
          <div class="grid grid-cols-5 gap-2 mb-4">
            <div class="agendaarquivo-card p-3 agendaarquivo-kpi-card border-2 border-cyan-400">
              <p class="text-[10px] text-cyan-600 font-semibold">ğŸ›£ï¸ KM TOTAIS</p>
              <p class="text-xl font-bold text-cyan-700" id="agendaArquivoKpiKmTotais">0</p>
              <p class="text-[9px] text-cyan-500">GPS Fortcom</p>
            </div>
            <div class="agendaarquivo-card p-3 agendaarquivo-kpi-card border-2 border-violet-400">
              <p class="text-[10px] text-violet-600 font-semibold">ğŸ’¶ â‚¬/KM GERAL</p>
              <p class="text-xl font-bold text-violet-700" id="agendaArquivoKpiEuroKmGeral">0.00 â‚¬</p>
              <p class="text-[9px] text-violet-500">(c/ complementares)</p>
            </div>
            <div class="agendaarquivo-card p-3 agendaarquivo-kpi-card border-2 border-rose-400">
              <p class="text-[10px] text-rose-600 font-semibold">ğŸ“Š â‚¬/LDM MÃ‰DIO</p>
              <p class="text-xl font-bold text-rose-700" id="agendaArquivoKpiEuroLdmMedio">0.00 â‚¬</p>
              <p class="text-[9px] text-rose-500">(s/ complementares)</p>
            </div>
            <div class="agendaarquivo-card p-3 agendaarquivo-kpi-card border-2 border-teal-400">
              <p class="text-[10px] text-teal-600 font-semibold">ğŸš› â‚¬/KM S/ COMP</p>
              <p class="text-xl font-bold text-teal-700" id="agendaArquivoKpiEuroKmSemComp">0.00 â‚¬</p>
              <p class="text-[9px] text-teal-500">(sÃ³ valor normal)</p>
            </div>
            <div class="agendaarquivo-card p-3 agendaarquivo-kpi-card border-2 border-lime-400">
              <p class="text-[10px] text-lime-600 font-semibold">ğŸšš â‚¬/KM C/ COMP</p>
              <p class="text-xl font-bold text-lime-700" id="agendaArquivoKpiEuroKmComComp">0.00 â‚¬</p>
              <p class="text-[9px] text-lime-500">(valor + complementar)</p>
            </div>
          </div>

          <!-- TABELA DE ARQUIVO -->
          <div class="agendaarquivo-card">
            <div class="p-3 border-b flex items-center justify-between">
              <h2 class="font-bold text-slate-700 agendaarquivo-section-title">ğŸ“ Registos Arquivados</h2>
              <span class="text-xs text-slate-500">ğŸ”’ Dados bloqueados - apenas consulta</span>
            </div>
            <div class="overflow-x-auto agendaarquivo-table-container" style="max-height: 500px; overflow-y: auto;">
              <table class="w-full text-xs">
                <thead class="agendaarquivo-table-header sticky top-0">
                  <tr>
                    <th class="p-2 text-left">Tipo</th>
                    <th class="p-2 text-left">NÂº Grup.</th>
                    <th class="p-2 text-center">ORD</th>
                    <th class="p-2 text-left">NÂº Reserva</th>
                    <th class="p-2 text-left">Data Arquivo</th>
                    <th class="p-2 text-left">Arm. Carga</th>
                    <th class="p-2 text-left">Arm. Destino</th>
                    <th class="p-2 text-left">Cliente</th>
                    <th class="p-2 text-left">Comercial</th>
                    <th class="p-2 text-left">Motorista</th>
                    <th class="p-2 text-left">Trator</th>
                    <th class="p-2 text-right">LDM</th>
                    <th class="p-2 text-right">Bultos</th>
                    <th class="p-2 text-right">Peso</th>
                    <th class="p-2 text-right">Valor â‚¬</th>
                    <th class="p-2 text-center">CMR Carga</th>
                    <th class="p-2 text-center">CMR Descarga</th>
                    <th class="p-2 text-right">Km</th>
                    <th class="p-2 text-right">â‚¬/Km</th>
                  </tr>
                </thead>
                <tbody id="agendaArquivoTabelaArquivo">
                  <!-- Preenchido por JavaScript -->
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- TAB: DASHBOARDS -->
        <div id="agendaArquivoContentDashboards" class="hidden">
          
          <!-- KPIs PRINCIPAIS -->
          <div class="grid grid-cols-6 gap-4 mb-4">
            <div class="agendaarquivo-card p-4 agendaarquivo-kpi-card bg-gradient-to-br from-emerald-50 to-emerald-100">
              <p class="text-xs text-emerald-600 font-semibold">ğŸ“¦ Grupagens (MÃªs)</p>
              <p class="text-3xl font-bold text-emerald-700" id="agendaArquivoKpiGrupagensMes">0</p>
              <p class="text-xs text-emerald-500 mt-1" id="agendaArquivoKpiGrupagensMesVar">-</p>
            </div>
            <div class="agendaarquivo-card p-4 agendaarquivo-kpi-card bg-gradient-to-br from-blue-50 to-blue-100">
              <p class="text-xs text-blue-600 font-semibold">ğŸ“‹ Reservas (MÃªs)</p>
              <p class="text-3xl font-bold text-blue-700" id="agendaArquivoKpiReservasMes">0</p>
              <p class="text-xs text-blue-500 mt-1" id="agendaArquivoKpiReservasMesVar">-</p>
            </div>
            <div class="agendaarquivo-card p-4 agendaarquivo-kpi-card bg-gradient-to-br from-purple-50 to-purple-100">
              <p class="text-xs text-purple-600 font-semibold">ğŸ“¦ LDM (MÃªs)</p>
              <p class="text-3xl font-bold text-purple-700" id="agendaArquivoKpiLDMMes">0</p>
              <p class="text-xs text-purple-500 mt-1" id="agendaArquivoKpiLDMMesVar">-</p>
            </div>
            <div class="agendaarquivo-card p-4 agendaarquivo-kpi-card bg-gradient-to-br from-orange-50 to-orange-100">
              <p class="text-xs text-orange-600 font-semibold">ğŸ’° FaturaÃ§Ã£o (MÃªs)</p>
              <p class="text-3xl font-bold text-orange-700" id="agendaArquivoKpiFaturacaoMes">0 â‚¬</p>
              <p class="text-xs text-orange-500 mt-1" id="agendaArquivoKpiFaturacaoMesVar">-</p>
            </div>
            <div class="agendaarquivo-card p-4 agendaarquivo-kpi-card bg-gradient-to-br from-cyan-50 to-cyan-100">
              <p class="text-xs text-cyan-600 font-semibold">ğŸ’¶ PreÃ§o MÃ©dio/LDM</p>
              <p class="text-3xl font-bold text-cyan-700" id="agendaArquivoKpiPrecoMedioLDM">0 â‚¬</p>
              <p class="text-xs text-cyan-500 mt-1">Geral</p>
            </div>
            <div class="agendaarquivo-card p-4 agendaarquivo-kpi-card bg-gradient-to-br from-rose-50 to-rose-100">
              <p class="text-xs text-rose-600 font-semibold">â†©ï¸ DevoluÃ§Ãµes (MÃªs)</p>
              <p class="text-3xl font-bold text-rose-700" id="agendaArquivoKpiDevolucoesMes">0</p>
              <p class="text-xs text-rose-500 mt-1" id="agendaArquivoKpiDevolucoesMesVar">-</p>
            </div>
          </div>

          <!-- GRÃFICOS LINHA 1 -->
          <div class="grid grid-cols-2 gap-4 mb-4">
            <div class="agendaarquivo-card p-4">
              <h3 class="font-bold text-slate-700 mb-3 agendaarquivo-section-title">ğŸ“ˆ Volume Mensal (LDM)</h3>
              <div class="agendaarquivo-chart-container">
                <canvas id="agendaArquivoChartVolumeMensal"></canvas>
              </div>
            </div>
            <div class="agendaarquivo-card p-4">
              <h3 class="font-bold text-slate-700 mb-3 agendaarquivo-section-title">ğŸ“Š Grupagens por ArmazÃ©m</h3>
              <div class="agendaarquivo-chart-container">
                <canvas id="agendaArquivoChartPorArmazem"></canvas>
              </div>
            </div>
          </div>

          <!-- GRÃFICOS LINHA 2 -->
          <div class="grid grid-cols-2 gap-4 mb-4">
            <div class="agendaarquivo-card p-4">
              <h3 class="font-bold text-slate-700 mb-3 agendaarquivo-section-title">ğŸ’¶ PreÃ§o MÃ©dio â‚¬/LDM por ArmazÃ©m</h3>
              <div class="agendaarquivo-chart-container">
                <canvas id="agendaArquivoChartPrecoArmazem"></canvas>
              </div>
            </div>
            <div class="agendaarquivo-card p-4">
              <h3 class="font-bold text-slate-700 mb-3 agendaarquivo-section-title">ğŸ’¶ PreÃ§o MÃ©dio â‚¬/LDM por Comercial</h3>
              <div class="agendaarquivo-chart-container">
                <canvas id="agendaArquivoChartPrecoComercial"></canvas>
              </div>
            </div>
          </div>

          <!-- GRÃFICOS LINHA 3 -->
          <div class="grid grid-cols-3 gap-4 mb-4">
            <div class="agendaarquivo-card p-4">
              <h3 class="font-bold text-slate-700 mb-3 agendaarquivo-section-title">ğŸš› Por Tipo Multimodal</h3>
              <div class="agendaarquivo-chart-container">
                <canvas id="agendaArquivoChartMultimodal"></canvas>
              </div>
            </div>
            <div class="agendaarquivo-card p-4">
              <h3 class="font-bold text-slate-700 mb-3 agendaarquivo-section-title">ğŸ‘¥ Top 5 Clientes (Volume)</h3>
              <div class="agendaarquivo-chart-container">
                <canvas id="agendaArquivoChartTopClientes"></canvas>
              </div>
            </div>
            <div class="agendaarquivo-card p-4">
              <h3 class="font-bold text-slate-700 mb-3 agendaarquivo-section-title">ğŸ‘¤ Top 5 Comerciais (Volume)</h3>
              <div class="agendaarquivo-chart-container">
                <canvas id="agendaArquivoChartTopComerciais"></canvas>
              </div>
            </div>
          </div>

          <!-- TABELAS RANKING -->
          <div class="grid grid-cols-3 gap-4">
            <div class="agendaarquivo-card p-4">
              <h3 class="font-bold text-slate-700 mb-3 agendaarquivo-section-title">ğŸ† Ranking ArmazÃ©ns</h3>
              <table class="w-full text-xs">
                <thead class="bg-slate-100">
                  <tr>
                    <th class="p-2 text-left">#</th>
                    <th class="p-2 text-left">ArmazÃ©m</th>
                    <th class="p-2 text-right">LDM</th>
                    <th class="p-2 text-right">â‚¬/LDM</th>
                  </tr>
                </thead>
                <tbody id="agendaArquivoRankingArmazens"></tbody>
              </table>
            </div>
            <div class="agendaarquivo-card p-4">
              <h3 class="font-bold text-slate-700 mb-3 agendaarquivo-section-title">ğŸ† Ranking Comerciais</h3>
              <table class="w-full text-xs">
                <thead class="bg-slate-100">
                  <tr>
                    <th class="p-2 text-left">#</th>
                    <th class="p-2 text-left">Comercial</th>
                    <th class="p-2 text-right">Reservas</th>
                    <th class="p-2 text-right">â‚¬/LDM</th>
                  </tr>
                </thead>
                <tbody id="agendaArquivoRankingComerciais"></tbody>
              </table>
            </div>
            <div class="agendaarquivo-card p-4">
              <h3 class="font-bold text-slate-700 mb-3 agendaarquivo-section-title">ğŸ† Ranking Motoristas</h3>
              <table class="w-full text-xs">
                <thead class="bg-slate-100">
                  <tr>
                    <th class="p-2 text-left">#</th>
                    <th class="p-2 text-left">Motorista</th>
                    <th class="p-2 text-right">Viagens</th>
                    <th class="p-2 text-right">LDM</th>
                  </tr>
                </thead>
                <tbody id="agendaArquivoRankingMotoristas"></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- TAB: SLA / PERFORMANCE -->
        <div id="agendaArquivoContentSLA" class="hidden">
          
          <!-- KPIs SLA -->
          <div class="grid grid-cols-4 gap-4 mb-4">
            <div class="agendaarquivo-card p-4 agendaarquivo-kpi-card">
              <p class="text-xs text-slate-500">âœ… Taxa Sucesso Recolhas</p>
              <p class="text-4xl font-bold text-green-600" id="agendaArquivoKpiSLARecolhas">0%</p>
              <p class="text-xs text-slate-400 mt-1">Meta: 90%</p>
              <div class="w-full bg-slate-200 rounded-full h-2 mt-2">
                <div id="agendaArquivoBarSLARecolhas" class="bg-green-500 h-2 rounded-full" style="width: 0%"></div>
              </div>
            </div>
            <div class="agendaarquivo-card p-4 agendaarquivo-kpi-card">
              <p class="text-xs text-slate-500">âœ… Taxa Sucesso Entregas</p>
              <p class="text-4xl font-bold text-blue-600" id="agendaArquivoKpiSLAEntregas">0%</p>
              <p class="text-xs text-slate-400 mt-1">Meta: 95%</p>
              <div class="w-full bg-slate-200 rounded-full h-2 mt-2">
                <div id="agendaArquivoBarSLAEntregas" class="bg-blue-500 h-2 rounded-full" style="width: 0%"></div>
              </div>
            </div>
            <div class="agendaarquivo-card p-4 agendaarquivo-kpi-card">
              <p class="text-xs text-slate-500">â±ï¸ Desvio MÃ©dio Recolha</p>
              <p class="text-4xl font-bold" id="agendaArquivoKpiDesvioRecolha">0h</p>
              <p class="text-xs text-slate-400 mt-1">Meta: &lt; 2h</p>
            </div>
            <div class="agendaarquivo-card p-4 agendaarquivo-kpi-card">
              <p class="text-xs text-slate-500">â±ï¸ Desvio MÃ©dio Entrega</p>
              <p class="text-4xl font-bold" id="agendaArquivoKpiDesvioEntrega">0h</p>
              <p class="text-xs text-slate-400 mt-1">Meta: &lt; 4h</p>
            </div>
          </div>

          <!-- GRÃFICOS SLA -->
          <div class="grid grid-cols-2 gap-4 mb-4">
            <div class="agendaarquivo-card p-4">
              <h3 class="font-bold text-slate-700 mb-3 agendaarquivo-section-title">ğŸ“ˆ EvoluÃ§Ã£o SLA Recolhas (Mensal)</h3>
              <div class="agendaarquivo-chart-container">
                <canvas id="agendaArquivoChartSLARecolhas"></canvas>
              </div>
            </div>
            <div class="agendaarquivo-card p-4">
              <h3 class="font-bold text-slate-700 mb-3 agendaarquivo-section-title">ğŸ“ˆ EvoluÃ§Ã£o SLA Entregas (Mensal)</h3>
              <div class="agendaarquivo-chart-container">
                <canvas id="agendaArquivoChartSLAEntregas"></canvas>
              </div>
            </div>
          </div>

          <!-- DETALHES SLA -->
          <div class="grid grid-cols-2 gap-4 mb-4">
            <div class="agendaarquivo-card p-4">
              <h3 class="font-bold text-slate-700 mb-3 agendaarquivo-section-title">ğŸ“Š DistribuiÃ§Ã£o Desvios Recolha</h3>
              <div class="agendaarquivo-chart-container">
                <canvas id="agendaArquivoChartDesviosRecolha"></canvas>
              </div>
            </div>
            <div class="agendaarquivo-card p-4">
              <h3 class="font-bold text-slate-700 mb-3 agendaarquivo-section-title">ğŸ“Š DistribuiÃ§Ã£o Desvios Entrega</h3>
              <div class="agendaarquivo-chart-container">
                <canvas id="agendaArquivoChartDesviosEntrega"></canvas>
              </div>
            </div>
          </div>

          <!-- TABELA SLA POR MOTORISTA -->
          <div class="grid grid-cols-2 gap-4">
            <div class="agendaarquivo-card p-4">
              <h3 class="font-bold text-slate-700 mb-3 agendaarquivo-section-title">ğŸ‘¤ SLA por Motorista</h3>
              <table class="w-full text-xs">
                <thead class="bg-slate-100">
                  <tr>
                    <th class="p-2 text-left">Motorista</th>
                    <th class="p-2 text-right">Recolhas</th>
                    <th class="p-2 text-right">% Prazo</th>
                    <th class="p-2 text-right">Entregas</th>
                    <th class="p-2 text-right">% Prazo</th>
                  </tr>
                </thead>
                <tbody id="agendaArquivoTableSLAMotoristas"></tbody>
              </table>
            </div>
            <div class="agendaarquivo-card p-4">
              <h3 class="font-bold text-slate-700 mb-3 agendaarquivo-section-title">ğŸ­ SLA por ArmazÃ©m</h3>
              <table class="w-full text-xs">
                <thead class="bg-slate-100">
                  <tr>
                    <th class="p-2 text-left">ArmazÃ©m</th>
                    <th class="p-2 text-right">Entregas</th>
                    <th class="p-2 text-right">% Prazo</th>
                    <th class="p-2 text-right">Desvio MÃ©dio</th>
                  </tr>
                </thead>
                <tbody id="agendaArquivoTableSLAArmazens"></tbody>
              </table>
            </div>
          </div>
        </div>

      </main>

      <!-- FOOTER -->
      <footer class="bg-slate-800 text-white text-center py-2 text-xs agendaarquivo-no-print">
        ğŸ”’ Agenda Arquivo - Dados Bloqueados | Ãšltima atualizaÃ§Ã£o: <span id="agendaArquivoUltimaAtualizacao">-</span>
      </footer>

    </section>

    <!-- PAGE: CLIENTES -->
    <section id="page-clientes" class="p-8 hidden">
      <div class="clientes-container">
        <div class="clientes-header">
            <div>
                <h1 data-i18n="customers_management">ğŸ‘¥ GestÃ£o de Clientes</h1>
                <p data-i18n="customers_subtitle">Sistema de GestÃ£o LogÃ­stica Global - IntegraÃ§Ã£o SAP</p>
            </div>
            <div class="clientes-header-right">
                <button class="clientes-btn clientes-btn-verde clientes-btn-sm" onclick="clientesReceberDadosSAP()" data-i18n="import_sap">ğŸ“¥ Importar SAP</button>
                <span class="clientes-sap-status" data-i18n="sap_connected">SAP Conectado</span>
                <span class="clientes-module-badge" data-i18n="customers_module">MÃ³dulo Clientes</span>
            </div>
        </div>

        <div class="clientes-nav-tabs">
            <div class="clientes-nav-tab active" onclick="clientesMostrarVista('lista')" data-i18n="customer_list">ğŸ“‹ Lista de Clientes</div>
            <div class="clientes-nav-tab" onclick="clientesMostrarVista('novo')" data-i18n="new_customer">â• Novo Cliente</div>
            <div class="clientes-nav-tab" onclick="clientesMostrarVista('detalhes')" id="clientesTabDetalhes" style="display: none;" data-i18n="details">ğŸ‘ï¸ Detalhes</div>
        </div>

        <div class="clientes-main-content">
            <div id="clientesAlertContainer"></div>

            <!-- VISTA: Lista -->
            <div id="clientesVistaLista" class="clientes-view-section active">
                <div class="clientes-stats-row">
                    <div class="clientes-stat-card" onclick="clientesFiltrarPorContador('todos')" style="cursor: pointer;" title="Clique para ver todos os clientes">
                        <div class="clientes-stat-card-icon">ğŸ‘¥</div>
                        <div class="clientes-stat-card-value" id="clientesStatTotal">0</div>
                        <div class="clientes-stat-card-label" data-i18n="total_customers">Total Clientes</div>
                    </div>
                    <div class="clientes-stat-card" onclick="clientesFiltrarPorContador('ativos')" style="cursor: pointer;" title="Clique para ver clientes ativos">
                        <div class="clientes-stat-card-icon">âœ…</div>
                        <div class="clientes-stat-card-value" id="clientesStatAtivos">0</div>
                        <div class="clientes-stat-card-label" data-i18n="active">Ativos</div>
                    </div>
                    <div class="clientes-stat-card" onclick="clientesFiltrarPorContador('bloqueados')" style="cursor: pointer;" title="Clique para ver clientes bloqueados">
                        <div class="clientes-stat-card-icon">ğŸ”’</div>
                        <div class="clientes-stat-card-value" id="clientesStatBloqueados">0</div>
                        <div class="clientes-stat-card-label" data-i18n="blocked">Bloqueados</div>
                    </div>
                    <div class="clientes-stat-card" onclick="clientesFiltrarPorContador('faturacao')" style="cursor: pointer;" title="Clique para ver clientes ordenados por faturaÃ§Ã£o">
                        <div class="clientes-stat-card-icon">ğŸ’°</div>
                        <div class="clientes-stat-card-value" id="clientesStatFaturacao">â‚¬0</div>
                        <div class="clientes-stat-card-label" data-i18n="annual_revenue">FaturaÃ§Ã£o Anual</div>
                    </div>
                </div>

                <div class="clientes-toolbar">
                    <div class="clientes-search-box" style="position: relative;">
                        <span style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #888;">ğŸ”</span>
                        <input type="text" id="clientesCampoPesquisa" data-i18n-placeholder="search_customer_nif" placeholder="Pesquisar por nÃºmero, nome, NIF, paÃ­s..." 
                               oninput="clientesPesquisar()" onkeyup="clientesPesquisar()" style="padding-left: 35px;">
                    </div>
                    <button class="clientes-btn clientes-btn-azul" onclick="clientesMostrarVista('novo')" data-i18n="new_customer">â• Novo Cliente</button>
                    <button class="clientes-btn clientes-btn-verde" onclick="clientesVerHistoricoEmails()" data-i18n="email_history">ğŸ“§ HistÃ³rico Emails</button>
                    <button class="clientes-btn clientes-btn-laranja" onclick="clientesExportarLista()" data-i18n="export">ğŸ“¥ Exportar</button>
                </div>

                <div class="clientes-table-container">
                    <table class="clientes-table">
                        <thead>
                            <tr>
                                <th data-i18n="customer_number">NÂº Cliente</th>
                                <th data-i18n="name">Nome</th>
                                <th data-i18n="tax_id">NIF</th>
                                <th data-i18n="country">PaÃ­s</th>
                                <th data-i18n="type">Tipo</th>
                                <th data-i18n="credit_limit">Plafond</th>
                                <th data-i18n="status">Estado</th>
                                <th data-i18n="actions">AÃ§Ãµes</th>
                            </tr>
                        </thead>
                        <tbody id="clientesTabelaClientes"></tbody>
                    </table>
                </div>
            </div>

            <!-- VISTA: Novo/Editar -->
            <div id="clientesVistaNovo" class="clientes-view-section">
                <form id="clientesFormCliente" onsubmit="clientesGuardar(event)">
                    
                    <!-- SECÃ‡ÃƒO 1: IdentificaÃ§Ã£o -->
                    <section class="clientes-section-box">
                        <h2 data-i18n="section_customer_identification">ğŸ¢ SecÃ§Ã£o 1 - IdentificaÃ§Ã£o do Cliente</h2>
                        <div style="display: grid; grid-template-columns: 100px 150px 1fr 180px; gap: 12px; margin-bottom: 12px;">
                            <div class="clientes-form-group">
                                <label data-i18n="customer_number">C1 - NÂº Cliente:</label>
                                <input type="text" id="clientes_numero_cliente" disabled style="font-weight: bold; color: #2980b9; text-align: center;">
                            </div>
                            <div class="clientes-form-group">
                                <label>C2 - * NIF:</label>
                                <div class="clientes-input-btn-group">
                                    <input type="text" id="clientes_contribuinte" required maxlength="14" placeholder="NIF" onchange="clientesPesquisarPorNIF()">
                                    <button type="button" class="clientes-btn-azul" onclick="clientesPesquisarPorNIF()" title="Pesquisar">ğŸ”</button>
                                </div>
                            </div>
                            <div class="clientes-form-group">
                                <label>C3 - * Nome Completo:</label>
                                <input type="text" id="clientes_nome_completo" required maxlength="100" placeholder="Nome completo da empresa">
                            </div>
                            <div class="clientes-form-group">
                                <label>C4 - * PaÃ­s: <span id="clientesTipoPaisBadge"></span></label>
                                <select id="clientes_pais" required onchange="clientesReconhecerTipoPais()">
                                    <option value="">Selecione...</option>
                                    <optgroup label="ğŸ‡µğŸ‡¹ Nacional">
                                        <option value="Portugal" data-tipo="nacional">Portugal</option>
                                    </optgroup>
                                    <optgroup label="ğŸ‡ªğŸ‡º UniÃ£o Europeia">
                                        <option value="Espanha" data-tipo="europeu">Espanha</option>
                                        <option value="FranÃ§a" data-tipo="europeu">FranÃ§a</option>
                                        <option value="Alemanha" data-tipo="europeu">Alemanha</option>
                                        <option value="ItÃ¡lia" data-tipo="europeu">ItÃ¡lia</option>
                                        <option value="Holanda" data-tipo="europeu">Holanda</option>
                                        <option value="BÃ©lgica" data-tipo="europeu">BÃ©lgica</option>
                                        <option value="PolÃ³nia" data-tipo="europeu">PolÃ³nia</option>
                                        <option value="Irlanda" data-tipo="europeu">Irlanda</option>
                                    </optgroup>
                                    <optgroup label="ğŸŒ PaÃ­ses Terceiros">
                                        <option value="Reino Unido" data-tipo="terceiro">Reino Unido</option>
                                        <option value="SuÃ­Ã§a" data-tipo="terceiro">SuÃ­Ã§a</option>
                                        <option value="EUA" data-tipo="terceiro">EUA</option>
                                        <option value="Brasil" data-tipo="terceiro">Brasil</option>
                                        <option value="Angola" data-tipo="terceiro">Angola</option>
                                        <option value="Marrocos" data-tipo="terceiro">Marrocos</option>
                                        <option value="China" data-tipo="terceiro">China</option>
                                        <option value="Outro" data-tipo="terceiro">Outro</option>
                                    </optgroup>
                                </select>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 200px; gap: 12px;">
                            <div class="clientes-form-group">
                                <label>5. * Ficha de Abertura:</label>
                                <div class="clientes-input-btn-group">
                                    <input type="text" id="clientes_ficha_abertura_nome" readonly placeholder="Nenhum ficheiro">
                                    <input type="file" id="clientes_ficha_abertura" style="display: none;" onchange="clientesFichaAnexada(this)">
                                    <button type="button" class="clientes-btn-laranja" onclick="document.getElementById('clientes_ficha_abertura').click()">ğŸ“ Anexar</button>
                                    <button type="button" class="clientes-btn-verde" onclick="clientesAbrirFicha()">ğŸ“‚ Abrir</button>
                                </div>
                            </div>
                            <div class="clientes-form-group">
                                <label>C6 - Estado:</label>
                                <div class="clientes-radio-group">
                                    <label class="clientes-radio-wrapper selected">
                                        <input type="radio" name="clientes_status" value="Ativo" checked onchange="clientesAtualizarEstado(this)">
                                        <span>âœ… Ativo</span>
                                    </label>
                                    <label class="clientes-radio-wrapper">
                                        <input type="radio" name="clientes_status" value="Inativo" onchange="clientesAtualizarEstado(this)">
                                        <span>â¸ï¸ Inativo</span>
                                    </label>
                                    <label class="clientes-radio-wrapper">
                                        <input type="radio" name="clientes_status" value="Bloqueado" onchange="clientesAtualizarEstado(this)">
                                        <span>ğŸ”’ Bloqueado</span>
                                    </label>
                                </div>
                            </div>
                            <div class="clientes-form-group">
                                <label>C6 - Saldo em DÃ­vida:</label>
                                <div class="clientes-input-btn-group">
                                    <input type="text" id="clientes_saldo_divida" readonly value="â‚¬ 0.00" style="font-weight: bold; color: #c0392b; cursor: pointer;" onclick="clientesAbrirListagemDividas()">
                                    <button type="button" class="clientes-btn-vermelho" onclick="clientesAbrirListagemDividas()" title="Ver faturas em dÃ­vida">ğŸ“‹</button>
                                </div>
                            </div>
                        </div>
                        <div class="clientes-sap-info">Todos os dados sÃ£o sincronizados automaticamente com SAP. MigraÃ§Ã£o de dados SAP disponÃ­vel.</div>
                    </section>

                    <!-- SECÃ‡ÃƒO 2: Moradas -->
                    <section class="clientes-section-box">
                        <h2>ğŸ“ SecÃ§Ã£o 2 - Moradas</h2>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 15px;">
                            <!-- SEDE -->
                            <div class="clientes-morada-box">
                                <h4>ğŸ¢ Sede</h4>
                                <div style="display: grid; grid-template-columns: 1fr 60px; gap: 8px; margin-bottom: 8px;">
                                    <div class="clientes-form-group"><label>C7 - Rua:</label><input type="text" id="clientes_sede_rua"></div>
                                    <div class="clientes-form-group"><label>C8 - Porta:</label><input type="text" id="clientes_sede_porta"></div>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px;">
                                    <div class="clientes-form-group"><label>C9 - Lugar:</label><input type="text" id="clientes_sede_lugar"></div>
                                    <div class="clientes-form-group"><label>C10 - Cidade:</label><input type="text" id="clientes_sede_cidade"></div>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 80px; gap: 8px; margin-bottom: 8px;">
                                    <div class="clientes-form-group"><label>C11 - Freguesia:</label><input type="text" id="clientes_sede_freguesia"></div>
                                    <div class="clientes-form-group"><label>C12 - CP:</label><input type="text" id="clientes_sede_cp" placeholder="0000-000"></div>
                                </div>
                                <div class="clientes-form-group"><label>C13 - Concelho:</label><input type="text" id="clientes_sede_concelho"></div>
                            </div>

                            <!-- FILIAL -->
                            <div class="clientes-morada-box">
                                <h4>ğŸ­ Filial <button type="button" class="clientes-btn clientes-btn-sm clientes-btn-laranja" onclick="clientesCopiarMorada('sede', 'filial')">ğŸ“‹ Copiar</button></h4>
                                <div style="display: grid; grid-template-columns: 1fr 60px; gap: 8px; margin-bottom: 8px;">
                                    <div class="clientes-form-group"><label>C14 - Rua:</label><input type="text" id="clientes_filial_rua"></div>
                                    <div class="clientes-form-group"><label>C15 - Porta:</label><input type="text" id="clientes_filial_porta"></div>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px;">
                                    <div class="clientes-form-group"><label>C16 - Lugar:</label><input type="text" id="clientes_filial_lugar"></div>
                                    <div class="clientes-form-group"><label>C17 - Cidade:</label><input type="text" id="clientes_filial_cidade"></div>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 80px; gap: 8px; margin-bottom: 8px;">
                                    <div class="clientes-form-group"><label>C18 - Freguesia:</label><input type="text" id="clientes_filial_freguesia"></div>
                                    <div class="clientes-form-group"><label>C19 - CP:</label><input type="text" id="clientes_filial_cp" placeholder="0000-000"></div>
                                </div>
                                <div class="clientes-form-group"><label>C20 - Concelho:</label><input type="text" id="clientes_filial_concelho"></div>
                            </div>

                            <!-- FATURAÃ‡ÃƒO -->
                            <div class="clientes-morada-box">
                                <h4>ğŸ“„ FaturaÃ§Ã£o <button type="button" class="clientes-btn clientes-btn-sm clientes-btn-laranja" onclick="clientesCopiarMorada('sede', 'faturacao')">ğŸ“‹ Copiar</button></h4>
                                <div style="display: grid; grid-template-columns: 1fr 60px; gap: 8px; margin-bottom: 8px;">
                                    <div class="clientes-form-group"><label>C21 - Rua:</label><input type="text" id="clientes_faturacao_rua"></div>
                                    <div class="clientes-form-group"><label>C22 - Porta:</label><input type="text" id="clientes_faturacao_porta"></div>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px;">
                                    <div class="clientes-form-group"><label>C23 - Lugar:</label><input type="text" id="clientes_faturacao_lugar"></div>
                                    <div class="clientes-form-group"><label>C24 - Cidade:</label><input type="text" id="clientes_faturacao_cidade"></div>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 80px; gap: 8px; margin-bottom: 8px;">
                                    <div class="clientes-form-group"><label>C25 - Freguesia:</label><input type="text" id="clientes_faturacao_freguesia"></div>
                                    <div class="clientes-form-group"><label>C26 - CP:</label><input type="text" id="clientes_faturacao_cp" placeholder="0000-000"></div>
                                </div>
                                <div class="clientes-form-group"><label>C27 - Concelho:</label><input type="text" id="clientes_faturacao_concelho"></div>
                            </div>
                        </div>
                        <!-- Contactos -->
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
                            <div class="clientes-form-group"><label>C28 - Telefone Geral:</label><input type="tel" id="clientes_telefone_geral" placeholder="+351 000 000 000"></div>
                            <div class="clientes-form-group"><label>C29 - Email Geral:</label><input type="email" id="clientes_email_geral" placeholder="geral@empresa.pt"></div>
                            <div class="clientes-form-group"><label>C30 - Fax:</label><input type="tel" id="clientes_fax"></div>
                        </div>
                    </section>

                    <!-- SECÃ‡ÃƒO 3: ResponsÃ¡veis -->
                    <section class="clientes-section-box">
                        <h2>ğŸ‘¤ SecÃ§Ã£o 3 - ResponsÃ¡veis</h2>
                        <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 10px;">
                            <div class="clientes-responsavel-box">
                                <h4>ğŸ‘” Dono/Gerente</h4>
                                <div class="clientes-form-group" style="margin-bottom: 6px;"><label>C31 - Nome:</label><input type="text" id="clientes_resp_dono_nome"></div>
                                <div class="clientes-form-group" style="margin-bottom: 6px;"><label>C32 - Email:</label><input type="email" id="clientes_resp_dono_email"></div>
                                <div class="clientes-form-group"><label>C33 - TelemÃ³vel:</label><input type="tel" id="clientes_resp_dono_telemovel"></div>
                            </div>
                            <div class="clientes-responsavel-box">
                                <h4>ğŸ“ Contacto</h4>
                                <div class="clientes-form-group" style="margin-bottom: 6px;"><label>C34 - Nome:</label><input type="text" id="clientes_resp_contacto_nome"></div>
                                <div class="clientes-form-group" style="margin-bottom: 6px;"><label>C35 - Email:</label><input type="email" id="clientes_resp_contacto_email"></div>
                                <div class="clientes-form-group"><label>C36 - Telefone:</label><input type="tel" id="clientes_resp_contacto_telefone"></div>
                            </div>
                            <div class="clientes-responsavel-box">
                                <h4>ğŸ’¼ Comercial</h4>
                                <div class="clientes-form-group" style="margin-bottom: 6px;"><label>C37 - Nome:</label><input type="text" id="clientes_resp_comercial_nome"></div>
                                <div class="clientes-form-group" style="margin-bottom: 6px;"><label>C38 - Email:</label><input type="email" id="clientes_resp_comercial_email"></div>
                                <div class="clientes-form-group"><label>C39 - Telefone:</label><input type="tel" id="clientes_resp_comercial_telefone"></div>
                            </div>
                            <div class="clientes-responsavel-box">
                                <h4>ğŸ“Š Contabilidade</h4>
                                <div class="clientes-form-group" style="margin-bottom: 6px;"><label>C40 - Nome:</label><input type="text" id="clientes_resp_contabilidade_nome"></div>
                                <div class="clientes-form-group" style="margin-bottom: 6px;"><label>C41 - Email:</label><input type="email" id="clientes_resp_contabilidade_email"></div>
                                <div class="clientes-form-group"><label>C42 - Telefone:</label><input type="tel" id="clientes_resp_contabilidade_telefone"></div>
                            </div>
                            <div class="clientes-responsavel-box">
                                <h4>ğŸ’° Financeiro</h4>
                                <div class="clientes-form-group" style="margin-bottom: 6px;"><label>C43 - Nome:</label><input type="text" id="clientes_resp_financeiro_nome"></div>
                                <div class="clientes-form-group" style="margin-bottom: 6px;"><label>C44 - Email:</label><input type="email" id="clientes_resp_financeiro_email"></div>
                                <div class="clientes-form-group"><label>C45 - Telefone:</label><input type="tel" id="clientes_resp_financeiro_telefone"></div>
                            </div>
                            <div class="clientes-responsavel-box">
                                <h4>ğŸšš LogÃ­stica</h4>
                                <div class="clientes-form-group" style="margin-bottom: 6px;"><label>C46 - Nome:</label><input type="text" id="clientes_resp_logistica_nome"></div>
                                <div class="clientes-form-group" style="margin-bottom: 6px;"><label>C47 - Email:</label><input type="email" id="clientes_resp_logistica_email"></div>
                                <div class="clientes-form-group"><label>C48 - Telefone:</label><input type="tel" id="clientes_resp_logistica_telefone"></div>
                            </div>
                        </div>
                    </section>

                    <!-- SECÃ‡ÃƒO 4: CondiÃ§Ãµes Comerciais -->
                    <section class="clientes-section-box">
                        <h2>ğŸ’¼ SecÃ§Ã£o 4 - CondiÃ§Ãµes Comerciais</h2>
                        <div style="display: grid; grid-template-columns: 120px 150px 100px 100px 100px 80px 100px 1fr; gap: 10px; margin-bottom: 12px;">
                            <div class="clientes-form-group"><label>C49 - Plafonds (â‚¬):</label><input type="number" id="clientes_plafonds_atribuidos" step="0.01" value="0"></div>
                            <div class="clientes-form-group"><label>C50 - Pessoa que Atribui:</label><input type="text" id="clientes_quem_atribui_plafonds"></div>
                            <div class="clientes-form-group"><label>C51 - Prazo (dias):</label><input type="number" id="clientes_prazo_pagamento_dias" value="30" style="width: 100%;"></div>
                            <div class="clientes-form-group"><label>C52 - * Modo Fat.:</label><select id="clientes_modo_faturacao" required style="width: 100%;"><option value="AutomÃ¡tica">AutomÃ¡tica</option><option value="Manual">Manual</option></select></div>
                            <div class="clientes-form-group"><label>C53 - Fat. Mensal (â‚¬):</label><input type="number" id="clientes_faturacao_prevista_mensal" step="0.01" required></div>
                            <div class="clientes-form-group"><label>C54 - Desc. (%):</label><input type="number" id="clientes_percentagem_desc" step="0.01" value="0"></div>
                            <div class="clientes-form-group"><label>C55 - Desc. Fatura:</label><select id="clientes_desconto_na_fatura"><option value="NÃ£o">NÃ£o</option><option value="Sim">Sim (P/P)</option></select></div>
                            <div class="clientes-form-group"><label>C56 - * NÂº Conta Banco:</label><input type="text" id="clientes_num_conta_bancaria" required placeholder="IBAN"></div>
                        </div>
                        <div style="display: grid; grid-template-columns: 100px 150px 80px 1fr auto auto; gap: 10px; align-items: end;">
                            <div class="clientes-form-group"><label>C57 - * Angariador:</label><input type="text" id="clientes_nome_angariador" required></div>
                            <div class="clientes-form-group"><label>C58 - Anexos Seguro:</label>
                                <div class="clientes-input-btn-group">
                                    <input type="text" id="clientes_anexos_seguro_nome" readonly placeholder="Nenhum" style="font-size: 11px;">
                                    <input type="file" id="clientes_anexos_seguro" style="display: none;" multiple onchange="clientesSeguroAnexado(this)">
                                    <button type="button" class="clientes-btn-laranja" onclick="document.getElementById('clientes_anexos_seguro').click()" style="padding: 6px 8px;">ğŸ“</button>
                                    <button type="button" class="clientes-btn-verde" onclick="clientesAbrirAnexosSeguro()" style="padding: 6px 8px;">ğŸ“‚</button>
                                </div>
                            </div>
                            <div class="clientes-form-group">
                                <label>59. Aceita PP:</label>
                                <label class="clientes-checkbox-inline" style="padding: 6px 8px;">
                                    <input type="checkbox" id="clientes_aceita_desc_pp">
                                    <span>Sim</span>
                                </label>
                            </div>
                            <div class="clientes-form-group"><label>C60 - IncidÃªncias:</label><input type="text" id="clientes_incidencias" placeholder="Notas de incidÃªncias..."></div>
                            <div class="clientes-form-group" style="margin-bottom: 0;">
                                <label>&nbsp;</label>
                                <input type="file" id="clientes_incidencias_ficheiro" style="display: none;" onchange="clientesIncidenciaAnexada(this)">
                                <button type="button" class="clientes-btn clientes-btn-laranja clientes-btn-sm" onclick="document.getElementById('clientes_incidencias_ficheiro').click()">ğŸ“ Anexar</button>
                            </div>
                            <div class="clientes-form-group" style="margin-bottom: 0;">
                                <label>&nbsp;</label>
                                <button type="button" class="clientes-btn clientes-btn-verde clientes-btn-sm" onclick="clientesAbrirIncidencias()">ğŸ“‚ Abrir</button>
                            </div>
                        </div>
                    </section>

                    <!-- SECÃ‡ÃƒO 5: Contabilidade e ObservaÃ§Ãµes -->
                    <section class="clientes-section-box">
                        <h2>ğŸ“Š SecÃ§Ã£o 5 - Contabilidade e ObservaÃ§Ãµes</h2>
                        <div style="display: grid; grid-template-columns: 120px 120px 120px 120px 150px 100px 100px; gap: 10px; margin-bottom: 12px;">
                            <div class="clientes-form-group"><label>C61 - Conta Contab. 1:</label><input type="text" id="clientes_conta_contab_1"></div>
                            <div class="clientes-form-group"><label>C62 - Conta Contab. 2:</label><input type="text" id="clientes_conta_contab_2"></div>
                            <div class="clientes-form-group"><label>C63 - Conta Contab. 3:</label><input type="text" id="clientes_conta_contab_3"></div>
                            <div class="clientes-form-group"><label>C64 - Conta Contab. 4:</label><input type="text" id="clientes_conta_contab_4"></div>
                            <div class="clientes-form-group"><label>C65 - * Conta SAP:</label><input type="text" id="clientes_conta_sap" required style="font-weight: bold; color: #27ae60;"></div>
                            <div class="clientes-form-group"><label>C66 - Val. Fat. Ano:</label><input type="text" id="clientes_valor_faturado_ano" readonly value="â‚¬ 0.00" style="font-weight: bold; color: #27ae60; font-size: 12px;"></div>
                            <div class="clientes-form-group">
                                <label>67. Cliente Login:</label>
                                <label class="clientes-checkbox-inline" style="border-color: #27ae60;">
                                    <input type="checkbox" id="clientes_cliente_com_login" onchange="clientesVerificarLogin()">
                                    <span>ğŸ” Ativo</span>
                                </label>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <div class="clientes-form-group"><label>C68 - ObservaÃ§Ãµes:</label><textarea id="clientes_observacoes" rows="2" placeholder="Notas adicionais..."></textarea></div>
                            <div class="clientes-form-group"><label>69. Anexos Gerais:</label>
                                <div class="clientes-input-btn-group">
                                    <input type="text" id="clientes_anexos_gerais_nome" readonly placeholder="Nenhum ficheiro anexado">
                                    <input type="file" id="clientes_anexos_gerais" style="display: none;" multiple onchange="clientesAnexosGeraisCarregados(this)">
                                    <button type="button" class="clientes-btn-laranja" onclick="document.getElementById('clientes_anexos_gerais').click()">ğŸ“ Anexar</button>
                                    <button type="button" class="clientes-btn-verde" onclick="clientesAbrirAnexosGerais()">ğŸ“‚ Abrir</button>
                                </div>
                            </div>
                        </div>
                        <div class="clientes-sap-info">Todos os movimentos contabilÃ­sticos e dados sÃ£o enviados automaticamente para SAP</div>
                    </section>

                    <div class="clientes-form-actions">
                        <button type="button" class="clientes-btn-cancelar" onclick="clientesSairFicha()" style="background:#6c757d;color:white;">âŒ Voltar Ã  Lista</button>
                        <button type="button" id="btnClientesAlterar" class="clientes-btn-alterar" onclick="clientesDesbloquearCampos()" style="display:none;">âœï¸ Alterar Cliente</button>
                        <button type="submit" id="btnClientesGuardar" class="clientes-btn-guardar" style="display:none;">ğŸ’¾ Guardar Cliente</button>
                    </div>
                </form>
            </div>

            <!-- VISTA: Detalhes -->
            <div id="clientesVistaDetalhes" class="clientes-view-section">
                <div id="clientesConteudoDetalhes"></div>
            </div>
        </div>
      </div>

      <!-- Modal ConfirmaÃ§Ã£o Eliminar -->
      <div class="clientes-modal-overlay" id="clientesModalConfirmacao">
        <div class="clientes-modal-content">
            <h3 style="color: #c0392b; margin-bottom: 15px;">âš ï¸ Confirmar EliminaÃ§Ã£o</h3>
            <p id="clientesModalMensagem" style="margin-bottom: 20px;">Eliminar este cliente?</p>
            <div style="display: flex; gap: 10px; justify-content: center;">
                <button class="clientes-btn clientes-btn-secondary" onclick="clientesFecharModal()" style="background: #e9ecef; color: #495057;">Cancelar</button>
                <button class="clientes-btn clientes-btn-vermelho" onclick="clientesConfirmarEliminacao()">ğŸ—‘ï¸ Eliminar</button>
            </div>
        </div>
      </div>

      <!-- Modal Listagem DÃ­vidas -->
      <div class="clientes-modal-overlay" id="clientesModalDividas">
        <div class="clientes-modal-content" style="max-width: 900px; text-align: left; max-height: 90vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3 style="color: #1e3c72;">ğŸ“‹ Faturas em DÃ­vida</h3>
                <button type="button" onclick="clientesFecharModalDividas()" style="background: none; border: none; font-size: 20px; cursor: pointer;">Ã—</button>
            </div>
            <div style="background: #f8f9fa; padding: 12px; border-radius: 8px; margin-bottom: 12px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <strong>Cliente:</strong> <span id="clientesDividaClienteNome">-</span><br>
                        <strong>NIF:</strong> <span id="clientesDividaClienteNIF">-</span> | <strong>PaÃ­s:</strong> <span id="clientesDividaClientePais">-</span>
                    </div>
                    <div style="text-align: right;">
                        <strong style="font-size: 16px; color: #c0392b;">Total em DÃ­vida: <span id="clientesDividaTotalValor">â‚¬ 0.00</span></strong>
                    </div>
                </div>
            </div>
            <div style="max-height: 150px; overflow-y: auto; margin-bottom: 12px; border: 1px solid #dee2e6; border-radius: 8px;">
                <table style="width: 100%; border-collapse: collapse; font-size: 11px;">
                    <thead style="background: #1e3c72; color: white; position: sticky; top: 0;">
                        <tr>
                            <th style="padding: 6px; text-align: left;">Data</th>
                            <th style="padding: 6px; text-align: left;">NÂº Fatura</th>
                            <th style="padding: 6px; text-align: left;">DescriÃ§Ã£o</th>
                            <th style="padding: 6px; text-align: right;">Valor</th>
                            <th style="padding: 6px; text-align: left;">Vencimento</th>
                            <th style="padding: 6px; text-align: center;">Atraso</th>
                        </tr>
                    </thead>
                    <tbody id="clientesTabelaDividas"></tbody>
                </table>
            </div>
            <div style="text-align: right;">
                <button class="clientes-btn clientes-btn-azul clientes-btn-sm" onclick="clientesFecharModalDividas()">Fechar</button>
            </div>
        </div>
      </div>

      <!-- Modal HistÃ³rico de Emails -->
      <div class="clientes-modal-overlay" id="clientesModalHistoricoEmails">
        <div class="clientes-modal-content" style="max-width: 1000px; text-align: left; max-height: 90vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3 style="color: #27ae60;">ğŸ“§ HistÃ³rico de Emails Enviados</h3>
                <button type="button" onclick="clientesFecharModalHistoricoEmails()" style="background: none; border: none; font-size: 20px; cursor: pointer;">Ã—</button>
            </div>
            <div style="background: #f8f9fa; padding: 12px; border-radius: 8px; margin-bottom: 12px;">
                <div style="display: flex; gap: 10px; align-items: center;">
                    <input type="text" id="clientesPesquisaEmails" placeholder="Pesquisar por cliente, assunto ou destinatÃ¡rio..." 
                           style="flex: 1; padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px;" onkeyup="clientesFiltrarHistoricoEmails()">
                    <select id="clientesFiltroTipoEmail" onchange="clientesFiltrarHistoricoEmails()" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px;">
                        <option value="">Todos os tipos</option>
                        <option value="Fatura">ğŸ“„ Faturas</option>
                        <option value="CMR">ğŸš› CMR</option>
                        <option value="CobranÃ§a">ğŸ’° CobranÃ§as</option>
                        <option value="NotificaÃ§Ã£o">ğŸ”” NotificaÃ§Ãµes</option>
                    </select>
                </div>
            </div>
            <div style="max-height: 400px; overflow-y: auto; margin-bottom: 12px; border: 1px solid #dee2e6; border-radius: 8px;">
                <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                    <thead style="background: #27ae60; color: white; position: sticky; top: 0;">
                        <tr>
                            <th style="padding: 8px; text-align: left;">Data/Hora</th>
                            <th style="padding: 8px; text-align: left;">Cliente</th>
                            <th style="padding: 8px; text-align: left;">DestinatÃ¡rio</th>
                            <th style="padding: 8px; text-align: left;">Tipo</th>
                            <th style="padding: 8px; text-align: left;">Assunto</th>
                            <th style="padding: 8px; text-align: center;">Estado</th>
                            <th style="padding: 8px; text-align: center;">AÃ§Ãµes</th>
                        </tr>
                    </thead>
                    <tbody id="clientesTabelaHistoricoEmails"></tbody>
                </table>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <span id="clientesContadorEmails" style="color: #666; font-size: 12px;">0 emails</span>
                <button class="clientes-btn clientes-btn-azul clientes-btn-sm" onclick="clientesFecharModalHistoricoEmails()">Fechar</button>
            </div>
        </div>
      </div>

      <!-- Modal Clientes Filtrados -->
      <div class="clientes-modal-overlay" id="clientesModalFiltrados">
        <div class="clientes-modal-content" style="max-width: 900px; text-align: left; max-height: 90vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3 id="clientesTituloFiltrados" style="color: #1e3c72;">ğŸ“‹ Clientes</h3>
                <button type="button" onclick="clientesFecharModalFiltrados()" style="background: none; border: none; font-size: 20px; cursor: pointer;">Ã—</button>
            </div>
            <div style="max-height: 450px; overflow-y: auto; margin-bottom: 12px; border: 1px solid #dee2e6; border-radius: 8px;">
                <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                    <thead style="background: #1e3c72; color: white; position: sticky; top: 0;">
                        <tr>
                            <th style="padding: 8px; text-align: left;">NÂº Cliente</th>
                            <th style="padding: 8px; text-align: left;">Nome</th>
                            <th style="padding: 8px; text-align: left;">NIF</th>
                            <th style="padding: 8px; text-align: left;">PaÃ­s</th>
                            <th style="padding: 8px; text-align: right;">Plafond</th>
                            <th style="padding: 8px; text-align: right;">FaturaÃ§Ã£o</th>
                            <th style="padding: 8px; text-align: center;">Estado</th>
                        </tr>
                    </thead>
                    <tbody id="clientesTabelaFiltrados"></tbody>
                </table>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <span id="clientesContadorFiltrados" style="color: #666; font-size: 12px;">0 clientes</span>
                <button class="clientes-btn clientes-btn-azul clientes-btn-sm" onclick="clientesFecharModalFiltrados()">Fechar</button>
            </div>
        </div>
      </div>
    </section>

    <!-- PAGE: FORNECEDORES -->
    <section id="page-fornecedores" class="p-8 hidden">
      <div class="card">
        <div class="card-header">
          <h3 class="font-bold text-lg text-slate-800">ğŸ­ GestÃ£o de Fornecedores</h3>
        </div>
        <div class="card-body">
          <div class="bg-purple-50 border border-purple-200 rounded-lg p-8 text-center">
            <span class="text-6xl mb-4 block">ğŸš§</span>
            <h4 class="text-xl font-bold text-purple-800 mb-2">MÃ³dulo em Desenvolvimento</h4>
            <p class="text-purple-700">GestÃ£o completa de fornecedores.</p>
            <p class="text-purple-600 text-sm mt-2">Funcionalidades previstas:</p>
            <ul class="text-purple-600 text-sm mt-2 space-y-1">
              <li>â€¢ Ficha completa de fornecedor</li>
              <li>â€¢ GestÃ£o de pagamentos a fornecedores</li>
              <li>â€¢ Notas de dÃ©bito</li>
              <li>â€¢ HistÃ³rico de transacÃ§Ãµes</li>
            </ul>
          </div>
        </div>
      </div>
    </section>

    <!-- PAGE: CONTABILIDADE -->
    <section id="page-contabilidade" class="p-8 hidden">
      <div class="card">
        <div class="card-header">
          <h3 class="font-bold text-lg text-slate-800">ğŸ“š Contabilidade</h3>
        </div>
        <div class="card-body">
          <div class="bg-indigo-50 border border-indigo-200 rounded-lg p-8 text-center">
            <span class="text-6xl mb-4 block">ğŸš§</span>
            <h4 class="text-xl font-bold text-indigo-800 mb-2">MÃ³dulo em Desenvolvimento</h4>
            <p class="text-indigo-700">MÃ³dulo de contabilidade e exportaÃ§Ãµes fiscais.</p>
            <p class="text-indigo-600 text-sm mt-2">Funcionalidades previstas:</p>
            <ul class="text-indigo-600 text-sm mt-2 space-y-1">
              <li>â€¢ ExportaÃ§Ã£o SAF-T (PT)</li>
              <li>â€¢ RelatÃ³rios de IVA</li>
              <li>â€¢ Mapas recapitulativos</li>
              <li>â€¢ IntegraÃ§Ã£o com software de contabilidade</li>
              <li>â€¢ Listagem de descontos por fatura/reserva/motivo</li>
            </ul>
          </div>
        </div>
      </div>
    </section>

    <!-- PAGE: RH -->
    <section id="page-rh" class="p-8 hidden">
      <div class="card">
        <div class="card-header">
          <h3 class="font-bold text-lg text-slate-800">ğŸ‘· Recursos Humanos</h3>
        </div>
        <div class="card-body">
          <div class="bg-orange-50 border border-orange-200 rounded-lg p-8 text-center">
            <span class="text-6xl mb-4 block">ğŸš§</span>
            <h4 class="text-xl font-bold text-orange-800 mb-2">MÃ³dulo em Desenvolvimento</h4>
            <p class="text-orange-700">GestÃ£o de recursos humanos.</p>
            <p class="text-orange-600 text-sm mt-2">Funcionalidades previstas:</p>
            <ul class="text-orange-600 text-sm mt-2 space-y-1">
              <li>â€¢ Ficha de funcionÃ¡rio</li>
              <li>â€¢ GestÃ£o de motoristas</li>
              <li>â€¢ Controlo de documentos (carta conduÃ§Ã£o, CAM, etc.)</li>
              <li>â€¢ GestÃ£o de fÃ©rias e ausÃªncias</li>
              <li>â€¢ Vencimentos e ajudas de custo</li>
            </ul>
          </div>
        </div>
      </div>
    </section>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <!-- NOVOS MÃ“DULOS - PLACEHOLDERS v5.0                                                    -->
    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->

    <!-- PAGE: UTILIZADORES -->
        <!-- PAGE: UTILIZADORES -->
    <section id="page-utilizadores" class="p-4 hidden">
      <div class="admin-container">
        <!-- Header -->
        <div class="admin-header admin-header-utilizadores">
          <div>
            <h2>ğŸ‘¤ GestÃ£o de Utilizadores</h2>
            <p>Criar e gerir utilizadores do sistema</p>
          </div>
          <button class="admin-btn-novo" onclick="adminUtilizadoresNovo()">
            <span>â•</span> Novo Utilizador
          </button>
        </div>
        
        <!-- KPIs -->
        <div class="admin-kpis">
          <div class="admin-kpi-card">
            <div class="admin-kpi-icon blue">ğŸ‘¥</div>
            <div class="admin-kpi-info">
              <h4>Total Utilizadores</h4>
              <p class="valor" id="adminUsrKpiTotal">0</p>
            </div>
          </div>
          <div class="admin-kpi-card">
            <div class="admin-kpi-icon green">âœ…</div>
            <div class="admin-kpi-info">
              <h4>Ativos</h4>
              <p class="valor" id="adminUsrKpiAtivos">0</p>
            </div>
          </div>
          <div class="admin-kpi-card">
            <div class="admin-kpi-icon red">ğŸ”’</div>
            <div class="admin-kpi-info">
              <h4>Bloqueados</h4>
              <p class="valor" id="adminUsrKpiBloqueados">0</p>
            </div>
          </div>
        </div>
        
        <!-- Card Principal -->
        <div class="admin-card">
          <div class="admin-toolbar">
            <div class="admin-search">
              <input type="text" id="adminUsrPesquisa" placeholder="Pesquisar utilizadores..." onkeyup="adminUtilizadoresFiltrar()">
            </div>
            <select class="admin-filter" id="adminUsrFiltroEstado" onchange="adminUtilizadoresFiltrar()">
              <option value="">Todos os estados</option>
              <option value="Ativo">âœ… Ativo</option>
              <option value="Inativo">â¸ï¸ Inativo</option>
              <option value="Bloqueado">ğŸ”’ Bloqueado</option>
            </select>
            <select class="admin-filter" id="adminUsrFiltroPerfil" onchange="adminUtilizadoresFiltrar()">
              <option value="">Todos os perfis</option>
              <option value="Administrador">ğŸ‘‘ Administrador</option>
              <option value="Gestor">ğŸ“Š Gestor</option>
              <option value="Diretor LogÃ­stica">ğŸš› Diretor/a Dept. LogÃ­stica</option>
              <option value="Comercial Gestor LogÃ­stica">ğŸ’¼ Comercial Gestor LogÃ­stica</option>
              <option value="Gestor ArmazÃ©m">ğŸ¢ Gestor ArmazÃ©m</option>
              <option value="Departamento Financeiro">ğŸ’° Dept. Financeiro</option>
              <option value="ResponsÃ¡vel Equipamento">ğŸ”§ Resp. Equipamento</option>
              <option value="EscriturÃ¡rio">ğŸ“ EscriturÃ¡rio/a</option>
              <option value="Departamento Contabilidade">ğŸ“š Dept. Contabilidade</option>
              <option value="Departamento RH">ğŸ‘¥ Dept. RH</option>
              <option value="Comercial">ğŸ’¼ Comercial</option>
              <option value="Operador LogÃ­stica">ğŸ“¦ Operador LogÃ­stica</option>
              <option value="FaturaÃ§Ã£o">ğŸ’° FaturaÃ§Ã£o</option>
              <option value="VisualizaÃ§Ã£o">ğŸ‘ï¸ VisualizaÃ§Ã£o</option>
            </select>
            <span class="admin-counter" id="adminUsrContador">0 registos</span>
          </div>
          
          <div class="admin-table-container">
            <table class="admin-table" id="adminUsrTabela">
              <thead>
                <tr>
                  <th>Username</th>
                  <th>Nome</th>
                  <th>Perfil</th>
                  <th>Departamento</th>
                  <th>Password</th>
                  <th>Estado</th>
                  <th>AÃ§Ãµes</th>
                </tr>
              </thead>
              <tbody id="adminUsrTabelaBody">
                <!-- Dados dinÃ¢micos -->
              </tbody>
            </table>
          </div>
          
          <div class="admin-empty" id="adminUsrEmpty" style="display:none;">
            <div class="admin-empty-icon">ğŸ‘¤</div>
            <h4>Nenhum utilizador encontrado</h4>
            <p>Clique em "Novo Utilizador" para adicionar o primeiro</p>
          </div>
        </div>
      </div>
      
      <!-- Modal Utilizador -->
      <div class="admin-modal" id="adminUsrModal">
        <div class="admin-modal-content">
          <div class="admin-modal-header">
            <h3 id="adminUsrModalTitulo">ğŸ‘¤ Novo Utilizador</h3>
            <button class="admin-modal-close" onclick="adminUtilizadoresFecharModal()">âœ•</button>
          </div>
          <div class="admin-modal-body">
            <input type="hidden" id="adminUsrId">
            
            <div class="admin-form-row">
              <div class="admin-form-group">
                <label>Username <span class="required">*</span></label>
                <input type="text" id="adminUsrUsername" placeholder="Ex: joao.silva" oninput="this.value=this.value.toLowerCase()">
              </div>
              <div class="admin-form-group">
                <label>Password <span class="required">*</span></label>
                <div class="input-with-btn">
                  <input type="password" id="adminUsrPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                  <button type="button" onclick="adminTogglePassword('adminUsrPassword', this)" title="Mostrar/Esconder">ğŸ‘ï¸</button>
                  <button type="button" onclick="adminGerarPassword()" title="Gerar Password">ğŸ²</button>
                </div>
              </div>
            </div>
            
            <div class="admin-form-row">
              <div class="admin-form-group">
                <label>Nome Completo <span class="required">*</span></label>
                <input type="text" id="adminUsrNome" placeholder="Nome completo">
              </div>
              <div class="admin-form-group">
                <label>Email <span class="required">*</span></label>
                <input type="email" id="adminUsrEmail" placeholder="email@empresa.pt">
              </div>
            </div>
            
            <div class="admin-form-row">
              <div class="admin-form-group">
                <label>Telefone</label>
                <input type="text" id="adminUsrTelefone" placeholder="+351 000 000 000">
              </div>
              <div class="admin-form-group">
                <label>Idioma <span class="required">*</span></label>
                <select id="adminUsrIdioma">
                  <option value="pt">ğŸ‡µğŸ‡¹ PortuguÃªs</option>
                  <option value="en">ğŸ‡¬ğŸ‡§ English</option>
                  <option value="es">ğŸ‡ªğŸ‡¸ EspaÃ±ol</option>
                  <option value="fr">ğŸ‡«ğŸ‡· FranÃ§ais</option>
                  <option value="de">ğŸ‡©ğŸ‡ª Deutsch</option>
                  <option value="it">ğŸ‡®ğŸ‡¹ Italiano</option>
                  <option value="nl">ğŸ‡³ğŸ‡± Nederlands</option>
                  <option value="pl">ğŸ‡µğŸ‡± Polski</option>
                  <option value="ro">ğŸ‡·ğŸ‡´ RomÃ¢nÄƒ</option>
                  <option value="bg">ğŸ‡§ğŸ‡¬ Ğ‘ÑŠĞ»Ğ³Ğ°Ñ€ÑĞºĞ¸</option>
                  <option value="cs">ğŸ‡¨ğŸ‡¿ ÄŒeÅ¡tina</option>
                  <option value="hu">ğŸ‡­ğŸ‡º Magyar</option>
                  <option value="el">ğŸ‡¬ğŸ‡· Î•Î»Î»Î·Î½Î¹ÎºÎ¬</option>
                  <option value="sv">ğŸ‡¸ğŸ‡ª Svenska</option>
                  <option value="da">ğŸ‡©ğŸ‡° Dansk</option>
                  <option value="fi">ğŸ‡«ğŸ‡® Suomi</option>
                  <option value="no">ğŸ‡³ğŸ‡´ Norsk</option>
                  <option value="hr">ğŸ‡­ğŸ‡· Hrvatski</option>
                  <option value="sk">ğŸ‡¸ğŸ‡° SlovenÄina</option>
                  <option value="sl">ğŸ‡¸ğŸ‡® SlovenÅ¡Äina</option>
                  <option value="lt">ğŸ‡±ğŸ‡¹ LietuviÅ³</option>
                  <option value="lv">ğŸ‡±ğŸ‡» LatvieÅ¡u</option>
                  <option value="et">ğŸ‡ªğŸ‡ª Eesti</option>
                  <option value="uk">ğŸ‡ºğŸ‡¦ Ğ£ĞºÑ€Ğ°Ñ—Ğ½ÑÑŒĞºĞ°</option>
                  <option value="ru">ğŸ‡·ğŸ‡º Ğ ÑƒÑÑĞºĞ¸Ğ¹</option>
                  <option value="tr">ğŸ‡¹ğŸ‡· TÃ¼rkÃ§e</option>
                  <option value="ar">ğŸ‡¸ğŸ‡¦ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
                  <option value="zh">ğŸ‡¨ğŸ‡³ ä¸­æ–‡</option>
                  <option value="ja">ğŸ‡¯ğŸ‡µ æ—¥æœ¬èª</option>
                  <option value="ko">ğŸ‡°ğŸ‡· í•œêµ­ì–´</option>
                </select>
              </div>
            </div>
            
            <div class="admin-form-row">
              <div class="admin-form-group">
                <label data-i18n="profile_type">Perfil/Tipo <span class="required">*</span></label>
                <select id="adminUsrPerfil">
                  <option value="Administrador" data-i18n="profile_admin">ğŸ‘‘ Administrador</option>
                  <option value="Gestor">ğŸ“Š Gestor</option>
                  <option value="Diretor LogÃ­stica" data-i18n="profile_dir_logistica">ğŸš› Diretor/a Departamento de LogÃ­stica</option>
                  <option value="Comercial Gestor LogÃ­stica" data-i18n="profile_comercial_logistica">ğŸ’¼ Comercial Gestor de LogÃ­stica</option>
                  <option value="Gestor ArmazÃ©m">ğŸ¢ Gestor ArmazÃ©m</option>
                  <option value="Departamento Financeiro" data-i18n="profile_financeiro">ğŸ’° Departamento Financeiro</option>
                  <option value="ResponsÃ¡vel Equipamento" data-i18n="profile_resp_equipamento">ğŸ”§ ResponsÃ¡vel de Equipamento</option>
                  <option value="EscriturÃ¡rio" data-i18n="profile_escriturario">ğŸ“ EscriturÃ¡rio/a</option>
                  <option value="Departamento Contabilidade" data-i18n="profile_contabilidade">ğŸ“š Departamento Contabilidade</option>
                  <option value="Departamento RH" data-i18n="profile_rh">ğŸ‘¥ Departamento RH</option>
                  <option value="Comercial">ğŸ’¼ Comercial</option>
                  <option value="Operador LogÃ­stica">ğŸ“¦ Operador LogÃ­stica</option>
                  <option value="FaturaÃ§Ã£o">ğŸ’° FaturaÃ§Ã£o</option>
                  <option value="VisualizaÃ§Ã£o">ğŸ‘ï¸ VisualizaÃ§Ã£o</option>
                </select>
              </div>
              <div class="admin-form-group">
                <label data-i18n="department">Departamento <span class="required">*</span></label>
                <select id="adminUsrDepartamento">
                  <option value="" data-i18n="no_department">-- Selecione --</option>
                  <option value="Departamento Contabilidade" data-i18n="dept_contabilidade">ğŸ“š Departamento Contabilidade</option>
                  <option value="Departamento LogÃ­stica" data-i18n="dept_logistica">ğŸš› Departamento LogÃ­stica</option>
                  <option value="Departamento Financeiro" data-i18n="dept_financeiro">ğŸ’° Departamento Financeiro</option>
                  <option value="Departamento Administrativo" data-i18n="dept_administrativo">ğŸ¢ Departamento Administrativo</option>
                  <option value="Departamento ManutenÃ§Ã£o" data-i18n="dept_manutencao">ğŸ”§ Departamento ManutenÃ§Ã£o</option>
                  <option value="Departamento Motoristas" data-i18n="dept_motoristas">ğŸšš Departamento de Motoristas</option>
                </select>
              </div>
            </div>
            
            <div class="admin-form-row">
              <div class="admin-form-group">
                <label data-i18n="status">Estado <span class="required">*</span></label>
                <select id="adminUsrEstado">
                  <option value="Ativo" data-i18n="status_active">âœ… Ativo</option>
                  <option value="Inativo" data-i18n="status_inactive">â¸ï¸ Inativo</option>
                  <option value="Bloqueado" data-i18n="status_blocked">ğŸ”’ Bloqueado</option>
                </select>
              </div>
              <div class="admin-form-group">
                <label data-i18n="team">Equipa</label>
                <select id="adminUsrEquipa">
                  <option value="" data-i18n="no_team">-- Sem equipa --</option>
                </select>
              </div>
            </div>
            
            <div class="admin-form-row">
              <div class="admin-form-group">
                <label data-i18n="warehouse">ArmazÃ©m Associado</label>
                <select id="adminUsrArmazem">
                  <option value="" data-i18n="no_warehouse">-- Sem armazÃ©m --</option>
                </select>
              </div>
              <div class="admin-form-group">
                <!-- Campo vazio para alinhamento -->
              </div>
            </div>
            
            <div class="admin-form-row full">
              <div class="admin-form-group">
                <label>ObservaÃ§Ãµes</label>
                <textarea id="adminUsrObservacoes" placeholder="Notas adicionais..."></textarea>
              </div>
            </div>
            
            <div class="admin-form-row full">
              <div class="admin-form-group">
                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                  <input type="checkbox" id="adminUsrForcarTrocaPassword" style="width: 20px; height: 20px;">
                  <span>ğŸ”„ ForÃ§ar troca de password no prÃ³ximo login</span>
                </label>
                <p style="color: #64748b; font-size: 0.8rem; margin-top: 4px;">Marque esta opÃ§Ã£o para obrigar o utilizador a definir uma nova password.</p>
              </div>
            </div>
          </div>
          <div class="admin-modal-footer">
            <button class="admin-btn admin-btn-secondary" onclick="adminUtilizadoresFecharModal()">Cancelar</button>
            <button class="admin-btn admin-btn-success" onclick="adminUtilizadoresGuardar()">ğŸ’¾ Guardar</button>
          </div>
        </div>
      </div>
    </section>

    <!-- PAGE: PERMISSÃ•ES -->
        <!-- PAGE: PERMISSÃ•ES -->
    <section id="page-permissoes" class="p-4 hidden">
      <div class="admin-container">
        <!-- Header -->
        <div class="admin-header admin-header-permissoes">
          <div>
            <h2>ğŸ” GestÃ£o de PermissÃµes</h2>
            <p>Configurar acessos por perfil e utilizador</p>
          </div>
          <button class="admin-btn-novo" onclick="adminPermissoesSalvarTudo()">
            <span>ğŸ’¾</span> Guardar AlteraÃ§Ãµes
          </button>
        </div>
        
        <!-- Tabs -->
        <div class="admin-tabs">
          <button class="admin-tab active" onclick="adminPermissoesTab('perfis')">ğŸ“‹ Por Perfil</button>
          <button class="admin-tab" onclick="adminPermissoesTab('utilizadores')">ğŸ‘¤ Por Utilizador</button>
        </div>
        
        <!-- Tab Content: Perfis -->
        <div class="admin-tab-content active" id="adminPermTabPerfis">
          <div style="margin-bottom: 20px;">
            <label style="font-weight: 600; margin-right: 10px;">Selecionar Perfil:</label>
            <select id="adminPermPerfilSelect" onchange="adminPermissoesCarregarPerfil()" style="padding: 10px 16px; border: 1px solid #e2e8f0; border-radius: 10px; min-width: 200px;">
              <option value="Administrador">ğŸ‘‘ Administrador</option>
              <option value="Gestor">ğŸ“Š Gestor</option>
              <option value="Gestor LogÃ­stica">ğŸš› Gestor LogÃ­stica</option>
              <option value="Gestor ArmazÃ©m">ğŸ¢ Gestor ArmazÃ©m</option>
              <option value="Comercial">ğŸ’¼ Comercial</option>
              <option value="Operador LogÃ­stica">ğŸ“¦ Operador LogÃ­stica</option>
              <option value="FaturaÃ§Ã£o">ğŸ’° FaturaÃ§Ã£o</option>
              <option value="VisualizaÃ§Ã£o">ğŸ‘ï¸ VisualizaÃ§Ã£o</option>
            </select>
          </div>
          
          <div class="admin-perm-section">
            <h4>ğŸ“¦ MÃ³dulos DisponÃ­veis</h4>
            <div class="admin-perm-grid" id="adminPermModulos">
              <!-- Checkboxes dinÃ¢micas -->
            </div>
          </div>
          
          <div class="admin-perm-section">
            <h4>âš¡ AÃ§Ãµes Permitidas</h4>
            <div class="admin-perm-grid" id="adminPermAcoes">
              <!-- Checkboxes dinÃ¢micas -->
            </div>
          </div>
        </div>
        
        <!-- Tab Content: Utilizadores -->
        <div class="admin-tab-content" id="adminPermTabUtilizadores">
          <div style="margin-bottom: 20px;">
            <label style="font-weight: 600; margin-right: 10px;">Selecionar Utilizador:</label>
            <select id="adminPermUserSelect" onchange="adminPermissoesCarregarUser()" style="padding: 10px 16px; border: 1px solid #e2e8f0; border-radius: 10px; min-width: 250px;">
              <option value="">-- Selecionar utilizador --</option>
            </select>
            <span style="margin-left: 20px; color: #64748b; font-size: 0.9rem;" id="adminPermUserPerfil"></span>
          </div>
          
          <div class="admin-perm-section">
            <h4>ğŸ“¦ PermissÃµes Customizadas (sobrepÃµem o perfil)</h4>
            <div class="admin-perm-grid" id="adminPermUserModulos">
              <!-- Checkboxes dinÃ¢micas -->
            </div>
          </div>
          
          <div class="admin-perm-section">
            <h4>âš¡ AÃ§Ãµes Customizadas</h4>
            <div class="admin-perm-grid" id="adminPermUserAcoes">
              <!-- Checkboxes dinÃ¢micas -->
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- PAGE: COMERCIAIS -->
        <!-- PAGE: COMERCIAIS -->
    <section id="page-comerciais" class="p-4 hidden">
      <div class="admin-container">
        <!-- Header -->
        <div class="admin-header admin-header-comerciais">
          <div>
            <h2>ğŸ’¼ GestÃ£o de Comerciais</h2>
            <p>Gerir equipa comercial e comissÃµes</p>
          </div>
          <button class="admin-btn-novo" onclick="adminComerciaisNovo()">
            <span>â•</span> Novo Comercial
          </button>
        </div>
        
        <!-- KPIs -->
        <div class="admin-kpis">
          <div class="admin-kpi-card">
            <div class="admin-kpi-icon amber">ğŸ’¼</div>
            <div class="admin-kpi-info">
              <h4>Total Comerciais</h4>
              <p class="valor" id="adminComKpiTotal">0</p>
            </div>
          </div>
          <div class="admin-kpi-card">
            <div class="admin-kpi-icon green">âœ…</div>
            <div class="admin-kpi-info">
              <h4>Ativos</h4>
              <p class="valor" id="adminComKpiAtivos">0</p>
            </div>
          </div>
          <div class="admin-kpi-card">
            <div class="admin-kpi-icon purple">ğŸ’°</div>
            <div class="admin-kpi-info">
              <h4>ComissÃ£o MÃ©dia</h4>
              <p class="valor" id="adminComKpiComissao">0%</p>
            </div>
          </div>
        </div>
        
        <!-- Card Principal -->
        <div class="admin-card">
          <div class="admin-toolbar">
            <div class="admin-search">
              <input type="text" id="adminComPesquisa" placeholder="Pesquisar comerciais..." onkeyup="adminComerciaisFiltrar()">
            </div>
            <select class="admin-filter" id="adminComFiltroEstado" onchange="adminComerciaisFiltrar()">
              <option value="">Todos os estados</option>
              <option value="Ativo">âœ… Ativo</option>
              <option value="Inativo">â¸ï¸ Inativo</option>
            </select>
            <select class="admin-filter" id="adminComFiltroZona" onchange="adminComerciaisFiltrar()">
              <option value="">Todas as zonas</option>
              <option value="Norte">Norte</option>
              <option value="Centro">Centro</option>
              <option value="Sul">Sul</option>
              <option value="Internacional">Internacional</option>
            </select>
            <span class="admin-counter" id="adminComContador">0 registos</span>
          </div>
          
          <div class="admin-table-container">
            <table class="admin-table" id="adminComTabela">
              <thead>
                <tr>
                  <th>CÃ³digo</th>
                  <th>Nome</th>
                  <th>Email</th>
                  <th>Telefone</th>
                  <th>Zona</th>
                  <th>Equipa</th>
                  <th>ComissÃ£o</th>
                  <th>Estado</th>
                  <th>AÃ§Ãµes</th>
                </tr>
              </thead>
              <tbody id="adminComTabelaBody">
                <!-- Dados dinÃ¢micos -->
              </tbody>
            </table>
          </div>
          
          <div class="admin-empty" id="adminComEmpty" style="display:none;">
            <div class="admin-empty-icon">ğŸ’¼</div>
            <h4>Nenhum comercial encontrado</h4>
            <p>Clique em "Novo Comercial" para adicionar o primeiro</p>
          </div>
        </div>
      </div>
      
      <!-- Modal Comercial -->
      <div class="admin-modal" id="adminComModal">
        <div class="admin-modal-content">
          <div class="admin-modal-header">
            <h3 id="adminComModalTitulo">ğŸ’¼ Novo Comercial</h3>
            <button class="admin-modal-close" onclick="adminComerciaisFecharModal()">âœ•</button>
          </div>
          <div class="admin-modal-body">
            <input type="hidden" id="adminComId">
            
            <div class="admin-form-row">
              <div class="admin-form-group">
                <label>CÃ³digo <span class="required">*</span></label>
                <input type="text" id="adminComCodigo" placeholder="Ex: COM001" maxlength="10">
              </div>
              <div class="admin-form-group">
                <label>Nome <span class="required">*</span></label>
                <input type="text" id="adminComNome" placeholder="Nome completo">
              </div>
            </div>
            
            <div class="admin-form-row">
              <div class="admin-form-group">
                <label>Email <span class="required">*</span></label>
                <input type="email" id="adminComEmail" placeholder="email@empresa.pt">
              </div>
              <div class="admin-form-group">
                <label>Telefone</label>
                <input type="text" id="adminComTelefone" placeholder="+351 000 000 000">
              </div>
            </div>
            
            <div class="admin-form-row">
              <div class="admin-form-group">
                <label>Zona/RegiÃ£o</label>
                <select id="adminComZona">
                  <option value="">-- Selecionar --</option>
                  <option value="Norte">Norte</option>
                  <option value="Centro">Centro</option>
                  <option value="Sul">Sul</option>
                  <option value="Internacional">Internacional</option>
                </select>
              </div>
              <div class="admin-form-group">
                <label>ComissÃ£o (%)</label>
                <input type="number" id="adminComComissao" placeholder="5" min="0" max="100" step="0.5">
              </div>
            </div>
            
            <div class="admin-form-row">
              <div class="admin-form-group">
                <label>Equipa</label>
                <select id="adminComEquipa">
                  <option value="">-- Sem equipa --</option>
                </select>
              </div>
              <div class="admin-form-group">
                <label>Utilizador Associado</label>
                <select id="adminComUtilizador">
                  <option value="">-- Sem utilizador --</option>
                </select>
              </div>
            </div>
            
            <div class="admin-form-row">
              <div class="admin-form-group">
                <label>Estado <span class="required">*</span></label>
                <select id="adminComEstado">
                  <option value="Ativo">âœ… Ativo</option>
                  <option value="Inativo">â¸ï¸ Inativo</option>
                </select>
              </div>
              <div class="admin-form-group">
                <!-- EspaÃ§o vazio para alinhamento -->
              </div>
            </div>
            
            <div class="admin-form-row full">
              <div class="admin-form-group">
                <label>ObservaÃ§Ãµes</label>
                <textarea id="adminComObservacoes" placeholder="Notas adicionais..."></textarea>
              </div>
            </div>
          </div>
          <div class="admin-modal-footer">
            <button class="admin-btn admin-btn-secondary" onclick="adminComerciaisFecharModal()">Cancelar</button>
            <button class="admin-btn admin-btn-success" onclick="adminComerciaisGuardar()">ğŸ’¾ Guardar</button>
          </div>
        </div>
      </div>
    </section>

    <!-- PAGE: EQUIPAS -->
        <!-- PAGE: EQUIPAS -->
    <section id="page-equipas" class="p-4 hidden">
      <div class="admin-container">
        <!-- Header -->
        <div class="admin-header admin-header-equipas">
          <div>
            <h2>ğŸ‘¥ GestÃ£o de Equipas</h2>
            <p>Criar e gerir equipas de trabalho</p>
          </div>
          <button class="admin-btn-novo" onclick="adminEquipasNovo()">
            <span>â•</span> Nova Equipa
          </button>
        </div>
        
        <!-- KPIs -->
        <div class="admin-kpis">
          <div class="admin-kpi-card">
            <div class="admin-kpi-icon cyan">ğŸ‘¥</div>
            <div class="admin-kpi-info">
              <h4>Total Equipas</h4>
              <p class="valor" id="adminEqpKpiTotal">0</p>
            </div>
          </div>
          <div class="admin-kpi-card">
            <div class="admin-kpi-icon green">âœ…</div>
            <div class="admin-kpi-info">
              <h4>Ativas</h4>
              <p class="valor" id="adminEqpKpiAtivas">0</p>
            </div>
          </div>
          <div class="admin-kpi-card">
            <div class="admin-kpi-icon blue">ğŸ‘¤</div>
            <div class="admin-kpi-info">
              <h4>Total Membros</h4>
              <p class="valor" id="adminEqpKpiMembros">0</p>
            </div>
          </div>
        </div>
        
        <!-- Card Principal -->
        <div class="admin-card">
          <div class="admin-toolbar">
            <div class="admin-search">
              <input type="text" id="adminEqpPesquisa" placeholder="Pesquisar equipas..." onkeyup="adminEquipasFiltrar()">
            </div>
            <select class="admin-filter" id="adminEqpFiltroEstado" onchange="adminEquipasFiltrar()">
              <option value="">Todos os estados</option>
              <option value="Ativo">âœ… Ativo</option>
              <option value="Inativo">â¸ï¸ Inativo</option>
            </select>
            <select class="admin-filter" id="adminEqpFiltroTipo" onchange="adminEquipasFiltrar()">
              <option value="">Todos os tipos</option>
              <option value="LogÃ­stica">ğŸš› LogÃ­stica</option>
              <option value="ArmazÃ©m">ğŸ¢ ArmazÃ©m</option>
              <option value="Comercial">ğŸ’¼ Comercial</option>
              <option value="FaturaÃ§Ã£o">ğŸ’° FaturaÃ§Ã£o</option>
              <option value="AdministraÃ§Ã£o">âš™ï¸ AdministraÃ§Ã£o</option>
            </select>
            <span class="admin-counter" id="adminEqpContador">0 registos</span>
          </div>
          
          <div class="admin-table-container">
            <table class="admin-table" id="adminEqpTabela">
              <thead>
                <tr>
                  <th>CÃ³digo</th>
                  <th>Nome</th>
                  <th>Tipo</th>
                  <th>ResponsÃ¡vel</th>
                  <th>ArmazÃ©m</th>
                  <th>Membros</th>
                  <th>Estado</th>
                  <th>AÃ§Ãµes</th>
                </tr>
              </thead>
              <tbody id="adminEqpTabelaBody">
                <!-- Dados dinÃ¢micos -->
              </tbody>
            </table>
          </div>
          
          <div class="admin-empty" id="adminEqpEmpty" style="display:none;">
            <div class="admin-empty-icon">ğŸ‘¥</div>
            <h4>Nenhuma equipa encontrada</h4>
            <p>Clique em "Nova Equipa" para adicionar a primeira</p>
          </div>
        </div>
      </div>
      
      <!-- Modal Equipa -->
      <div class="admin-modal" id="adminEqpModal">
        <div class="admin-modal-content">
          <div class="admin-modal-header">
            <h3 id="adminEqpModalTitulo">ğŸ‘¥ Nova Equipa</h3>
            <button class="admin-modal-close" onclick="adminEquipasFecharModal()">âœ•</button>
          </div>
          <div class="admin-modal-body">
            <input type="hidden" id="adminEqpId">
            
            <div class="admin-form-row">
              <div class="admin-form-group">
                <label>CÃ³digo <span class="required">*</span></label>
                <input type="text" id="adminEqpCodigo" placeholder="Ex: EQP001" maxlength="10">
              </div>
              <div class="admin-form-group">
                <label>Nome <span class="required">*</span></label>
                <input type="text" id="adminEqpNome" placeholder="Nome da equipa">
              </div>
            </div>
            
            <div class="admin-form-row">
              <div class="admin-form-group">
                <label>Tipo <span class="required">*</span></label>
                <select id="adminEqpTipo">
                  <option value="LogÃ­stica">ğŸš› LogÃ­stica</option>
                  <option value="ArmazÃ©m">ğŸ¢ ArmazÃ©m</option>
                  <option value="Comercial">ğŸ’¼ Comercial</option>
                  <option value="FaturaÃ§Ã£o">ğŸ’° FaturaÃ§Ã£o</option>
                  <option value="AdministraÃ§Ã£o">âš™ï¸ AdministraÃ§Ã£o</option>
                </select>
              </div>
              <div class="admin-form-group">
                <label>Estado <span class="required">*</span></label>
                <select id="adminEqpEstado">
                  <option value="Ativo">âœ… Ativo</option>
                  <option value="Inativo">â¸ï¸ Inativo</option>
                </select>
              </div>
            </div>
            
            <div class="admin-form-row">
              <div class="admin-form-group">
                <label>ResponsÃ¡vel</label>
                <select id="adminEqpResponsavel">
                  <option value="">-- Selecionar --</option>
                </select>
              </div>
              <div class="admin-form-group">
                <label>ArmazÃ©m Base</label>
                <select id="adminEqpArmazem">
                  <option value="">-- Sem armazÃ©m --</option>
                </select>
              </div>
            </div>
            
            <div class="admin-form-row full">
              <div class="admin-form-group">
                <label>Membros da Equipa</label>
                <div class="admin-checkbox-list" id="adminEqpMembrosLista">
                  <!-- Checkboxes dinÃ¢micas -->
                </div>
              </div>
            </div>
            
            <div class="admin-form-row full">
              <div class="admin-form-group">
                <label>ObservaÃ§Ãµes</label>
                <textarea id="adminEqpObservacoes" placeholder="Notas adicionais..."></textarea>
              </div>
            </div>
          </div>
          <div class="admin-modal-footer">
            <button class="admin-btn admin-btn-secondary" onclick="adminEquipasFecharModal()">Cancelar</button>
            <button class="admin-btn admin-btn-success" onclick="adminEquipasGuardar()">ğŸ’¾ Guardar</button>
          </div>
        </div>
      </div>
    </section>

    <!-- PAGE: ROTAS -->
        <!-- PAGE: ROTAS -->
    <section id="page-rotas" class="p-4 hidden">
      <div class="admin-container">
        <!-- Header -->
        <div class="admin-header admin-header-rotas">
          <div>
            <h2>ğŸ›£ï¸ GestÃ£o de Rotas</h2>
            <p>DefiniÃ§Ã£o de rotas e trajetos</p>
          </div>
          <button class="admin-btn-novo" onclick="adminRotasNovo()">
            <span>â•</span> Nova Rota
          </button>
        </div>
        
        <!-- KPIs -->
        <div class="admin-kpis">
          <div class="admin-kpi-card">
            <div class="admin-kpi-icon green">ğŸ›£ï¸</div>
            <div class="admin-kpi-info">
              <h4>Total Rotas</h4>
              <p class="valor" id="adminRotKpiTotal">0</p>
            </div>
          </div>
          <div class="admin-kpi-card">
            <div class="admin-kpi-icon blue">ğŸ‡µğŸ‡¹</div>
            <div class="admin-kpi-info">
              <h4>Nacionais</h4>
              <p class="valor" id="adminRotKpiNacionais">0</p>
            </div>
          </div>
          <div class="admin-kpi-card">
            <div class="admin-kpi-icon purple">ğŸŒ</div>
            <div class="admin-kpi-info">
              <h4>Internacionais</h4>
              <p class="valor" id="adminRotKpiInternacionais">0</p>
            </div>
          </div>
        </div>
        
        <!-- Card Principal -->
        <div class="admin-card">
          <div class="admin-toolbar">
            <div class="admin-search">
              <input type="text" id="adminRotPesquisa" placeholder="Pesquisar rotas..." onkeyup="adminRotasFiltrar()">
            </div>
            <select class="admin-filter" id="adminRotFiltroEstado" onchange="adminRotasFiltrar()">
              <option value="">Todos os estados</option>
              <option value="Ativo">âœ… Ativo</option>
              <option value="Inativo">â¸ï¸ Inativo</option>
            </select>
            <select class="admin-filter" id="adminRotFiltroTipo" onchange="adminRotasFiltrar()">
              <option value="">Todos os tipos</option>
              <option value="Nacional">ğŸ‡µğŸ‡¹ Nacional</option>
              <option value="Internacional">ğŸŒ Internacional</option>
            </select>
            <span class="admin-counter" id="adminRotContador">0 registos</span>
          </div>
          
          <div class="admin-table-container">
            <table class="admin-table" id="adminRotTabela">
              <thead>
                <tr>
                  <th>CÃ³digo</th>
                  <th>Nome</th>
                  <th>Origem</th>
                  <th>Destino</th>
                  <th>Km</th>
                  <th>â‚¬/Km</th>
                  <th>Tempo</th>
                  <th>Tipo</th>
                  <th>Estado</th>
                  <th>AÃ§Ãµes</th>
                </tr>
              </thead>
              <tbody id="adminRotTabelaBody">
                <!-- Dados dinÃ¢micos -->
              </tbody>
            </table>
          </div>
          
          <div class="admin-empty" id="adminRotEmpty" style="display:none;">
            <div class="admin-empty-icon">ğŸ›£ï¸</div>
            <h4>Nenhuma rota encontrada</h4>
            <p>Clique em "Nova Rota" para adicionar a primeira</p>
          </div>
        </div>
      </div>
      
      <!-- Modal Rota -->
      <div class="admin-modal" id="adminRotModal">
        <div class="admin-modal-content">
          <div class="admin-modal-header">
            <h3 id="adminRotModalTitulo">ğŸ›£ï¸ Nova Rota</h3>
            <button class="admin-modal-close" onclick="adminRotasFecharModal()">âœ•</button>
          </div>
          <div class="admin-modal-body">
            <input type="hidden" id="adminRotId">
            
            <div class="admin-form-row">
              <div class="admin-form-group">
                <label>CÃ³digo <span class="required">*</span></label>
                <input type="text" id="adminRotCodigo" placeholder="Ex: ROT001" maxlength="10">
              </div>
              <div class="admin-form-group">
                <label>Nome <span class="required">*</span></label>
                <input type="text" id="adminRotNome" placeholder="Ex: Lisboa - Porto">
              </div>
            </div>
            
            <div class="admin-form-row">
              <div class="admin-form-group">
                <label>Origem <span class="required">*</span></label>
                <input type="text" id="adminRotOrigem" placeholder="Cidade de origem">
              </div>
              <div class="admin-form-group">
                <label>Destino <span class="required">*</span></label>
                <input type="text" id="adminRotDestino" placeholder="Cidade de destino">
              </div>
            </div>
            
            <div class="admin-form-row">
              <div class="admin-form-group">
                <label>DistÃ¢ncia (Km) <span class="required">*</span></label>
                <input type="number" id="adminRotKm" placeholder="315" min="0" step="0.1">
              </div>
              <div class="admin-form-group">
                <label>Tempo Estimado</label>
                <input type="text" id="adminRotTempo" placeholder="Ex: 3h00">
              </div>
            </div>
            
            <div class="admin-form-row">
              <div class="admin-form-group">
                <label>PreÃ§o por Km (â‚¬)</label>
                <input type="number" id="adminRotPrecoKm" placeholder="1.20" min="0" step="0.01">
              </div>
              <div class="admin-form-group">
                <label>PreÃ§o Fixo (â‚¬)</label>
                <input type="number" id="adminRotPrecoFixo" placeholder="0" min="0" step="0.01">
              </div>
            </div>
            
            <div class="admin-form-row">
              <div class="admin-form-group">
                <label>Tipo <span class="required">*</span></label>
                <select id="adminRotTipo">
                  <option value="Nacional">ğŸ‡µğŸ‡¹ Nacional</option>
                  <option value="Internacional">ğŸŒ Internacional</option>
                </select>
              </div>
              <div class="admin-form-group">
                <label>Estado <span class="required">*</span></label>
                <select id="adminRotEstado">
                  <option value="Ativo">âœ… Ativo</option>
                  <option value="Inativo">â¸ï¸ Inativo</option>
                </select>
              </div>
            </div>
            
            <div class="admin-form-row full">
              <div class="admin-form-group">
                <label>Pontos de Passagem</label>
                <input type="text" id="adminRotPontos" placeholder="Ex: Coimbra, Aveiro (separados por vÃ­rgula)">
              </div>
            </div>
            
            <div class="admin-form-row full">
              <div class="admin-form-group">
                <label>ObservaÃ§Ãµes</label>
                <textarea id="adminRotObservacoes" placeholder="Notas adicionais..."></textarea>
              </div>
            </div>
          </div>
          <div class="admin-modal-footer">
            <button class="admin-btn admin-btn-secondary" onclick="adminRotasFecharModal()">Cancelar</button>
            <button class="admin-btn admin-btn-success" onclick="adminRotasGuardar()">ğŸ’¾ Guardar</button>
          </div>
        </div>
      </div>
    </section>

    <!-- PAGE: ARMAZÃ‰NS -->
        <!-- PAGE: ARMAZÃ‰NS -->
    <section id="page-armazens" class="p-4 hidden">
      <div class="admin-container">
        <!-- Header -->
        <div class="admin-header admin-header-armazens">
          <div>
            <h2>ğŸ¢ GestÃ£o de ArmazÃ©ns</h2>
            <p>Criar e gerir armazÃ©ns do sistema</p>
          </div>
          <button class="admin-btn-novo" onclick="adminArmazensNovo()">
            <span>â•</span> Novo ArmazÃ©m
          </button>
        </div>
        
        <!-- KPIs -->
        <div class="admin-kpis">
          <div class="admin-kpi-card">
            <div class="admin-kpi-icon indigo">ğŸ¢</div>
            <div class="admin-kpi-info">
              <h4>Total ArmazÃ©ns</h4>
              <p class="valor" id="adminArmKpiTotal">0</p>
            </div>
          </div>
          <div class="admin-kpi-card">
            <div class="admin-kpi-icon green">âœ…</div>
            <div class="admin-kpi-info">
              <h4>Ativos</h4>
              <p class="valor" id="adminArmKpiAtivos">0</p>
            </div>
          </div>
          <div class="admin-kpi-card">
            <div class="admin-kpi-icon gray">ğŸ“</div>
            <div class="admin-kpi-info">
              <h4>Capacidade Total (mÂ²)</h4>
              <p class="valor" id="adminArmKpiCapacidade">0</p>
            </div>
          </div>
        </div>
        
        <!-- Card Principal -->
        <div class="admin-card">
          <div class="admin-toolbar">
            <div class="admin-search">
              <input type="text" id="adminArmPesquisa" placeholder="Pesquisar armazÃ©ns..." onkeyup="adminArmazensFiltrar()">
            </div>
            <select class="admin-filter" id="adminArmFiltroEstado" onchange="adminArmazensFiltrar()">
              <option value="">Todos os estados</option>
              <option value="Ativo">âœ… Ativo</option>
              <option value="Inativo">â¸ï¸ Inativo</option>
              <option value="Em ManutenÃ§Ã£o">ğŸ”§ Em ManutenÃ§Ã£o</option>
            </select>
            <select class="admin-filter" id="adminArmFiltroPais" onchange="adminArmazensFiltrar()">
              <option value="">Todos os paÃ­ses</option>
              <option value="Portugal">ğŸ‡µğŸ‡¹ Portugal</option>
              <option value="Espanha">ğŸ‡ªğŸ‡¸ Espanha</option>
              <option value="FranÃ§a">ğŸ‡«ğŸ‡· FranÃ§a</option>
            </select>
            <span class="admin-counter" id="adminArmContador">0 registos</span>
          </div>
          
          <div class="admin-table-container">
            <table class="admin-table" id="adminArmTabela">
              <thead>
                <tr>
                  <th>CÃ³digo</th>
                  <th>Nome</th>
                  <th>Localidade</th>
                  <th>PaÃ­s</th>
                  <th>Capacidade</th>
                  <th>ResponsÃ¡vel</th>
                  <th>Estado</th>
                  <th>AÃ§Ãµes</th>
                </tr>
              </thead>
              <tbody id="adminArmTabelaBody">
                <!-- Dados dinÃ¢micos -->
              </tbody>
            </table>
          </div>
          
          <div class="admin-empty" id="adminArmEmpty" style="display:none;">
            <div class="admin-empty-icon">ğŸ¢</div>
            <h4>Nenhum armazÃ©m encontrado</h4>
            <p>Clique em "Novo ArmazÃ©m" para adicionar o primeiro</p>
          </div>
        </div>
      </div>
      
      <!-- Modal ArmazÃ©m -->
      <div class="admin-modal" id="adminArmModal">
        <div class="admin-modal-content">
          <div class="admin-modal-header">
            <h3 id="adminArmModalTitulo">ğŸ¢ Novo ArmazÃ©m</h3>
            <button class="admin-modal-close" onclick="adminArmazensFecharModal()">âœ•</button>
          </div>
          <div class="admin-modal-body">
            <input type="hidden" id="adminArmId">
            
            <div class="admin-form-row">
              <div class="admin-form-group">
                <label>CÃ³digo <span class="required">*</span></label>
                <input type="text" id="adminArmCodigo" placeholder="Ex: ARM001" maxlength="10">
              </div>
              <div class="admin-form-group">
                <label>Nome <span class="required">*</span></label>
                <input type="text" id="adminArmNome" placeholder="Nome do armazÃ©m">
              </div>
            </div>
            
            <div class="admin-form-row full">
              <div class="admin-form-group">
                <label>Morada <span class="required">*</span></label>
                <input type="text" id="adminArmMorada" placeholder="Morada completa">
              </div>
            </div>
            
            <div class="admin-form-row">
              <div class="admin-form-group">
                <label>CÃ³digo Postal</label>
                <input type="text" id="adminArmCodigoPostal" placeholder="0000-000">
              </div>
              <div class="admin-form-group">
                <label>Localidade <span class="required">*</span></label>
                <input type="text" id="adminArmLocalidade" placeholder="Cidade/Localidade">
              </div>
            </div>
            
            <div class="admin-form-row">
              <div class="admin-form-group">
                <label>PaÃ­s <span class="required">*</span></label>
                <select id="adminArmPais">
                  <option value="Portugal">ğŸ‡µğŸ‡¹ Portugal</option>
                  <option value="Espanha">ğŸ‡ªğŸ‡¸ Espanha</option>
                  <option value="FranÃ§a">ğŸ‡«ğŸ‡· FranÃ§a</option>
                  <option value="Alemanha">ğŸ‡©ğŸ‡ª Alemanha</option>
                  <option value="BÃ©lgica">ğŸ‡§ğŸ‡ª BÃ©lgica</option>
                  <option value="Holanda">ğŸ‡³ğŸ‡± Holanda</option>
                </select>
              </div>
              <div class="admin-form-group">
                <label>Capacidade (mÂ²)</label>
                <input type="number" id="adminArmCapacidade" placeholder="5000" min="0">
              </div>
            </div>
            
            <div class="admin-form-row">
              <div class="admin-form-group">
                <label>Telefone</label>
                <input type="text" id="adminArmTelefone" placeholder="+351 000 000 000">
              </div>
              <div class="admin-form-group">
                <label>Email</label>
                <input type="email" id="adminArmEmail" placeholder="armazem@empresa.pt">
              </div>
            </div>
            
            <div class="admin-form-row">
              <div class="admin-form-group">
                <label>ResponsÃ¡vel</label>
                <input type="text" id="adminArmResponsavel" placeholder="Nome do responsÃ¡vel">
              </div>
              <div class="admin-form-group">
                <label>Estado <span class="required">*</span></label>
                <select id="adminArmEstado">
                  <option value="Ativo">âœ… Ativo</option>
                  <option value="Inativo">â¸ï¸ Inativo</option>
                  <option value="Em ManutenÃ§Ã£o">ğŸ”§ Em ManutenÃ§Ã£o</option>
                </select>
              </div>
            </div>
            
            <div class="admin-form-row full">
              <div class="admin-form-group">
                <label>HorÃ¡rio de Funcionamento</label>
                <input type="text" id="adminArmHorario" placeholder="Ex: Seg-Sex 08:00-18:00">
              </div>
            </div>
            
            <div class="admin-form-row full">
              <div class="admin-form-group">
                <label>ObservaÃ§Ãµes</label>
                <textarea id="adminArmObservacoes" placeholder="Notas adicionais..."></textarea>
              </div>
            </div>
          </div>
          <div class="admin-modal-footer">
            <button class="admin-btn admin-btn-secondary" onclick="adminArmazensFecharModal()">Cancelar</button>
            <button class="admin-btn admin-btn-success" onclick="adminArmazensGuardar()">ğŸ’¾ Guardar</button>
          </div>
        </div>
      </div>
    </section>

    <!-- PAGE: LOGS -->
    <section id="page-logs" class="p-8 hidden">
      <div class="card">
        <div class="card-header">
          <h3 class="font-bold text-lg text-slate-800">ğŸ“œ Logs / HistÃ³rico</h3>
        </div>
        <div class="card-body">
          <div class="bg-slate-50 border border-slate-200 rounded-lg p-8 text-center">
            <span class="text-6xl mb-4 block">ğŸš§</span>
            <h4 class="text-xl font-bold text-slate-800 mb-2">MÃ³dulo em Desenvolvimento</h4>
            <p class="text-slate-700">Registo de todas as aÃ§Ãµes no sistema.</p>
            <p class="text-slate-600 text-sm mt-2">Funcionalidades previstas:</p>
            <ul class="text-slate-600 text-sm mt-2 space-y-1">
              <li>â€¢ HistÃ³rico de aÃ§Ãµes por utilizador</li>
              <li>â€¢ Filtros por data, mÃ³dulo, aÃ§Ã£o</li>
              <li>â€¢ ExportaÃ§Ã£o de logs</li>
              <li>â€¢ Alertas de seguranÃ§a</li>
            </ul>
          </div>
        </div>
      </div>
    </section>

    <!-- PAGE: BACKUP -->
    <section id="page-backup" class="p-8 hidden">
      <div class="card">
        <div class="card-header">
          <h3 class="font-bold text-lg text-slate-800">ğŸ’¾ Backup de Dados</h3>
        </div>
        <div class="card-body">
          <div class="bg-teal-50 border border-teal-200 rounded-lg p-8 text-center">
            <span class="text-6xl mb-4 block">ğŸš§</span>
            <h4 class="text-xl font-bold text-teal-800 mb-2">MÃ³dulo em Desenvolvimento</h4>
            <p class="text-teal-700">SeguranÃ§a e backup de dados.</p>
            <p class="text-teal-600 text-sm mt-2">Funcionalidades previstas:</p>
            <ul class="text-teal-600 text-sm mt-2 space-y-1">
              <li>â€¢ Backup manual</li>
              <li>â€¢ Backup automÃ¡tico programado</li>
              <li>â€¢ Restauro de dados</li>
              <li>â€¢ ExportaÃ§Ã£o completa</li>
            </ul>
          </div>
        </div>
      </div>
    </section>

    <!-- PAGE: COTAÃ‡Ã•ES -->
    <section id="page-cotacoes" class="p-8 hidden">
      <div class="cotacoes-container">
        
        <!-- Header Principal -->
        <div class="cotacoes-card" style="margin-bottom: 20px;">
          <div class="cotacoes-header-main">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div>
                <h2 style="color: white; font-size: 22px; font-weight: 700; margin: 0;" data-i18n="quotations_management">ğŸ’¶ GestÃ£o de CotaÃ§Ãµes</h2>
                <p style="color: rgba(255,255,255,0.8); font-size: 13px; margin-top: 4px;" data-i18n="quotations_subtitle">Propostas de preÃ§o para clientes</p>
              </div>
              <div style="display: flex; gap: 10px;">
                <button onclick="cotacoesNova()" class="cotacoes-btn" style="background: white; color: #8b5cf6;" data-i18n="new_quotation">â• Nova CotaÃ§Ã£o</button>
                <button onclick="cotacoesExportarExcel()" class="cotacoes-btn cotacoes-btn-secondary" data-i18n="export">ğŸ“¥ Exportar</button>
              </div>
            </div>
          </div>
        </div>
        
        <!-- KPIs -->
        <div class="cotacoes-stats-row">
          <div class="cotacoes-stat-card total">
            <p class="cotacoes-stat-label" data-i18n="total_quotations">Total CotaÃ§Ãµes</p>
            <p class="cotacoes-stat-value" id="cotacoesKpiTotal">0</p>
          </div>
          <div class="cotacoes-stat-card pendentes">
            <p class="cotacoes-stat-label" data-i18n="pending">Pendentes</p>
            <p class="cotacoes-stat-value" id="cotacoesKpiPendentes">0</p>
          </div>
          <div class="cotacoes-stat-card aceites">
            <p class="cotacoes-stat-label" data-i18n="accepted">Aceites</p>
            <p class="cotacoes-stat-value" id="cotacoesKpiAceites">0</p>
          </div>
          <div class="cotacoes-stat-card recusadas">
            <p class="cotacoes-stat-label" data-i18n="rejected">Recusadas</p>
            <p class="cotacoes-stat-value" id="cotacoesKpiRecusadas">0</p>
          </div>
          <div class="cotacoes-stat-card valor">
            <p class="cotacoes-stat-label" data-i18n="total_value_accepted">Valor Total (Aceites)</p>
            <p class="cotacoes-stat-value" id="cotacoesKpiValor">0 â‚¬</p>
          </div>
        </div>
        
        <!-- Tabela Principal -->
        <div class="cotacoes-card">
          <!-- Toolbar -->
          <div class="cotacoes-toolbar cotacoes-no-print">
            <input type="text" id="cotacoesFiltroCliente" class="cotacoes-filter-input" data-i18n-placeholder="search_customer" placeholder="ğŸ” Pesquisar cliente..." oninput="cotacoesFiltrar()">
            <select id="cotacoesFiltroEstado" class="cotacoes-filter-select" onchange="cotacoesFiltrar()">
              <option value="" data-i18n="all_statuses">Todos os estados</option>
              <option value="Pendente" data-i18n="status_pending">Pendente</option>
              <option value="Aceite" data-i18n="status_accepted">Aceite</option>
              <option value="Recusada" data-i18n="status_rejected">Recusada</option>
              <option value="Convertida" data-i18n="status_converted">Convertida</option>
              <option value="Expirada" data-i18n="status_expired">Expirada</option>
            </select>
            <input type="date" id="cotacoesFiltroDataDe" class="cotacoes-filter-input" data-i18n-title="date_from" title="Data de" onchange="cotacoesFiltrar()">
            <input type="date" id="cotacoesFiltroDataAte" class="cotacoes-filter-input" data-i18n-title="date_to" title="Data atÃ©" onchange="cotacoesFiltrar()">
            <button onclick="cotacoesLimparFiltros()" class="cotacoes-btn cotacoes-btn-secondary cotacoes-btn-sm" data-i18n="clear">âœ– Limpar</button>
            <span class="cotacoes-contador" id="cotacoesContador">0 cotaÃ§Ãµes</span>
          </div>
          
          <!-- Tabela -->
          <div class="cotacoes-table-container">
            <table class="cotacoes-table" id="cotacoesTabela">
              <thead>
                <tr>
                  <th style="width: 80px;" onclick="cotacoesOrdenar('numero')" data-i18n="number">NÂº â–¼</th>
                  <th style="width: 90px;" onclick="cotacoesOrdenar('data')" data-i18n="date">Data</th>
                  <th style="width: 90px;" onclick="cotacoesOrdenar('validade')" data-i18n="validity">Validade</th>
                  <th onclick="cotacoesOrdenar('cliente')" data-i18n="customer_number_name">NÂº/Nome Cliente</th>
                  <th data-i18n="description">DescriÃ§Ã£o</th>
                  <th data-i18n="loading_location">Local Carga</th>
                  <th data-i18n="unloading_location">Local Descarga</th>
                  <th style="width: 70px; text-align: right;" data-i18n="km">Km</th>
                  <th style="width: 80px; text-align: right;" data-i18n="price_per_km">â‚¬/Km</th>
                  <th style="width: 90px; text-align: right;" data-i18n="price_per_trip">â‚¬/Viagem</th>
                  <th style="width: 100px; text-align: right;" onclick="cotacoesOrdenar('total')" data-i18n="total">Total â‚¬</th>
                  <th style="width: 100px; text-align: center;" data-i18n="status">Estado</th>
                  <th style="width: 140px; text-align: center;" class="cotacoes-no-print" data-i18n="actions">AÃ§Ãµes</th>
                </tr>
              </thead>
              <tbody id="cotacoesTabelaBody">
                <!-- Preenchido por JS -->
              </tbody>
            </table>
          </div>
          
          <!-- Empty State -->
          <div class="cotacoes-empty-state" id="cotacoesEmptyState" style="display: none;">
            <span>ğŸ’¶</span>
            <h4 style="font-size: 18px; font-weight: 600; color: #1e293b; margin-bottom: 8px;" data-i18n="no_quotation_found">Nenhuma cotaÃ§Ã£o encontrada</h4>
            <p data-i18n="click_new_quotation">Clique em "Nova CotaÃ§Ã£o" para criar a primeira.</p>
          </div>
        </div>
        
      </div>
      
      <!-- Modal Nova/Editar CotaÃ§Ã£o -->
      <div class="cotacoes-modal-overlay" id="cotacoesModalOverlay" style="display: none;" onclick="if(event.target===this)cotacoesFecharModal()">
        <div class="cotacoes-modal">
          <div class="cotacoes-modal-header">
            <h3 id="cotacoesModalTitulo" data-i18n="new_quotation">ğŸ’¶ Nova CotaÃ§Ã£o</h3>
            <button class="cotacoes-modal-close" onclick="cotacoesFecharModal()">âœ•</button>
          </div>
          <div class="cotacoes-modal-body">
            <form id="cotacoesForm" onsubmit="return false;">
              <input type="hidden" id="cotacoesEditId">
              
              <!-- SecÃ§Ã£o: Dados Gerais -->
              <div class="cotacoes-form-section">
                <h4 data-i18n="general_data">ğŸ“‹ Dados Gerais</h4>
                <div class="cotacoes-form-row cols-4">
                  <div class="cotacoes-form-group">
                    <label data-i18n="quotation_number">CT1 - NÂº CotaÃ§Ã£o</label>
                    <input type="text" id="cotacoesNumero" readonly style="background: #f1f5f9; font-weight: bold;">
                  </div>
                  <div class="cotacoes-form-group">
                    <label>CT2 - <span data-i18n="date">Data</span> <span class="required">*</span></label>
                    <input type="date" id="cotacoesData" required>
                  </div>
                  <div class="cotacoes-form-group">
                    <label>CT3 - <span data-i18n="validity">Validade</span> <span class="required">*</span></label>
                    <input type="date" id="cotacoesValidade" required>
                  </div>
                  <div class="cotacoes-form-group">
                    <label>CT4 - <span data-i18n="status">Estado</span></label>
                    <select id="cotacoesEstado">
                      <option value="Pendente" data-i18n="status_pending">Pendente</option>
                      <option value="Aceite" data-i18n="status_accepted">Aceite</option>
                      <option value="Recusada" data-i18n="status_rejected">Recusada</option>
                      <option value="Expirada" data-i18n="status_expired">Expirada</option>
                    </select>
                  </div>
                </div>
              </div>
              
              <!-- SecÃ§Ã£o: Cliente -->
              <div class="cotacoes-form-section">
                <h4 data-i18n="customer">ğŸ‘¤ Cliente</h4>
                <div class="cotacoes-form-row">
                  <div class="cotacoes-form-group">
                    <label>CT5 - <span data-i18n="customer_number">NÂº Cliente</span> <span class="required">*</span></label>
                    <div class="cotacoes-input-group">
                      <input type="text" id="cotacoesNumCliente" required placeholder="Ex: 12345">
                      <button type="button" class="cotacoes-btn cotacoes-btn-secondary cotacoes-btn-sm" onclick="cotacoesPesquisarCliente()">ğŸ”</button>
                    </div>
                  </div>
                  <div class="cotacoes-form-group">
                    <label>CT6 - <span data-i18n="customer_name">Nome Cliente</span> <span class="required">*</span></label>
                    <input type="text" id="cotacoesNomeCliente" required data-i18n-placeholder="customer_name" placeholder="Nome do cliente">
                  </div>
                </div>
                <div class="cotacoes-form-row">
                  <div class="cotacoes-form-group">
                    <label>CT7 - <span data-i18n="email">Email</span></label>
                    <input type="email" id="cotacoesEmailCliente" placeholder="email@cliente.com">
                  </div>
                  <div class="cotacoes-form-group">
                    <label>CT8 - <span data-i18n="phone">Telefone</span></label>
                    <input type="tel" id="cotacoesTelCliente" placeholder="+351 ...">
                  </div>
                </div>
              </div>
              
              <!-- SecÃ§Ã£o: ServiÃ§o -->
              <div class="cotacoes-form-section">
                <h4 data-i18n="service_details">ğŸšš Detalhes do ServiÃ§o</h4>
                <div class="cotacoes-form-row">
                  <div class="cotacoes-form-group">
                    <label>CT9 - <span data-i18n="description">DescriÃ§Ã£o</span> <span class="required">*</span></label>
                    <input type="text" id="cotacoesDescricao" required data-i18n-placeholder="transport_type" placeholder="Tipo de transporte/mercadoria">
                  </div>
                </div>
                <div class="cotacoes-form-row">
                  <div class="cotacoes-form-group">
                    <label>CT10 - <span data-i18n="loading_location">Local de Carga</span> <span class="required">*</span></label>
                    <input type="text" id="cotacoesLocalCarga" required data-i18n-placeholder="city_country" placeholder="Cidade, PaÃ­s">
                  </div>
                  <div class="cotacoes-form-group">
                    <label>CT11 - <span data-i18n="unloading_location">Local de Descarga</span> <span class="required">*</span></label>
                    <input type="text" id="cotacoesLocalDescarga" required data-i18n-placeholder="city_country" placeholder="Cidade, PaÃ­s">
                  </div>
                </div>
                <div class="cotacoes-form-row">
                  <div class="cotacoes-form-group" style="grid-column: span 2;">
                    <label>CT12 - <span data-i18n="observations">ObservaÃ§Ãµes</span></label>
                    <textarea id="cotacoesObs" rows="2" data-i18n-placeholder="additional_notes" placeholder="Notas adicionais..."></textarea>
                  </div>
                </div>
              </div>
              
              <!-- SecÃ§Ã£o: PreÃ§os -->
              <div class="cotacoes-form-section">
                <h4 data-i18n="price_calculation">ğŸ’° CÃ¡lculo de PreÃ§o</h4>
                <div class="cotacoes-form-row cols-4">
                  <div class="cotacoes-form-group">
                    <label>CT13 - <span data-i18n="distance_km">DistÃ¢ncia (Km)</span></label>
                    <input type="number" id="cotacoesKm" step="1" min="0" placeholder="0" oninput="cotacoesCalcularTotal()">
                  </div>
                  <div class="cotacoes-form-group">
                    <label>CT14 - <span data-i18n="price_per_km">PreÃ§o por Km (â‚¬)</span></label>
                    <input type="number" id="cotacoesPrecoKm" step="0.01" min="0" placeholder="0.00" oninput="cotacoesCalcularTotal()">
                  </div>
                  <div class="cotacoes-form-group">
                    <label>CT15 - <span data-i18n="price_per_trip">PreÃ§o por Viagem (â‚¬)</span></label>
                    <input type="number" id="cotacoesPrecoViagem" step="0.01" min="0" placeholder="0.00" oninput="cotacoesCalcularTotal()">
                  </div>
                  <div class="cotacoes-form-group">
                    <label>CT16 - <span data-i18n="extras">Extras (â‚¬)</span></label>
                    <input type="number" id="cotacoesExtras" step="0.01" min="0" placeholder="0.00" oninput="cotacoesCalcularTotal()">
                  </div>
                </div>
                
                <!-- Caixa de CÃ¡lculo -->
                <div class="cotacoes-calculo-box">
                  <div class="cotacoes-calculo-row">
                    <span>Km Ã— â‚¬/Km</span>
                    <span id="cotacoesCalcKm">0.00 â‚¬</span>
                  </div>
                  <div class="cotacoes-calculo-row">
                    <span data-i18n="price_per_trip">PreÃ§o/Viagem</span>
                    <span id="cotacoesCalcViagem">0.00 â‚¬</span>
                  </div>
                  <div class="cotacoes-calculo-row">
                    <span data-i18n="extras">Extras</span>
                    <span id="cotacoesCalcExtras">0.00 â‚¬</span>
                  </div>
                  <div class="cotacoes-calculo-row total">
                    <span data-i18n="total">TOTAL</span>
                    <span id="cotacoesCalcTotal">0.00 â‚¬</span>
                  </div>
                </div>
              </div>
              
            </form>
          </div>
          <div class="cotacoes-modal-footer cotacoes-no-print">
            <button class="cotacoes-btn cotacoes-btn-secondary" onclick="cotacoesFecharModal()" data-i18n="cancel">Cancelar</button>
            <button class="cotacoes-btn cotacoes-btn-primary" onclick="cotacoesGuardar()" data-i18n="save_quotation">ğŸ’¾ Guardar CotaÃ§Ã£o</button>
          </div>
        </div>
      </div>
      
      <!-- Modal Converter em Reserva -->
      <div class="cotacoes-modal-overlay" id="cotacoesModalConverterOverlay" style="display: none;" onclick="if(event.target===this)cotacoesFecharModalConverter()">
        <div class="cotacoes-modal" style="max-width: 500px;">
          <div class="cotacoes-modal-header" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
            <h3 data-i18n="convert_to_booking">ğŸ”„ Converter em Reserva</h3>
            <button class="cotacoes-modal-close" onclick="cotacoesFecharModalConverter()">âœ•</button>
          </div>
          <div class="cotacoes-modal-body">
            <input type="hidden" id="cotacoesConverterId">
            <div class="bg-emerald-50 border border-emerald-200 rounded-lg p-4 mb-4">
              <p class="text-emerald-800 text-sm"><strong data-i18n="quotation">CotaÃ§Ã£o</strong>: <span id="cotacoesConverterNumero">-</span></p>
              <p class="text-emerald-800 text-sm"><strong data-i18n="customer">Cliente</strong>: <span id="cotacoesConverterCliente">-</span></p>
              <p class="text-emerald-800 text-sm"><strong data-i18n="value">Valor</strong>: <span id="cotacoesConverterValor">-</span></p>
            </div>
            <p class="text-slate-600 text-sm mb-4" data-i18n="convert_action_text">
              Esta aÃ§Ã£o irÃ¡ criar uma nova reserva baseada nesta cotaÃ§Ã£o e alterar o estado para "Convertida".
            </p>
            <div class="cotacoes-form-group">
              <label><span data-i18n="booking_date">Data da Reserva</span> <span class="required">*</span></label>
              <input type="date" id="cotacoesConverterData" required>
            </div>
          </div>
          <div class="cotacoes-modal-footer">
            <button class="cotacoes-btn cotacoes-btn-secondary" onclick="cotacoesFecharModalConverter()" data-i18n="cancel">Cancelar</button>
            <button class="cotacoes-btn cotacoes-btn-success" onclick="cotacoesConfirmarConversao()" data-i18n="confirm_conversion">âœ… Confirmar ConversÃ£o</button>
          </div>
        </div>
      </div>
      
    </section>

    <!-- PAGE: DASHBOARD FINANCEIRO -->
    <section id="page-dashboardfinanceiro" class="p-8 hidden">
      <div class="card">
        <div class="card-header">
          <h3 class="font-bold text-lg text-slate-800">ğŸ“Š Dashboard Financeiro</h3>
        </div>
        <div class="card-body">
          <p class="text-slate-600">Este mÃ³dulo redireciona para o Dashboard principal com foco em dados financeiros.</p>
          <button onclick="navegarPara('dashboard')" class="btn btn-primary mt-4">Ir para Dashboard</button>
        </div>
      </div>
    </section>

    <!-- PAGE: FICHAS FORNECEDORES -->
    <!-- PAGE: FICHAS FORNECEDORES -->
    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <!-- MÃ“DULO FORNECEDORES v5.9 - HTML PREFIXADO (LAYOUT ORIGINAL)                      -->
    <!-- Prefixo CSS: fornecedores-  |  Prefixo JS: fornecedores                          -->
    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <section id="page-fichasfornecedores" class="p-0 hidden">
      <div class="fornecedores-container">
        <!-- CabeÃ§alho -->
        <div class="fornecedores-header">
            <div class="fornecedores-header-left">
                <h1 data-i18n="suppliers_management">ğŸ¢ GestÃ£o de Fornecedores</h1>
                <p data-i18n="suppliers_subtitle">Sistema de GestÃ£o LogÃ­stica Global</p>
            </div>
            <div class="fornecedores-header-right">
                <span class="fornecedores-sap-status" data-i18n="sap_connected">SAP Conectado</span>
                <span class="fornecedores-module-badge" data-i18n="suppliers_module">MÃ³dulo Fornecedores</span>
            </div>
        </div>

        <!-- NavegaÃ§Ã£o por abas -->
        <div class="fornecedores-nav-tabs">
            <div class="fornecedores-nav-tab active" onclick="fornecedoresMostrarVista('lista')" data-i18n="supplier_list">ğŸ“‹ Lista de Fornecedores</div>
            <div class="fornecedores-nav-tab" onclick="fornecedoresMostrarVista('novo')" data-i18n="new_supplier">â• Novo Fornecedor</div>
            <div class="fornecedores-nav-tab" onclick="fornecedoresMostrarVista('detalhes')" id="fornecedoresTabDetalhes" style="display: none;" data-i18n="details">ğŸ‘ï¸ Detalhes</div>
        </div>

        <!-- ConteÃºdo Principal -->
        <div class="fornecedores-main-content">
            <div id="fornecedoresAlertContainer"></div>

            <!-- VISTA: Lista de Fornecedores -->
            <div id="fornecedoresVistaLista" class="fornecedores-view-section active">
                <div class="fornecedores-stats-row">
                    <div class="fornecedores-stat-card">
                        <div class="fornecedores-stat-card-icon">ğŸ¢</div>
                        <div class="fornecedores-stat-card-value" id="fornecedoresStatTotal">0</div>
                        <div class="fornecedores-stat-card-label" data-i18n="total_suppliers">Total Fornecedores</div>
                    </div>
                    <div class="fornecedores-stat-card">
                        <div class="fornecedores-stat-card-icon">âœ…</div>
                        <div class="fornecedores-stat-card-value" id="fornecedoresStatAtivos">0</div>
                        <div class="fornecedores-stat-card-label" data-i18n="active">Ativos</div>
                    </div>
                    <div class="fornecedores-stat-card">
                        <div class="fornecedores-stat-card-icon">ğŸ”’</div>
                        <div class="fornecedores-stat-card-value" id="fornecedoresStatBloqueados">0</div>
                        <div class="fornecedores-stat-card-label" data-i18n="blocked">Bloqueados</div>
                    </div>
                    <div class="fornecedores-stat-card">
                        <div class="fornecedores-stat-card-icon">ğŸ’³</div>
                        <div class="fornecedores-stat-card-value" id="fornecedoresStatDivida">â‚¬0.00</div>
                        <div class="fornecedores-stat-card-label" data-i18n="total_debt">Total em DÃ­vida</div>
                    </div>
                </div>

                <div class="fornecedores-toolbar">
                    <div class="fornecedores-search-box">
                        <input type="text" id="fornecedoresCampoPesquisa" data-i18n-placeholder="search_supplier_nif" placeholder="Pesquisar por nÃºmero, nome, NIF, cidade..." onkeyup="fornecedoresPesquisar()">
                    </div>
                    <button class="fornecedores-btn fornecedores-btn-vermelho" onclick="fornecedoresMostrarVista('novo')" data-i18n="new_supplier">â• Novo Fornecedor</button>
                    <button class="fornecedores-btn fornecedores-btn-amarelo" onclick="fornecedoresExportarLista()" data-i18n="export">ğŸ“¥ Exportar</button>
                </div>

                <div class="fornecedores-table-container" id="fornecedoresTableContainer">
                    <table class="fornecedores-table">
                        <thead>
                            <tr>
                                <th data-i18n="supplier_number">NÂº Fornecedor</th>
                                <th data-i18n="name">Nome</th>
                                <th data-i18n="tax_id">NIF</th>
                                <th data-i18n="city">Cidade</th>
                                <th data-i18n="country">PaÃ­s</th>
                                <th data-i18n="sap_account">Conta SAP</th>
                                <th data-i18n="status">Estado</th>
                                <th data-i18n="actions">AÃ§Ãµes</th>
                            </tr>
                        </thead>
                        <tbody id="fornecedoresTabelaFornecedores"></tbody>
                    </table>
                </div>

                <div id="fornecedoresEstadoVazio" class="fornecedores-empty-state" style="display: none;">
                    <div class="fornecedores-empty-state-icon">ğŸ“­</div>
                    <h3>Nenhum fornecedor encontrado</h3>
                    <p>Adicione o primeiro fornecedor para comeÃ§ar.</p>
                    <button class="fornecedores-btn fornecedores-btn-vermelho" onclick="fornecedoresMostrarVista('novo')">â• Adicionar Fornecedor</button>
                </div>
            </div>

            <!-- VISTA: Novo/Editar Fornecedor -->
            <div id="fornecedoresVistaNovo" class="fornecedores-view-section">
                <form id="fornecedoresFormFornecedor" onsubmit="fornecedoresGuardar(event)">
                    
                    <!-- SECÃ‡ÃƒO 1: IdentificaÃ§Ã£o -->
                    <section class="fornecedores-section-box">
                        <h2>ğŸ¢ SecÃ§Ã£o 1 - IdentificaÃ§Ã£o do Fornecedor</h2>
                        <div style="display: grid; grid-template-columns: 120px 200px 1fr; gap: 15px;">
                            <div class="fornecedores-form-group">
                                <label>F1 - NÂº Fornecedor:</label>
                                <input type="text" id="fornecedores_numero" disabled style="font-weight: bold; color: #c0392b; text-align: center;">
                            </div>
                            <div class="fornecedores-form-group">
                                <label>F2 - * NIF:</label>
                                <div class="fornecedores-input-button-wrapper">
                                    <input type="text" id="fornecedores_contribuinte" required maxlength="14" placeholder="123456789" onchange="fornecedoresPesquisarPorNIF()">
                                    <button type="button" onclick="fornecedoresPesquisarPorNIF()" title="Pesquisar e preencher dados">ğŸ”</button>
                                </div>
                            </div>
                            <div class="fornecedores-form-group">
                                <label>F3 - * Nome do Fornecedor:</label>
                                <input type="text" id="fornecedores_nome" required maxlength="100" placeholder="Nome completo da empresa">
                            </div>
                        </div>
                        <div class="fornecedores-sap-info">Dados sincronizados com SAP - Ao preencher o NIF, os dados serÃ£o importados automaticamente</div>
                    </section>

                    <!-- SECÃ‡ÃƒO 2: Morada -->
                    <section class="fornecedores-section-box">
                        <h2>ğŸ“ SecÃ§Ã£o 2 - Morada</h2>
                        <div class="fornecedores-grid-morada">
                            <div class="fornecedores-form-group">
                                <label>F4 - * Rua:</label>
                                <input type="text" id="fornecedores_rua" required maxlength="100">
                            </div>
                            <div class="fornecedores-form-group">
                                <label>F5 - * NÂº:</label>
                                <input type="text" id="fornecedores_numero_porta" required maxlength="10" style="max-width: 80px;">
                            </div>
                            <div class="fornecedores-form-group">
                                <label>F6 - * CÃ³d. Postal:</label>
                                <input type="text" id="fornecedores_codigo_postal" required maxlength="10" placeholder="0000-000" style="max-width: 120px;">
                            </div>
                            <div class="fornecedores-form-group">
                                <label>F7 - * Localidade:</label>
                                <input type="text" id="fornecedores_localidade" required maxlength="50">
                            </div>
                        </div>
                        <div class="fornecedores-grid-morada-2" style="margin-top: 15px;">
                            <div class="fornecedores-form-group">
                                <label>F8 - * Freguesia:</label>
                                <input type="text" id="fornecedores_freguesia" required maxlength="50">
                            </div>
                            <div class="fornecedores-form-group">
                                <label>F9 - * Cidade:</label>
                                <input type="text" id="fornecedores_cidade" required maxlength="50">
                            </div>
                            <div class="fornecedores-form-group">
                                <label>F10 - * Concelho:</label>
                                <input type="text" id="fornecedores_concelho" required maxlength="50">
                            </div>
                            <div class="fornecedores-form-group">
                                <label>F11 - * PaÃ­s:</label>
                                <select id="fornecedores_pais" required onchange="fornecedoresDefinirContaSAP()">
                                    <option value="">Selecione...</option>
                                    <optgroup label="Nacional">
                                        <option value="Portugal" data-tipo="nacional">Portugal</option>
                                    </optgroup>
                                    <optgroup label="UniÃ£o Europeia">
                                        <option value="Espanha" data-tipo="europeu">Espanha</option>
                                        <option value="FranÃ§a" data-tipo="europeu">FranÃ§a</option>
                                        <option value="Alemanha" data-tipo="europeu">Alemanha</option>
                                        <option value="ItÃ¡lia" data-tipo="europeu">ItÃ¡lia</option>
                                        <option value="Holanda" data-tipo="europeu">Holanda</option>
                                        <option value="BÃ©lgica" data-tipo="europeu">BÃ©lgica</option>
                                        <option value="PolÃ³nia" data-tipo="europeu">PolÃ³nia</option>
                                        <option value="Ãustria" data-tipo="europeu">Ãustria</option>
                                        <option value="Irlanda" data-tipo="europeu">Irlanda</option>
                                        <option value="GrÃ©cia" data-tipo="europeu">GrÃ©cia</option>
                                    </optgroup>
                                    <optgroup label="PaÃ­ses Terceiros">
                                        <option value="Reino Unido" data-tipo="terceiro">Reino Unido</option>
                                        <option value="SuÃ­Ã§a" data-tipo="terceiro">SuÃ­Ã§a</option>
                                        <option value="EUA" data-tipo="terceiro">EUA</option>
                                        <option value="Brasil" data-tipo="terceiro">Brasil</option>
                                        <option value="China" data-tipo="terceiro">China</option>
                                        <option value="Marrocos" data-tipo="terceiro">Marrocos</option>
                                        <option value="Outro" data-tipo="terceiro">Outro PaÃ­s Terceiro</option>
                                    </optgroup>
                                </select>
                            </div>
                        </div>
                        <div class="fornecedores-sap-info" id="fornecedoresSapContaInfo">Selecione o paÃ­s para definir a conta SAP automaticamente (22111... Nacional | 22112... Europeu | 22113... Terceiros)</div>
                    </section>

                    <!-- SECÃ‡ÃƒO 3: Contactos, Emails e Dados BancÃ¡rios -->
                    <section class="fornecedores-section-box">
                        <h2>ğŸ“ SecÃ§Ã£o 3 - Contactos, Emails e Dados BancÃ¡rios</h2>
                        <div class="fornecedores-grid-contactos-1">
                            <div class="fornecedores-form-group">
                                <label>F12 - * Telefone 1:</label>
                                <input type="tel" id="fornecedores_telefone1" required maxlength="20" placeholder="+351 xxxxxxxxx">
                            </div>
                            <div class="fornecedores-form-group">
                                <label>F13 - * Telefone 2:</label>
                                <input type="tel" id="fornecedores_telefone2" required maxlength="20">
                            </div>
                            <div class="fornecedores-form-group">
                                <label>F14 - * Contacto 1 (Nome):</label>
                                <input type="text" id="fornecedores_contacto1_nome" required maxlength="100">
                            </div>
                            <div class="fornecedores-form-group">
                                <label>F15 - * Contacto 2 (Nome):</label>
                                <input type="text" id="fornecedores_contacto2_nome" required maxlength="100">
                            </div>
                        </div>
                        <div class="fornecedores-grid-contactos-2">
                            <div class="fornecedores-form-group">
                                <label>F16 - * Email Geral:</label>
                                <input type="email" id="fornecedores_email_geral" required maxlength="100" placeholder="geral@empresa.pt">
                            </div>
                            <div class="fornecedores-form-group">
                                <label>F17 - * Email Contabilidade:</label>
                                <input type="email" id="fornecedores_email_contabilidade" required maxlength="100">
                            </div>
                            <div class="fornecedores-form-group">
                                <label>F18 - * Email Financeiro:</label>
                                <input type="email" id="fornecedores_email_financeiro" required maxlength="100">
                            </div>
                            <div class="fornecedores-form-group">
                                <label>F19 - * IBAN 1:</label>
                                <div class="fornecedores-iban-wrapper">
                                    <input type="text" id="fornecedores_iban1" required maxlength="50" placeholder="PT50...">
                                    <input type="file" id="fornecedores_anexo_iban1" style="display: none;" onchange="fornecedoresAnexoIbanCarregado(1)">
                                    <button type="button" class="fornecedores-btn-anexar" onclick="document.getElementById('fornecedores_anexo_iban1').click()">ğŸ“ Anexar</button>
                                    <button type="button" class="fornecedores-btn-abrir" onclick="fornecedoresAbrirAnexoIban(1)">ğŸ“‚ Abrir</button>
                                </div>
                            </div>
                            <div class="fornecedores-form-group">
                                <label>F21 - * IBAN 2:</label>
                                <div class="fornecedores-iban-wrapper">
                                    <input type="text" id="fornecedores_iban2" required maxlength="50" placeholder="PT50...">
                                    <input type="file" id="fornecedores_anexo_iban2" style="display: none;" onchange="fornecedoresAnexoIbanCarregado(2)">
                                    <button type="button" class="fornecedores-btn-anexar" onclick="document.getElementById('fornecedores_anexo_iban2').click()">ğŸ“ Anexar</button>
                                    <button type="button" class="fornecedores-btn-abrir" onclick="fornecedoresAbrirAnexoIban(2)">ğŸ“‚ Abrir</button>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- SECÃ‡ÃƒO 4: Dados ContabilÃ­sticos -->
                    <section class="fornecedores-section-box">
                        <h2>ğŸ’° SecÃ§Ã£o 4 - Dados ContabilÃ­sticos</h2>
                        <div class="fornecedores-grid-3">
                            <div class="fornecedores-form-group">
                                <label>F23 - Conta SAP (AutomÃ¡tica):</label>
                                <input type="text" id="fornecedores_conta_sap" readonly style="font-weight: bold; color: #27ae60;">
                            </div>
                            <div class="fornecedores-form-group">
                                <label>F24 - Tipo de Fornecedor:</label>
                                <input type="text" id="fornecedores_tipo" readonly>
                            </div>
                            <div class="fornecedores-form-group">
                                <label>F25 - * RetenÃ§Ã£o na Fonte:</label>
                                <select id="fornecedores_retencao_fonte" required>
                                    <option value="">Selecione...</option>
                                    <option value="com_retencao">Com RetenÃ§Ã£o na Fonte</option>
                                    <option value="sem_retencao">Sem RetenÃ§Ã£o na Fonte</option>
                                </select>
                            </div>
                        </div>
                        <h3>Contas de Contabilidade</h3>
                        <div class="fornecedores-grid-6">
                            <div class="fornecedores-form-group">
                                <label>F26 - Conta 1:</label>
                                <input type="text" id="fornecedores_conta_contab1" maxlength="50">
                            </div>
                            <div class="fornecedores-form-group">
                                <label>F27 - Conta 2:</label>
                                <input type="text" id="fornecedores_conta_contab2" maxlength="50">
                            </div>
                            <div class="fornecedores-form-group">
                                <label>F28 - Conta 3:</label>
                                <input type="text" id="fornecedores_conta_contab3" maxlength="50">
                            </div>
                            <div class="fornecedores-form-group">
                                <label>F29 - Conta 4:</label>
                                <input type="text" id="fornecedores_conta_contab4" maxlength="50">
                            </div>
                            <div class="fornecedores-form-group">
                                <label>F30 - Conta 5:</label>
                                <input type="text" id="fornecedores_conta_contab5" maxlength="50">
                            </div>
                            <div class="fornecedores-form-group">
                                <label>F31 - Conta 6:</label>
                                <input type="text" id="fornecedores_conta_contab6" maxlength="50">
                            </div>
                        </div>
                        <div class="fornecedores-sap-info">Todas as movimentaÃ§Ãµes (pagamentos, lanÃ§amentos, contabilidade) sÃ£o sincronizadas automaticamente com o SAP</div>
                    </section>

                    <!-- SECÃ‡ÃƒO 5: ConfiguraÃ§Ãµes e ObservaÃ§Ãµes -->
                    <section class="fornecedores-section-box">
                        <h2>âš™ï¸ SecÃ§Ã£o 5 - ConfiguraÃ§Ãµes e ObservaÃ§Ãµes</h2>
                        <h3>Estado do Fornecedor (selecione apenas um) e Acesso ao Portal</h3>
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px;">
                            <label class="fornecedores-checkbox-wrapper">
                                <input type="checkbox" id="fornecedores_cativo" onchange="fornecedoresSelecionarEstado('fornecedores_cativo')">
                                <span>F32 - Fornecedor Cativo</span>
                            </label>
                            <label class="fornecedores-checkbox-wrapper">
                                <input type="checkbox" id="fornecedores_bloqueado" onchange="fornecedoresSelecionarEstado('fornecedores_bloqueado')">
                                <span>F33 - Fornecedor Bloqueado</span>
                            </label>
                            <label class="fornecedores-checkbox-wrapper">
                                <input type="checkbox" id="fornecedores_inativo" onchange="fornecedoresSelecionarEstado('fornecedores_inativo')">
                                <span>F34 - Fornecedor Inativo</span>
                            </label>
                            <label class="fornecedores-checkbox-wrapper" style="border-color: #27ae60;">
                                <input type="checkbox" id="fornecedores_com_login" onchange="fornecedoresVerificarLogin()">
                                <span>F35 - ğŸ” Fornecedor com Login</span>
                            </label>
                        </div>
                        <div class="fornecedores-form-group" style="margin-top: 20px;">
                            <label>F36 - ObservaÃ§Ãµes:</label>
                            <textarea id="fornecedores_observacoes" maxlength="1000" placeholder="Notas adicionais sobre o fornecedor..."></textarea>
                        </div>
                        <div class="fornecedores-sap-info">Estado do fornecedor (Cativo/Bloqueado/Inativo) Ã© sincronizado automaticamente com o SAP</div>
                    </section>

                    <!-- BotÃµes de AÃ§Ã£o -->
                    <div class="fornecedores-form-actions">
                        <button type="button" class="fornecedores-btn-alterar" onclick="fornecedoresMostrarVista('lista')">âŒ Cancelar</button>
                        <button type="button" class="fornecedores-btn-alterar" onclick="fornecedoresAlterar()">âœï¸ Alterar Fornecedor</button>
                        <button type="submit" class="fornecedores-btn-guardar">ğŸ’¾ Guardar Fornecedor</button>
                    </div>
                </form>
            </div>

            <!-- VISTA: Detalhes do Fornecedor -->
            <div id="fornecedoresVistaDetalhes" class="fornecedores-view-section">
                <div id="fornecedoresConteudoDetalhes"></div>
            </div>
        </div>
      </div>

      <!-- Modal de ConfirmaÃ§Ã£o -->
      <div class="fornecedores-modal-overlay" id="fornecedoresModalConfirmacao">
        <div class="fornecedores-modal-content">
            <div class="fornecedores-modal-icon">âš ï¸</div>
            <h3>Confirmar EliminaÃ§Ã£o</h3>
            <p id="fornecedoresModalMensagem"></p>
            <div class="fornecedores-modal-buttons">
                <button class="fornecedores-btn fornecedores-btn-amarelo" onclick="fornecedoresFecharModal()" style="flex: 1;">Cancelar</button>
                <button class="fornecedores-btn fornecedores-btn-vermelho" onclick="fornecedoresConfirmarEliminacao()" style="flex: 1;">Eliminar</button>
            </div>
        </div>
      </div>

      <!-- Modal SAP -->
      <div class="fornecedores-modal-overlay" id="fornecedoresModalSAP">
        <div class="fornecedores-modal-content">
            <div class="fornecedores-modal-icon">ğŸ”—</div>
            <h3>SincronizaÃ§Ã£o SAP</h3>
            <p id="fornecedoresModalSAPMensagem">A enviar dados para o SAP...</p>
            <div style="margin-top: 20px;">
                <button class="fornecedores-btn fornecedores-btn-vermelho" onclick="fornecedoresFecharModalSAP()" style="width: 100%;">Fechar</button>
            </div>
        </div>
      </div>
    </section>

    <!-- PAGE: COMPRAS -->
    <section id="page-compras" class="p-8 hidden">
      <div class="card">
        <div class="card-header">
          <h3 class="font-bold text-lg text-slate-800">ğŸ›’ Compras</h3>
        </div>
        <div class="card-body">
          <div class="bg-rose-50 border border-rose-200 rounded-lg p-8 text-center">
            <span class="text-6xl mb-4 block">ğŸš§</span>
            <h4 class="text-xl font-bold text-rose-800 mb-2">MÃ³dulo em Desenvolvimento</h4>
            <p class="text-rose-700">GestÃ£o de encomendas e pedidos a fornecedores.</p>
            <p class="text-rose-600 text-sm mt-2">Funcionalidades previstas:</p>
            <ul class="text-rose-600 text-sm mt-2 space-y-1">
              <li>â€¢ Criar encomendas</li>
              <li>â€¢ Acompanhar estados</li>
              <li>â€¢ ReceÃ§Ã£o de mercadoria</li>
              <li>â€¢ Associar a faturas</li>
            </ul>
          </div>
        </div>
      </div>
    </section>

    <!-- PAGE: FATURAS FORNECEDORES -->
    <section id="page-faturasfornecedores" class="p-8 hidden">
      <div class="card">
        <div class="card-header">
          <h3 class="font-bold text-lg text-slate-800">ğŸ“„ Faturas de Fornecedores</h3>
        </div>
        <div class="card-body">
          <div class="bg-red-50 border border-red-200 rounded-lg p-8 text-center">
            <span class="text-6xl mb-4 block">ğŸš§</span>
            <h4 class="text-xl font-bold text-red-800 mb-2">MÃ³dulo em Desenvolvimento</h4>
            <p class="text-red-700">Registo de faturas recebidas de fornecedores.</p>
            <p class="text-red-600 text-sm mt-2">Funcionalidades previstas:</p>
            <ul class="text-red-600 text-sm mt-2 space-y-1">
              <li>â€¢ Registar faturas de fornecedores</li>
              <li>â€¢ Upload de documentos</li>
              <li>â€¢ Controlo de vencimentos</li>
              <li>â€¢ IntegraÃ§Ã£o com pagamentos</li>
            </ul>
          </div>
        </div>
      </div>
    </section>

    <!-- PAGE: NC FORNECEDORES -->
    <section id="page-ncfornecedores" class="p-8 hidden">
      <div class="card">
        <div class="card-header">
          <h3 class="font-bold text-lg text-slate-800">ğŸ“‘ Notas de CrÃ©dito de Fornecedores</h3>
        </div>
        <div class="card-body">
          <div class="bg-pink-50 border border-pink-200 rounded-lg p-8 text-center">
            <span class="text-6xl mb-4 block">ğŸš§</span>
            <h4 class="text-xl font-bold text-pink-800 mb-2">MÃ³dulo em Desenvolvimento</h4>
            <p class="text-pink-700">Notas de crÃ©dito recebidas de fornecedores.</p>
          </div>
        </div>
      </div>
    </section>

    <!-- PAGE: PAGAMENTOS -->
    <section id="page-pagamentos" class="p-8 hidden">
      <div class="card">
        <div class="card-header">
          <h3 class="font-bold text-lg text-slate-800">ğŸ’³ Pagamentos a Fornecedores</h3>
        </div>
        <div class="card-body">
          <div class="bg-violet-50 border border-violet-200 rounded-lg p-8 text-center">
            <span class="text-6xl mb-4 block">ğŸš§</span>
            <h4 class="text-xl font-bold text-violet-800 mb-2">MÃ³dulo em Desenvolvimento</h4>
            <p class="text-violet-700">Registo de pagamentos efetuados.</p>
            <p class="text-violet-600 text-sm mt-2">Funcionalidades previstas:</p>
            <ul class="text-violet-600 text-sm mt-2 space-y-1">
              <li>â€¢ Registar pagamentos</li>
              <li>â€¢ MÃ©todos de pagamento</li>
              <li>â€¢ Pagamentos parciais</li>
              <li>â€¢ Comprovativo de pagamento</li>
            </ul>
          </div>
        </div>
      </div>
    </section>

    <!-- PAGE: CC FORNECEDORES -->
    <section id="page-ccfornecedores" class="p-8 hidden">
      <div class="card">
        <div class="card-header">
          <h3 class="font-bold text-lg text-slate-800">ğŸ“’ Contas Correntes Fornecedores</h3>
        </div>
        <div class="card-body">
          <div class="bg-fuchsia-50 border border-fuchsia-200 rounded-lg p-8 text-center">
            <span class="text-6xl mb-4 block">ğŸš§</span>
            <h4 class="text-xl font-bold text-fuchsia-800 mb-2">MÃ³dulo em Desenvolvimento</h4>
            <p class="text-fuchsia-700">Saldos e extratos de fornecedores.</p>
          </div>
        </div>
      </div>
    </section>

    <!-- PAGE: GESTÃƒO DE FROTA -->
    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <!-- MÃ“DULO GESTÃƒO DE FROTA v5.8 - HTML PREFIXADO                                     -->
    <!-- Prefixo CSS: frota-  |  Prefixo JS: frota                                        -->
    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <section id="page-gestaofrota" class="p-0 hidden" style="display: none;">
      <div class="frota-container">
        <!-- Header do mÃ³dulo -->
        <div class="frota-header">
          <div>
            <h1>ğŸš› GestÃ£o de Frota</h1>
            <p>Controlo de VeÃ­culos e Reboques</p>
          </div>
          <div class="frota-header-right">
            <span class="frota-module-badge">ğŸš› TRATORES</span>
            <span class="frota-module-badge frota-reboque">ğŸšƒ REBOQUES</span>
            <span class="frota-sap-status">âš™ï¸ <span id="frotaConfigBtn" onclick="frotaAbrirConfigAlertas()" style="cursor:pointer;">Configurar Alertas</span></span>
          </div>
        </div>

        <!-- Tabs de navegaÃ§Ã£o -->
        <div class="frota-nav-tabs" id="frotaNavTabs">
          <div class="frota-nav-tab active" draggable="true" data-vista="listaCamioes" onclick="frotaMostrarVista('listaCamioes')"><span class="frota-drag-handle">â‹®â‹®</span>ğŸš› Tratores PrÃ³prios</div>
          <div class="frota-nav-tab" draggable="true" data-vista="novoCamiao" onclick="frotaMostrarVista('novoCamiao')"><span class="frota-drag-handle">â‹®â‹®</span>â• Novo Trator</div>
          <div class="frota-nav-tab" draggable="true" data-vista="listaCamioesTerceiros" onclick="frotaMostrarVista('listaCamioesTerceiros')"><span class="frota-drag-handle">â‹®â‹®</span>ğŸšš Tratores Contratados</div>
          <div class="frota-nav-tab" draggable="true" data-vista="novoCamiaoTerceiro" onclick="frotaMostrarVista('novoCamiaoTerceiro')"><span class="frota-drag-handle">â‹®â‹®</span>â• Novo Trator Contratado</div>
          <div class="frota-nav-tab frota-reboque" draggable="true" data-vista="listaReboques" onclick="frotaMostrarVista('listaReboques')"><span class="frota-drag-handle">â‹®â‹®</span>ğŸšƒ Reboques PrÃ³prios</div>
          <div class="frota-nav-tab frota-reboque" draggable="true" data-vista="novoReboque" onclick="frotaMostrarVista('novoReboque')"><span class="frota-drag-handle">â‹®â‹®</span>â• Novo Reboque</div>
          <div class="frota-nav-tab frota-reboque" draggable="true" data-vista="listaReboquesTerceiros" onclick="frotaMostrarVista('listaReboquesTerceiros')"><span class="frota-drag-handle">â‹®â‹®</span>ğŸš‹ Reboques Contratados</div>
          <div class="frota-nav-tab frota-reboque" draggable="true" data-vista="novoReboqueTerceiro" onclick="frotaMostrarVista('novoReboqueTerceiro')"><span class="frota-drag-handle">â‹®â‹®</span>â• Novo Reboque Contratado</div>
        </div>

        <div class="frota-main-content">
          <div id="frotaAlertContainer"></div>
          <div id="frotaAlertasVencimento"></div>

          <!-- ==================== LISTA TRATORES PRÃ“PRIOS ==================== -->
          <div id="frotaVistaListaCamioes" class="frota-view-section active">
            <div class="frota-stats-row">
              <div class="frota-stat-card"><div class="frota-stat-card-icon">ğŸš›</div><div class="frota-stat-card-value" id="frotaStatTotalCamioes">0</div><div class="frota-stat-card-label">Total</div></div>
              <div class="frota-stat-card"><div class="frota-stat-card-icon">âœ…</div><div class="frota-stat-card-value" id="frotaStatCamioesAtivos">0</div><div class="frota-stat-card-label">Ativos</div></div>
              <div class="frota-stat-card"><div class="frota-stat-card-icon">â˜¢ï¸</div><div class="frota-stat-card-value" id="frotaStatCamioesADR">0</div><div class="frota-stat-card-label">ADR</div></div>
              <div class="frota-stat-card"><div class="frota-stat-card-icon">âš ï¸</div><div class="frota-stat-card-value" id="frotaStatCamioesVencer">0</div><div class="frota-stat-card-label">A Vencer</div></div>
            </div>
            <div class="frota-toolbar">
              <div class="frota-search-box"><input type="text" id="frotaPesquisaCamioes" placeholder="Pesquisar matrÃ­cula, marca..." onkeyup="frotaPesquisarCamioes()"></div>
              <button class="frota-btn frota-btn-vermelho" onclick="frotaMostrarVista('novoCamiao')">â• Novo Trator</button>
              <button class="frota-btn frota-btn-laranja" onclick="frotaExportarCamioes()">ğŸ“¥ Exportar</button>
            </div>
            <div class="frota-table-container">
              <table class="frota-table">
                <thead><tr><th>MatrÃ­cula</th><th>Marca</th><th>Ano</th><th>ADR</th><th>InspeÃ§Ã£o</th><th>TacÃ³grafo</th><th>Estado</th><th>AÃ§Ãµes</th></tr></thead>
                <tbody id="frotaTabelaCamioes"></tbody>
              </table>
            </div>
          </div>

          <!-- ==================== NOVO TRATOR ==================== -->
          <div id="frotaVistaNovoCamiao" class="frota-view-section">
            <form id="frotaFormCamiao" onsubmit="frotaGuardarCamiao(event)">
              <section class="frota-section-box">
                <h2>ğŸš› SecÃ§Ã£o 1 - IdentificaÃ§Ã£o</h2>
                <div style="display: grid; grid-template-columns: 130px 1fr 90px 140px; gap: 10px; margin-bottom: 10px;">
                  <div class="frota-form-group"><label>GF1 - * MatrÃ­cula:</label><input type="text" id="frotaCam_matricula" required placeholder="00-AA-00" style="text-transform: uppercase; font-weight: bold;"></div>
                  <div class="frota-form-group"><label>GF2 - DUA:</label><div class="frota-input-btn-group"><input type="text" id="frotaCam_dua_nome" readonly placeholder="Documento"><input type="file" id="frotaCam_dua" style="display:none;" onchange="frotaAnexarDoc(this,'frotaCam_dua_nome')"><button type="button" class="frota-btn frota-btn-laranja frota-btn-sm" onclick="document.getElementById('frotaCam_dua').click()">ğŸ“</button><button type="button" class="frota-btn frota-btn-verde frota-btn-sm" onclick="frotaAbrirDoc('frotaCam_dua')">ğŸ“‚</button></div></div>
                  <div class="frota-form-group"><label>GF3 - * Ano:</label><input type="number" id="frotaCam_ano" required min="1990" max="2030" placeholder="2020"></div>
                  <div class="frota-form-group"><label>GF4 - * Marca:</label><select id="frotaCam_marca" required><option value="">Selecione...</option><option>Volvo</option><option>Scania</option><option>Mercedes</option><option>MAN</option><option>DAF</option><option>Iveco</option><option>Renault</option></select></div>
                </div>
                <div style="display: grid; grid-template-columns: 150px 130px 1fr; gap: 10px;">
                  <div class="frota-form-group"><label>GF5 - Pneus:</label><input type="text" id="frotaCam_pneus" placeholder="315/55/22.5"></div>
                  <div class="frota-form-group"><label>GF6 - ADR:</label><div class="frota-radio-group"><label class="frota-radio-wrapper"><input type="radio" name="frotaCam_adr" value="Sim">â˜¢ï¸ Sim</label><label class="frota-radio-wrapper selected"><input type="radio" name="frotaCam_adr" value="NÃ£o" checked>NÃ£o</label></div></div>
                  <div class="frota-form-group"><label>GF7 - Estado:</label><div class="frota-radio-group"><label class="frota-radio-wrapper selected"><input type="radio" name="frotaCam_estado" value="Ativo" checked>âœ… Ativo</label><label class="frota-radio-wrapper"><input type="radio" name="frotaCam_estado" value="ManutenÃ§Ã£o">ğŸ”§ ManutenÃ§Ã£o</label><label class="frota-radio-wrapper"><input type="radio" name="frotaCam_estado" value="Inativo">â¸ï¸ Inativo</label></div></div>
                </div>
              </section>

              <section class="frota-section-box">
                <h2>ğŸ“… SecÃ§Ã£o 2 - DocumentaÃ§Ã£o</h2>
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;">
                  <div class="frota-form-group"><label>GF8 - * PrÃ³x. InspeÃ§Ã£o:</label><input type="date" id="frotaCam_inspecao_data" required><div class="frota-input-btn-group" style="margin-top:4px;"><input type="text" id="frotaCam_inspecao_doc_nome" readonly placeholder="Doc" style="font-size:10px;"><input type="file" id="frotaCam_inspecao_doc" style="display:none;" onchange="frotaAnexarDoc(this,'frotaCam_inspecao_doc_nome')"><button type="button" class="frota-btn frota-btn-laranja frota-btn-sm" onclick="document.getElementById('frotaCam_inspecao_doc').click()">ğŸ“</button><button type="button" class="frota-btn frota-btn-verde frota-btn-sm" onclick="frotaAbrirDoc('frotaCam_inspecao_doc')">ğŸ“‚</button></div></div>
                  <div class="frota-form-group"><label>GF9 - * PrÃ³x. TacÃ³grafo:</label><input type="date" id="frotaCam_tacografo_data" required><div class="frota-input-btn-group" style="margin-top:4px;"><input type="text" id="frotaCam_tacografo_doc_nome" readonly placeholder="Doc" style="font-size:10px;"><input type="file" id="frotaCam_tacografo_doc" style="display:none;" onchange="frotaAnexarDoc(this,'frotaCam_tacografo_doc_nome')"><button type="button" class="frota-btn frota-btn-laranja frota-btn-sm" onclick="document.getElementById('frotaCam_tacografo_doc').click()">ğŸ“</button><button type="button" class="frota-btn frota-btn-verde frota-btn-sm" onclick="frotaAbrirDoc('frotaCam_tacografo_doc')">ğŸ“‚</button></div></div>
                  <div class="frota-form-group"><label>GF10 - * PrÃ³x. LicenÃ§a:</label><input type="date" id="frotaCam_licenca_data" required><div class="frota-input-btn-group" style="margin-top:4px;"><input type="text" id="frotaCam_licenca_doc_nome" readonly placeholder="Doc" style="font-size:10px;"><input type="file" id="frotaCam_licenca_doc" style="display:none;" onchange="frotaAnexarDoc(this,'frotaCam_licenca_doc_nome')"><button type="button" class="frota-btn frota-btn-laranja frota-btn-sm" onclick="document.getElementById('frotaCam_licenca_doc').click()">ğŸ“</button><button type="button" class="frota-btn frota-btn-verde frota-btn-sm" onclick="frotaAbrirDoc('frotaCam_licenca_doc')">ğŸ“‚</button></div></div>
                  <div class="frota-form-group"><label>GF11 - * PrÃ³x. Seguro:</label><input type="date" id="frotaCam_seguro_data" required><div class="frota-input-btn-group" style="margin-top:4px;"><input type="text" id="frotaCam_seguro_doc_nome" readonly placeholder="Doc" style="font-size:10px;"><input type="file" id="frotaCam_seguro_doc" style="display:none;" onchange="frotaAnexarDoc(this,'frotaCam_seguro_doc_nome')"><button type="button" class="frota-btn frota-btn-laranja frota-btn-sm" onclick="document.getElementById('frotaCam_seguro_doc').click()">ğŸ“</button><button type="button" class="frota-btn frota-btn-verde frota-btn-sm" onclick="frotaAbrirDoc('frotaCam_seguro_doc')">ğŸ“‚</button></div></div>
                </div>
              </section>

              <section class="frota-section-box">
                <h2>ğŸ”§ SecÃ§Ã£o 3 - RevisÃµes</h2>
                <div style="display: grid; grid-template-columns: 120px 1fr 120px 100px; gap: 10px;">
                  <div class="frota-form-group"><label>GF12 - RevisÃ£o (Km):</label><input type="number" id="frotaCam_revisao_km" placeholder="150000"></div>
                  <div class="frota-form-group"><label>GF13 - Tipo RevisÃ£o:</label><input type="text" id="frotaCam_revisao_tipo" placeholder="RevisÃ£o completa, Ã³leo, filtros..."></div>
                  <div class="frota-form-group"><label>GF14 - PrÃ³x. Rev. (Km):</label><input type="number" id="frotaCam_proxima_revisao_km" placeholder="200000"></div>
                  <div class="frota-form-group"><label>GF15 - Km Atual:</label><input type="number" id="frotaCam_km_atual" placeholder="175000"></div>
                </div>
                <div class="frota-form-group" style="margin-top: 10px;"><label>GF16 - Docs RevisÃ£o:</label><div class="frota-input-btn-group"><input type="text" id="frotaCam_revisao_docs_nome" readonly placeholder="Nenhum documento"><input type="file" id="frotaCam_revisao_docs" style="display:none;" multiple onchange="frotaAnexarMultDoc(this,'frotaCam_revisao_docs_nome')"><button type="button" class="frota-btn frota-btn-laranja frota-btn-sm" onclick="document.getElementById('frotaCam_revisao_docs').click()">ğŸ“ Anexar</button><button type="button" class="frota-btn frota-btn-verde frota-btn-sm" onclick="frotaAbrirMultDoc('frotaCam_revisao_docs')">ğŸ“‚ Abrir</button></div></div>
              </section>

              <section class="frota-section-box">
                <h2>âš ï¸ SecÃ§Ã£o 4 - IntervenÃ§Ãµes NÃ£o Programadas</h2>
                <div id="frotaListaIntervencoes"></div>
                <button type="button" class="frota-btn frota-btn-azul" onclick="frotaAbrirModalIntervencao()" style="margin-top:8px;">â• Adicionar IntervenÃ§Ã£o</button>
              </section>

              <section class="frota-section-box">
                <h2>ğŸ“ SecÃ§Ã£o 5 - ObservaÃ§Ãµes</h2>
                <div class="frota-form-group"><label>GF17 - ObservaÃ§Ãµes:</label><textarea id="frotaCam_observacoes" rows="2" placeholder="Notas..."></textarea></div>
              </section>

              <div class="frota-form-actions">
                <button type="button" class="frota-btn frota-btn-laranja" onclick="frotaMostrarVista('listaCamioes')" style="flex:1;">âŒ Cancelar</button>
                <button type="submit" class="frota-btn-guardar">ğŸ’¾ Guardar Trator</button>
              </div>
            </form>
          </div>

          <!-- ==================== LISTA TRATORES TERCEIROS ==================== -->
          <div id="frotaVistaListaCamioesTerceiros" class="frota-view-section">
            <div class="frota-stats-row">
              <div class="frota-stat-card"><div class="frota-stat-card-icon">ğŸšš</div><div class="frota-stat-card-value" id="frotaStatTotalCamioesTer">0</div><div class="frota-stat-card-label">Total</div></div>
              <div class="frota-stat-card"><div class="frota-stat-card-icon">âœ…</div><div class="frota-stat-card-value" id="frotaStatCamioesTerAtivos">0</div><div class="frota-stat-card-label">Ativos</div></div>
              <div class="frota-stat-card"><div class="frota-stat-card-icon">âš ï¸</div><div class="frota-stat-card-value" id="frotaStatCamioesTerVencer">0</div><div class="frota-stat-card-label">A Vencer</div></div>
            </div>
            <div class="frota-toolbar">
              <div class="frota-search-box"><input type="text" id="frotaPesquisaCamioesTer" placeholder="Pesquisar matrÃ­cula, transportador..." onkeyup="frotaPesquisarCamioesTer()"></div>
              <button class="frota-btn frota-btn-vermelho" onclick="frotaMostrarVista('novoCamiaoTerceiro')">â• Novo Trator Contratado</button>
              <button class="frota-btn frota-btn-laranja" onclick="frotaExportarCamioesTer()">ğŸ“¥ Exportar</button>
            </div>
            <div class="frota-table-container">
              <table class="frota-table">
                <thead><tr><th>Transportador</th><th>MatrÃ­cula</th><th>Ano</th><th>Seguro</th><th>LicenÃ§a</th><th>CMR</th><th>Estado</th><th>AÃ§Ãµes</th></tr></thead>
                <tbody id="frotaTabelaCamioesTer"></tbody>
              </table>
            </div>
          </div>

          <!-- ==================== NOVO TRATOR TERCEIRO ==================== -->
          <div id="frotaVistaNovoCamiaoTerceiro" class="frota-view-section">
            <form id="frotaFormCamiaoTer" onsubmit="frotaGuardarCamiaoTer(event)">
              <section class="frota-section-box">
                <h2>ğŸšš Trator Contratado (Transportador/Fornecedor)</h2>
                <div style="display: grid; grid-template-columns: 1fr 150px 100px; gap: 10px; margin-bottom: 10px;">
                  <div class="frota-form-group"><label>1. * Transportador (Fornecedor):</label><select id="frotaCamter_transportador" required><option value="">Selecione o fornecedor...</option></select></div>
                  <div class="frota-form-group"><label>2. * MatrÃ­cula:</label><input type="text" id="frotaCamter_matricula" required placeholder="00-AA-00" style="text-transform: uppercase; font-weight: bold;"></div>
                  <div class="frota-form-group"><label>4. * Ano:</label><input type="number" id="frotaCamter_ano" required min="1990" max="2030" placeholder="2020"></div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                  <div class="frota-form-group"><label>3. DUA:</label><div class="frota-input-btn-group"><input type="text" id="frotaCamter_dua_nome" readonly placeholder="Documento Ãšnico AutomÃ³vel"><input type="file" id="frotaCamter_dua" style="display:none;" onchange="frotaAnexarDoc(this,'frotaCamter_dua_nome')"><button type="button" class="frota-btn frota-btn-laranja frota-btn-sm" onclick="document.getElementById('frotaCamter_dua').click()">ğŸ“ Anexar</button><button type="button" class="frota-btn frota-btn-verde frota-btn-sm" onclick="frotaAbrirDoc('frotaCamter_dua')">ğŸ“‚ Abrir</button></div></div>
                  <div class="frota-form-group"><label>5. * Ficha de Seguro:</label><input type="date" id="frotaCamter_seguro_data" required><div class="frota-input-btn-group" style="margin-top:4px;"><input type="text" id="frotaCamter_seguro_doc_nome" readonly placeholder="Documento" style="font-size:10px;"><input type="file" id="frotaCamter_seguro_doc" style="display:none;" onchange="frotaAnexarDoc(this,'frotaCamter_seguro_doc_nome')"><button type="button" class="frota-btn frota-btn-laranja frota-btn-sm" onclick="document.getElementById('frotaCamter_seguro_doc').click()">ğŸ“</button><button type="button" class="frota-btn frota-btn-verde frota-btn-sm" onclick="frotaAbrirDoc('frotaCamter_seguro_doc')">ğŸ“‚</button></div></div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                  <div class="frota-form-group"><label>6. * LicenÃ§a ComunitÃ¡ria:</label><input type="date" id="frotaCamter_licenca_data" required><div class="frota-input-btn-group" style="margin-top:4px;"><input type="text" id="frotaCamter_licenca_doc_nome" readonly placeholder="Documento" style="font-size:10px;"><input type="file" id="frotaCamter_licenca_doc" style="display:none;" onchange="frotaAnexarDoc(this,'frotaCamter_licenca_doc_nome')"><button type="button" class="frota-btn frota-btn-laranja frota-btn-sm" onclick="document.getElementById('frotaCamter_licenca_doc').click()">ğŸ“</button><button type="button" class="frota-btn frota-btn-verde frota-btn-sm" onclick="frotaAbrirDoc('frotaCamter_licenca_doc')">ğŸ“‚</button></div></div>
                  <div class="frota-form-group"><label>7. * Seguro CMR:</label><input type="date" id="frotaCamter_cmr_data" required><div class="frota-input-btn-group" style="margin-top:4px;"><input type="text" id="frotaCamter_cmr_doc_nome" readonly placeholder="Documento" style="font-size:10px;"><input type="file" id="frotaCamter_cmr_doc" style="display:none;" onchange="frotaAnexarDoc(this,'frotaCamter_cmr_doc_nome')"><button type="button" class="frota-btn frota-btn-laranja frota-btn-sm" onclick="document.getElementById('frotaCamter_cmr_doc').click()">ğŸ“</button><button type="button" class="frota-btn frota-btn-verde frota-btn-sm" onclick="frotaAbrirDoc('frotaCamter_cmr_doc')">ğŸ“‚</button></div></div>
                </div>
                <div style="margin-top: 10px;">
                  <div class="frota-form-group"><label>Estado:</label><div class="frota-radio-group"><label class="frota-radio-wrapper selected"><input type="radio" name="frotaCamter_estado" value="Ativo" checked>âœ… Ativo</label><label class="frota-radio-wrapper"><input type="radio" name="frotaCamter_estado" value="Inativo">â¸ï¸ Inativo</label></div></div>
                </div>
              </section>
              <div class="frota-form-actions">
                <button type="button" class="frota-btn frota-btn-laranja" onclick="frotaMostrarVista('listaCamioesTerceiros')" style="flex:1;">âŒ Cancelar</button>
                <button type="submit" class="frota-btn-guardar">ğŸ’¾ Guardar Trator Contratado</button>
              </div>
            </form>
          </div>


          <!-- ==================== LISTA REBOQUES PRÃ“PRIOS ==================== -->
          <div id="frotaVistaListaReboques" class="frota-view-section">
            <div class="frota-stats-row">
              <div class="frota-stat-card frota-reboque"><div class="frota-stat-card-icon">ğŸšƒ</div><div class="frota-stat-card-value" id="frotaStatTotalReboques">0</div><div class="frota-stat-card-label">Total</div></div>
              <div class="frota-stat-card frota-reboque"><div class="frota-stat-card-icon">âœ…</div><div class="frota-stat-card-value" id="frotaStatReboquesAtivos">0</div><div class="frota-stat-card-label">Ativos</div></div>
              <div class="frota-stat-card frota-reboque"><div class="frota-stat-card-icon">ğŸ¯</div><div class="frota-stat-card-value" id="frotaStatReboquesBobines">0</div><div class="frota-stat-card-label">Bobines</div></div>
              <div class="frota-stat-card frota-reboque"><div class="frota-stat-card-icon">ğŸ“</div><div class="frota-stat-card-value" id="frotaStatReboquesMega">0</div><div class="frota-stat-card-label">Mega</div></div>
              <div class="frota-stat-card frota-reboque"><div class="frota-stat-card-icon">â¬†ï¸</div><div class="frota-stat-card-value" id="frotaStatReboquesTeto">0</div><div class="frota-stat-card-label">Lev. Teto</div></div>
              <div class="frota-stat-card frota-reboque"><div class="frota-stat-card-icon">â˜¢ï¸</div><div class="frota-stat-card-value" id="frotaStatReboquesADR">0</div><div class="frota-stat-card-label">ADR</div></div>
              <div class="frota-stat-card frota-reboque"><div class="frota-stat-card-icon">âš ï¸</div><div class="frota-stat-card-value" id="frotaStatReboquesVencer">0</div><div class="frota-stat-card-label">A Vencer</div></div>
            </div>
            <div class="frota-toolbar">
              <div class="frota-search-box"><input type="text" id="frotaPesquisaReboques" placeholder="Pesquisar matrÃ­cula, marca..." onkeyup="frotaPesquisarReboques()"></div>
              <button class="frota-btn frota-btn-roxo" onclick="frotaMostrarVista('novoReboque')">â• Novo Reboque</button>
              <button class="frota-btn frota-btn-laranja" onclick="frotaExportarReboques()">ğŸ“¥ Exportar</button>
            </div>
            <div class="frota-table-container">
              <table class="frota-table">
                <thead class="frota-reboque"><tr><th>MatrÃ­cula</th><th>Marca</th><th>Ano</th><th>Bobines</th><th>Mega</th><th>Teto</th><th>ADR</th><th>InspeÃ§Ã£o</th><th>Estado</th><th>AÃ§Ãµes</th></tr></thead>
                <tbody id="frotaTabelaReboques"></tbody>
              </table>
            </div>
          </div>

          <!-- ==================== NOVO REBOQUE ==================== -->
          <div id="frotaVistaNovoReboque" class="frota-view-section">
            <form id="frotaFormReboque" onsubmit="frotaGuardarReboque(event)">
              <section class="frota-section-box frota-reboque">
                <h2>ğŸšƒ SecÃ§Ã£o 1 - IdentificaÃ§Ã£o do Reboque</h2>
                <div style="display: grid; grid-template-columns: 130px 1fr 90px 140px; gap: 10px; margin-bottom: 10px;">
                  <div class="frota-form-group"><label>GF1 - * MatrÃ­cula:</label><input type="text" id="frotaReb_matricula" required placeholder="A-000000" style="text-transform: uppercase; font-weight: bold;"></div>
                  <div class="frota-form-group"><label>GF2 - DUA:</label><div class="frota-input-btn-group"><input type="text" id="frotaReb_dua_nome" readonly placeholder="Documento"><input type="file" id="frotaReb_dua" style="display:none;" onchange="frotaAnexarDoc(this,'frotaReb_dua_nome')"><button type="button" class="frota-btn frota-btn-laranja frota-btn-sm" onclick="document.getElementById('frotaReb_dua').click()">ğŸ“</button><button type="button" class="frota-btn frota-btn-verde frota-btn-sm" onclick="frotaAbrirDoc('frotaReb_dua')">ğŸ“‚</button></div></div>
                  <div class="frota-form-group"><label>GF3 - * Ano:</label><input type="number" id="frotaReb_ano" required min="1990" max="2030" placeholder="2020"></div>
                  <div class="frota-form-group"><label>GF4 - * Marca:</label><select id="frotaReb_marca" required><option value="">Selecione...</option><option>Schmitz</option><option>Krone</option><option>Kogel</option><option>Wielton</option><option>Lecitrailer</option><option>Lamberet</option><option>Fruehauf</option></select></div>
                </div>
                <div style="display: grid; grid-template-columns: 150px 140px 140px 140px 1fr; gap: 10px; margin-bottom: 10px;">
                  <div class="frota-form-group"><label>GF5 - Pneus:</label><input type="text" id="frotaReb_pneus" placeholder="385/55/22.5"></div>
                  <div class="frota-form-group"><label>6. Porta Bobines:</label><div class="frota-radio-group"><label class="frota-radio-wrapper"><input type="radio" name="frotaReb_bobines" value="Sim">ğŸ¯ Sim</label><label class="frota-radio-wrapper selected"><input type="radio" name="frotaReb_bobines" value="NÃ£o" checked>NÃ£o</label></div></div>
                  <div class="frota-form-group"><label>7. Mega:</label><div class="frota-radio-group"><label class="frota-radio-wrapper"><input type="radio" name="frotaReb_mega" value="Sim">ğŸ“ Sim</label><label class="frota-radio-wrapper selected"><input type="radio" name="frotaReb_mega" value="NÃ£o" checked>NÃ£o</label></div></div>
                  <div class="frota-form-group"><label>8. Levanta Teto:</label><div class="frota-radio-group"><label class="frota-radio-wrapper"><input type="radio" name="frotaReb_teto" value="Sim">â¬†ï¸ Sim</label><label class="frota-radio-wrapper selected"><input type="radio" name="frotaReb_teto" value="NÃ£o" checked>NÃ£o</label></div></div>
                  <div class="frota-form-group"><label>9. ADR:</label><div class="frota-radio-group"><label class="frota-radio-wrapper"><input type="radio" name="frotaReb_adr" value="Sim">â˜¢ï¸ Sim</label><label class="frota-radio-wrapper selected"><input type="radio" name="frotaReb_adr" value="NÃ£o" checked>NÃ£o</label></div></div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr; gap: 10px;">
                  <div class="frota-form-group"><label>Estado:</label><div class="frota-radio-group"><label class="frota-radio-wrapper selected"><input type="radio" name="frotaReb_estado" value="Ativo" checked>âœ… Ativo</label><label class="frota-radio-wrapper"><input type="radio" name="frotaReb_estado" value="ManutenÃ§Ã£o">ğŸ”§ ManutenÃ§Ã£o</label><label class="frota-radio-wrapper"><input type="radio" name="frotaReb_estado" value="Inativo">â¸ï¸ Inativo</label></div></div>
                </div>
              </section>

              <section class="frota-section-box frota-reboque">
                <h2>ğŸ“… SecÃ§Ã£o 2 - DocumentaÃ§Ã£o</h2>
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;">
                  <div class="frota-form-group"><label>10. * PrÃ³x. InspeÃ§Ã£o:</label><input type="date" id="frotaReb_inspecao_data" required><div class="frota-input-btn-group" style="margin-top:4px;"><input type="text" id="frotaReb_inspecao_doc_nome" readonly placeholder="Doc" style="font-size:10px;"><input type="file" id="frotaReb_inspecao_doc" style="display:none;" onchange="frotaAnexarDoc(this,'frotaReb_inspecao_doc_nome')"><button type="button" class="frota-btn frota-btn-laranja frota-btn-sm" onclick="document.getElementById('frotaReb_inspecao_doc').click()">ğŸ“</button><button type="button" class="frota-btn frota-btn-verde frota-btn-sm" onclick="frotaAbrirDoc('frotaReb_inspecao_doc')">ğŸ“‚</button></div></div>
                  <div class="frota-form-group"><label>11. * PrÃ³x. TacÃ³grafo:</label><input type="date" id="frotaReb_tacografo_data" required><div class="frota-input-btn-group" style="margin-top:4px;"><input type="text" id="frotaReb_tacografo_doc_nome" readonly placeholder="Doc" style="font-size:10px;"><input type="file" id="frotaReb_tacografo_doc" style="display:none;" onchange="frotaAnexarDoc(this,'frotaReb_tacografo_doc_nome')"><button type="button" class="frota-btn frota-btn-laranja frota-btn-sm" onclick="document.getElementById('frotaReb_tacografo_doc').click()">ğŸ“</button><button type="button" class="frota-btn frota-btn-verde frota-btn-sm" onclick="frotaAbrirDoc('frotaReb_tacografo_doc')">ğŸ“‚</button></div></div>
                  <div class="frota-form-group"><label>12. * PrÃ³x. LicenÃ§a:</label><input type="date" id="frotaReb_licenca_data" required><div class="frota-input-btn-group" style="margin-top:4px;"><input type="text" id="frotaReb_licenca_doc_nome" readonly placeholder="Doc" style="font-size:10px;"><input type="file" id="frotaReb_licenca_doc" style="display:none;" onchange="frotaAnexarDoc(this,'frotaReb_licenca_doc_nome')"><button type="button" class="frota-btn frota-btn-laranja frota-btn-sm" onclick="document.getElementById('frotaReb_licenca_doc').click()">ğŸ“</button><button type="button" class="frota-btn frota-btn-verde frota-btn-sm" onclick="frotaAbrirDoc('frotaReb_licenca_doc')">ğŸ“‚</button></div></div>
                  <div class="frota-form-group"><label>13. * PrÃ³x. Seguro:</label><input type="date" id="frotaReb_seguro_data" required><div class="frota-input-btn-group" style="margin-top:4px;"><input type="text" id="frotaReb_seguro_doc_nome" readonly placeholder="Doc" style="font-size:10px;"><input type="file" id="frotaReb_seguro_doc" style="display:none;" onchange="frotaAnexarDoc(this,'frotaReb_seguro_doc_nome')"><button type="button" class="frota-btn frota-btn-laranja frota-btn-sm" onclick="document.getElementById('frotaReb_seguro_doc').click()">ğŸ“</button><button type="button" class="frota-btn frota-btn-verde frota-btn-sm" onclick="frotaAbrirDoc('frotaReb_seguro_doc')">ğŸ“‚</button></div></div>
                </div>
              </section>

              <section class="frota-section-box frota-reboque">
                <h2>ğŸ”§ SecÃ§Ã£o 3 - RevisÃµes</h2>
                <div style="display: grid; grid-template-columns: 120px 1fr 120px; gap: 10px;">
                  <div class="frota-form-group"><label>14. RevisÃ£o (Km):</label><input type="number" id="frotaReb_revisao_km" placeholder="100000"></div>
                  <div class="frota-form-group"><label>15. Tipo RevisÃ£o:</label><input type="text" id="frotaReb_revisao_tipo" placeholder="RevisÃ£o eixos, travÃµes, lonas..."></div>
                  <div class="frota-form-group"><label>16. PrÃ³x. Rev. (Km):</label><input type="number" id="frotaReb_proxima_revisao_km" placeholder="150000"></div>
                </div>
              </section>

              <section class="frota-section-box frota-reboque">
                <h2>âš ï¸ SecÃ§Ã£o 4 - IntervenÃ§Ãµes NÃ£o Programadas</h2>
                <div id="frotaListaIntervencoesReb"></div>
                <button type="button" class="frota-btn frota-btn-roxo" onclick="frotaAbrirModalIntervencaoReb()" style="margin-top:8px;">â• Adicionar IntervenÃ§Ã£o</button>
              </section>

              <section class="frota-section-box frota-reboque">
                <h2>ğŸ“ SecÃ§Ã£o 5 - ObservaÃ§Ãµes</h2>
                <div class="frota-form-group"><label>17. ObservaÃ§Ãµes:</label><textarea id="frotaReb_observacoes" rows="2" placeholder="Notas..."></textarea></div>
              </section>

              <div class="frota-form-actions">
                <button type="button" class="frota-btn frota-btn-laranja" onclick="frotaMostrarVista('listaReboques')" style="flex:1;">âŒ Cancelar</button>
                <button type="submit" class="frota-btn-guardar frota-reboque">ğŸ’¾ Guardar Reboque</button>
              </div>
            </form>
          </div>

          <!-- ==================== LISTA REBOQUES TERCEIROS ==================== -->
          <div id="frotaVistaListaReboquesTerceiros" class="frota-view-section">
            <div class="frota-stats-row">
              <div class="frota-stat-card frota-reboque"><div class="frota-stat-card-icon">ğŸš‹</div><div class="frota-stat-card-value" id="frotaStatTotalReboquesTer">0</div><div class="frota-stat-card-label">Total</div></div>
              <div class="frota-stat-card frota-reboque"><div class="frota-stat-card-icon">âœ…</div><div class="frota-stat-card-value" id="frotaStatReboquesTerAtivos">0</div><div class="frota-stat-card-label">Ativos</div></div>
              <div class="frota-stat-card frota-reboque"><div class="frota-stat-card-icon">âš ï¸</div><div class="frota-stat-card-value" id="frotaStatReboquesTerVencer">0</div><div class="frota-stat-card-label">A Vencer</div></div>
            </div>
            <div class="frota-toolbar">
              <div class="frota-search-box"><input type="text" id="frotaPesquisaReboquesTer" placeholder="Pesquisar matrÃ­cula, transportador..." onkeyup="frotaPesquisarReboquesTer()"></div>
              <button class="frota-btn frota-btn-roxo" onclick="frotaMostrarVista('novoReboqueTerceiro')">â• Novo Reboque Contratado</button>
              <button class="frota-btn frota-btn-laranja" onclick="frotaExportarReboquesTer()">ğŸ“¥ Exportar</button>
            </div>
            <div class="frota-table-container">
              <table class="frota-table">
                <thead class="frota-reboque"><tr><th>Transportador</th><th>MatrÃ­cula</th><th>Ano</th><th>Seguro</th><th>LicenÃ§a</th><th>CMR</th><th>Estado</th><th>AÃ§Ãµes</th></tr></thead>
                <tbody id="frotaTabelaReboquesTer"></tbody>
              </table>
            </div>
          </div>

          <!-- ==================== NOVO REBOQUE TERCEIRO ==================== -->
          <div id="frotaVistaNovoReboqueTerceiro" class="frota-view-section">
            <form id="frotaFormReboqueTer" onsubmit="frotaGuardarReboqueTer(event)">
              <section class="frota-section-box frota-reboque">
                <h2>ğŸš‹ Reboque Contratado (Transportador/Fornecedor)</h2>
                <div style="display: grid; grid-template-columns: 1fr 150px 100px; gap: 10px; margin-bottom: 10px;">
                  <div class="frota-form-group"><label>1. * Transportador (Fornecedor):</label><select id="frotaRebter_transportador" required><option value="">Selecione o fornecedor...</option></select></div>
                  <div class="frota-form-group"><label>2. * MatrÃ­cula:</label><input type="text" id="frotaRebter_matricula" required placeholder="A-000000" style="text-transform: uppercase; font-weight: bold;"></div>
                  <div class="frota-form-group"><label>4. * Ano:</label><input type="number" id="frotaRebter_ano" required min="1990" max="2030" placeholder="2020"></div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                  <div class="frota-form-group"><label>3. DUA:</label><div class="frota-input-btn-group"><input type="text" id="frotaRebter_dua_nome" readonly placeholder="Documento Ãšnico AutomÃ³vel"><input type="file" id="frotaRebter_dua" style="display:none;" onchange="frotaAnexarDoc(this,'frotaRebter_dua_nome')"><button type="button" class="frota-btn frota-btn-laranja frota-btn-sm" onclick="document.getElementById('frotaRebter_dua').click()">ğŸ“ Anexar</button><button type="button" class="frota-btn frota-btn-verde frota-btn-sm" onclick="frotaAbrirDoc('frotaRebter_dua')">ğŸ“‚ Abrir</button></div></div>
                  <div class="frota-form-group"><label>5. * Ficha de Seguro:</label><input type="date" id="frotaRebter_seguro_data" required><div class="frota-input-btn-group" style="margin-top:4px;"><input type="text" id="frotaRebter_seguro_doc_nome" readonly placeholder="Documento" style="font-size:10px;"><input type="file" id="frotaRebter_seguro_doc" style="display:none;" onchange="frotaAnexarDoc(this,'frotaRebter_seguro_doc_nome')"><button type="button" class="frota-btn frota-btn-laranja frota-btn-sm" onclick="document.getElementById('frotaRebter_seguro_doc').click()">ğŸ“</button><button type="button" class="frota-btn frota-btn-verde frota-btn-sm" onclick="frotaAbrirDoc('frotaRebter_seguro_doc')">ğŸ“‚</button></div></div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                  <div class="frota-form-group"><label>6. * LicenÃ§a ComunitÃ¡ria:</label><input type="date" id="frotaRebter_licenca_data" required><div class="frota-input-btn-group" style="margin-top:4px;"><input type="text" id="frotaRebter_licenca_doc_nome" readonly placeholder="Documento" style="font-size:10px;"><input type="file" id="frotaRebter_licenca_doc" style="display:none;" onchange="frotaAnexarDoc(this,'frotaRebter_licenca_doc_nome')"><button type="button" class="frota-btn frota-btn-laranja frota-btn-sm" onclick="document.getElementById('frotaRebter_licenca_doc').click()">ğŸ“</button><button type="button" class="frota-btn frota-btn-verde frota-btn-sm" onclick="frotaAbrirDoc('frotaRebter_licenca_doc')">ğŸ“‚</button></div></div>
                  <div class="frota-form-group"><label>7. * Seguro CMR:</label><input type="date" id="frotaRebter_cmr_data" required><div class="frota-input-btn-group" style="margin-top:4px;"><input type="text" id="frotaRebter_cmr_doc_nome" readonly placeholder="Documento" style="font-size:10px;"><input type="file" id="frotaRebter_cmr_doc" style="display:none;" onchange="frotaAnexarDoc(this,'frotaRebter_cmr_doc_nome')"><button type="button" class="frota-btn frota-btn-laranja frota-btn-sm" onclick="document.getElementById('frotaRebter_cmr_doc').click()">ğŸ“</button><button type="button" class="frota-btn frota-btn-verde frota-btn-sm" onclick="frotaAbrirDoc('frotaRebter_cmr_doc')">ğŸ“‚</button></div></div>
                </div>
                <div style="margin-top: 10px;">
                  <div class="frota-form-group"><label>Estado:</label><div class="frota-radio-group"><label class="frota-radio-wrapper selected"><input type="radio" name="frotaRebter_estado" value="Ativo" checked>âœ… Ativo</label><label class="frota-radio-wrapper"><input type="radio" name="frotaRebter_estado" value="Inativo">â¸ï¸ Inativo</label></div></div>
                </div>
              </section>
              <div class="frota-form-actions">
                <button type="button" class="frota-btn frota-btn-laranja" onclick="frotaMostrarVista('listaReboquesTerceiros')" style="flex:1;">âŒ Cancelar</button>
                <button type="submit" class="frota-btn-guardar frota-reboque">ğŸ’¾ Guardar Reboque Contratado</button>
              </div>
            </form>
          </div>

        </div>
      </div>

      <!-- Modal IntervenÃ§Ã£o CamiÃ£o -->
      <div class="frota-modal-overlay" id="frotaModalIntervencao">
        <div class="frota-modal-content" style="text-align: left;">
          <h3 style="margin-bottom: 15px; color: #2c3e50;">âš ï¸ Nova IntervenÃ§Ã£o - Trator</h3>
          <div class="frota-form-group" style="margin-bottom: 12px;"><label>Data:</label><input type="date" id="frotaInt_data"></div>
          <div class="frota-form-group" style="margin-bottom: 12px;"><label>Km:</label><input type="number" id="frotaInt_km" placeholder="175000"></div>
          <div class="frota-form-group" style="margin-bottom: 12px;"><label>DescriÃ§Ã£o:</label><textarea id="frotaInt_descricao" rows="2" placeholder="O que foi feito..."></textarea></div>
          <div class="frota-form-group" style="margin-bottom: 12px;"><label>Motivo:</label><textarea id="frotaInt_motivo" rows="2" placeholder="Motivo da intervenÃ§Ã£o..."></textarea></div>
          <div class="frota-form-group" style="margin-bottom: 12px;"><label>Documentos:</label><div class="frota-input-btn-group"><input type="text" id="frotaInt_docs_nome" readonly placeholder="Nenhum"><input type="file" id="frotaInt_docs" style="display:none;" multiple onchange="frotaAnexarMultDoc(this,'frotaInt_docs_nome')"><button type="button" class="frota-btn frota-btn-laranja frota-btn-sm" onclick="document.getElementById('frotaInt_docs').click()">ğŸ“</button></div></div>
          <div style="display: flex; gap: 10px; margin-top: 15px;">
            <button type="button" class="frota-btn frota-btn-laranja" onclick="frotaFecharModalIntervencao()" style="flex:1;">Cancelar</button>
            <button type="button" class="frota-btn frota-btn-verde" onclick="frotaSalvarIntervencao()" style="flex:1;">ğŸ’¾ Guardar</button>
          </div>
        </div>
      </div>

      <!-- Modal IntervenÃ§Ã£o Reboque -->
      <div class="frota-modal-overlay" id="frotaModalIntervencaoReb">
        <div class="frota-modal-content" style="text-align: left;">
          <h3 style="margin-bottom: 15px; color: #9b59b6;">âš ï¸ Nova IntervenÃ§Ã£o - Reboque</h3>
          <div class="frota-form-group" style="margin-bottom: 12px;"><label>Data:</label><input type="date" id="frotaIntReb_data"></div>
          <div class="frota-form-group" style="margin-bottom: 12px;"><label>Km:</label><input type="number" id="frotaIntReb_km" placeholder="175000"></div>
          <div class="frota-form-group" style="margin-bottom: 12px;"><label>DescriÃ§Ã£o:</label><textarea id="frotaIntReb_descricao" rows="2" placeholder="O que foi feito..."></textarea></div>
          <div class="frota-form-group" style="margin-bottom: 12px;"><label>Motivo:</label><textarea id="frotaIntReb_motivo" rows="2" placeholder="Motivo da intervenÃ§Ã£o..."></textarea></div>
          <div class="frota-form-group" style="margin-bottom: 12px;"><label>Documentos:</label><div class="frota-input-btn-group"><input type="text" id="frotaIntReb_docs_nome" readonly placeholder="Nenhum"><input type="file" id="frotaIntReb_docs" style="display:none;" multiple onchange="frotaAnexarMultDoc(this,'frotaIntReb_docs_nome')"><button type="button" class="frota-btn frota-btn-laranja frota-btn-sm" onclick="document.getElementById('frotaIntReb_docs').click()">ğŸ“</button></div></div>
          <div style="display: flex; gap: 10px; margin-top: 15px;">
            <button type="button" class="frota-btn frota-btn-laranja" onclick="frotaFecharModalIntervencaoReb()" style="flex:1;">Cancelar</button>
            <button type="button" class="frota-btn frota-btn-roxo" onclick="frotaSalvarIntervencaoReb()" style="flex:1;">ğŸ’¾ Guardar</button>
          </div>
        </div>
      </div>

      <!-- Modal ConfiguraÃ§Ã£o Alertas -->
      <div class="frota-modal-overlay" id="frotaModalConfigAlertas">
        <div class="frota-modal-content" style="text-align: left; max-width: 600px;">
          <h3 style="margin-bottom: 20px; color: #2c3e50;">âš™ï¸ ConfiguraÃ§Ã£o de Alertas</h3>
          <div style="background: #e8f4fd; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
            <h4 style="margin-bottom: 10px; color: #2980b9;">ğŸ“§ Alertas por Email (60 dias antecedÃªncia)</h4>
            <p style="font-size: 12px; color: #666; margin-bottom: 10px;">Emails enviados automaticamente quando documentos estÃ£o a 60 dias de expirar:</p>
            <div class="frota-form-group" style="margin-bottom: 8px;"><label>Email Oficina:</label><input type="email" id="frotaAlertaEmailOficina" value="oficina@emeutrans.pt" style="width: 100%;"></div>
            <div class="frota-form-group"><label>Email Controlo Custos:</label><input type="email" id="frotaAlertaEmailCustos" value="controlo.custos@emeutrans.pt" style="width: 100%;"></div>
          </div>
          <div style="background: #fef3e2; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
            <h4 style="margin-bottom: 10px; color: #e67e22;">ğŸ”” Pop-up no EcrÃ£</h4>
            <p style="font-size: 12px; color: #666; margin-bottom: 10px;">Alertas visuais para utilizadores quando documentos estÃ£o a expirar:</p>
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 13px;"><input type="checkbox" id="frotaAlertaPopupLogistica" checked> Utilizadores LogÃ­stica</label>
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 13px; margin-top: 5px;"><input type="checkbox" id="frotaAlertaPopupCustos" checked> Utilizadores Controlo Custos</label>
          </div>
          <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
            <h4 style="margin-bottom: 10px; color: #495057;">â° AntecedÃªncia dos Alertas</h4>
            <div class="frota-form-group"><label>Dias de antecedÃªncia:</label><input type="number" id="frotaAlertaDias" value="60" min="1" max="180" style="width: 100px;"> dias</div>
          </div>
          <div style="display: flex; gap: 10px;">
            <button type="button" class="frota-btn frota-btn-laranja" onclick="frotaFecharConfigAlertas()" style="flex:1;">Cancelar</button>
            <button type="button" class="frota-btn frota-btn-verde" onclick="frotaGuardarConfigAlertas()" style="flex:1;">ğŸ’¾ Guardar</button>
            <button type="button" class="frota-btn frota-btn-azul" onclick="frotaTestarAlertas()" style="flex:1;">ğŸ§ª Testar</button>
          </div>
        </div>
      </div>

      <!-- Modal Alerta Vencimentos -->
      <div class="frota-modal-overlay" id="frotaModalAlertaVencimentos">
        <div class="frota-modal-content" style="text-align: left; max-width: 700px; max-height: 80vh; overflow-y: auto;">
          <div style="background: linear-gradient(135deg, #e74c3c, #c0392b); color: white; padding: 20px; border-radius: 8px 8px 0 0; margin: -22px -22px 20px -22px;">
            <h3 style="display: flex; align-items: center; gap: 10px;">ğŸš¨ ALERTA - Documentos a Expirar</h3>
            <p style="font-size: 12px; opacity: 0.9; margin-top: 5px;">Os seguintes documentos estÃ£o prÃ³ximos da data de validade</p>
          </div>
          <div id="frotaListaAlertasVencimentos"></div>
          <div style="background: #d4edda; padding: 12px; border-radius: 8px; margin: 15px 0;">
            <p style="font-size: 12px; margin: 0;"><strong>ğŸ“§ Emails enviados para:</strong> oficina@emeutrans.pt, controlo.custos@emeutrans.pt</p>
          </div>
          <div style="display: flex; gap: 10px;">
            <button type="button" class="frota-btn frota-btn-laranja" onclick="frotaFecharAlertaVencimentos()" style="flex:1;">Fechar</button>
            <button type="button" class="frota-btn frota-btn-verde" onclick="frotaMarcarAlertasVistos()" style="flex:1;">âœ… Marcar como Vistos</button>
          </div>
        </div>
      </div>

      <!-- Modal ConfirmaÃ§Ã£o -->
      <div class="frota-modal-overlay" id="frotaModalConfirmacao">
        <div class="frota-modal-content" style="text-align: center;">
          <div style="font-size: 40px; margin-bottom: 12px;">âš ï¸</div>
          <h3 id="frotaModalTitulo">Confirmar</h3>
          <p id="frotaModalMensagem" style="margin: 12px 0;"></p>
          <div style="display: flex; gap: 10px; margin-top: 15px;">
            <button class="frota-btn frota-btn-laranja" onclick="frotaFecharModal()" style="flex:1;">Cancelar</button>
            <button class="frota-btn frota-btn-vermelho" onclick="frotaConfirmarAcao()" style="flex:1;">Confirmar</button>
          </div>
        </div>
      </div>
    </section>


    <!-- PAGE: VEÃCULOS -->
    <section id="page-veiculos" class="p-8 hidden">
      <div class="card">
        <div class="card-header">
          <h3 class="font-bold text-lg text-slate-800">ğŸš› VeÃ­culos</h3>
        </div>
        <div class="card-body">
          <div class="bg-lime-50 border border-lime-200 rounded-lg p-8 text-center">
            <span class="text-6xl mb-4 block">ğŸš§</span>
            <h4 class="text-xl font-bold text-lime-800 mb-2">MÃ³dulo em Desenvolvimento</h4>
            <p class="text-lime-700">Fichas dos veÃ­culos da frota.</p>
            <p class="text-lime-600 text-sm mt-2">Funcionalidades previstas:</p>
            <ul class="text-lime-600 text-sm mt-2 space-y-1">
              <li>â€¢ Ficha do veÃ­culo</li>
              <li>â€¢ Documentos (seguro, inspeÃ§Ã£o, etc.)</li>
              <li>â€¢ HistÃ³rico de manutenÃ§Ã£o</li>
              <li>â€¢ Quilometragem</li>
            </ul>
          </div>
        </div>
      </div>
    </section>

    <!-- PAGE: MOTORISTAS -->
    <section id="page-motoristas" class="p-8 hidden">
      <div class="card">
        <div class="card-header">
          <h3 class="font-bold text-lg text-slate-800">ğŸ§‘â€âœˆï¸ Motoristas</h3>
        </div>
        <div class="card-body">
          <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-8 text-center">
            <span class="text-6xl mb-4 block">ğŸš§</span>
            <h4 class="text-xl font-bold text-yellow-800 mb-2">MÃ³dulo em Desenvolvimento</h4>
            <p class="text-yellow-700">Custos e gestÃ£o de motoristas.</p>
          </div>
        </div>
      </div>
    </section>

    <!-- PAGE: COMBUSTÃVEL -->
    <section id="page-combustivel" class="p-8 hidden">
      <div class="card">
        <div class="card-header">
          <h3 class="font-bold text-lg text-slate-800">â›½ CombustÃ­vel</h3>
        </div>
        <div class="card-body">
          <div class="bg-amber-50 border border-amber-200 rounded-lg p-8 text-center">
            <span class="text-6xl mb-4 block">ğŸš§</span>
            <h4 class="text-xl font-bold text-amber-800 mb-2">MÃ³dulo em Desenvolvimento</h4>
            <p class="text-amber-700">Registo e anÃ¡lise de consumos de combustÃ­vel.</p>
          </div>
        </div>
      </div>
    </section>

    <!-- PAGE: MANUTENÃ‡ÃƒO -->
    <section id="page-manutencao" class="p-8 hidden">
      <div class="card">
        <div class="card-header">
          <h3 class="font-bold text-lg text-slate-800">ğŸ”§ ManutenÃ§Ã£o</h3>
        </div>
        <div class="card-body">
          <div class="bg-stone-50 border border-stone-200 rounded-lg p-8 text-center">
            <span class="text-6xl mb-4 block">ğŸš§</span>
            <h4 class="text-xl font-bold text-stone-800 mb-2">MÃ³dulo em Desenvolvimento</h4>
            <p class="text-stone-700">Oficina, pneus, revisÃµes e reparaÃ§Ãµes.</p>
          </div>
        </div>
      </div>
    </section>

    <!-- PAGE: PORTAGENS -->
    <section id="page-portagens" class="p-8 hidden">
      <div class="card">
        <div class="card-header">
          <h3 class="font-bold text-lg text-slate-800">ğŸ›£ï¸ Portagens</h3>
        </div>
        <div class="card-body">
          <div class="bg-neutral-50 border border-neutral-200 rounded-lg p-8 text-center">
            <span class="text-6xl mb-4 block">ğŸš§</span>
            <h4 class="text-xl font-bold text-neutral-800 mb-2">MÃ³dulo em Desenvolvimento</h4>
            <p class="text-neutral-700">Via Verde, SCUT e outras portagens.</p>
          </div>
        </div>
      </div>
    </section>

    <!-- PAGE: DASHBOARD CONTABILIDADE -->
    <section id="page-dashboardcontabilidade" class="p-8 hidden">
      <div class="card">
        <div class="card-header">
          <h3 class="font-bold text-lg text-slate-800">ğŸ“Š Dashboard Contabilidade</h3>
        </div>
        <div class="card-body">
          <div class="bg-emerald-50 border border-emerald-200 rounded-lg p-8 text-center">
            <span class="text-6xl mb-4 block">ğŸš§</span>
            <h4 class="text-xl font-bold text-emerald-800 mb-2">MÃ³dulo em Desenvolvimento</h4>
            <p class="text-emerald-700">Resumo contabilÃ­stico geral.</p>
          </div>
        </div>
      </div>
    </section>

    <!-- PAGE: SAF-T -->
    <section id="page-saft" class="p-8 hidden">
      <div class="card">
        <div class="card-header">
          <h3 class="font-bold text-lg text-slate-800">ğŸ“ SAF-T</h3>
        </div>
        <div class="card-body">
          <div class="bg-blue-50 border border-blue-200 rounded-lg p-8 text-center">
            <span class="text-6xl mb-4 block">ğŸš§</span>
            <h4 class="text-xl font-bold text-blue-800 mb-2">MÃ³dulo em Desenvolvimento</h4>
            <p class="text-blue-700">ExportaÃ§Ã£o de ficheiro SAF-T para as FinanÃ§as.</p>
          </div>
        </div>
      </div>
    </section>

    <!-- PAGE: RELATÃ“RIOS -->
    <section id="page-relatorios" class="p-8 hidden">
      <div class="card">
        <div class="card-header">
          <h3 class="font-bold text-lg text-slate-800">ğŸ“ˆ RelatÃ³rios</h3>
        </div>
        <div class="card-body">
          <div class="bg-cyan-50 border border-cyan-200 rounded-lg p-8 text-center">
            <span class="text-6xl mb-4 block">ğŸš§</span>
            <h4 class="text-xl font-bold text-cyan-800 mb-2">MÃ³dulo em Desenvolvimento</h4>
            <p class="text-cyan-700">BalanÃ§os, mapas e relatÃ³rios contabilÃ­sticos.</p>
          </div>
        </div>
      </div>
    </section>

    <!-- PAGE: FUNCIONÃRIOS -->
    <section id="page-funcionarios" class="p-8 hidden">
      <div class="card">
        <div class="card-header">
          <h3 class="font-bold text-lg text-slate-800">ğŸ‘· FuncionÃ¡rios</h3>
        </div>
        <div class="card-body">
          <div class="bg-orange-50 border border-orange-200 rounded-lg p-8 text-center">
            <span class="text-6xl mb-4 block">ğŸš§</span>
            <h4 class="text-xl font-bold text-orange-800 mb-2">MÃ³dulo em Desenvolvimento</h4>
            <p class="text-orange-700">Fichas pessoais dos funcionÃ¡rios.</p>
          </div>
        </div>
      </div>
    </section>

    <!-- PAGE: CONTRATOS -->
    <section id="page-contratos" class="p-8 hidden">
      <div class="card">
        <div class="card-header">
          <h3 class="font-bold text-lg text-slate-800">ğŸ“ Contratos</h3>
        </div>
        <div class="card-body">
          <div class="bg-rose-50 border border-rose-200 rounded-lg p-8 text-center">
            <span class="text-6xl mb-4 block">ğŸš§</span>
            <h4 class="text-xl font-bold text-rose-800 mb-2">MÃ³dulo em Desenvolvimento</h4>
            <p class="text-rose-700">Documentos laborais e contratos.</p>
          </div>
        </div>
      </div>
    </section>

    <!-- PAGE: SALÃRIOS -->
    <section id="page-salarios" class="p-8 hidden">
      <div class="card">
        <div class="card-header">
          <h3 class="font-bold text-lg text-slate-800">ğŸ’µ SalÃ¡rios</h3>
        </div>
        <div class="card-body">
          <div class="bg-green-50 border border-green-200 rounded-lg p-8 text-center">
            <span class="text-6xl mb-4 block">ğŸš§</span>
            <h4 class="text-xl font-bold text-green-800 mb-2">MÃ³dulo em Desenvolvimento</h4>
            <p class="text-green-700">Processamento de salÃ¡rios.</p>
          </div>
        </div>
      </div>
    </section>

    <!-- PAGE: FÃ‰RIAS -->
    <section id="page-ferias" class="p-8 hidden">
      <div class="card">
        <div class="card-header">
          <h3 class="font-bold text-lg text-slate-800">ğŸ–ï¸ FÃ©rias</h3>
        </div>
        <div class="card-body">
          <div class="bg-teal-50 border border-teal-200 rounded-lg p-8 text-center">
            <span class="text-6xl mb-4 block">ğŸš§</span>
            <h4 class="text-xl font-bold text-teal-800 mb-2">MÃ³dulo em Desenvolvimento</h4>
            <p class="text-teal-700">MarcaÃ§Ãµes e saldos de fÃ©rias.</p>
          </div>
        </div>
      </div>
    </section>

    <!-- PAGE: DOCUMENTOS RH -->
    <section id="page-documentosrh" class="p-8 hidden">
      <div class="card">
        <div class="card-header">
          <h3 class="font-bold text-lg text-slate-800">ğŸ“‚ Documentos RH</h3>
        </div>
        <div class="card-body">
          <div class="bg-purple-50 border border-purple-200 rounded-lg p-8 text-center">
            <span class="text-6xl mb-4 block">ğŸš§</span>
            <h4 class="text-xl font-bold text-purple-800 mb-2">MÃ³dulo em Desenvolvimento</h4>
            <p class="text-purple-700">CertidÃµes, seguros e outros documentos.</p>
          </div>
        </div>
      </div>
    </section>

  </main>

  <!-- MODAL: NOVA FATURA -->
  <div id="modalFatura" class="modal-overlay">
    <div class="modal-content" style="max-width: 1200px;">
      <div class="modal-header">
        <h3 id="modalFaturaTitulo">ğŸ“„ Nova Fatura</h3>
        <button onclick="fecharModal('modalFatura')" class="text-white hover:text-emerald-200 text-2xl">&times;</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="faturaId">
        <input type="hidden" id="faturaTipo" value="avulso">
        
        <!-- Tipo de FaturaÃ§Ã£o -->
        <div class="mb-6 p-4 bg-slate-50 rounded-lg">
          <label class="font-bold text-slate-700 mb-2 block">Tipo de FaturaÃ§Ã£o</label>
          <div class="flex gap-4">
            <label class="checkbox-container">
              <input type="radio" name="tipoFaturacao" value="avulso" checked onchange="mudarTipoFaturacao(this.value)">
              <span>Avulso (sem reserva)</span>
            </label>
            <label class="checkbox-container">
              <input type="radio" name="tipoFaturacao" value="reserva" onchange="mudarTipoFaturacao(this.value)">
              <span>Com Reserva(s)</span>
            </label>
          </div>
        </div>
        
        <!-- CabeÃ§alho da Fatura -->
        <div class="grid grid-cols-4 gap-4 mb-6">
          <div class="form-group">
            <label>FT1 - NÃºmero *</label>
            <input type="text" id="faturaNumero" disabled class="bg-slate-100 font-mono font-bold">
          </div>
          <div class="form-group">
            <label>FT2 - Data EmissÃ£o *</label>
            <input type="date" id="faturaData" required>
          </div>
          <div class="form-group">
            <label>FT3 - Data Vencimento *</label>
            <input type="date" id="faturaVencimento" required>
          </div>
          <div class="form-group">
            <label>FT4 - CondiÃ§Ãµes Pagamento</label>
            <input type="text" id="faturaCondicoes" disabled class="bg-slate-100">
          </div>
        </div>
        
        <div class="grid grid-cols-3 gap-4 mb-6">
          <div class="form-group">
            <label>FT5 - Cliente *</label>
            <select id="faturaCliente" onchange="preencherDadosCliente()" required>
              <option value="">-- Selecione o Cliente --</option>
            </select>
          </div>
          <div class="form-group">
            <label>FT6 - NIF</label>
            <input type="text" id="faturaNIF" disabled class="bg-slate-100">
          </div>
          <div class="form-group">
            <label>FT7 - Tipo Cliente</label>
            <input type="text" id="faturaTipoCliente" disabled class="bg-slate-100">
          </div>
        </div>
        
        <div class="form-group mb-6">
          <label>FT8 - Morada de FaturaÃ§Ã£o</label>
          <input type="text" id="faturaMorada" disabled class="bg-slate-100">
        </div>
        
        <!-- Linhas da Fatura (Estilo Excel) -->
        <div class="mb-4">
          <div class="flex justify-between items-center mb-3">
            <label class="font-bold text-slate-700">Linhas da Fatura (mÃ¡x. 30 linhas)</label>
            <div class="flex gap-2">
              <span class="text-sm text-slate-500" id="contadorLinhas">0/30 linhas</span>
              <button type="button" onclick="adicionarLinhaFatura()" class="btn btn-info btn-sm">â• Adicionar Linha</button>
            </div>
          </div>
          
          <!-- CabeÃ§alho tipo Excel - Campos alinhados com a Reserva -->
          <div class="excel-header">
            <span>Reserva/CMR</span>
            <span>Local Carga</span>
            <span>Local Descarga</span>
            <span>DescriÃ§Ã£o</span>
            <span>Ref. Cliente</span>
            <span>LDM</span>
            <span>NÂº Bultos</span>
            <span>Peso (kg)</span>
            <span>â‚¬/TON</span>
            <span>Valor</span>
            <span>IVA</span>
            <span></span>
          </div>
          
          <div id="linhasFatura">
            <!-- Linhas adicionadas por JS -->
          </div>
        </div>
        
        <!-- ObservaÃ§Ãµes -->
        <div class="form-group mb-4">
          <label>FT9 - ObservaÃ§Ãµes</label>
          <textarea id="faturaObs" rows="2" placeholder="ObservaÃ§Ãµes a incluir na fatura..."></textarea>
        </div>
        
        <!-- Totais -->
        <div class="totais-box">
          <div class="totais-linha">
            <span>Subtotal (Base TributÃ¡vel)</span>
            <span id="faturaSubtotal">â‚¬0,00</span>
          </div>
          <div class="totais-linha" id="linhaIVA23" style="display:none;">
            <span>IVA 23%</span>
            <span id="faturaIVA23">â‚¬0,00</span>
          </div>
          <div class="totais-linha" id="linhaIVA6" style="display:none;">
            <span>IVA 6%</span>
            <span id="faturaIVA6">â‚¬0,00</span>
          </div>
          <div class="totais-linha" id="linhaIVA0" style="display:none;">
            <span>Isento de IVA</span>
            <span id="faturaIVA0">â‚¬0,00</span>
          </div>
          <div class="totais-linha">
            <span>TOTAL</span>
            <span id="faturaTotal">â‚¬0,00</span>
          </div>
        </div>
        
      </div>
      <div class="modal-footer">
        <button onclick="fecharModal('modalFatura')" class="btn btn-secondary">Cancelar</button>
        <button onclick="previewFatura()" class="btn btn-info">ğŸ‘ï¸ PrÃ©-visualizar</button>
        <button onclick="emitirFatura()" class="btn btn-success">âœ… Emitir Fatura</button>
      </div>
    </div>
  </div>

  <!-- MODAL: PREVIEW FATURA -->
  <div id="modalPreviewFatura" class="modal-overlay">
    <div class="modal-content" style="max-width: 230mm; width: 95%;">
      <div class="modal-header">
        <h3>ğŸ‘ï¸ PrÃ©-visualizaÃ§Ã£o da Fatura</h3>
        <button onclick="fecharModal('modalPreviewFatura')" class="text-white hover:text-emerald-200 text-2xl">&times;</button>
      </div>
      <div class="modal-body" id="previewFaturaContent" style="background: #e2e8f0; padding: 20px;">
        <!-- ConteÃºdo gerado por JS -->
      </div>
      <div class="modal-footer">
        <button onclick="fecharModal('modalPreviewFatura')" class="btn btn-secondary">Fechar</button>
        <button onclick="imprimirPreview()" class="btn btn-info">ğŸ–¨ï¸ Imprimir</button>
      </div>
    </div>
  </div>

  <!-- MODAL: ENVIAR EMAIL -->
  <div id="modalEnviarEmail" class="modal-overlay">
    <div class="modal-content" style="max-width: 600px;">
      <div class="modal-header">
        <h3>ğŸ“§ Enviar Fatura por Email</h3>
        <button onclick="fecharModal('modalEnviarEmail')" class="text-white hover:text-emerald-200 text-2xl">&times;</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="emailFaturaId">
        
        <div class="form-group">
          <label>Emails da Contabilidade do Cliente</label>
          <div id="emailsContabilidade" class="p-3 bg-slate-50 rounded-lg text-sm">
            <!-- Preenchido por JS -->
          </div>
        </div>
        
        <div class="form-group">
          <label>Outros emails da ficha do cliente</label>
          <div id="emailsOutros" class="p-3 bg-slate-50 rounded-lg text-sm">
            <!-- Preenchido por JS -->
          </div>
        </div>
        
        <div class="form-group">
          <label>Adicionar email manual</label>
          <input type="email" id="emailManual" placeholder="email@exemplo.com">
        </div>
        
        <div class="form-group">
          <label>Anexos</label>
          <div class="p-3 bg-slate-50 rounded-lg">
            <label class="checkbox-container mb-2">
              <input type="checkbox" checked disabled>
              <span>Fatura (PDF)</span>
            </label>
            <label class="checkbox-container mb-2">
              <input type="checkbox" id="anexarCMR" checked>
              <span>CMR(s) da(s) reserva(s)</span>
            </label>
            <div id="anexosAdicionais" class="mt-2"></div>
            <div class="mt-3">
              <button type="button" onclick="adicionarAnexo()" class="btn btn-secondary btn-sm">ğŸ“ Adicionar outro anexo</button>
            </div>
          </div>
        </div>
        
      </div>
      <div class="modal-footer">
        <button onclick="fecharModal('modalEnviarEmail')" class="btn btn-secondary">Cancelar</button>
        <button onclick="enviarEmailFatura()" class="btn btn-success">ğŸ“¤ Enviar Email</button>
      </div>
    </div>
  </div>

  <!-- ğŸ”’ BLOQUEADO v4.3 - MODAL: ENVIAR EMAIL RECIBO -->
  <div id="modalEnviarEmailRecibo" class="modal-overlay">
    <div class="modal-content" style="max-width: 600px;">
      <div class="modal-header" style="background: #059669;">
        <h3>ğŸ“§ Enviar Recibo por Email</h3>
        <button onclick="fecharModal('modalEnviarEmailRecibo')" class="text-white hover:text-emerald-200 text-2xl">&times;</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="emailReciboId">
        
        <div class="p-3 mb-4 bg-emerald-50 rounded-lg border border-emerald-200">
          <p class="text-emerald-800 text-sm" id="infoReciboEmail">
            <!-- Info do recibo preenchida por JS -->
          </p>
        </div>
        
        <div class="form-group">
          <label>ğŸ“Š Emails da Contabilidade do Cliente</label>
          <div id="emailsContabilidadeRecibo" class="p-3 bg-slate-50 rounded-lg text-sm">
            <!-- Preenchido por JS -->
          </div>
        </div>
        
        <div class="form-group">
          <label>ğŸ’° Emails Financeiros do Cliente</label>
          <div id="emailsFinanceiroRecibo" class="p-3 bg-slate-50 rounded-lg text-sm">
            <!-- Preenchido por JS -->
          </div>
        </div>
        
        <div class="form-group">
          <label>Adicionar email manual</label>
          <input type="email" id="emailManualRecibo" placeholder="email@exemplo.com">
        </div>
        
        <div class="form-group">
          <label>Anexos</label>
          <div class="p-3 bg-slate-50 rounded-lg">
            <label class="checkbox-container mb-2">
              <input type="checkbox" checked disabled>
              <span>Recibo (PDF)</span>
            </label>
            <div id="anexosAdicionaisRecibo" class="mt-2"></div>
            <div class="mt-3">
              <button type="button" onclick="adicionarAnexoRecibo()" class="btn btn-secondary btn-sm">ğŸ“ Adicionar outro anexo</button>
            </div>
          </div>
        </div>
        
      </div>
      <div class="modal-footer">
        <button onclick="fecharModal('modalEnviarEmailRecibo')" class="btn btn-secondary">Cancelar</button>
        <button onclick="enviarEmailRecibo()" class="btn btn-success">ğŸ“¤ Enviar Email</button>
      </div>
    </div>
  </div>

  <!-- MODAL: NOTA DE CRÃ‰DITO -->
  <div id="modalNotaCredito" class="modal-overlay">
    <div class="modal-content" style="max-width: 1000px; max-height: 90vh; overflow-y: auto;">
      <div class="modal-header" style="background: #dc2626;">
        <h3>ğŸ“‘ Emitir Nota de CrÃ©dito</h3>
        <button onclick="fecharModal('modalNotaCredito')" class="text-white hover:text-red-200 text-2xl">&times;</button>
      </div>
      <div class="modal-body">
        
        <!-- Linha 1: NÃºmero, Data -->
        <div class="grid grid-cols-2 gap-4 mb-4">
          <div class="form-group">
            <label>NÃºmero</label>
            <input type="text" id="ncNumero" disabled class="bg-slate-100 font-mono">
          </div>
          <div class="form-group">
            <label>Data</label>
            <input type="date" id="ncData">
          </div>
        </div>
        
        <!-- Motor de Busca Cliente -->
        <div class="bg-emerald-50 p-4 rounded-lg mb-4 border border-emerald-200">
          <h4 class="font-semibold text-emerald-800 mb-3">ğŸ‘¤ Cliente</h4>
          <div class="grid grid-cols-2 gap-4 mb-3">
            <div class="form-group">
              <label>Pesquisar Cliente (nome ou NIF)</label>
              <div class="flex gap-2">
                <input type="text" id="ncPesquisaCliente" placeholder="Escreva para pesquisar..." class="flex-1" oninput="pesquisarClienteNC()">
                <button type="button" onclick="limparClienteNC()" class="btn btn-secondary btn-sm">âœ–</button>
              </div>
              <div id="ncResultadosCliente" class="absolute z-50 bg-white border rounded shadow-lg mt-1 max-h-40 overflow-y-auto hidden" style="width: calc(100% - 60px);"></div>
            </div>
            <div class="form-group">
              <label>Cliente Selecionado</label>
              <input type="text" id="ncCliente" disabled class="bg-white font-semibold">
              <input type="hidden" id="ncClienteId">
            </div>
          </div>
          <div class="grid grid-cols-2 gap-4">
            <div class="form-group">
              <label>NIF</label>
              <input type="text" id="ncNIF" disabled class="bg-slate-100">
            </div>
            <div class="form-group">
              <label>Morada</label>
              <input type="text" id="ncMorada" disabled class="bg-slate-100">
            </div>
          </div>
        </div>
        
        <!-- Motor de Busca Fatura + Lista -->
        <div class="bg-blue-50 p-4 rounded-lg mb-4 border border-blue-200">
          <h4 class="font-semibold text-blue-800 mb-3">ğŸ“„ Faturas</h4>
          <div class="grid grid-cols-3 gap-4 mb-3">
            <div class="form-group">
              <label>Pesquisar Fatura (nÂº fatura)</label>
              <div class="flex gap-2">
                <input type="text" id="ncPesquisaFatura" placeholder="Ex: FT 2025/1" class="flex-1" oninput="pesquisarFaturaNC()">
                <button type="button" onclick="adicionarFaturaPesquisadaNC()" class="btn btn-primary btn-sm">â•</button>
              </div>
              <div id="ncResultadosFatura" class="absolute z-50 bg-white border rounded shadow-lg mt-1 max-h-40 overflow-y-auto hidden" style="width: calc(100% - 60px);"></div>
            </div>
            <div class="form-group col-span-2">
              <label>Filtrar por estado</label>
              <div class="flex gap-2">
                <button type="button" onclick="filtrarFaturasNCPorEstado('pendente')" class="text-xs px-2 py-1 rounded bg-yellow-300 font-semibold" id="btnFiltroNCPendente">ğŸ”¸ Em Aberto</button>
                <button type="button" onclick="filtrarFaturasNCPorEstado('todos')" class="text-xs px-2 py-1 rounded bg-slate-200 hover:bg-slate-300" id="btnFiltroNCTodos">Todas</button>
                <button type="button" onclick="filtrarFaturasNCPorEstado('pago')" class="text-xs px-2 py-1 rounded bg-slate-200 hover:bg-slate-300" id="btnFiltroNCPago">Pagas</button>
                <span class="border-l mx-1"></span>
                <button type="button" onclick="seleccionarTodasFaturasNC()" class="text-xs px-2 py-1 rounded bg-blue-100 hover:bg-blue-200">â˜‘ï¸ Todas</button>
                <button type="button" onclick="desseleccionarTodasFaturasNC()" class="text-xs px-2 py-1 rounded bg-slate-100 hover:bg-slate-200">â˜ Nenhuma</button>
              </div>
            </div>
          </div>
          <div id="ncListaFaturas" class="max-h-48 overflow-y-auto bg-white rounded border">
            <p class="text-slate-500 text-sm p-3 text-center">Pesquise um cliente ou fatura para comeÃ§ar</p>
          </div>
          <div class="mt-2 flex justify-between text-sm">
            <span id="ncFaturasSelecionadas" class="text-blue-700 font-semibold">0 faturas selecionadas</span>
            <span id="ncTotalFaturas" class="font-bold text-blue-800">Total: â‚¬0,00</span>
          </div>
          
          <!-- Campo manual quando cliente nÃ£o tem faturas em aberto -->
          <div id="ncCamposManualDiv" class="hidden mt-4 p-3 bg-amber-50 border border-amber-300 rounded-lg">
            <p class="text-amber-800 text-sm font-semibold mb-2">âš ï¸ Cliente sem faturas em aberto - preencha manualmente:</p>
            <div class="grid grid-cols-2 gap-4">
              <div class="form-group">
                <label>NÂº Fatura(s) de ReferÃªncia <span class="text-red-600">*</span></label>
                <input type="text" id="ncFaturaManual" placeholder="Ex: FT 2025/1, FT 2025/2" oninput="verificarCamposManuaisNC()">
              </div>
              <div class="form-group">
                <label>NÂº Reserva(s) <span class="text-red-600">*</span></label>
                <input type="text" id="ncReservaManual" placeholder="Ex: RES-2025-001" oninput="verificarCamposManuaisNC()">
              </div>
            </div>
          </div>
        </div>
        
        <!-- Reservas -->
        <div class="bg-purple-50 p-4 rounded-lg mb-4 border border-purple-200">
          <div class="flex justify-between items-center mb-3">
            <h4 class="font-semibold text-purple-800">ğŸ“¦ Reservas <span id="ncReservasObrigatorio" class="text-red-600 text-sm">*</span></h4>
            <span class="text-xs text-purple-600" id="ncReservasAviso">ObrigatÃ³rio selecionar reservas</span>
          </div>
          <div class="form-group mb-3">
            <label>Filtrar reservas das faturas</label>
            <div class="flex gap-2">
              <input type="text" id="ncPesquisaReserva" placeholder="Pesquisar por nÂº reserva ou CMR..." class="flex-1" oninput="pesquisarReservaNC()">
            </div>
            <div id="ncResultadosReserva" class="absolute z-50 bg-white border rounded shadow-lg mt-1 max-h-40 overflow-y-auto hidden" style="width: calc(100% - 20px);"></div>
          </div>
          <div id="ncListaReservas" class="max-h-40 overflow-y-auto bg-white rounded border">
            <p class="text-slate-500 text-sm p-3 text-center">Selecione faturas para ver as reservas disponÃ­veis</p>
          </div>
          <div class="mt-2 text-sm">
            <span id="ncReservasSelecionadas" class="text-purple-700 font-semibold">0 reservas</span>
          </div>
        </div>
        
        <!-- Motivo e ObservaÃ§Ãµes -->
        <div class="bg-slate-50 p-4 rounded-lg mb-4">
          <h4 class="font-semibold mb-3">ğŸ“ Motivo da Nota de CrÃ©dito</h4>
          <div class="grid grid-cols-2 gap-4 mb-3">
            <div class="form-group">
              <label>Motivo *</label>
              <select id="ncMotivo" onchange="verificarMotivoNC()">
                <option value="">-- Selecione o motivo --</option>
                <option value="DevoluÃ§Ã£o de mercadoria">DevoluÃ§Ã£o de mercadoria</option>
                <option value="Erro de faturaÃ§Ã£o">Erro de faturaÃ§Ã£o</option>
                <option value="Desconto comercial">Desconto comercial</option>
                <option value="Desconto pronto pagamento">Desconto pronto pagamento</option>
                <option value="Desconto volume">Desconto volume</option>
                <option value="AnulaÃ§Ã£o parcial">AnulaÃ§Ã£o parcial</option>
                <option value="AnulaÃ§Ã£o total">AnulaÃ§Ã£o total</option>
                <option value="DiferenÃ§a de preÃ§o">DiferenÃ§a de preÃ§o</option>
                <option value="Quebra de mercadoria">Quebra de mercadoria</option>
                <option value="ServiÃ§o nÃ£o prestado">ServiÃ§o nÃ£o prestado</option>
                <option value="__outro__">âœï¸ Outro (escrever manualmente)</option>
              </select>
            </div>
            <div class="form-group" id="ncMotivoManualDiv" style="display: none;">
              <label>Motivo Manual *</label>
              <div class="flex gap-2">
                <input type="text" id="ncMotivoManual" placeholder="Escreva o motivo..." class="flex-1">
                <button type="button" onclick="adicionarMotivoNC()" class="btn btn-secondary btn-sm" title="Adicionar Ã  lista">â•</button>
              </div>
            </div>
          </div>
          <!-- Aviso de IVA -->
          <div id="ncAvisoIVA" class="p-2 bg-yellow-100 border border-yellow-300 rounded text-sm text-yellow-800 mb-3 hidden">
            âš ï¸ <strong>Desconto comercial/pronto pagamento:</strong> Nota de crÃ©dito emitida sem IVA (0%)
          </div>
          <div class="form-group">
            <label>DescriÃ§Ã£o / ObservaÃ§Ãµes</label>
            <textarea id="ncObservacoes" rows="2" placeholder="Descreva detalhadamente o motivo da nota de crÃ©dito..."></textarea>
          </div>
        </div>
        
        <!-- CÃ¡lculo de Valores -->
        <div class="bg-red-50 p-4 rounded-lg mb-4 border border-red-200">
          <h4 class="font-semibold mb-3 text-red-800">ğŸ’¶ CÃ¡lculo do Valor a Creditar</h4>
          
          <!-- Tipo de CÃ¡lculo -->
          <div class="flex gap-4 mb-4">
            <label class="flex items-center gap-2 cursor-pointer">
              <input type="radio" name="ncTipoCalculo" value="fixo" checked onchange="mudarTipoCalculoNC()">
              <span class="text-sm">Valor Fixo (â‚¬)</span>
            </label>
            <label class="flex items-center gap-2 cursor-pointer">
              <input type="radio" name="ncTipoCalculo" value="total" onchange="mudarTipoCalculoNC()">
              <span class="text-sm">Total das Faturas</span>
            </label>
            <label class="flex items-center gap-2 cursor-pointer">
              <input type="radio" name="ncTipoCalculo" value="percentagem" onchange="mudarTipoCalculoNC()">
              <span class="text-sm">Percentagem (%)</span>
            </label>
          </div>
          
          <div class="grid grid-cols-5 gap-4">
            <div class="form-group">
              <label>Total Faturas</label>
              <input type="text" id="ncValorOriginal" disabled class="bg-white text-right font-mono font-semibold">
            </div>
            <div class="form-group" id="ncPercentagemDiv" style="display: none;">
              <label>Percentagem (%)</label>
              <input type="number" id="ncPercentagem" step="0.01" min="0" max="100" class="text-right font-mono" placeholder="0.00" oninput="calcularTotaisNC()">
            </div>
            <div class="form-group" id="ncValorDiv">
              <label>Valor a Creditar *</label>
              <input type="number" id="ncValor" step="0.01" min="0" class="text-right font-mono" placeholder="0.00" oninput="calcularTotaisNC()">
            </div>
            <div class="form-group">
              <label>Taxa IVA</label>
              <select id="ncIVA" onchange="calcularTotaisNC()">
                <option value="23">23%</option>
                <option value="13">13%</option>
                <option value="6">6%</option>
                <option value="0">0% (Isento)</option>
              </select>
            </div>
            <div class="form-group">
              <label>Total NC</label>
              <input type="text" id="ncTotal" disabled class="bg-white text-right font-mono font-bold text-red-600 text-lg">
            </div>
          </div>
          
          <!-- Resumo -->
          <div class="mt-3 p-2 bg-white rounded text-sm" id="ncResumoCalculo">
            <span class="text-slate-500">Selecione faturas e preencha o valor</span>
          </div>
        </div>
        
      </div>
      <div class="modal-footer">
        <button onclick="fecharModal('modalNotaCredito')" class="btn btn-secondary">Cancelar</button>
        <button onclick="previewNC()" class="btn btn-success">ğŸ‘ï¸ Preview</button>
        <button onclick="emitirNC()" class="btn btn-danger">ğŸ“‘ Emitir Nota de CrÃ©dito</button>
      </div>
    </div>
  </div>

  <!-- ğŸ”’ BLOQUEADO v4.3 - MODAL: RECIBO -->
  <div id="modalRecibo" class="modal-overlay">
    <div class="modal-content" style="max-width: 700px;">
      <div class="modal-header">
        <h3>ğŸ§¾ Emitir Recibo</h3>
        <button onclick="fecharModal('modalRecibo')" class="text-white hover:text-emerald-200 text-2xl">&times;</button>
      </div>
      <div class="modal-body">
        <div class="grid grid-cols-2 gap-4 mb-4">
          <div class="form-group">
            <label>NÃºmero</label>
            <input type="text" id="reciboNumero" disabled class="bg-slate-100 font-mono">
          </div>
          <div class="form-group">
            <label>Data</label>
            <input type="date" id="reciboData" required>
          </div>
        </div>
        
        <div class="form-group">
          <label>Cliente *</label>
          <select id="reciboCliente" onchange="carregarFaturasCliente()" required>
            <option value="">-- Selecione --</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>Faturas Pendentes (selecione as que estÃ¡ a receber)</label>
          <div id="faturasPendentesRecibo" class="border-2 border-slate-200 rounded-lg p-4 max-h-48 overflow-y-auto">
            <p class="text-slate-500 text-sm">Selecione um cliente</p>
          </div>
        </div>
        
        <div class="grid grid-cols-2 gap-4">
          <div class="form-group">
            <label>MÃ©todo de Pagamento *</label>
            <select id="reciboMetodo" required>
              <option value="">-- Selecione --</option>
              <option value="TransferÃªncia">TransferÃªncia BancÃ¡ria</option>
              <option value="Multibanco">Multibanco</option>
              <option value="Cheque">Cheque</option>
              <option value="NumerÃ¡rio">NumerÃ¡rio</option>
            </select>
          </div>
          <div class="form-group">
            <label>Conta Destino *</label>
            <select id="reciboContaDestino" required>
              <option value="">-- Selecione --</option>
              <option value="Santander">Santander</option>
              <option value="CGD">CGD</option>
              <option value="BPI">BPI</option>
              <option value="Millennium">Millennium</option>
              <option value="Caixa">Caixa (NumerÃ¡rio)</option>
            </select>
          </div>
        </div>
        
        <div class="grid grid-cols-2 gap-4">
          <div class="form-group">
            <label>Valor Total a Receber</label>
            <input type="text" id="reciboValorTotal" disabled class="bg-slate-100 font-bold text-lg">
          </div>
          <div class="form-group">
            <label>Valor Recebido *</label>
            <input type="number" id="reciboValor" step="0.01" required onchange="calcularTrocoRecibo()">
          </div>
        </div>
        
        <div class="form-group">
          <label>ReferÃªncia Pagamento</label>
          <input type="text" id="reciboReferencia" placeholder="NÂº cheque, ref. transferÃªncia...">
        </div>
        
      </div>
      <div class="modal-footer">
        <button onclick="fecharModal('modalRecibo')" class="btn btn-secondary">Cancelar</button>
        <button onclick="previewRecibo()" class="btn btn-success" style="background: #059669;">ğŸ‘ï¸ Preview</button>
        <button onclick="emitirRecibo()" class="btn btn-success">âœ… Emitir Recibo</button>
      </div>
    </div>
  </div>

  <script>
    // ==================== MENU ACORDEÃƒO ====================
    
    function toggleMenu(menuId) {
      var menuItems = document.getElementById(menuId);
      if (!menuItems) {
        console.error('Menu nÃ£o encontrado:', menuId);
        return;
      }
      
      var menuTitle = menuItems.previousElementSibling;
      
      // Toggle da classe E do estilo inline
      if (menuItems.classList.contains('menu-collapsed')) {
        menuItems.classList.remove('menu-collapsed');
        menuItems.style.display = 'block';
        if (menuTitle) menuTitle.classList.add('active');
      } else {
        menuItems.classList.add('menu-collapsed');
        menuItems.style.display = 'none';
        if (menuTitle) menuTitle.classList.remove('active');
      }
    }
    
    // Abrir automaticamente o menu da pÃ¡gina ativa
    function abrirMenuDaPaginaAtiva(pagina) {
      const menuMap = {
        'dashboard': 'menu-administracao',
        'configuracoes': 'menu-administracao',
        'utilizadores': 'menu-administracao',
        'permissoes': 'menu-administracao',
        'comerciais': 'menu-administracao',
        'equipas': 'menu-administracao',
        'rotas': 'menu-administracao',
        'armazens': 'menu-administracao',
        'agendaarquivo': 'menu-administracao',
        'logs': 'menu-administracao',
        'backup': 'menu-administracao',
        'cotacoes': 'menu-logistica',
        'reservas': 'menu-logistica',
        'agenda1': 'menu-logistica',
        'agenda2': 'menu-logistica',
        'agenda3': 'menu-logistica',
        'dashboardfinanceiro': 'menu-financeiro',
        'clientes': 'menu-financeiro',
        'faturas': 'menu-financeiro',
        'prefaturacao': 'menu-financeiro',
        'controlofaturacao': 'menu-financeiro',
        'notascredito': 'menu-financeiro',
        'recibos': 'menu-financeiro',
        'contascorrentes': 'menu-financeiro',
        'fichasfornecedores': 'menu-fornecedores',
        'compras': 'menu-fornecedores',
        'faturasfornecedores': 'menu-fornecedores',
        'ncfornecedores': 'menu-fornecedores',
        'pagamentos': 'menu-fornecedores',
        'ccfornecedores': 'menu-fornecedores',
        'gestaofrota': 'menu-custos',
        'veiculos': 'menu-custos',
        'motoristas': 'menu-custos',
        'combustivel': 'menu-custos',
        'manutencao': 'menu-custos',
        'portagens': 'menu-custos',
        'dashboardcontabilidade': 'menu-contabilidade',
        'series': 'menu-contabilidade',
        'saft': 'menu-contabilidade',
        'relatorios': 'menu-contabilidade',
        'funcionarios': 'menu-rh',
        'contratos': 'menu-rh',
        'salarios': 'menu-rh',
        'ferias': 'menu-rh',
        'documentosrh': 'menu-rh'
      };
      
      const menuId = menuMap[pagina];
      if (menuId) {
        const menuItems = document.getElementById(menuId);
        const menuTitle = menuItems?.previousElementSibling;
        if (menuItems) {
          menuItems.classList.remove('menu-collapsed');
          menuItems.style.display = 'block';
          menuTitle?.classList.add('active');
        }
      }
    }
    
    // ==================== DADOS GLOBAIS ====================
    
    let faturas = [];
    let notasCredito = [];
    let recibos = [];
    let series = [];
    let clientes = [];
    let reservas = []; // Reservas executadas (com CMR carga e descarga)
    let empresaConfig = {};
    
    // Armazenamento para novos tipos de documentos
    let notasDebito = [];
    let pagamentosFornecedor = [];
    let debitosFornecedor = [];
    
    // ==================== SISTEMA DE UTILIZADORES E PERMISSÃ•ES ====================
    
    // Utilizador actual (simulado - em produÃ§Ã£o viria do login)
    let utilizadorActual = {
      id: 1,
      nome: 'Administrador',
      email: 'admin@emeutrans.pt',
      perfil: 'admin', // admin, gestor, operador
      permissoes: {
        emitirFaturas: true,
        emitirNC: true,        // PermissÃ£o para emitir Notas de CrÃ©dito
        emitirRecibos: true,
        anularDocumentos: true,
        verRelatorios: true,
        editarConfiguracoes: true,
        editarReservasFaturadas: true  // PermissÃ£o para editar reservas jÃ¡ faturadas
      }
    };
    
    // Perfis de utilizador disponÃ­veis
    const PERFIS_UTILIZADOR = {
      'admin': {
        nome: 'Administrador',
        permissoes: {
          emitirFaturas: true,
          emitirNC: true,
          emitirRecibos: true,
          anularDocumentos: true,
          verRelatorios: true,
          editarConfiguracoes: true,
          editarReservasFaturadas: true  // âœ… Admin pode editar reservas faturadas
        }
      },
      'gestor': {
        nome: 'Gestor',
        permissoes: {
          emitirFaturas: true,
          emitirNC: true,  // Gestores podem emitir NC
          emitirRecibos: true,
          anularDocumentos: false,
          verRelatorios: true,
          editarConfiguracoes: false,
          editarReservasFaturadas: false  // âŒ Gestores NÃƒO podem editar reservas faturadas
        }
      },
      'operador': {
        nome: 'Operador',
        permissoes: {
          emitirFaturas: true,
          emitirNC: false,  // Operadores NÃƒO podem emitir NC
          emitirRecibos: true,
          anularDocumentos: false,
          verRelatorios: false,
          editarConfiguracoes: false,
          editarReservasFaturadas: false  // âŒ Operadores NÃƒO podem editar reservas faturadas
        }
      }
    };
    
    // FunÃ§Ã£o para verificar permissÃ£o
    function temPermissao(permissao) {
      return utilizadorActual.permissoes && utilizadorActual.permissoes[permissao] === true;
    }
    
    // FunÃ§Ã£o para mudar perfil (para testes)
    function mudarPerfilUtilizador(perfil) {
      if (PERFIS_UTILIZADOR[perfil]) {
        utilizadorActual.perfil = perfil;
        utilizadorActual.permissoes = PERFIS_UTILIZADOR[perfil].permissoes;
        utilizadorActual.nome = PERFIS_UTILIZADOR[perfil].nome;
        actualizarIndicadoresPermissao();
        alert(`âœ… Perfil alterado para: ${PERFIS_UTILIZADOR[perfil].nome}\n\nPermissÃ£o para NC: ${temPermissao('emitirNC') ? 'SIM âœ“' : 'NÃƒO âœ—'}`);
      }
    }
    
    // Actualizar indicadores visuais de permissÃ£o
    function actualizarIndicadoresPermissao() {
      const indicador = document.getElementById('permissaoNCIndicador');
      const btnNovaNC = document.getElementById('btnNovaNC');
      const avisoPermissao = document.getElementById('avisoPermissaoNC');
      const selectPerfil = document.getElementById('selectPerfilTeste');
      
      // Actualizar dropdown de perfil
      if (selectPerfil) {
        selectPerfil.value = utilizadorActual.perfil;
      }
      
      if (indicador) {
        if (temPermissao('emitirNC')) {
          indicador.textContent = 'ğŸ”“ ' + utilizadorActual.nome;
          indicador.className = 'text-xs px-2 py-1 rounded bg-green-100 text-green-700';
          if (btnNovaNC) {
            btnNovaNC.disabled = false;
            btnNovaNC.classList.remove('opacity-50', 'cursor-not-allowed');
          }
          if (avisoPermissao) {
            avisoPermissao.classList.add('hidden');
          }
        } else {
          indicador.textContent = 'ğŸ”’ ' + utilizadorActual.nome + ' (sem permissÃ£o)';
          indicador.className = 'text-xs px-2 py-1 rounded bg-red-100 text-red-700';
          if (btnNovaNC) {
            btnNovaNC.disabled = true;
            btnNovaNC.classList.add('opacity-50', 'cursor-not-allowed');
          }
          if (avisoPermissao) {
            avisoPermissao.classList.remove('hidden');
          }
        }
      }
    }
    
    /* â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
       â•‘   CONFIGURAÃ‡ÃƒO DE TIPOS DE DOCUMENTOS - LAYOUT UNIFICADO                     â•‘
       â•‘   Todos os documentos usam o mesmo layout, mudando apenas tÃ­tulo e sÃ©rie     â•‘
       â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    const TIPOS_DOCUMENTO = {
      'FT': { 
        nome: 'FATURA', 
        serie: 'FT', 
        corTitulo: '#065f46',
        mostrarLinhasServico: true,
        mostrarIBAN: true,
        mostrarQRCode: true,
        tipoQR: 'FT'
      },
      'NC': { 
        nome: 'NOTA DE CRÃ‰DITO', 
        serie: 'NC', 
        corTitulo: '#dc2626',
        mostrarLinhasServico: false,
        mostrarIBAN: true,
        mostrarQRCode: true,
        tipoQR: 'NC'
      },
      'ND': { 
        nome: 'NOTA DE DÃ‰BITO', 
        serie: 'ND', 
        corTitulo: '#d97706',
        mostrarLinhasServico: true,
        mostrarIBAN: true,
        mostrarQRCode: true,
        tipoQR: 'ND'
      },
      'RC': { 
        nome: 'RECIBO', 
        serie: 'RC', 
        corTitulo: '#059669',
        mostrarLinhasServico: false,
        mostrarIBAN: false,
        mostrarQRCode: true,
        tipoQR: 'RC'
      },
      'PF': { 
        nome: 'PAGAMENTO A FORNECEDOR', 
        serie: 'PF', 
        corTitulo: '#2563eb',
        mostrarLinhasServico: false,
        mostrarIBAN: true,
        mostrarQRCode: false,
        tipoQR: 'PF'
      },
      'DF': { 
        nome: 'DÃ‰BITO A FORNECEDOR', 
        serie: 'DF', 
        corTitulo: '#7c3aed',
        mostrarLinhasServico: true,
        mostrarIBAN: true,
        mostrarQRCode: false,
        tipoQR: 'DF'
      }
    };
    
    // FunÃ§Ã£o para obter prÃ³ximo nÃºmero de documento
    function obterProximoNumero(tipoSerie) {
      const serie = series.find(s => s.serie === tipoSerie);
      if (!serie) return `${tipoSerie} 2025/1`;
      const numero = `${tipoSerie} ${serie.ano}/${serie.proxNum}`;
      return numero;
    }
    
    // FunÃ§Ã£o para incrementar nÃºmero de sÃ©rie
    function incrementarSerie(tipoSerie) {
      const serie = series.find(s => s.serie === tipoSerie);
      if (serie) {
        serie.proxNum++;
        guardarDados();
      }
    }
    
    // ConfiguraÃ§Ãµes IVA (baseado nas tabelas fornecidas)
    const REGRAS_IVA = {
      // Cliente PortuguÃªs (Nacional - 21111)
      '21111': {
        'Normal': {
          'PT-PT': { taxa: 0.23, contaRazao: '72113', contaIVA: '2433113', artigo: 'IVA Liquidado O.B.S. Taxa Normal M.Nac', motivo: '' },
          'PT-EUR': { taxa: 0, contaRazao: '72122', contaIVA: '2433110', artigo: 'Art. 14Âº nÂº1 AlÃ­nea q CIVA', motivo: 'M05' },
          'PT-FORA_UE': { taxa: 0, contaRazao: '72122', contaIVA: '2433110', artigo: 'Art. 14Âº nÂº1 AlÃ­nea q CIVA', motivo: 'M05' },
          'EUR-PT': { taxa: 0.23, contaRazao: '72113', contaIVA: '2433113', artigo: 'IVA Liquidado O.B.S. Taxa Normal M.Nac', motivo: '' },
          'EUR-EUR': { taxa: 0.23, contaRazao: '72113', contaIVA: '2433113', artigo: 'IVA Liquidado O.B.S. Taxa Normal M.Nac', motivo: '' },
          'EUR-FORA_UE': { taxa: 0, contaRazao: '72122', contaIVA: '2433110', artigo: 'Art. 14Âº nÂº1 AlÃ­nea q CIVA', motivo: 'M05' },
          'FORA_UE-PT': { taxa: 0, contaRazao: '72122', contaIVA: '2433110', artigo: 'Art. 14Âº nÂº1 AlÃ­nea q CIVA', motivo: 'M05' },
          'FORA_UE-EUR': { taxa: 0, contaRazao: '72122', contaIVA: '2433110', artigo: 'Art. 14Âº nÂº1 AlÃ­nea q CIVA', motivo: 'M05' },
          'FORA_UE-FORA_UE': { taxa: 0, contaRazao: '72122', contaIVA: '2433110', artigo: 'Art. 14Âº nÂº1 AlÃ­nea q CIVA', motivo: 'M05' }
        },
        'ResÃ­duos': {
          'PT-PT': { taxa: 0.06, contaRazao: '72111', contaIVA: '2433111', artigo: 'IVA Liquidado O.B.S. Tx Red. M.Nac', motivo: '' },
          'PT-EUR': { taxa: 0, contaRazao: '72122', contaIVA: '2433110', artigo: 'Art. 14Âº nÂº1 AlÃ­nea q CIVA', motivo: 'M05' },
          'PT-FORA_UE': { taxa: 0, contaRazao: '72122', contaIVA: '2433110', artigo: 'Art. 14Âº nÂº1 AlÃ­nea q CIVA', motivo: 'M05' },
          'EUR-PT': { taxa: 0.06, contaRazao: '72111', contaIVA: '2433111', artigo: 'IVA Liquidado O.B.S. Tx Red. M.Nac', motivo: '' },
          'EUR-EUR': { taxa: 0.06, contaRazao: '72111', contaIVA: '2433111', artigo: 'IVA Liquidado O.B.S. Tx Red. M.Nac', motivo: '' },
          'EUR-FORA_UE': { taxa: 0, contaRazao: '72122', contaIVA: '2433110', artigo: 'Art. 14Âº nÂº1 AlÃ­nea q CIVA', motivo: 'M05' },
          'FORA_UE-PT': { taxa: 0.06, contaRazao: '72111', contaIVA: '2433111', artigo: 'IVA Liquidado O.B.S. Tx Red. M.Nac', motivo: '' },
          'FORA_UE-EUR': { taxa: 0.06, contaRazao: '72111', contaIVA: '2433111', artigo: 'IVA Liquidado O.B.S. Tx Red. M.Nac', motivo: '' },
          'FORA_UE-FORA_UE': { taxa: 0, contaRazao: '72122', contaIVA: '2433110', artigo: 'Art. 14Âº nÂº1 AlÃ­nea q CIVA', motivo: 'M05' }
        },
        'Penalizacao': { taxa: 0, contaRazao: '78865', contaIVA: '2433110/2433113', artigo: '', motivo: '' }
      },
      // Cliente Europeu (IntraComunitÃ¡rio - 21112)
      '21112': {
        'Normal': { taxa: 0, contaRazao: '72123', contaIVA: '2433110', artigo: 'Transp. I.C. Art 6.Âº CIVA nÂº6 a) - Ã  contrÃ¡rio', motivo: 'M05' },
        'ResÃ­duos': { taxa: 0, contaRazao: '72123', contaIVA: '2433110', artigo: 'Transp. I.C. Art 6.Âº CIVA nÂº6 a) - Ã  contrÃ¡rio', motivo: 'M05' },
        'Penalizacao': { taxa: 0, contaRazao: '78865', contaIVA: '', artigo: '', motivo: '' }
      },
      // Cliente Externo (Fora UE - 21113)
      '21113': {
        'Normal': { taxa: 0, contaRazao: '72131', contaIVA: '2433310', artigo: 'Transp. Isento - O Merc - Art. 14Âº nÂº1 a) p CIVA', motivo: 'M05' },
        'ResÃ­duos': { taxa: 0, contaRazao: '72131', contaIVA: '2433310', artigo: 'Transp. Isento - O Merc - Art. 14Âº nÂº1 a) p CIVA', motivo: 'M05' },
        'Penalizacao': { taxa: 0, contaRazao: '78865', contaIVA: '', artigo: '', motivo: '' }
      }
    };
    
    // Contas para Notas de CrÃ©dito
    const REGRAS_NC = {
      '21111': { 
        '6': { contaRazao: '72811', contaIVA: '2434131', artigo: 'IVA Reg. Favor Empresa O.B.S. Tx Red. M.Nac' },
        '23': { contaRazao: '72813', contaIVA: '2434133', artigo: 'IVA Reg. Favor Empresa O.B.S. Tx Norm M.Nac' },
        '0': { contaRazao: '72810', contaIVA: '2434130', artigo: 'IVA Reg. Fav. Empr. Isnt c/dir.deduÃ§Ã£o' }
      },
      '21112': { '0': { contaRazao: '72820', contaIVA: '2434170', artigo: 'IVA Reg. Favor Empresa Transm. IC Isnt ServiÃ§os' } },
      '21113': { '0': { contaRazao: '72830', contaIVA: '2434180', artigo: 'IVA Reg. Favor Empresa O Merc - Isnt ServiÃ§os' } }
    };
    
    // Lista de paÃ­ses PT e EUR
    // Lista de paÃ­ses e regiÃµes para detecÃ§Ã£o de zona
    const PAISES_PT = ['PT', 'PORTUGAL', 'PORTUGUES', 'PORTUGUESA'];
    const PAISES_EUR = [
      // CÃ³digos de paÃ­ses
      'ES', 'FR', 'DE', 'IT', 'NL', 'BE', 'AT', 'PL', 'CZ', 'SK', 'HU', 'RO', 'BG', 'GR', 'SE', 'DK', 'FI', 'IE', 'LU', 'HR', 'SI', 'EE', 'LV', 'LT', 'CY', 'MT',
      // Nomes de paÃ­ses em portuguÃªs
      'ESPANHA', 'FRANÃ‡A', 'ALEMANHA', 'ITÃLIA', 'ITALIA', 'HOLANDA', 'BÃ‰LGICA', 'BELGICA', 'ÃUSTRIA', 'AUSTRIA', 'POLÃ“NIA', 'POLONIA',
      'REPÃšBLICA CHECA', 'REPUBLICA CHECA', 'ESLOVÃQUIA', 'ESLOVAQUIA', 'HUNGRIA', 'ROMÃ‰NIA', 'ROMENIA', 'BULGÃRIA', 'BULGARIA',
      'GRÃ‰CIA', 'GRECIA', 'SUÃ‰CIA', 'SUECIA', 'DINAMARCA', 'FINLÃ‚NDIA', 'FINLANDIA', 'IRLANDA', 'LUXEMBURGO', 'CROÃCIA', 'CROACIA',
      'ESLOVÃ‰NIA', 'ESLOVENIA', 'ESTÃ“NIA', 'ESTONIA', 'LETÃ“NIA', 'LETONIA', 'LITUÃ‚NIA', 'LITUANIA', 'CHIPRE', 'MALTA',
      // Nomes em outras lÃ­nguas
      'SPAIN', 'FRANCE', 'GERMANY', 'ITALY', 'NETHERLANDS', 'BELGIUM', 'AUSTRIA', 'POLAND',
      'ESPAÃ‘A', 'DEUTSCHLAND', 'NEDERLAND', 'BELGIQUE', 'Ã–STERREICH', 'POLSKA',
      // Cidades/RegiÃµes espanholas comuns
      'MADRID', 'BARCELONA', 'VALENCIA', 'SEVILLA', 'BILBAO', 'VIZCAYA', 'BIZKAIA', 'VITORIA', 'GASTEIZ', 
      'ZARAGOZA', 'MÃLAGA', 'MALAGA', 'MURCIA', 'ALICANTE', 'CÃ“RDOBA', 'CORDOBA', 'VALLADOLID', 'VIGO',
      'GIJÃ“N', 'GIJON', 'HOSPITALET', 'CORUÃ‘A', 'CORUNA', 'GRANADA', 'ELCHE', 'OVIEDO', 'BADALONA',
      'CARTAGENA', 'TERRASSA', 'JEREZ', 'SABADELL', 'MÃ“STOLES', 'MOSTOLES', 'ALCALÃ', 'ALCALA', 'PAMPLONA',
      'FUENLABRADA', 'LEGANÃ‰S', 'LEGANES', 'ALMERÃA', 'ALMERIA', 'SAN SEBASTIÃN', 'SAN SEBASTIAN', 'DONOSTIA',
      'BURGOS', 'SANTANDER', 'CASTELLÃ“N', 'CASTELLON', 'ALBACETE', 'GETAFE', 'SALAMANCA', 'LOGROÃ‘O', 'LOGRONO',
      'HUELVA', 'BADAJOZ', 'TARRAGONA', 'LLEIDA', 'LERIDA', 'MARBELLA', 'LEÃ“N', 'LEON', 'CÃDIZ', 'CADIZ',
      'PAÃS VASCO', 'PAIS VASCO', 'CATALUÃ‘A', 'CATALUNA', 'ANDALUCÃA', 'ANDALUCIA', 'GALICIA', 'CASTILLA',
      'ARAGÃ“N', 'ARAGON', 'NAVARRA', 'ASTURIAS', 'CANTABRIA', 'EXTREMADURA', 'MURCIA', 'RIOJA', 'BALEARES', 'CANARIAS',
      // Cidades francesas comuns
      'PARIS', 'LYON', 'MARSEILLE', 'TOULOUSE', 'NICE', 'NANTES', 'STRASBOURG', 'MONTPELLIER', 'BORDEAUX', 'LILLE',
      // Cidades alemÃ£s comuns
      'BERLIN', 'HAMBURG', 'MUNICH', 'MÃœNCHEN', 'MUNCHEN', 'COLOGNE', 'KÃ–LN', 'KOLN', 'FRANKFURT', 'STUTTGART', 'DÃœSSELDORF', 'DUSSELDORF',
      // Cidades italianas comuns
      'ROMA', 'ROME', 'MILANO', 'MILAN', 'NAPOLI', 'NAPLES', 'TORINO', 'TURIN', 'FIRENZE', 'FLORENCE', 'VENEZIA', 'VENICE', 'BOLOGNA', 'GENOVA', 'GENOA'
    ];
    
    // ==================== FUNÃ‡Ã•ES DE CÃLCULO IVA ====================
    
    function determinarZona(local) {
      if (!local) return 'PT';
      const localUpper = local.toUpperCase().trim();
      
      // Primeiro verificar se Ã© Portugal
      if (PAISES_PT.some(p => localUpper.includes(p))) return 'PT';
      
      // Depois verificar se Ã© Europa
      if (PAISES_EUR.some(p => localUpper.includes(p))) return 'EUR';
      
      // Por defeito, se nÃ£o for Portugal nem Europa conhecida, Ã© FORA_UE
      return 'FORA_UE';
    }
    
    function obterRegraIVA(tipoCliente, tipoMercadoria, localCarga, localDescarga) {
      const zonaCarga = determinarZona(localCarga);
      const zonaDescarga = determinarZona(localDescarga);
      const chaveZona = `${zonaCarga}-${zonaDescarga}`;
      
      // Se tipoCliente nÃ£o definido, usar '21111' (Cliente PortuguÃªs) por defeito
      const tipoClienteReal = tipoCliente || '21111';
      
      const regrasCliente = REGRAS_IVA[tipoClienteReal];
      if (!regrasCliente) return REGRAS_IVA['21111']['Normal']['PT-PT']; // Default
      
      const regrasMercadoria = regrasCliente[tipoMercadoria] || regrasCliente['Normal'];
      
      // Para clientes EUR e Fora UE, a regra Ã© Ãºnica independente das zonas
      if (tipoClienteReal !== '21111') {
        return regrasMercadoria;
      }
      
      // Para cliente portuguÃªs, usar a regra baseada nas zonas
      const regra = regrasMercadoria[chaveZona];
      if (!regra) {
        console.warn(`âš ï¸ Regra IVA nÃ£o encontrada para ${chaveZona}, usando PT-PT`);
        return regrasMercadoria['PT-PT'];
      }
      
      console.log(`ğŸ“Š IVA: ${localCarga} (${zonaCarga}) â†’ ${localDescarga} (${zonaDescarga}) = ${regra.taxa * 100}%`);
      return regra;
    }
    
    // â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    // â•‘                                                                                          â•‘
    // â•‘   ğŸ“‹ SISTEMA DE LOGS E DIAGNÃ“STICO                                                       â•‘
    // â•‘                                                                                          â•‘
    // â•‘   Sistema para capturar erros e gerar relatÃ³rios de diagnÃ³stico.                         â•‘
    // â•‘   Permite identificar e reportar problemas quando o sistema estÃ¡ em produÃ§Ã£o.            â•‘
    // â•‘                                                                                          â•‘
    // â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    // Array para guardar logs em memÃ³ria
    let sistemalogs = [];
    const MAX_LOGS = 100; // MÃ¡ximo de logs a guardar
    
    // FunÃ§Ã£o para registar log
    function registarLog(tipo, mensagem, detalhes = null) {
      const log = {
        id: Date.now(),
        timestamp: new Date().toISOString(),
        dataHora: new Date().toLocaleString('pt-PT'),
        tipo: tipo, // 'INFO', 'AVISO', 'ERRO', 'DEBUG'
        mensagem: mensagem,
        detalhes: detalhes,
        pagina: document.querySelector('[id^="page-"]:not(.hidden)')?.id?.replace('page-', '') || 'desconhecida',
        utilizador: utilizadorActual?.nome || 'NÃ£o identificado'
      };
      
      sistemalogs.unshift(log); // Adicionar no inÃ­cio
      
      // Limitar tamanho
      if (sistemalogs.length > MAX_LOGS) {
        sistemalogs = sistemalogs.slice(0, MAX_LOGS);
      }
      
      // Guardar no localStorage
      try {
        localStorage.setItem('erpSistemaLogs', JSON.stringify(sistemalogs));
      } catch (e) {
        console.warn('NÃ£o foi possÃ­vel guardar logs no localStorage');
      }
      
      // Log na consola tambÃ©m
      const estilos = {
        'INFO': 'color: #3b82f6',
        'AVISO': 'color: #f59e0b',
        'ERRO': 'color: #ef4444; font-weight: bold',
        'DEBUG': 'color: #8b5cf6'
      };
      console.log(`%c[${tipo}] ${mensagem}`, estilos[tipo] || '', detalhes || '');
      
      // Actualizar painel de logs se estiver visÃ­vel
      if (document.getElementById('painelLogs')) {
        renderizarPainelLogs();
      }
    }
    
    // Capturar erros globais automaticamente
    window.onerror = function(mensagem, fonte, linha, coluna, erro) {
      registarLog('ERRO', `${mensagem}`, {
        fonte: fonte,
        linha: linha,
        coluna: coluna,
        stack: erro?.stack || 'NÃ£o disponÃ­vel'
      });
      return false; // Continuar a mostrar no console normal
    };
    
    // Capturar erros de promises nÃ£o tratadas
    window.onunhandledrejection = function(evento) {
      registarLog('ERRO', `Promise rejeitada: ${evento.reason}`, {
        reason: evento.reason?.toString(),
        stack: evento.reason?.stack || 'NÃ£o disponÃ­vel'
      });
    };
    
    // Carregar logs guardados
    function carregarLogs() {
      try {
        sistemalogs = JSON.parse(localStorage.getItem('erpSistemaLogs') || '[]');
      } catch (e) {
        sistemalogs = [];
      }
    }
    
    // Limpar logs
    function limparLogs() {
      if (confirm('âš ï¸ Tem a certeza que quer limpar todos os logs?\n\nEsta acÃ§Ã£o nÃ£o pode ser revertida.')) {
        sistemalogs = [];
        localStorage.removeItem('erpSistemaLogs');
        renderizarPainelLogs();
        registarLog('INFO', 'Logs limpos pelo utilizador');
        alert('âœ… Logs limpos com sucesso!');
      }
    }
    
    // Renderizar painel de logs
    function renderizarPainelLogs() {
      const painel = document.getElementById('painelLogs');
      if (!painel) return;
      
      const logsErros = sistemalogs.filter(l => l.tipo === 'ERRO');
      const logsAvisos = sistemalogs.filter(l => l.tipo === 'AVISO');
      
      if (sistemalogs.length === 0) {
        painel.innerHTML = `
          <div class="text-center text-slate-500 py-8">
            <span class="text-4xl mb-2 block">âœ…</span>
            <p>Nenhum log registado</p>
            <p class="text-sm">O sistema estÃ¡ a funcionar normalmente</p>
          </div>
        `;
        return;
      }
      
      painel.innerHTML = `
        <div class="mb-4 flex gap-4 items-center">
          <span class="text-sm">
            <span class="inline-block w-3 h-3 bg-red-500 rounded-full mr-1"></span>
            ${logsErros.length} erros
          </span>
          <span class="text-sm">
            <span class="inline-block w-3 h-3 bg-amber-500 rounded-full mr-1"></span>
            ${logsAvisos.length} avisos
          </span>
          <span class="text-sm">
            <span class="inline-block w-3 h-3 bg-blue-500 rounded-full mr-1"></span>
            ${sistemalogs.length} total
          </span>
        </div>
        <div class="max-h-96 overflow-y-auto border rounded-lg">
          <table class="w-full text-sm">
            <thead class="bg-slate-100 sticky top-0">
              <tr>
                <th class="p-2 text-left w-32">Data/Hora</th>
                <th class="p-2 text-left w-20">Tipo</th>
                <th class="p-2 text-left">Mensagem</th>
                <th class="p-2 text-left w-24">PÃ¡gina</th>
              </tr>
            </thead>
            <tbody>
              ${sistemalogs.slice(0, 50).map(log => `
                <tr class="border-b hover:bg-slate-50 ${log.tipo === 'ERRO' ? 'bg-red-50' : log.tipo === 'AVISO' ? 'bg-amber-50' : ''}">
                  <td class="p-2 text-xs text-slate-500">${log.dataHora}</td>
                  <td class="p-2">
                    <span class="px-2 py-1 rounded text-xs font-semibold ${
                      log.tipo === 'ERRO' ? 'bg-red-100 text-red-700' :
                      log.tipo === 'AVISO' ? 'bg-amber-100 text-amber-700' :
                      log.tipo === 'INFO' ? 'bg-blue-100 text-blue-700' :
                      'bg-purple-100 text-purple-700'
                    }">${log.tipo}</span>
                  </td>
                  <td class="p-2 ${log.tipo === 'ERRO' ? 'text-red-700' : ''}">${log.mensagem}</td>
                  <td class="p-2 text-xs text-slate-500">${log.pagina}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;
    }
    
    // Gerar relatÃ³rio de diagnÃ³stico completo
    function gerarDiagnostico() {
      registarLog('INFO', 'A gerar relatÃ³rio de diagnÃ³stico...');
      
      const diagnostico = {
        // InformaÃ§Ã£o do sistema
        sistema: {
          versao: '4.1',
          dataGeracao: new Date().toISOString(),
          dataHoraLocal: new Date().toLocaleString('pt-PT'),
          navegador: navigator.userAgent,
          plataforma: navigator.platform,
          idioma: navigator.language,
          online: navigator.onLine,
          localStorage: typeof localStorage !== 'undefined'
        },
        
        // Estado dos dados
        dados: {
          faturas: {
            total: faturas.length,
            pendentes: faturas.filter(f => f.estado === 'Pendente').length,
            pagas: faturas.filter(f => f.estado === 'Pago').length,
            vencidas: faturas.filter(f => f.estado === 'Vencido').length
          },
          notasCredito: {
            total: notasCredito.length,
            emitidas: notasCredito.filter(nc => nc.estado === 'Emitida').length
          },
          recibos: {
            total: recibos.length
          },
          clientes: {
            total: clientes.length
          },
          reservas: {
            total: reservas.length,
            porFaturar: reservas.filter(r => !r.faturada).length,
            faturadas: reservas.filter(r => r.faturada).length
          },
          series: series.map(s => ({ serie: s.serie, proxNum: s.proxNum }))
        },
        
        // ConfiguraÃ§Ãµes
        configuracoes: {
          empresa: empresaConfig.nome || 'NÃ£o configurada',
          nif: empresaConfig.nif || '-',
          utilizadorActual: utilizadorActual?.nome || 'NÃ£o identificado',
          perfil: utilizadorActual?.perfil || '-'
        },
        
        // Ãšltimos logs (sÃ³ erros e avisos)
        logs: {
          totalLogs: sistemalogs.length,
          erros: sistemalogs.filter(l => l.tipo === 'ERRO').slice(0, 20),
          avisos: sistemalogs.filter(l => l.tipo === 'AVISO').slice(0, 10)
        },
        
        // MemÃ³ria localStorage
        armazenamento: {
          erpFaturas: (localStorage.getItem('erpFaturas') || '').length + ' bytes',
          erpNotasCredito: (localStorage.getItem('erpNotasCredito') || '').length + ' bytes',
          erpRecibos: (localStorage.getItem('erpRecibos') || '').length + ' bytes',
          erpClientes: (localStorage.getItem('erpClientes') || '').length + ' bytes',
          erpReservasExecutadas: (localStorage.getItem('erpReservasExecutadas') || '').length + ' bytes',
          erpSistemaLogs: (localStorage.getItem('erpSistemaLogs') || '').length + ' bytes'
        }
      };
      
      // Criar ficheiro para download
      const conteudo = JSON.stringify(diagnostico, null, 2);
      const blob = new Blob([conteudo], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      
      const a = document.createElement('a');
      a.href = url;
      a.download = `diagnostico_erp_${new Date().toISOString().slice(0,10)}_${new Date().toTimeString().slice(0,5).replace(':','-')}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      registarLog('INFO', 'RelatÃ³rio de diagnÃ³stico exportado com sucesso');
      alert('âœ… RelatÃ³rio de diagnÃ³stico exportado!\n\nEnvie este ficheiro para anÃ¡lise quando reportar um problema.');
    }
    
    // Exportar logs para texto (mais simples para copiar)
    function exportarLogsTexto() {
      const logsTexto = sistemalogs.map(log => 
        `[${log.dataHora}] [${log.tipo}] [${log.pagina}] ${log.mensagem}${log.detalhes ? '\n  Detalhes: ' + JSON.stringify(log.detalhes) : ''}`
      ).join('\n\n');
      
      const blob = new Blob([logsTexto], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      
      const a = document.createElement('a');
      a.href = url;
      a.download = `logs_erp_${new Date().toISOString().slice(0,10)}.txt`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      registarLog('INFO', 'Logs exportados para ficheiro de texto');
    }
    
    // ==================== CLIENTES DE TESTE ====================
    
    function criarClientesTeste() {
      let clientes = JSON.parse(localStorage.getItem('erpClientes') || '[]');
      
      // Se jÃ¡ existem clientes de teste, nÃ£o criar novamente
      if (clientes.some(c => c.nif === '501234567')) {
        console.log('âœ… Clientes de teste jÃ¡ existem');
        return;
      }
      
      const clientesTeste = [
        {
          id: 1001,
          codigo: 'CLI-001',
          nome: 'Transportes RÃ¡pidos do Norte, Lda',
          nomeComercial: 'TR Norte',
          nif: '501234567',
          email: 'ruben@tracocer.pt',
          telefone: '+351 253 123 456',
          morada: 'Rua da IndÃºstria, 123',
          localidade: 'SÃ£o JoÃ£o',
          freguesia: 'SÃ£o JoÃ£o das Caldas',
          codigoPostal: '4700-001',
          cidade: 'Braga',
          concelho: 'Braga',
          pais: 'Portugal',
          modo_faturacao: 'Manual',
          estado: 'Ativo',
          bloqueado: false,
          dataCriacao: new Date().toISOString()
        },
        {
          id: 1002,
          codigo: 'CLI-002',
          nome: 'LogÃ­stica Centro Sul, S.A.',
          nomeComercial: 'LCS Transportes',
          nif: '502345678',
          email: 'ruben@emeutrans.pt',
          telefone: '+351 21 234 5678',
          morada: 'Av. da RepÃºblica, 456',
          localidade: 'Alvalade',
          freguesia: 'Alvalade',
          codigoPostal: '1050-001',
          cidade: 'Lisboa',
          concelho: 'Lisboa',
          pais: 'Portugal',
          modo_faturacao: 'Manual',
          estado: 'Ativo',
          bloqueado: false,
          dataCriacao: new Date().toISOString()
        },
        {
          id: 1003,
          codigo: 'CLI-003',
          nome: 'Mercadorias IbÃ©ricas, Lda',
          nomeComercial: 'Merc. IbÃ©ricas',
          nif: '503456789',
          email: 'dina@tracocer.pt',
          telefone: '+351 244 567 890',
          morada: 'Zona Industrial, Lote 15',
          localidade: 'Marinha Grande',
          freguesia: 'Marinha Grande',
          codigoPostal: '2430-001',
          cidade: 'Marinha Grande',
          concelho: 'Marinha Grande',
          pais: 'Portugal',
          modo_faturacao: 'Manual',
          estado: 'Ativo',
          bloqueado: false,
          dataCriacao: new Date().toISOString()
        },
        {
          id: 1004,
          codigo: 'CLI-004',
          nome: 'DistribuiÃ§Ã£o Expressa Porto, Lda',
          nomeComercial: 'DEP Express',
          nif: '504567890',
          email: 'dina@emeutrans.pt',
          telefone: '+351 22 345 6789',
          morada: 'Rua do ComÃ©rcio, 789',
          localidade: 'Matosinhos',
          freguesia: 'Matosinhos',
          codigoPostal: '4450-001',
          cidade: 'Matosinhos',
          concelho: 'Matosinhos',
          pais: 'Portugal',
          modo_faturacao: 'Manual',
          estado: 'Ativo',
          bloqueado: false,
          dataCriacao: new Date().toISOString()
        },
        {
          id: 1005,
          codigo: 'CLI-005',
          nome: 'Cargas Pesadas Alentejo, S.A.',
          nomeComercial: 'CPA Transportes',
          nif: '505678901',
          email: 'controlo.custos@emeutrans.pt',
          telefone: '+351 266 789 012',
          morada: 'Estrada Nacional 4, Km 125',
          localidade: 'Ã‰vora',
          freguesia: 'Ã‰vora (SÃ£o Mamede)',
          codigoPostal: '7000-001',
          cidade: 'Ã‰vora',
          concelho: 'Ã‰vora',
          pais: 'Portugal',
          modo_faturacao: 'Manual',
          estado: 'Ativo',
          bloqueado: false,
          dataCriacao: new Date().toISOString()
        },
        {
          id: 1006,
          codigo: 'CLI-006',
          nome: 'FrigorÃ­ficos do Minho, Lda',
          nomeComercial: 'Frio Minho',
          nif: '506789012',
          email: 'financeiro@tracocer.pt',
          telefone: '+351 253 890 123',
          morada: 'Parque Empresarial, Bloco A',
          localidade: 'GuimarÃ£es',
          freguesia: 'Oliveira do Castelo',
          codigoPostal: '4800-001',
          cidade: 'GuimarÃ£es',
          concelho: 'GuimarÃ£es',
          pais: 'Portugal',
          modo_faturacao: 'Manual',
          estado: 'Ativo',
          bloqueado: false,
          dataCriacao: new Date().toISOString()
        },
        {
          id: 1007,
          codigo: 'CLI-007',
          nome: 'TransLusitÃ¢nia ComÃ©rcio Internacional',
          nomeComercial: 'TransLusi',
          nif: '507890123',
          email: 'financeiro@emeutrans.pt',
          telefone: '+351 21 901 2345',
          morada: 'Av. dos Aliados, 321',
          localidade: 'Cascais',
          freguesia: 'Cascais',
          codigoPostal: '2750-001',
          cidade: 'Cascais',
          concelho: 'Cascais',
          pais: 'Portugal',
          modo_faturacao: 'Manual',
          estado: 'Ativo',
          bloqueado: false,
          dataCriacao: new Date().toISOString()
        },
        {
          id: 1008,
          codigo: 'CLI-008',
          nome: 'Cimentos & Inertes do Douro',
          nomeComercial: 'CID Materiais',
          nif: '508901234',
          email: 'ruben@tracocer.pt',
          telefone: '+351 254 012 345',
          morada: 'Rua das Pedreiras, 56',
          localidade: 'Vila Real',
          freguesia: 'Vila Real',
          codigoPostal: '5000-001',
          cidade: 'Vila Real',
          concelho: 'Vila Real',
          pais: 'Portugal',
          modo_faturacao: 'Manual',
          estado: 'Ativo',
          bloqueado: false,
          dataCriacao: new Date().toISOString()
        },
        {
          id: 1009,
          codigo: 'CLI-009',
          nome: 'Produtos AgrÃ­colas Ribatejo, Lda',
          nomeComercial: 'PAR AgrÃ­cola',
          nif: '509012345',
          email: 'dina@tracocer.pt',
          telefone: '+351 243 123 456',
          morada: 'Quinta das Oliveiras',
          localidade: 'SantarÃ©m',
          freguesia: 'SantarÃ©m (Marvila)',
          codigoPostal: '2000-001',
          cidade: 'SantarÃ©m',
          concelho: 'SantarÃ©m',
          pais: 'Portugal',
          modo_faturacao: 'Manual',
          estado: 'Ativo',
          bloqueado: false,
          dataCriacao: new Date().toISOString()
        },
        {
          id: 1010,
          codigo: 'CLI-010',
          nome: 'ExportaÃ§Ãµes Algarve Premium, S.A.',
          nomeComercial: 'EAP Export',
          nif: '510123456',
          email: 'controlo.custos@emeutrans.pt',
          telefone: '+351 289 234 567',
          morada: 'Zona Industrial de LoulÃ©, Lote 8',
          localidade: 'LoulÃ©',
          freguesia: 'LoulÃ© (SÃ£o SebastiÃ£o)',
          codigoPostal: '8100-001',
          cidade: 'LoulÃ©',
          concelho: 'LoulÃ©',
          pais: 'Portugal',
          modo_faturacao: 'Manual',
          estado: 'Ativo',
          bloqueado: false,
          dataCriacao: new Date().toISOString()
        }
      ];
      
      // Adicionar aos clientes existentes
      clientes = clientes.concat(clientesTeste);
      
      // Guardar no localStorage
      localStorage.setItem('erpClientes', JSON.stringify(clientes));
      
      console.log('âœ… 10 clientes de teste criados com sucesso!');
      console.log('   Emails: ruben@tracocer.pt, ruben@emeutrans.pt, dina@tracocer.pt, dina@emeutrans.pt,');
      console.log('           controlo.custos@emeutrans.pt, financeiro@tracocer.pt, financeiro@emeutrans.pt');
    }
    
    // ==================== CARREGAR DADOS ====================
    
    function carregarDados() {
      // Carregar logs primeiro
      carregarLogs();
      registarLog('INFO', 'A carregar dados do sistema...');
      
      faturas = JSON.parse(localStorage.getItem('erpFaturas') || '[]');
      notasCredito = JSON.parse(localStorage.getItem('erpNotasCredito') || '[]');
      recibos = JSON.parse(localStorage.getItem('erpRecibos') || '[]');
      notasDebito = JSON.parse(localStorage.getItem('erpNotasDebito') || '[]');
      pagamentosFornecedor = JSON.parse(localStorage.getItem('erpPagamentosFornecedor') || '[]');
      debitosFornecedor = JSON.parse(localStorage.getItem('erpDebitosFornecedor') || '[]');
      series = JSON.parse(localStorage.getItem('erpSeriesDoc') || '[]');
      // CORREÃ‡ÃƒO: Suportar ambas estruturas de clientes (array direto ou {lista: [...], proximoNumero: X})
      var clientesData = JSON.parse(localStorage.getItem('erpClientes') || '[]');
      if (Array.isArray(clientesData)) {
        clientes = clientesData;
      } else if (clientesData && Array.isArray(clientesData.lista)) {
        clientes = clientesData.lista;
      } else {
        clientes = [];
      }
      reservas = JSON.parse(localStorage.getItem('erpReservasExecutadas') || '[]');
      empresaConfig = JSON.parse(localStorage.getItem('erpEmpresaConfig') || '{}');
      
      registarLog('INFO', 'Dados carregados com sucesso', {
        faturas: faturas.length,
        notasCredito: notasCredito.length,
        recibos: recibos.length,
        clientes: clientes.length,
        reservas: reservas.length
      });
      
      // ConfiguraÃ§Ã£o padrÃ£o da empresa - DADOS REAIS EMEUTRANS
      if (!empresaConfig.nome) {
        empresaConfig = {
          nome: 'Emeutrans',
          nif: 'PT515996149',
          morada: 'Rua Do Rei Conquistador NÂº2 - Casal Do Rei',
          localidade: '2500-739 Vidais - Caldas Da Rainha - Portugal',
          telefone: '+351 243 909 780',
          email: 'geral@emeutrans.pt',
          iban: 'PT50 0035 0000 00000000000 97',
          certificacao: 'Programa certificado nÂº 0000/AT',
          capitalSocial: '125.000â‚¬',
          registoComercial: 'C.R.C Caldas Da Rainha'
        };
        localStorage.setItem('erpEmpresaConfig', JSON.stringify(empresaConfig));
      }
      
      // CORREÃ‡ÃƒO: Garantir que campos novos existem mesmo se empresaConfig jÃ¡ existia
      let empresaAtualizada = false;
      if (!empresaConfig.capitalSocial) { empresaConfig.capitalSocial = '125.000â‚¬'; empresaAtualizada = true; }
      if (!empresaConfig.registoComercial) { empresaConfig.registoComercial = 'C.R.C Caldas Da Rainha'; empresaAtualizada = true; }
      if (!empresaConfig.telefone) { empresaConfig.telefone = '+351 243 909 780'; empresaAtualizada = true; }
      if (!empresaConfig.email) { empresaConfig.email = 'geral@emeutrans.pt'; empresaAtualizada = true; }
      if (empresaConfig.iban === 'PT50 0000 0000 0000 0000 0000 0') {
        empresaConfig.iban = 'PT50 0035 0000 00000000000 97';
        empresaAtualizada = true;
      }
      // Guardar correÃ§Ãµes se necessÃ¡rio
      if (empresaAtualizada) {
        localStorage.setItem('erpEmpresaConfig', JSON.stringify(empresaConfig));
        console.log('ğŸ”§ Dados da empresa atualizados automaticamente');
      }
      
      // SÃ©ries padrÃ£o - TODOS OS TIPOS DE DOCUMENTOS
      if (series.length === 0 || series.length < 6) {
        series = [
          { id: 1, tipo: 'Fatura', serie: 'FT', prefixo: 'FT', proxNum: 1, ano: 2025, estado: 'Ativo' },
          { id: 2, tipo: 'Nota CrÃ©dito', serie: 'NC', prefixo: 'NC', proxNum: 1, ano: 2025, estado: 'Ativo' },
          { id: 3, tipo: 'Recibo', serie: 'RC', prefixo: 'RC', proxNum: 1, ano: 2025, estado: 'Ativo' },
          { id: 4, tipo: 'Nota DÃ©bito', serie: 'ND', prefixo: 'ND', proxNum: 1, ano: 2025, estado: 'Ativo' },
          { id: 5, tipo: 'Pagamento Fornecedor', serie: 'PF', prefixo: 'PF', proxNum: 1, ano: 2025, estado: 'Ativo' },
          { id: 6, tipo: 'DÃ©bito Fornecedor', serie: 'DF', prefixo: 'DF', proxNum: 1, ano: 2025, estado: 'Ativo' }
        ];
        guardarDados();
      }
      
      // CORREÃ‡ÃƒO: Atualizar clientes existentes sem emails/numeroCliente
      let clientesAtualizados = false;
      if (Array.isArray(clientes)) {
        clientes.forEach(c => {
          if (!c.numeroCliente && c.id) {
            c.numeroCliente = 'C' + (7000 + c.id);
            clientesAtualizados = true;
          }
          if (c.nome && (!c.emailsContabilidade || c.emailsContabilidade.length === 0)) {
            c.emailsContabilidade = ['contabilidade@' + c.nome.toLowerCase().replace(/[^a-z]/g, '').substring(0, 10) + '.pt'];
            clientesAtualizados = true;
          }
          if (c.nome && (!c.emailsGerais || c.emailsGerais.length === 0)) {
            c.emailsGerais = ['geral@' + c.nome.toLowerCase().replace(/[^a-z]/g, '').substring(0, 10) + '.pt'];
            clientesAtualizados = true;
          }
        });
      }
      if (clientesAtualizados) {
        localStorage.setItem('erpClientes', JSON.stringify(clientes));
      }
      
      // Clientes de exemplo - CORREÃ‡ÃƒO: Verificar se existem os 5 clientes de teste
      const clientesNecessarios = [1, 2, 3, 4, 5];
      const clientesExistentes = clientesNecessarios.filter(id => clientes.find(c => c.id === id));
      if (clientes.length === 0 || clientesExistentes.length < 5) {
        clientes = [
          { 
            id: 1, numeroCliente: 'C7001', nome: 'Empresa Nacional Lda', nif: '501234567', 
            morada: 'Rua do ComÃ©rcio 123', localidade: '1000-001 Lisboa', pais: 'Portugal',
            telefone: '+351 21 123 4567', telemovel: '+351 91 234 5678',
            tipoCliente: '21111', // Nacional
            tipoFaturacao: 'manual',
            prazoPagamento: 30,
            emailsContabilidade: ['contabilidade@enacional.pt', 'faturas@enacional.pt'],
            emailsFinanceiro: ['financeiro@enacional.pt', 'tesouraria@enacional.pt'],
            emailsGerais: ['geral@enacional.pt'],
            respContabilidadeNome: 'Maria Santos',
            respContabilidadeEmail: 'maria.santos@enacional.pt',
            respContabilidadeTelefone: '+351 21 123 4568',
            respFinanceiroNome: 'JoÃ£o Ferreira',
            respFinanceiroEmail: 'joao.ferreira@enacional.pt',
            respFinanceiroTelefone: '+351 21 123 4569',
            camposPP: { campo54: '', campo55: 'nÃ£o', campo56: '' }
          },
          { 
            id: 2, numeroCliente: 'C7022', nome: 'Transport Europe SA', nif: 'FR12345678901', 
            morada: 'Avenue des Champs 456', localidade: '75008 Paris', pais: 'FranÃ§a',
            telefone: '+33 1 23 45 67 89', telemovel: '+33 6 12 34 56 78',
            tipoCliente: '21112', // Europeu
            tipoFaturacao: 'automatica',
            prazoPagamento: 45,
            emailsContabilidade: ['comptabilite@teurope.fr', 'factures@teurope.fr'],
            emailsFinanceiro: ['tresorerie@teurope.fr'],
            emailsGerais: ['info@teurope.fr', 'contact@teurope.fr'],
            respContabilidadeNome: 'Pierre Dupont',
            respContabilidadeEmail: 'pierre.dupont@teurope.fr',
            respContabilidadeTelefone: '+33 1 23 45 67 90',
            respFinanceiroNome: 'Marie LefÃ¨vre',
            respFinanceiroEmail: 'marie.lefevre@teurope.fr',
            respFinanceiroTelefone: '+33 1 23 45 67 91',
            camposPP: { campo54: '', campo55: 'nÃ£o', campo56: '' }
          },
          { 
            id: 3, numeroCliente: 'C7033', nome: 'Global Logistics UK Ltd', nif: 'GB123456789', 
            morada: 'London Street 789', localidade: 'EC1A 1BB London', pais: 'Reino Unido',
            telefone: '+44 20 7123 4567', telemovel: '+44 77 1234 5678',
            tipoCliente: '21113', // Fora UE
            tipoFaturacao: 'manual',
            prazoPagamento: 60,
            emailsContabilidade: ['accounts@gluk.co.uk', 'invoices@gluk.co.uk'],
            emailsFinanceiro: ['finance@gluk.co.uk', 'treasury@gluk.co.uk'],
            emailsGerais: ['info@gluk.co.uk'],
            respContabilidadeNome: 'John Smith',
            respContabilidadeEmail: 'john.smith@gluk.co.uk',
            respContabilidadeTelefone: '+44 20 7123 4568',
            respFinanceiroNome: 'Sarah Johnson',
            respFinanceiroEmail: 'sarah.johnson@gluk.co.uk',
            respFinanceiroTelefone: '+44 20 7123 4569',
            camposPP: { campo54: 'Frete pago', campo55: 'sim P/P', campo56: 'Porto de Lisboa' }
          },
          { 
            id: 4, numeroCliente: 'C7044', nome: 'Transportes Abreu SA', nif: '502345678', 
            morada: 'Av. da Liberdade 500', localidade: '4000-001 Porto', pais: 'Portugal',
            telefone: '+351 22 345 6789', telemovel: '+351 92 345 6789',
            tipoCliente: '21111', // Nacional
            tipoFaturacao: 'manual',
            prazoPagamento: 30,
            emailsContabilidade: ['contab@abreu.pt', 'faturas@abreu.pt'],
            emailsFinanceiro: ['financeiro@abreu.pt', 'pagamentos@abreu.pt'],
            emailsGerais: ['geral@abreu.pt', 'comercial@abreu.pt'],
            respContabilidadeNome: 'Ana Costa',
            respContabilidadeEmail: 'ana.costa@abreu.pt',
            respContabilidadeTelefone: '+351 22 345 6790',
            respFinanceiroNome: 'Pedro Oliveira',
            respFinanceiroEmail: 'pedro.oliveira@abreu.pt',
            respFinanceiroTelefone: '+351 22 345 6791',
            camposPP: { campo54: '', campo55: 'nÃ£o', campo56: '' }
          },
          { 
            id: 5, numeroCliente: 'C7055', nome: 'LogÃ­stica Silva Lda', nif: '503456789', 
            morada: 'Zona Industrial Norte, Lote 15', localidade: '4700-001 Braga', pais: 'Portugal',
            telefone: '+351 25 345 6789', telemovel: '+351 93 456 7890',
            tipoCliente: '21111', // Nacional
            tipoFaturacao: 'automatica',
            prazoPagamento: 45,
            emailsContabilidade: ['contabilidade@silva.pt'],
            emailsFinanceiro: ['tesouraria@silva.pt', 'financeiro@silva.pt'],
            emailsGerais: ['info@silva.pt', 'operacoes@silva.pt'],
            respContabilidadeNome: 'Carla Ribeiro',
            respContabilidadeEmail: 'carla.ribeiro@silva.pt',
            respContabilidadeTelefone: '+351 25 345 6790',
            respFinanceiroNome: 'Miguel Pereira',
            respFinanceiroEmail: 'miguel.pereira@silva.pt',
            respFinanceiroTelefone: '+351 25 345 6791',
            camposPP: { campo54: '', campo55: 'nÃ£o', campo56: '' }
          },
          { 
            id: 6, numeroCliente: 'C7066', nome: 'Spedition Schmidt GmbH', nif: 'DE123456789', 
            morada: 'IndustriestraÃŸe 45', localidade: '60311 Frankfurt', pais: 'Alemanha',
            telefone: '+49 69 123 4567', telemovel: '+49 170 123 4567',
            tipoCliente: '21112', // Europeu
            tipoFaturacao: 'automatica',
            prazoPagamento: 30,
            emailsContabilidade: ['buchhaltung@schmidt-spedition.de', 'rechnungen@schmidt-spedition.de'],
            emailsFinanceiro: ['finanzen@schmidt-spedition.de'],
            emailsGerais: ['info@schmidt-spedition.de', 'kontakt@schmidt-spedition.de'],
            respContabilidadeNome: 'Hans MÃ¼ller',
            respContabilidadeEmail: 'hans.mueller@schmidt-spedition.de',
            respContabilidadeTelefone: '+49 69 123 4568',
            respFinanceiroNome: 'Greta Weber',
            respFinanceiroEmail: 'greta.weber@schmidt-spedition.de',
            respFinanceiroTelefone: '+49 69 123 4569',
            camposPP: { campo54: '', campo55: 'nÃ£o', campo56: '' }
          },
          { 
            id: 7, numeroCliente: 'C7077', nome: 'Trasporti Rossi SpA', nif: 'IT12345678901', 
            morada: 'Via Roma 123', localidade: '20121 Milano', pais: 'ItÃ¡lia',
            telefone: '+39 02 1234 5678', telemovel: '+39 339 123 4567',
            tipoCliente: '21112', // Europeu
            tipoFaturacao: 'manual',
            prazoPagamento: 60,
            emailsContabilidade: ['contabilita@rossi-trasporti.it', 'fatture@rossi-trasporti.it'],
            emailsFinanceiro: ['tesoreria@rossi-trasporti.it', 'finanza@rossi-trasporti.it'],
            emailsGerais: ['info@rossi-trasporti.it'],
            respContabilidadeNome: 'Marco Bianchi',
            respContabilidadeEmail: 'marco.bianchi@rossi-trasporti.it',
            respContabilidadeTelefone: '+39 02 1234 5679',
            respFinanceiroNome: 'Giulia Ferrari',
            respFinanceiroEmail: 'giulia.ferrari@rossi-trasporti.it',
            respFinanceiroTelefone: '+39 02 1234 5680',
            camposPP: { campo54: '', campo55: 'nÃ£o', campo56: '' }
          },
          { 
            id: 8, numeroCliente: 'C7088', nome: 'Transportes IbÃ©ricos SA', nif: 'ES12345678A', 
            morada: 'Calle Mayor 78', localidade: '28001 Madrid', pais: 'Espanha',
            telefone: '+34 91 123 4567', telemovel: '+34 612 345 678',
            tipoCliente: '21112', // Europeu
            tipoFaturacao: 'automatica',
            prazoPagamento: 45,
            emailsContabilidade: ['contabilidad@tibericos.es', 'facturas@tibericos.es'],
            emailsFinanceiro: ['tesoreria@tibericos.es'],
            emailsGerais: ['info@tibericos.es', 'comercial@tibericos.es'],
            respContabilidadeNome: 'Carmen GarcÃ­a',
            respContabilidadeEmail: 'carmen.garcia@tibericos.es',
            respContabilidadeTelefone: '+34 91 123 4568',
            respFinanceiroNome: 'Miguel RodrÃ­guez',
            respFinanceiroEmail: 'miguel.rodriguez@tibericos.es',
            respFinanceiroTelefone: '+34 91 123 4569',
            camposPP: { campo54: '', campo55: 'nÃ£o', campo56: '' }
          },
          { 
            id: 9, numeroCliente: 'C7099', nome: 'Freteiro & Filhos Lda', nif: '504567890', 
            morada: 'Estrada Nacional 1, Km 234', localidade: '3000-001 Coimbra', pais: 'Portugal',
            telefone: '+351 23 456 7890', telemovel: '+351 94 567 8901',
            tipoCliente: '21111', // Nacional
            tipoFaturacao: 'manual',
            prazoPagamento: 30,
            emailsContabilidade: ['contabilidade@freteiro.pt'],
            emailsFinanceiro: ['financeiro@freteiro.pt', 'tesouraria@freteiro.pt'],
            emailsGerais: ['geral@freteiro.pt', 'apoio@freteiro.pt'],
            respContabilidadeNome: 'Teresa Almeida',
            respContabilidadeEmail: 'teresa.almeida@freteiro.pt',
            respContabilidadeTelefone: '+351 23 456 7891',
            respFinanceiroNome: 'AntÃ³nio Freteiro',
            respFinanceiroEmail: 'antonio.freteiro@freteiro.pt',
            respFinanceiroTelefone: '+351 23 456 7892',
            camposPP: { campo54: '', campo55: 'nÃ£o', campo56: '' }
          },
          { 
            id: 10, numeroCliente: 'C7100', nome: 'Nordic Transport AB', nif: 'SE123456789012', 
            morada: 'Kungsgatan 55', localidade: '11122 Stockholm', pais: 'SuÃ©cia',
            telefone: '+46 8 123 45 67', telemovel: '+46 70 123 45 67',
            tipoCliente: '21112', // Europeu
            tipoFaturacao: 'automatica',
            prazoPagamento: 30,
            emailsContabilidade: ['bokforing@nordictransport.se', 'fakturor@nordictransport.se'],
            emailsFinanceiro: ['ekonomi@nordictransport.se'],
            emailsGerais: ['info@nordictransport.se', 'support@nordictransport.se'],
            respContabilidadeNome: 'Erik Lindberg',
            respContabilidadeEmail: 'erik.lindberg@nordictransport.se',
            respContabilidadeTelefone: '+46 8 123 45 68',
            respFinanceiroNome: 'Anna Svensson',
            respFinanceiroEmail: 'anna.svensson@nordictransport.se',
            respFinanceiroTelefone: '+46 8 123 45 69',
            camposPP: { campo54: 'FOB', campo55: 'sim P/P', campo56: 'Porto de Gotemburgo' }
          }
        ];
        localStorage.setItem('erpClientes', JSON.stringify(clientes));
      }
      
      // Reservas executadas de exemplo (mais linhas para testar)
      // CORREÃ‡ÃƒO: Criar reservas se nÃ£o existirem OU se todas estiverem faturadas
      const reservasDisponiveis = reservas.filter(r => !r.faturada && r.cmrCarga && r.cmrDescarga);
      if (reservas.length === 0 || reservasDisponiveis.length === 0) {
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸ§ª DADOS DE TESTE v6.34 - PARA TESTAR REGRAS DE FATURAÃ‡ÃƒO E IVA
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // 
        // CENÃRIOS DE TESTE:
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // C0001 - Transportes RÃ¡pidos do Norte (MANUAL)
        //    â†’ RES-2025-001: Lisboa â†’ Porto (PTâ†’PT = 23% IVA)
        //    â†’ RES-2025-002: Porto â†’ Madrid (PTâ†’EUR = 0% IVA)
        //
        // C0002 - LogÃ­stica Centro Sul (AUTOMÃTICA) âš¡
        //    â†’ RES-2025-003: SetÃºbal â†’ Lisboa (PTâ†’PT = 23% IVA)
        //    â†’ RES-2025-004: Lisboa â†’ Paris (PTâ†’EUR = 0% IVA)
        //
        // C0003 - Mercadorias IbÃ©ricas (MANUAL)
        //    â†’ RES-2025-005: Porto â†’ Braga (PTâ†’PT = 23% IVA)
        //    â†’ RES-2025-006: Braga â†’ Barcelona (PTâ†’EUR = 0% IVA)
        //
        // C0004 - DistribuiÃ§Ã£o Expressa Porto (MANUAL)
        //    â†’ RES-2025-007: Coimbra â†’ Aveiro (PTâ†’PT = 23% IVA)
        //    â†’ RES-2025-008: Aveiro â†’ Bordeaux (PTâ†’EUR = 0% IVA)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        reservas = [
          // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          // C0001 - TRANSPORTES RÃPIDOS DO NORTE (FaturaÃ§Ã£o MANUAL)
          // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          {
            id: 1, 
            numero: 'RES-2025-001', 
            clienteId: 'C0001', 
            cliente: 'Transportes RÃ¡pidos do Norte, Lda',
            clienteNIF: '501234567',
            clienteMorada: 'Rua da IndÃºstria, 123, Braga',
            modoFaturacao: 'Manual',
            localCarga: 'Lisboa, Portugal', 
            localDescarga: 'Porto, Portugal',
            refCliente: 'TRN-001', 
            ldm: '13.6', 
            pesoCarga: 24000, 
            pesoDescarga: 23980,
            precoTon: 35, 
            tipoMercadoria: 'Normal', 
            valorFixo: null,
            cmrCarga: '', 
            cmrDescarga: '',
            cmrCargaAnexado: false,
            cmrDescargaAnexado: false,
            dataExecucao: '2025-12-20', 
            faturada: false,
            // Campos extra para referÃªncia
            tipoCliente: '21111',
            ivaEsperado: 23,
            descricaoTeste: 'ğŸ‡µğŸ‡¹â†’ğŸ‡µğŸ‡¹ PT para PT = IVA 23%'
          },
          {
            id: 2, 
            numero: 'RES-2025-002', 
            clienteId: 'C0001', 
            cliente: 'Transportes RÃ¡pidos do Norte, Lda',
            clienteNIF: '501234567',
            clienteMorada: 'Rua da IndÃºstria, 123, Braga',
            modoFaturacao: 'Manual',
            localCarga: 'Porto, Portugal', 
            localDescarga: 'Madrid, Espanha',
            refCliente: 'TRN-002', 
            ldm: '13.6', 
            pesoCarga: 22000, 
            pesoDescarga: 21950,
            precoTon: 55, 
            tipoMercadoria: 'Normal', 
            valorFixo: null,
            cmrCarga: '', 
            cmrDescarga: '',
            cmrCargaAnexado: false,
            cmrDescargaAnexado: false,
            dataExecucao: '2025-12-21', 
            faturada: false,
            tipoCliente: '21111',
            ivaEsperado: 0,
            descricaoTeste: 'ğŸ‡µğŸ‡¹â†’ğŸ‡ªğŸ‡¸ PT para EUR = IVA 0% Isento'
          },
          
          // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          // C0002 - LOGÃSTICA CENTRO SUL (FaturaÃ§Ã£o AUTOMÃTICA) âš¡
          // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          {
            id: 3, 
            numero: 'RES-2025-003', 
            clienteId: 'C0002', 
            cliente: 'LogÃ­stica Centro Sul, SA',
            clienteNIF: '502345678',
            clienteMorada: 'Avenida da RepÃºblica, 456, Lisboa',
            modoFaturacao: 'AutomÃ¡tica',
            localCarga: 'SetÃºbal, Portugal', 
            localDescarga: 'Lisboa, Portugal',
            refCliente: 'LCS-001', 
            ldm: '10.5', 
            pesoCarga: 18000, 
            pesoDescarga: 17980,
            precoTon: 28, 
            tipoMercadoria: 'Normal', 
            valorFixo: null,
            cmrCarga: '', 
            cmrDescarga: '',
            cmrCargaAnexado: false,
            cmrDescargaAnexado: false,
            dataExecucao: '2025-12-20', 
            faturada: false,
            tipoCliente: '21111',
            ivaEsperado: 23,
            descricaoTeste: 'âš¡ AUTOMÃTICA ğŸ‡µğŸ‡¹â†’ğŸ‡µğŸ‡¹ PT para PT = IVA 23%'
          },
          {
            id: 4, 
            numero: 'RES-2025-004', 
            clienteId: 'C0002', 
            cliente: 'LogÃ­stica Centro Sul, SA',
            clienteNIF: '502345678',
            clienteMorada: 'Avenida da RepÃºblica, 456, Lisboa',
            modoFaturacao: 'AutomÃ¡tica',
            localCarga: 'Lisboa, Portugal', 
            localDescarga: 'Paris, FranÃ§a',
            refCliente: 'LCS-002', 
            ldm: '13.6', 
            pesoCarga: 20000, 
            pesoDescarga: 19950,
            precoTon: 95, 
            tipoMercadoria: 'Normal', 
            valorFixo: null,
            cmrCarga: '', 
            cmrDescarga: '',
            cmrCargaAnexado: false,
            cmrDescargaAnexado: false,
            dataExecucao: '2025-12-21', 
            faturada: false,
            tipoCliente: '21111',
            ivaEsperado: 0,
            descricaoTeste: 'âš¡ AUTOMÃTICA ğŸ‡µğŸ‡¹â†’ğŸ‡«ğŸ‡· PT para EUR = IVA 0% Isento'
          },
          
          // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          // C0003 - MERCADORIAS IBÃ‰RICAS (FaturaÃ§Ã£o MANUAL)
          // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          {
            id: 5, 
            numero: 'RES-2025-005', 
            clienteId: 'C0003', 
            cliente: 'Mercadorias IbÃ©ricas, Lda',
            clienteNIF: '503456789',
            clienteMorada: 'Rua do ComÃ©rcio, 78, Porto',
            modoFaturacao: 'Manual',
            localCarga: 'Porto, Portugal', 
            localDescarga: 'Braga, Portugal',
            refCliente: 'MIB-001', 
            ldm: '8.0', 
            pesoCarga: null, 
            pesoDescarga: null,
            precoTon: null, 
            tipoMercadoria: 'Paletes', 
            valorFixo: 380.00,
            cmrCarga: '', 
            cmrDescarga: '',
            cmrCargaAnexado: false,
            cmrDescargaAnexado: false,
            dataExecucao: '2025-12-20', 
            faturada: false,
            tipoCliente: '21111',
            ivaEsperado: 23,
            descricaoTeste: 'ğŸ‡µğŸ‡¹â†’ğŸ‡µğŸ‡¹ PT para PT = IVA 23% (Valor Fixo)'
          },
          {
            id: 6, 
            numero: 'RES-2025-006', 
            clienteId: 'C0003', 
            cliente: 'Mercadorias IbÃ©ricas, Lda',
            clienteNIF: '503456789',
            clienteMorada: 'Rua do ComÃ©rcio, 78, Porto',
            modoFaturacao: 'Manual',
            localCarga: 'Braga, Portugal', 
            localDescarga: 'Barcelona, Espanha',
            refCliente: 'MIB-002', 
            ldm: '13.6', 
            pesoCarga: null, 
            pesoDescarga: null,
            precoTon: null, 
            tipoMercadoria: 'Completo', 
            valorFixo: 1250.00,
            cmrCarga: '', 
            cmrDescarga: '',
            cmrCargaAnexado: false,
            cmrDescargaAnexado: false,
            dataExecucao: '2025-12-21', 
            faturada: false,
            tipoCliente: '21111',
            ivaEsperado: 0,
            descricaoTeste: 'ğŸ‡µğŸ‡¹â†’ğŸ‡ªğŸ‡¸ PT para EUR = IVA 0% Isento (Valor Fixo)'
          },
          
          // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          // C0004 - DISTRIBUIÃ‡ÃƒO EXPRESSA PORTO (FaturaÃ§Ã£o MANUAL)
          // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          {
            id: 7, 
            numero: 'RES-2025-007', 
            clienteId: 'C0004', 
            cliente: 'DistribuiÃ§Ã£o Expressa Porto, SA',
            clienteNIF: '504567890',
            clienteMorada: 'Avenida da Boavista, 1500, Porto',
            modoFaturacao: 'Manual',
            localCarga: 'Coimbra, Portugal', 
            localDescarga: 'Aveiro, Portugal',
            refCliente: 'DEP-001', 
            ldm: '6.5', 
            pesoCarga: 15000, 
            pesoDescarga: 14980,
            precoTon: 32, 
            tipoMercadoria: 'Normal', 
            valorFixo: null,
            cmrCarga: '', 
            cmrDescarga: '',
            cmrCargaAnexado: false,
            cmrDescargaAnexado: false,
            dataExecucao: '2025-12-20', 
            faturada: false,
            tipoCliente: '21111',
            ivaEsperado: 23,
            descricaoTeste: 'ğŸ‡µğŸ‡¹â†’ğŸ‡µğŸ‡¹ PT para PT = IVA 23%'
          },
          {
            id: 8, 
            numero: 'RES-2025-008', 
            clienteId: 'C0004', 
            cliente: 'DistribuiÃ§Ã£o Expressa Porto, SA',
            clienteNIF: '504567890',
            clienteMorada: 'Avenida da Boavista, 1500, Porto',
            modoFaturacao: 'Manual',
            localCarga: 'Aveiro, Portugal', 
            localDescarga: 'Bordeaux, FranÃ§a',
            refCliente: 'DEP-002', 
            ldm: '13.6', 
            pesoCarga: 21000, 
            pesoDescarga: 20950,
            precoTon: 78, 
            tipoMercadoria: 'Normal', 
            valorFixo: null,
            cmrCarga: '', 
            cmrDescarga: '',
            cmrCargaAnexado: false,
            cmrDescargaAnexado: false,
            dataExecucao: '2025-12-21', 
            faturada: false,
            tipoCliente: '21111',
            ivaEsperado: 0,
            descricaoTeste: 'ğŸ‡µğŸ‡¹â†’ğŸ‡«ğŸ‡· PT para EUR = IVA 0% Isento'
          }
        ];
        localStorage.setItem('erpReservasExecutadas', JSON.stringify(reservas));
      }
      
      // Notas de CrÃ©dito de exemplo
      if (notasCredito.length === 0) {
        notasCredito = [
          {
            id: 1,
            numero: 'NC 2025/1',
            data: '2025-12-10',
            faturaId: 1,
            faturaRef: 'FT 2025/1',
            clienteId: 1,
            cliente: 'Empresa Nacional Lda',
            nif: '501234567',
            morada: 'Rua do ComÃ©rcio, 123, Lisboa',
            motivo: 'Erro de faturaÃ§Ã£o',
            observacoes: 'CorrecÃ§Ã£o de valor cobrado em excesso',
            subtotal: 150.00,
            iva: 34.50,
            total: 184.50,
            taxaIVA: 23,
            estado: 'Emitida',
            linhas: [{
              descricao: 'Nota de CrÃ©dito ref. FT 2025/1 - Erro de faturaÃ§Ã£o',
              valor: 150.00,
              iva: 23
            }]
          },
          {
            id: 2,
            numero: 'NC 2025/2',
            data: '2025-12-12',
            faturaId: 2,
            faturaRef: 'FT 2025/2',
            clienteId: 2,
            cliente: 'Transport Europe SA',
            nif: 'FR12345678901',
            morada: 'Avenue des Champs, Paris',
            motivo: 'Desconto comercial',
            observacoes: 'Desconto acordado por volume',
            subtotal: 250.00,
            iva: 0,
            total: 250.00,
            taxaIVA: 0,
            estado: 'Emitida',
            linhas: [{
              descricao: 'Nota de CrÃ©dito ref. FT 2025/2 - Desconto comercial',
              valor: 250.00,
              iva: 0
            }]
          },
          {
            id: 3,
            numero: 'NC 2025/3',
            data: '2025-12-15',
            faturaId: 3,
            faturaRef: 'FT 2025/3',
            clienteId: 4,
            cliente: 'Transportes Abreu SA',
            nif: '509876543',
            morada: 'Zona Industrial, Lote 5, Porto',
            motivo: 'DiferenÃ§a de preÃ§o',
            observacoes: 'Ajuste de preÃ§o conforme tabela actualizada',
            subtotal: 85.00,
            iva: 19.55,
            total: 104.55,
            taxaIVA: 23,
            estado: 'Emitida',
            linhas: [{
              descricao: 'Nota de CrÃ©dito ref. FT 2025/3 - DiferenÃ§a de preÃ§o',
              valor: 85.00,
              iva: 23
            }]
          }
        ];
        localStorage.setItem('erpNotasCredito', JSON.stringify(notasCredito));
        
        // Actualizar sÃ©rie NC
        const serieNC = series.find(s => s.serie === 'NC');
        if (serieNC) serieNC.proxNum = 4;
      }
      
      // Verificar vencimentos e atualizar estados
      atualizarEstadosFaturas();
    }
    
    function guardarDados() {
      localStorage.setItem('erpFaturas', JSON.stringify(faturas));
      localStorage.setItem('erpNotasCredito', JSON.stringify(notasCredito));
      localStorage.setItem('erpRecibos', JSON.stringify(recibos));
      localStorage.setItem('erpNotasDebito', JSON.stringify(notasDebito));
      localStorage.setItem('erpPagamentosFornecedor', JSON.stringify(pagamentosFornecedor));
      localStorage.setItem('erpDebitosFornecedor', JSON.stringify(debitosFornecedor));
      localStorage.setItem('erpSeriesDoc', JSON.stringify(series));
      localStorage.setItem('erpReservasExecutadas', JSON.stringify(reservas));
    }
    
    function atualizarEstadosFaturas() {
      const hoje = new Date();
      hoje.setHours(0, 0, 0, 0);
      
      faturas.forEach(f => {
        if (f.estado !== 'Pago') {
          const venc = new Date(f.vencimento);
          venc.setHours(0, 0, 0, 0);
          
          if (venc < hoje && f.pago < f.total) {
            f.estado = 'Vencido';
          }
        }
      });
      guardarDados();
    }
    
    // ==================== NAVEGAÃ‡ÃƒO ====================
    
    function navegarPara(pagina) {
      // LIMPAR MOTOR DE BUSCA ao mudar de pÃ¡gina
      const pesquisaGlobal = document.getElementById('pesquisaGlobal');
      if (pesquisaGlobal) {
        pesquisaGlobal.value = '';
      }
      termoPesquisaGlobal = '';
      
      // Limpar tambÃ©m filtros especÃ­ficos de cada pÃ¡gina
      limparTodosFiltros();
      
      // Fechar todos os menus e abrir o menu correto
      document.querySelectorAll('.menu-items').forEach(m => {
        m.classList.add('menu-collapsed');
        m.style.display = 'none';
      });
      document.querySelectorAll('.menu-title').forEach(t => t.classList.remove('active'));
      abrirMenuDaPaginaAtiva(pagina);
      
      document.querySelectorAll('[id^="page-"]').forEach(p => {
        p.classList.add('hidden');
        p.style.display = 'none';
      });
      const paginaEl = document.getElementById('page-' + pagina);
      if (paginaEl) {
        paginaEl.classList.remove('hidden');
        paginaEl.classList.add('animate-fade-in');
        // Agenda 3 precisa de display: flex para o layout funcionar corretamente
        if (pagina === 'agenda3') {
          paginaEl.style.display = 'flex';
          // Inicializar a Agenda 3 se ainda nÃ£o foi feito
          if (typeof inicializarAgenda3 === 'function') {
            inicializarAgenda3();
          }
        } else if (pagina === 'agendaarquivo') {
          paginaEl.style.display = 'flex';
          // Inicializar a Agenda Arquivo
          if (typeof inicializarAgendaArquivo === 'function') {
            inicializarAgendaArquivo();
          }
        } else if (pagina === 'reservas') {
          paginaEl.style.display = 'block';
          // Recarregar lista de clientes nas reservas
          if (typeof recarregarClientesReservas === 'function') {
            recarregarClientesReservas();
          }
          // Apenas resetar flags - NÃƒO limpar formulÃ¡rio
          // Isto permite criar novas reservas sem perder dados existentes
          if (typeof resetarFlagsReservas === 'function') {
            resetarFlagsReservas();
          }
        } else {
          paginaEl.style.display = 'block';
        }
      }
      
      document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
      if (event && event.target) {
        event.target.closest('.nav-item')?.classList.add('active');
      }
      
      const titulos = {
        // â•â•â•â•â•â•â•â•â•â•â• 1. ADMINISTRAÃ‡ÃƒO â•â•â•â•â•â•â•â•â•â•â•
        'dashboard': { titulo: 'Dashboard Geral', subtitulo: 'AnÃ¡lise de todos os mÃ³dulos' },
        'configuracoes': { titulo: 'ConfiguraÃ§Ãµes', subtitulo: 'ConfiguraÃ§Ãµes do sistema' },
        'utilizadores': { titulo: 'Utilizadores', subtitulo: 'GestÃ£o de utilizadores do sistema' },
        'permissoes': { titulo: 'PermissÃµes', subtitulo: 'AtribuiÃ§Ã£o de permissÃµes por utilizador' },
        'comerciais': { titulo: 'Comerciais', subtitulo: 'GestÃ£o da equipa comercial' },
        'equipas': { titulo: 'Equipas', subtitulo: 'Criar e gerir equipas de trabalho' },
        'rotas': { titulo: 'Rotas', subtitulo: 'DefiniÃ§Ã£o de rotas e trajetos' },
        'armazens': { titulo: 'ArmazÃ©ns', subtitulo: 'Criar e gerir armazÃ©ns' },
        'agendaarquivo': { titulo: 'Agenda Arquivo', subtitulo: 'HistÃ³rico de agendas' },
        'logs': { titulo: 'Logs / HistÃ³rico', subtitulo: 'Registo de aÃ§Ãµes no sistema' },
        'backup': { titulo: 'Backup', subtitulo: 'SeguranÃ§a e backup de dados' },
        
        // â•â•â•â•â•â•â•â•â•â•â• 2. LOGÃSTICA â•â•â•â•â•â•â•â•â•â•â•
        'cotacoes': { titulo: 'CotaÃ§Ãµes', subtitulo: 'Propostas de preÃ§o para clientes' },
        'reservas': { titulo: 'Reservas', subtitulo: 'ServiÃ§os confirmados' },
        'agenda1': { titulo: 'Agenda 1', subtitulo: 'GestÃ£o de agenda operacional' },
        'agenda2': { titulo: 'Agenda 2', subtitulo: 'GestÃ£o de agenda operacional' },
        'agenda3': { titulo: 'Agenda 3', subtitulo: 'GestÃ£o de agenda operacional' },
        
        // â•â•â•â•â•â•â•â•â•â•â• 3. FINANCEIRO â•â•â•â•â•â•â•â•â•â•â•
        'dashboardfinanceiro': { titulo: 'Dashboard Financeiro', subtitulo: 'Resumo financeiro' },
        'clientes': { titulo: 'Clientes', subtitulo: 'Fichas completas de clientes' },
        'faturas': { titulo: 'Faturas', subtitulo: 'GestÃ£o de faturas emitidas' },
        'prefaturacao': { titulo: 'PrÃ©-FaturaÃ§Ã£o', subtitulo: 'Reservas prontas a faturar' },
        'controlofaturacao': { titulo: 'Controlo de FaturaÃ§Ã£o', subtitulo: 'VerificaÃ§Ã£o de reservas faturadas' },
        'notascredito': { titulo: 'Notas de CrÃ©dito', subtitulo: 'GestÃ£o de notas de crÃ©dito' },
        'recibos': { titulo: 'Recibos', subtitulo: 'GestÃ£o de recibos emitidos' },
        'contascorrentes': { titulo: 'Contas Correntes', subtitulo: 'Saldos e extratos de clientes' },
        
        // â•â•â•â•â•â•â•â•â•â•â• 4. FORNECEDORES â•â•â•â•â•â•â•â•â•â•â•
        'fichasfornecedores': { titulo: 'Fichas Fornecedores', subtitulo: 'Dados e contactos de fornecedores' },
        'compras': { titulo: 'Compras', subtitulo: 'Encomendas e pedidos a fornecedores' },
        'faturasfornecedores': { titulo: 'Faturas Fornecedores', subtitulo: 'Faturas recebidas de fornecedores' },
        'ncfornecedores': { titulo: 'NC Fornecedores', subtitulo: 'Notas de crÃ©dito de fornecedores' },
        'pagamentos': { titulo: 'Pagamentos', subtitulo: 'Registos de pagamentos a fornecedores' },
        'ccfornecedores': { titulo: 'CC Fornecedores', subtitulo: 'Saldos a fornecedores' },
        'fornecedores': { titulo: 'Fornecedores', subtitulo: 'GestÃ£o de fornecedores' },
        
        // â•â•â•â•â•â•â•â•â•â•â• 5. CONTROLO DE CUSTOS â•â•â•â•â•â•â•â•â•â•â•
        'gestaofrota': { titulo: 'GestÃ£o de Frota', subtitulo: 'VisÃ£o geral da frota' },
        'veiculos': { titulo: 'VeÃ­culos', subtitulo: 'Fichas dos veÃ­culos' },
        'motoristas': { titulo: 'Motoristas', subtitulo: 'Custos por motorista' },
        'combustivel': { titulo: 'CombustÃ­vel', subtitulo: 'Registos e anÃ¡lise de consumos' },
        'manutencao': { titulo: 'ManutenÃ§Ã£o', subtitulo: 'Oficina, pneus, revisÃµes' },
        'portagens': { titulo: 'Portagens', subtitulo: 'Via Verde, SCUT' },
        
        // â•â•â•â•â•â•â•â•â•â•â• 6. CONTABILIDADE â•â•â•â•â•â•â•â•â•â•â•
        'dashboardcontabilidade': { titulo: 'Dashboard Contabilidade', subtitulo: 'Resumo contabilÃ­stico' },
        'series': { titulo: 'SÃ©ries de Documentos', subtitulo: 'ConfiguraÃ§Ã£o de numeraÃ§Ã£o' },
        'saft': { titulo: 'SAF-T', subtitulo: 'ExportaÃ§Ã£o fiscal' },
        'relatorios': { titulo: 'RelatÃ³rios', subtitulo: 'BalanÃ§os e mapas' },
        'contabilidade': { titulo: 'Contabilidade', subtitulo: 'ExportaÃ§Ãµes fiscais e relatÃ³rios' },
        
        // â•â•â•â•â•â•â•â•â•â•â• 7. RECURSOS HUMANOS â•â•â•â•â•â•â•â•â•â•â•
        'funcionarios': { titulo: 'FuncionÃ¡rios', subtitulo: 'Fichas pessoais' },
        'contratos': { titulo: 'Contratos', subtitulo: 'Documentos laborais' },
        'salarios': { titulo: 'SalÃ¡rios', subtitulo: 'Processamento de salÃ¡rios' },
        'ferias': { titulo: 'FÃ©rias', subtitulo: 'MarcaÃ§Ãµes e saldos de fÃ©rias' },
        'documentosrh': { titulo: 'Documentos RH', subtitulo: 'CertidÃµes, seguros' },
        'rh': { titulo: 'Recursos Humanos', subtitulo: 'GestÃ£o de funcionÃ¡rios e motoristas' }
      };
      
      const info = titulos[pagina] || { titulo: pagina, subtitulo: '' };
      document.getElementById('pageTitle').textContent = info.titulo;
      document.getElementById('pageSubtitle').textContent = info.subtitulo;
      
      // CONTROLAR BOTÃƒO DO HEADER - esconder em pÃ¡ginas que tÃªm seu prÃ³prio botÃ£o ou nÃ£o precisam
      const btnHeaderNovaFatura = document.getElementById('btnHeaderNovaFatura');
      if (btnHeaderNovaFatura) {
        // Mostrar botÃ£o Nova Fatura apenas em: dashboard, faturas, prefaturacao
        if (['dashboard', 'faturas', 'prefaturacao'].includes(pagina)) {
          btnHeaderNovaFatura.style.display = 'inline-flex';
        } else {
          btnHeaderNovaFatura.style.display = 'none';
        }
      }
      
      // Renderizar conteÃºdo da pÃ¡gina
      if (pagina === 'dashboard') atualizarDashboard();
      if (pagina === 'faturas') renderizarFaturas();
      if (pagina === 'prefaturacao') renderizarPreFaturacao();
      if (pagina === 'controlofaturacao') renderizarControloFaturacao();
      if (pagina === 'recibos') renderizarRecibos();
      if (pagina === 'series') renderizarSeries();
      if (pagina === 'contascorrentes') renderizarContasCorrentes();
      if (pagina === 'notascredito') renderizarNotasCredito();
    }
    
    // FunÃ§Ã£o para limpar todos os filtros ao mudar de pÃ¡gina
    function limparTodosFiltros() {
      // Filtros de Faturas
      const filtroNumero = document.getElementById('filtroNumero');
      const filtroCliente = document.getElementById('filtroCliente');
      const filtroEstado = document.getElementById('filtroEstado');
      const filtroTipoFaturacao = document.getElementById('filtroTipoFaturacao');
      const filtroDataDe = document.getElementById('filtroDataDe');
      const filtroDataAte = document.getElementById('filtroDataAte');
      
      if (filtroNumero) filtroNumero.value = '';
      if (filtroCliente) filtroCliente.value = '';
      if (filtroEstado) filtroEstado.value = '';
      if (filtroTipoFaturacao) filtroTipoFaturacao.value = '';
      if (filtroDataDe) filtroDataDe.value = '';
      if (filtroDataAte) filtroDataAte.value = '';
      
      // Filtros de PrÃ©-FaturaÃ§Ã£o
      const filtroClientePreFat = document.getElementById('filtroClientePreFat');
      if (filtroClientePreFat) filtroClientePreFat.value = '';
      
      // Filtros de Notas de CrÃ©dito
      const filtroNCNumero = document.getElementById('filtroNCNumero');
      const filtroNCCliente = document.getElementById('filtroNCCliente');
      const filtroNCFatura = document.getElementById('filtroNCFatura');
      const filtroNCMotivo = document.getElementById('filtroNCMotivo');
      const filtroNCDataDe = document.getElementById('filtroNCDataDe');
      const filtroNCDataAte = document.getElementById('filtroNCDataAte');
      
      if (filtroNCNumero) filtroNCNumero.value = '';
      if (filtroNCCliente) filtroNCCliente.value = '';
      if (filtroNCFatura) filtroNCFatura.value = '';
      if (filtroNCMotivo) filtroNCMotivo.value = '';
      if (filtroNCDataDe) filtroNCDataDe.value = '';
      if (filtroNCDataAte) filtroNCDataAte.value = '';
    }
    
    // ==================== PESQUISA GLOBAL ====================
    
    let termoPesquisaGlobal = '';
    
    function pesquisarGlobal(termo) {
      termoPesquisaGlobal = termo.toLowerCase().trim();
      
      // Determinar pÃ¡gina atual
      const paginaAtualEl = document.querySelector('section[id^="page-"]:not(.hidden)');
      if (!paginaAtualEl) return;
      
      const paginaAtual = paginaAtualEl.id.replace('page-', '');
      
      console.log('ğŸ” Pesquisa global:', termoPesquisaGlobal, '| PÃ¡gina:', paginaAtual);
      
      // Re-renderizar a pÃ¡gina atual com o filtro aplicado
      switch(paginaAtual) {
        case 'faturas':
          if (termoPesquisaGlobal.length >= 2) {
            pesquisarFaturas(termoPesquisaGlobal);
          } else {
            renderizarFaturas();
          }
          break;
        case 'prefaturacao':
          renderizarPreFaturacao();
          break;
        case 'recibos':
          renderizarRecibos();
          break;
        case 'notascredito':
          renderizarNotasCredito();
          break;
        case 'contascorrentes':
          renderizarContasCorrentes();
          break;
        case 'series':
          renderizarSeries();
          break;
        case 'dashboard':
          // Dashboard nÃ£o precisa de pesquisa
          break;
        case 'configuracoes':
          // ConfiguraÃ§Ãµes nÃ£o precisa de pesquisa
          break;
        default:
          console.log('PÃ¡gina sem suporte a pesquisa global:', paginaAtual);
      }
    }
    
    // Limpar pesquisa global ao mudar de pÃ¡gina
    function limparPesquisaGlobal() {
      const input = document.getElementById('pesquisaGlobal');
      if (input) {
        input.value = '';
      }
      termoPesquisaGlobal = '';
    }
    
    // ==================== FORMATAÃ‡ÃƒO ====================
    
    function formatCurrency(v) {
      return new Intl.NumberFormat('pt-PT', { style: 'currency', currency: 'EUR' }).format(v || 0);
    }
    
    function formatDate(d) {
      if (!d) return '-';
      return new Date(d).toLocaleDateString('pt-PT');
    }
    
    function formatPeso(kg) {
      if (!kg) return '-';
      return new Intl.NumberFormat('pt-PT').format(kg) + ' kg';
    }
    
    function getEstadoBadge(estado) {
      const classes = {
        'Pago': 'badge-success',
        'Pendente': 'badge-warning',
        'Parcial': 'badge-info',
        'Vencido': 'badge-danger'
      };
      return `<span class="badge ${classes[estado] || 'badge-info'}">${estado}</span>`;
    }
    
    function getTipoFaturacaoBadge(tipo) {
      const badges = {
        'automatica': '<span class="badge badge-success">AutomÃ¡tica</span>',
        'manual': '<span class="badge badge-info">Manual</span>',
        'avulso': '<span class="badge badge-purple">Avulso</span>'
      };
      return badges[tipo] || '';
    }
    
    function getEmailBadge(enviado) {
      return enviado 
        ? '<span class="email-enviado" title="Email enviado">âœ…</span>'
        : '<span class="email-pendente" title="Email pendente">â³</span>';
    }
    
    // ==================== DASHBOARD ====================
    
    function atualizarDashboard() {
      const hoje = new Date();
      const mesAtual = hoje.getMonth();
      const anoAtual = hoje.getFullYear();
      
      // Calcular estatÃ­sticas
      const faturasMes = faturas.filter(f => {
        const d = new Date(f.data);
        return d.getMonth() === mesAtual && d.getFullYear() === anoAtual;
      });
      
      const faturadoMes = faturasMes.reduce((s, f) => s + f.total, 0);
      const porReceber = faturas.filter(f => f.estado !== 'Pago').reduce((s, f) => s + (f.total - f.pago), 0);
      const vencido = faturas.filter(f => f.estado === 'Vencido').reduce((s, f) => s + (f.total - f.pago), 0);
      const recebidoMes = recibos.filter(r => {
        const d = new Date(r.data);
        return d.getMonth() === mesAtual && d.getFullYear() === anoAtual;
      }).reduce((s, r) => s + r.valor, 0);
      
      const totalFaturado = faturas.reduce((s, f) => s + f.total, 0);
      const totalPago = faturas.reduce((s, f) => s + f.pago, 0);
      const taxaCobranca = totalFaturado > 0 ? (totalPago / totalFaturado * 100) : 0;
      
      document.getElementById('statFaturadoMes').textContent = formatCurrency(faturadoMes);
      document.getElementById('statPorReceber').textContent = formatCurrency(porReceber);
      document.getElementById('statVencido').textContent = formatCurrency(vencido);
      document.getElementById('statRecebidoMes').textContent = formatCurrency(recebidoMes);
      document.getElementById('statNumFaturas').textContent = faturas.length;
      document.getElementById('statNumNC').textContent = notasCredito.length;
      document.getElementById('statNumRecibos').textContent = recibos.length;
      document.getElementById('statTaxaCobranca').textContent = taxaCobranca.toFixed(1) + '%';
      
      // Alertas de vencimento (5 dias)
      renderizarAlertasVencimento();
      
      // Faturas a vencer
      const aVencer = faturas
        .filter(f => f.estado === 'Pendente' || f.estado === 'Parcial')
        .sort((a, b) => new Date(a.vencimento) - new Date(b.vencimento))
        .slice(0, 5);
      
      document.getElementById('tabelaVencer').innerHTML = aVencer.map(f => {
        const diasVenc = Math.ceil((new Date(f.vencimento) - hoje) / (1000 * 60 * 60 * 24));
        const corDias = diasVenc <= 5 ? 'text-red-600 font-bold' : '';
        return `
          <tr>
            <td class="text-sm font-mono">${f.numero}</td>
            <td class="text-sm">${formatCurrency(f.total - f.pago)}</td>
            <td class="text-sm ${corDias}">${diasVenc}d</td>
          </tr>
        `;
      }).join('') || '<tr><td colspan="3" class="text-center text-slate-500 py-4">Sem faturas pendentes</td></tr>';
      
      // Ãšltimas faturas
      document.getElementById('tabelaUltimasFaturas').innerHTML = faturas.slice(-5).reverse().map(f => `
        <tr>
          <td class="font-mono">${f.numero}</td>
          <td>${formatDate(f.data)}</td>
          <td>${f.cliente}</td>
          <td class="font-semibold">${formatCurrency(f.total)}</td>
          <td>${getEstadoBadge(f.estado)}</td>
          <td>${getEmailBadge(f.emailEnviado)}</td>
          <td>
            <button onclick="verFatura(${f.id})" class="text-emerald-600 hover:underline text-sm">Ver</button>
          </td>
        </tr>
      `).join('') || '<tr><td colspan="7" class="text-center text-slate-500">Sem faturas</td></tr>';
      
      // GrÃ¡fico
      renderizarGrafico();
    }
    
    function renderizarAlertasVencimento() {
      const hoje = new Date();
      hoje.setHours(0, 0, 0, 0);
      
      const alertas = [];
      
      // Faturas a vencer em 5 dias
      faturas.filter(f => f.estado === 'Pendente' || f.estado === 'Parcial').forEach(f => {
        const venc = new Date(f.vencimento);
        const dias = Math.ceil((venc - hoje) / (1000 * 60 * 60 * 24));
        
        if (dias <= 5 && dias > 0) {
          alertas.push({
            tipo: 'aviso',
            texto: `Fatura ${f.numero} (${f.cliente}) vence em ${dias} dia(s) - ${formatCurrency(f.total - f.pago)}`
          });
        } else if (dias <= 0) {
          alertas.push({
            tipo: 'vencido',
            texto: `Fatura ${f.numero} (${f.cliente}) VENCIDA hÃ¡ ${Math.abs(dias)} dia(s) - ${formatCurrency(f.total - f.pago)}`
          });
        }
      });
      
      const container = document.getElementById('alertasVencimento');
      container.innerHTML = alertas.map(a => `
        <div class="alerta-vencimento ${a.tipo === 'vencido' ? 'alerta-vencido' : ''}">
          <strong>${a.tipo === 'vencido' ? 'âš ï¸ VENCIDO' : 'â° Aviso'}:</strong> ${a.texto}
        </div>
      `).join('');
    }
    
    function renderizarGrafico() {
      const ctx = document.getElementById('chartFaturacao');
      if (!ctx) return;
      
      const meses = [];
      const valores = [];
      const recebidos = [];
      
      for (let i = 5; i >= 0; i--) {
        const d = new Date();
        d.setMonth(d.getMonth() - i);
        const mes = d.toLocaleDateString('pt-PT', { month: 'short' });
        meses.push(mes);
        
        const faturasDoMes = faturas.filter(f => {
          const df = new Date(f.data);
          return df.getMonth() === d.getMonth() && df.getFullYear() === d.getFullYear();
        });
        valores.push(faturasDoMes.reduce((s, f) => s + f.total, 0));
        recebidos.push(faturasDoMes.reduce((s, f) => s + f.pago, 0));
      }
      
      if (window.chartInstance) window.chartInstance.destroy();
      
      window.chartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: meses,
          datasets: [
            { label: 'Faturado', data: valores, backgroundColor: 'rgba(16, 185, 129, 0.8)', borderRadius: 6 },
            { label: 'Recebido', data: recebidos, backgroundColor: 'rgba(59, 130, 246, 0.8)', borderRadius: 6 }
          ]
        },
        options: {
          responsive: true,
          plugins: { legend: { position: 'top' } },
          scales: {
            y: { beginAtZero: true, ticks: { callback: v => 'â‚¬' + v.toLocaleString('pt-PT') } }
          }
        }
      });
    }
    
    // ==================== FATURAS ====================
    
    function renderizarFaturas(listaFaturas = null) {
      const tbody = document.getElementById('tabelaFaturas');
      
      // Se nÃ£o for passada uma lista, usar todas as faturas
      let faturasBase = listaFaturas || faturas;
      
      // REGRA: SÃ³ mostrar faturas com dÃ­vida (total > pago), nunca saldo zero
      const faturasParaRenderizar = faturasBase.filter(f => {
        const saldo = (f.total || 0) - (f.pago || 0);
        return saldo > 0; // SÃ³ mostra se tiver dÃ­vida
      });
      
      tbody.innerHTML = faturasParaRenderizar.map(f => {
        const saldoDevido = (f.total || 0) - (f.pago || 0);
        return `
        <tr>
          <td class="font-mono font-semibold">${f.numero}</td>
          <td>${formatDate(f.data)}</td>
          <td>${formatDate(f.vencimento)}</td>
          <td>
            <a href="#" onclick="abrirFichaCliente(${f.clienteId}); return false;" class="text-emerald-700 hover:text-emerald-900 hover:underline font-medium cursor-pointer">
              ${f.cliente}
            </a>
          </td>
          <td>${getTipoFaturacaoBadge(f.tipoFaturacao)}</td>
          <td class="text-right">${formatCurrency(f.subtotal)}</td>
          <td class="text-right">${formatCurrency(f.totalIVA)}</td>
          <td class="text-right font-bold">${formatCurrency(f.total)}</td>
          <td class="text-right">${formatCurrency(f.pago)}</td>
          <td class="text-right font-bold text-red-600">${formatCurrency(saldoDevido)}</td>
          <td>${getEstadoBadge(f.estado)}</td>
          <td>${getEmailBadge(f.emailEnviado)}</td>
          <td>
            <button onclick="verFatura(${f.id})" class="text-blue-600 hover:underline text-sm">Ver</button>
            ${!f.emailEnviado ? `<button onclick="abrirEnviarEmail(${f.id})" class="text-emerald-600 hover:underline text-sm ml-2">Email</button>` : ''}
            <button onclick="imprimirFatura(${f.id})" class="text-slate-600 hover:underline text-sm ml-2">PDF</button>
          </td>
        </tr>
      `}).join('') || '<tr><td colspan="13" class="text-center text-slate-500 py-8">Nenhuma fatura em dÃ­vida</td></tr>';
      
      // Actualizar contador
      const contador = document.getElementById('contadorFaturas');
      if (contador) {
        contador.textContent = `${faturasParaRenderizar.length} fatura(s) em dÃ­vida`;
      }
    }
    
    // FunÃ§Ã£o para abrir a ficha do cliente
    function abrirFichaCliente(clienteId) {
      const cliente = clientes.find(c => c.id == clienteId);
      if (!cliente) {
        alert('Cliente nÃ£o encontrado!');
        return;
      }
      
      // Abrir modal com ficha do cliente
      const modal = document.getElementById('modalFichaCliente');
      if (!modal) {
        // Criar modal se nÃ£o existir
        criarModalFichaCliente();
      }
      
      // Actualizar tÃ­tulo com nome do cliente
      const tituloModal = document.getElementById('fichaClienteTitulo');
      if (tituloModal) {
        tituloModal.innerHTML = 'ğŸ“‹ Ficha de Cliente: <strong>' + cliente.nome + '</strong>';
      }
      
      // Preencher dados do cliente no modal
      preencherFichaCliente(cliente);
      abrirModal('modalFichaCliente');
    }
    
    // â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    // â•‘  ğŸ”’ FUNÃ‡ÃƒO BLOQUEADA - criarModalFichaCliente()                                 â•‘
    // â•‘  Data: 19/12/2024 | VersÃ£o: 3.1                                                 â•‘
    // â•‘  NÃƒO ALTERAR - Modal da ficha de cliente com layout especÃ­fico                  â•‘
    // â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function criarModalFichaCliente() {
      const modalHTML = `
        <div id="modalFichaCliente" class="modal-overlay">
          <div class="modal" style="max-width: 1400px; width: 98%;">
            <div class="modal-header" style="background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); color: white;">
              <h2 id="fichaClienteTitulo">ğŸ“‹ Ficha de Cliente (VisualizaÃ§Ã£o)</h2>
              <button onclick="fecharModal('modalFichaCliente')" class="modal-close" style="color: white; font-size: 28px; background: none; border: none; cursor: pointer;">Ã—</button>
            </div>
            <div class="modal-body" style="max-height: 85vh; overflow-y: auto; padding: 20px; background: #f8fafc;">
              <div id="fichaClienteContent"></div>
            </div>
            <div class="modal-footer" style="background: #f1f5f9; display: flex; justify-content: space-between; align-items: center;">
              <span style="color: #64748b; font-size: 12px;">ğŸ‘ï¸ Modo visualizaÃ§Ã£o - Dados apenas para consulta | Layout replicado do mÃ³dulo GestÃ£o de Clientes</span>
              <button onclick="fecharModal('modalFichaCliente')" class="btn btn-secondary">Fechar</button>
            </div>
          </div>
        </div>
      `;
      document.body.insertAdjacentHTML('beforeend', modalHTML);
    }
    
    // â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    // â•‘  ğŸ”’ FUNÃ‡ÃƒO BLOQUEADA - preencherFichaCliente()                                  â•‘
    // â•‘  Data: 19/12/2024 | VersÃ£o: 3.1                                                 â•‘
    // â•‘  NÃƒO ALTERAR - Replica EXACTAMENTE o layout do mÃ³dulo GestÃ£o de Clientes        â•‘
    // â•‘                                                                                 â•‘
    // â•‘  SECÃ‡Ã•ES (69 campos):                                                           â•‘
    // â•‘  1. IdentificaÃ§Ã£o (7 campos)                                                    â•‘
    // â•‘  2. Moradas - Sede/Filial/FaturaÃ§Ã£o (21 campos + 3 contactos)                   â•‘
    // â•‘  3. ResponsÃ¡veis - 6 tipos (18 campos)                                          â•‘
    // â•‘  4. CondiÃ§Ãµes Comerciais (12 campos)                                            â•‘
    // â•‘  5. Contabilidade e ObservaÃ§Ãµes (9 campos)                                      â•‘
    // â•‘  6. Resumo Financeiro (4 estatÃ­sticas)                                          â•‘
    // â•‘  7. Ãšltimas Faturas (tabela)                                                    â•‘
    // â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function preencherFichaCliente(cliente) {
      const content = document.getElementById('fichaClienteContent');
      if (!content) return;
      
      // Calcular estatÃ­sticas do cliente
      const faturasCliente = faturas.filter(f => f.clienteId == cliente.id);
      const totalFaturado = faturasCliente.reduce((sum, f) => sum + f.total, 0);
      const totalPago = faturasCliente.reduce((sum, f) => sum + (f.pago || 0), 0);
      const totalEmAberto = totalFaturado - totalPago;
      const faturasEmAberto = faturasCliente.filter(f => f.estado !== 'Pago').length;
      
      // Calcular total de Notas de CrÃ©dito
      const ncCliente = notasCredito.filter(nc => nc.clienteId == cliente.id);
      const totalNC = ncCliente.reduce((sum, nc) => sum + nc.total, 0);
      
      // Calcular prazo mÃ©dio de pagamento (em dias)
      let prazoMedioPagamento = 0;
      const faturasPagas = faturasCliente.filter(f => f.estado === 'Pago' && f.dataPagamento);
      if (faturasPagas.length > 0) {
        const somaDias = faturasPagas.reduce((sum, f) => {
          const dataFatura = new Date(f.data);
          const dataPago = new Date(f.dataPagamento);
          const dias = Math.floor((dataPago - dataFatura) / (1000 * 60 * 60 * 24));
          return sum + Math.max(0, dias);
        }, 0);
        prazoMedioPagamento = Math.round(somaDias / faturasPagas.length);
      } else {
        // Se nÃ£o tem faturas pagas com data, calcular mÃ©dia do prazo de pagamento configurado
        prazoMedioPagamento = cliente.diasPagamento || 30;
      }
      
      // Gerar HTML das Ãºltimas faturas
      let faturasHTML = '';
      if (faturasCliente.length > 0) {
        faturasCliente.slice(-5).reverse().forEach(f => {
          const saldo = f.total - (f.pago || 0);
          faturasHTML += '<tr style="background: white; border-bottom: 1px solid #e9ecef;">' +
            '<td style="padding: 10px; font-family: monospace;">' + f.numero + '</td>' +
            '<td style="padding: 10px;">' + formatDate(f.data) + '</td>' +
            '<td style="padding: 10px;">' + formatDate(f.vencimento || f.data) + '</td>' +
            '<td style="padding: 10px; text-align: right; font-weight: 600;">' + formatCurrency(f.total) + '</td>' +
            '<td style="padding: 10px; text-align: right; font-weight: 600; color: ' + (saldo > 0 ? '#dc2626' : '#16a34a') + ';">' + formatCurrency(saldo) + '</td>' +
            '<td style="padding: 10px; text-align: center;">' + getEstadoBadge(f.estado) + '</td>' +
          '</tr>';
        });
      } else {
        faturasHTML = '<tr><td colspan="6" style="padding: 20px; text-align: center; color: #94a3b8;">Sem faturas registadas</td></tr>';
      }
      
      // Determinar tipo de paÃ­s e badge
      let tipoPaisBadge = '';
      let tipoPaisTexto = '';
      if (cliente.tipoCliente === '21111' || cliente.pais === 'Portugal') {
        tipoPaisBadge = '<span style="background:#d4edda;color:#155724;padding:4px 10px;border-radius:12px;font-size:10px;font-weight:600;text-transform:uppercase;">ğŸ‡µğŸ‡¹ NACIONAL</span>';
        tipoPaisTexto = 'Nacional';
      } else if (cliente.tipoCliente === '21112') {
        tipoPaisBadge = '<span style="background:#cce5ff;color:#004085;padding:4px 10px;border-radius:12px;font-size:10px;font-weight:600;text-transform:uppercase;">ğŸ‡ªğŸ‡º EUROPEU</span>';
        tipoPaisTexto = 'Europeu';
      } else if (cliente.tipoCliente === '21113') {
        tipoPaisBadge = '<span style="background:#fff3cd;color:#856404;padding:4px 10px;border-radius:12px;font-size:10px;font-weight:600;text-transform:uppercase;">ğŸŒ TERCEIRO</span>';
        tipoPaisTexto = 'Terceiro';
      }
      
      // Estado badge
      let estadoBadge = '';
      const estado = cliente.estado || 'Ativo';
      if (estado === 'Ativo') {
        estadoBadge = '<span style="background:#d4edda;color:#155724;padding:4px 10px;border-radius:12px;font-size:11px;font-weight:600;">âœ… Ativo</span>';
      } else if (estado === 'Inativo') {
        estadoBadge = '<span style="background:#e9ecef;color:#495057;padding:4px 10px;border-radius:12px;font-size:11px;font-weight:600;">â¸ï¸ Inativo</span>';
      } else if (estado === 'Bloqueado') {
        estadoBadge = '<span style="background:#f8d7da;color:#721c24;padding:4px 10px;border-radius:12px;font-size:11px;font-weight:600;">ğŸ”’ Bloqueado</span>';
      }
      
      const corEmAberto = totalEmAberto > 0 ? 'color:#c0392b;' : 'color:#27ae60;';
      
      // Estilos CSS inline para replicar o layout original
      const sectionStyle = 'background:#f8f9fa;border:2px solid #e9ecef;border-radius:10px;padding:20px;margin-bottom:20px;';
      const sectionTitleStyle = 'color:#1e3c72;font-size:16px;margin-bottom:15px;padding-bottom:8px;border-bottom:3px solid #2980b9;font-weight:600;';
      const labelStyle = 'display:block;margin-bottom:4px;font-weight:600;color:#495057;font-size:11px;';
      const valueStyle = 'padding:8px 10px;border:2px solid #dee2e6;border-radius:6px;font-size:13px;background:#e9ecef;display:block;min-height:36px;';
      const moradaBoxStyle = 'background:white;border:2px solid #e9ecef;border-radius:8px;padding:15px;';
      const moradaTitleStyle = 'color:#1e3c72;font-size:13px;margin-bottom:12px;padding-bottom:6px;border-bottom:2px solid #2980b9;font-weight:600;';
      const respBoxStyle = 'background:white;border:2px solid #e9ecef;border-radius:8px;padding:12px;';
      const respTitleStyle = 'color:#1e3c72;font-size:12px;margin-bottom:10px;padding-bottom:5px;border-bottom:2px solid #2980b9;font-weight:600;';
      
      content.innerHTML = 
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // SECÃ‡ÃƒO 1: IdentificaÃ§Ã£o do Cliente
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        '<section style="' + sectionStyle + '">' +
          '<h2 style="' + sectionTitleStyle + '">ğŸ¢ SecÃ§Ã£o 1 - IdentificaÃ§Ã£o do Cliente</h2>' +
          
          // Linha 1: NÂº Cliente, NIF, Nome, PaÃ­s
          '<div style="display:grid;grid-template-columns:120px 150px 1fr 200px;gap:12px;margin-bottom:12px;">' +
            '<div>' +
              '<label style="' + labelStyle + '">1. NÂº Cliente</label>' +
              '<div style="' + valueStyle + 'font-weight:bold;color:#2980b9;">' + (cliente.numeroCliente || 'C' + String(cliente.id).padStart(4, '0')) + '</div>' +
            '</div>' +
            '<div>' +
              '<label style="' + labelStyle + '">2. NIF</label>' +
              '<div style="' + valueStyle + 'font-family:monospace;">' + (cliente.nif || '-') + '</div>' +
            '</div>' +
            '<div>' +
              '<label style="' + labelStyle + '">3. Nome Completo</label>' +
              '<div style="' + valueStyle + 'font-weight:600;">' + (cliente.nome || '-') + '</div>' +
            '</div>' +
            '<div>' +
              '<label style="' + labelStyle + '">4. PaÃ­s ' + tipoPaisBadge + '</label>' +
              '<div style="' + valueStyle + '">' + (cliente.pais || 'Portugal') + '</div>' +
            '</div>' +
          '</div>' +
          
          // Linha 2: Ficha Abertura, Estado, Saldo em DÃ­vida
          '<div style="display:grid;grid-template-columns:1fr 1fr 200px;gap:12px;">' +
            '<div>' +
              '<label style="' + labelStyle + '">5. Ficha de Abertura</label>' +
              '<div style="' + valueStyle + '">' + (cliente.fichaAbertura || 'Sem ficheiro') + '</div>' +
            '</div>' +
            '<div>' +
              '<label style="' + labelStyle + '">6. Estado</label>' +
              '<div style="padding:8px 10px;border:2px solid #dee2e6;border-radius:6px;background:#fff;">' + estadoBadge + '</div>' +
            '</div>' +
            '<div>' +
              '<label style="' + labelStyle + '">7. Saldo em DÃ­vida</label>' +
              '<div style="' + valueStyle + 'font-weight:bold;font-size:15px;' + corEmAberto + '">' + formatCurrency(totalEmAberto) + '</div>' +
            '</div>' +
          '</div>' +
        '</section>' +
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // SECÃ‡ÃƒO 2: Moradas
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        '<section style="' + sectionStyle + '">' +
          '<h2 style="' + sectionTitleStyle + '">ğŸ“ SecÃ§Ã£o 2 - Moradas</h2>' +
          
          // 3 Colunas: Sede, Filial, FaturaÃ§Ã£o
          '<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:15px;margin-bottom:15px;">' +
            
            // SEDE
            '<div style="' + moradaBoxStyle + '">' +
              '<h4 style="' + moradaTitleStyle + '">ğŸ¢ Sede</h4>' +
              '<div style="display:grid;grid-template-columns:1fr 60px;gap:8px;margin-bottom:8px;">' +
                '<div><label style="' + labelStyle + '">7. Rua</label><div style="' + valueStyle + '">' + (cliente.sedeRua || cliente.morada || '-') + '</div></div>' +
                '<div><label style="' + labelStyle + '">8. Porta</label><div style="' + valueStyle + '">' + (cliente.sedePorta || '-') + '</div></div>' +
              '</div>' +
              '<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px;">' +
                '<div><label style="' + labelStyle + '">9. Lugar</label><div style="' + valueStyle + '">' + (cliente.sedeLugar || '-') + '</div></div>' +
                '<div><label style="' + labelStyle + '">10. Cidade</label><div style="' + valueStyle + '">' + (cliente.sedeCidade || cliente.localidade || '-') + '</div></div>' +
              '</div>' +
              '<div style="display:grid;grid-template-columns:1fr 100px;gap:8px;margin-bottom:8px;">' +
                '<div><label style="' + labelStyle + '">11. Freguesia</label><div style="' + valueStyle + '">' + (cliente.sedeFreguesia || '-') + '</div></div>' +
                '<div><label style="' + labelStyle + '">12. CP</label><div style="' + valueStyle + 'font-family:monospace;">' + (cliente.sedeCP || cliente.codigoPostal || '-') + '</div></div>' +
              '</div>' +
              '<div><label style="' + labelStyle + '">13. Concelho</label><div style="' + valueStyle + '">' + (cliente.sedeConcelho || '-') + '</div></div>' +
            '</div>' +
            
            // FILIAL
            '<div style="' + moradaBoxStyle + '">' +
              '<h4 style="' + moradaTitleStyle + '">ğŸ­ Filial</h4>' +
              '<div style="display:grid;grid-template-columns:1fr 60px;gap:8px;margin-bottom:8px;">' +
                '<div><label style="' + labelStyle + '">14. Rua</label><div style="' + valueStyle + '">' + (cliente.filialRua || '-') + '</div></div>' +
                '<div><label style="' + labelStyle + '">15. Porta</label><div style="' + valueStyle + '">' + (cliente.filialPorta || '-') + '</div></div>' +
              '</div>' +
              '<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px;">' +
                '<div><label style="' + labelStyle + '">16. Lugar</label><div style="' + valueStyle + '">' + (cliente.filialLugar || '-') + '</div></div>' +
                '<div><label style="' + labelStyle + '">17. Cidade</label><div style="' + valueStyle + '">' + (cliente.filialCidade || '-') + '</div></div>' +
              '</div>' +
              '<div style="display:grid;grid-template-columns:1fr 100px;gap:8px;margin-bottom:8px;">' +
                '<div><label style="' + labelStyle + '">18. Freguesia</label><div style="' + valueStyle + '">' + (cliente.filialFreguesia || '-') + '</div></div>' +
                '<div><label style="' + labelStyle + '">19. CP</label><div style="' + valueStyle + 'font-family:monospace;">' + (cliente.filialCP || '-') + '</div></div>' +
              '</div>' +
              '<div><label style="' + labelStyle + '">20. Concelho</label><div style="' + valueStyle + '">' + (cliente.filialConcelho || '-') + '</div></div>' +
            '</div>' +
            
            // FATURAÃ‡ÃƒO
            '<div style="' + moradaBoxStyle + '">' +
              '<h4 style="' + moradaTitleStyle + '">ğŸ“„ FaturaÃ§Ã£o</h4>' +
              '<div style="display:grid;grid-template-columns:1fr 60px;gap:8px;margin-bottom:8px;">' +
                '<div><label style="' + labelStyle + '">21. Rua</label><div style="' + valueStyle + '">' + (cliente.fatRua || cliente.morada || '-') + '</div></div>' +
                '<div><label style="' + labelStyle + '">22. Porta</label><div style="' + valueStyle + '">' + (cliente.fatPorta || '-') + '</div></div>' +
              '</div>' +
              '<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px;">' +
                '<div><label style="' + labelStyle + '">23. Lugar</label><div style="' + valueStyle + '">' + (cliente.fatLugar || '-') + '</div></div>' +
                '<div><label style="' + labelStyle + '">24. Cidade</label><div style="' + valueStyle + '">' + (cliente.fatCidade || cliente.localidade || '-') + '</div></div>' +
              '</div>' +
              '<div style="display:grid;grid-template-columns:1fr 100px;gap:8px;margin-bottom:8px;">' +
                '<div><label style="' + labelStyle + '">25. Freguesia</label><div style="' + valueStyle + '">' + (cliente.fatFreguesia || '-') + '</div></div>' +
                '<div><label style="' + labelStyle + '">26. CP</label><div style="' + valueStyle + 'font-family:monospace;">' + (cliente.fatCP || cliente.codigoPostal || '-') + '</div></div>' +
              '</div>' +
              '<div><label style="' + labelStyle + '">27. Concelho</label><div style="' + valueStyle + '">' + (cliente.fatConcelho || '-') + '</div></div>' +
            '</div>' +
          '</div>' +
          
          // Contactos Gerais
          '<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;">' +
            '<div><label style="' + labelStyle + '">28. Telefone Geral</label><div style="' + valueStyle + '">' + (cliente.telefone || '-') + '</div></div>' +
            '<div><label style="' + labelStyle + '">29. Email Geral</label><div style="' + valueStyle + '">' + (cliente.email || (cliente.emailsGerais ? cliente.emailsGerais.join(', ') : '-')) + '</div></div>' +
            '<div><label style="' + labelStyle + '">30. Fax</label><div style="' + valueStyle + '">' + (cliente.fax || '-') + '</div></div>' +
          '</div>' +
        '</section>' +
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // SECÃ‡ÃƒO 3: ResponsÃ¡veis (6 colunas)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        '<section style="' + sectionStyle + '">' +
          '<h2 style="' + sectionTitleStyle + '">ğŸ‘¤ SecÃ§Ã£o 3 - ResponsÃ¡veis</h2>' +
          '<div style="display:grid;grid-template-columns:repeat(6,1fr);gap:10px;">' +
            
            // Dono/Gerente
            '<div style="' + respBoxStyle + '">' +
              '<h4 style="' + respTitleStyle + '">ğŸ‘” Dono/Gerente</h4>' +
              '<div style="margin-bottom:6px;"><label style="' + labelStyle + '">31. Nome</label><div style="' + valueStyle + 'font-size:11px;">' + (cliente.respDonoNome || '-') + '</div></div>' +
              '<div style="margin-bottom:6px;"><label style="' + labelStyle + '">32. Email</label><div style="' + valueStyle + 'font-size:10px;word-break:break-all;">' + (cliente.respDonoEmail || '-') + '</div></div>' +
              '<div><label style="' + labelStyle + '">33. TelemÃ³vel</label><div style="' + valueStyle + 'font-size:11px;">' + (cliente.respDonoTelemovel || '-') + '</div></div>' +
            '</div>' +
            
            // Contacto
            '<div style="' + respBoxStyle + '">' +
              '<h4 style="' + respTitleStyle + '">ğŸ“ Contacto</h4>' +
              '<div style="margin-bottom:6px;"><label style="' + labelStyle + '">34. Nome</label><div style="' + valueStyle + 'font-size:11px;">' + (cliente.respContactoNome || '-') + '</div></div>' +
              '<div style="margin-bottom:6px;"><label style="' + labelStyle + '">35. Email</label><div style="' + valueStyle + 'font-size:10px;word-break:break-all;">' + (cliente.respContactoEmail || '-') + '</div></div>' +
              '<div><label style="' + labelStyle + '">36. Telefone</label><div style="' + valueStyle + 'font-size:11px;">' + (cliente.respContactoTelefone || '-') + '</div></div>' +
            '</div>' +
            
            // Comercial
            '<div style="' + respBoxStyle + '">' +
              '<h4 style="' + respTitleStyle + '">ğŸ’¼ Comercial</h4>' +
              '<div style="margin-bottom:6px;"><label style="' + labelStyle + '">37. Nome</label><div style="' + valueStyle + 'font-size:11px;">' + (cliente.respComercialNome || '-') + '</div></div>' +
              '<div style="margin-bottom:6px;"><label style="' + labelStyle + '">38. Email</label><div style="' + valueStyle + 'font-size:10px;word-break:break-all;">' + (cliente.respComercialEmail || '-') + '</div></div>' +
              '<div><label style="' + labelStyle + '">39. Telefone</label><div style="' + valueStyle + 'font-size:11px;">' + (cliente.respComercialTelefone || '-') + '</div></div>' +
            '</div>' +
            
            // Contabilidade
            '<div style="' + respBoxStyle + '">' +
              '<h4 style="' + respTitleStyle + '">ğŸ“Š Contabilidade</h4>' +
              '<div style="margin-bottom:6px;"><label style="' + labelStyle + '">40. Nome</label><div style="' + valueStyle + 'font-size:11px;">' + (cliente.respContabilidadeNome || '-') + '</div></div>' +
              '<div style="margin-bottom:6px;"><label style="' + labelStyle + '">41. Email</label><div style="' + valueStyle + 'font-size:10px;word-break:break-all;">' + (cliente.respContabilidadeEmail || (cliente.emailsContabilidade ? cliente.emailsContabilidade[0] : '-')) + '</div></div>' +
              '<div><label style="' + labelStyle + '">42. Telefone</label><div style="' + valueStyle + 'font-size:11px;">' + (cliente.respContabilidadeTelefone || '-') + '</div></div>' +
            '</div>' +
            
            // Financeiro
            '<div style="' + respBoxStyle + '">' +
              '<h4 style="' + respTitleStyle + '">ğŸ’° Financeiro</h4>' +
              '<div style="margin-bottom:6px;"><label style="' + labelStyle + '">43. Nome</label><div style="' + valueStyle + 'font-size:11px;">' + (cliente.respFinanceiroNome || '-') + '</div></div>' +
              '<div style="margin-bottom:6px;"><label style="' + labelStyle + '">44. Email</label><div style="' + valueStyle + 'font-size:10px;word-break:break-all;">' + (cliente.respFinanceiroEmail || cliente.emailFinanceiro || '-') + '</div></div>' +
              '<div><label style="' + labelStyle + '">45. Telefone</label><div style="' + valueStyle + 'font-size:11px;">' + (cliente.respFinanceiroTelefone || '-') + '</div></div>' +
            '</div>' +
            
            // LogÃ­stica
            '<div style="' + respBoxStyle + '">' +
              '<h4 style="' + respTitleStyle + '">ğŸšš LogÃ­stica</h4>' +
              '<div style="margin-bottom:6px;"><label style="' + labelStyle + '">46. Nome</label><div style="' + valueStyle + 'font-size:11px;">' + (cliente.respLogisticaNome || '-') + '</div></div>' +
              '<div style="margin-bottom:6px;"><label style="' + labelStyle + '">47. Email</label><div style="' + valueStyle + 'font-size:10px;word-break:break-all;">' + (cliente.respLogisticaEmail || cliente.emailLogistica || '-') + '</div></div>' +
              '<div><label style="' + labelStyle + '">48. Telefone</label><div style="' + valueStyle + 'font-size:11px;">' + (cliente.respLogisticaTelefone || '-') + '</div></div>' +
            '</div>' +
          '</div>' +
        '</section>' +
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // SECÃ‡ÃƒO 4: CondiÃ§Ãµes Comerciais
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        '<section style="' + sectionStyle + '">' +
          '<h2 style="' + sectionTitleStyle + '">ğŸ’¼ SecÃ§Ã£o 4 - CondiÃ§Ãµes Comerciais</h2>' +
          
          // Linha 1
          '<div style="display:grid;grid-template-columns:120px 150px 100px 120px 120px 80px 100px 1fr;gap:10px;margin-bottom:12px;">' +
            '<div><label style="' + labelStyle + '">49. Plafonds (â‚¬)</label><div style="' + valueStyle + 'font-weight:bold;">' + formatCurrency(cliente.plafond || 0) + '</div></div>' +
            '<div><label style="' + labelStyle + '">50. Pessoa que Atribui</label><div style="' + valueStyle + '">' + (cliente.quemAtribuiPlafonds || '-') + '</div></div>' +
            '<div><label style="' + labelStyle + '">51. Prazo (dias)</label><div style="' + valueStyle + 'text-align:center;font-weight:bold;">' + (cliente.prazoPagamento || 30) + '</div></div>' +
            '<div><label style="' + labelStyle + '">52. Modo Fat.</label><div style="' + valueStyle + '">' + (cliente.modoFaturacao || 'Manual') + '</div></div>' +
            '<div><label style="' + labelStyle + '">53. Fat. Mensal (â‚¬)</label><div style="' + valueStyle + '">' + formatCurrency(cliente.faturacaoMensalPrevista || 0) + '</div></div>' +
            '<div><label style="' + labelStyle + '">54. Desc. (%)</label><div style="' + valueStyle + 'text-align:center;">' + (cliente.desconto || 0) + '%</div></div>' +
            '<div><label style="' + labelStyle + '">55. Desc. Fatura</label><div style="' + valueStyle + '">' + (cliente.descontoNaFatura || 'NÃ£o') + '</div></div>' +
            '<div><label style="' + labelStyle + '">56. NÂº Conta Banco</label><div style="' + valueStyle + 'font-family:monospace;font-size:11px;">' + (cliente.iban || '-') + '</div></div>' +
          '</div>' +
          
          // Linha 2
          '<div style="display:grid;grid-template-columns:150px 1fr 100px 1fr;gap:10px;">' +
            '<div><label style="' + labelStyle + '">57. Angariador</label><div style="' + valueStyle + '">' + (cliente.angariador || '-') + '</div></div>' +
            '<div><label style="' + labelStyle + '">58. Anexos Seguro</label><div style="' + valueStyle + '">' + (cliente.anexosSeguro || 'Sem anexos') + '</div></div>' +
            '<div><label style="' + labelStyle + '">59. Aceita PP</label><div style="' + valueStyle + 'text-align:center;">' + (cliente.aceitaPP ? 'âœ… Sim' : 'âŒ NÃ£o') + '</div></div>' +
            '<div><label style="' + labelStyle + '">60. IncidÃªncias</label><div style="' + valueStyle + '">' + (cliente.incidencias || '-') + '</div></div>' +
          '</div>' +
        '</section>' +
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // SECÃ‡ÃƒO 5: Contabilidade e ObservaÃ§Ãµes
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        '<section style="' + sectionStyle + '">' +
          '<h2 style="' + sectionTitleStyle + '">ğŸ“Š SecÃ§Ã£o 5 - Contabilidade e ObservaÃ§Ãµes</h2>' +
          
          // Linha 1
          '<div style="display:grid;grid-template-columns:120px 120px 120px 120px 150px 120px 120px;gap:10px;margin-bottom:12px;">' +
            '<div><label style="' + labelStyle + '">61. Conta Contab. 1</label><div style="' + valueStyle + 'font-family:monospace;">' + (cliente.contaContab1 || '-') + '</div></div>' +
            '<div><label style="' + labelStyle + '">62. Conta Contab. 2</label><div style="' + valueStyle + 'font-family:monospace;">' + (cliente.contaContab2 || '-') + '</div></div>' +
            '<div><label style="' + labelStyle + '">63. Conta Contab. 3</label><div style="' + valueStyle + 'font-family:monospace;">' + (cliente.contaContab3 || '-') + '</div></div>' +
            '<div><label style="' + labelStyle + '">64. Conta Contab. 4</label><div style="' + valueStyle + 'font-family:monospace;">' + (cliente.contaContab4 || '-') + '</div></div>' +
            '<div><label style="' + labelStyle + '">65. Conta SAP</label><div style="' + valueStyle + 'font-weight:bold;color:#27ae60;font-family:monospace;">' + (cliente.contaSAP || '-') + '</div></div>' +
            '<div><label style="' + labelStyle + '">66. Val. Fat. Ano</label><div style="' + valueStyle + 'font-weight:bold;color:#27ae60;">' + formatCurrency(totalFaturado) + '</div></div>' +
            '<div><label style="' + labelStyle + '">67. Cliente Login</label><div style="' + valueStyle + 'text-align:center;">' + (cliente.clienteComLogin ? 'ğŸ” Ativo' : 'âŒ NÃ£o') + '</div></div>' +
          '</div>' +
          
          // Linha 2
          '<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">' +
            '<div><label style="' + labelStyle + '">68. ObservaÃ§Ãµes</label><div style="' + valueStyle + 'min-height:60px;white-space:pre-wrap;">' + (cliente.observacoes || '-') + '</div></div>' +
            '<div><label style="' + labelStyle + '">69. Anexos Gerais</label><div style="' + valueStyle + 'min-height:60px;">' + (cliente.anexosGerais || 'Sem anexos') + '</div></div>' +
          '</div>' +
          
          '<div style="background:#e8f5e9;border:1px solid #c8e6c9;border-radius:6px;padding:8px 12px;font-size:11px;color:#2e7d32;margin-top:15px;">ğŸ”— Todos os dados sÃ£o sincronizados com o mÃ³dulo GestÃ£o de Clientes</div>' +
        '</section>' +
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // SECÃ‡ÃƒO 6: Resumo Financeiro (EstatÃ­sticas)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        '<section style="background:linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);border:2px solid #a7f3d0;border-radius:10px;padding:20px;margin-bottom:20px;">' +
          '<h2 style="color:#065f46;font-size:16px;margin-bottom:15px;padding-bottom:8px;border-bottom:3px solid #10b981;font-weight:600;">ğŸ“ˆ Resumo Financeiro</h2>' +
          '<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:15px;text-align:center;margin-bottom:15px;">' +
            '<div style="background:white;padding:15px;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,0.05);">' +
              '<div style="font-size:28px;font-weight:bold;color:#475569;">' + faturasCliente.length + '</div>' +
              '<div style="font-size:10px;color:#64748b;text-transform:uppercase;letter-spacing:0.5px;">Total Faturas</div>' +
            '</div>' +
            '<div style="background:white;padding:15px;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,0.05);">' +
              '<div style="font-size:28px;font-weight:bold;color:#059669;">' + formatCurrency(totalFaturado) + '</div>' +
              '<div style="font-size:10px;color:#64748b;text-transform:uppercase;letter-spacing:0.5px;">Total Faturado</div>' +
            '</div>' +
            '<div style="background:white;padding:15px;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,0.05);">' +
              '<div style="font-size:28px;font-weight:bold;color:#2563eb;">' + formatCurrency(totalPago) + '</div>' +
              '<div style="font-size:10px;color:#64748b;text-transform:uppercase;letter-spacing:0.5px;">Total Pago</div>' +
            '</div>' +
          '</div>' +
          '<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:15px;text-align:center;">' +
            '<div style="background:white;padding:15px;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,0.05);">' +
              '<div style="font-size:28px;font-weight:bold;' + corEmAberto + '">' + formatCurrency(totalEmAberto) + '</div>' +
              '<div style="font-size:10px;color:#64748b;text-transform:uppercase;letter-spacing:0.5px;">Em Aberto (' + faturasEmAberto + ')</div>' +
            '</div>' +
            '<div style="background:white;padding:15px;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,0.05);border:2px solid #fecaca;">' +
              '<div style="font-size:28px;font-weight:bold;color:#dc2626;">-' + formatCurrency(totalNC) + '</div>' +
              '<div style="font-size:10px;color:#dc2626;text-transform:uppercase;letter-spacing:0.5px;">Notas CrÃ©dito (' + ncCliente.length + ')</div>' +
            '</div>' +
            '<div style="background:white;padding:15px;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,0.05);">' +
              '<div style="font-size:28px;font-weight:bold;color:#7c3aed;">' + prazoMedioPagamento + ' dias</div>' +
              '<div style="font-size:10px;color:#64748b;text-transform:uppercase;letter-spacing:0.5px;">Prazo MÃ©dio Pag.</div>' +
            '</div>' +
          '</div>' +
        '</section>' +
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // SECÃ‡ÃƒO 7: Ãšltimas Faturas
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        '<section style="' + sectionStyle + '">' +
          '<h2 style="' + sectionTitleStyle + '">ğŸ“„ Ãšltimas Faturas</h2>' +
          '<div style="border:1px solid #dee2e6;border-radius:8px;overflow:hidden;">' +
            '<table style="width:100%;border-collapse:collapse;font-size:13px;">' +
              '<thead style="background:linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);color:white;">' +
                '<tr>' +
                  '<th style="padding:12px;text-align:left;font-weight:600;font-size:11px;text-transform:uppercase;">NÃºmero</th>' +
                  '<th style="padding:12px;text-align:left;font-weight:600;font-size:11px;text-transform:uppercase;">Data</th>' +
                  '<th style="padding:12px;text-align:left;font-weight:600;font-size:11px;text-transform:uppercase;">Vencimento</th>' +
                  '<th style="padding:12px;text-align:right;font-weight:600;font-size:11px;text-transform:uppercase;">Total</th>' +
                  '<th style="padding:12px;text-align:right;font-weight:600;font-size:11px;text-transform:uppercase;">Saldo</th>' +
                  '<th style="padding:12px;text-align:center;font-weight:600;font-size:11px;text-transform:uppercase;">Estado</th>' +
                '</tr>' +
              '</thead>' +
              '<tbody>' + faturasHTML + '</tbody>' +
            '</table>' +
          '</div>' +
        '</section>';
    }
    
    let linhaCount = 0;
    let clienteSelecionado = null;
    
    function abrirNovaFatura() {
      document.getElementById('modalFaturaTitulo').textContent = 'ğŸ“„ Nova Fatura';
      document.getElementById('faturaId').value = '';
      document.getElementById('faturaTipo').value = 'avulso';
      
      // Reset radio buttons
      document.querySelectorAll('input[name="tipoFaturacao"]').forEach(r => r.checked = r.value === 'avulso');
      
      // PrÃ³ximo nÃºmero
      const serieFT = series.find(s => s.serie === 'FT');
      const proxNum = serieFT ? serieFT.proxNum : 1;
      const anoFT = serieFT ? serieFT.ano : new Date().getFullYear();
      document.getElementById('faturaNumero').value = `FT ${anoFT}/${proxNum}`;
      
      // Datas
      const hoje = new Date().toISOString().split('T')[0];
      document.getElementById('faturaData').value = hoje;
      
      // Carregar clientes
      const selectCliente = document.getElementById('faturaCliente');
      selectCliente.innerHTML = '<option value="">-- Selecione o Cliente --</option>';
      if (Array.isArray(clientes)) {
        clientes.forEach(c => {
          selectCliente.innerHTML += `<option value="${c.id}">${c.nome || c.nome_completo || 'Cliente ' + c.id}</option>`;
        });
      }
      
      // Limpar campos
      document.getElementById('faturaNIF').value = '';
      document.getElementById('faturaMorada').value = '';
      document.getElementById('faturaTipoCliente').value = '';
      document.getElementById('faturaVencimento').value = '';
      document.getElementById('faturaCondicoes').value = '';
      document.getElementById('faturaObs').value = '';
      
      // Limpar linhas
      linhaCount = 0;
      document.getElementById('linhasFatura').innerHTML = '';
      adicionarLinhaFatura();
      
      atualizarTotaisFatura();
      abrirModal('modalFatura');
    }
    
    function preencherDadosCliente() {
      const clienteId = document.getElementById('faturaCliente').value;
      const cliente = clientes.find(c => c.id == clienteId);
      clienteSelecionado = cliente;
      
      if (cliente) {
        document.getElementById('faturaNIF').value = cliente.nif || '';
        document.getElementById('faturaMorada').value = `${cliente.morada}, ${cliente.localidade}` || '';
        
        const tiposCliente = { '21111': 'Nacional', '21112': 'Europeu (IC)', '21113': 'Fora UE' };
        document.getElementById('faturaTipoCliente').value = tiposCliente[cliente.tipoCliente] || '';
        
        // Calcular vencimento baseado no prazo do cliente
        const hoje = new Date();
        const venc = new Date(hoje);
        venc.setDate(venc.getDate() + (cliente.prazoPagamento || 30));
        document.getElementById('faturaVencimento').value = venc.toISOString().split('T')[0];
        document.getElementById('faturaCondicoes').value = `${cliente.prazoPagamento || 30} dias`;
        
        // Atualizar cÃ³digos IVA nas linhas existentes
        atualizarIVALinhas();
      }
    }
    
    function mudarTipoFaturacao(tipo) {
      document.getElementById('faturaTipo').value = tipo;
      // Aqui poderia mostrar/esconder campos especÃ­ficos para cada tipo
    }
    
    function adicionarLinhaFatura() {
      const maxLinhas = 30;
      const linhasAtuais = document.querySelectorAll('#linhasFatura .excel-row').length;
      
      if (linhasAtuais >= maxLinhas) {
        alert(`MÃ¡ximo de ${maxLinhas} linhas por fatura!`);
        return;
      }
      
      linhaCount++;
      const div = document.createElement('div');
      div.className = 'excel-row';
      div.id = `linha-${linhaCount}`;
      div.innerHTML = `
        <input type="text" class="excel-cell" placeholder="NÂº Reserva" data-field="cmr">
        <input type="text" class="excel-cell" placeholder="Local carga" data-field="localCarga" onchange="atualizarIVALinha(${linhaCount})">
        <input type="text" class="excel-cell" placeholder="Local descarga" data-field="localDescarga" onchange="atualizarIVALinha(${linhaCount})">
        <input type="text" class="excel-cell" placeholder="DescriÃ§Ã£o" data-field="descricao" value="Transporte mercadoria">
        <input type="text" class="excel-cell" placeholder="Ref. cliente" data-field="refCliente">
        <input type="text" class="excel-cell text-center" placeholder="LDM" data-field="ldm">
        <input type="number" class="excel-cell text-center" placeholder="Bultos" data-field="numBultos">
        <input type="number" class="excel-cell text-right" placeholder="Peso" data-field="peso" onchange="verificarCamposPesoValor(${linhaCount})">
        <input type="number" class="excel-cell text-right" step="0.01" placeholder="â‚¬/TON" data-field="precoTon" onchange="calcularValorLinha(${linhaCount})">
        <input type="number" class="excel-cell text-right font-semibold" step="0.01" placeholder="Valor â‚¬" data-field="valor" onchange="atualizarTotaisFatura()">
        <select class="excel-cell text-xs" data-field="codigoIVA" onchange="atualizarTotaisFatura()">
          <option value="23">23%</option>
          <option value="6">6%</option>
          <option value="0">0%</option>
        </select>
        <button type="button" onclick="removerLinha(${linhaCount})" class="text-red-500 hover:text-red-700 text-lg">âœ–</button>
      `;
      document.getElementById('linhasFatura').appendChild(div);
      
      // Configurar navegaÃ§Ã£o tipo Excel
      configurarNavegacaoExcel(div);
      
      atualizarContadorLinhas();
      
      // Se jÃ¡ tem cliente selecionado, atualizar IVA
      if (clienteSelecionado) {
        atualizarIVALinha(linhaCount);
      }
    }
    
    // CORREÃ‡ÃƒO v6.22: Verificar e configurar campos Peso/â‚¬TON/Valor
    // REGRA: Peso Ã© INDICATIVO, nÃ£o obriga â‚¬/TON
    // Se Peso + â‚¬/TON preenchidos â†’ calcula valor automaticamente
    // Se sÃ³ Peso preenchido â†’ valor Ã© editÃ¡vel (peso Ã© sÃ³ informaÃ§Ã£o)
    function verificarCamposPesoValor(linhaId) {
      const linha = document.getElementById(`linha-${linhaId}`);
      if (!linha) return;
      
      const pesoInput = linha.querySelector('[data-field="peso"]');
      const precoTonInput = linha.querySelector('[data-field="precoTon"]');
      const valorInput = linha.querySelector('[data-field="valor"]');
      
      const peso = parseFloat(pesoInput.value) || 0;
      const precoTon = parseFloat(precoTonInput.value) || 0;
      
      // NOVA LÃ“GICA: Peso Ã© indicativo, valor Ã© sempre editÃ¡vel
      // SÃ³ calcula automaticamente se AMBOS peso e â‚¬/TON estiverem preenchidos
      if (peso > 0 && precoTon > 0) {
        // Ambos preenchidos: calcular automaticamente mas permitir ediÃ§Ã£o
        precoTonInput.style.background = '#d1fae5'; // Verde claro
        valorInput.style.background = '#d1fae5'; // Verde claro = calculado
        valorInput.readOnly = false; // Permitir ajuste manual
        calcularValorLinha(linhaId);
      } else {
        // Peso Ã© sÃ³ indicativo OU estÃ¡ vazio
        precoTonInput.required = false;
        precoTonInput.style.background = '';
        precoTonInput.placeholder = 'â‚¬/TON';
        valorInput.readOnly = false;
        valorInput.style.background = '#fef9c3'; // Amarelo = editÃ¡vel
        valorInput.placeholder = 'Valor â‚¬';
      }
      
      atualizarTotaisFatura();
    }
    
    function configurarNavegacaoExcel(container) {
      const inputs = container.querySelectorAll('input, select');
      
      inputs.forEach((input, index) => {
        input.addEventListener('keydown', (e) => {
          const allInputs = document.querySelectorAll('#linhasFatura input, #linhasFatura select');
          const currentIndex = Array.from(allInputs).indexOf(input);
          
          switch(e.key) {
            case 'Enter':
            case 'Tab':
              e.preventDefault();
              const nextInput = allInputs[currentIndex + 1];
              if (nextInput) nextInput.focus();
              break;
            case 'ArrowDown':
              e.preventDefault();
              const inputsPerRow = 9;
              const downInput = allInputs[currentIndex + inputsPerRow];
              if (downInput) downInput.focus();
              break;
            case 'ArrowUp':
              e.preventDefault();
              const upInput = allInputs[currentIndex - 9];
              if (upInput) upInput.focus();
              break;
            case 'ArrowRight':
              if (input.selectionStart === input.value.length) {
                e.preventDefault();
                const rightInput = allInputs[currentIndex + 1];
                if (rightInput) rightInput.focus();
              }
              break;
            case 'ArrowLeft':
              if (input.selectionStart === 0) {
                e.preventDefault();
                const leftInput = allInputs[currentIndex - 1];
                if (leftInput) leftInput.focus();
              }
              break;
          }
        });
      });
    }
    
    function removerLinha(id) {
      const el = document.getElementById(`linha-${id}`);
      if (el) {
        el.remove();
        atualizarContadorLinhas();
        atualizarTotaisFatura();
      }
    }
    
    function atualizarContadorLinhas() {
      const count = document.querySelectorAll('#linhasFatura .excel-row').length;
      document.getElementById('contadorLinhas').textContent = `${count}/30 linhas`;
    }
    
    function calcularValorLinha(linhaId) {
      const linha = document.getElementById(`linha-${linhaId}`);
      if (!linha) return;
      
      const peso = parseFloat(linha.querySelector('[data-field="peso"]').value) || 0;
      const precoTon = parseFloat(linha.querySelector('[data-field="precoTon"]').value) || 0;
      const valorInput = linha.querySelector('[data-field="valor"]');
      const precoTonInput = linha.querySelector('[data-field="precoTon"]');
      
      if (peso > 0) {
        // MODO: Peso Ã— â‚¬/TON (valor calculado automaticamente)
        const pesoTon = peso / 1000;
        const valor = pesoTon * precoTon;
        
        valorInput.value = valor > 0 ? valor.toFixed(2) : '';
        valorInput.readOnly = true;
        valorInput.style.background = '#f1f5f9'; // Cinza (readonly)
        
        // â‚¬/TON obrigatÃ³rio quando hÃ¡ peso
        precoTonInput.style.background = precoTon > 0 ? '#fff' : '#fef9c3'; // Amarelo se vazio
      } else {
        // MODO: LDM + Valor Fixo (valor editÃ¡vel manualmente)
        valorInput.readOnly = false;
        valorInput.style.background = valorInput.value ? '#fff' : '#fef9c3'; // Amarelo se vazio
        
        // â‚¬/TON nÃ£o obrigatÃ³rio quando nÃ£o hÃ¡ peso
        precoTonInput.style.background = '#fff';
      }
      
      atualizarTotaisFatura();
    }
    
    function atualizarIVALinha(linhaId) {
      const linha = document.getElementById(`linha-${linhaId}`);
      if (!linha) return;
      
      const localCarga = linha.querySelector('[data-field="localCarga"]').value;
      const localDescarga = linha.querySelector('[data-field="localDescarga"]').value;
      
      // Obter tipoCliente do cliente selecionado, ou usar '21111' (PT) por defeito
      const tipoCliente = clienteSelecionado?.tipoCliente || '21111';
      
      // Obter regra IVA baseada nos locais
      const regra = obterRegraIVA(tipoCliente, 'Normal', localCarga, localDescarga);
      
      // Atualizar select de IVA
      const selectIVA = linha.querySelector('[data-field="codigoIVA"]');
      const taxaPercent = Math.round(regra.taxa * 100);
      selectIVA.value = taxaPercent.toString();
      
      console.log(`ğŸ”„ Linha ${linhaId}: ${localCarga} â†’ ${localDescarga} = ${taxaPercent}% IVA`);
      
      atualizarTotaisFatura();
    }
    
    function atualizarIVALinhas() {
      document.querySelectorAll('#linhasFatura .excel-row').forEach(linha => {
        const id = linha.id.replace('linha-', '');
        atualizarIVALinha(id);
      });
    }
    
    function atualizarTotaisFatura() {
      let subtotal = 0;
      let iva23 = 0;
      let iva6 = 0;
      let iva0 = 0;
      
      document.querySelectorAll('#linhasFatura .excel-row').forEach(linha => {
        const valorInput = linha.querySelector('[data-field="valor"]');
        // Ler valor numÃ©rico directamente (jÃ¡ nÃ£o tem formataÃ§Ã£o)
        const valor = parseFloat(valorInput.value) || 0;
        const taxaIVA = parseInt(linha.querySelector('[data-field="codigoIVA"]').value) || 0;
        
        subtotal += valor;
        
        if (taxaIVA === 23) iva23 += valor * 0.23;
        else if (taxaIVA === 6) iva6 += valor * 0.06;
        // IVA 0% nÃ£o adiciona nada
      });
      
      const totalIVA = iva23 + iva6;
      const total = subtotal + totalIVA;
      
      document.getElementById('faturaSubtotal').textContent = formatCurrency(subtotal);
      document.getElementById('faturaTotal').textContent = formatCurrency(total);
      
      // Mostrar/esconder linhas de IVA
      document.getElementById('linhaIVA23').style.display = iva23 > 0 ? 'flex' : 'none';
      document.getElementById('faturaIVA23').textContent = formatCurrency(iva23);
      
      document.getElementById('linhaIVA6').style.display = iva6 > 0 ? 'flex' : 'none';
      document.getElementById('faturaIVA6').textContent = formatCurrency(iva6);
      
      document.getElementById('linhaIVA0').style.display = iva0 > 0 || (subtotal > 0 && totalIVA === 0) ? 'flex' : 'none';
      document.getElementById('faturaIVA0').textContent = formatCurrency(0);
    }
    
    function emitirFatura() {
      const clienteId = document.getElementById('faturaCliente').value;
      if (!clienteId) {
        alert('Selecione um cliente!');
        return;
      }
      
      // Verificar se a sÃ©rie FT estÃ¡ ativa
      if (!verificarSerieAtiva('FT')) {
        return;
      }
      
      // Procurar cliente em mÃºltiplas fontes
      let cliente = clientes.find(c => c.id == clienteId);
      
      // Se nÃ£o encontrou, tentar em clientesLista
      if (!cliente && typeof clientesLista !== 'undefined') {
        const clienteTemp = clientesLista.find(c => c.id == clienteId || c.numero == clienteId);
        if (clienteTemp) {
          cliente = {
            id: clienteTemp.id,
            nome: clienteTemp.nome_completo || clienteTemp.nome,
            nif: clienteTemp.contribuinte || '',
            morada: clienteTemp.sede_rua || '',
            localidade: clienteTemp.sede_cidade || '',
            tipoCliente: clienteTemp.tipo_cliente || '21111'
          };
        }
      }
      
      // Se ainda nÃ£o encontrou, criar cliente temporÃ¡rio com dados do formulÃ¡rio
      if (!cliente) {
        const selectCliente = document.getElementById('faturaCliente');
        cliente = {
          id: clienteId,
          nome: selectCliente.options[selectCliente.selectedIndex]?.text || 'Cliente',
          nif: document.getElementById('faturaNIF')?.value || '',
          morada: document.getElementById('faturaMorada')?.value || '',
          localidade: '',
          tipoCliente: '21111' // Default: Cliente PortuguÃªs
        };
        console.warn('âš ï¸ Cliente nÃ£o encontrado, usando dados do formulÃ¡rio');
      }
      
      // Garantir que tipoCliente existe
      if (!cliente.tipoCliente) {
        cliente.tipoCliente = '21111';
      }
      
      const linhas = [];
      let subtotal = 0;
      let iva23 = 0, iva6 = 0, iva0 = 0;
      
      document.querySelectorAll('#linhasFatura .excel-row').forEach(linha => {
        const cmr = linha.querySelector('[data-field="cmr"]').value;
        const localCarga = linha.querySelector('[data-field="localCarga"]').value;
        const localDescarga = linha.querySelector('[data-field="localDescarga"]').value;
        const descricao = linha.querySelector('[data-field="descricao"]')?.value || 'Transporte mercadoria';
        const refCliente = linha.querySelector('[data-field="refCliente"]').value;
        const ldm = linha.querySelector('[data-field="ldm"]').value;
        const numBultos = linha.querySelector('[data-field="numBultos"]')?.value || '';
        const peso = parseFloat(linha.querySelector('[data-field="peso"]').value) || 0;
        const precoTon = parseFloat(linha.querySelector('[data-field="precoTon"]').value) || 0;
        const valorInput = parseFloat(linha.querySelector('[data-field="valor"]').value) || 0;
        const taxaIVA = parseInt(linha.querySelector('[data-field="codigoIVA"]').value) || 0;
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // CORREÃ‡ÃƒO v6.22: Nova lÃ³gica de valor
        // - Peso Ã© INDICATIVO (informativo), nÃ£o obriga â‚¬/TON
        // - Se peso E â‚¬/TON preenchidos â†’ calcula automaticamente
        // - Se sÃ³ valor preenchido â†’ usa valor direto (regra principal)
        // - Peso pode estar preenchido E usar valor direto (peso Ã© sÃ³ informaÃ§Ã£o)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        let valor = 0;
        
        if (peso > 0 && precoTon > 0) {
          // Ambos preenchidos: calcular valor automaticamente
          const pesoTon = peso / 1000;
          valor = pesoTon * precoTon;
        } else if (valorInput > 0) {
          // Valor direto preenchido: usar esse valor (peso Ã© sÃ³ indicativo)
          valor = valorInput;
        } else if (cmr) {
          // Tem CMR mas nÃ£o tem valor - avisar
          alert('O campo Valor Ã© obrigatÃ³rio para cada linha!');
          return;
        }
        
        if (valor > 0 || cmr) {
          // Incluir novos campos para layout A4
          linhas.push({ 
            cmr, 
            localCarga, 
            localDescarga, 
            descricao,
            refCliente, 
            ldm,
            numBultos, 
            peso, 
            precoTon, 
            valor, 
            taxaIVA,
            empresaCarga: '',
            empresaDescarga: ''
          });
          subtotal += valor;
          
          if (taxaIVA === 23) iva23 += valor * 0.23;
          else if (taxaIVA === 6) iva6 += valor * 0.06;
        }
      });
      
      if (linhas.length === 0) {
        alert('Adicione pelo menos uma linha Ã  fatura!');
        return;
      }
      
      // Obter artigo de isenÃ§Ã£o se aplicÃ¡vel
      const regra = obterRegraIVA(cliente.tipoCliente, 'Normal', linhas[0].localCarga, linhas[0].localDescarga);
      
      const serieFT = series.find(s => s.serie === 'FT');
      const numero = `FT ${serieFT.ano}/${serieFT.proxNum}`;
      serieFT.proxNum++;
      
      const totalIVA = iva23 + iva6;
      const total = subtotal + totalIVA;
      
      const novaFatura = {
        id: Date.now(),
        numero,
        data: document.getElementById('faturaData').value,
        vencimento: document.getElementById('faturaVencimento').value,
        clienteId: parseInt(clienteId),
        cliente: cliente.nome || 'Cliente',
        nif: cliente.nif || '',
        morada: [cliente.morada, cliente.localidade].filter(x => x).join(', ') || '',
        tipoCliente: cliente.tipoCliente || '21111',
        tipoFaturacao: document.getElementById('faturaTipo').value,
        linhas,
        subtotal,
        iva23, iva6, iva0: subtotal - (subtotal * (iva23 > 0 ? 0.23 : 0) + subtotal * (iva6 > 0 ? 0.06 : 0)),
        totalIVA,
        total,
        pago: 0,
        estado: 'Pendente',
        obs: document.getElementById('faturaObs').value,
        artigoIsencao: regra.artigo || '',
        motivoIsencao: regra.motivo || '',
        contaRazao: regra.contaRazao || '',
        contaIVA: regra.contaIVA || '',
        emailEnviado: false,
        dataCriacao: new Date().toISOString()
      };
      
      faturas.push(novaFatura);
      
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // CORREÃ‡ÃƒO v6.14: Marcar reservas como faturadas e atualizar TODOS os campos
      // O nÃºmero da fatura deve aparecer no campo verde da reserva (SecÃ§Ã£o 1)
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      const reservasParaMarcar = document.getElementById('faturaId').dataset.reservas;
      let reservasComCMRDescarga = []; // Guardar reservas que jÃ¡ tÃªm CMR de Descarga
      
      if (reservasParaMarcar) {
        const idsReservas = JSON.parse(reservasParaMarcar);
        idsReservas.forEach(id => {
          // Atualizar na variÃ¡vel global reservas
          const reserva = reservas.find(r => r.id === id);
          if (reserva) {
            reserva.faturada = true;
            reserva.faturaNumero = numero;
            reserva.numero_fatura = numero;  // Compatibilidade com formulÃ¡rio
            reserva.dataFaturacao = new Date().toISOString();
            reserva.faturaId = novaFatura.id; // ReferÃªncia Ã  fatura
            
            // Verificar se jÃ¡ tem CMR de Descarga
            if (reserva.cmrDescarga || reserva.cmr_descarga) {
              reservasComCMRDescarga.push(reserva);
            }
            
            console.log(`âœ… Reserva ${reserva.numero || id} marcada como faturada: ${numero}`);
          }
          
          // Atualizar tambÃ©m nas reservas normais (localStorage erpReservas)
          try {
            let reservasNormais = JSON.parse(localStorage.getItem('erpReservas') || '[]');
            const idxNormal = reservasNormais.findIndex(r => r.id === id);
            if (idxNormal !== -1) {
              reservasNormais[idxNormal].faturada = true;
              reservasNormais[idxNormal].faturaNumero = numero;
              reservasNormais[idxNormal].numero_fatura = numero;
              reservasNormais[idxNormal].dataFaturacao = new Date().toISOString();
              reservasNormais[idxNormal].faturaId = novaFatura.id;
              localStorage.setItem('erpReservas', JSON.stringify(reservasNormais));
            }
          } catch (e) {
            console.warn('Erro ao atualizar reservas normais:', e);
          }
        });
        // Limpar a referÃªncia
        document.getElementById('faturaId').dataset.reservas = '';
      }
      
      // Limpar seleÃ§Ã£o da prÃ©-faturaÃ§Ã£o
      reservasSelecionadas = [];
      
      guardarDados();
      fecharModal('modalFatura');
      renderizarFaturas();
      atualizarDashboard();
      
      // Atualizar Controlo de FaturaÃ§Ã£o se estiver visÃ­vel
      if (document.getElementById('page-controlofaturacao') && 
          !document.getElementById('page-controlofaturacao').classList.contains('hidden')) {
        renderizarControloFaturacao();
      }
      
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // REGRA v6.23: ENVIO AUTOMÃTICO DE EMAILS
      // CORREÃ‡ÃƒO: SÃ³ envia email quando TODAS as reservas da fatura tÃªm CMR de Descarga
      // Se a fatura tem 2 reservas, sÃ³ envia quando as 2 tiverem CMR de descarga
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      
      // Obter todas as reservas desta fatura
      const reservasDaFatura = [];
      const idsReservasStr = document.getElementById('faturaId').dataset.reservas;
      if (idsReservasStr) {
        try {
          const idsReservas = JSON.parse(idsReservasStr);
          idsReservas.forEach(id => {
            const res = reservas.find(r => r.id === id);
            if (res) reservasDaFatura.push(res);
          });
        } catch (e) {}
      }
      
      // TambÃ©m verificar pelas linhas da fatura
      if (reservasDaFatura.length === 0 && novaFatura.linhas) {
        novaFatura.linhas.forEach(linha => {
          if (linha.cmr) {
            const res = reservas.find(r => r.numero === linha.cmr || r.id === linha.reservaId);
            if (res && !reservasDaFatura.find(rf => rf.id === res.id)) {
              reservasDaFatura.push(res);
            }
          }
        });
      }
      
      // Verificar se TODAS as reservas tÃªm CMR de Descarga
      const totalReservas = reservasDaFatura.length || novaFatura.linhas?.length || 0;
      const reservasComCMR = reservasDaFatura.filter(r => 
        r.cmrDescargaAnexado === true || 
        (r.cmrDescarga && r.cmrDescarga.includes('.')) ||
        (r.cmr_descarga && r.cmr_descarga.includes('.'))
      );
      
      const todasTemCMR = totalReservas > 0 && reservasComCMR.length === totalReservas;
      
      console.log(`ğŸ“Š Fatura ${numero}: ${reservasComCMR.length}/${totalReservas} reservas com CMR Descarga`);
      
      if (todasTemCMR) {
        // TODAS as reservas tÃªm CMR de Descarga â†’ ENVIAR EMAILS AUTOMATICAMENTE
        console.log(`ğŸ“§ TODAS as ${totalReservas} reserva(s) tÃªm CMR Descarga - enviando emails...`);
        
        // Usar a primeira reserva para obter o cliente (todas sÃ£o do mesmo cliente)
        const reservaRef = reservasComCMR[0];
        
        // Guardar referÃªncia de todas as reservas na fatura para anexar todos os CMRs
        novaFatura.reservasIds = reservasDaFatura.map(r => r.id);
        
        // Enviar emails automaticamente
        enviarEmailsFaturaCompleta(novaFatura, reservaRef, cliente);
        
        alert(`âœ… Fatura ${numero} emitida com sucesso!\n\n` +
              `Total: ${formatCurrency(total)}\n\n` +
              `ğŸ“§ EMAILS ENVIADOS AUTOMATICAMENTE\n` +
              `(Todas as ${totalReservas} reserva(s) tÃªm CMR de Descarga)`);
              
      } else if (reservasComCMR.length > 0) {
        // Algumas reservas tÃªm CMR, mas nÃ£o todas
        const faltam = totalReservas - reservasComCMR.length;
        alert(`âœ… Fatura ${numero} emitida com sucesso!\n\n` +
              `Total: ${formatCurrency(total)}\n\n` +
              `â³ AGUARDANDO ${faltam} CMR(s) DE DESCARGA\n` +
              `A fatura serÃ¡ enviada automaticamente quando todos os CMRs chegarem.\n` +
              `(${reservasComCMR.length}/${totalReservas} CMRs recebidos)`);
      } else {
        // Nenhuma reserva tem CMR de Descarga â†’ emails serÃ£o enviados quando CMR chegar
        alert(`âœ… Fatura ${numero} emitida com sucesso!\n\n` +
              `Total: ${formatCurrency(total)}\n\n` +
              `ğŸ“‹ A fatura serÃ¡ enviada automaticamente quando todos os CMRs de Descarga chegarem.`);
      }
    }
    
    // âš ï¸ REGRA: Esta funÃ§Ã£o DEVE usar gerarPreviewFatura() - NÃƒO criar layout alternativo
    function verFatura(id) {
      const f = faturas.find(x => x.id == id);
      if (!f) return;
      
      // OBRIGATÃ“RIO: Usar funÃ§Ã£o centralizada para layout consistente
      gerarPreviewFatura(f);
      abrirModal('modalPreviewFatura');
    }
    
    /* â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
       â•‘                                                                              â•‘
       â•‘   âš ï¸  FUNÃ‡ÃƒO BLOQUEADA - NÃƒO ALTERAR ESTRUTURA HTML âš ï¸                       â•‘
       â•‘                                                                              â•‘
       â•‘   FUNÃ‡ÃƒO: gerarPreviewDocumento(doc, tipoDocumento)                          â•‘
       â•‘   VERSÃƒO: 3.1 - Actualizado em 19/12/2024                                    â•‘
       â•‘                                                                              â•‘
       â•‘   DESCRIÃ‡ÃƒO:                                                                 â•‘
       â•‘   FunÃ§Ã£o ÃšNICA e CENTRALIZADA para gerar o layout de TODOS os documentos.   â•‘
       â•‘   Todos os tipos (FT, NC, RC, ND, PF, DF) usam este mesmo layout.            â•‘
       â•‘                                                                              â•‘
       â•‘   TIPOS SUPORTADOS:                                                          â•‘
       â•‘   â€¢ FT - Fatura                                                              â•‘
       â•‘   â€¢ NC - Nota de CrÃ©dito                                                     â•‘
       â•‘   â€¢ ND - Nota de DÃ©bito                                                      â•‘
       â•‘   â€¢ RC - Recibo                                                              â•‘
       â•‘   â€¢ PF - Pagamento a Fornecedor                                              â•‘
       â•‘   â€¢ DF - DÃ©bito a Fornecedor                                                 â•‘
       â•‘                                                                              â•‘
       â•‘   REGRAS:                                                                    â•‘
       â•‘   â€¢ TODOS os documentos DEVEM usar esta funÃ§Ã£o                               â•‘
       â•‘   â€¢ NÃƒO criar funÃ§Ãµes alternativas para gerar documentos                     â•‘
       â•‘   â€¢ NÃƒO duplicar este cÃ³digo em outros locais                                â•‘
       â•‘   â€¢ Qualquer alteraÃ§Ã£o pode afetar a impressÃ£o e validade fiscal             â•‘
       â•‘                                                                              â•‘
       â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    function gerarPreviewDocumento(doc, tipoDocumento = 'FT') {
      // âš ï¸ LAYOUT BLOQUEADO - VersÃ£o 3.1 FINAL
      const container = document.getElementById('previewFaturaContent');
      
      // Obter configuraÃ§Ã£o do tipo de documento
      const configDoc = TIPOS_DOCUMENTO[tipoDocumento] || TIPOS_DOCUMENTO['FT'];
      
      // Obter dados do cliente/fornecedor completos
      // CORREÃ‡ÃƒO v6.16: Procurar cliente por ID ou por nÃºmero, e usar dados do documento se nÃ£o encontrar
      let cliente = clientes.find(c => c.id === doc.clienteId);
      
      // Se nÃ£o encontrou por ID, tentar por nÃºmero
      if (!cliente && doc.clienteId) {
        cliente = clientes.find(c => c.numeroCliente === doc.clienteId || c.numero === doc.clienteId);
      }
      
      // Tentar tambÃ©m no clientesLista (mÃ³dulo Clientes)
      if (!cliente && typeof clientesLista !== 'undefined') {
        cliente = clientesLista.find(c => 
          c.numero === doc.clienteId || 
          c.numero === doc.clienteNumero ||
          c.nome_completo === doc.cliente ||
          c.nome_completo === doc.clienteNome
        );
      }
      
      // Obter nÃºmero do cliente - usar do documento se disponÃ­vel
      const numCliente = doc.clienteNumero || 
                        cliente?.numero || 
                        cliente?.numeroCliente || 
                        ('C' + (cliente?.id || doc.clienteId || ''));
      
      // Obter NIF - usar do documento se disponÃ­vel
      const nifCliente = doc.nif || doc.clienteNIF || cliente?.contribuinte || cliente?.nif || '-';
      
      // Obter morada - usar do documento se disponÃ­vel
      const moradaCliente = doc.morada || doc.clienteMorada || '';
      
      // Obter vencimento - usar do documento
      const vencimentoDoc = doc.vencimento || doc.dataVencimento || '';
      
      // Calcular prazo de pagamento (se aplicÃ¡vel)
      const diasPrazo = doc.vencimento ? Math.ceil((new Date(doc.vencimento) - new Date(doc.data)) / (1000*60*60*24)) : 30;
      
      // Determinar tipo de cÃ³pia (ORIGINAL, DUPLICADO, etc.)
      const tipoCopia = doc.copia || 'ORIGINAL';
      
      // Determinar label do destinatÃ¡rio baseado no tipo de documento
      let labelDestinatario = 'Faturar a';
      if (tipoDocumento === 'NC' || tipoDocumento === 'ND') labelDestinatario = 'Cliente';
      if (tipoDocumento === 'RC') labelDestinatario = 'Recebemos de';
      if (tipoDocumento === 'PF' || tipoDocumento === 'DF') labelDestinatario = 'Fornecedor';
      
      // Gerar linhas da tabela (se aplicÃ¡vel)
      let linhasHTML = '';
      let linhasVaziasHTML = '';
      
      if (configDoc.mostrarLinhasServico && doc.linhas && doc.linhas.length > 0) {
        linhasHTML = doc.linhas.map((l, idx) => {
          const taxaIVADisplay = l.taxaIVA === 0 ? '0%' : l.taxaIVA + '%';
          // CORREÃ‡ÃƒO v6.22: Formatar nÃºmero da reserva (remover "RES-" porque jÃ¡ estÃ¡ no cabeÃ§alho)
          let numReserva = l.cmr || l.reservaNum || l.referencia || '-';
          if (numReserva.startsWith('RES-')) {
            numReserva = numReserva.substring(4); // Remove "RES-"
          }
          return `
            <tr>
              <td>${numReserva}</td>
              <td class="morada-cell">
                <div class="empresa">${l.empresaCarga || ''}</div>
                <div class="endereco">${l.localCarga || '-'}</div>
              </td>
              <td class="morada-cell">
                <div class="empresa">${l.empresaDescarga || ''}</div>
                <div class="endereco">${l.localDescarga || '-'}</div>
              </td>
              <td>${l.descricao || 'Transporte mercadoria'}</td>
              <td>${l.refCliente || '-'}</td>
              <td class="text-center">${l.ldm || '-'}</td>
              <td class="text-center">${l.numBultos || '-'}</td>
              <td class="text-right">${formatPeso(l.peso)}</td>
              <td class="text-right">${l.precoTon ? l.precoTon.toFixed(2) : '-'}</td>
              <td class="text-right valor">${formatCurrency(l.valor)}</td>
              <td class="text-center">${taxaIVADisplay}</td>
            </tr>
          `;
        }).join('');
        
        // Gerar linhas vazias
        const linhasVazias = Math.max(0, 3 - doc.linhas.length);
        for (let i = 0; i < linhasVazias; i++) {
          linhasVaziasHTML += '<tr style="height: 20px;"><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>';
        }
      }
      
      // Tabela para Recibos (layout com barra verde e colunas especÃ­ficas)
      let tabelaRecibo = '';
      if (tipoDocumento === 'RC') {
        // Obter dados do cliente
        const clienteRecibo = clientes.find(c => c.id === doc.clienteId);
        const numCliente = clienteRecibo?.numeroCliente || ('C' + (doc.clienteId || ''));
        const nifCliente = clienteRecibo?.nif || doc.nif || '-';
        
        // Calcular total
        let totalRecibo = doc.total || doc.valor || 0;
        
        // Gerar linhas da tabela (uma por fatura)
        let linhasRecibo = '';
        
        if (doc.detalhesFaturas && doc.detalhesFaturas.length > 0) {
          // Tem detalhes por fatura
          doc.detalhesFaturas.forEach(d => {
            linhasRecibo += `
              <tr>
                <td style="padding: 8px 6px; border: 1px solid #e2e8f0;">${numCliente}</td>
                <td style="padding: 8px 6px; border: 1px solid #e2e8f0;">${nifCliente}</td>
                <td style="padding: 8px 6px; border: 1px solid #e2e8f0; text-align: center;">${doc.metodo || 'TRANSFERÃŠNCIA'}</td>
                <td style="padding: 8px 6px; border: 1px solid #e2e8f0; font-family: monospace;">${d.faturaNumero}</td>
                <td style="padding: 8px 6px; border: 1px solid #e2e8f0; text-align: right;">${formatCurrency(d.valorFatura - d.valorAnteriorPago)}</td>
                <td style="padding: 8px 6px; border: 1px solid #e2e8f0; text-align: right;">${formatCurrency(d.valorRecebido)}</td>
                <td style="padding: 8px 6px; border: 1px solid #e2e8f0; text-align: right; font-weight: 500;"></td>
              </tr>
            `;
          });
        } else if (doc.faturas && doc.faturas.length > 0) {
          // Sem detalhes, usar array de faturas simples
          doc.faturas.forEach(faturaNum => {
            linhasRecibo += `
              <tr>
                <td style="padding: 8px 6px; border: 1px solid #e2e8f0;">${numCliente}</td>
                <td style="padding: 8px 6px; border: 1px solid #e2e8f0;">${nifCliente}</td>
                <td style="padding: 8px 6px; border: 1px solid #e2e8f0; text-align: center;">${doc.metodo || 'TRANSFERÃŠNCIA'}</td>
                <td style="padding: 8px 6px; border: 1px solid #e2e8f0; font-family: monospace;">${faturaNum}</td>
                <td style="padding: 8px 6px; border: 1px solid #e2e8f0; text-align: right;">${formatCurrency(doc.valorDocumento || totalRecibo)}</td>
                <td style="padding: 8px 6px; border: 1px solid #e2e8f0; text-align: right;">${formatCurrency(totalRecibo)}</td>
                <td style="padding: 8px 6px; border: 1px solid #e2e8f0; text-align: right; font-weight: 500;"></td>
              </tr>
            `;
          });
        } else {
          // Linha Ãºnica
          linhasRecibo = `
            <tr>
              <td style="padding: 8px 6px; border: 1px solid #e2e8f0;">${numCliente}</td>
              <td style="padding: 8px 6px; border: 1px solid #e2e8f0;">${nifCliente}</td>
              <td style="padding: 8px 6px; border: 1px solid #e2e8f0; text-align: center;">${doc.metodo || 'TRANSFERÃŠNCIA'}</td>
              <td style="padding: 8px 6px; border: 1px solid #e2e8f0; font-family: monospace;">${doc.faturaRef || '-'}</td>
              <td style="padding: 8px 6px; border: 1px solid #e2e8f0; text-align: right;">${formatCurrency(doc.valorDocumento || totalRecibo)}</td>
              <td style="padding: 8px 6px; border: 1px solid #e2e8f0; text-align: right;">${formatCurrency(totalRecibo)}</td>
              <td style="padding: 8px 6px; border: 1px solid #e2e8f0; text-align: right; font-weight: 500;"></td>
            </tr>
          `;
        }
        
        tabelaRecibo = `
          <div style="margin-bottom: 5mm;">
            <table style="width: 100%; border-collapse: collapse; font-size: 9pt;">
              <thead>
                <tr style="background: #065f46 !important; background-color: #065f46 !important; -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; color: white !important;">
                  <th style="padding: 8px 6px; text-align: left; font-weight: 600; border: 1px solid #065f46; background: #065f46 !important; color: white !important;">NÂº CLIENTE</th>
                  <th style="padding: 8px 6px; text-align: left; font-weight: 600; border: 1px solid #065f46; background: #065f46 !important; color: white !important;">CONTRIBUINTE</th>
                  <th style="padding: 8px 6px; text-align: center; font-weight: 600; border: 1px solid #065f46; background: #065f46 !important; color: white !important;">MÃ‰TODO DE PAGAMENTO</th>
                  <th style="padding: 8px 6px; text-align: left; font-weight: 600; border: 1px solid #065f46; background: #065f46 !important; color: white !important;">DOCUMENTO</th>
                  <th style="padding: 8px 6px; text-align: right; font-weight: 600; border: 1px solid #065f46; background: #065f46 !important; color: white !important;">VALOR DO DOCUMENTO</th>
                  <th style="padding: 8px 6px; text-align: right; font-weight: 600; border: 1px solid #065f46; background: #065f46 !important; color: white !important;">VALOR PAGO</th>
                  <th style="padding: 8px 6px; text-align: right; font-weight: 600; border: 1px solid #065f46; background: #065f46 !important; color: white !important;">VALOR</th>
                </tr>
              </thead>
              <tbody>
                ${linhasRecibo}
              </tbody>
              <tfoot>
                <tr style="background: #f8fafc;">
                  <td colspan="6" style="padding: 10px 6px; border: 1px solid #e2e8f0; text-align: right; font-weight: 700;">TOTAL</td>
                  <td style="padding: 10px 6px; border: 1px solid #e2e8f0; text-align: right; font-weight: 700; font-size: 11pt; color: #065f46;">${formatCurrency(totalRecibo)}</td>
                </tr>
              </tfoot>
            </table>
            
            <!-- Conta Destino - Caixa Verde Alface -->
            ${doc.contaDestino ? `
            <div style="margin-top: 8px; padding: 10px 15px; background: #dcfce7; border: 1px solid #86efac; border-radius: 4px; -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important;">
              <span style="font-weight: 600; color: #166534; font-size: 9pt;">CONTA DESTINO: ${doc.contaDestino.toUpperCase()}</span>
            </div>
            ` : ''}
          </div>
        `;
      }
      
      // Tabela para Pagamentos a Fornecedor
      let tabelaPagamento = '';
      if ((tipoDocumento === 'PF' || tipoDocumento === 'DF') && doc.documentoRef) {
        tabelaPagamento = `
          <div style="padding: 15px; background: #f8fafc; border-radius: 8px; margin-bottom: 10mm;">
            <table style="width: 100%; border-collapse: collapse;">
              <tr style="background: #065f46; color: white;">
                <th style="padding: 10px; text-align: left;">Documento ReferÃªncia</th>
                <th style="padding: 10px; text-align: left;">DescriÃ§Ã£o</th>
                <th style="padding: 10px; text-align: right;">Valor</th>
              </tr>
              <tr>
                <td style="padding: 10px; border-bottom: 1px solid #e2e8f0;">${doc.documentoRef}</td>
                <td style="padding: 10px; border-bottom: 1px solid #e2e8f0;">${doc.descricao || '-'}</td>
                <td style="padding: 10px; border-bottom: 1px solid #e2e8f0; text-align: right; font-weight: bold;">${formatCurrency(doc.total)}</td>
              </tr>
            </table>
          </div>
        `;
      }
      
      // Tabela para Notas de CrÃ©dito - removida (info jÃ¡ estÃ¡ na barra verde)
      let tabelaNC = '';
      
      // Gerar QR Code data (formato AT) - se aplicÃ¡vel
      const qrData = configDoc.mostrarQRCode ? 
        `A:${empresaConfig.nif.replace('PT', '')}*B:${doc.nif}*C:${cliente?.pais || 'PT'}*D:${configDoc.tipoQR}*E:N*F:${doc.data.replace(/-/g, '')}*G:${doc.numero}*H:XXXXXXXX-1*I1:PT*I7:${(doc.subtotal || doc.total).toFixed(2)}*I8:${(doc.totalIVA || 0).toFixed(2)}*N:${(doc.totalIVA || 0).toFixed(2)}*O:${doc.total.toFixed(2)}*Q:XXXX*R:0000` 
        : '';
      
      // SecÃ§Ã£o de referÃªncia (para NC, mostra fatura original)
      let referenciaHTML = '';
      if (tipoDocumento === 'NC' && doc.faturaOriginal) {
        referenciaHTML = `
          <div style="background: #fef3c7; border-left: 3px solid #f59e0b; padding: 8px 12px; margin-bottom: 3mm; font-size: 9pt;">
            <strong>ReferÃªncia:</strong> ${doc.faturaOriginal} ${doc.motivoNC ? '- ' + doc.motivoNC : ''}
          </div>
        `;
      }
      
      container.innerHTML = `
        <div class="fatura-a4" id="faturaParaImprimir">
          
          <!-- CABEÃ‡ALHO -->
          <div class="fatura-cabecalho">
            <div class="empresa-dados">
              <div class="empresa-logo">
                <div class="barras">
                  <div class="barra barra-verde"></div>
                  <div class="barra barra-laranja"></div>
                  <div class="barra barra-azul"></div>
                </div>
                <span class="nome">emeutrans</span>
              </div>
              <p>${empresaConfig.morada}</p>
              <p>${empresaConfig.localidade}</p>
              <p>Telefone: ${empresaConfig.telefone || '+351 220 000 000'}</p>
              <p>Contribuinte: ${empresaConfig.nif}</p>
              <p>Email: ${empresaConfig.email || 'geral@emeutrans.pt'}</p>
            </div>
            
            <div class="fatura-numero-box">
              <div class="fatura-titulo-a4" style="color: ${configDoc.corTitulo}">${configDoc.nome}</div>
              ${tipoDocumento === 'RC' ? `<div style="font-size: 10pt; color: #64748b; margin-bottom: 3px;">Data: ${formatDate(doc.data)}</div>` : ''}
              <div class="fatura-numero-a4">${doc.numero}</div>
              <div class="fatura-copia">${tipoCopia}</div>
            </div>
          </div>
          
          ${referenciaHTML}
          
          <!-- CAIXA CLIENTE/FORNECEDOR -->
          <div class="cliente-box">
            <div class="cliente-box-titulo">${labelDestinatario}</div>
            <div class="cliente-nome">${doc.cliente || doc.clienteNome || doc.fornecedor || ''}</div>
            <div class="cliente-morada">${moradaCliente}</div>
          </div>
          
          <!-- LINHA INFO -->
          ${tipoDocumento === 'NC' ? `
          <table class="tabela-nc-info">
            <thead>
              <tr>
                <th style="width: 25%">NÂº FATURA(S)</th>
                <th style="width: 20%">NÂº RESERVA(S)</th>
                <th style="width: 25%">MOTIVO</th>
                <th style="width: 15%">VALOR</th>
                <th style="width: 15%">IVA</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>${doc.faturaRef || '-'}</td>
                <td>${doc.reservasRef || '-'}</td>
                <td>${doc.motivo || '-'}</td>
                <td>${formatCurrency(doc.subtotal)}</td>
                <td>${doc.taxaIVA}% (${formatCurrency(doc.iva || 0)})</td>
              </tr>
            </tbody>
          </table>
          ` : tipoDocumento === 'RC' ? `
          ${tabelaRecibo}
          ` : `
          <div class="info-linha">
            <div class="info-item">
              <div class="info-item-label">NÂº ${tipoDocumento === 'PF' || tipoDocumento === 'DF' ? 'Fornecedor' : 'Cliente'}</div>
              <div class="info-item-valor">${numCliente}</div>
            </div>
            <div class="info-item">
              <div class="info-item-label">Contribuinte</div>
              <div class="info-item-valor">${nifCliente}</div>
            </div>
            <div class="info-item">
              <div class="info-item-label">Data EmissÃ£o</div>
              <div class="info-item-valor">${formatDate(doc.data)}</div>
            </div>
            <div class="info-item">
              <div class="info-item-label">Data Vencimento</div>
              <div class="info-item-valor">${formatDate(vencimentoDoc)}</div>
            </div>
          </div>
          `}
          
          <!-- CONTEÃšDO PRINCIPAL -->
          <div class="tabela-container">
            ${configDoc.mostrarLinhasServico ? `
            <table class="fatura-tabela-a4">
              <thead style="background: #065f46 !important; background-color: #065f46 !important; -webkit-print-color-adjust: exact !important;">
                <tr style="background: #065f46 !important; background-color: #065f46 !important;">
                  <th style="width: 12%; background: #065f46 !important; background-color: #065f46 !important; color: white !important;">Reserva/<br>CMR</th>
                  <th style="width: 13%; background: #065f46 !important; background-color: #065f46 !important; color: white !important;">Local de Carga</th>
                  <th style="width: 13%; background: #065f46 !important; background-color: #065f46 !important; color: white !important;">Local de Descarga</th>
                  <th style="width: 10%; background: #065f46 !important; background-color: #065f46 !important; color: white !important;">DescriÃ§Ã£o</th>
                  <th style="width: 8%; background: #065f46 !important; background-color: #065f46 !important; color: white !important;">Ref.<br>Cliente</th>
                  <th style="width: 5%; background: #065f46 !important; background-color: #065f46 !important; color: white !important;" class="text-center">LDM</th>
                  <th style="width: 5%; background: #065f46 !important; background-color: #065f46 !important; color: white !important;" class="text-center">NÂº<br>Bultos</th>
                  <th style="width: 7%; background: #065f46 !important; background-color: #065f46 !important; color: white !important;" class="text-right">Peso<br>(kg)</th>
                  <th style="width: 6%; background: #065f46 !important; background-color: #065f46 !important; color: white !important;" class="text-right">â‚¬/TON</th>
                  <th style="width: 10%; background: #065f46 !important; background-color: #065f46 !important; color: white !important;" class="text-right">Valor</th>
                  <th style="width: 6%; background: #065f46 !important; background-color: #065f46 !important; color: white !important;" class="text-center">CÃ³d.<br>IVA</th>
                </tr>
              </thead>
              <tbody>
                ${linhasHTML}
                ${linhasVaziasHTML}
              </tbody>
            </table>
            ` : ''}
            ${tipoDocumento === 'RC' ? '' : tabelaRecibo}
            ${tabelaPagamento}
            ${tabelaNC}
          </div>
          
          <!-- SECÃ‡ÃƒO INFERIOR -->
          <div class="fatura-inferior">
            <div class="inferior-row">
              <!-- COLUNA ESQUERDA -->
              <div class="coluna-esquerda">
                <div class="observacoes-box">
                  <div class="observacoes-titulo">ObservaÃ§Ãµes</div>
                  <div class="observacoes-texto">${doc.obs || (tipoDocumento === 'RC' ? 'Pagamento recebido. Obrigado.' : 'Transporte internacional de mercadorias. Pagamento a ' + diasPrazo + ' dias.')}</div>
                </div>
                ${configDoc.mostrarIBAN ? `
                <div class="dados-bancarios">
                  <div class="dados-bancarios-titulo">Dados para Pagamento</div>
                  <div class="dados-bancarios-iban">IBAN: ${empresaConfig.iban}</div>
                </div>
                ` : ''}
              </div>
              
              <!-- COLUNA DIREITA -->
              <div class="coluna-direita">
                <div class="totais-box-a4">
                  <div class="totais-linha-a4">
                    <span class="totais-linha-label">Subtotal</span>
                    <span class="totais-linha-valor">${formatCurrency(doc.subtotal || doc.total)}</span>
                  </div>
                  <div class="totais-linha-a4">
                    <span class="totais-linha-label">Base TributÃ¡vel</span>
                    <span class="totais-linha-valor">${formatCurrency(doc.subtotal || (doc.total - (doc.iva || 0)))}</span>
                  </div>
                  ${(doc.iva23 && doc.iva23 > 0) ? `
                  <div class="totais-linha-a4">
                    <span class="totais-linha-label">IVA (23%)</span>
                    <span class="totais-linha-valor">${formatCurrency(doc.iva23)}</span>
                  </div>` : ''}
                  ${(doc.iva13 && doc.iva13 > 0) ? `
                  <div class="totais-linha-a4">
                    <span class="totais-linha-label">IVA (13%)</span>
                    <span class="totais-linha-valor">${formatCurrency(doc.iva13)}</span>
                  </div>` : ''}
                  ${(doc.iva6 && doc.iva6 > 0) ? `
                  <div class="totais-linha-a4">
                    <span class="totais-linha-label">IVA (6%)</span>
                    <span class="totais-linha-valor">${formatCurrency(doc.iva6)}</span>
                  </div>` : ''}
                  ${(doc.iva && doc.iva > 0 && !doc.iva23 && !doc.iva6 && !doc.iva13) ? `
                  <div class="totais-linha-a4">
                    <span class="totais-linha-label">IVA (${doc.taxaIVA || 23}%)</span>
                    <span class="totais-linha-valor">${formatCurrency(doc.iva)}</span>
                  </div>` : ''}
                  ${(doc.taxaIVA === 0 || doc.iva === 0 || (doc.iva0 && doc.iva0 > 0)) ? `
                  <div class="totais-linha-a4">
                    <span class="totais-linha-label">IVA (0% Isento)</span>
                    <span class="totais-linha-valor">0,00 â‚¬</span>
                  </div>` : ''}
                </div>
                <div class="total-box-final" style="background: ${configDoc.corTitulo}">
                  <span class="totais-linha-label">TOTAL</span>
                  <span class="totais-linha-valor">${formatCurrency(doc.total)}</span>
                </div>
              </div>
            </div>
            
            ${(doc.taxaIVA === 0 || doc.totalIVA === 0) && doc.artigoIsencao ? `
            <div class="isencao-box">
              <div><strong>Motivo de IsenÃ§Ã£o de IVA:</strong> ${doc.artigoIsencao}${doc.motivoIsencao ? ' - ' + doc.motivoIsencao : ''}</div>
            </div>` : ''}
            
            <!-- QR CODE -->
            ${configDoc.mostrarQRCode ? `
            <div class="qr-section">
              <div class="qr-box">
                <div class="qr-code" id="qrcode-${doc.id}"></div>
                <div class="qr-label">CÃ³digo QR AT</div>
              </div>
            </div>
            ` : ''}
            
            <!-- RODAPÃ‰ -->
            <div class="fatura-rodape">
              <div class="rodape-legal">
                EMEUTRANS â€“ EMPRESA EUROPEIA DE TRANSPORTES, UNIPESSOAL LDA. â€¢ CAPITAL SOCIAL ${empresaConfig.capitalSocial || '125.000â‚¬'} â€¢ Contribuinte ${empresaConfig.nif} â€¢ ${empresaConfig.registoComercial || 'C.R.C Caldas Da Rainha'}
              </div>
              <div class="rodape-licenca">
                ${empresaConfig.certificacao || 'Programa certificado nÂº 0000/AT'} â€¢ Documento processado por programa certificado
              </div>
            </div>
          </div>
          
        </div>
      `;
      
      // Gerar QR Code AT (se aplicÃ¡vel)
      if (configDoc.mostrarQRCode) {
        setTimeout(() => {
          const qrContainer = document.getElementById(`qrcode-${doc.id}`);
          if (qrContainer && typeof QRCode !== 'undefined') {
            qrContainer.innerHTML = '';
            new QRCode(qrContainer, {
              text: qrData,
              width: 80,
              height: 80,
              colorDark: '#000000',
              colorLight: '#ffffff',
              correctLevel: QRCode.CorrectLevel.M
            });
          }
        }, 100);
      }
    }
    
    // FunÃ§Ã£o wrapper para faturas (compatibilidade)
    function gerarPreviewFatura(f) {
      gerarPreviewDocumento(f, 'FT');
    }
    
    // FunÃ§Ã£o wrapper para Notas de CrÃ©dito
    function gerarPreviewNotaCredito(nc) {
      gerarPreviewDocumento(nc, 'NC');
    }
    
    // FunÃ§Ã£o wrapper para Notas de DÃ©bito
    function gerarPreviewNotaDebito(nd) {
      gerarPreviewDocumento(nd, 'ND');
    }
    
    // FunÃ§Ã£o wrapper para Recibos
    function gerarPreviewRecibo(rc) {
      gerarPreviewDocumento(rc, 'RC');
    }
    
    // FunÃ§Ã£o wrapper para Pagamentos a Fornecedor
    function gerarPreviewPagamentoFornecedor(pf) {
      gerarPreviewDocumento(pf, 'PF');
    }
    
    // FunÃ§Ã£o wrapper para DÃ©bitos a Fornecedor
    function gerarPreviewDebitoFornecedor(df) {
      gerarPreviewDocumento(df, 'DF');
    }
    
    // ==================== FUNÃ‡Ã•ES DE VISUALIZAÃ‡ÃƒO ====================
    
    // Ver Nota de CrÃ©dito
    function verNotaCredito(id) {
      const nc = notasCredito.find(x => x.id == id);
      if (!nc) return;
      gerarPreviewDocumento(nc, 'NC');
      abrirModal('modalPreviewFatura');
    }
    
    // Ver Nota de DÃ©bito
    function verNotaDebito(id) {
      const nd = notasDebito.find(x => x.id == id);
      if (!nd) return;
      gerarPreviewDocumento(nd, 'ND');
      abrirModal('modalPreviewFatura');
    }
    
    // Ver Recibo
    function verRecibo(id) {
      const rc = recibos.find(x => x.id == id);
      if (!rc) return;
      
      // Normalizar dados do recibo para o formato esperado pelo gerarPreviewDocumento
      const rcNormalizado = {
        ...rc,
        total: rc.valor || rc.total,  // Usar valor se existir, senÃ£o total
        nif: clientes.find(c => c.id == rc.clienteId)?.nif || '',
        faturaRef: rc.faturas ? rc.faturas.join(', ') : rc.faturaRef
      };
      
      gerarPreviewDocumento(rcNormalizado, 'RC');
      abrirModal('modalPreviewFatura');
    }
    
    // Ver Pagamento a Fornecedor
    function verPagamentoFornecedor(id) {
      const pf = pagamentosFornecedor.find(x => x.id == id);
      if (!pf) return;
      gerarPreviewDocumento(pf, 'PF');
      abrirModal('modalPreviewFatura');
    }
    
    // Ver DÃ©bito a Fornecedor
    function verDebitoFornecedor(id) {
      const df = debitosFornecedor.find(x => x.id == id);
      if (!df) return;
      gerarPreviewDocumento(df, 'DF');
      abrirModal('modalPreviewFatura');
    }
    
    // ==================== FUNÃ‡Ã•ES DE IMPRESSÃƒO ====================
    
    // Imprimir Nota de CrÃ©dito
    function imprimirNotaCredito(id) {
      const nc = notasCredito.find(x => x.id == id);
      if (!nc) return;
      gerarPreviewDocumento(nc, 'NC');
      abrirModal('modalPreviewFatura');
      setTimeout(() => window.print(), 500);
    }
    
    // Imprimir Nota de DÃ©bito
    function imprimirNotaDebito(id) {
      const nd = notasDebito.find(x => x.id == id);
      if (!nd) return;
      gerarPreviewDocumento(nd, 'ND');
      abrirModal('modalPreviewFatura');
      setTimeout(() => window.print(), 500);
    }
    
    // Imprimir Recibo
    function imprimirRecibo(id) {
      const rc = recibos.find(x => x.id == id);
      if (!rc) return;
      
      // Normalizar dados do recibo para o formato esperado pelo gerarPreviewDocumento
      const rcNormalizado = {
        ...rc,
        total: rc.valor || rc.total,
        nif: clientes.find(c => c.id == rc.clienteId)?.nif || '',
        faturaRef: rc.faturas ? rc.faturas.join(', ') : rc.faturaRef
      };
      
      gerarPreviewDocumento(rcNormalizado, 'RC');
      abrirModal('modalPreviewFatura');
      setTimeout(() => window.print(), 500);
    }
    
    // Imprimir Pagamento a Fornecedor
    function imprimirPagamentoFornecedor(id) {
      const pf = pagamentosFornecedor.find(x => x.id == id);
      if (!pf) return;
      gerarPreviewDocumento(pf, 'PF');
      abrirModal('modalPreviewFatura');
      setTimeout(() => window.print(), 500);
    }
    
    // Imprimir DÃ©bito a Fornecedor
    function imprimirDebitoFornecedor(id) {
      const df = debitosFornecedor.find(x => x.id == id);
      if (!df) return;
      gerarPreviewDocumento(df, 'DF');
      abrirModal('modalPreviewFatura');
      setTimeout(() => window.print(), 500);
    }
    
    /* ========== FIM FUNÃ‡ÃƒO gerarPreviewDocumento - BLOQUEADA ========== */
    
    // âš ï¸ REGRA: Esta funÃ§Ã£o DEVE usar gerarPreviewFatura() - NÃƒO criar layout alternativo
    function previewFatura() {
      // Criar objeto fatura temporÃ¡rio para preview
      const clienteId = document.getElementById('faturaCliente').value;
      if (!clienteId) {
        alert('Selecione um cliente primeiro!');
        return;
      }
      
      // CORREÃ‡ÃƒO v6.22: Procurar cliente em mÃºltiplas fontes
      let cliente = null;
      if (typeof clientes !== 'undefined') {
        cliente = clientes.find(c => c.id == clienteId);
      }
      if (!cliente && typeof clientesLista !== 'undefined') {
        cliente = clientesLista.find(c => c.id == clienteId || c.numero == clienteId);
        if (cliente && cliente.nome_completo) {
          cliente = {
            id: cliente.id,
            nome: cliente.nome_completo,
            nif: cliente.contribuinte || '',
            morada: cliente.sede_rua || '',
            localidade: cliente.sede_cidade || ''
          };
        }
      }
      
      // Se ainda nÃ£o encontrou, usar dados do formulÃ¡rio
      if (!cliente) {
        const selectCliente = document.getElementById('faturaCliente');
        const nomeCliente = selectCliente.options[selectCliente.selectedIndex]?.text || 'Cliente';
        cliente = {
          id: clienteId,
          nome: nomeCliente,
          nif: document.getElementById('faturaNIF')?.value || '',
          morada: document.getElementById('faturaMorada')?.value || '',
          localidade: ''
        };
      }
      
      const linhas = [];
      let subtotal = 0;
      let iva23 = 0, iva6 = 0;
      
      document.querySelectorAll('#linhasFatura .excel-row').forEach(linha => {
        const cmr = linha.querySelector('[data-field="cmr"]').value;
        const localCarga = linha.querySelector('[data-field="localCarga"]').value;
        const localDescarga = linha.querySelector('[data-field="localDescarga"]').value;
        const descricao = linha.querySelector('[data-field="descricao"]')?.value || 'Transporte mercadoria';
        const refCliente = linha.querySelector('[data-field="refCliente"]').value;
        const ldm = linha.querySelector('[data-field="ldm"]').value;
        const numBultos = linha.querySelector('[data-field="numBultos"]')?.value || '';
        const peso = parseFloat(linha.querySelector('[data-field="peso"]').value) || 0;
        const precoTon = parseFloat(linha.querySelector('[data-field="precoTon"]').value) || 0;
        const valorInput = parseFloat(linha.querySelector('[data-field="valor"]').value) || 0;
        const taxaIVA = parseInt(linha.querySelector('[data-field="codigoIVA"]').value) || 0;
        
        // CORREÃ‡ÃƒO v6.22: Mesma lÃ³gica de valor que emitirFatura
        // Peso Ã© INDICATIVO, nÃ£o obriga â‚¬/TON
        let valor = 0;
        if (peso > 0 && precoTon > 0) {
          const pesoTon = peso / 1000;
          valor = pesoTon * precoTon;
        } else if (valorInput > 0) {
          valor = valorInput;
        }
        
        // Incluir novos campos para layout A4
        if (valor > 0 || cmr) {
          linhas.push({ 
            cmr, 
            localCarga, 
            localDescarga, 
            descricao,
            refCliente, 
            ldm,
            numBultos, 
            peso, 
            precoTon, 
            valor, 
            taxaIVA,
            empresaCarga: '',
            empresaDescarga: ''
          });
          subtotal += valor;
          
          if (taxaIVA === 23) iva23 += valor * 0.23;
          else if (taxaIVA === 6) iva6 += valor * 0.06;
        }
      });
      
      if (linhas.length === 0) {
        alert('Adicione pelo menos uma linha com valor Ã  fatura!');
        return;
      }
      
      const regra = obterRegraIVA(cliente.tipoCliente, 'Normal', linhas[0]?.localCarga, linhas[0]?.localDescarga);
      
      const faturaTemp = {
        id: 'preview',
        numero: document.getElementById('faturaNumero').value,
        data: document.getElementById('faturaData').value,
        vencimento: document.getElementById('faturaVencimento').value,
        clienteId: parseInt(clienteId),
        cliente: cliente.nome,
        nif: cliente.nif,
        morada: cliente.morada + (cliente.localidade ? ', ' + cliente.localidade : ''),
        linhas,
        subtotal,
        iva23, iva6,
        totalIVA: iva23 + iva6,
        total: subtotal + iva23 + iva6,
        obs: document.getElementById('faturaObs').value,
        artigoIsencao: regra.artigo,
        motivoIsencao: regra.motivo
      };
      
      // OBRIGATÃ“RIO: Usar funÃ§Ã£o centralizada para layout consistente
      gerarPreviewFatura(faturaTemp);
      abrirModal('modalPreviewFatura');
    }
    
    function imprimirPreview() {
      window.print();
    }
    
    // âš ï¸ REGRA: Esta funÃ§Ã£o DEVE usar gerarPreviewFatura() - NÃƒO criar layout alternativo
    function imprimirFatura(id) {
      const f = faturas.find(x => x.id == id);
      if (!f) return;
      // OBRIGATÃ“RIO: Usar funÃ§Ã£o centralizada para layout consistente
      gerarPreviewFatura(f);
      abrirModal('modalPreviewFatura');
      setTimeout(() => window.print(), 500);
    }
    
    // â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    // â•‘                                                                                        â•‘
    // â•‘  ğŸ”’ SECÃ‡ÃƒO BLOQUEADA - PRÃ‰-FATURAÃ‡ÃƒO                                                   â•‘
    // â•‘  Data: 19/12/2024 | VersÃ£o: 3.1                                                        â•‘
    // â•‘                                                                                        â•‘
    // â•‘  FUNÃ‡Ã•ES BLOQUEADAS (NÃƒO ALTERAR):                                                     â•‘
    // â•‘  â€¢ renderizarPreFaturacao() - Renderiza lista de reservas com suporte misto           â•‘
    // â•‘  â€¢ toggleReserva() - Selecciona/desselecciona reservas (valida cliente e IVA)         â•‘
    // â•‘  â€¢ selecionarTodas() - Selecciona todas do mesmo cliente/IVA                          â•‘
    // â•‘  â€¢ deselecionarTodas() - Limpa selecÃ§Ã£o                                               â•‘
    // â•‘  â€¢ faturarSelecionadas() - Cria fatura com linhas mistas (PesoÃ—â‚¬/TON e LDM+Valor)     â•‘
    // â•‘  â€¢ limparFiltrosPreFat() - Limpa filtros de cliente e data                            â•‘
    // â•‘  â€¢ reporReservasTeste() - RepÃµe 12 reservas de teste (5 peso, 7 valor fixo)           â•‘
    // â•‘                                                                                        â•‘
    // â•‘  TIPOS DE FATURAÃ‡ÃƒO SUPORTADOS:                                                        â•‘
    // â•‘  1. Peso Ã— â‚¬/TON â†’ Valor calculado automaticamente                                     â•‘
    // â•‘  2. LDM + Valor Fixo â†’ Valor editÃ¡vel manualmente                                      â•‘
    // â•‘                                                                                        â•‘
    // â•‘  REGRAS DE SELECÃ‡ÃƒO:                                                                   â•‘
    // â•‘  â€¢ SÃ³ pode juntar reservas do MESMO CLIENTE                                            â•‘
    // â•‘  â€¢ NÃ£o pode misturar COM IVA e SEM IVA (nacionais vs internacionais)                   â•‘
    // â•‘  â€¢ PODE misturar tipos de faturaÃ§Ã£o (PesoÃ—â‚¬/TON com LDM+Valor)                         â•‘
    // â•‘                                                                                        â•‘
    // â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    let reservasSelecionadas = [];
    
    // ğŸ”’ FUNÃ‡ÃƒO BLOQUEADA - renderizarPreFaturacao
    function renderizarPreFaturacao() {
      // Guardar valor do filtro atual antes de recriar o dropdown
      const filtroClienteAtual = document.getElementById('filtroClientePreFat')?.value || '';
      const filtroDataAtual = document.getElementById('filtroDataPreFat')?.value || '';
      
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // CORREÃ‡ÃƒO v6.21: Obter reservas APENAS do localStorage (reservas REAIS)
      // NÃƒO usar o array 'reservas' que contÃ©m dados de teste!
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      let todasAsReservas = [];
      
      // 1. localStorage 'erpReservasExecutadas' (mÃ³dulo reservas - principal)
      try {
        const reservasExec = JSON.parse(localStorage.getItem('erpReservasExecutadas') || '[]');
        reservasExec.forEach(r => {
          todasAsReservas.push(r);
        });
      } catch (e) {}
      
      // 2. localStorage 'erpReservas' (backup)
      try {
        const reservasLS = JSON.parse(localStorage.getItem('erpReservas') || '[]');
        reservasLS.forEach(r => {
          if (!todasAsReservas.find(tr => tr.id === r.id || tr.numero === r.numero)) {
            todasAsReservas.push(r);
          }
        });
      } catch (e) {}
      
      // 3. Array 'todasReservas' (mÃ³dulo reservas em memÃ³ria) - APENAS reservas reais
      if (typeof todasReservas !== 'undefined' && todasReservas.length > 0) {
        todasReservas.forEach(r => {
          if (r.numero && r.numero.startsWith('RES-') && !todasAsReservas.find(tr => tr.numero === r.numero)) {
            todasAsReservas.push(r);
          }
        });
      }
      
      console.log('ğŸ“‹ PrÃ©-FaturaÃ§Ã£o: Total reservas reais:', todasAsReservas.length);
      
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // FILTRAR: SÃ³ reservas de FATURAÃ‡ÃƒO MANUAL com CMR CARGA anexado
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      let reservasDisponiveis = todasAsReservas.filter(r => {
        // NÃ£o pode estar faturada
        if (r.faturada || r.faturaNumero || r.numero_fatura) return false;
        
        // Tem que ter CMR de Carga ANEXADO (ficheiro real, nÃ£o texto)
        const temCMRCarga = r.cmrCargaAnexado === true || 
                          (r.cmrCarga && r.cmrCarga.includes('.'));  // Tem extensÃ£o = Ã© ficheiro
        if (!temCMRCarga) return false;
        
        // Verificar modo de faturaÃ§Ã£o - sÃ³ modo MANUAL vai para prÃ©-faturaÃ§Ã£o
        const modoFaturacao = r.modoFaturacao || r.modo_faturacao || 'Manual';
        if (modoFaturacao === 'AutomÃ¡tica') return false; // AutomÃ¡ticas sÃ£o faturadas pelo trigger C52
        
        return true;
      });
      
      console.log('ğŸ“‹ PrÃ©-FaturaÃ§Ã£o: Reservas disponÃ­veis:', reservasDisponiveis.length);
      
      // Preencher filtro de clientes - CORREÃ‡ÃƒO v6.21: usar dados das prÃ³prias reservas
      const selectCliente = document.getElementById('filtroClientePreFat');
      const clientesUnicos = [...new Set(reservasDisponiveis.map(r => r.cliente || r.nome_cliente).filter(c => c))];
      selectCliente.innerHTML = '<option value="">Todos os clientes</option>';
      clientesUnicos.forEach(nomeCliente => {
        const reservaCliente = reservasDisponiveis.find(r => (r.cliente || r.nome_cliente) === nomeCliente);
        const numCliente = reservaCliente?.clienteNumero || '';
        const selected = filtroClienteAtual === nomeCliente ? 'selected' : '';
        const labelCliente = numCliente ? `${numCliente} - ${nomeCliente}` : nomeCliente;
        selectCliente.innerHTML += `<option value="${nomeCliente}" ${selected}>${labelCliente}</option>`;
      });
      
      // CORREÃ‡ÃƒO: Aplicar pesquisa global
      if (termoPesquisaGlobal) {
        reservasDisponiveis = reservasDisponiveis.filter(r => {
          const numCliente = r.clienteNumero || '';
          return (r.numero || '').toLowerCase().includes(termoPesquisaGlobal) ||
                 (r.cliente || '').toLowerCase().includes(termoPesquisaGlobal) ||
                 numCliente.toLowerCase().includes(termoPesquisaGlobal) ||
                 (r.localCarga || '').toLowerCase().includes(termoPesquisaGlobal) ||
                 (r.localDescarga || '').toLowerCase().includes(termoPesquisaGlobal) ||
                 (r.refCliente || '').toLowerCase().includes(termoPesquisaGlobal) ||
                 (r.cmrDescarga || '').toLowerCase().includes(termoPesquisaGlobal);
        });
      }
      
      // CORREÃ‡ÃƒO v6.21: Aplicar filtro de cliente (por nome)
      if (filtroClienteAtual) {
        reservasDisponiveis = reservasDisponiveis.filter(r => {
          const nomeCliente = r.cliente || r.nome_cliente || '';
          return nomeCliente === filtroClienteAtual;
        });
      }
      
      // CORREÃ‡ÃƒO: Aplicar filtro de data
      if (filtroDataAtual) {
        reservasDisponiveis = reservasDisponiveis.filter(r => r.dataExecucao === filtroDataAtual);
      }
      
      const container = document.getElementById('listaPreFaturacao');
      
      if (reservasDisponiveis.length === 0) {
        container.innerHTML = '<p class="text-center text-slate-500 py-8">NÃ£o existem reservas prontas a faturar.</p>';
        atualizarContadorSelecionadas();
        return;
      }
      
      container.innerHTML = reservasDisponiveis.map(r => {
        // CORREÃ‡ÃƒO v6.21: Usar dados da prÃ³pria reserva, nÃ£o do array clientes
        const numCliente = r.clienteNumero || '';
        
        // CORREÃ‡ÃƒO v6.21: Obter valores de mÃºltiplos campos possÃ­veis
        const peso = r.pesoCarga || r.peso || 0;
        const precoTon = r.precoTon || r.preco_ton || 0;
        const valorFixo = r.valorFixo || r.valor_fixo || 0;
        const preco = r.preco || r.valor || 0;
        const ldm = r.ldm || '';
        
        // Determinar tipo de faturaÃ§Ã£o: por peso/tonelada ou por valor fixo
        const faturaPorPeso = peso > 0 && precoTon > 0 && !valorFixo;
        
        // Calcular valor
        let valorTotal = 0;
        let coluna5 = ''; // Peso ou LDM
        let coluna6 = ''; // â‚¬/TON ou Valor
        
        if (faturaPorPeso) {
          // FaturaÃ§Ã£o por Peso x â‚¬/TON
          valorTotal = (peso / 1000) * precoTon;
          coluna5 = `<p class="font-medium">${formatPeso(peso)}</p><p class="text-xs text-slate-400">Peso</p>`;
          coluna6 = `<p class="font-medium">â‚¬${precoTon}/TON</p><p class="text-xs text-slate-400">â‚¬/Tonelada</p>`;
        } else {
          // FaturaÃ§Ã£o por LDM + Valor Fixo ou PreÃ§o direto
          valorTotal = valorFixo || preco || 0;
          coluna5 = `<p class="font-medium">${ldm || '-'} LDM</p><p class="text-xs text-slate-400">Metros Lineares</p>`;
          coluna6 = `<p class="font-medium">${formatCurrency(valorTotal)}</p><p class="text-xs text-slate-400">Valor Fixo</p>`;
        }
        
        // NOVO v6.21: Determinar regime de IVA da reserva
        // Baseado no local de descarga (Portugal = IVA, Fora = Isento)
        const localDescarga = (r.localDescarga || r.descargaPais || '').toLowerCase();
        const temIVA = localDescarga.includes('portugal') || localDescarga === '' || localDescarga === 'pt';
        const regimeIVA = temIVA ? 'COM_IVA' : 'SEM_IVA';
        const badgeIVA = temIVA 
          ? '<span class="text-xs px-1 py-0.5 bg-blue-100 text-blue-700 rounded">IVA 23%</span>'
          : '<span class="text-xs px-1 py-0.5 bg-amber-100 text-amber-700 rounded">Isento</span>';
        
        return `
        <div class="pre-fat-row ${reservasSelecionadas.includes(r.id) ? 'selected' : ''}" 
             onclick="toggleReserva(${r.id}, '${regimeIVA}')"
             data-regime-iva="${regimeIVA}">
          <input type="checkbox" ${reservasSelecionadas.includes(r.id) ? 'checked' : ''} onclick="event.stopPropagation(); toggleReserva(${r.id}, '${regimeIVA}')" class="mr-4">
          <div class="flex-1 grid grid-cols-7 gap-4 text-sm">
            <div>
              <p class="font-mono font-semibold">${r.numero}</p>
              <p class="text-xs text-slate-500">${formatDate(r.dataExecucao || r.dataAbertura || r.data)}</p>
            </div>
            <div>
              <p class="font-semibold">${r.cliente || 'Cliente'}</p>
              <p class="text-xs text-slate-500">${numCliente || ''}</p>
            </div>
            <div>
              <p class="text-slate-600">${r.localCarga || ''}</p>
              <p class="text-xs text-slate-400">â†’ ${r.localDescarga || ''}</p>
            </div>
            <div>
              <p class="text-xs text-slate-500">Ref: ${r.refCliente || '-'}</p>
              <p class="text-xs text-slate-500">${badgeIVA}</p>
            </div>
            <div class="text-right">
              ${coluna5}
            </div>
            <div class="text-right">
              ${coluna6}
            </div>
            <div class="text-right font-semibold text-emerald-600">
              <p>${formatCurrency(valorTotal)}</p>
              <p class="text-xs text-slate-400">${faturaPorPeso ? 'PesoÃ—â‚¬/TON' : 'Valor Fixo'}</p>
            </div>
          </div>
        </div>
      `}).join('');
      
      atualizarContadorSelecionadas();
    }
    
    // ğŸ”’ FUNÃ‡ÃƒO BLOQUEADA - toggleReserva (valida cliente e IVA)
    // VariÃ¡vel para guardar o regime de IVA das reservas selecionadas
    let regimeIVASelecionado = null;
    
    function toggleReserva(id, regimeIVA) {
      const index = reservasSelecionadas.indexOf(id);
      
      if (index > -1) {
        // REMOVER da seleÃ§Ã£o
        reservasSelecionadas.splice(index, 1);
        
        // Se nÃ£o hÃ¡ mais selecionadas, limpar regime
        if (reservasSelecionadas.length === 0) {
          regimeIVASelecionado = null;
        }
      } else {
        // ADICIONAR Ã  seleÃ§Ã£o
        
        // Obter a reserva de todas as fontes
        let reserva = null;
        if (typeof reservas !== 'undefined') {
          reserva = reservas.find(r => r.id === id);
        }
        if (!reserva && typeof todasReservas !== 'undefined') {
          reserva = todasReservas.find(r => r.id === id);
        }
        
        if (!reserva) {
          console.error('Reserva nÃ£o encontrada:', id);
          return;
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // REGRA v6.21: Determinar regime de IVA baseado no local de descarga
        // Portugal = COM_IVA (23%), Fora de Portugal = SEM_IVA (0% isento)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const localDescarga = (reserva.localDescarga || reserva.descargaPais || '').toLowerCase();
        const regimeReserva = (localDescarga.includes('portugal') || localDescarga === '' || localDescarga === 'pt') 
          ? 'COM_IVA' 
          : 'SEM_IVA';
        
        if (reservasSelecionadas.length > 0) {
          // JÃ¡ tem reservas selecionadas - verificar regras
          
          // Obter primeira reserva selecionada
          let primeiraReserva = null;
          if (typeof reservas !== 'undefined') {
            primeiraReserva = reservas.find(r => r.id === reservasSelecionadas[0]);
          }
          if (!primeiraReserva && typeof todasReservas !== 'undefined') {
            primeiraReserva = todasReservas.find(r => r.id === reservasSelecionadas[0]);
          }
          
          if (primeiraReserva) {
            // REGRA 1: Verificar mesmo cliente
            const clienteIdPrimeira = primeiraReserva.clienteId || primeiraReserva.cliente_id;
            const clienteIdAtual = reserva.clienteId || reserva.cliente_id;
            
            // TambÃ©m verificar por nome se IDs sÃ£o diferentes ou nÃ£o existem
            const clienteNomePrimeira = primeiraReserva.cliente || primeiraReserva.nome_cliente || '';
            const clienteNomeAtual = reserva.cliente || reserva.nome_cliente || '';
            
            const mesmoCliente = (clienteIdPrimeira && clienteIdAtual && clienteIdPrimeira === clienteIdAtual) ||
                                (clienteNomePrimeira && clienteNomeAtual && clienteNomePrimeira === clienteNomeAtual);
            
            if (!mesmoCliente) {
              alert('âš ï¸ SÃ³ pode juntar reservas do MESMO CLIENTE na mesma fatura!');
              return;
            }
            
            // REGRA 2: Verificar mesmo regime de IVA
            if (regimeIVASelecionado && regimeIVASelecionado !== regimeReserva) {
              const msgIVA = regimeIVASelecionado === 'COM_IVA' 
                ? 'As reservas selecionadas tÃªm IVA (transporte nacional).\nNÃ£o pode adicionar uma reserva ISENTA DE IVA (transporte internacional).'
                : 'As reservas selecionadas sÃ£o ISENTAS DE IVA (transporte internacional).\nNÃ£o pode adicionar uma reserva COM IVA (transporte nacional).';
              
              alert(`âš ï¸ REGRA DE IVA VIOLADA!\n\n${msgIVA}\n\nCrie faturas separadas para transportes com regimes de IVA diferentes.`);
              return;
            }
          }
        } else {
          // Primeira reserva - guardar o regime de IVA
          regimeIVASelecionado = regimeReserva;
        }
        
        reservasSelecionadas.push(id);
      }
      
      renderizarPreFaturacao();
    }
    
    // ğŸ”’ FUNÃ‡ÃƒO BLOQUEADA - selecionarTodas (mesmo cliente e IVA)
    function selecionarTodas() {
      // Obter reservas de todas as fontes
      let todasAsReservas = [];
      if (typeof reservas !== 'undefined' && reservas.length > 0) {
        todasAsReservas = [...reservas];
      }
      if (typeof todasReservas !== 'undefined' && todasReservas.length > 0) {
        todasReservas.forEach(r => {
          if (!todasAsReservas.find(tr => tr.id === r.id)) {
            todasAsReservas.push(r);
          }
        });
      }
      
      // Filtrar disponÃ­veis (mesma lÃ³gica da PrÃ©-FaturaÃ§Ã£o)
      const reservasDisponiveis = todasAsReservas.filter(r => {
        if (r.faturada || r.faturaNumero || r.numero_fatura) return false;
        const temCMRCarga = r.cmrCargaAnexado === true || (r.cmrCarga && r.cmrCarga.includes('.'));
        if (!temCMRCarga) return false;
        const modoFaturacao = r.modoFaturacao || r.modo_faturacao || 'Manual';
        if (modoFaturacao === 'AutomÃ¡tica') return false;
        return true;
      });
      
      if (reservasDisponiveis.length === 0) return;
      
      // CORREÃ‡ÃƒO v6.21: Selecionar sÃ³ as do mesmo cliente E com mesmo regime de IVA
      alert('âš ï¸ "Selecionar Todas" foi desativado para evitar mistura de regimes de IVA.\n\nPor favor, selecione as reservas manualmente verificando que tÃªm o mesmo regime de IVA (todas COM IVA ou todas SEM IVA).');
    }
    
    // ğŸ”’ FUNÃ‡ÃƒO BLOQUEADA - deselecionarTodas
    function deselecionarTodas() {
      reservasSelecionadas = [];
      regimeIVASelecionado = null; // Limpar regime de IVA
      renderizarPreFaturacao();
    }
    
    function atualizarContadorSelecionadas() {
      document.getElementById('countSelecionadas').textContent = `${reservasSelecionadas.length} selecionadas`;
      document.getElementById('btnFaturarSelecionadas').disabled = reservasSelecionadas.length === 0;
    }
    
    // ğŸ”’ FUNÃ‡ÃƒO BLOQUEADA - faturarSelecionadas (suporta PesoÃ—â‚¬/TON e LDM+Valor)
    function faturarSelecionadas() {
      if (reservasSelecionadas.length === 0) return;
      
      // Verificar se a sÃ©rie FT estÃ¡ ativa
      if (!verificarSerieAtiva('FT')) {
        return;
      }
      
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // CORREÃ‡ÃƒO v6.21: Obter reservas APENAS do localStorage (reservas REAIS do utilizador)
      // NÃƒO usar o array 'reservas' que contÃ©m dados de teste!
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      let todasAsReservas = [];
      
      // 1. localStorage 'erpReservasExecutadas' (mÃ³dulo reservas - principal)
      try {
        const reservasExec = JSON.parse(localStorage.getItem('erpReservasExecutadas') || '[]');
        reservasExec.forEach(r => {
          todasAsReservas.push(r);
        });
        console.log('ğŸ“‹ Carregadas', reservasExec.length, 'reservas de erpReservasExecutadas');
      } catch (e) {
        console.warn('Erro ao carregar erpReservasExecutadas:', e);
      }
      
      // 2. localStorage 'erpReservas' (backup)
      try {
        const reservasLS = JSON.parse(localStorage.getItem('erpReservas') || '[]');
        reservasLS.forEach(r => {
          if (!todasAsReservas.find(tr => tr.id === r.id || tr.numero === r.numero)) {
            todasAsReservas.push(r);
          }
        });
        console.log('ğŸ“‹ Total apÃ³s erpReservas:', todasAsReservas.length);
      } catch (e) {
        console.warn('Erro ao carregar erpReservas:', e);
      }
      
      // 3. Array 'todasReservas' (mÃ³dulo reservas em memÃ³ria) - APENAS se sÃ£o reservas reais
      if (typeof todasReservas !== 'undefined' && todasReservas.length > 0) {
        todasReservas.forEach(r => {
          // Verificar se Ã© reserva real (nÃºmero com formato RES-YYYY-NNN)
          if (r.numero && r.numero.startsWith('RES-') && !todasAsReservas.find(tr => tr.numero === r.numero)) {
            todasAsReservas.push(r);
          }
        });
      }
      
      console.log('ğŸ“‹ faturarSelecionadas: Total reservas reais:', todasAsReservas.length);
      console.log('ğŸ“‹ faturarSelecionadas: IDs selecionados:', reservasSelecionadas);
      
      // Encontrar as reservas selecionadas - por ID E verificar que Ã© reserva real
      let reservasFaturar = todasAsReservas.filter(r => reservasSelecionadas.includes(r.id));
      
      console.log('ğŸ“‹ faturarSelecionadas: Reservas encontradas:', reservasFaturar.map(r => r.numero));
      
      if (reservasFaturar.length === 0) {
        alert('Erro: NÃ£o foi possÃ­vel encontrar as reservas selecionadas.\n\nVerifique se as reservas estÃ£o correctamente guardadas.');
        return;
      }
      
      console.log('ğŸ“‹ Reservas a faturar:', reservasFaturar);
      
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // OBTER CLIENTE - procurar pelo nome, nÃºmero ou ID
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      const primeiraReserva = reservasFaturar[0];
      let cliente = null;
      
      // Dados do cliente da reserva
      const clienteNome = primeiraReserva.cliente || primeiraReserva.nome_cliente || '';
      const clienteNumero = primeiraReserva.clienteNumero || primeiraReserva.cliente_numero || '';
      const clienteId = primeiraReserva.clienteId || primeiraReserva.cliente_id || null;
      
      console.log('ğŸ” Procurando cliente:', clienteNome, '| NÃºmero:', clienteNumero, '| ID:', clienteId);
      
      // 1. Procurar no array 'clientes' (mÃ³dulo faturaÃ§Ã£o)
      if (typeof clientes !== 'undefined' && clientes.length > 0) {
        cliente = clientes.find(c => 
          c.id === clienteId || 
          c.numeroCliente === clienteNumero ||
          c.nome === clienteNome
        );
      }
      
      // 2. Procurar em 'clientesLista' (mÃ³dulo clientes)
      if (!cliente && typeof clientesLista !== 'undefined' && clientesLista.length > 0) {
        cliente = clientesLista.find(c => 
          c.numero === clienteNumero || 
          c.nome_completo === clienteNome ||
          (c.nome_completo && c.nome_completo.includes(clienteNome))
        );
      }
      
      // 3. Se encontrou em clientesLista, converter para formato do mÃ³dulo faturaÃ§Ã£o
      if (cliente && cliente.nome_completo && !cliente.nome) {
        cliente = {
          id: cliente.id || Date.now(),
          nome: cliente.nome_completo,
          nif: cliente.contribuinte || '',
          numeroCliente: cliente.numero || '',
          morada: [
            cliente.sede_rua,
            cliente.sede_porta ? 'nÂº ' + cliente.sede_porta : '',
            cliente.sede_cp,
            cliente.sede_cidade,
            cliente.pais
          ].filter(p => p).join(', ')
        };
      }
      
      if (!cliente) {
        // Criar cliente temporÃ¡rio com dados da reserva
        console.warn('âš ï¸ Cliente nÃ£o encontrado, usando dados da reserva');
        cliente = {
          id: clienteId || Date.now(),
          nome: clienteNome || 'Cliente nÃ£o identificado',
          nif: primeiraReserva.clienteNIF || '',
          numeroCliente: clienteNumero || '',
          morada: ''
        };
      }
      
      console.log('âœ… Cliente encontrado:', cliente.nome);
      
      // Abrir modal de fatura preenchida
      abrirNovaFatura();
      
      // CORREÃ‡ÃƒO v6.20: Usar setTimeout para garantir que o modal estÃ¡ carregado
      setTimeout(() => {
        // Selecionar cliente - preencher manualmente se nÃ£o existe no dropdown
        const selectCliente = document.getElementById('faturaCliente');
        if (selectCliente) {
          // Verificar se o cliente existe no dropdown
          const opcaoExiste = Array.from(selectCliente.options).find(opt => opt.value == cliente.id);
          if (opcaoExiste) {
            selectCliente.value = cliente.id;
            preencherDadosCliente();
          } else {
            // Adicionar opÃ§Ã£o temporÃ¡ria e preencher manualmente
            const novaOpcao = document.createElement('option');
            novaOpcao.value = cliente.id;
            novaOpcao.text = cliente.nome;
            selectCliente.add(novaOpcao);
            selectCliente.value = cliente.id;
            
            // Preencher dados manualmente
            document.getElementById('faturaNIF').value = cliente.nif || '';
            document.getElementById('faturaMorada').value = cliente.morada || '';
          }
        }
        
        // Mudar tipo de faturaÃ§Ã£o
        document.querySelector('input[name="tipoFaturacao"][value="reserva"]').checked = true;
        document.getElementById('faturaTipo').value = 'manual';
        
        // Limpar linhas e adicionar as reservas
        const containerLinhas = document.getElementById('linhasFatura');
        containerLinhas.innerHTML = '';
        linhaCount = 0;
        
        console.log('ğŸ“‹ Criando linhas para', reservasFaturar.length, 'reservas');
        
        reservasFaturar.forEach((r, index) => {
          console.log('ğŸ“‹ Processando reserva', index + 1, ':', r.numero);
          adicionarLinhaFatura();
          const linha = document.getElementById(`linha-${linhaCount}`);
          
          if (!linha) {
            console.error('âŒ Linha nÃ£o encontrada: linha-' + linhaCount);
            return;
          }
          
          // Campos comuns - usar mÃºltiplos nomes de campos possÃ­veis
          const cmrVal = r.numero || r.numero_reserva || r.cmrDescarga || '';
          const localCargaVal = r.localCarga || r.cargaCidade || '';
          const localDescargaVal = r.localDescarga || r.descargaCidade || '';
          const descricaoVal = r.descricao || r.descricao_carga || 'Transporte mercadoria';
          const refClienteVal = r.refCliente || r.ref_cliente || '';
          const ldmVal = r.ldm || '';
          const numBultosVal = r.numBultos || r.num_bultos || '';
          
          linha.querySelector('[data-field="cmr"]').value = cmrVal;
          linha.querySelector('[data-field="localCarga"]').value = localCargaVal;
          linha.querySelector('[data-field="localDescarga"]').value = localDescargaVal;
          if (linha.querySelector('[data-field="descricao"]')) {
            linha.querySelector('[data-field="descricao"]').value = descricaoVal;
          }
          linha.querySelector('[data-field="refCliente"]').value = refClienteVal;
          linha.querySelector('[data-field="ldm"]').value = ldmVal;
          if (linha.querySelector('[data-field="numBultos"]')) {
            linha.querySelector('[data-field="numBultos"]').value = numBultosVal;
          }
          
          // Obter valores da reserva
          const peso = r.pesoCarga || r.peso || 0;
          const precoTon = r.precoTon || r.preco_ton || 0;
          const valorFixo = r.valorFixo || r.valor_fixo || 0;
          const preco = r.preco || 0;
          
          console.log('ğŸ“Š Reserva', r.numero, '- Peso:', peso, 'â‚¬/TON:', precoTon, 'Valor:', valorFixo || preco);
          
          // Verificar tipo de faturaÃ§Ã£o: PesoÃ—â‚¬/TON ou LDM+Valor Fixo
          const faturaPorPeso = peso > 0 && precoTon > 0 && !valorFixo;
          
          if (faturaPorPeso) {
            // FATURAÃ‡ÃƒO POR PESO Ã— â‚¬/TON
            linha.querySelector('[data-field="peso"]').value = peso;
            linha.querySelector('[data-field="precoTon"]').value = precoTon;
            
            // Calcular valor automaticamente
            calcularValorLinha(linhaCount);
          } else {
            // FATURAÃ‡ÃƒO POR LDM + VALOR FIXO ou PREÃ‡O DIRETO
            linha.querySelector('[data-field="peso"]').value = peso || '';
            linha.querySelector('[data-field="precoTon"]').value = '';
            
            // Preencher valor directamente
            const valorInput = linha.querySelector('[data-field="valor"]');
            const valorFinal = valorFixo || preco || 0;
            valorInput.value = valorFinal;
            valorInput.readOnly = false;
            valorInput.style.background = '#fef9c3'; // Fundo amarelo (editÃ¡vel)
          }
          
          atualizarIVALinha(linhaCount);
        });
        
        // Guardar referÃªncia das reservas para marcar como faturadas depois
        document.getElementById('faturaId').dataset.reservas = JSON.stringify(reservasSelecionadas);
        
        atualizarTotaisFatura();
        
        console.log('âœ… Linhas criadas:', document.querySelectorAll('#linhasFatura .excel-row').length);
      }, 100); // Pequeno delay para garantir que o modal estÃ¡ carregado
    }
    
    // â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    // â•‘                                                                                          â•‘
    // â•‘   ğŸ” MÃ“DULO DE CONTROLO DE FATURAÃ‡ÃƒO v1.0 (22/12/2024)                                   â•‘
    // â•‘                                                                                          â•‘
    // â•‘   Listagem de controlo que mostra TODAS as reservas e o seu estado de faturaÃ§Ã£o.         â•‘
    // â•‘   Permite verificar rapidamente se alguma reserva nÃ£o foi faturada.                      â•‘
    // â•‘                                                                                          â•‘
    // â•‘   FUNCIONALIDADES:                                                                       â•‘
    // â•‘   â€¢ CabeÃ§alho azul escuro fixo com: NÂº RESERVA | NÂº FATURA | CLIENTE | VALOR             â•‘
    // â•‘   â€¢ NÂº Reserva clicÃ¡vel â†’ abre a reserva                                                 â•‘
    // â•‘   â€¢ NÂº Fatura clicÃ¡vel â†’ abre a fatura                                                   â•‘
    // â•‘   â€¢ Cliente clicÃ¡vel â†’ abre a ficha do cliente                                           â•‘
    // â•‘   â€¢ Filtros por estado, cliente, data e pesquisa                                         â•‘
    // â•‘   â€¢ EstatÃ­sticas em tempo real                                                           â•‘
    // â•‘   â€¢ ExportaÃ§Ã£o para Excel                                                                â•‘
    // â•‘                                                                                          â•‘
    // â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    /**
     * Renderiza a listagem de Controlo de FaturaÃ§Ã£o
     */
    function renderizarControloFaturacao() {
      console.log('ğŸ” renderizarControloFaturacao() - InÃ­cio');
      
      const tbody = document.getElementById('tbodyControloFaturacao');
      if (!tbody) {
        console.error('Elemento tbodyControloFaturacao nÃ£o encontrado!');
        return;
      }
      
      // Obter TODAS as reservas (tanto de localStorage como da variÃ¡vel global)
      let todasReservas = [];
      
      // 1. Reservas executadas (prÃ©-faturaÃ§Ã£o)
      try {
        const reservasExec = JSON.parse(localStorage.getItem('erpReservasExecutadas') || '[]');
        todasReservas = [...todasReservas, ...reservasExec];
      } catch (e) {
        console.warn('Erro ao carregar reservas executadas:', e);
      }
      
      // 2. Reservas normais (mÃ³dulo de reservas)
      try {
        const reservasNormais = JSON.parse(localStorage.getItem('erpReservas') || '[]');
        // Adicionar apenas as que nÃ£o estÃ£o jÃ¡ na lista
        reservasNormais.forEach(r => {
          if (!todasReservas.find(tr => tr.id === r.id || tr.numero === r.numero)) {
            todasReservas.push(r);
          }
        });
      } catch (e) {
        console.warn('Erro ao carregar reservas normais:', e);
      }
      
      // 3. Da variÃ¡vel global 'reservas' se existir
      if (typeof reservas !== 'undefined' && Array.isArray(reservas)) {
        reservas.forEach(r => {
          if (!todasReservas.find(tr => tr.id === r.id || tr.numero === r.numero)) {
            todasReservas.push(r);
          }
        });
      }
      
      console.log('ğŸ“Š Total de reservas encontradas:', todasReservas.length);
      
      // Preencher dropdown de clientes
      preencherDropdownClientesControlo(todasReservas);
      
      // Aplicar filtros
      let reservasFiltradas = filtrarReservasControlo(todasReservas);
      
      // Calcular estatÃ­sticas - CORREÃ‡ÃƒO v6.19: verificar CMR anexado corretamente
      const totalReservas = todasReservas.length;
      const faturadas = todasReservas.filter(r => r.faturada || r.faturaNumero || r.numero_fatura).length;
      
      // Verificar se CMR Carga foi REALMENTE anexado
      const temCMRCargaReal = (r) => r.cmrCargaAnexado === true || (r.cmrCarga && r.cmrCarga.includes('.'));
      
      const pendentes = todasReservas.filter(r => {
        const naoFaturada = !r.faturada && !r.faturaNumero && !r.numero_fatura;
        const temCMR = temCMRCargaReal(r);
        return naoFaturada && temCMR;
      }).length;
      
      const semCMR = todasReservas.filter(r => !temCMRCargaReal(r)).length;
      
      // Atualizar estatÃ­sticas
      document.getElementById('ctrlTotalReservas').textContent = totalReservas;
      document.getElementById('ctrlFaturadas').textContent = faturadas;
      document.getElementById('ctrlPendentes').textContent = pendentes;
      document.getElementById('ctrlSemCMR').textContent = semCMR;
      
      // Renderizar tabela
      if (reservasFiltradas.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" class="text-center text-slate-500 py-8">Nenhuma reserva encontrada</td></tr>';
        return;
      }
      
      // Ordenar por data (mais recentes primeiro)
      reservasFiltradas.sort((a, b) => {
        const dataA = a.dataExecucao || a.data_abertura || a.data || '';
        const dataB = b.dataExecucao || b.data_abertura || b.data || '';
        return dataB.localeCompare(dataA);
      });
      
      tbody.innerHTML = reservasFiltradas.map(r => {
        // Obter dados da reserva
        const numReserva = r.numero || r.numero_reserva || `RES-${r.id}`;
        const numFatura = r.faturaNumero || r.numero_fatura || '-';
        const nomeCliente = r.cliente || r.nome_cliente || 'Desconhecido';
        const clienteId = r.clienteId || r.cliente_id || null;
        
        // Calcular valor
        let valor = 0;
        if (r.valorFixo) {
          valor = parseFloat(r.valorFixo) || 0;
        } else if (r.pesoCarga && r.precoTon) {
          valor = (parseFloat(r.pesoCarga) / 1000) * parseFloat(r.precoTon);
        } else if (r.preco) {
          valor = parseFloat(r.preco) || 0;
        } else if (r.valor) {
          valor = parseFloat(r.valor) || 0;
        }
        
        // Determinar estado
        let estado = '';
        let estadoClass = '';
        const temFatura = r.faturada || r.faturaNumero || r.numero_fatura;
        
        // CORREÃ‡ÃƒO v6.19: Verificar se CMR foi REALMENTE anexado (ficheiro)
        const temCMRCarga = r.cmrCargaAnexado === true || 
                          (r.cmrCarga && r.cmrCarga.includes('.'));  // Tem extensÃ£o de ficheiro
        const temCMRDescarga = r.cmrDescargaAnexado === true || 
                              (r.cmrDescarga && r.cmrDescarga.includes('.'));  // Tem extensÃ£o de ficheiro
        
        if (temFatura) {
          estado = 'âœ… Faturada';
          estadoClass = 'bg-green-100 text-green-800';
        } else if (temCMRCarga) {
          estado = 'â³ Pendente';
          estadoClass = 'bg-amber-100 text-amber-800';
        } else {
          estado = 'âŒ Sem CMR';
          estadoClass = 'bg-red-100 text-red-800';
        }
        
        // CMR de Carga
        const cmrCargaDisplay = temCMRCarga ? 'âœ…' : 'âŒ';
        
        // CMR de Descarga
        const cmrDescargaDisplay = temCMRDescarga ? 'âœ…' : 'âŒ';
        
        // Email Enviado - verificar se existe registo de envio
        // O email sÃ³ Ã© enviado quando: FATURA + CMR DESCARGA
        const emailEnviado = r.emailEnviado || (temFatura && temCMRDescarga && r.emailEnviadoData);
        const emailDisplay = emailEnviado ? 'âœ…' : 'âŒ';
        
        // Data
        const data = r.dataExecucao || r.data_abertura || r.dataAbertura || r.data || '-';
        const dataFormatada = data !== '-' ? formatDate(data) : '-';
        
        return `
          <tr style="border-bottom: 1px solid #e2e8f0;">
            <td style="padding: 10px 12px;">
              <span class="cursor-pointer text-blue-600 hover:underline font-mono font-semibold" 
                    onclick="abrirReservaDoControlo('${numReserva}', ${r.id})" 
                    title="Clique para abrir a reserva">
                ${numReserva}
              </span>
            </td>
            <td style="padding: 10px 12px;">
              ${numFatura !== '-' 
                ? `<span class="cursor-pointer text-green-600 hover:underline font-mono font-semibold" 
                         onclick="abrirFaturaDoControlo('${numFatura}')" 
                         title="Clique para ver a fatura">
                    ${numFatura}
                   </span>`
                : `<span class="text-slate-400">-</span>`
              }
            </td>
            <td style="padding: 10px 12px;">
              <span class="cursor-pointer text-blue-600 hover:underline" 
                     onclick="abrirFichaClienteDoControlo('${clienteId || nomeCliente}')" 
                     title="Clique para abrir a ficha do cliente">
                  ${nomeCliente}
               </span>
            </td>
            <td style="padding: 10px 12px; text-align: right; font-weight: 600;">
              ${formatCurrency(valor)}
            </td>
            <td style="padding: 10px 12px; text-align: center;">
              <span class="px-2 py-1 rounded text-xs font-semibold ${estadoClass}">${estado}</span>
            </td>
            <td style="padding: 10px 8px; text-align: center; font-size: 18px;" title="${temCMRCarga ? 'CMR Carga recebido' : 'CMR Carga em falta'}">
              ${cmrCargaDisplay}
            </td>
            <td style="padding: 10px 8px; text-align: center; font-size: 18px;" title="${temCMRDescarga ? 'CMR Descarga recebido' : 'CMR Descarga em falta'}">
              ${cmrDescargaDisplay}
            </td>
            <td style="padding: 10px 8px; text-align: center; font-size: 18px;" title="${emailEnviado ? 'Email enviado ao cliente' : 'Email nÃ£o enviado (aguarda fatura + CMR descarga)'}">
              ${emailDisplay}
            </td>
            <td style="padding: 10px 12px; text-align: center; font-size: 12px; color: #64748b;">
              ${dataFormatada}
            </td>
          </tr>
        `;
      }).join('');
      
      console.log('ğŸ” renderizarControloFaturacao() - ConcluÃ­do:', reservasFiltradas.length, 'reservas');
    }
    
    /**
     * Preenche o dropdown de clientes no filtro
     */
    function preencherDropdownClientesControlo(reservas) {
      const select = document.getElementById('filtroCtrlCliente');
      if (!select) return;
      
      // Obter clientes Ãºnicos
      const clientesUnicos = [...new Set(reservas.map(r => r.cliente || r.nome_cliente).filter(c => c))];
      clientesUnicos.sort();
      
      // Manter o valor selecionado
      const valorAtual = select.value;
      
      // Limpar e preencher
      select.innerHTML = '<option value="">Todos os Clientes</option>';
      clientesUnicos.forEach(cliente => {
        select.innerHTML += `<option value="${cliente}">${cliente}</option>`;
      });
      
      // Restaurar valor
      select.value = valorAtual;
    }
    
    /**
     * Filtra as reservas conforme os filtros selecionados
     */
    function filtrarReservasControlo(reservas) {
      const filtroEstado = document.getElementById('filtroCtrlEstado')?.value || '';
      const filtroCliente = document.getElementById('filtroCtrlCliente')?.value || '';
      const filtroDataDe = document.getElementById('filtroCtrlDataDe')?.value || '';
      const filtroDataAte = document.getElementById('filtroCtrlDataAte')?.value || '';
      const filtroPesquisa = document.getElementById('filtroCtrlPesquisa')?.value?.toLowerCase() || '';
      
      return reservas.filter(r => {
        // Filtro por estado - CORREÃ‡ÃƒO v6.19: verificar CMR anexado corretamente
        if (filtroEstado) {
          const temFatura = r.faturada || r.faturaNumero || r.numero_fatura;
          const temCMR = r.cmrCargaAnexado === true || (r.cmrCarga && r.cmrCarga.includes('.'));
          
          if (filtroEstado === 'faturada' && !temFatura) return false;
          if (filtroEstado === 'pendente' && (temFatura || !temCMR)) return false;
          if (filtroEstado === 'semcmr' && temCMR) return false;
        }
        
        // Filtro por cliente
        if (filtroCliente) {
          const cliente = r.cliente || r.nome_cliente || '';
          if (cliente !== filtroCliente) return false;
        }
        
        // Filtro por data
        const data = r.dataExecucao || r.data_abertura || r.data || '';
        if (filtroDataDe && data < filtroDataDe) return false;
        if (filtroDataAte && data > filtroDataAte) return false;
        
        // Filtro por pesquisa
        if (filtroPesquisa) {
          const numReserva = (r.numero || r.numero_reserva || '').toLowerCase();
          const numFatura = (r.faturaNumero || r.numero_fatura || '').toLowerCase();
          const cliente = (r.cliente || r.nome_cliente || '').toLowerCase();
          const cmr = (r.cmrCarga || r.cmr_carga || '').toLowerCase();
          
          if (!numReserva.includes(filtroPesquisa) && 
              !numFatura.includes(filtroPesquisa) && 
              !cliente.includes(filtroPesquisa) &&
              !cmr.includes(filtroPesquisa)) {
            return false;
          }
        }
        
        return true;
      });
    }
    
    /**
     * Aplica os filtros e re-renderiza a listagem
     */
    function filtrarControloFaturacao() {
      renderizarControloFaturacao();
    }
    
    /**
     * Limpa todos os filtros do Controlo de FaturaÃ§Ã£o
     */
    function limparFiltrosControlo() {
      const filtroEstado = document.getElementById('filtroCtrlEstado');
      const filtroCliente = document.getElementById('filtroCtrlCliente');
      const filtroDataDe = document.getElementById('filtroCtrlDataDe');
      const filtroDataAte = document.getElementById('filtroCtrlDataAte');
      const filtroPesquisa = document.getElementById('filtroCtrlPesquisa');
      
      if (filtroEstado) filtroEstado.value = '';
      if (filtroCliente) filtroCliente.value = '';
      if (filtroDataDe) filtroDataDe.value = '';
      if (filtroDataAte) filtroDataAte.value = '';
      if (filtroPesquisa) filtroPesquisa.value = '';
      
      renderizarControloFaturacao();
    }
    
    /**
     * Abre uma reserva a partir do Controlo de FaturaÃ§Ã£o
     */
    function abrirReservaDoControlo(numReserva, reservaId) {
      console.log('ğŸ“‹ Abrindo reserva:', numReserva, 'ID:', reservaId);
      
      // Tentar encontrar a reserva
      let reserva = null;
      
      // Procurar nas reservas executadas
      try {
        const reservasExec = JSON.parse(localStorage.getItem('erpReservasExecutadas') || '[]');
        reserva = reservasExec.find(r => r.id === reservaId || r.numero === numReserva);
      } catch (e) {}
      
      // Procurar nas reservas normais
      if (!reserva) {
        try {
          const reservasNormais = JSON.parse(localStorage.getItem('erpReservas') || '[]');
          reserva = reservasNormais.find(r => r.id === reservaId || r.numero === numReserva || r.numero_reserva === numReserva);
        } catch (e) {}
      }
      
      // Procurar na variÃ¡vel global
      if (!reserva && typeof reservas !== 'undefined' && Array.isArray(reservas)) {
        reserva = reservas.find(r => r.id === reservaId || r.numero === numReserva);
      }
      
      if (reserva) {
        // Navegar para a pÃ¡gina de reservas
        navegarPara('reservas');
        
        // Aguardar um momento para a pÃ¡gina carregar e entÃ£o abrir a reserva
        setTimeout(() => {
          if (typeof preencherReservaNoFormulario === 'function') {
            preencherReservaNoFormulario(reserva);
          } else if (typeof abrirReserva === 'function') {
            abrirReserva(reserva.id);
          } else {
            alert(`ğŸ“‹ Reserva: ${numReserva}\n\nCliente: ${reserva.cliente || reserva.nome_cliente}\nLocal Carga: ${reserva.localCarga || '-'}\nLocal Descarga: ${reserva.localDescarga || '-'}`);
          }
        }, 300);
      } else {
        alert(`âš ï¸ Reserva ${numReserva} nÃ£o encontrada.`);
      }
    }
    
    /**
     * Abre uma fatura a partir do Controlo de FaturaÃ§Ã£o
     */
    function abrirFaturaDoControlo(numFatura) {
      console.log('ğŸ“„ Abrindo fatura:', numFatura);
      
      // Encontrar a fatura
      const fatura = faturas.find(f => f.numero === numFatura);
      
      if (fatura) {
        // Usar a funÃ§Ã£o existente para ver a fatura
        if (typeof verFatura === 'function') {
          verFatura(fatura.id);
        } else {
          alert(`ğŸ“„ Fatura: ${numFatura}\n\nCliente: ${fatura.cliente || fatura.clienteNome}\nValor: ${formatCurrency(fatura.total)}\nEstado: ${fatura.estado}`);
        }
      } else {
        // Tentar navegar para a pÃ¡gina de faturas e pesquisar
        navegarPara('faturas');
        setTimeout(() => {
          const filtroPesquisa = document.getElementById('filtroNumero');
          if (filtroPesquisa) {
            filtroPesquisa.value = numFatura;
            if (typeof filtrarFaturas === 'function') {
              filtrarFaturas();
            }
          }
        }, 300);
      }
    }
    
    /**
     * Abre a ficha de um cliente a partir do Controlo de FaturaÃ§Ã£o
     * CORREÃ‡ÃƒO v6.34: Procura tambÃ©m por nome do cliente
     */
    function abrirFichaClienteDoControlo(clienteIdOuNome) {
      console.log('ğŸ‘¤ Abrindo ficha do cliente:', clienteIdOuNome);
      
      // Se nÃ£o tem identificador vÃ¡lido
      if (!clienteIdOuNome || clienteIdOuNome === 'null' || clienteIdOuNome === 'undefined' || clienteIdOuNome === 'Desconhecido') {
        alert('âš ï¸ NÃ£o foi possÃ­vel identificar o cliente desta reserva.');
        return;
      }
      
      // Encontrar o cliente por ID, nÃºmero ou nome
      let cliente = null;
      
      // 1. Procurar em clientesLista (mÃ³dulo clientes)
      if (typeof clientesLista !== 'undefined' && clientesLista.length > 0) {
        cliente = clientesLista.find(c => 
          c.id === clienteIdOuNome || 
          c.numero === clienteIdOuNome ||
          c.id === parseInt(clienteIdOuNome) ||
          c.numero === String(clienteIdOuNome) ||
          c.nome_completo === clienteIdOuNome ||
          (c.nome_completo && c.nome_completo.toLowerCase().includes(clienteIdOuNome.toLowerCase()))
        );
        if (cliente) {
          console.log('âœ… Cliente encontrado em clientesLista:', cliente.nome_completo || cliente.nome);
        }
      }
      
      // 2. Procurar em clientes (mÃ³dulo faturaÃ§Ã£o)
      if (!cliente && typeof clientes !== 'undefined' && clientes.length > 0) {
        cliente = clientes.find(c => 
          c.id === clienteIdOuNome || 
          c.numero === clienteIdOuNome ||
          c.id === parseInt(clienteIdOuNome) ||
          c.nome === clienteIdOuNome ||
          (c.nome && c.nome.toLowerCase().includes(clienteIdOuNome.toLowerCase()))
        );
        if (cliente) {
          console.log('âœ… Cliente encontrado em clientes:', cliente.nome_completo || cliente.nome);
        }
      }
      
      // 3. Procurar no localStorage
      if (!cliente) {
        try {
          const dadosClientes = localStorage.getItem('erpClientes');
          if (dadosClientes) {
            const parsed = JSON.parse(dadosClientes);
            const listaClientes = Array.isArray(parsed) ? parsed : (parsed.clientes || parsed.lista || []);
            cliente = listaClientes.find(c => 
              c.id === clienteIdOuNome || 
              c.numero === clienteIdOuNome ||
              c.numero === String(clienteIdOuNome) ||
              c.nome_completo === clienteIdOuNome ||
              (c.nome_completo && c.nome_completo.toLowerCase().includes(clienteIdOuNome.toLowerCase()))
            );
            if (cliente) {
              console.log('âœ… Cliente encontrado em localStorage:', cliente.nome_completo || cliente.nome);
            }
          }
        } catch (e) {
          console.warn('Erro ao procurar cliente no localStorage:', e);
        }
      }
      
      if (cliente) {
        // Navegar para clientes e abrir ficha
        navegarPara('clientes');
        setTimeout(() => {
          // CORREÃ‡ÃƒO v6.34: Usar clientesVerFichaCompleta que abre a ficha real
          if (typeof clientesVerFichaCompleta === 'function' && cliente.numero) {
            console.log('ğŸ“‚ Abrindo ficha completa para:', cliente.numero);
            clientesVerFichaCompleta(cliente.numero);
          } else if (typeof clientesVerFicha === 'function') {
            const idx = clientesLista.findIndex(c => c.numero === cliente.numero || c.id === cliente.id);
            if (idx !== -1) {
              clientesVerFicha(idx);
            }
          } else {
            // Fallback: Clicar na linha da tabela
            const linhas = document.querySelectorAll('#clientes-tabela-corpo tr');
            linhas.forEach(tr => {
              const firstCell = tr.querySelector('td');
              if (firstCell && firstCell.textContent.includes(cliente.numero)) {
                const btnVer = tr.querySelector('button[onclick*="clientesVerFichaCompleta"]');
                if (btnVer) btnVer.click();
              }
            });
          }
        }, 400);
      } else {
        alert(`âš ï¸ Cliente nÃ£o encontrado!\n\nIdentificador: ${clienteIdOuNome}\n\nO cliente pode nÃ£o existir na base de dados.`);
      }
    }
    
    /**
     * Exporta o Controlo de FaturaÃ§Ã£o para Excel/CSV
     */
    function exportarControloFaturacao() {
      console.log('ğŸ“¥ Exportando Controlo de FaturaÃ§Ã£o...');
      
      // Obter todas as reservas
      let todasReservas = [];
      
      try {
        const reservasExec = JSON.parse(localStorage.getItem('erpReservasExecutadas') || '[]');
        todasReservas = [...reservasExec];
      } catch (e) {}
      
      try {
        const reservasNormais = JSON.parse(localStorage.getItem('erpReservas') || '[]');
        reservasNormais.forEach(r => {
          if (!todasReservas.find(tr => tr.id === r.id || tr.numero === r.numero)) {
            todasReservas.push(r);
          }
        });
      } catch (e) {}
      
      if (typeof reservas !== 'undefined' && Array.isArray(reservas)) {
        reservas.forEach(r => {
          if (!todasReservas.find(tr => tr.id === r.id || tr.numero === r.numero)) {
            todasReservas.push(r);
          }
        });
      }
      
      // Aplicar filtros atuais
      const reservasFiltradas = filtrarReservasControlo(todasReservas);
      
      // Criar CSV com todas as colunas
      let csv = 'NÂº Reserva;NÂº Fatura;Cliente;Valor;Estado;CMR Carga;CMR Descarga;Email Enviado;Data\n';
      
      reservasFiltradas.forEach(r => {
        const numReserva = r.numero || r.numero_reserva || `RES-${r.id}`;
        const numFatura = r.faturaNumero || r.numero_fatura || '-';
        const nomeCliente = r.cliente || r.nome_cliente || 'Desconhecido';
        
        let valor = 0;
        if (r.valorFixo) valor = parseFloat(r.valorFixo) || 0;
        else if (r.pesoCarga && r.precoTon) valor = (parseFloat(r.pesoCarga) / 1000) * parseFloat(r.precoTon);
        else if (r.preco) valor = parseFloat(r.preco) || 0;
        else if (r.valor) valor = parseFloat(r.valor) || 0;
        
        const temFatura = r.faturada || r.faturaNumero || r.numero_fatura;
        // CORREÃ‡ÃƒO v6.19: verificar CMR anexado corretamente
        const temCMRCarga = r.cmrCargaAnexado === true || (r.cmrCarga && r.cmrCarga.includes('.'));
        const temCMRDescarga = r.cmrDescargaAnexado === true || (r.cmrDescarga && r.cmrDescarga.includes('.'));
        const emailEnviado = r.emailEnviado || (temFatura && temCMRDescarga && r.emailEnviadoData);
        
        let estado = temFatura ? 'Faturada' : (temCMRCarga ? 'Pendente' : 'Sem CMR');
        
        const cmrCargaStatus = temCMRCarga ? 'Sim' : 'NÃ£o';
        const cmrDescargaStatus = temCMRDescarga ? 'Sim' : 'NÃ£o';
        const emailStatus = emailEnviado ? 'Sim' : 'NÃ£o';
        const data = r.dataExecucao || r.data_abertura || r.dataAbertura || r.data || '-';
        
        csv += `${numReserva};${numFatura};${nomeCliente};${valor.toFixed(2)};${estado};${cmrCargaStatus};${cmrDescargaStatus};${emailStatus};${data}\n`;
      });
      
      // Download
      const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `controlo_faturacao_${new Date().toISOString().split('T')[0]}.csv`;
      link.click();
      
      alert(`âœ… ExportaÃ§Ã£o concluÃ­da!\n\n${reservasFiltradas.length} reservas exportadas.`);
    }
    
    // â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    // â•‘                                                                                          â•‘
    // â•‘   ğŸ”’ SECÃ‡ÃƒO BLOQUEADA - NOTAS DE CRÃ‰DITO                                                 â•‘
    // â•‘                                                                                          â•‘
    // â•‘   Esta secÃ§Ã£o contÃ©m todas as funÃ§Ãµes do mÃ³dulo de Notas de CrÃ©dito.                     â•‘
    // â•‘   NÃƒO ALTERAR sem autorizaÃ§Ã£o - funcionalidades validadas e testadas.                    â•‘
    // â•‘                                                                                          â•‘
    // â•‘   FUNCIONALIDADES IMPLEMENTADAS:                                                         â•‘
    // â•‘   â€¢ Motor de busca global (campo superior direito)                                       â•‘
    // â•‘   â€¢ Motor de busca especÃ­fico (6 filtros na pÃ¡gina)                                      â•‘
    // â•‘   â€¢ DetecÃ§Ã£o automÃ¡tica de IVA das faturas                                               â•‘
    // â•‘   â€¢ Bloqueio de IVA quando fatura nÃ£o tem IVA                                            â•‘
    // â•‘   â€¢ Campos manuais para clientes sem faturas em aberto                                   â•‘
    // â•‘   â€¢ Carregamento automÃ¡tico de reservas das faturas                                      â•‘
    // â•‘   â€¢ ValidaÃ§Ã£o de valores (NC nÃ£o pode exceder total faturas)                             â•‘
    // â•‘   â€¢ Preview e emissÃ£o de NC                                                              â•‘
    // â•‘   â€¢ GestÃ£o de motivos personalizados                                                     â•‘
    // â•‘                                                                                          â•‘
    // â•‘   REGRAS DE IVA:                                                                         â•‘
    // â•‘   â€¢ Desconto comercial/pronto pagamento â†’ 0% (bloqueado)                                 â•‘
    // â•‘   â€¢ Fatura SEM IVA â†’ 0% (bloqueado)                                                      â•‘
    // â•‘   â€¢ Fatura COM IVA â†’ Taxa detectada (bloqueado)                                          â•‘
    // â•‘   â€¢ Sem fatura (manual) â†’ Escolha livre (desbloqueado)                                   â•‘
    // â•‘                                                                                          â•‘
    // â•‘   FUNÃ‡Ã•ES PRINCIPAIS:                                                                    â•‘
    // â•‘   â€¢ renderizarNotasCredito()      â†’ Lista NC com filtros                                 â•‘
    // â•‘   â€¢ filtrarNotasCredito()         â†’ Aplicar filtros                                      â•‘
    // â•‘   â€¢ abrirNovaNC()                 â†’ Modal nova NC                                        â•‘
    // â•‘   â€¢ seleccionarClienteNC()        â†’ Seleccionar cliente                                  â•‘
    // â•‘   â€¢ carregarFaturasClienteNC()    â†’ Carregar faturas do cliente                          â•‘
    // â•‘   â€¢ actualizarTotaisFaturasNC()   â†’ Calcular totais e detectar IVA                       â•‘
    // â•‘   â€¢ verificarMotivoNC()           â†’ Validar motivo e configurar IVA                      â•‘
    // â•‘   â€¢ calcularTotaisNC()            â†’ Calcular valor final NC                              â•‘
    // â•‘   â€¢ previewNC()                   â†’ Gerar preview documento                              â•‘
    // â•‘   â€¢ emitirNC()                    â†’ Emitir NC final                                      â•‘
    // â•‘   â€¢ verificarFaturasEmAbertoNC()  â†’ Detectar modo manual                                 â•‘
    // â•‘   â€¢ reporNCTeste()                â†’ Criar NC de teste                                    â•‘
    // â•‘                                                                                          â•‘
    // â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    // ğŸ”’ FUNÃ‡ÃƒO BLOQUEADA - renderizarNotasCredito (lista NC com filtros globais e especÃ­ficos)
    function renderizarNotasCredito() {
      console.log('renderizarNotasCredito() chamada - notasCredito:', notasCredito.length);
      const tbody = document.getElementById('tabelaNC');
      if (!tbody) {
        console.error('Elemento tabelaNC nÃ£o encontrado!');
        return;
      }
      
      // Aplicar filtros
      let ncFiltradas = [...notasCredito];
      
      // PESQUISA GLOBAL (campo superior direito)
      if (termoPesquisaGlobal && termoPesquisaGlobal.length >= 2) {
        ncFiltradas = ncFiltradas.filter(nc => 
          (nc.numero && nc.numero.toLowerCase().includes(termoPesquisaGlobal)) ||
          (nc.cliente && nc.cliente.toLowerCase().includes(termoPesquisaGlobal)) ||
          (nc.faturaRef && nc.faturaRef.toLowerCase().includes(termoPesquisaGlobal)) ||
          (nc.motivo && nc.motivo.toLowerCase().includes(termoPesquisaGlobal)) ||
          (nc.nif && nc.nif.toLowerCase().includes(termoPesquisaGlobal))
        );
        console.log('Pesquisa global:', termoPesquisaGlobal, '- encontradas:', ncFiltradas.length);
      }
      
      // FILTROS ESPECÃFICOS (campos na pÃ¡gina)
      const filtroNumero = document.getElementById('filtroNCNumero')?.value?.toLowerCase() || '';
      const filtroCliente = document.getElementById('filtroNCCliente')?.value?.toLowerCase() || '';
      const filtroFatura = document.getElementById('filtroNCFatura')?.value?.toLowerCase() || '';
      const filtroMotivo = document.getElementById('filtroNCMotivo')?.value || '';
      const filtroDataDe = document.getElementById('filtroNCDataDe')?.value || '';
      const filtroDataAte = document.getElementById('filtroNCDataAte')?.value || '';
      
      console.log('Filtros:', {filtroNumero, filtroCliente, filtroFatura, filtroMotivo, filtroDataDe, filtroDataAte});
      
      if (filtroNumero) {
        ncFiltradas = ncFiltradas.filter(nc => nc.numero && nc.numero.toLowerCase().includes(filtroNumero));
      }
      
      if (filtroCliente) {
        ncFiltradas = ncFiltradas.filter(nc => nc.cliente && nc.cliente.toLowerCase().includes(filtroCliente));
      }
      
      if (filtroFatura) {
        ncFiltradas = ncFiltradas.filter(nc => (nc.faturaRef || '').toLowerCase().includes(filtroFatura));
      }
      
      if (filtroMotivo) {
        ncFiltradas = ncFiltradas.filter(nc => nc.motivo && nc.motivo.toLowerCase().includes(filtroMotivo.toLowerCase()));
      }
      
      if (filtroDataDe) {
        ncFiltradas = ncFiltradas.filter(nc => nc.data >= filtroDataDe);
      }
      
      if (filtroDataAte) {
        ncFiltradas = ncFiltradas.filter(nc => nc.data <= filtroDataAte);
      }
      
      console.log('NC filtradas:', ncFiltradas.length);
      
      // Actualizar contador
      const contador = document.getElementById('contadorNC');
      if (contador) {
        contador.textContent = `${ncFiltradas.length} de ${notasCredito.length} NC`;
      }
      
      if (ncFiltradas.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center text-slate-500 py-8">Nenhuma nota de crÃ©dito encontrada</td></tr>';
        return;
      }
      
      tbody.innerHTML = ncFiltradas.map(nc => `
        <tr>
          <td class="font-mono font-semibold text-red-600">${nc.numero}</td>
          <td>${formatDate(nc.data)}</td>
          <td class="font-mono">${nc.faturaRef || '-'}</td>
          <td>
            <span class="cursor-pointer text-blue-600 hover:underline" onclick="abrirFichaCliente(${nc.clienteId})">${nc.cliente}</span>
          </td>
          <td><span class="text-xs">${nc.motivo}</span></td>
          <td class="font-bold text-red-600">-${formatCurrency(nc.total)}</td>
          <td><span class="badge ${nc.estado === 'Emitida' ? 'badge-success' : 'badge-warning'}">${nc.estado}</span></td>
          <td>
            <button onclick="verNotaCredito(${nc.id})" class="text-blue-600 hover:underline text-sm">Ver</button>
            <button onclick="imprimirNotaCredito(${nc.id})" class="text-slate-600 hover:underline text-sm ml-2">PDF</button>
          </td>
        </tr>
      `).join('');
      
      // Actualizar indicador de permissÃ£o
      actualizarIndicadoresPermissao();
    }
    
    // ğŸ”’ FUNÃ‡ÃƒO BLOQUEADA - filtrarNotasCredito
    function filtrarNotasCredito() {
      console.log('ğŸ” filtrarNotasCredito() chamada');
      console.log('   notasCredito.length:', notasCredito.length);
      renderizarNotasCredito();
    }
    
    // ğŸ”’ FUNÃ‡ÃƒO BLOQUEADA - limparFiltrosNC
    function limparFiltrosNC() {
      document.getElementById('filtroNCNumero').value = '';
      document.getElementById('filtroNCCliente').value = '';
      document.getElementById('filtroNCFatura').value = '';
      document.getElementById('filtroNCMotivo').value = '';
      document.getElementById('filtroNCDataDe').value = '';
      document.getElementById('filtroNCDataAte').value = '';
      renderizarNotasCredito();
    }
    
    // FunÃ§Ãµes globais para os filtros NC funcionarem via onclick/oninput
    window.filtrarNotasCredito = filtrarNotasCredito;
    window.renderizarNotasCredito = renderizarNotasCredito;
    window.limparFiltrosNC = limparFiltrosNC;
    
    // ğŸ”’ FUNÃ‡ÃƒO BLOQUEADA - reporNCTeste (5 NC de teste)
    function reporNCTeste() {
      if (!confirm('âš ï¸ Isto irÃ¡ repor as Notas de CrÃ©dito de teste.\n\nAs NC actuais serÃ£o substituÃ­das por dados de exemplo.\n\nContinuar?')) {
        return;
      }
      
      // Criar notas de crÃ©dito de teste
      notasCredito = [
        {
          id: 1,
          numero: 'NC 2025/1',
          data: '2025-12-10',
          faturaId: 1,
          faturaRef: 'FT 2025/1',
          clienteId: 1,
          cliente: 'Empresa Nacional Lda',
          nif: '501234567',
          morada: 'Rua do ComÃ©rcio, 123, Lisboa',
          motivo: 'Erro de faturaÃ§Ã£o',
          observacoes: 'CorrecÃ§Ã£o de valor cobrado em excesso',
          subtotal: 150.00,
          iva: 34.50,
          total: 184.50,
          taxaIVA: 23,
          estado: 'Emitida',
          linhas: [{
            descricao: 'Nota de CrÃ©dito ref. FT 2025/1 - Erro de faturaÃ§Ã£o',
            valor: 150.00,
            iva: 23
          }]
        },
        {
          id: 2,
          numero: 'NC 2025/2',
          data: '2025-12-12',
          faturaId: 2,
          faturaRef: 'FT 2025/2',
          clienteId: 2,
          cliente: 'Transport Europe SA',
          nif: 'FR12345678901',
          morada: 'Avenue des Champs, Paris',
          motivo: 'Desconto comercial',
          observacoes: 'Desconto acordado por volume',
          subtotal: 250.00,
          iva: 0,
          total: 250.00,
          taxaIVA: 0,
          estado: 'Emitida',
          linhas: [{
            descricao: 'Nota de CrÃ©dito ref. FT 2025/2 - Desconto comercial',
            valor: 250.00,
            iva: 0
          }]
        },
        {
          id: 3,
          numero: 'NC 2025/3',
          data: '2025-12-15',
          faturaId: 3,
          faturaRef: 'FT 2025/3',
          clienteId: 4,
          cliente: 'Transportes Abreu SA',
          nif: '509876543',
          morada: 'Zona Industrial, Lote 5, Porto',
          motivo: 'DiferenÃ§a de preÃ§o',
          observacoes: 'Ajuste de preÃ§o conforme tabela actualizada',
          subtotal: 85.00,
          iva: 19.55,
          total: 104.55,
          taxaIVA: 23,
          estado: 'Emitida',
          linhas: [{
            descricao: 'Nota de CrÃ©dito ref. FT 2025/3 - DiferenÃ§a de preÃ§o',
            valor: 85.00,
            iva: 23
          }]
        },
        {
          id: 4,
          numero: 'NC 2025/4',
          data: '2025-12-17',
          faturaId: 4,
          faturaRef: 'FT 2025/4',
          clienteId: 5,
          cliente: 'LogÃ­stica Silva Lda',
          nif: '506543210',
          morada: 'Av. da Liberdade, 50, Braga',
          motivo: 'DevoluÃ§Ã£o de mercadoria',
          observacoes: 'Mercadoria devolvida por defeito',
          subtotal: 320.00,
          iva: 73.60,
          total: 393.60,
          taxaIVA: 23,
          estado: 'Emitida',
          linhas: [{
            descricao: 'Nota de CrÃ©dito ref. FT 2025/4 - DevoluÃ§Ã£o de mercadoria',
            valor: 320.00,
            iva: 23
          }]
        },
        {
          id: 5,
          numero: 'NC 2025/5',
          data: '2025-12-18',
          faturaId: 5,
          faturaRef: 'FT 2025/5',
          clienteId: 3,
          cliente: 'Global Logistics UK Ltd',
          nif: 'GB123456789',
          morada: '10 Downing Street, London',
          motivo: 'AnulaÃ§Ã£o parcial',
          observacoes: 'ServiÃ§o parcialmente cancelado',
          subtotal: 500.00,
          iva: 0,
          total: 500.00,
          taxaIVA: 0,
          estado: 'Emitida',
          linhas: [{
            descricao: 'Nota de CrÃ©dito ref. FT 2025/5 - AnulaÃ§Ã£o parcial',
            valor: 500.00,
            iva: 0
          }]
        }
      ];
      
      // Actualizar sÃ©rie NC
      const serieNC = series.find(s => s.serie === 'NC');
      if (serieNC) serieNC.proxNum = 6;
      
      localStorage.setItem('erpNotasCredito', JSON.stringify(notasCredito));
      guardarDados();
      renderizarNotasCredito();
      atualizarDashboard();
      
      alert('âœ… Notas de CrÃ©dito de teste repostas!\n\nğŸ“Š 5 NC disponÃ­veis:\nâ€¢ NC 2025/1 - Erro de faturaÃ§Ã£o\nâ€¢ NC 2025/2 - Desconto comercial\nâ€¢ NC 2025/3 - DiferenÃ§a de preÃ§o\nâ€¢ NC 2025/4 - DevoluÃ§Ã£o mercadoria\nâ€¢ NC 2025/5 - AnulaÃ§Ã£o parcial');
    }
    
    // VariÃ¡vel para armazenar faturas seleccionadas para NC
    let faturasSelecionadasNC = [];
    let ncFiltroEstado = 'pendente';  // Por defeito, mostrar apenas faturas em aberto
    let ncModoManual = false; // True quando cliente nÃ£o tem faturas em aberto
    
    // VariÃ¡veis globais para IVA das faturas
    let faturasTemIVA = false;
    let taxaIVADasFaturas = 0;
    
    // Lista de motivos personalizados (podem ser adicionados pelo utilizador)
    let motivosNCPersonalizados = JSON.parse(localStorage.getItem('erpMotivosNC') || '[]');
    
    // FunÃ§Ã£o para verificar se cliente tem faturas em aberto
    // ğŸ”’ FUNÃ‡ÃƒO BLOQUEADA - verificarFaturasEmAbertoNC (detecta modo manual)
    function verificarFaturasEmAbertoNC(clienteId) {
      const faturasEmAberto = faturas.filter(f => 
        f.clienteId == clienteId && 
        f.estado !== 'Anulada' && 
        f.estado !== 'Pago'
      );
      
      ncModoManual = faturasEmAberto.length === 0;
      
      const divManual = document.getElementById('ncCamposManualDiv');
      if (divManual) {
        if (ncModoManual) {
          divManual.classList.remove('hidden');
        } else {
          divManual.classList.add('hidden');
          // Limpar campos manuais
          document.getElementById('ncFaturaManual').value = '';
          document.getElementById('ncReservaManual').value = '';
        }
      }
      
      return !ncModoManual;
    }
    
    // FunÃ§Ã£o para verificar campos manuais
    function verificarCamposManuaisNC() {
      // Apenas para feedback visual, validaÃ§Ã£o real Ã© feita no preview/emitir
      const faturaManual = document.getElementById('ncFaturaManual')?.value?.trim() || '';
      const reservaManual = document.getElementById('ncReservaManual')?.value?.trim() || '';
      
      // Preencher automaticamente campos hidden se modo manual
      if (ncModoManual && faturaManual && reservaManual) {
        calcularTotaisNC();
      }
    }
    
    // ğŸ”’ FUNÃ‡ÃƒO BLOQUEADA - abrirNovaNC (modal nova NC com reset completo)
    function abrirNovaNC() {
      // Verificar permissÃ£o
      if (!temPermissao('emitirNC')) {
        alert('â›” Acesso Negado!\n\nNÃ£o tem permissÃ£o para emitir Notas de CrÃ©dito.\n\nContacte o administrador para obter acesso.');
        return;
      }
      
      // Gerar nÃºmero da NC
      const serieNC = series.find(s => s.serie === 'NC');
      const proxNum = serieNC ? serieNC.proxNum : 1;
      const anoNC = serieNC ? serieNC.ano : new Date().getFullYear();
      document.getElementById('ncNumero').value = `NC ${anoNC}/${proxNum}`;
      document.getElementById('ncData').value = new Date().toISOString().split('T')[0];
      
      // Adicionar motivos personalizados ao dropdown
      actualizarDropdownMotivosNC();
      
      // Limpar campos
      document.getElementById('ncPesquisaCliente').value = '';
      document.getElementById('ncPesquisaFatura').value = '';
      document.getElementById('ncCliente').value = '';
      document.getElementById('ncClienteId').value = '';
      document.getElementById('ncNIF').value = '';
      document.getElementById('ncMorada').value = '';
      document.getElementById('ncMotivo').value = '';
      document.getElementById('ncMotivoManual').value = '';
      document.getElementById('ncMotivoManualDiv').style.display = 'none';
      document.getElementById('ncObservacoes').value = '';
      document.getElementById('ncValorOriginal').value = '';
      document.getElementById('ncValor').value = '';
      document.getElementById('ncPercentagem').value = '';
      document.getElementById('ncIVA').value = '23';
      document.getElementById('ncTotal').value = '';
      document.getElementById('ncListaFaturas').innerHTML = '<p class="text-slate-500 text-sm p-3 text-center">Pesquise um cliente ou fatura para comeÃ§ar</p>';
      document.getElementById('ncFaturasSelecionadas').textContent = '0 faturas selecionadas';
      document.getElementById('ncTotalFaturas').textContent = 'Total: â‚¬0,00';
      document.getElementById('ncResumoCalculo').innerHTML = '<span class="text-slate-500">Selecione faturas e preencha o valor</span>';
      document.getElementById('ncResultadosCliente').classList.add('hidden');
      document.getElementById('ncResultadosFatura').classList.add('hidden');
      
      // Reset tipo de cÃ¡lculo
      document.querySelector('input[name="ncTipoCalculo"][value="fixo"]').checked = true;
      mudarTipoCalculoNC();
      
      // Limpar selecÃ§Ã£o de faturas e reservas
      faturasSelecionadasNC = [];
      reservasSelecionadasNC = [];
      ncFiltroEstado = 'pendente';  // Por defeito, mostrar apenas faturas em aberto
      
      // Limpar campos de reservas
      document.getElementById('ncPesquisaReserva').value = '';
      document.getElementById('ncResultadosReserva').classList.add('hidden');
      document.getElementById('ncListaReservas').innerHTML = '<p class="text-slate-500 text-sm p-3 text-center">Selecione faturas para ver as reservas disponÃ­veis</p>';
      document.getElementById('ncReservasSelecionadas').textContent = '0 reservas';
      reservasDisponiveis = [];
      
      // Reset IVA
      document.getElementById('ncIVA').disabled = false;
      document.getElementById('ncAvisoIVA').classList.add('hidden');
      
      // Reset variÃ¡veis globais de IVA
      faturasTemIVA = false;
      taxaIVADasFaturas = 0;
      ncModoManual = false;
      
      // Esconder e limpar campos manuais
      const divManual = document.getElementById('ncCamposManualDiv');
      if (divManual) {
        divManual.classList.add('hidden');
      }
      const faturaManual = document.getElementById('ncFaturaManual');
      const reservaManual = document.getElementById('ncReservaManual');
      if (faturaManual) faturaManual.value = '';
      if (reservaManual) reservaManual.value = '';
      
      abrirModal('modalNotaCredito');
      
      // Configurar navegaÃ§Ã£o por teclado
      configurarNavegacaoTecladoNC();
    }
    
    // ========== NAVEGAÃ‡ÃƒO POR TECLADO NO MODAL NC ==========
    function configurarNavegacaoTecladoNC() {
      const modal = document.getElementById('modalNotaCredito');
      if (!modal) return;
      
      // Lista de campos focÃ¡veis no modal
      const camposFocaveis = [
        'ncPesquisaCliente',
        'ncPesquisaFatura', 
        'ncMotivo',
        'ncMotivoManual',
        'ncObservacoes',
        'ncValor',
        'ncPercentagem',
        'ncIVA',
        'ncPesquisaReserva'
      ];
      
      // Remover listener anterior se existir
      modal.removeEventListener('keydown', handleKeydownNC);
      
      // Adicionar novo listener
      modal.addEventListener('keydown', handleKeydownNC);
    }
    
    function handleKeydownNC(e) {
      const activeElement = document.activeElement;
      const modal = document.getElementById('modalNotaCredito');
      
      // Se nÃ£o estamos dentro do modal, ignorar
      if (!modal || !modal.contains(activeElement)) return;
      
      // Enter - avanÃ§ar para prÃ³ximo campo ou activar botÃ£o
      if (e.key === 'Enter') {
        e.preventDefault();
        
        // Se estamos num campo de texto, avanÃ§ar para o prÃ³ximo
        if (activeElement.tagName === 'INPUT' || activeElement.tagName === 'SELECT') {
          const inputs = modal.querySelectorAll('input:not([type="radio"]):not([type="checkbox"]):not([disabled]), select:not([disabled]), textarea:not([disabled])');
          const currentIndex = Array.from(inputs).indexOf(activeElement);
          if (currentIndex < inputs.length - 1) {
            inputs[currentIndex + 1].focus();
          }
        }
        return;
      }
      
      // Setas cima/baixo - navegar entre campos
      if (e.key === 'ArrowDown' || e.key === 'ArrowUp') {
        // SÃ³ interceptar se nÃ£o estivermos num select ou textarea
        if (activeElement.tagName === 'SELECT' || activeElement.tagName === 'TEXTAREA') {
          return; // Deixar comportamento normal
        }
        
        e.preventDefault();
        const inputs = modal.querySelectorAll('input:not([type="radio"]):not([type="checkbox"]):not([disabled]), select:not([disabled]), textarea:not([disabled])');
        const currentIndex = Array.from(inputs).indexOf(activeElement);
        
        if (e.key === 'ArrowDown' && currentIndex < inputs.length - 1) {
          inputs[currentIndex + 1].focus();
        } else if (e.key === 'ArrowUp' && currentIndex > 0) {
          inputs[currentIndex - 1].focus();
        }
      }
      
      // Tab - comportamento normal (jÃ¡ funciona)
    }
    
    // ========== MOTOR DE BUSCA CLIENTE ==========
    function pesquisarClienteNC() {
      const termo = document.getElementById('ncPesquisaCliente').value.toLowerCase().trim();
      const container = document.getElementById('ncResultadosCliente');
      
      if (termo.length < 2) {
        container.classList.add('hidden');
        return;
      }
      
      // Pesquisar clientes por nome ou NIF
      const resultados = clientes.filter(c => 
        c.nome.toLowerCase().includes(termo) || 
        (c.nif && c.nif.toLowerCase().includes(termo))
      ).slice(0, 10);
      
      if (resultados.length === 0) {
        container.innerHTML = '<div class="p-2 text-slate-500 text-sm">Nenhum cliente encontrado</div>';
      } else {
        container.innerHTML = resultados.map(c => {
          const numCliente = c.numeroCliente || ('C' + c.id);
          return `
            <div class="p-2 hover:bg-emerald-50 cursor-pointer border-b text-sm" onclick="seleccionarClienteNC(${c.id})">
              <span class="font-semibold">${numCliente}</span> - ${c.nome}
              <span class="text-slate-500 ml-2">(${c.nif || 'sem NIF'})</span>
            </div>
          `;
        }).join('');
      }
      container.classList.remove('hidden');
    }
    
    // ğŸ”’ FUNÃ‡ÃƒO BLOQUEADA - seleccionarClienteNC (preenche dados cliente e carrega faturas)
    function seleccionarClienteNC(clienteId) {
      const cliente = clientes.find(c => c.id === clienteId);
      if (!cliente) return;
      
      document.getElementById('ncClienteId').value = clienteId;
      document.getElementById('ncCliente').value = cliente.nome;
      document.getElementById('ncNIF').value = cliente.nif || '';
      document.getElementById('ncMorada').value = cliente.morada || cliente.sedeRua || '';
      document.getElementById('ncPesquisaCliente').value = cliente.nome;
      document.getElementById('ncResultadosCliente').classList.add('hidden');
      
      // Verificar se cliente tem faturas em aberto
      verificarFaturasEmAbertoNC(clienteId);
      
      // Carregar faturas deste cliente
      carregarFaturasClienteNC(clienteId);
    }
    
    function limparClienteNC() {
      document.getElementById('ncPesquisaCliente').value = '';
      document.getElementById('ncClienteId').value = '';
      document.getElementById('ncCliente').value = '';
      document.getElementById('ncNIF').value = '';
      document.getElementById('ncMorada').value = '';
      document.getElementById('ncResultadosCliente').classList.add('hidden');
      document.getElementById('ncListaFaturas').innerHTML = '<p class="text-slate-500 text-sm p-3 text-center">Pesquise um cliente ou fatura para comeÃ§ar</p>';
      faturasSelecionadasNC = [];
      actualizarTotaisFaturasNC();
    }
    
    // ========== MOTOR DE BUSCA FATURA ==========
    function pesquisarFaturaNC() {
      const termo = document.getElementById('ncPesquisaFatura').value.toLowerCase().trim();
      const container = document.getElementById('ncResultadosFatura');
      
      if (termo.length < 2) {
        container.classList.add('hidden');
        return;
      }
      
      // Pesquisar faturas por nÃºmero
      const resultados = faturas.filter(f => 
        f.numero.toLowerCase().includes(termo) && f.estado !== 'Anulada'
      ).slice(0, 10);
      
      if (resultados.length === 0) {
        container.innerHTML = '<div class="p-2 text-slate-500 text-sm">Nenhuma fatura encontrada</div>';
      } else {
        container.innerHTML = resultados.map(f => `
          <div class="p-2 hover:bg-blue-50 cursor-pointer border-b text-sm" onclick="adicionarFaturaNCPorId(${f.id})">
            <span class="font-mono font-semibold">${f.numero}</span> - ${f.cliente}
            <span class="ml-2 ${f.estado === 'Pago' ? 'text-green-600' : 'text-red-600'}">${formatCurrency(f.total)}</span>
            <span class="badge ${f.estado === 'Pago' ? 'badge-success' : 'badge-warning'} ml-1">${f.estado}</span>
          </div>
        `).join('');
      }
      container.classList.remove('hidden');
    }
    
    function adicionarFaturaPesquisadaNC() {
      const termo = document.getElementById('ncPesquisaFatura').value.trim();
      const fatura = faturas.find(f => f.numero.toLowerCase() === termo.toLowerCase());
      
      if (fatura) {
        adicionarFaturaNCPorId(fatura.id);
      } else {
        alert('âš ï¸ Fatura nÃ£o encontrada!');
      }
    }
    
    function adicionarFaturaNCPorId(faturaId) {
      const fatura = faturas.find(f => f.id === faturaId);
      if (!fatura) return;
      
      // Se cliente nÃ£o estÃ¡ seleccionado, seleccionar automaticamente
      const clienteIdActual = document.getElementById('ncClienteId').value;
      if (!clienteIdActual) {
        seleccionarClienteNC(fatura.clienteId);
      } else if (parseInt(clienteIdActual) !== fatura.clienteId) {
        // Cliente diferente - perguntar se quer mudar
        if (confirm(`Esta fatura pertence a outro cliente (${fatura.cliente}).\n\nDeseja mudar de cliente? As faturas actuais serÃ£o desmarcadas.`)) {
          faturasSelecionadasNC = [];
          seleccionarClienteNC(fatura.clienteId);
        } else {
          return;
        }
      }
      
      // Adicionar fatura Ã  selecÃ§Ã£o
      if (!faturasSelecionadasNC.includes(faturaId)) {
        faturasSelecionadasNC.push(faturaId);
        renderizarListaFaturasNC();
        actualizarTotaisFaturasNC();
      }
      
      document.getElementById('ncPesquisaFatura').value = '';
      document.getElementById('ncResultadosFatura').classList.add('hidden');
    }
    
    // ========== LISTA DE FATURAS ==========
    // ğŸ”’ FUNÃ‡ÃƒO BLOQUEADA - carregarFaturasClienteNC (lista faturas do cliente)
    function carregarFaturasClienteNC(clienteId) {
      if (!clienteId) {
        document.getElementById('ncListaFaturas').innerHTML = '<p class="text-slate-500 text-sm p-3 text-center">Pesquise um cliente ou fatura para comeÃ§ar</p>';
        faturasSelecionadasNC = [];
        actualizarTotaisFaturasNC();
        return;
      }
      
      // Por defeito, mostrar apenas faturas em aberto
      ncFiltroEstado = 'pendente';
      renderizarListaFaturasNC();
    }
    
    function renderizarListaFaturasNC() {
      const clienteId = document.getElementById('ncClienteId').value;
      const container = document.getElementById('ncListaFaturas');
      
      if (!clienteId) {
        container.innerHTML = '<p class="text-slate-500 text-sm p-3 text-center">Pesquise um cliente ou fatura para comeÃ§ar</p>';
        return;
      }
      
      // Filtrar faturas do cliente - por defeito sÃ³ em aberto
      let faturasCliente = faturas.filter(f => f.clienteId == clienteId && f.estado !== 'Anulada');
      
      // Aplicar filtro de estado - por defeito sÃ³ pendentes
      if (ncFiltroEstado === 'pendente' || ncFiltroEstado === 'todos') {
        // Para 'pendente', mostrar apenas nÃ£o pagas
        if (ncFiltroEstado === 'pendente') {
          faturasCliente = faturasCliente.filter(f => f.estado !== 'Pago');
        }
        // Para 'todos', mostra todas
      } else if (ncFiltroEstado === 'pago') {
        faturasCliente = faturasCliente.filter(f => f.estado === 'Pago');
      }
      
      // Contar faturas em aberto para mostrar aviso
      const faturasEmAberto = faturas.filter(f => f.clienteId == clienteId && f.estado !== 'Anulada' && f.estado !== 'Pago').length;
      
      if (faturasCliente.length === 0) {
        let mensagem = 'Nenhuma fatura encontrada com este filtro';
        if (ncFiltroEstado === 'pendente' && faturasEmAberto === 0) {
          mensagem = 'âœ… Este cliente nÃ£o tem faturas em aberto. Pode emitir NC sem selecionar faturas.';
        }
        container.innerHTML = `<p class="text-slate-500 text-sm p-3 text-center">${mensagem}</p>`;
        return;
      }
      
      // Renderizar lista de faturas com checkboxes
      container.innerHTML = `
        <div class="grid grid-cols-5 gap-2 text-xs font-semibold text-slate-500 p-2 border-b bg-slate-50">
          <span>NÃºmero</span>
          <span>Data</span>
          <span class="text-right">Total</span>
          <span class="text-right">Saldo</span>
          <span>Estado</span>
        </div>
      ` + faturasCliente.map(f => {
        const saldo = f.total - (f.pago || 0);
        const isSelected = faturasSelecionadasNC.includes(f.id);
        return `
          <div class="flex items-center gap-3 p-2 border-b hover:bg-blue-50 cursor-pointer ${isSelected ? 'bg-blue-100' : ''}" onclick="toggleFaturaNC(${f.id})">
            <input type="checkbox" id="ncFat${f.id}" ${isSelected ? 'checked' : ''} class="cursor-pointer">
            <div class="flex-1 grid grid-cols-5 gap-2 text-sm">
              <span class="font-mono font-semibold">${f.numero}</span>
              <span>${formatDate(f.data)}</span>
              <span class="text-right">${formatCurrency(f.total)}</span>
              <span class="text-right ${saldo > 0 ? 'text-red-600' : 'text-green-600'}">${formatCurrency(saldo)}</span>
              <span><span class="badge ${f.estado === 'Pago' ? 'badge-success' : f.estado === 'Vencido' ? 'badge-danger' : 'badge-warning'}">${f.estado}</span></span>
            </div>
          </div>
        `;
      }).join('');
    }
    
    function filtrarFaturasNCPorEstado(estado) {
      ncFiltroEstado = estado;
      
      // Destacar botÃ£o activo
      const btnPendente = document.getElementById('btnFiltroNCPendente');
      const btnTodos = document.getElementById('btnFiltroNCTodos');
      const btnPago = document.getElementById('btnFiltroNCPago');
      
      // Reset todos os botÃµes
      btnPendente.className = 'text-xs px-2 py-1 rounded bg-slate-200 hover:bg-slate-300';
      btnTodos.className = 'text-xs px-2 py-1 rounded bg-slate-200 hover:bg-slate-300';
      btnPago.className = 'text-xs px-2 py-1 rounded bg-slate-200 hover:bg-slate-300';
      
      // Destacar o activo
      if (estado === 'pendente') {
        btnPendente.className = 'text-xs px-2 py-1 rounded bg-yellow-300 font-semibold';
      } else if (estado === 'todos') {
        btnTodos.className = 'text-xs px-2 py-1 rounded bg-blue-300 font-semibold';
      } else if (estado === 'pago') {
        btnPago.className = 'text-xs px-2 py-1 rounded bg-green-300 font-semibold';
      }
      
      renderizarListaFaturasNC();
    }
    
    function toggleFaturaNC(faturaId) {
      const index = faturasSelecionadasNC.indexOf(faturaId);
      if (index > -1) {
        faturasSelecionadasNC.splice(index, 1);
      } else {
        faturasSelecionadasNC.push(faturaId);
      }
      
      renderizarListaFaturasNC();
      actualizarTotaisFaturasNC();
    }
    
    function seleccionarTodasFaturasNC() {
      const clienteId = document.getElementById('ncClienteId').value;
      if (!clienteId) return;
      
      let faturasCliente = faturas.filter(f => f.clienteId == clienteId && f.estado !== 'Anulada');
      
      // Aplicar filtro de estado actual
      if (ncFiltroEstado === 'pendente') {
        faturasCliente = faturasCliente.filter(f => f.estado !== 'Pago');
      } else if (ncFiltroEstado === 'pago') {
        faturasCliente = faturasCliente.filter(f => f.estado === 'Pago');
      }
      
      faturasSelecionadasNC = faturasCliente.map(f => f.id);
      renderizarListaFaturasNC();
      actualizarTotaisFaturasNC();
    }
    
    function desseleccionarTodasFaturasNC() {
      faturasSelecionadasNC = [];
      renderizarListaFaturasNC();
      actualizarTotaisFaturasNC();
    }
    
    // ğŸ”’ FUNÃ‡ÃƒO BLOQUEADA - actualizarTotaisFaturasNC (calcula totais e detecta IVA das faturas)
    function actualizarTotaisFaturasNC() {
      // ========== 1. CALCULAR SOMATÃ“RIO ==========
      let somaTotal = 0;
      let somaSubtotal = 0;
      let somaIVA = 0;
      faturasTemIVA = false;
      taxaIVADasFaturas = 0;
      
      faturasSelecionadasNC.forEach(fId => {
        const f = faturas.find(x => x.id === fId);
        if (f) {
          // Somar total da fatura
          somaTotal += parseFloat(f.total) || 0;
          somaSubtotal += parseFloat(f.subtotal) || 0;
          
          // Detectar se fatura tem IVA - verificar APENAS valores reais de IVA
          const iva23 = parseFloat(f.iva23) || 0;
          const iva13 = parseFloat(f.iva13) || 0;
          const iva6 = parseFloat(f.iva6) || 0;
          const totalIVA = parseFloat(f.totalIVA) || 0;
          const ivaDirecto = parseFloat(f.iva) || 0;
          const ivaFatura = iva23 + iva13 + iva6 + totalIVA + ivaDirecto;
          
          console.log(`Fatura ${f.numero} - IVA detectado:`, {iva23, iva13, iva6, totalIVA, ivaDirecto, ivaFatura, taxaIVA: f.taxaIVA, tipoCliente: f.tipoCliente});
          
          // CORRECÃ‡ÃƒO: SÃ³ considerar que tem IVA se o VALOR do IVA for > 0
          // NÃƒO usar o campo taxaIVA porque pode estar preenchido mesmo sem IVA aplicado
          if (ivaFatura > 0) {
            faturasTemIVA = true;
            somaIVA += ivaFatura;
            // Detectar taxa predominante pelo valor real
            if (iva23 > 0) taxaIVADasFaturas = 23;
            else if (iva13 > 0) taxaIVADasFaturas = 13;
            else if (iva6 > 0) taxaIVADasFaturas = 6;
            else if (totalIVA > 0 || ivaDirecto > 0) {
              // Tentar detectar taxa pelo campo taxaIVA se existir
              if (f.taxaIVA && f.taxaIVA > 0) taxaIVADasFaturas = f.taxaIVA;
              else taxaIVADasFaturas = 23; // Default
            }
          }
          // Se nÃ£o hÃ¡ valor de IVA, NÃƒO considerar como tendo IVA
          // mesmo que taxaIVA esteja preenchido
        }
      });
      
      console.log('faturasTemIVA:', faturasTemIVA, 'taxaIVADasFaturas:', taxaIVADasFaturas);
      
      // ========== 2. ACTUALIZAR DISPLAY ==========
      document.getElementById('ncFaturasSelecionadas').textContent = 
        `${faturasSelecionadasNC.length} fatura${faturasSelecionadasNC.length !== 1 ? 's' : ''} selecionada${faturasSelecionadasNC.length !== 1 ? 's' : ''}`;
      document.getElementById('ncTotalFaturas').textContent = `Total: ${formatCurrency(somaTotal)}`;
      document.getElementById('ncValorOriginal').value = formatCurrency(somaTotal);
      
      // ========== 3. CONFIGURAR IVA - LÃ“GICA CORRECTA ==========
      const motivo = document.getElementById('ncMotivo').value;
      const motivosSemIVA = ['Desconto comercial', 'Desconto pronto pagamento'];
      const selectIVA = document.getElementById('ncIVA');
      const avisoIVA = document.getElementById('ncAvisoIVA');
      
      // REGRA 1: Desconto comercial/pronto pagamento = SEMPRE 0%
      if (motivosSemIVA.includes(motivo)) {
        selectIVA.value = '0';
        selectIVA.disabled = true;
        if (avisoIVA) {
          avisoIVA.textContent = 'âš ï¸ Desconto comercial/pronto pagamento: Nota de crÃ©dito emitida sem IVA (0%)';
          avisoIVA.classList.remove('hidden');
        }
      }
      // REGRA 2: Faturas SEM IVA = NC sem IVA (bloqueado)
      else if (faturasSelecionadasNC.length > 0 && !faturasTemIVA) {
        selectIVA.value = '0';
        selectIVA.disabled = true;
        if (avisoIVA) {
          avisoIVA.textContent = 'âš ï¸ As faturas selecionadas nÃ£o tÃªm IVA - NC serÃ¡ emitida sem IVA (0%)';
          avisoIVA.className = 'text-xs text-amber-600 mt-1';
          avisoIVA.classList.remove('hidden');
        }
      }
      // REGRA 3: Faturas COM IVA = NC com IVA da fatura (BLOQUEADO)
      else if (faturasSelecionadasNC.length > 0 && faturasTemIVA) {
        selectIVA.value = taxaIVADasFaturas.toString();
        selectIVA.disabled = true; // BLOQUEADO - IVA detectado automaticamente
        if (avisoIVA) {
          avisoIVA.textContent = `âœ“ IVA detectado das faturas: ${taxaIVADasFaturas}%`;
          avisoIVA.classList.remove('hidden');
          avisoIVA.className = 'text-xs text-green-600 mt-1';
        }
      }
      // Nenhuma fatura selecionada - permitir escolher
      else {
        selectIVA.disabled = false;
        if (avisoIVA) avisoIVA.classList.add('hidden');
      }
      
      // ========== 4. AUTO-PREENCHER VALOR ==========
      const tipoCalculo = document.querySelector('input[name="ncTipoCalculo"]:checked')?.value || 'fixo';
      if (tipoCalculo === 'total') {
        document.getElementById('ncValor').value = somaTotal.toFixed(2);
      }
      
      // ========== 5. CARREGAR RESERVAS DAS FATURAS ==========
      carregarReservasDasFaturasAuto();
      
      // ========== 6. RECALCULAR TOTAIS NC ==========
      calcularTotaisNC();
    }
    
    // ========== CARREGAR RESERVAS AUTOMATICAMENTE ==========
    function carregarReservasDasFaturasAuto() {
      // Limpar
      reservasSelecionadasNC = [];
      reservasDisponiveis = [];
      
      if (faturasSelecionadasNC.length === 0) {
        renderizarReservasDisponiveisNC();
        return;
      }
      
      // Percorrer todas as faturas seleccionadas
      faturasSelecionadasNC.forEach(fId => {
        const fatura = faturas.find(f => f.id === fId);
        if (fatura && fatura.linhas && fatura.linhas.length > 0) {
          fatura.linhas.forEach(linha => {
            let reservaEncontrada = null;
            
            // Tentar por reservaId
            if (linha.reservaId) {
              reservaEncontrada = reservas.find(r => r.id === linha.reservaId);
            }
            
            // Tentar por CMR
            if (!reservaEncontrada && linha.cmr) {
              reservaEncontrada = reservas.find(r => 
                r.cmrCarga === linha.cmr || 
                r.cmrDescarga === linha.cmr ||
                r.cmr === linha.cmr ||
                r.numero === linha.cmr
              );
            }
            
            // Tentar por refCliente
            if (!reservaEncontrada && linha.refCliente) {
              reservaEncontrada = reservas.find(r => r.refCliente === linha.refCliente);
            }
            
            // Adicionar se encontrada e nÃ£o duplicada
            if (reservaEncontrada && !reservasDisponiveis.find(r => r.id === reservaEncontrada.id)) {
              reservasDisponiveis.push(reservaEncontrada);
            }
          });
        }
      });
      
      // Se nÃ£o encontrou por linhas, buscar reservas do cliente
      if (reservasDisponiveis.length === 0) {
        const primeiraFatura = faturas.find(f => f.id === faturasSelecionadasNC[0]);
        if (primeiraFatura && primeiraFatura.clienteId) {
          const reservasCliente = reservas.filter(r => 
            r.clienteId === primeiraFatura.clienteId || 
            r.cliente === primeiraFatura.cliente
          );
          reservasDisponiveis = reservasCliente.slice(0, 20);
        }
      }
      
      // Renderizar lista
      renderizarReservasDisponiveisNC();
    }
    
    // Array para guardar reservas disponÃ­veis
    let reservasDisponiveis = [];
    
    // ========== MOTIVOS ==========
    function actualizarDropdownMotivosNC() {
      const select = document.getElementById('ncMotivo');
      const valorActual = select.value;
      
      select.innerHTML = `
        <option value="">-- Selecione o motivo --</option>
        <option value="DevoluÃ§Ã£o de mercadoria">DevoluÃ§Ã£o de mercadoria</option>
        <option value="Erro de faturaÃ§Ã£o">Erro de faturaÃ§Ã£o</option>
        <option value="Desconto comercial">Desconto comercial</option>
        <option value="Desconto pronto pagamento">Desconto pronto pagamento</option>
        <option value="Desconto volume">Desconto volume</option>
        <option value="AnulaÃ§Ã£o parcial">AnulaÃ§Ã£o parcial</option>
        <option value="AnulaÃ§Ã£o total">AnulaÃ§Ã£o total</option>
        <option value="DiferenÃ§a de preÃ§o">DiferenÃ§a de preÃ§o</option>
        <option value="Quebra de mercadoria">Quebra de mercadoria</option>
        <option value="ServiÃ§o nÃ£o prestado">ServiÃ§o nÃ£o prestado</option>
        ${motivosNCPersonalizados.map(m => `<option value="${m}">${m}</option>`).join('')}
        <option value="__outro__">âœï¸ Outro (escrever manualmente)</option>
      `;
      
      if (valorActual) select.value = valorActual;
    }
    
    // VariÃ¡vel para armazenar reservas selecionadas para NC
    let reservasSelecionadasNC = [];
    
    // ========== MOTIVO E IVA ==========
    // ğŸ”’ FUNÃ‡ÃƒO BLOQUEADA - verificarMotivoNC (configura IVA baseado no motivo e faturas)
    function verificarMotivoNC() {
      const motivo = document.getElementById('ncMotivo').value;
      const divManual = document.getElementById('ncMotivoManualDiv');
      const avisoIVA = document.getElementById('ncAvisoIVA');
      const selectIVA = document.getElementById('ncIVA');
      const labelReservasObrig = document.getElementById('ncReservasObrigatorio');
      const avisoReservas = document.getElementById('ncReservasAviso');
      
      // Verificar se Ã© "Outro" para mostrar campo manual
      if (motivo === '__outro__') {
        divManual.style.display = 'block';
        document.getElementById('ncMotivoManual').focus();
      } else {
        divManual.style.display = 'none';
        document.getElementById('ncMotivoManual').value = '';
      }
      
      // Configurar IVA baseado no motivo e faturas
      const motivosSemIVA = ['Desconto comercial', 'Desconto pronto pagamento'];
      const motivosSemReservaObrigatoria = ['Desconto comercial', 'Desconto pronto pagamento'];
      
      // REGRA 1: Desconto comercial/pronto pagamento = SEMPRE 0%
      if (motivosSemIVA.includes(motivo)) {
        selectIVA.value = '0';
        selectIVA.disabled = true;
        if (avisoIVA) {
          avisoIVA.textContent = 'âš ï¸ Desconto comercial/pronto pagamento: Nota de crÃ©dito emitida sem IVA (0%)';
          avisoIVA.className = 'text-xs text-amber-600 mt-1';
          avisoIVA.classList.remove('hidden');
        }
      }
      // REGRA 2: Faturas SEM IVA = NC sem IVA (bloqueado)
      else if (faturasSelecionadasNC.length > 0 && !faturasTemIVA) {
        selectIVA.value = '0';
        selectIVA.disabled = true;
        if (avisoIVA) {
          avisoIVA.textContent = 'âš ï¸ As faturas selecionadas nÃ£o tÃªm IVA - NC serÃ¡ emitida sem IVA (0%)';
          avisoIVA.className = 'text-xs text-amber-600 mt-1';
          avisoIVA.classList.remove('hidden');
        }
      }
      // REGRA 3: Faturas COM IVA = NC com IVA da fatura (BLOQUEADO)
      else if (faturasSelecionadasNC.length > 0 && faturasTemIVA) {
        selectIVA.value = taxaIVADasFaturas.toString();
        selectIVA.disabled = true; // BLOQUEADO - IVA detectado automaticamente
        if (avisoIVA) {
          avisoIVA.textContent = `âœ“ IVA detectado das faturas: ${taxaIVADasFaturas}%`;
          avisoIVA.className = 'text-xs text-green-600 mt-1';
          avisoIVA.classList.remove('hidden');
        }
      }
      // Nenhuma fatura selecionada - permitir escolher
      else {
        selectIVA.disabled = false;
        if (avisoIVA) avisoIVA.classList.add('hidden');
      }
      
      // Verificar obrigatoriedade de reservas
      if (motivosSemReservaObrigatoria.includes(motivo)) {
        labelReservasObrig.textContent = '';
        avisoReservas.textContent = 'Opcional para este motivo';
        avisoReservas.className = 'text-xs text-green-600';
      } else {
        labelReservasObrig.textContent = '*';
        avisoReservas.textContent = 'ObrigatÃ³rio selecionar reservas';
        avisoReservas.className = 'text-xs text-purple-600';
      }
      
      calcularTotaisNC();
    }
    
    // ========== RESERVAS - Nova LÃ³gica ==========
    // Pesquisar reservas apenas nas disponÃ­veis (das faturas)
    function pesquisarReservaNC() {
      const termo = document.getElementById('ncPesquisaReserva').value.toLowerCase().trim();
      const container = document.getElementById('ncResultadosReserva');
      
      if (termo.length < 1) {
        container.classList.add('hidden');
        return;
      }
      
      // Pesquisar apenas nas reservas disponÃ­veis (das faturas selecionadas)
      const resultados = reservasDisponiveis.filter(r => 
        (r.numero && r.numero.toLowerCase().includes(termo)) ||
        (r.id && r.id.toString().includes(termo)) ||
        (r.cmr && r.cmr.toLowerCase().includes(termo))
      ).slice(0, 10);
      
      if (resultados.length === 0) {
        container.innerHTML = '<div class="p-2 text-slate-500 text-sm">Nenhuma reserva encontrada nas faturas selecionadas</div>';
      } else {
        container.innerHTML = resultados.map(r => {
          const isSelected = reservasSelecionadasNC.includes(r.id);
          return `
            <div class="p-2 hover:bg-purple-50 cursor-pointer border-b text-sm ${isSelected ? 'bg-purple-100' : ''}" onclick="toggleReservaNC(${r.id})">
              <span class="font-mono font-semibold">${r.numero || 'R-' + r.id}</span>
              ${r.cmr ? `<span class="text-xs text-slate-500 ml-1">(CMR: ${r.cmr})</span>` : ''}
              <span class="ml-2 text-slate-500">${r.localCarga || ''} â†’ ${r.localDescarga || ''}</span>
              ${isSelected ? '<span class="ml-2 text-green-600">âœ“</span>' : ''}
            </div>
          `;
        }).join('');
      }
      container.classList.remove('hidden');
    }
    
    function adicionarReservaPesquisadaNC() {
      const termo = document.getElementById('ncPesquisaReserva').value.trim();
      const reserva = reservasDisponiveis.find(r => 
        (r.numero && r.numero.toLowerCase() === termo.toLowerCase()) ||
        (r.id && r.id.toString() === termo) ||
        (r.cmr && r.cmr.toLowerCase() === termo.toLowerCase())
      );
      
      if (reserva) {
        toggleReservaNC(reserva.id);
        document.getElementById('ncPesquisaReserva').value = '';
        document.getElementById('ncResultadosReserva').classList.add('hidden');
      } else {
        alert('âš ï¸ Reserva nÃ£o encontrada nas faturas selecionadas!');
      }
    }
    
    function toggleReservaNC(reservaId) {
      const index = reservasSelecionadasNC.indexOf(reservaId);
      if (index > -1) {
        reservasSelecionadasNC.splice(index, 1);
      } else {
        reservasSelecionadasNC.push(reservaId);
      }
      renderizarReservasDisponiveisNC();
    }
    
    function seleccionarTodasReservasNC() {
      reservasSelecionadasNC = reservasDisponiveis.map(r => r.id);
      renderizarReservasDisponiveisNC();
    }
    
    function desseleccionarTodasReservasNC() {
      reservasSelecionadasNC = [];
      renderizarReservasDisponiveisNC();
    }
    
    // Esta funÃ§Ã£o agora mostra reservas das faturas com checkboxes
    function renderizarReservasDisponiveisNC() {
      const container = document.getElementById('ncListaReservas');
      
      if (reservasDisponiveis.length === 0) {
        if (faturasSelecionadasNC.length === 0) {
          container.innerHTML = '<p class="text-slate-500 text-sm p-3 text-center">Selecione faturas para ver as reservas disponÃ­veis</p>';
        } else {
          container.innerHTML = '<p class="text-slate-500 text-sm p-3 text-center">As faturas selecionadas nÃ£o tÃªm reservas associadas</p>';
        }
        document.getElementById('ncReservasSelecionadas').textContent = '0 reservas';
        return;
      }
      
      // CabeÃ§alho
      let html = `
        <div class="flex justify-between items-center p-2 bg-purple-100 border-b">
          <span class="text-xs font-semibold text-purple-800">${reservasDisponiveis.length} reserva(s) nas faturas</span>
          <div class="flex gap-1">
            <button type="button" onclick="seleccionarTodasReservasNC()" class="text-xs px-2 py-1 rounded bg-purple-200 hover:bg-purple-300">â˜‘ï¸ Todas</button>
            <button type="button" onclick="desseleccionarTodasReservasNC()" class="text-xs px-2 py-1 rounded bg-slate-200 hover:bg-slate-300">â˜ Nenhuma</button>
          </div>
        </div>
      `;
      
      // Lista de reservas com checkboxes
      html += reservasDisponiveis.map(r => {
        const isSelected = reservasSelecionadasNC.includes(r.id);
        return `
          <div class="flex items-center gap-2 p-2 border-b hover:bg-purple-50 cursor-pointer ${isSelected ? 'bg-purple-100' : ''}" onclick="toggleReservaNC(${r.id})">
            <input type="checkbox" ${isSelected ? 'checked' : ''} class="cursor-pointer" onclick="event.stopPropagation(); toggleReservaNC(${r.id})">
            <div class="flex-1 text-sm">
              <span class="font-mono font-semibold">${r.numero || 'R-' + r.id}</span>
              ${r.cmr ? `<span class="text-xs text-slate-500 ml-1">(CMR: ${r.cmr})</span>` : ''}
              <span class="text-slate-500 ml-2">${r.localCarga || ''} â†’ ${r.localDescarga || ''}</span>
            </div>
          </div>
        `;
      }).join('');
      
      container.innerHTML = html;
      
      document.getElementById('ncReservasSelecionadas').textContent = `${reservasSelecionadasNC.length} de ${reservasDisponiveis.length} reserva(s) selecionada(s)`;
    }
    
    // Manter compatibilidade com funÃ§Ã£o antiga
    function renderizarListaReservasNC() {
      renderizarReservasDisponiveisNC();
    }
    
    function removerReservaNC(reservaId) {
      const index = reservasSelecionadasNC.indexOf(reservaId);
      if (index > -1) {
        reservasSelecionadasNC.splice(index, 1);
        renderizarReservasDisponiveisNC();
      }
    }
    
    function obterReservasRefNC() {
      return reservasSelecionadasNC.map(rId => {
        const r = reservas.find(x => x.id === rId);
        return r ? (r.numero || 'R-' + r.id) : '';
      }).filter(n => n).join(', ') || '-';
    }
    
    function adicionarMotivoNC() {
      const novoMotivo = document.getElementById('ncMotivoManual').value.trim();
      
      if (!novoMotivo) {
        alert('âš ï¸ Escreva um motivo para adicionar!');
        return;
      }
      
      if (motivosNCPersonalizados.includes(novoMotivo)) {
        alert('âš ï¸ Este motivo jÃ¡ existe na lista!');
        return;
      }
      
      motivosNCPersonalizados.push(novoMotivo);
      localStorage.setItem('erpMotivosNC', JSON.stringify(motivosNCPersonalizados));
      
      actualizarDropdownMotivosNC();
      document.getElementById('ncMotivo').value = novoMotivo;
      document.getElementById('ncMotivoManualDiv').style.display = 'none';
      document.getElementById('ncMotivoManual').value = '';
      
      alert(`âœ… Motivo "${novoMotivo}" adicionado Ã  lista!`);
    }
    
    function obterMotivoNC() {
      const motivo = document.getElementById('ncMotivo').value;
      if (motivo === '__outro__') {
        return document.getElementById('ncMotivoManual').value.trim();
      }
      return motivo;
    }
    
    function motivoRequerReservas(motivo) {
      const motivosSemReservaObrigatoria = ['Desconto comercial', 'Desconto pronto pagamento'];
      return !motivosSemReservaObrigatoria.includes(motivo);
    }
    
    // ========== CÃLCULOS ==========
    function mudarTipoCalculoNC() {
      const tipoCalculo = document.querySelector('input[name="ncTipoCalculo"]:checked').value;
      const divPercentagem = document.getElementById('ncPercentagemDiv');
      const divValor = document.getElementById('ncValorDiv');
      const inputValor = document.getElementById('ncValor');
      
      if (tipoCalculo === 'fixo') {
        divPercentagem.style.display = 'none';
        divValor.style.display = 'block';
        inputValor.readOnly = false;
        inputValor.style.background = '';
        inputValor.value = '';
      } else if (tipoCalculo === 'total') {
        divPercentagem.style.display = 'none';
        divValor.style.display = 'block';
        inputValor.readOnly = true;
        inputValor.style.background = '#f1f5f9';
        const totalFaturas = faturasSelecionadasNC.reduce((sum, fId) => {
          const f = faturas.find(x => x.id === fId);
          return sum + (f ? f.total : 0);
        }, 0);
        inputValor.value = totalFaturas.toFixed(2);
      } else if (tipoCalculo === 'percentagem') {
        divPercentagem.style.display = 'block';
        divValor.style.display = 'block';
        inputValor.readOnly = true;
        inputValor.style.background = '#f1f5f9';
        inputValor.value = '';
        document.getElementById('ncPercentagem').value = '';
      }
      
      calcularTotaisNC();
    }
    
    // ğŸ”’ FUNÃ‡ÃƒO BLOQUEADA - calcularTotaisNC (calcula valor final NC com regras IVA)
    function calcularTotaisNC() {
      const tipoCalculo = document.querySelector('input[name="ncTipoCalculo"]:checked')?.value || 'fixo';
      
      // Calcular total das faturas seleccionadas
      let totalFaturas = 0;
      faturasSelecionadasNC.forEach(fId => {
        const f = faturas.find(x => x.id === fId);
        if (f && f.total) {
          totalFaturas += parseFloat(f.total) || 0;
        }
      });
      
      let valor = 0;
      
      if (tipoCalculo === 'fixo') {
        valor = parseFloat(document.getElementById('ncValor').value) || 0;
      } else if (tipoCalculo === 'total') {
        valor = totalFaturas;
        document.getElementById('ncValor').value = valor.toFixed(2);
      } else if (tipoCalculo === 'percentagem') {
        const percentagem = parseFloat(document.getElementById('ncPercentagem').value) || 0;
        valor = totalFaturas * (percentagem / 100);
        document.getElementById('ncValor').value = valor.toFixed(2);
      }
      
      // CORRECÃ‡ÃƒO: Quando faturas nÃ£o tÃªm IVA, NC tambÃ©m nÃ£o pode ter IVA
      let taxaIVA = parseFloat(document.getElementById('ncIVA').value) || 0;
      
      // Se hÃ¡ faturas selecionadas E elas nÃ£o tÃªm IVA, forÃ§ar IVA a 0
      if (faturasSelecionadasNC.length > 0 && !faturasTemIVA) {
        taxaIVA = 0;
        document.getElementById('ncIVA').value = '0';
      }
      
      const iva = valor * (taxaIVA / 100);
      const total = valor + iva;
      
      document.getElementById('ncTotal').value = formatCurrency(total);
      
      // Actualizar resumo
      const resumo = document.getElementById('ncResumoCalculo');
      if (faturasSelecionadasNC.length === 0 && !ncModoManual) {
        resumo.innerHTML = '<span class="text-slate-500">Selecione faturas para continuar</span>';
      } else if (valor <= 0) {
        resumo.innerHTML = '<span class="text-slate-500">Introduza o valor a creditar</span>';
      } else {
        let textoTipo = '';
        if (tipoCalculo === 'fixo') {
          textoTipo = `Valor fixo: ${formatCurrency(valor)}`;
        } else if (tipoCalculo === 'total') {
          textoTipo = `Total das ${faturasSelecionadasNC.length} fatura(s): ${formatCurrency(totalFaturas)}`;
        } else {
          const perc = document.getElementById('ncPercentagem').value || 0;
          textoTipo = `${perc}% de ${formatCurrency(totalFaturas)} = ${formatCurrency(valor)}`;
        }
        
        const taxaIVATexto = taxaIVA > 0 ? ` + IVA ${taxaIVA}% (${formatCurrency(iva)})` : ' (Isento IVA)';
        
        resumo.innerHTML = `
          <div class="flex justify-between items-center">
            <span>${textoTipo}${taxaIVATexto}</span>
            <span class="font-bold text-red-600 text-lg">Total NC: ${formatCurrency(total)}</span>
          </div>
        `;
      }
    }
    
    // ========== PREVIEW E EMISSÃƒO ==========
    // ğŸ”’ FUNÃ‡ÃƒO BLOQUEADA - previewNC (gera preview documento NC)
    function previewNC() {
      try {
        const clienteId = document.getElementById('ncClienteId').value;
        const motivo = obterMotivoNC();
        const valor = parseFloat(document.getElementById('ncValor').value) || 0;
        
        if (!clienteId) {
          alert('âš ï¸ Selecione um cliente!');
          return;
        }
        
        // Verificar se hÃ¡ faturas em aberto
        const faturasEmAberto = faturas.filter(f => f.clienteId == clienteId && f.estado !== 'Anulada' && f.estado !== 'Pago');
        
        // Se hÃ¡ faturas em aberto, Ã© obrigatÃ³rio selecionar pelo menos uma
        if (faturasEmAberto.length > 0 && faturasSelecionadasNC.length === 0) {
          alert('âš ï¸ Este cliente tem faturas em aberto!\n\nSelecione pelo menos uma fatura para aplicar a nota de crÃ©dito.');
          return;
        }
        
        // Se NÃƒO hÃ¡ faturas em aberto (modo manual), verificar campos manuais
        let faturasRef = '-';
        let reservasRef = '-';
        
        if (faturasEmAberto.length === 0) {
          // Modo manual - campos obrigatÃ³rios
          const faturaManual = document.getElementById('ncFaturaManual')?.value?.trim() || '';
          const reservaManual = document.getElementById('ncReservaManual')?.value?.trim() || '';
          
          if (!faturaManual) {
            alert('âš ï¸ Cliente sem faturas em aberto!\n\nIndique o nÃºmero da fatura de referÃªncia no campo manual.');
            return;
          }
          
          if (!reservaManual) {
            alert('âš ï¸ Cliente sem faturas em aberto!\n\nIndique o nÃºmero da reserva no campo manual.');
            return;
          }
          
          faturasRef = faturaManual;
          reservasRef = reservaManual;
        } else {
          // Modo normal - usar faturas selecionadas
          faturasRef = faturasSelecionadasNC.length > 0 
            ? faturasSelecionadasNC.map(fId => {
                const f = faturas.find(x => x.id === fId);
                return f ? f.numero : '';
              }).filter(n => n).join(', ')
            : '-';
          
          reservasRef = obterReservasRefNC();
        }
        
        if (!motivo) {
          alert('âš ï¸ Selecione ou escreva o motivo da nota de crÃ©dito!');
          return;
        }
        
        // Verificar obrigatoriedade de reservas (apenas se motivo requer e nÃ£o estÃ¡ em modo manual)
        if (faturasEmAberto.length > 0 && motivoRequerReservas(motivo) && reservasSelecionadasNC.length === 0 && reservasDisponiveis.length > 0) {
          alert('âš ï¸ Para este motivo Ã© obrigatÃ³rio selecionar pelo menos uma reserva!');
          return;
        }
        
        if (valor <= 0) {
          alert('âš ï¸ Introduza um valor a creditar!');
          return;
        }
        
        const cliente = clientes.find(c => c.id == clienteId);
        if (!cliente) {
          alert('âš ï¸ Cliente nÃ£o encontrado!');
          return;
        }
        
        // CORRECÃ‡ÃƒO: ForÃ§ar IVA a 0 se faturas nÃ£o tÃªm IVA
        let taxaIVA = parseFloat(document.getElementById('ncIVA').value) || 0;
        if (faturasSelecionadasNC.length > 0 && !faturasTemIVA) {
          taxaIVA = 0; // Faturas sem IVA = NC sem IVA
        }
        const iva = valor * (taxaIVA / 100);
        
        const ncTemp = {
          id: 0,
          numero: document.getElementById('ncNumero').value,
          data: document.getElementById('ncData').value,
          faturaRef: faturasRef,
          reservasRef: reservasRef,
          clienteId: parseInt(clienteId),
          cliente: cliente.nome,
          nif: cliente.nif,
          morada: cliente.morada || cliente.sedeRua || '',
          motivo: motivo,
          observacoes: document.getElementById('ncObservacoes').value || '',
          subtotal: valor,
          iva: iva,
          iva23: taxaIVA === 23 ? iva : 0,
          iva13: taxaIVA === 13 ? iva : 0,
          iva6: taxaIVA === 6 ? iva : 0,
          iva0: taxaIVA === 0 ? valor : 0,
          total: valor + iva,
          taxaIVA: taxaIVA,
          linhas: [{
            descricao: `Nota de CrÃ©dito${faturasRef !== '-' ? ' ref. ' + faturasRef : ''} - ${motivo}`,
            reservaNum: reservasRef,
            valor: valor,
            iva: taxaIVA
          }]
        };
        
        gerarPreviewDocumento(ncTemp, 'NC');
        abrirModal('modalPreviewFatura');
      } catch (erro) {
        console.error('Erro no Preview NC:', erro);
        alert('âš ï¸ Erro ao gerar preview: ' + erro.message);
      }
    }
    
    // ğŸ”’ FUNÃ‡ÃƒO BLOQUEADA - emitirNC (emite NC final com todas as validaÃ§Ãµes)
    function emitirNC() {
      const clienteId = document.getElementById('ncClienteId').value;
      const motivo = obterMotivoNC();
      const valor = parseFloat(document.getElementById('ncValor').value) || 0;
      
      if (!clienteId) {
        alert('âš ï¸ Selecione um cliente!');
        return;
      }
      
      // Verificar se a sÃ©rie NC estÃ¡ ativa
      if (!verificarSerieAtiva('NC')) {
        return;
      }
      
      // Verificar se hÃ¡ faturas em aberto
      const faturasEmAberto = faturas.filter(f => f.clienteId == clienteId && f.estado !== 'Anulada' && f.estado !== 'Pago');
      
      // Se hÃ¡ faturas em aberto, Ã© obrigatÃ³rio selecionar pelo menos uma
      if (faturasEmAberto.length > 0 && faturasSelecionadasNC.length === 0) {
        alert('âš ï¸ Este cliente tem faturas em aberto!\n\nSelecione pelo menos uma fatura para aplicar a nota de crÃ©dito.');
        return;
      }
      
      // Determinar referÃªncias (modo manual ou normal)
      let faturasRef = '-';
      let reservasRef = '-';
      
      if (faturasEmAberto.length === 0) {
        // Modo manual - campos obrigatÃ³rios
        const faturaManual = document.getElementById('ncFaturaManual')?.value?.trim() || '';
        const reservaManual = document.getElementById('ncReservaManual')?.value?.trim() || '';
        
        if (!faturaManual) {
          alert('âš ï¸ Cliente sem faturas em aberto!\n\nIndique o nÃºmero da fatura de referÃªncia no campo manual.');
          return;
        }
        
        if (!reservaManual) {
          alert('âš ï¸ Cliente sem faturas em aberto!\n\nIndique o nÃºmero da reserva no campo manual.');
          return;
        }
        
        faturasRef = faturaManual;
        reservasRef = reservaManual;
      } else {
        // Modo normal
        faturasRef = faturasSelecionadasNC.length > 0 
          ? faturasSelecionadasNC.map(fId => {
              const f = faturas.find(x => x.id === fId);
              return f ? f.numero : '';
            }).filter(n => n).join(', ')
          : '-';
        
        reservasRef = obterReservasRefNC();
      }
      
      if (!motivo) {
        alert('âš ï¸ Selecione ou escreva o motivo da nota de crÃ©dito!');
        return;
      }
      
      // Verificar obrigatoriedade de reservas (apenas se nÃ£o modo manual)
      if (faturasEmAberto.length > 0 && motivoRequerReservas(motivo) && reservasSelecionadasNC.length === 0) {
        alert('âš ï¸ Para este motivo Ã© obrigatÃ³rio selecionar pelo menos uma reserva!');
        return;
      }
      
      if (valor <= 0) {
        alert('âš ï¸ Introduza um valor a creditar!');
        return;
      }
      
      const cliente = clientes.find(c => c.id == clienteId);
      
      // CORRECÃ‡ÃƒO: ForÃ§ar IVA a 0 se faturas nÃ£o tÃªm IVA
      let taxaIVA = parseFloat(document.getElementById('ncIVA').value) || 0;
      if (faturasSelecionadasNC.length > 0 && !faturasTemIVA) {
        taxaIVA = 0; // Faturas sem IVA = NC sem IVA
      }
      const iva = valor * (taxaIVA / 100);
      const total = valor + iva;
      
      // SÃ³ validar total se houver faturas selecionadas
      if (faturasSelecionadasNC.length > 0) {
        const totalFaturas = faturasSelecionadasNC.reduce((sum, fId) => {
          const f = faturas.find(x => x.id === fId);
          return sum + (f ? f.total : 0);
        }, 0);
        
        if (total > totalFaturas) {
          alert('âš ï¸ O valor da nota de crÃ©dito nÃ£o pode exceder o total das faturas selecionadas!');
          return;
        }
      }
      
      const serieNC = series.find(s => s.serie === 'NC');
      if (serieNC) serieNC.proxNum++;
      
      const novaNC = {
        id: notasCredito.length + 1,
        numero: document.getElementById('ncNumero').value,
        data: document.getElementById('ncData').value,
        faturasIds: [...faturasSelecionadasNC],
        reservasIds: [...reservasSelecionadasNC],
        faturaRef: faturasRef,
        reservasRef: reservasRef,
        clienteId: parseInt(clienteId),
        cliente: cliente.nome,
        nif: cliente.nif,
        morada: cliente.morada || cliente.sedeRua || '',
        motivo: motivo,
        observacoes: document.getElementById('ncObservacoes').value,
        subtotal: valor,
        iva: iva,
        iva23: taxaIVA === 23 ? iva : 0,
        iva13: taxaIVA === 13 ? iva : 0,
        iva6: taxaIVA === 6 ? iva : 0,
        iva0: taxaIVA === 0 ? valor : 0,
        total: total,
        taxaIVA: taxaIVA,
        estado: 'Emitida',
        reconciliada: false,
        linhas: [{
          descricao: `Nota de CrÃ©dito${faturasRef !== '-' ? ' ref. ' + faturasRef : ''} - ${motivo}`,
          reservaNum: reservasRef,
          valor: valor,
          iva: taxaIVA
        }]
      };
      
      notasCredito.push(novaNC);
      
      // Distribuir o crÃ©dito pelas faturas seleccionadas (proporcionalmente) - sÃ³ se houver faturas
      if (faturasSelecionadasNC.length > 0) {
        const totalFaturas = faturasSelecionadasNC.reduce((sum, fId) => {
          const f = faturas.find(x => x.id === fId);
          return sum + (f ? f.total : 0);
        }, 0);
        
        let valorRestante = total;
        faturasSelecionadasNC.forEach(fId => {
          const f = faturas.find(x => x.id === fId);
          if (f && valorRestante > 0) {
            const proporcao = f.total / totalFaturas;
            const creditoFatura = Math.min(total * proporcao, f.total - (f.pago || 0));
            f.pago = (f.pago || 0) + creditoFatura;
            valorRestante -= creditoFatura;
            
            if (f.pago >= f.total) {
              f.estado = 'Pago';
              f.pago = f.total;
            } else if (f.pago > 0) {
              f.estado = 'Parcial';
            }
          }
        });
      }
      
      guardarDados();
      fecharModal('modalNotaCredito');
      renderizarNotasCredito();
      renderizarFaturas();
      atualizarDashboard();
      
      alert(`âœ… Nota de CrÃ©dito ${novaNC.numero} emitida com sucesso!\n\nValor: ${formatCurrency(total)}\nIVA: ${taxaIVA}% (${formatCurrency(iva)})\n${faturasRef !== '-' ? 'Fatura(s): ' + faturasRef : 'Sem fatura associada'}\n${reservasRef !== '-' ? 'Reserva(s): ' + reservasRef : ''}\nMotivo: ${motivo}`);
    }
    
    /* â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
       â•‘  ğŸ”’ SECÃ‡ÃƒO BLOQUEADA - RECIBOS v4.3 (20/12/2024)                              â•‘
       â•‘  NÃƒO ALTERAR SEM AUTORIZAÃ‡ÃƒO - Backup disponÃ­vel                              â•‘
       â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    
    // ==================== RECIBOS ====================
    
    function renderizarRecibos() {
      const tbody = document.getElementById('tabelaRecibos');
      
      // Aplicar filtros da barra de filtros
      const filtroNumero = document.getElementById('filtroReciboNumero')?.value?.toLowerCase() || '';
      const filtroCliente = document.getElementById('filtroReciboCliente')?.value?.toLowerCase() || '';
      const filtroFatura = document.getElementById('filtroReciboFatura')?.value?.toLowerCase() || '';
      const filtroMetodo = document.getElementById('filtroReciboMetodo')?.value || '';
      const filtroDataDe = document.getElementById('filtroReciboDataDe')?.value || '';
      const filtroDataAte = document.getElementById('filtroReciboDataAte')?.value || '';
      
      // Aplicar pesquisa global (motor de busca do header)
      const pesquisaGlobal = (typeof termoPesquisaGlobal !== 'undefined' ? termoPesquisaGlobal : '').toLowerCase();
      
      let recibosFiltrados = recibos.filter(r => {
        // Filtro pesquisa global (header) - pesquisa em todos os campos
        if (pesquisaGlobal && pesquisaGlobal.length >= 2) {
          const textoCompleto = [
            r.numero,
            r.cliente,
            r.faturas.join(' '),
            r.metodo,
            r.contaDestino,
            r.referencia || ''
          ].join(' ').toLowerCase();
          
          if (!textoCompleto.includes(pesquisaGlobal)) return false;
        }
        
        // Filtro por nÃºmero
        if (filtroNumero && !r.numero.toLowerCase().includes(filtroNumero)) return false;
        
        // Filtro por cliente
        if (filtroCliente && !r.cliente.toLowerCase().includes(filtroCliente)) return false;
        
        // Filtro por fatura
        if (filtroFatura) {
          const faturasStr = r.faturas.join(', ').toLowerCase();
          if (!faturasStr.includes(filtroFatura)) return false;
        }
        
        // Filtro por mÃ©todo
        if (filtroMetodo && r.metodo !== filtroMetodo) return false;
        
        // Filtro por data de
        if (filtroDataDe && r.data < filtroDataDe) return false;
        
        // Filtro por data atÃ©
        if (filtroDataAte && r.data > filtroDataAte) return false;
        
        return true;
      });
      
      // Atualizar contador
      const contador = document.getElementById('contadorRecibos');
      if (contador) {
        const temFiltros = filtroNumero || filtroCliente || filtroFatura || filtroMetodo || filtroDataDe || filtroDataAte || (pesquisaGlobal && pesquisaGlobal.length >= 2);
        if (temFiltros) {
          contador.textContent = `${recibosFiltrados.length} de ${recibos.length} recibos`;
        } else {
          contador.textContent = `${recibos.length} recibos`;
        }
      }
      
      tbody.innerHTML = recibosFiltrados.map(r => `
        <tr>
          <td class="font-mono font-semibold">${r.numero}</td>
          <td>${formatDate(r.data)}</td>
          <td>
            <span class="cursor-pointer text-blue-600 hover:underline" onclick="abrirFichaCliente(${r.clienteId})">${r.cliente}</span>
          </td>
          <td>${r.faturas.join(', ')}</td>
          <td>${r.metodo}</td>
          <td>${r.contaDestino}</td>
          <td class="font-bold text-emerald-600">${formatCurrency(r.valor)}</td>
          <td style="white-space: nowrap;">
            <button onclick="verRecibo(${r.id})" class="text-blue-600 hover:underline text-sm">Ver</button>
            <button onclick="imprimirRecibo(${r.id})" class="text-slate-600 hover:underline text-sm" style="margin-left: 8px;">PDF</button>
            <button onclick="abrirEnviarEmailRecibo(${r.id})" class="text-emerald-600 hover:underline text-sm" style="margin-left: 8px;">Email</button>
          </td>
        </tr>
      `).join('') || '<tr><td colspan="8" class="text-center text-slate-500 py-8">Nenhum recibo encontrado</td></tr>';
    }
    
    function filtrarRecibos() {
      renderizarRecibos();
    }
    
    function limparFiltrosRecibos() {
      document.getElementById('filtroReciboNumero').value = '';
      document.getElementById('filtroReciboCliente').value = '';
      document.getElementById('filtroReciboFatura').value = '';
      document.getElementById('filtroReciboMetodo').value = '';
      document.getElementById('filtroReciboDataDe').value = '';
      document.getElementById('filtroReciboDataAte').value = '';
      renderizarRecibos();
    }
    
    function reporRecibosTeste() {
      const recibosExemplo = [
        {
          id: 1,
          numero: 'RC 2025/1',
          data: '2025-12-15',
          clienteId: 1,
          cliente: 'Empresa Nacional Lda',
          faturas: ['FT 2025/1'],
          metodo: 'TransferÃªncia',
          contaDestino: 'Banco BPI',
          valor: 1230.00,
          referencia: 'TRF-001'
        },
        {
          id: 2,
          numero: 'RC 2025/2',
          data: '2025-12-16',
          clienteId: 2,
          cliente: 'Transport Europe SA',
          faturas: ['FT 2025/2', 'FT 2025/3'],
          metodo: 'Cheque',
          contaDestino: 'CGD',
          valor: 2850.00,
          referencia: 'CHQ-5521'
        },
        {
          id: 3,
          numero: 'RC 2025/3',
          data: '2025-12-17',
          clienteId: 5,
          cliente: 'LogÃ­stica Silva Lda',
          faturas: ['FT 2025/4'],
          metodo: 'MB Way',
          contaDestino: 'Millennium BCP',
          valor: 450.00,
          referencia: 'MBWAY-9987'
        },
        {
          id: 4,
          numero: 'RC 2025/4',
          data: '2025-12-18',
          clienteId: 3,
          cliente: 'Global Logistics UK Ltd',
          faturas: ['FT 2025/5'],
          metodo: 'TransferÃªncia',
          contaDestino: 'Banco BPI',
          valor: 3200.00,
          referencia: 'TRF-SWIFT-002'
        },
        {
          id: 5,
          numero: 'RC 2025/5',
          data: '2025-12-19',
          clienteId: 1,
          cliente: 'Empresa Nacional Lda',
          faturas: ['FT 2025/6', 'FT 2025/7'],
          metodo: 'NumerÃ¡rio',
          contaDestino: 'Caixa',
          valor: 680.00,
          referencia: ''
        }
      ];
      
      recibos = recibosExemplo;
      localStorage.setItem('erpRecibos', JSON.stringify(recibos));
      renderizarRecibos();
      alert('âœ… Recibos de teste repostos com sucesso!\n\nğŸ“Š 5 recibos disponÃ­veis para teste.');
    }
    
    function abrirNovoRecibo() {
      const serieRC = series.find(s => s.serie === 'RC');
      const anoRC = serieRC ? serieRC.ano : new Date().getFullYear();
      document.getElementById('reciboNumero').value = `RC ${anoRC}/${serieRC ? serieRC.proxNum : 1}`;
      document.getElementById('reciboData').value = new Date().toISOString().split('T')[0];
      
      const select = document.getElementById('reciboCliente');
      select.innerHTML = '<option value="">-- Selecione --</option>';
      clientes.forEach(c => {
        select.innerHTML += `<option value="${c.id}">${c.nome}</option>`;
      });
      
      document.getElementById('faturasPendentesRecibo').innerHTML = '<p class="text-slate-500 text-sm">Selecione um cliente</p>';
      document.getElementById('reciboValorTotal').value = '';
      document.getElementById('reciboValor').value = '';
      document.getElementById('reciboReferencia').value = '';
      document.getElementById('reciboMetodo').value = '';
      document.getElementById('reciboContaDestino').value = '';
      
      abrirModal('modalRecibo');
    }
    
    // Preview do recibo antes de emitir
    function previewRecibo() {
      const clienteId = document.getElementById('reciboCliente').value;
      if (!clienteId) {
        alert('Selecione um cliente primeiro!');
        return;
      }
      
      const cliente = clientes.find(c => c.id == clienteId);
      const valor = parseFloat(document.getElementById('reciboValor').value) || 0;
      
      if (valor <= 0) {
        alert('Selecione faturas e indique os valores a receber!');
        return;
      }
      
      const metodo = document.getElementById('reciboMetodo').value;
      const contaDestino = document.getElementById('reciboContaDestino').value;
      
      if (!metodo || !contaDestino) {
        alert('Preencha o mÃ©todo de pagamento e conta destino!');
        return;
      }
      
      // Obter faturas selecionadas com valores parciais
      const checkboxes = document.querySelectorAll('#faturasPendentesRecibo .fatura-checkbox:checked');
      const faturasRecibo = [];
      const detalhesFaturas = [];
      let valorDocumento = 0;
      let totalAReceber = 0;
      
      checkboxes.forEach(cb => {
        const faturaId = cb.value;
        const fatura = faturas.find(f => f.id == faturaId);
        const inputValor = document.getElementById('valor_' + faturaId);
        
        if (fatura && inputValor) {
          const valorAReceber = parseFloat(inputValor.value) || 0;
          const emFalta = fatura.total - fatura.pago;
          
          faturasRecibo.push(fatura.numero);
          valorDocumento += emFalta;
          totalAReceber += valorAReceber;
          
          detalhesFaturas.push({
            faturaId: fatura.id,
            faturaNumero: fatura.numero,
            valorFatura: fatura.total,
            valorAnteriorPago: fatura.pago,
            valorRecebido: valorAReceber,
            valorPendente: emFalta - valorAReceber
          });
        }
      });
      
      if (faturasRecibo.length === 0) {
        alert('Selecione pelo menos uma fatura!');
        return;
      }
      
      // Criar objeto recibo temporÃ¡rio para preview
      const reciboPreview = {
        id: 'preview',
        numero: document.getElementById('reciboNumero').value,
        data: document.getElementById('reciboData').value,
        clienteId: parseInt(clienteId),
        cliente: cliente.nome,
        morada: cliente.morada || '',
        nif: cliente.nif,
        faturas: faturasRecibo,
        detalhesFaturas: detalhesFaturas,
        metodo: metodo,
        contaDestino: contaDestino,
        valor: totalAReceber,
        total: totalAReceber,
        valorDocumento: valorDocumento,
        valorPago: totalAReceber,
        referencia: document.getElementById('reciboReferencia').value
      };
      
      gerarPreviewDocumento(reciboPreview, 'RC');
      abrirModal('modalPreviewFatura');
    }
    
    function carregarFaturasCliente() {
      const clienteId = document.getElementById('reciboCliente').value;
      const faturasCliente = faturas.filter(f => f.clienteId == clienteId && (f.estado === 'Pendente' || f.estado === 'Parcial' || f.estado === 'Vencido'));
      
      const container = document.getElementById('faturasPendentesRecibo');
      
      if (faturasCliente.length === 0) {
        container.innerHTML = '<p class="text-slate-500 text-sm">Este cliente nÃ£o tem faturas pendentes</p>';
        document.getElementById('reciboValorTotal').value = '';
        return;
      }
      
      // Criar tabela estilo Excel
      let html = `
        <table class="w-full text-sm border-collapse">
          <thead>
            <tr style="background: #065f46; color: white;">
              <th style="padding: 8px; text-align: center; width: 30px;"></th>
              <th style="padding: 8px; text-align: left;">NÂº FATURA</th>
              <th style="padding: 8px; text-align: right;">VALOR A PAGAR</th>
              <th style="padding: 8px; text-align: center; width: 140px;">VALOR A RECEBER</th>
              <th style="padding: 8px; text-align: right;">VALOR EM FALTA</th>
            </tr>
          </thead>
          <tbody>
      `;
      
      faturasCliente.forEach(f => {
        const emFalta = f.total - f.pago;
        html += `
          <tr class="border-b border-slate-200 hover:bg-slate-50" data-fatura-id="${f.id}">
            <td style="padding: 8px; text-align: center;">
              <input type="checkbox" id="chk_${f.id}" value="${f.id}" class="w-4 h-4 fatura-checkbox" onchange="toggleValorReceber(${f.id})">
            </td>
            <td style="padding: 8px; font-family: monospace; font-weight: 600;">${f.numero}</td>
            <td style="padding: 8px; text-align: right; font-weight: 500;">${formatCurrency(emFalta)}</td>
            <td style="padding: 8px; text-align: center;">
              <input type="text" 
                     id="valor_${f.id}" 
                     data-max="${emFalta.toFixed(2)}"
                     value="${emFalta.toFixed(2)}"
                     class="w-28 px-2 py-1 text-sm border border-slate-300 rounded text-right font-semibold"
                     disabled
                     onblur="validarECalcular(${f.id}, ${emFalta})"
                     onkeyup="atualizarValorEmFaltaLive(${f.id}, ${emFalta})">
            </td>
            <td style="padding: 8px; text-align: right;" id="falta_${f.id}">
              <span class="text-amber-600 font-semibold">${formatCurrency(0)}</span>
            </td>
          </tr>
        `;
      });
      
      html += `
          </tbody>
        </table>
      `;
      
      container.innerHTML = html;
      calcularTotalRecibo();
    }
    
    function toggleValorReceber(faturaId) {
      const checkbox = document.getElementById('chk_' + faturaId);
      const inputValor = document.getElementById('valor_' + faturaId);
      const fatura = faturas.find(f => f.id == faturaId);
      const emFalta = fatura ? fatura.total - fatura.pago : 0;
      
      if (checkbox.checked) {
        inputValor.disabled = false;
        inputValor.focus();
        inputValor.select();
        atualizarValorEmFaltaLive(faturaId, emFalta);
      } else {
        inputValor.disabled = true;
        document.getElementById('falta_' + faturaId).innerHTML = `<span class="text-amber-600 font-semibold">${formatCurrency(0)}</span>`;
      }
      
      calcularTotalRecibo();
    }
    
    // Atualiza em tempo real enquanto digita (sem validaÃ§Ã£o)
    function atualizarValorEmFaltaLive(faturaId, maxValor) {
      const input = document.getElementById('valor_' + faturaId);
      const checkbox = document.getElementById('chk_' + faturaId);
      let valorAReceber = parseFloat(input.value) || 0;
      
      // Calcular valor em falta (sem limitar o input)
      const valorEmFalta = maxValor - valorAReceber;
      
      // Atualizar cÃ©lula de valor em falta
      if (checkbox && checkbox.checked) {
        const corValor = valorEmFalta < 0 ? 'text-red-600' : 'text-amber-600';
        document.getElementById('falta_' + faturaId).innerHTML = `<span class="${corValor} font-semibold">${formatCurrency(Math.max(0, valorEmFalta))}</span>`;
      }
      
      calcularTotalRecibo();
    }
    
    // Valida quando sai do campo
    function validarECalcular(faturaId, maxValor) {
      const input = document.getElementById('valor_' + faturaId);
      let valorAReceber = parseFloat(input.value) || 0;
      
      // Validar limites apenas no blur
      if (valorAReceber < 0) valorAReceber = 0;
      if (valorAReceber > maxValor) valorAReceber = maxValor;
      
      input.value = valorAReceber.toFixed(2);
      atualizarValorEmFaltaLive(faturaId, maxValor);
    }
    
    function atualizarValorEmFalta(faturaId, maxValor) {
      atualizarValorEmFaltaLive(faturaId, maxValor);
    }
    
    function validarValorReceber(faturaId, maxValor) {
      validarECalcular(faturaId, maxValor);
    }
    
    function calcularTotalRecibo() {
      const checkboxes = document.querySelectorAll('#faturasPendentesRecibo .fatura-checkbox:checked');
      let total = 0;
      
      checkboxes.forEach(cb => {
        const faturaId = cb.value;
        const inputValor = document.getElementById('valor_' + faturaId);
        if (inputValor) {
          total += parseFloat(inputValor.value) || 0;
        }
      });
      
      document.getElementById('reciboValorTotal').value = formatCurrency(total);
      document.getElementById('reciboValor').value = total.toFixed(2);
    }
    
    function emitirRecibo() {
      const clienteId = document.getElementById('reciboCliente').value;
      if (!clienteId) {
        alert('Selecione um cliente!');
        return;
      }
      
      // Verificar se a sÃ©rie RC estÃ¡ ativa
      if (!verificarSerieAtiva('RC')) {
        return;
      }
      
      const valor = parseFloat(document.getElementById('reciboValor').value) || 0;
      if (valor <= 0) {
        alert('Indique o valor recebido!');
        return;
      }
      
      const metodo = document.getElementById('reciboMetodo').value;
      const contaDestino = document.getElementById('reciboContaDestino').value;
      
      if (!metodo || !contaDestino) {
        alert('Preencha o mÃ©todo de pagamento e conta destino!');
        return;
      }
      
      const cliente = clientes.find(c => c.id == clienteId);
      const serieRC = series.find(s => s.serie === 'RC');
      const numRecibo = `RC ${serieRC.ano}/${serieRC.proxNum}`;
      serieRC.proxNum++;
      
      // Obter faturas selecionadas com valores parciais
      const checkboxes = document.querySelectorAll('#faturasPendentesRecibo .fatura-checkbox:checked');
      const faturasRecibo = [];
      const detalhesFaturas = []; // Guardar detalhes de cada fatura
      let totalRecebido = 0;
      
      checkboxes.forEach(cb => {
        const faturaId = cb.value;
        const fatura = faturas.find(f => f.id == faturaId);
        const inputValor = document.getElementById('valor_' + faturaId);
        
        if (fatura && inputValor) {
          const valorAReceber = parseFloat(inputValor.value) || 0;
          
          if (valorAReceber > 0) {
            const emFaltaAntes = fatura.total - fatura.pago;
            
            // Atualizar fatura
            fatura.pago += valorAReceber;
            totalRecebido += valorAReceber;
            
            // Determinar estado
            if (fatura.pago >= fatura.total) {
              fatura.estado = 'Pago';
            } else {
              fatura.estado = 'Parcial';
            }
            
            // Guardar detalhes
            faturasRecibo.push(fatura.numero);
            detalhesFaturas.push({
              faturaId: fatura.id,
              faturaNumero: fatura.numero,
              valorFatura: fatura.total,
              valorAnteriorPago: fatura.pago - valorAReceber,
              valorRecebido: valorAReceber,
              valorPendente: fatura.total - fatura.pago
            });
          }
        }
      });
      
      if (faturasRecibo.length === 0) {
        alert('Selecione pelo menos uma fatura!');
        return;
      }
      
      const novoReciboId = Date.now();
      
      recibos.push({
        id: novoReciboId,
        numero: numRecibo,
        data: document.getElementById('reciboData').value,
        clienteId: parseInt(clienteId),
        cliente: cliente.nome,
        faturas: faturasRecibo,
        detalhesFaturas: detalhesFaturas, // Detalhes de cada fatura
        metodo,
        contaDestino,
        valor: totalRecebido,
        referencia: document.getElementById('reciboReferencia').value
      });
      
      guardarDados();
      fecharModal('modalRecibo');
      renderizarRecibos();
      atualizarDashboard();
      
      // Construir resumo
      let resumo = `âœ… Recibo ${numRecibo} emitido com sucesso!\n\n`;
      resumo += `ğŸ’° Total Recebido: ${formatCurrency(totalRecebido)}\n`;
      resumo += `ğŸ¦ Conta: ${contaDestino}\n\n`;
      resumo += `ğŸ“„ Faturas:\n`;
      detalhesFaturas.forEach(d => {
        resumo += `â€¢ ${d.faturaNumero}: ${formatCurrency(d.valorRecebido)} recebido`;
        if (d.valorPendente > 0) {
          resumo += ` (pendente: ${formatCurrency(d.valorPendente)})`;
        } else {
          resumo += ` (PAGO)`;
        }
        resumo += `\n`;
      });
      
      // Perguntar se quer enviar email (abre janela de email)
      perguntarEnviarEmailRecibo(novoReciboId, resumo);
    }
    
    /* â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
       â•‘  ğŸ”’ FIM DA SECÃ‡ÃƒO BLOQUEADA - RECIBOS                                         â•‘
       â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    
    /* â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
       â•‘  ğŸ”’ SECÃ‡ÃƒO BLOQUEADA - CONTAS CORRENTES v4.6 (20/12/2024)                    â•‘
       â•‘  NÃƒO ALTERAR SEM AUTORIZAÃ‡ÃƒO - MÃ“DULO COMPLETO E FUNCIONAL                  â•‘
       â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
       â•‘  Funcionalidades:                                                            â•‘
       â•‘  â€¢ Resumo com clientes em dÃ­vida + filtros + botÃ£o imprimir                  â•‘
       â•‘  â€¢ Extrato detalhado + filtros + email + botÃ£o imprimir                      â•‘
       â•‘  â€¢ AnÃ¡lise de vencimentos + filtros + botÃ£o imprimir                         â•‘
       â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    
    // ==================== CONTAS CORRENTES - BLOQUEADO v4.6 ====================
    
    // Dados temporÃ¡rios para filtros
    let dadosResumoCC = [];
    let emailsExtratoManuaisLista = [];
    
    function renderizarContasCorrentes() {
      renderizarCCResumo();
      preencherSelectExtrato();
      renderizarVencimentos();
    }
    
    // ========== RESUMO - SÃ“ CLIENTES COM DÃVIDA ==========
    
    function renderizarCCResumo() {
      const ccClientes = {};
      
      faturas.forEach(f => {
        if (!ccClientes[f.clienteId]) {
          ccClientes[f.clienteId] = { 
            id: f.clienteId,
            cliente: f.cliente, 
            nif: f.nif, 
            faturado: 0, 
            pago: 0 
          };
        }
        ccClientes[f.clienteId].faturado += f.total;
        ccClientes[f.clienteId].pago += f.pago;
      });
      
      // Filtrar SÃ“ clientes com saldo em dÃ­vida (saldo > 0)
      dadosResumoCC = Object.entries(ccClientes)
        .map(([id, c]) => ({ ...c, id: parseInt(id), saldo: c.faturado - c.pago }))
        .filter(c => c.saldo > 0.01); // SÃ³ mostrar se saldo > 0
      
      filtrarResumoCC();
    }
    
    function filtrarResumoCC() {
      const filtroCliente = (document.getElementById('filtroResumoCliente')?.value || '').toLowerCase();
      const filtroSaldoMin = parseFloat(document.getElementById('filtroResumoSaldoMin')?.value) || 0;
      const filtroSaldoMax = parseFloat(document.getElementById('filtroResumoSaldoMax')?.value) || Infinity;
      
      // Integrar pesquisa global do header
      const pesquisaGlobal = (typeof termoPesquisaGlobal !== 'undefined' ? termoPesquisaGlobal : '').toLowerCase();
      
      const filtrados = dadosResumoCC.filter(c => {
        // Filtro local (campo dentro do mÃ³dulo)
        if (filtroCliente && !c.cliente.toLowerCase().includes(filtroCliente) && !(c.nif || '').toLowerCase().includes(filtroCliente)) return false;
        if (c.saldo < filtroSaldoMin) return false;
        if (c.saldo > filtroSaldoMax) return false;
        
        // Filtro global (campo no header)
        if (pesquisaGlobal && pesquisaGlobal.length >= 2) {
          const textoCompleto = [
            c.cliente,
            c.nif || '',
            c.faturado.toString(),
            c.saldo.toString()
          ].join(' ').toLowerCase();
          
          if (!textoCompleto.includes(pesquisaGlobal)) return false;
        }
        
        return true;
      });
      
      const tbody = document.getElementById('tabelaCCResumo');
      
      if (filtrados.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center text-slate-500 py-8">Sem clientes com saldo em dÃ­vida</td></tr>';
        document.getElementById('resumoCCTotais').innerHTML = '';
        return;
      }
      
      tbody.innerHTML = filtrados.map(c => `
        <tr>
          <td>
            <a href="#" onclick="verExtratoClienteDivida(${c.id}); return false;" class="text-blue-600 hover:underline font-semibold">
              ${c.cliente}
            </a>
          </td>
          <td>${c.nif || '-'}</td>
          <td>${formatCurrency(c.faturado)}</td>
          <td class="text-emerald-600">${formatCurrency(c.pago)}</td>
          <td class="font-bold text-amber-600">${formatCurrency(c.saldo)}</td>
          <td>
            <button onclick="verExtratoClienteDivida(${c.id})" class="text-blue-600 hover:underline text-sm">Ver Extrato</button>
            <button onclick="abrirReciboCliente(${c.id})" class="text-emerald-600 hover:underline text-sm ml-2">Emitir Recibo</button>
            <button onclick="imprimirResumoCliente(${c.id})" class="text-slate-600 hover:underline text-sm ml-2">ğŸ–¨ï¸ Imprimir</button>
          </td>
        </tr>
      `).join('');
      
      // Totais
      const totalFaturado = filtrados.reduce((sum, c) => sum + c.faturado, 0);
      const totalPago = filtrados.reduce((sum, c) => sum + c.pago, 0);
      const totalSaldo = filtrados.reduce((sum, c) => sum + c.saldo, 0);
      
      document.getElementById('resumoCCTotais').innerHTML = `
        <div class="grid grid-cols-4 gap-4 text-center">
          <div>
            <div class="text-xs text-slate-500">Clientes em DÃ­vida</div>
            <div class="text-xl font-bold text-slate-700">${filtrados.length}</div>
          </div>
          <div>
            <div class="text-xs text-slate-500">Total Faturado</div>
            <div class="text-xl font-bold text-slate-700">${formatCurrency(totalFaturado)}</div>
          </div>
          <div>
            <div class="text-xs text-emerald-500">Total Pago</div>
            <div class="text-xl font-bold text-emerald-600">${formatCurrency(totalPago)}</div>
          </div>
          <div>
            <div class="text-xs text-amber-500">Total em DÃ­vida</div>
            <div class="text-xl font-bold text-amber-600">${formatCurrency(totalSaldo)}</div>
          </div>
        </div>
      `;
    }
    
    function limparFiltrosResumoCC() {
      document.getElementById('filtroResumoCliente').value = '';
      document.getElementById('filtroResumoSaldoMin').value = '';
      document.getElementById('filtroResumoSaldoMax').value = '';
      filtrarResumoCC();
    }
    
    // ========== EXTRATO DETALHADO ==========
    
    function preencherSelectExtrato() {
      const select = document.getElementById('extratoCliente');
      select.innerHTML = '<option value="">-- Selecione --</option>';
      clientes.forEach(c => {
        select.innerHTML += `<option value="${c.id}">${c.nome}</option>`;
      });
    }
    
    // Ver extrato com foco em faturas em dÃ­vida (chamado do Resumo)
    function verExtratoClienteDivida(clienteId) {
      document.getElementById('extratoCliente').value = clienteId;
      document.getElementById('extratoCondicao').value = 'divida'; // ForÃ§ar condiÃ§Ã£o "Faturas em dÃ­vida"
      carregarExtrato();
      mudarTabCC('extrato');
    }
    
    function verExtratoCliente(clienteId) {
      document.getElementById('extratoCliente').value = clienteId;
      carregarExtrato();
      mudarTabCC('extrato');
    }
    
    function carregarExtrato() {
      const clienteId = document.getElementById('extratoCliente').value;
      const resumoDiv = document.getElementById('extratoResumoCliente');
      
      if (!clienteId) {
        document.getElementById('tabelaExtrato').innerHTML = '<tr><td colspan="9" class="text-center text-slate-500 py-8">Selecione um cliente</td></tr>';
        resumoDiv.classList.add('hidden');
        return;
      }
      
      const dataDe = document.getElementById('extratoDataDe').value;
      const dataAte = document.getElementById('extratoDataAte').value;
      const condicao = document.getElementById('extratoCondicao').value;
      
      // Obter movimentos (faturas e recibos)
      let movimentos = [];
      let totalFaturado = 0;
      let totalPago = 0;
      let numFaturasPendentes = 0;
      
      faturas.filter(f => f.clienteId == clienteId).forEach(f => {
        if (dataDe && f.data < dataDe) return;
        if (dataAte && f.data > dataAte) return;
        
        const valorPendente = f.total - f.pago;
        const estaPaga = valorPendente <= 0.01;
        
        // Aplicar filtro de condiÃ§Ã£o
        if (condicao === 'divida' && estaPaga) return; // SÃ³ faturas em dÃ­vida
        if (condicao === 'pagas' && !estaPaga) return; // SÃ³ faturas pagas
        // 'completo' mostra todas
        
        let descricaoFatura = 'Fatura';
        if (f.pago > 0 && valorPendente > 0.01) {
          descricaoFatura = `Fatura (Parcial)`;
        } else if (estaPaga) {
          descricaoFatura = 'Fatura (PAGO)';
        }
        
        movimentos.push({
          data: f.data,
          documento: f.numero,
          descricao: descricaoFatura,
          refCliente: f.linhas[0]?.refCliente || '-',
          valorDocumento: f.total,
          debito: f.total,
          credito: f.pago,
          valorDivida: valorPendente > 0 ? valorPendente : 0,
          tipo: 'fatura'
        });
        
        totalFaturado += f.total;
        totalPago += f.pago;
        if (!estaPaga) numFaturasPendentes++;
      });
      
      // Adicionar recibos se nÃ£o for filtro "divida"
      if (condicao !== 'divida') {
        recibos.filter(r => r.clienteId == clienteId).forEach(r => {
          if (dataDe && r.data < dataDe) return;
          if (dataAte && r.data > dataAte) return;
          
          let descricaoRecibo = `Recibo (${r.faturas.join(', ')})`;
          
          movimentos.push({
            data: r.data,
            documento: r.numero,
            descricao: descricaoRecibo,
            refCliente: '-',
            valorDocumento: r.valor,
            debito: 0,
            credito: r.valor,
            valorDivida: 0,
            tipo: 'recibo'
          });
        });
      }
      
      // Ordenar por data
      movimentos.sort((a, b) => new Date(a.data) - new Date(b.data));
      
      // Calcular saldo acumulado (dÃ©bito - crÃ©dito acumulado)
      let saldoAcumulado = 0;
      movimentos.forEach(m => {
        if (m.tipo === 'fatura') {
          saldoAcumulado += m.valorDivida; // Adiciona apenas o valor em dÃ­vida
        } else {
          // Recibos jÃ¡ foram descontados nas faturas
        }
        m.saldo = saldoAcumulado;
      });
      
      // Recalcular saldo para mostrar corretamente
      saldoAcumulado = 0;
      movimentos.forEach(m => {
        saldoAcumulado += m.debito - m.credito;
        m.saldo = saldoAcumulado;
      });
      
      // Atualizar resumo
      resumoDiv.classList.remove('hidden');
      document.getElementById('extratoTotalFaturado').textContent = formatCurrency(totalFaturado);
      document.getElementById('extratoTotalPago').textContent = formatCurrency(totalPago);
      document.getElementById('extratoSaldoPendente').textContent = formatCurrency(totalFaturado - totalPago);
      document.getElementById('extratoNumFaturas').textContent = numFaturasPendentes;
      
      // Renderizar tabela com as novas colunas
      const tbody = document.getElementById('tabelaExtrato');
      tbody.innerHTML = movimentos.length ? movimentos.map(m => `
        <tr class="${m.tipo === 'recibo' ? 'bg-emerald-50' : ''}">
          <td>${formatDate(m.data)}</td>
          <td class="font-mono">${m.documento}</td>
          <td class="text-xs">${m.descricao}</td>
          <td>${m.refCliente}</td>
          <td class="text-right">${formatCurrency(m.valorDocumento)}</td>
          <td class="text-right ${m.debito > 0 ? 'text-amber-600' : ''}">${m.debito > 0 ? formatCurrency(m.debito) : '-'}</td>
          <td class="text-right ${m.credito > 0 ? 'text-emerald-600' : ''}">${m.credito > 0 ? formatCurrency(m.credito) : '-'}</td>
          <td class="text-right font-bold ${m.valorDivida > 0 ? 'text-red-600' : 'text-emerald-600'}">${m.tipo === 'fatura' ? formatCurrency(m.valorDivida) : '-'}</td>
          <td class="text-right font-bold ${m.saldo > 0 ? 'text-amber-600' : 'text-emerald-600'}">${formatCurrency(m.saldo)}</td>
        </tr>
      `).join('') : '<tr><td colspan="9" class="text-center text-slate-500 py-8">Sem movimentos para os filtros selecionados</td></tr>';
    }
    
    function limparFiltrosExtrato() {
      document.getElementById('extratoCliente').value = '';
      document.getElementById('extratoDataDe').value = '';
      document.getElementById('extratoDataAte').value = '';
      document.getElementById('extratoCondicao').value = 'divida';
      document.getElementById('tabelaExtrato').innerHTML = '<tr><td colspan="9" class="text-center text-slate-500 py-8">Selecione um cliente</td></tr>';
      document.getElementById('extratoResumoCliente').classList.add('hidden');
    }
    
    // ========== EMAIL DO EXTRATO ==========
    
    function abrirEmailExtrato() {
      const clienteId = document.getElementById('extratoCliente').value;
      if (!clienteId) {
        alert('âš ï¸ Selecione um cliente primeiro!');
        return;
      }
      
      const cliente = clientes.find(c => c.id == clienteId);
      if (!cliente) {
        alert('âš ï¸ Cliente nÃ£o encontrado!');
        return;
      }
      
      document.getElementById('emailExtratoClienteId').value = clienteId;
      emailsExtratoManuaisLista = [];
      
      // Info do cliente
      document.getElementById('emailExtratoClienteInfo').innerHTML = `
        <strong>ğŸ“‹ Cliente:</strong> ${cliente.nome}<br>
        <strong>NIF:</strong> ${cliente.nif || '-'}
      `;
      
      // Emails de contabilidade
      const emailsCont = cliente.emailsContabilidade || [];
      document.getElementById('emailsExtratoContabilidade').innerHTML = emailsCont.length 
        ? emailsCont.map(e => `<label class="checkbox-container"><input type="checkbox" value="${e}" checked><span>${e}</span></label>`).join('')
        : '<p class="text-slate-400 italic">Sem emails configurados</p>';
      
      // Emails financeiro
      const emailsFin = cliente.emailsFinanceiro || [];
      document.getElementById('emailsExtratoFinanceiro').innerHTML = emailsFin.length 
        ? emailsFin.map(e => `<label class="checkbox-container"><input type="checkbox" value="${e}" checked><span>${e}</span></label>`).join('')
        : '<p class="text-slate-400 italic">Sem emails configurados</p>';
      
      // Outros emails (gerais)
      const emailsOutros = cliente.emailsGerais || [];
      document.getElementById('emailsExtratoOutros').innerHTML = emailsOutros.length 
        ? emailsOutros.map(e => `<label class="checkbox-container"><input type="checkbox" value="${e}"><span>${e}</span></label>`).join('')
        : '<p class="text-slate-400 italic">Sem outros emails</p>';
      
      // Limpar campos
      document.getElementById('emailExtratoManual').value = '';
      document.getElementById('emailsExtratoManuais').innerHTML = '';
      document.getElementById('emailExtratoTexto').value = '';
      
      abrirModal('modalEmailExtrato');
    }
    
    function adicionarEmailManualExtrato() {
      const input = document.getElementById('emailExtratoManual');
      const email = input.value.trim();
      
      if (!email) return;
      if (!email.includes('@')) {
        alert('Email invÃ¡lido!');
        return;
      }
      
      if (emailsExtratoManuaisLista.includes(email)) {
        alert('Email jÃ¡ adicionado!');
        return;
      }
      
      emailsExtratoManuaisLista.push(email);
      input.value = '';
      
      const container = document.getElementById('emailsExtratoManuais');
      container.innerHTML = emailsExtratoManuaisLista.map((e, i) => `
        <span class="inline-flex items-center bg-blue-100 text-blue-800 px-2 py-1 rounded text-sm">
          ${e}
          <button onclick="removerEmailManualExtrato(${i})" class="ml-1 text-blue-600 hover:text-blue-800">Ã—</button>
        </span>
      `).join('');
    }
    
    function removerEmailManualExtrato(index) {
      emailsExtratoManuaisLista.splice(index, 1);
      const container = document.getElementById('emailsExtratoManuais');
      container.innerHTML = emailsExtratoManuaisLista.map((e, i) => `
        <span class="inline-flex items-center bg-blue-100 text-blue-800 px-2 py-1 rounded text-sm">
          ${e}
          <button onclick="removerEmailManualExtrato(${i})" class="ml-1 text-blue-600 hover:text-blue-800">Ã—</button>
        </span>
      `).join('');
    }
    
    function selecionarTextoExtrato(tipo) {
      const cliente = clientes.find(c => c.id == document.getElementById('emailExtratoClienteId').value);
      const nomeCliente = cliente?.nome || 'Cliente';
      const empresa = empresaConfig.nome || 'A nossa empresa';
      
      const textos = {
        lembrete: `Exmo(a). Sr(a).,

Vimos por este meio relembrar que existem faturas pendentes de pagamento.

Segue em anexo o extrato atualizado da vossa conta corrente para vossa anÃ¡lise.

Caso o pagamento jÃ¡ tenha sido efetuado, por favor desconsidere este email.

Agradecemos a vossa atenÃ§Ã£o.

Com os melhores cumprimentos,
${empresa}`,
        
        cobranca: `Exmo(a). Sr(a).,

ApÃ³s verificaÃ§Ã£o das nossas contas, constatamos que existem valores em atraso relativos a faturas anteriormente emitidas.

Solicitamos a regularizaÃ§Ã£o dos valores em dÃ­vida com a maior brevidade possÃ­vel.

Segue em anexo o extrato detalhado para vossa conferÃªncia.

Ficamos ao dispor para qualquer esclarecimento.

Com os melhores cumprimentos,
${empresa}`,
        
        urgente: `Exmo(a). Sr(a).,

AVISO URGENTE DE COBRANÃ‡A

Apesar das nossas anteriores comunicaÃ§Ãµes, verificamos que os valores em dÃ­vida continuam por regularizar.

Informamos que, caso nÃ£o seja efetuado o pagamento nos prÃ³ximos 5 dias Ãºteis, seremos forÃ§ados a tomar medidas adicionais para recuperaÃ§Ã£o do crÃ©dito.

Segue em anexo o extrato atualizado.

Aguardamos contacto urgente.

${empresa}`,
        
        informativo: `Exmo(a). Sr(a).,

Segue em anexo o extrato da vossa conta corrente connosco, para vossa informaÃ§Ã£o e arquivo.

Caso tenha alguma dÃºvida sobre os valores apresentados, por favor entre em contacto connosco.

Com os melhores cumprimentos,
${empresa}`
      };
      
      document.getElementById('emailExtratoTexto').value = textos[tipo] || '';
    }
    
    function enviarEmailExtrato() {
      const clienteId = document.getElementById('emailExtratoClienteId').value;
      const cliente = clientes.find(c => c.id == clienteId);
      
      // Recolher emails selecionados
      const emailsSelecionados = [];
      
      document.querySelectorAll('#emailsExtratoContabilidade input:checked, #emailsExtratoFinanceiro input:checked, #emailsExtratoOutros input:checked').forEach(cb => {
        emailsSelecionados.push(cb.value);
      });
      
      // Adicionar emails manuais
      emailsExtratoManuaisLista.forEach(e => emailsSelecionados.push(e));
      
      if (emailsSelecionados.length === 0) {
        alert('âš ï¸ Selecione pelo menos um email!');
        return;
      }
      
      const textoEmail = document.getElementById('emailExtratoTexto').value;
      if (!textoEmail.trim()) {
        alert('âš ï¸ Escreva o texto do email!');
        return;
      }
      
      // Simular envio
      const condicao = document.getElementById('extratoCondicao').value;
      const condicaoTexto = {
        'divida': 'Faturas em DÃ­vida',
        'completo': 'Extrato Completo',
        'pagas': 'Faturas Pagas'
      }[condicao];
      
      alert(`âœ… Email enviado com sucesso!\n\nğŸ“§ Para: ${emailsSelecionados.join(', ')}\nğŸ“‹ Cliente: ${cliente.nome}\nğŸ“Š Tipo: ${condicaoTexto}\nğŸ“ Anexo: Extrato PDF`);
      
      fecharModal('modalEmailExtrato');
    }
    
    // ========== ANÃLISE DE VENCIMENTOS - MÃ‰DIA DE DIAS DE PAGAMENTO ==========
    
    // Dados temporÃ¡rios para vencimentos
    let dadosVencimentosCC = [];
    
    function renderizarVencimentos() {
      // Calcular estatÃ­sticas por cliente
      const estatisticasClientes = {};
      
      faturas.forEach(f => {
        if (!estatisticasClientes[f.clienteId]) {
          estatisticasClientes[f.clienteId] = {
            cliente: f.cliente,
            totalFaturas: 0,
            faturasPagas: 0,
            diasPagamento: [],
            faturasNoPrazo: 0
          };
        }
        
        const stats = estatisticasClientes[f.clienteId];
        stats.totalFaturas++;
        
        // Se a fatura foi paga (total ou parcialmente com recibos)
        if (f.pago > 0) {
          // Encontrar recibos desta fatura
          const recibosDestafatura = recibos.filter(r => 
            r.clienteId == f.clienteId && 
            (r.faturas.includes(f.numero) || (r.detalhesFaturas && r.detalhesFaturas.some(d => d.faturaNumero === f.numero)))
          );
          
          if (recibosDestafatura.length > 0) {
            stats.faturasPagas++;
            
            // Calcular dias atÃ© pagamento (usando primeiro recibo)
            const primeiroRecibo = recibosDestafatura.sort((a, b) => new Date(a.data) - new Date(b.data))[0];
            const dataFatura = new Date(f.data);
            const dataRecibo = new Date(primeiroRecibo.data);
            const diasAtePagamento = Math.ceil((dataRecibo - dataFatura) / (1000 * 60 * 60 * 24));
            
            stats.diasPagamento.push(diasAtePagamento);
            
            // Verificar se pagou no prazo (antes do vencimento)
            const dataVencimento = new Date(f.vencimento);
            if (dataRecibo <= dataVencimento) {
              stats.faturasNoPrazo++;
            }
          }
        }
      });
      
      // Converter para array e calcular mÃ©dias - SÃ“ CLIENTES COM FATURAS
      dadosVencimentosCC = Object.entries(estatisticasClientes)
        .filter(([id, stats]) => stats.totalFaturas > 0) // SÃ³ clientes com movimentos
        .map(([id, stats]) => {
          const mediaDias = stats.diasPagamento.length > 0 
            ? Math.round(stats.diasPagamento.reduce((a, b) => a + b, 0) / stats.diasPagamento.length) 
            : null;
          const melhorDia = stats.diasPagamento.length > 0 ? Math.min(...stats.diasPagamento) : null;
          const piorDia = stats.diasPagamento.length > 0 ? Math.max(...stats.diasPagamento) : null;
          const taxaPontualidade = stats.faturasPagas > 0 
            ? Math.round((stats.faturasNoPrazo / stats.faturasPagas) * 100) 
            : null;
          
          return {
            id: parseInt(id),
            cliente: stats.cliente,
            totalFaturas: stats.totalFaturas,
            faturasPagas: stats.faturasPagas,
            mediaDias,
            melhorDia,
            piorDia,
            taxaPontualidade
          };
        })
        .sort((a, b) => (b.mediaDias || 999) - (a.mediaDias || 999)); // Ordenar por mÃ©dia de dias (pior primeiro)
      
      filtrarVencimentos();
    }
    
    function filtrarVencimentos() {
      const filtroCliente = (document.getElementById('filtroVencimentosCliente')?.value || '').toLowerCase();
      const filtroDiasMin = parseFloat(document.getElementById('filtroVencimentosDiasMin')?.value) || 0;
      const filtroDiasMax = parseFloat(document.getElementById('filtroVencimentosDiasMax')?.value) || Infinity;
      const filtroPontualidade = document.getElementById('filtroVencimentosPontualidade')?.value || '';
      
      // Pesquisa global do header
      const pesquisaGlobal = (typeof termoPesquisaGlobal !== 'undefined' ? termoPesquisaGlobal : '').toLowerCase();
      
      let filtrados = dadosVencimentosCC.filter(c => {
        // Filtro por nome de cliente (local)
        if (filtroCliente && !c.cliente.toLowerCase().includes(filtroCliente)) return false;
        
        // Filtro por pesquisa global (header)
        if (pesquisaGlobal && pesquisaGlobal.length >= 2) {
          if (!c.cliente.toLowerCase().includes(pesquisaGlobal)) return false;
        }
        
        // Filtro por mÃ©dia de dias
        if (c.mediaDias !== null) {
          if (c.mediaDias < filtroDiasMin) return false;
          if (c.mediaDias > filtroDiasMax) return false;
        }
        
        // Filtro por taxa de pontualidade
        if (filtroPontualidade && c.taxaPontualidade !== null) {
          if (filtroPontualidade === '100' && c.taxaPontualidade !== 100) return false;
          if (filtroPontualidade === '80' && c.taxaPontualidade < 80) return false;
          if (filtroPontualidade === '50' && c.taxaPontualidade < 50) return false;
          if (filtroPontualidade === '0' && c.taxaPontualidade >= 50) return false;
        }
        
        return true;
      });
      
      const tbody = document.getElementById('tabelaVencimentos');
      
      if (filtrados.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center text-slate-500 py-8">Sem clientes com movimentos para os filtros selecionados</td></tr>';
        return;
      }
      
      tbody.innerHTML = filtrados.map(c => {
        // Classe baseada na mÃ©dia de dias
        let mediaClass = 'text-emerald-600';
        if (c.mediaDias !== null) {
          if (c.mediaDias > 60) mediaClass = 'text-red-600 font-bold';
          else if (c.mediaDias > 30) mediaClass = 'text-amber-600 font-bold';
        }
        
        // Classe para taxa de pontualidade
        let taxaClass = 'text-emerald-600';
        if (c.taxaPontualidade !== null) {
          if (c.taxaPontualidade < 50) taxaClass = 'text-red-600';
          else if (c.taxaPontualidade < 80) taxaClass = 'text-amber-600';
        }
        
        return `
          <tr>
            <td class="font-semibold">${c.cliente}</td>
            <td class="text-center">${c.totalFaturas}</td>
            <td class="text-center">${c.faturasPagas}</td>
            <td class="text-center ${mediaClass}">${c.mediaDias !== null ? c.mediaDias + ' dias' : '-'}</td>
            <td class="text-center text-emerald-600">${c.melhorDia !== null ? c.melhorDia + 'd' : '-'}</td>
            <td class="text-center text-red-600">${c.piorDia !== null ? c.piorDia + 'd' : '-'}</td>
            <td class="text-center ${taxaClass}">${c.taxaPontualidade !== null ? c.taxaPontualidade + '%' : '-'}</td>
            <td>
              <button onclick="verExtratoCliente(${c.id})" class="text-blue-600 hover:underline text-sm">Extrato</button>
              <button onclick="imprimirVencimentosCliente(${c.id})" class="text-slate-600 hover:underline text-sm ml-2">ğŸ–¨ï¸ Imprimir</button>
            </td>
          </tr>
        `;
      }).join('');
    }
    
    function limparFiltrosVencimentos() {
      document.getElementById('filtroVencimentosCliente').value = '';
      document.getElementById('filtroVencimentosDiasMin').value = '';
      document.getElementById('filtroVencimentosDiasMax').value = '';
      document.getElementById('filtroVencimentosPontualidade').value = '';
      filtrarVencimentos();
    }
    
    // ========== FUNÃ‡Ã•ES DE IMPRESSÃƒO - CONTAS CORRENTES ==========
    
    function imprimirResumoCliente(clienteId) {
      const cliente = dadosResumoCC.find(c => c.id === clienteId);
      if (!cliente) {
        alert('âš ï¸ Cliente nÃ£o encontrado!');
        return;
      }
      
      const printWindow = window.open('', '_blank');
      printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
          <title>Resumo Conta Corrente - ${cliente.cliente}</title>
          <style>
            body { font-family: Arial, sans-serif; margin: 40px; color: #333; }
            .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #1e40af; padding-bottom: 20px; }
            .header h1 { color: #1e40af; margin: 0; font-size: 24px; }
            .header p { color: #64748b; margin: 5px 0; }
            .empresa { margin-bottom: 20px; }
            .empresa h2 { font-size: 18px; color: #1e40af; margin: 0; }
            .cliente-info { background: #f8fafc; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
            .cliente-info h3 { margin: 0 0 15px 0; color: #334155; }
            .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
            .info-item { padding: 8px 0; }
            .info-label { font-size: 12px; color: #64748b; }
            .info-value { font-size: 16px; font-weight: bold; }
            .valores { margin-top: 20px; }
            .valor-box { display: inline-block; padding: 15px 25px; margin: 5px; border-radius: 8px; text-align: center; }
            .valor-faturado { background: #f1f5f9; }
            .valor-pago { background: #dcfce7; color: #166534; }
            .valor-divida { background: #fef3c7; color: #b45309; }
            .footer { margin-top: 40px; text-align: center; color: #94a3b8; font-size: 12px; }
            @media print { body { margin: 20px; } }
          </style>
        </head>
        <body>
          <div class="header">
            <div class="empresa">
              <h2>${empresaConfig.nome || 'EMEUTRANS'}</h2>
              <p>${empresaConfig.morada || ''}</p>
              <p>NIF: ${empresaConfig.nif || ''}</p>
            </div>
            <h1>ğŸ“’ Resumo de Conta Corrente</h1>
            <p>Data de emissÃ£o: ${new Date().toLocaleDateString('pt-PT')}</p>
          </div>
          
          <div class="cliente-info">
            <h3>Dados do Cliente</h3>
            <div class="info-grid">
              <div class="info-item">
                <div class="info-label">Nome</div>
                <div class="info-value">${cliente.cliente}</div>
              </div>
              <div class="info-item">
                <div class="info-label">NIF</div>
                <div class="info-value">${cliente.nif || '-'}</div>
              </div>
            </div>
          </div>
          
          <div class="valores">
            <div class="valor-box valor-faturado">
              <div class="info-label">Total Faturado</div>
              <div class="info-value">${formatCurrency(cliente.faturado)}</div>
            </div>
            <div class="valor-box valor-pago">
              <div class="info-label">Total Pago</div>
              <div class="info-value">${formatCurrency(cliente.pago)}</div>
            </div>
            <div class="valor-box valor-divida">
              <div class="info-label">Saldo em DÃ­vida</div>
              <div class="info-value">${formatCurrency(cliente.saldo)}</div>
            </div>
          </div>
          
          <div class="footer">
            <p>Documento gerado automaticamente pelo ERP EMEUTRANS</p>
          </div>
        </body>
        </html>
      `);
      printWindow.document.close();
      printWindow.print();
    }
    
    function imprimirExtrato() {
      const clienteId = document.getElementById('extratoCliente').value;
      if (!clienteId) {
        alert('âš ï¸ Selecione um cliente primeiro!');
        return;
      }
      
      const cliente = clientes.find(c => c.id == clienteId);
      if (!cliente) {
        alert('âš ï¸ Cliente nÃ£o encontrado!');
        return;
      }
      
      const condicao = document.getElementById('extratoCondicao').value;
      const dataDe = document.getElementById('extratoDataDe').value;
      const dataAte = document.getElementById('extratoDataAte').value;
      
      // Obter dados do extrato
      const totalFaturado = document.getElementById('extratoTotalFaturado').textContent;
      const totalPago = document.getElementById('extratoTotalPago').textContent;
      const saldoPendente = document.getElementById('extratoSaldoPendente').textContent;
      const numFaturas = document.getElementById('extratoNumFaturas').textContent;
      
      // Obter tabela atual
      const tabelaHTML = document.getElementById('tabelaExtrato').innerHTML;
      
      let condicaoTexto = 'Extrato Completo';
      if (condicao === 'divida') condicaoTexto = 'Faturas em DÃ­vida';
      if (condicao === 'pagas') condicaoTexto = 'Faturas Recebidas';
      
      const printWindow = window.open('', '_blank');
      printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
          <title>Extrato - ${cliente.nome}</title>
          <style>
            body { font-family: Arial, sans-serif; margin: 30px; color: #333; font-size: 12px; }
            .header { text-align: center; margin-bottom: 20px; border-bottom: 2px solid #1e40af; padding-bottom: 15px; }
            .header h1 { color: #1e40af; margin: 0; font-size: 20px; }
            .header p { color: #64748b; margin: 3px 0; }
            .empresa h2 { font-size: 16px; color: #1e40af; margin: 0; }
            .filtros { background: #f8fafc; padding: 10px; border-radius: 6px; margin-bottom: 15px; font-size: 11px; }
            .resumo { display: flex; gap: 15px; margin-bottom: 15px; }
            .resumo-box { flex: 1; padding: 10px; border-radius: 6px; text-align: center; }
            .resumo-faturado { background: #f1f5f9; }
            .resumo-pago { background: #dcfce7; }
            .resumo-pendente { background: #fef3c7; }
            .resumo-faturas { background: #dbeafe; }
            .resumo-label { font-size: 10px; color: #64748b; }
            .resumo-valor { font-size: 14px; font-weight: bold; }
            table { width: 100%; border-collapse: collapse; font-size: 11px; }
            th { background: #1e40af; color: white; padding: 8px 5px; text-align: left; }
            td { padding: 6px 5px; border-bottom: 1px solid #e2e8f0; }
            tr:nth-child(even) { background: #f8fafc; }
            .text-right { text-align: right; }
            .text-center { text-align: center; }
            .footer { margin-top: 20px; text-align: center; color: #94a3b8; font-size: 10px; }
            @media print { body { margin: 15px; } }
          </style>
        </head>
        <body>
          <div class="header">
            <div class="empresa">
              <h2>${empresaConfig.nome || 'EMEUTRANS'}</h2>
              <p>NIF: ${empresaConfig.nif || ''}</p>
            </div>
            <h1>ğŸ“’ Extrato de Conta Corrente</h1>
            <p><strong>Cliente:</strong> ${cliente.nome} | <strong>NIF:</strong> ${cliente.nif || '-'}</p>
            <p>Data de emissÃ£o: ${new Date().toLocaleDateString('pt-PT')}</p>
          </div>
          
          <div class="filtros">
            <strong>Filtros:</strong> ${condicaoTexto}
            ${dataDe ? ' | De: ' + formatDate(dataDe) : ''}
            ${dataAte ? ' | AtÃ©: ' + formatDate(dataAte) : ''}
          </div>
          
          <div class="resumo">
            <div class="resumo-box resumo-faturado">
              <div class="resumo-label">Total Faturado</div>
              <div class="resumo-valor">${totalFaturado}</div>
            </div>
            <div class="resumo-box resumo-pago">
              <div class="resumo-label">Total Pago</div>
              <div class="resumo-valor">${totalPago}</div>
            </div>
            <div class="resumo-box resumo-pendente">
              <div class="resumo-label">Saldo Pendente</div>
              <div class="resumo-valor">${saldoPendente}</div>
            </div>
            <div class="resumo-box resumo-faturas">
              <div class="resumo-label">Faturas Pendentes</div>
              <div class="resumo-valor">${numFaturas}</div>
            </div>
          </div>
          
          <table>
            <thead>
              <tr>
                <th>Data</th>
                <th>Documento</th>
                <th>DescriÃ§Ã£o</th>
                <th>Ref. Cliente</th>
                <th class="text-right">Valor Doc.</th>
                <th class="text-right">DÃ©bito</th>
                <th class="text-right">CrÃ©dito</th>
                <th class="text-right">Em DÃ­vida</th>
                <th class="text-right">Saldo</th>
              </tr>
            </thead>
            <tbody>
              ${tabelaHTML}
            </tbody>
          </table>
          
          <div class="footer">
            <p>Documento gerado automaticamente pelo ERP EMEUTRANS</p>
          </div>
        </body>
        </html>
      `);
      printWindow.document.close();
      printWindow.print();
    }
    
    function imprimirVencimentosCliente(clienteId) {
      const cliente = dadosVencimentosCC.find(c => c.id === clienteId);
      if (!cliente) {
        alert('âš ï¸ Cliente nÃ£o encontrado!');
        return;
      }
      
      let mediaClass = '#059669';
      if (cliente.mediaDias !== null) {
        if (cliente.mediaDias > 60) mediaClass = '#dc2626';
        else if (cliente.mediaDias > 30) mediaClass = '#d97706';
      }
      
      let taxaClass = '#059669';
      if (cliente.taxaPontualidade !== null) {
        if (cliente.taxaPontualidade < 50) taxaClass = '#dc2626';
        else if (cliente.taxaPontualidade < 80) taxaClass = '#d97706';
      }
      
      const printWindow = window.open('', '_blank');
      printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
          <title>AnÃ¡lise de Vencimentos - ${cliente.cliente}</title>
          <style>
            body { font-family: Arial, sans-serif; margin: 40px; color: #333; }
            .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #1e40af; padding-bottom: 20px; }
            .header h1 { color: #1e40af; margin: 0; font-size: 24px; }
            .header p { color: #64748b; margin: 5px 0; }
            .empresa h2 { font-size: 18px; color: #1e40af; margin: 0; }
            .cliente-info { background: #f8fafc; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
            .cliente-info h3 { margin: 0 0 15px 0; color: #334155; }
            .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 20px; }
            .stat-box { padding: 15px; border-radius: 8px; text-align: center; }
            .stat-label { font-size: 12px; color: #64748b; }
            .stat-value { font-size: 20px; font-weight: bold; margin-top: 5px; }
            .stat-faturas { background: #f1f5f9; }
            .stat-pagas { background: #dcfce7; }
            .stat-media { background: #fef3c7; }
            .stat-melhor { background: #dcfce7; }
            .stat-pior { background: #fee2e2; }
            .stat-taxa { background: #dbeafe; }
            .footer { margin-top: 40px; text-align: center; color: #94a3b8; font-size: 12px; }
            @media print { body { margin: 20px; } }
          </style>
        </head>
        <body>
          <div class="header">
            <div class="empresa">
              <h2>${empresaConfig.nome || 'EMEUTRANS'}</h2>
              <p>NIF: ${empresaConfig.nif || ''}</p>
            </div>
            <h1>ğŸ“Š AnÃ¡lise de Vencimentos</h1>
            <p>Data de emissÃ£o: ${new Date().toLocaleDateString('pt-PT')}</p>
          </div>
          
          <div class="cliente-info">
            <h3>Cliente: ${cliente.cliente}</h3>
            
            <div class="stats-grid">
              <div class="stat-box stat-faturas">
                <div class="stat-label">Total de Faturas</div>
                <div class="stat-value">${cliente.totalFaturas}</div>
              </div>
              <div class="stat-box stat-pagas">
                <div class="stat-label">Faturas Pagas</div>
                <div class="stat-value">${cliente.faturasPagas}</div>
              </div>
              <div class="stat-box stat-media">
                <div class="stat-label">MÃ©dia Dias Pagamento</div>
                <div class="stat-value" style="color: ${mediaClass}">${cliente.mediaDias !== null ? cliente.mediaDias + ' dias' : '-'}</div>
              </div>
              <div class="stat-box stat-melhor">
                <div class="stat-label">Melhor (dias)</div>
                <div class="stat-value">${cliente.melhorDia !== null ? cliente.melhorDia : '-'}</div>
              </div>
              <div class="stat-box stat-pior">
                <div class="stat-label">Pior (dias)</div>
                <div class="stat-value">${cliente.piorDia !== null ? cliente.piorDia : '-'}</div>
              </div>
              <div class="stat-box stat-taxa">
                <div class="stat-label">Taxa de Pontualidade</div>
                <div class="stat-value" style="color: ${taxaClass}">${cliente.taxaPontualidade !== null ? cliente.taxaPontualidade + '%' : '-'}</div>
              </div>
            </div>
          </div>
          
          <div class="footer">
            <p>Documento gerado automaticamente pelo ERP EMEUTRANS</p>
          </div>
        </body>
        </html>
      `);
      printWindow.document.close();
      printWindow.print();
    }
    
    // ========== FIM FUNÃ‡Ã•ES DE IMPRESSÃƒO ==========

    function abrirReciboCliente(clienteId) {
      abrirNovoRecibo();
      document.getElementById('reciboCliente').value = clienteId;
      carregarFaturasCliente();
    }
    
    function mudarTabCC(tab) {
      // LIMPAR MOTOR DE BUSCA GLOBAL ao mudar de tab
      const pesquisaGlobal = document.getElementById('pesquisaGlobal');
      if (pesquisaGlobal) {
        pesquisaGlobal.value = '';
      }
      termoPesquisaGlobal = '';
      
      document.querySelectorAll('[id^="tab-cc-"]').forEach(t => t.classList.remove('active'));
      document.getElementById('tab-cc-' + tab).classList.add('active');
      
      document.querySelectorAll('#page-contascorrentes .tab-btn').forEach((b, i) => {
        b.classList.toggle('active', ['resumo', 'extrato', 'vencimentos'][i] === tab);
      });
      
      // Re-renderizar dados (jÃ¡ sem filtro de pesquisa global)
      if (tab === 'resumo') filtrarResumoCC();
      else if (tab === 'vencimentos') filtrarVencimentos();
    }
    
    /* â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
       â•‘  ğŸ”’ FIM DA SECÃ‡ÃƒO BLOQUEADA - CONTAS CORRENTES v4.6                          â•‘
       â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    
    // ==================== EMAIL ====================
    
    function abrirEnviarEmail(faturaId) {
      const f = faturas.find(x => x.id == faturaId);
      if (!f) return;
      
      const cliente = clientes.find(c => c.id === f.clienteId);
      
      document.getElementById('emailFaturaId').value = faturaId;
      
      // Emails de contabilidade
      const emailsCont = cliente?.emailsContabilidade || [];
      document.getElementById('emailsContabilidade').innerHTML = emailsCont.length 
        ? emailsCont.map(e => `<label class="checkbox-container"><input type="checkbox" value="${e}" checked><span>${e}</span></label>`).join('')
        : '<p class="text-slate-500">Sem emails de contabilidade configurados</p>';
      
      // Outros emails
      const emailsOutros = cliente?.emailsGerais || [];
      document.getElementById('emailsOutros').innerHTML = emailsOutros.length
        ? emailsOutros.map(e => `<label class="checkbox-container"><input type="checkbox" value="${e}"><span>${e}</span></label>`).join('')
        : '<p class="text-slate-500">Sem outros emails</p>';
      
      document.getElementById('emailManual').value = '';
      
      // Limpar anexos adicionais
      document.getElementById('anexosAdicionais').innerHTML = '';
      
      abrirModal('modalEnviarEmail');
    }
    
    // CORREÃ‡ÃƒO: FunÃ§Ã£o para adicionar anexos
    let anexoCount = 0;
    function adicionarAnexo() {
      anexoCount++;
      const container = document.getElementById('anexosAdicionais');
      const div = document.createElement('div');
      div.id = `anexo-${anexoCount}`;
      div.className = 'flex items-center gap-2 mt-2 p-2 bg-white rounded border';
      div.innerHTML = `
        <input type="file" id="ficheiro-${anexoCount}" class="flex-1 text-sm" accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.png">
        <button type="button" onclick="removerAnexo(${anexoCount})" class="text-red-500 hover:text-red-700 px-2">âœ–</button>
      `;
      container.appendChild(div);
    }
    
    function removerAnexo(id) {
      const anexo = document.getElementById(`anexo-${id}`);
      if (anexo) anexo.remove();
    }
    
    function enviarEmailFatura() {
      const faturaId = document.getElementById('emailFaturaId').value;
      const f = faturas.find(x => x.id == faturaId);
      if (!f) return;
      
      // Recolher emails selecionados
      const emailsSelecionados = [];
      document.querySelectorAll('#emailsContabilidade input:checked, #emailsOutros input:checked').forEach(cb => {
        emailsSelecionados.push(cb.value);
      });
      
      const emailManual = document.getElementById('emailManual').value;
      if (emailManual) emailsSelecionados.push(emailManual);
      
      if (emailsSelecionados.length === 0) {
        alert('Selecione pelo menos um email!');
        return;
      }
      
      // Contar anexos adicionais
      const anexosAdicionais = [];
      document.querySelectorAll('#anexosAdicionais input[type="file"]').forEach(input => {
        if (input.files && input.files.length > 0) {
          anexosAdicionais.push(input.files[0].name);
        }
      });
      
      // Simular envio
      f.emailEnviado = true;
      f.dataEmailEnviado = new Date().toISOString();
      f.emailsEnviados = emailsSelecionados;
      f.anexosEnviados = ['Fatura (PDF)', 'CMR(s)', ...anexosAdicionais];
      
      guardarDados();
      fecharModal('modalEnviarEmail');
      renderizarFaturas();
      atualizarDashboard();
      
      // Construir lista de anexos para mensagem
      let listaAnexos = '- Fatura (PDF)\n- CMR(s)';
      if (anexosAdicionais.length > 0) {
        anexosAdicionais.forEach(nome => {
          listaAnexos += `\n- ${nome}`;
        });
      }
      
      const totalAnexos = 2 + anexosAdicionais.length; // Fatura + CMR + adicionais
      
      alert(`âœ… Email enviado com sucesso!\n\nFatura: ${f.numero}\nPara: ${emailsSelecionados.join(', ')}\n\nğŸ“ Total de anexos: ${totalAnexos}\n${listaAnexos}`);
    }
    
    /* ğŸ”’ BLOQUEADO - EMAIL RECIBO v4.3 */
    // ==================== EMAIL RECIBO ====================
    
    // VariÃ¡vel para guardar dados do recibo a enviar apÃ³s emitir
    let reciboParaEnviarEmail = null;
    let anexoReciboCount = 0;
    
    function abrirEnviarEmailRecibo(reciboId) {
      const r = recibos.find(x => x.id == reciboId);
      if (!r) return;
      
      const cliente = clientes.find(c => c.id === r.clienteId);
      
      document.getElementById('emailReciboId').value = reciboId;
      
      // Info do recibo
      document.getElementById('infoReciboEmail').innerHTML = `
        <strong>Recibo:</strong> ${r.numero}<br>
        <strong>Cliente:</strong> ${r.cliente}<br>
        <strong>Valor:</strong> ${formatCurrency(r.valor)}<br>
        <strong>Faturas:</strong> ${r.faturas.join(', ')}
      `;
      
      // Emails de contabilidade
      const emailsCont = cliente?.emailsContabilidade || [];
      document.getElementById('emailsContabilidadeRecibo').innerHTML = emailsCont.length 
        ? emailsCont.map(e => `<label class="checkbox-container"><input type="checkbox" value="${e}" checked><span>${e}</span></label>`).join('')
        : '<p class="text-slate-500">Sem emails de contabilidade configurados</p>';
      
      // Emails financeiros
      const emailsFin = cliente?.emailsFinanceiro || [];
      document.getElementById('emailsFinanceiroRecibo').innerHTML = emailsFin.length
        ? emailsFin.map(e => `<label class="checkbox-container"><input type="checkbox" value="${e}" checked><span>${e}</span></label>`).join('')
        : '<p class="text-slate-500">Sem emails financeiros configurados</p>';
      
      document.getElementById('emailManualRecibo').value = '';
      document.getElementById('anexosAdicionaisRecibo').innerHTML = '';
      
      abrirModal('modalEnviarEmailRecibo');
    }
    
    function adicionarAnexoRecibo() {
      anexoReciboCount++;
      const container = document.getElementById('anexosAdicionaisRecibo');
      const div = document.createElement('div');
      div.id = `anexo-recibo-${anexoReciboCount}`;
      div.className = 'flex items-center gap-2 mt-2 p-2 bg-white rounded border';
      div.innerHTML = `
        <input type="file" id="ficheiro-recibo-${anexoReciboCount}" class="flex-1 text-sm" accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.png">
        <button type="button" onclick="removerAnexoRecibo(${anexoReciboCount})" class="text-red-500 hover:text-red-700 px-2">âœ–</button>
      `;
      container.appendChild(div);
    }
    
    function removerAnexoRecibo(id) {
      const anexo = document.getElementById(`anexo-recibo-${id}`);
      if (anexo) anexo.remove();
    }
    
    function enviarEmailRecibo() {
      const reciboId = document.getElementById('emailReciboId').value;
      const r = recibos.find(x => x.id == reciboId);
      if (!r) return;
      
      // Recolher emails selecionados
      const emailsSelecionados = [];
      document.querySelectorAll('#emailsContabilidadeRecibo input:checked, #emailsFinanceiroRecibo input:checked').forEach(cb => {
        emailsSelecionados.push(cb.value);
      });
      
      const emailManual = document.getElementById('emailManualRecibo').value;
      if (emailManual) emailsSelecionados.push(emailManual);
      
      if (emailsSelecionados.length === 0) {
        alert('Selecione pelo menos um email!');
        return;
      }
      
      // Contar anexos adicionais
      const anexosAdicionais = [];
      document.querySelectorAll('#anexosAdicionaisRecibo input[type="file"]').forEach(input => {
        if (input.files && input.files.length > 0) {
          anexosAdicionais.push(input.files[0].name);
        }
      });
      
      // Simular envio
      r.emailEnviado = true;
      r.dataEmailEnviado = new Date().toISOString();
      r.emailsEnviados = emailsSelecionados;
      
      guardarDados();
      fecharModal('modalEnviarEmailRecibo');
      renderizarRecibos();
      
      // Construir lista de anexos para mensagem
      let listaAnexos = '- Recibo (PDF)';
      if (anexosAdicionais.length > 0) {
        anexosAdicionais.forEach(nome => {
          listaAnexos += `\n- ${nome}`;
        });
      }
      
      const totalAnexos = 1 + anexosAdicionais.length;
      
      alert(`âœ… Email enviado com sucesso!\n\nRecibo: ${r.numero}\nPara: ${emailsSelecionados.join(', ')}\n\nğŸ“ Total de anexos: ${totalAnexos}\n${listaAnexos}`);
    }
    
    // FunÃ§Ã£o para perguntar se quer enviar email apÃ³s emitir recibo
    function perguntarEnviarEmailRecibo(reciboId, resumo) {
      const r = recibos.find(x => x.id == reciboId);
      if (!r) {
        alert(resumo);
        return;
      }
      
      const cliente = clientes.find(c => c.id === r.clienteId);
      const temEmails = (cliente?.emailsContabilidade?.length > 0) || (cliente?.emailsFinanceiro?.length > 0);
      
      if (temEmails) {
        // Mostrar confirmaÃ§Ã£o com opÃ§Ã£o de enviar email
        if (confirm(resumo + '\n\nğŸ“§ Deseja enviar este recibo por email para o cliente?')) {
          abrirEnviarEmailRecibo(reciboId);
        }
      } else {
        // Sem emails configurados, sÃ³ mostrar resumo
        alert(resumo + '\n\nâš ï¸ Cliente sem emails configurados na ficha.');
      }
    }
    
    /* ğŸ”’ FIM BLOQUEADO - EMAIL RECIBO */
    
    // ==================== SÃ‰RIES DE DOCUMENTOS ====================
    
    // HistÃ³rico de alteraÃ§Ãµes das sÃ©ries
    let seriesHistorico = [];
    
    function renderizarSeries() {
      renderizarResumoSeries();
      renderizarTabelaSeries();
      renderizarHistoricoSeries();
    }
    
    function renderizarResumoSeries() {
      const resumoDiv = document.getElementById('seriesResumo');
      if (!resumoDiv) return;
      
      // Calcular estatÃ­sticas
      const seriesAtivas = series.filter(s => s.estado === 'Ativo').length;
      const seriesInativas = series.filter(s => s.estado !== 'Ativo').length;
      const totalDocumentos = calcularTotalDocumentosEmitidos();
      const anoAtual = new Date().getFullYear();
      const seriesAnoAtual = series.filter(s => s.ano === anoAtual).length;
      
      resumoDiv.innerHTML = `
        <div class="p-3 bg-emerald-100 rounded-lg text-center">
          <div class="text-xs text-emerald-600">SÃ©ries Ativas</div>
          <div class="text-xl font-bold text-emerald-700">${seriesAtivas}</div>
        </div>
        <div class="p-3 bg-red-100 rounded-lg text-center">
          <div class="text-xs text-red-600">SÃ©ries Inativas</div>
          <div class="text-xl font-bold text-red-700">${seriesInativas}</div>
        </div>
        <div class="p-3 bg-blue-100 rounded-lg text-center">
          <div class="text-xs text-blue-600">Faturas Emitidas</div>
          <div class="text-xl font-bold text-blue-700">${faturas.length}</div>
        </div>
        <div class="p-3 bg-purple-100 rounded-lg text-center">
          <div class="text-xs text-purple-600">Recibos Emitidos</div>
          <div class="text-xl font-bold text-purple-700">${recibos.length}</div>
        </div>
        <div class="p-3 bg-amber-100 rounded-lg text-center">
          <div class="text-xs text-amber-600">Notas CrÃ©dito</div>
          <div class="text-xl font-bold text-amber-700">${notasCredito.length}</div>
        </div>
        <div class="p-3 bg-slate-100 rounded-lg text-center">
          <div class="text-xs text-slate-600">Ano Atual</div>
          <div class="text-xl font-bold text-slate-700">${anoAtual}</div>
        </div>
      `;
    }
    
    function calcularTotalDocumentosEmitidos() {
      return faturas.length + recibos.length + notasCredito.length;
    }
    
    function contarDocumentosPorSerie(serieCodigo) {
      switch(serieCodigo) {
        case 'FT': return faturas.length;
        case 'RC': return recibos.length;
        case 'NC': return notasCredito.length;
        default: return 0;
      }
    }
    
    function renderizarTabelaSeries() {
      const tbody = document.getElementById('tabelaSeries');
      if (!tbody) return;
      
      // Aplicar pesquisa global
      let seriesFiltradas = [...series];
      
      if (termoPesquisaGlobal && termoPesquisaGlobal.length >= 2) {
        seriesFiltradas = seriesFiltradas.filter(s => 
          s.tipo.toLowerCase().includes(termoPesquisaGlobal) ||
          s.serie.toLowerCase().includes(termoPesquisaGlobal) ||
          (s.prefixo || '').toLowerCase().includes(termoPesquisaGlobal) ||
          s.ano.toString().includes(termoPesquisaGlobal) ||
          s.estado.toLowerCase().includes(termoPesquisaGlobal)
        );
      }
      
      if (seriesFiltradas.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center text-slate-500 py-8">Sem sÃ©ries encontradas</td></tr>';
        return;
      }
      
      tbody.innerHTML = seriesFiltradas.map(s => {
        const docsEmitidos = contarDocumentosPorSerie(s.serie);
        const estadoClass = s.estado === 'Ativo' ? 'badge-success' : 'badge-danger';
        const estadoIcon = s.estado === 'Ativo' ? 'âœ…' : 'âŒ';
        
        return `
          <tr class="${s.estado !== 'Ativo' ? 'opacity-50' : ''}">
            <td>${s.tipo}</td>
            <td class="font-mono font-bold text-blue-600">${s.serie}</td>
            <td class="font-mono">${s.prefixo || s.serie}</td>
            <td class="font-mono font-bold">${s.ano}/${s.proxNum}</td>
            <td>${s.ano}</td>
            <td class="text-center">
              <span class="bg-slate-200 text-slate-700 px-2 py-1 rounded-full text-xs font-bold">${docsEmitidos}</span>
            </td>
            <td><span class="badge ${estadoClass}">${estadoIcon} ${s.estado}</span></td>
            <td>
              <div class="flex gap-1">
                <button onclick="editarSerie(${s.id})" class="text-blue-600 hover:underline text-sm" title="Editar">âœï¸</button>
                <button onclick="toggleEstadoSerie(${s.id})" class="text-amber-600 hover:underline text-sm" title="${s.estado === 'Ativo' ? 'Desativar' : 'Ativar'}">${s.estado === 'Ativo' ? 'â¸ï¸' : 'â–¶ï¸'}</button>
                <button onclick="resetarSerie(${s.id})" class="text-red-600 hover:underline text-sm" title="Resetar NumeraÃ§Ã£o">ğŸ”„</button>
                ${docsEmitidos === 0 ? `<button onclick="eliminarSerie(${s.id})" class="text-red-600 hover:underline text-sm" title="Eliminar">ğŸ—‘ï¸</button>` : ''}
              </div>
            </td>
          </tr>
        `;
      }).join('');
    }
    
    function renderizarHistoricoSeries() {
      const historicoDiv = document.getElementById('seriesHistorico');
      if (!historicoDiv) return;
      
      // Carregar histÃ³rico do localStorage
      seriesHistorico = JSON.parse(localStorage.getItem('erpSeriesHistorico') || '[]');
      
      if (seriesHistorico.length === 0) {
        historicoDiv.innerHTML = '<p class="text-slate-400 italic">Sem alteraÃ§Ãµes registadas</p>';
        return;
      }
      
      historicoDiv.innerHTML = seriesHistorico.slice(-20).reverse().map(h => `
        <div class="flex items-center gap-2 py-1 border-b border-slate-200 last:border-0">
          <span class="text-xs text-slate-400">${h.data}</span>
          <span class="text-xs px-2 py-0.5 rounded ${h.tipo === 'criar' ? 'bg-emerald-100 text-emerald-700' : h.tipo === 'editar' ? 'bg-blue-100 text-blue-700' : h.tipo === 'estado' ? 'bg-amber-100 text-amber-700' : 'bg-red-100 text-red-700'}">${h.tipo.toUpperCase()}</span>
          <span class="text-sm">${h.descricao}</span>
        </div>
      `).join('');
    }
    
    function registarHistoricoSeries(tipo, descricao) {
      seriesHistorico.push({
        data: new Date().toLocaleString('pt-PT'),
        tipo: tipo,
        descricao: descricao
      });
      localStorage.setItem('erpSeriesHistorico', JSON.stringify(seriesHistorico));
    }
    
    function abrirNovaSerie() {
      document.getElementById('modalSerieTitulo').textContent = 'â• Nova SÃ©rie';
      document.getElementById('serieEditarId').value = '';
      document.getElementById('serieTipo').value = '';
      document.getElementById('serieCodigo').value = '';
      document.getElementById('seriePrefixo').value = '';
      document.getElementById('serieProxNum').value = '1';
      document.getElementById('serieAno').value = new Date().getFullYear();
      document.querySelector('input[name="serieEstado"][value="Ativo"]').checked = true;
      
      abrirModal('modalSerie');
    }
    
    function editarSerie(id) {
      const serie = series.find(s => s.id === id);
      if (!serie) {
        alert('âš ï¸ SÃ©rie nÃ£o encontrada!');
        return;
      }
      
      document.getElementById('modalSerieTitulo').textContent = 'âœï¸ Editar SÃ©rie';
      document.getElementById('serieEditarId').value = id;
      document.getElementById('serieTipo').value = serie.tipo;
      document.getElementById('serieCodigo').value = serie.serie;
      document.getElementById('seriePrefixo').value = serie.prefixo || serie.serie;
      document.getElementById('serieProxNum').value = serie.proxNum;
      document.getElementById('serieAno').value = serie.ano;
      document.querySelector(`input[name="serieEstado"][value="${serie.estado}"]`).checked = true;
      
      abrirModal('modalSerie');
    }
    
    function sugerirPrefixoSerie() {
      const tipo = document.getElementById('serieTipo').value;
      const codigoInput = document.getElementById('serieCodigo');
      const prefixoInput = document.getElementById('seriePrefixo');
      
      // Se jÃ¡ tem cÃ³digo, nÃ£o alterar
      if (codigoInput.value) return;
      
      const sugestoes = {
        'Fatura': 'FT',
        'Fatura Simplificada': 'FS',
        'Fatura-Recibo': 'FR',
        'Nota CrÃ©dito': 'NC',
        'Nota DÃ©bito': 'ND',
        'Recibo': 'RC',
        'Guia Transporte': 'GT',
        'Guia Remessa': 'GR',
        'OrÃ§/CotaÃ§Ã£o': 'OR',
        'RequisiÃ§Ã£o': 'RQ',
        'Pagamento Fornecedor': 'PF',
        'DÃ©bito Fornecedor': 'DF'
      };
      
      if (sugestoes[tipo]) {
        codigoInput.value = sugestoes[tipo];
        prefixoInput.value = sugestoes[tipo];
      }
    }
    
    function guardarSerie() {
      const editarId = document.getElementById('serieEditarId').value;
      const tipo = document.getElementById('serieTipo').value;
      const codigo = document.getElementById('serieCodigo').value.toUpperCase().trim();
      const prefixo = document.getElementById('seriePrefixo').value.trim() || codigo;
      const proxNum = parseInt(document.getElementById('serieProxNum').value) || 1;
      const ano = parseInt(document.getElementById('serieAno').value) || new Date().getFullYear();
      const estado = document.querySelector('input[name="serieEstado"]:checked').value;
      
      // ValidaÃ§Ãµes
      if (!tipo) {
        alert('âš ï¸ Selecione o tipo de documento!');
        return;
      }
      if (!codigo || codigo.length < 2) {
        alert('âš ï¸ O cÃ³digo da sÃ©rie deve ter pelo menos 2 caracteres!');
        return;
      }
      if (!/^[A-Z]{2,4}$/.test(codigo)) {
        alert('âš ï¸ O cÃ³digo da sÃ©rie deve conter apenas letras (2 a 4 caracteres)!');
        return;
      }
      
      // Verificar duplicados
      const duplicado = series.find(s => s.serie === codigo && s.id != editarId);
      if (duplicado) {
        alert(`âš ï¸ JÃ¡ existe uma sÃ©rie com o cÃ³digo "${codigo}"!`);
        return;
      }
      
      if (editarId) {
        // Editar sÃ©rie existente
        const serie = series.find(s => s.id == editarId);
        if (serie) {
          const alteracoes = [];
          if (serie.tipo !== tipo) alteracoes.push(`tipo: ${serie.tipo} â†’ ${tipo}`);
          if (serie.serie !== codigo) alteracoes.push(`cÃ³digo: ${serie.serie} â†’ ${codigo}`);
          if (serie.proxNum !== proxNum) alteracoes.push(`prÃ³x.nÂº: ${serie.proxNum} â†’ ${proxNum}`);
          if (serie.ano !== ano) alteracoes.push(`ano: ${serie.ano} â†’ ${ano}`);
          if (serie.estado !== estado) alteracoes.push(`estado: ${serie.estado} â†’ ${estado}`);
          
          serie.tipo = tipo;
          serie.serie = codigo;
          serie.prefixo = prefixo;
          serie.proxNum = proxNum;
          serie.ano = ano;
          serie.estado = estado;
          
          if (alteracoes.length > 0) {
            registarHistoricoSeries('editar', `SÃ©rie ${codigo}: ${alteracoes.join(', ')}`);
          }
        }
      } else {
        // Criar nova sÃ©rie
        const novoId = series.length > 0 ? Math.max(...series.map(s => s.id)) + 1 : 1;
        series.push({
          id: novoId,
          tipo: tipo,
          serie: codigo,
          prefixo: prefixo,
          proxNum: proxNum,
          ano: ano,
          estado: estado
        });
        registarHistoricoSeries('criar', `Nova sÃ©rie ${codigo} (${tipo}) criada`);
      }
      
      guardarDados();
      fecharModal('modalSerie');
      renderizarSeries();
      
      alert(editarId ? 'âœ… SÃ©rie atualizada com sucesso!' : 'âœ… Nova sÃ©rie criada com sucesso!');
    }
    
    function toggleEstadoSerie(id) {
      const serie = series.find(s => s.id === id);
      if (!serie) return;
      
      const novoEstado = serie.estado === 'Ativo' ? 'Inativo' : 'Ativo';
      const acao = novoEstado === 'Ativo' ? 'ativar' : 'desativar';
      
      if (!confirm(`Tem a certeza que deseja ${acao} a sÃ©rie ${serie.serie}?`)) {
        return;
      }
      
      serie.estado = novoEstado;
      registarHistoricoSeries('estado', `SÃ©rie ${serie.serie} ${novoEstado === 'Ativo' ? 'ativada' : 'desativada'}`);
      guardarDados();
      renderizarSeries();
    }
    
    function resetarSerie(id) {
      const serie = series.find(s => s.id === id);
      if (!serie) return;
      
      const docsEmitidos = contarDocumentosPorSerie(serie.serie);
      
      if (docsEmitidos > 0) {
        alert(`âš ï¸ NÃ£o Ã© possÃ­vel resetar a sÃ©rie ${serie.serie} porque jÃ¡ tem ${docsEmitidos} documento(s) emitido(s).`);
        return;
      }
      
      if (!confirm(`âš ï¸ Tem a certeza que deseja resetar a sÃ©rie ${serie.serie}?\n\nIsto irÃ¡ reiniciar a numeraÃ§Ã£o para 1.`)) {
        return;
      }
      
      const numeroAnterior = serie.proxNum;
      serie.proxNum = 1;
      registarHistoricoSeries('editar', `SÃ©rie ${serie.serie} resetada (${numeroAnterior} â†’ 1)`);
      guardarDados();
      renderizarSeries();
      
      alert(`âœ… SÃ©rie ${serie.serie} resetada com sucesso!`);
    }
    
    function eliminarSerie(id) {
      const serie = series.find(s => s.id === id);
      if (!serie) return;
      
      const docsEmitidos = contarDocumentosPorSerie(serie.serie);
      
      if (docsEmitidos > 0) {
        alert(`âš ï¸ NÃ£o Ã© possÃ­vel eliminar a sÃ©rie ${serie.serie} porque jÃ¡ tem ${docsEmitidos} documento(s) emitido(s).`);
        return;
      }
      
      if (!confirm(`âš ï¸ Tem a certeza que deseja eliminar a sÃ©rie ${serie.serie}?\n\nEsta aÃ§Ã£o nÃ£o pode ser revertida.`)) {
        return;
      }
      
      series = series.filter(s => s.id !== id);
      registarHistoricoSeries('eliminar', `SÃ©rie ${serie.serie} (${serie.tipo}) eliminada`);
      guardarDados();
      renderizarSeries();
      
      alert(`âœ… SÃ©rie ${serie.serie} eliminada com sucesso!`);
    }
    
    function verificarMudancaAno() {
      const anoAtual = series.length > 0 ? series[0].ano : new Date().getFullYear();
      const novoAno = new Date().getFullYear();
      
      document.getElementById('mudancaAnoAtual').value = anoAtual;
      document.getElementById('mudancaNovoAno').value = novoAno > anoAtual ? novoAno : anoAtual + 1;
      document.getElementById('mudancaConfirmar').checked = false;
      
      abrirModal('modalMudancaAno');
    }
    
    function executarMudancaAno() {
      const novoAno = parseInt(document.getElementById('mudancaNovoAno').value);
      const confirmar = document.getElementById('mudancaConfirmar').checked;
      
      if (!confirmar) {
        alert('âš ï¸ Deve confirmar que pretende executar a mudanÃ§a de ano!');
        return;
      }
      
      if (!novoAno || novoAno < 2020 || novoAno > 2099) {
        alert('âš ï¸ Ano invÃ¡lido!');
        return;
      }
      
      const anoAnterior = series.length > 0 ? series[0].ano : new Date().getFullYear();
      
      if (novoAno <= anoAnterior) {
        alert(`âš ï¸ O novo ano (${novoAno}) deve ser superior ao ano atual (${anoAnterior})!`);
        return;
      }
      
      // Atualizar todas as sÃ©ries ativas
      let seriesAtualizadas = 0;
      series.forEach(s => {
        if (s.estado === 'Ativo') {
          s.ano = novoAno;
          s.proxNum = 1;
          seriesAtualizadas++;
        }
      });
      
      registarHistoricoSeries('ano', `MudanÃ§a de ano: ${anoAnterior} â†’ ${novoAno} (${seriesAtualizadas} sÃ©ries atualizadas, numeraÃ§Ã£o reiniciada)`);
      guardarDados();
      fecharModal('modalMudancaAno');
      renderizarSeries();
      
      alert(`âœ… MudanÃ§a de ano executada com sucesso!\n\n${seriesAtualizadas} sÃ©ries atualizadas para ${novoAno}.\nTodas as numeraÃ§Ãµes foram reiniciadas para 1.`);
    }
    
    // FunÃ§Ã£o para obter sÃ©rie ativa por cÃ³digo
    function obterSerieAtiva(codigo) {
      return series.find(s => s.serie === codigo && s.estado === 'Ativo');
    }
    
    // Verificar se sÃ©rie estÃ¡ ativa antes de emitir documento
    function verificarSerieAtiva(codigo) {
      const serie = obterSerieAtiva(codigo);
      if (!serie) {
        alert(`âš ï¸ A sÃ©rie ${codigo} nÃ£o estÃ¡ ativa ou nÃ£o existe!\n\nVÃ¡ a "SÃ©ries de Documentos" para ativar ou criar a sÃ©rie.`);
        return false;
      }
      return true;
    }

    // ==================== CONFIGURAÃ‡Ã•ES ====================
    
    function mudarTabConfig(tab) {
      document.querySelectorAll('[id^="tab-cfg-"]').forEach(t => t.classList.remove('active'));
      document.getElementById('tab-cfg-' + tab).classList.add('active');
      
      document.querySelectorAll('#page-configuracoes .tab-btn').forEach((b, i) => {
        b.classList.toggle('active', ['empresa', 'geral', 'iva', 'emails', 'textos', 'diagnostico'][i] === tab);
      });
      
      // Se for tab de diagnÃ³stico, inicializar
      if (tab === 'diagnostico') {
        // Preencher info do sistema
        document.getElementById('diagNavegador').textContent = navigator.userAgent.includes('Chrome') ? 'Chrome' : 
          navigator.userAgent.includes('Firefox') ? 'Firefox' : 
          navigator.userAgent.includes('Safari') ? 'Safari' : 
          navigator.userAgent.includes('Edge') ? 'Edge' : 'Outro';
        document.getElementById('diagOnline').textContent = navigator.onLine ? 'âœ… Sim' : 'âŒ NÃ£o';
        document.getElementById('diagStorage').textContent = typeof localStorage !== 'undefined' ? 'âœ… DisponÃ­vel' : 'âŒ IndisponÃ­vel';
        
        // Renderizar painel de logs
        renderizarPainelLogs();
        
        registarLog('INFO', 'Painel de diagnÃ³stico aberto');
      }
    }
    
    // ==================== DADOS DA EMPRESA ====================
    
    function carregarDadosEmpresaForm() {
      // Carregar dados atuais da empresaConfig para o formulÃ¡rio
      document.getElementById('cfgEmpresaNome').value = empresaConfig.nome || '';
      document.getElementById('cfgEmpresaNIF').value = empresaConfig.nif || '';
      document.getElementById('cfgEmpresaMorada').value = empresaConfig.morada || '';
      document.getElementById('cfgEmpresaLocalidade').value = empresaConfig.localidade || '';
      document.getElementById('cfgEmpresaTelefone').value = empresaConfig.telefone || '';
      document.getElementById('cfgEmpresaEmail').value = empresaConfig.email || '';
      document.getElementById('cfgEmpresaIBAN').value = empresaConfig.iban || '';
      document.getElementById('cfgEmpresaCapital').value = empresaConfig.capitalSocial || '';
      document.getElementById('cfgEmpresaRC').value = empresaConfig.registoComercial || '';
      document.getElementById('cfgEmpresaCertificacao').value = empresaConfig.certificacao || '';
    }
    
    function reporDadosFabricaEmpresa() {
      if (!confirm('âš ï¸ Tem a certeza que deseja repor os dados de fÃ¡brica da empresa?\n\nIsto irÃ¡ substituir todos os dados actuais pelos dados originais da Emeutrans.')) {
        return;
      }
      
      // Dados de fÃ¡brica da Emeutrans
      empresaConfig = {
        nome: 'Emeutrans',
        nif: 'PT515996149',
        morada: 'Rua Do Rei Conquistador NÂº2 - Casal Do Rei',
        localidade: '2500-739 Vidais - Caldas Da Rainha - Portugal',
        telefone: '+351 243 909 780',
        email: 'geral@emeutrans.pt',
        iban: 'PT50 0035 0000 00000000000 97',
        certificacao: 'Programa certificado nÂº 0000/AT',
        capitalSocial: '125.000â‚¬',
        registoComercial: 'C.R.C Caldas Da Rainha'
      };
      
      localStorage.setItem('erpEmpresaConfig', JSON.stringify(empresaConfig));
      carregarDadosEmpresaForm();
      
      alert('âœ… Dados de fÃ¡brica repostos com sucesso!\n\nOs dados da Emeutrans foram carregados.');
    }
    
    function guardarDadosEmpresa() {
      // Validar campos obrigatÃ³rios
      const nome = document.getElementById('cfgEmpresaNome').value.trim();
      const nif = document.getElementById('cfgEmpresaNIF').value.trim();
      const morada = document.getElementById('cfgEmpresaMorada').value.trim();
      const localidade = document.getElementById('cfgEmpresaLocalidade').value.trim();
      const iban = document.getElementById('cfgEmpresaIBAN').value.trim();
      
      if (!nome || !nif || !morada || !localidade || !iban) {
        alert('âš ï¸ Por favor preencha todos os campos obrigatÃ³rios (*)');
        return;
      }
      
      // Atualizar empresaConfig
      empresaConfig.nome = nome;
      empresaConfig.nif = nif;
      empresaConfig.morada = morada;
      empresaConfig.localidade = localidade;
      empresaConfig.telefone = document.getElementById('cfgEmpresaTelefone').value.trim();
      empresaConfig.email = document.getElementById('cfgEmpresaEmail').value.trim();
      empresaConfig.iban = iban;
      empresaConfig.capitalSocial = document.getElementById('cfgEmpresaCapital').value.trim();
      empresaConfig.registoComercial = document.getElementById('cfgEmpresaRC').value.trim();
      empresaConfig.certificacao = document.getElementById('cfgEmpresaCertificacao').value.trim();
      
      // Guardar no localStorage
      localStorage.setItem('erpEmpresaConfig', JSON.stringify(empresaConfig));
      
      alert('âœ… Dados da empresa guardados com sucesso!\n\nEstes dados serÃ£o usados em todas as faturas.');
    }
    
    function guardarConfigFaturacao() {
      alert('âœ… ConfiguraÃ§Ãµes guardadas com sucesso!');
    }
    
    // ==================== MODAIS ====================
    
    function abrirModal(id) {
      document.getElementById(id).classList.add('active');
    }
    
    function fecharModal(id) {
      document.getElementById(id).classList.remove('active');
    }
    
    // ==================== FILTROS ====================
    
    function filtrarFaturas() {
      // Obter valores dos filtros
      const filtroNumero = document.getElementById('filtroNumero')?.value?.toLowerCase() || '';
      const filtroCliente = document.getElementById('filtroCliente')?.value?.toLowerCase() || '';
      const filtroEstado = document.getElementById('filtroEstado')?.value || '';
      const filtroTipoFaturacao = document.getElementById('filtroTipoFaturacao')?.value || '';
      const filtroDataDe = document.getElementById('filtroDataDe')?.value || '';
      const filtroDataAte = document.getElementById('filtroDataAte')?.value || '';
      
      // Filtrar faturas
      let faturasFiltradasList = faturas.filter(f => {
        // Filtro por nÃºmero
        if (filtroNumero && !f.numero.toLowerCase().includes(filtroNumero)) {
          return false;
        }
        
        // Filtro por cliente
        if (filtroCliente && !f.cliente.toLowerCase().includes(filtroCliente)) {
          return false;
        }
        
        // Filtro por estado
        if (filtroEstado && f.estado !== filtroEstado) {
          return false;
        }
        
        // Filtro por tipo de faturaÃ§Ã£o
        if (filtroTipoFaturacao && f.tipoFaturacao !== filtroTipoFaturacao) {
          return false;
        }
        
        // Filtro por data (de)
        if (filtroDataDe) {
          const dataFatura = new Date(f.data);
          const dataDe = new Date(filtroDataDe);
          if (dataFatura < dataDe) {
            return false;
          }
        }
        
        // Filtro por data (atÃ©)
        if (filtroDataAte) {
          const dataFatura = new Date(f.data);
          const dataAte = new Date(filtroDataAte);
          if (dataFatura > dataAte) {
            return false;
          }
        }
        
        return true;
      });
      
      // Renderizar com a lista filtrada
      renderizarFaturas(faturasFiltradasList);
    }
    
    // Motor de busca global (na caixa de pesquisa principal)
    function pesquisarFaturas(termo) {
      if (!termo || termo.length < 2) {
        renderizarFaturas();
        return;
      }
      
      termo = termo.toLowerCase();
      
      const resultados = faturas.filter(f => 
        f.numero.toLowerCase().includes(termo) ||
        f.cliente.toLowerCase().includes(termo) ||
        (f.nif && f.nif.toLowerCase().includes(termo)) ||
        formatCurrency(f.total).includes(termo)
      );
      
      renderizarFaturas(resultados);
    }
    
    function limparFiltros() {
      document.getElementById('filtroNumero').value = '';
      document.getElementById('filtroCliente').value = '';
      document.getElementById('filtroEstado').value = '';
      document.getElementById('filtroTipoFaturacao').value = '';
      document.getElementById('filtroDataDe').value = '';
      document.getElementById('filtroDataAte').value = '';
      renderizarFaturas();
    }
    
    function filtrarPreFaturacao() {
      renderizarPreFaturacao();
    }
    
    // ğŸ”’ FUNÃ‡ÃƒO BLOQUEADA - limparFiltrosPreFat
    function limparFiltrosPreFat() {
      document.getElementById('filtroClientePreFat').value = '';
      document.getElementById('filtroDataPreFat').value = '';
      renderizarPreFaturacao();
    }
    
    // ğŸ”’ FUNÃ‡ÃƒO - reporFaturasTeste (faturas com IVA correcto por tipo de cliente)
    function reporFaturasTeste() {
      if (!confirm('âš ï¸ Isto irÃ¡ repor as faturas de teste.\n\nAs faturas actuais serÃ£o substituÃ­das por novas faturas com IVA correcto:\nâ€¢ Clientes Nacionais = IVA 23%\nâ€¢ Clientes Europeus = IVA 0%\nâ€¢ Clientes Fora UE = IVA 0%\n\nContinuar?')) {
        return;
      }
      
      // Criar faturas de teste com IVA CORRECTO - 10 CLIENTES
      faturas = [
        // ========== CLIENTE 1: Empresa Nacional Lda (Nacional - IVA 23%) ==========
        {
          id: 1, numero: 'FT 2025/1', data: '2025-12-01', vencimento: '2025-12-31',
          clienteId: 1, cliente: 'Empresa Nacional Lda', nif: '501234567',
          morada: 'Rua do ComÃ©rcio 123, 1000-001 Lisboa', tipoCliente: '21111',
          linhas: [{ cmr: 'CMR-001-D', localCarga: 'Lisboa', localDescarga: 'Porto', refCliente: 'PO-12345', ldm: '13.6', peso: 24500, precoTon: 32, valor: 784.00, taxaIVA: 23 }],
          subtotal: 784.00, iva23: 180.32, iva13: 0, iva6: 0, iva0: 0, totalIVA: 180.32, iva: 180.32,
          total: 964.32, taxaIVA: 23, pago: 0, estado: 'Pendente'
        },
        {
          id: 2, numero: 'FT 2025/2', data: '2025-12-05', vencimento: '2026-01-04',
          clienteId: 1, cliente: 'Empresa Nacional Lda', nif: '501234567',
          morada: 'Rua do ComÃ©rcio 123, 1000-001 Lisboa', tipoCliente: '21111',
          linhas: [{ cmr: 'CMR-002-D', localCarga: 'Lisboa', localDescarga: 'Faro', refCliente: 'PO-12346', ldm: '13.6', peso: 22000, precoTon: 35, valor: 770.00, taxaIVA: 23 }],
          subtotal: 770.00, iva23: 177.10, iva13: 0, iva6: 0, iva0: 0, totalIVA: 177.10, iva: 177.10,
          total: 947.10, taxaIVA: 23, pago: 500.00, estado: 'Parcial'
        },
        
        // ========== CLIENTE 2: Transport Europe SA (Europeu - IVA 0%) ==========
        {
          id: 3, numero: 'FT 2025/3', data: '2025-12-03', vencimento: '2026-01-17',
          clienteId: 2, cliente: 'Transport Europe SA', nif: 'FR12345678901',
          morada: 'Avenue des Champs 456, 75008 Paris', tipoCliente: '21112',
          linhas: [{ cmr: 'CMR-003-D', localCarga: 'Lisboa', localDescarga: 'Paris', refCliente: 'FR-98765', ldm: '13.6', peso: 18000, precoTon: 85, valor: 1530.00, taxaIVA: 0 }],
          subtotal: 1530.00, iva23: 0, iva13: 0, iva6: 0, iva0: 1530.00, totalIVA: 0, iva: 0,
          total: 1530.00, taxaIVA: 0, pago: 0, estado: 'Pendente',
          artigoIsencao: 'Art.14Âº RITI - IsenÃ§Ã£o IVA'
        },
        
        // ========== CLIENTE 3: Global Logistics UK Ltd (Fora UE - IVA 0%) ==========
        {
          id: 4, numero: 'FT 2025/4', data: '2025-12-04', vencimento: '2026-02-02',
          clienteId: 3, cliente: 'Global Logistics UK Ltd', nif: 'GB123456789',
          morada: 'London Street 789, EC1A 1BB London', tipoCliente: '21113',
          linhas: [{ cmr: 'CMR-004-D', localCarga: 'Lisboa', localDescarga: 'Londres', refCliente: 'UK-5001', ldm: '13.6', peso: 16000, precoTon: 120, valor: 1920.00, taxaIVA: 0 }],
          subtotal: 1920.00, iva23: 0, iva13: 0, iva6: 0, iva0: 1920.00, totalIVA: 0, iva: 0,
          total: 1920.00, taxaIVA: 0, pago: 0, estado: 'Pendente',
          artigoIsencao: 'Art.14Âº RITI - IsenÃ§Ã£o IVA'
        },
        {
          id: 5, numero: 'FT 2025/5', data: '2025-12-10', vencimento: '2026-02-08',
          clienteId: 3, cliente: 'Global Logistics UK Ltd', nif: 'GB123456789',
          morada: 'London Street 789, EC1A 1BB London', tipoCliente: '21113',
          linhas: [{ cmr: 'CMR-005-D', localCarga: 'Porto', localDescarga: 'Dublin', refCliente: 'UK-5002', ldm: '7.5', valor: 1250.00, taxaIVA: 0 }],
          subtotal: 1250.00, iva23: 0, iva13: 0, iva6: 0, iva0: 1250.00, totalIVA: 0, iva: 0,
          total: 1250.00, taxaIVA: 0, pago: 0, estado: 'Pendente',
          artigoIsencao: 'Art.14Âº RITI - IsenÃ§Ã£o IVA'
        },
        
        // ========== CLIENTE 4: Transportes Abreu SA (Nacional - IVA 23%) ==========
        {
          id: 6, numero: 'FT 2025/6', data: '2025-12-06', vencimento: '2026-01-05',
          clienteId: 4, cliente: 'Transportes Abreu SA', nif: '502345678',
          morada: 'Av. da Liberdade 500, 4000-001 Porto', tipoCliente: '21111',
          linhas: [{ cmr: 'CMR-006-D', localCarga: 'Porto', localDescarga: 'Faro', refCliente: 'AB-001', ldm: '8.5', valor: 450.00, taxaIVA: 23 }],
          subtotal: 450.00, iva23: 103.50, iva13: 0, iva6: 0, iva0: 0, totalIVA: 103.50, iva: 103.50,
          total: 553.50, taxaIVA: 23, pago: 0, estado: 'Pendente'
        },
        
        // ========== CLIENTE 5: LogÃ­stica Silva Lda (Nacional - IVA 23%) ==========
        {
          id: 7, numero: 'FT 2025/7', data: '2025-12-07', vencimento: '2026-01-21',
          clienteId: 5, cliente: 'LogÃ­stica Silva Lda', nif: '503456789',
          morada: 'Zona Industrial Norte, Lote 15, 4700-001 Braga', tipoCliente: '21111',
          linhas: [{ cmr: 'CMR-007-D', localCarga: 'Braga', localDescarga: 'Lisboa', refCliente: 'LS-100', ldm: '13.6', valor: 850.00, taxaIVA: 23 }],
          subtotal: 850.00, iva23: 195.50, iva13: 0, iva6: 0, iva0: 0, totalIVA: 195.50, iva: 195.50,
          total: 1045.50, taxaIVA: 23, pago: 0, estado: 'Pendente'
        },
        
        // ========== CLIENTE 6: Spedition Schmidt GmbH (Europeu - IVA 0%) ==========
        {
          id: 8, numero: 'FT 2025/8', data: '2025-12-08', vencimento: '2026-01-07',
          clienteId: 6, cliente: 'Spedition Schmidt GmbH', nif: 'DE123456789',
          morada: 'IndustriestraÃŸe 45, 60311 Frankfurt', tipoCliente: '21112',
          linhas: [{ cmr: 'CMR-008-D', localCarga: 'Lisboa', localDescarga: 'Frankfurt', refCliente: 'DE-2001', ldm: '13.6', peso: 20000, precoTon: 75, valor: 1500.00, taxaIVA: 0 }],
          subtotal: 1500.00, iva23: 0, iva13: 0, iva6: 0, iva0: 1500.00, totalIVA: 0, iva: 0,
          total: 1500.00, taxaIVA: 0, pago: 750.00, estado: 'Parcial',
          artigoIsencao: 'Art.14Âº RITI - IsenÃ§Ã£o IVA'
        },
        {
          id: 9, numero: 'FT 2025/9', data: '2025-12-12', vencimento: '2026-01-11',
          clienteId: 6, cliente: 'Spedition Schmidt GmbH', nif: 'DE123456789',
          morada: 'IndustriestraÃŸe 45, 60311 Frankfurt', tipoCliente: '21112',
          linhas: [{ cmr: 'CMR-009-D', localCarga: 'Porto', localDescarga: 'Munique', refCliente: 'DE-2002', ldm: '10.0', valor: 1200.00, taxaIVA: 0 }],
          subtotal: 1200.00, iva23: 0, iva13: 0, iva6: 0, iva0: 1200.00, totalIVA: 0, iva: 0,
          total: 1200.00, taxaIVA: 0, pago: 0, estado: 'Pendente',
          artigoIsencao: 'Art.14Âº RITI - IsenÃ§Ã£o IVA'
        },
        
        // ========== CLIENTE 7: Trasporti Rossi SpA (Europeu - IVA 0%) ==========
        {
          id: 10, numero: 'FT 2025/10', data: '2025-12-09', vencimento: '2026-02-07',
          clienteId: 7, cliente: 'Trasporti Rossi SpA', nif: 'IT12345678901',
          morada: 'Via Roma 123, 20121 Milano', tipoCliente: '21112',
          linhas: [{ cmr: 'CMR-010-D', localCarga: 'Lisboa', localDescarga: 'MilÃ£o', refCliente: 'IT-3001', ldm: '13.6', peso: 19000, precoTon: 80, valor: 1520.00, taxaIVA: 0 }],
          subtotal: 1520.00, iva23: 0, iva13: 0, iva6: 0, iva0: 1520.00, totalIVA: 0, iva: 0,
          total: 1520.00, taxaIVA: 0, pago: 0, estado: 'Pendente',
          artigoIsencao: 'Art.14Âº RITI - IsenÃ§Ã£o IVA'
        },
        
        // ========== CLIENTE 8: Transportes IbÃ©ricos SA (Europeu - IVA 0%) ==========
        {
          id: 11, numero: 'FT 2025/11', data: '2025-12-10', vencimento: '2026-01-24',
          clienteId: 8, cliente: 'Transportes IbÃ©ricos SA', nif: 'ES12345678A',
          morada: 'Calle Mayor 78, 28001 Madrid', tipoCliente: '21112',
          linhas: [{ cmr: 'CMR-011-D', localCarga: 'Lisboa', localDescarga: 'Madrid', refCliente: 'ES-4001', ldm: '13.6', peso: 21000, precoTon: 45, valor: 945.00, taxaIVA: 0 }],
          subtotal: 945.00, iva23: 0, iva13: 0, iva6: 0, iva0: 945.00, totalIVA: 0, iva: 0,
          total: 945.00, taxaIVA: 0, pago: 0, estado: 'Pendente',
          artigoIsencao: 'Art.14Âº RITI - IsenÃ§Ã£o IVA'
        },
        {
          id: 12, numero: 'FT 2025/12', data: '2025-12-14', vencimento: '2026-01-28',
          clienteId: 8, cliente: 'Transportes IbÃ©ricos SA', nif: 'ES12345678A',
          morada: 'Calle Mayor 78, 28001 Madrid', tipoCliente: '21112',
          linhas: [{ cmr: 'CMR-012-D', localCarga: 'Porto', localDescarga: 'Barcelona', refCliente: 'ES-4002', ldm: '8.0', valor: 680.00, taxaIVA: 0 }],
          subtotal: 680.00, iva23: 0, iva13: 0, iva6: 0, iva0: 680.00, totalIVA: 0, iva: 0,
          total: 680.00, taxaIVA: 0, pago: 0, estado: 'Pendente',
          artigoIsencao: 'Art.14Âº RITI - IsenÃ§Ã£o IVA'
        },
        
        // ========== CLIENTE 9: Freteiro & Filhos Lda (Nacional - IVA 23%) ==========
        {
          id: 13, numero: 'FT 2025/13', data: '2025-12-11', vencimento: '2026-01-10',
          clienteId: 9, cliente: 'Freteiro & Filhos Lda', nif: '504567890',
          morada: 'Estrada Nacional 1, Km 234, 3000-001 Coimbra', tipoCliente: '21111',
          linhas: [{ cmr: 'CMR-013-D', localCarga: 'Coimbra', localDescarga: 'Lisboa', refCliente: 'FF-001', ldm: '6.5', valor: 320.00, taxaIVA: 23 }],
          subtotal: 320.00, iva23: 73.60, iva13: 0, iva6: 0, iva0: 0, totalIVA: 73.60, iva: 73.60,
          total: 393.60, taxaIVA: 23, pago: 0, estado: 'Pendente'
        },
        {
          id: 14, numero: 'FT 2025/14', data: '2025-12-15', vencimento: '2026-01-14',
          clienteId: 9, cliente: 'Freteiro & Filhos Lda', nif: '504567890',
          morada: 'Estrada Nacional 1, Km 234, 3000-001 Coimbra', tipoCliente: '21111',
          linhas: [{ cmr: 'CMR-014-D', localCarga: 'Coimbra', localDescarga: 'Porto', refCliente: 'FF-002', ldm: '4.0', valor: 180.00, taxaIVA: 23 }],
          subtotal: 180.00, iva23: 41.40, iva13: 0, iva6: 0, iva0: 0, totalIVA: 41.40, iva: 41.40,
          total: 221.40, taxaIVA: 23, pago: 221.40, estado: 'Pago'
        },
        
        // ========== CLIENTE 10: Nordic Transport AB (Europeu - IVA 0%) ==========
        {
          id: 15, numero: 'FT 2025/15', data: '2025-12-13', vencimento: '2026-01-12',
          clienteId: 10, cliente: 'Nordic Transport AB', nif: 'SE123456789012',
          morada: 'Kungsgatan 55, 11122 Stockholm', tipoCliente: '21112',
          linhas: [{ cmr: 'CMR-015-D', localCarga: 'Lisboa', localDescarga: 'Estocolmo', refCliente: 'SE-5001', ldm: '13.6', peso: 17000, precoTon: 95, valor: 1615.00, taxaIVA: 0 }],
          subtotal: 1615.00, iva23: 0, iva13: 0, iva6: 0, iva0: 1615.00, totalIVA: 0, iva: 0,
          total: 1615.00, taxaIVA: 0, pago: 0, estado: 'Pendente',
          artigoIsencao: 'Art.14Âº RITI - IsenÃ§Ã£o IVA'
        }
      ];
      
      // Actualizar sÃ©rie FT
      const serieFT = series.find(s => s.serie === 'FT');
      if (serieFT) serieFT.proxNum = 16;
      
      // Criar alguns recibos de teste para a AnÃ¡lise de Vencimentos
      recibos = [
        {
          id: 1, numero: 'RC 2025/1', data: '2025-12-08', 
          clienteId: 1, cliente: 'Empresa Nacional Lda', nif: '501234567',
          faturas: ['FT 2025/2'], valor: 500.00, metodo: 'TransferÃªncia',
          contaDestino: 'Millennium BCP', detalhesFaturas: [
            { faturaId: 2, faturaNumero: 'FT 2025/2', valorFatura: 947.10, valorRecebido: 500.00, valorPendente: 447.10 }
          ]
        },
        {
          id: 2, numero: 'RC 2025/2', data: '2025-12-15', 
          clienteId: 6, cliente: 'Spedition Schmidt GmbH', nif: 'DE123456789',
          faturas: ['FT 2025/8'], valor: 750.00, metodo: 'TransferÃªncia',
          contaDestino: 'Caixa Geral', detalhesFaturas: [
            { faturaId: 8, faturaNumero: 'FT 2025/8', valorFatura: 1500.00, valorRecebido: 750.00, valorPendente: 750.00 }
          ]
        },
        {
          id: 3, numero: 'RC 2025/3', data: '2025-12-18', 
          clienteId: 9, cliente: 'Freteiro & Filhos Lda', nif: '504567890',
          faturas: ['FT 2025/14'], valor: 221.40, metodo: 'TransferÃªncia',
          contaDestino: 'Millennium BCP', detalhesFaturas: [
            { faturaId: 14, faturaNumero: 'FT 2025/14', valorFatura: 221.40, valorRecebido: 221.40, valorPendente: 0 }
          ]
        }
      ];
      
      // Actualizar sÃ©rie RC
      const serieRC = series.find(s => s.serie === 'RC');
      if (serieRC) serieRC.proxNum = 4;
      
      localStorage.setItem('erpFaturas', JSON.stringify(faturas));
      localStorage.setItem('erpRecibos', JSON.stringify(recibos));
      guardarDados();
      renderizarFaturas();
      atualizarDashboard();
      
      alert('âœ… Dados de teste repostos!\n\nğŸ“Š 15 faturas criadas para 10 clientes:\n\nğŸ‡µğŸ‡¹ Nacionais (IVA 23%):\nâ€¢ C1: Empresa Nacional Lda (2 faturas)\nâ€¢ C4: Transportes Abreu SA (1 fatura)\nâ€¢ C5: LogÃ­stica Silva Lda (1 fatura)\nâ€¢ C9: Freteiro & Filhos Lda (2 faturas)\n\nğŸ‡ªğŸ‡º Europeus (IVA 0%):\nâ€¢ C2: Transport Europe SA (1 fatura)\nâ€¢ C6: Spedition Schmidt GmbH (2 faturas)\nâ€¢ C7: Trasporti Rossi SpA (1 fatura)\nâ€¢ C8: Transportes IbÃ©ricos SA (2 faturas)\nâ€¢ C10: Nordic Transport AB (1 fatura)\n\nğŸŒ Fora UE (IVA 0%):\nâ€¢ C3: Global Logistics UK Ltd (2 faturas)\n\nğŸ’° 3 recibos de teste criados');
    }
    
    // ğŸ”’ FUNÃ‡ÃƒO BLOQUEADA - reporReservasTeste (12 reservas: 5 peso, 7 valor fixo)
    function reporReservasTeste() {
      if (!confirm('âš ï¸ Isto irÃ¡ repor as reservas de teste para PrÃ©-FaturaÃ§Ã£o.\n\nAs reservas actuais serÃ£o substituÃ­das por novas reservas de exemplo.\n\nContinuar?')) {
        return;
      }
      
      // Criar novas reservas de teste - MISTAS (peso+tonelada e LDM+valor fixo)
      reservas = [
        // ========== FATURAÃ‡ÃƒO POR PESO Ã— â‚¬/TON ==========
        {
          id: 1, numero: 'RES-2025-001', clienteId: 1, cliente: 'Empresa Nacional Lda',
          localCarga: 'Lisboa, Portugal', localDescarga: 'Porto, Portugal',
          refCliente: 'PO-12345', ldm: '13.6', pesoCarga: 24500, pesoDescarga: 24480,
          precoTon: 32, tipoMercadoria: 'Normal', valorFixo: null,
          cmrCarga: 'CMR-001-C', cmrDescarga: 'CMR-001-D',
          dataExecucao: '2025-12-15', faturada: false
        },
        {
          id: 2, numero: 'RES-2025-002', clienteId: 1, cliente: 'Empresa Nacional Lda',
          localCarga: 'SetÃºbal, Portugal', localDescarga: 'Braga, Portugal',
          refCliente: 'PO-12346', ldm: '13.6', pesoCarga: 22000, pesoDescarga: 21980,
          precoTon: 35, tipoMercadoria: 'Normal', valorFixo: null,
          cmrCarga: 'CMR-002-C', cmrDescarga: 'CMR-002-D',
          dataExecucao: '2025-12-16', faturada: false
        },
        {
          id: 3, numero: 'RES-2025-003', clienteId: 2, cliente: 'Transport Europe SA',
          localCarga: 'Lisboa, Portugal', localDescarga: 'Paris, FranÃ§a',
          refCliente: 'FR-98765', ldm: '13.6', pesoCarga: 18000, pesoDescarga: 17950,
          precoTon: 85, tipoMercadoria: 'Normal', valorFixo: null,
          cmrCarga: 'CMR-003-C', cmrDescarga: 'CMR-003-D',
          dataExecucao: '2025-12-14', faturada: false
        },
        
        // ========== FATURAÃ‡ÃƒO POR LDM + VALOR FIXO ==========
        {
          id: 4, numero: 'RES-2025-004', clienteId: 4, cliente: 'Transportes Abreu SA',
          localCarga: 'Porto, Portugal', localDescarga: 'Faro, Portugal',
          refCliente: 'AB-001', ldm: '8.5', pesoCarga: null, pesoDescarga: null,
          precoTon: null, tipoMercadoria: 'Paletes', valorFixo: 450.00,
          cmrCarga: 'CMR-004-C', cmrDescarga: 'CMR-004-D',
          dataExecucao: '2025-12-14', faturada: false
        },
        {
          id: 5, numero: 'RES-2025-005', clienteId: 4, cliente: 'Transportes Abreu SA',
          localCarga: 'Braga, Portugal', localDescarga: 'Lisboa, Portugal',
          refCliente: 'AB-002', ldm: '13.6', pesoCarga: null, pesoDescarga: null,
          precoTon: null, tipoMercadoria: 'Completo', valorFixo: 850.00,
          cmrCarga: 'CMR-005-C', cmrDescarga: 'CMR-005-D',
          dataExecucao: '2025-12-15', faturada: false
        },
        {
          id: 6, numero: 'RES-2025-006', clienteId: 4, cliente: 'Transportes Abreu SA',
          localCarga: 'Coimbra, Portugal', localDescarga: 'Aveiro, Portugal',
          refCliente: 'AB-003', ldm: '4.2', pesoCarga: null, pesoDescarga: null,
          precoTon: null, tipoMercadoria: 'Grupagem', valorFixo: 180.00,
          cmrCarga: 'CMR-006-C', cmrDescarga: 'CMR-006-D',
          dataExecucao: '2025-12-16', faturada: false
        },
        
        // ========== MAIS FATURAÃ‡ÃƒO POR PESO Ã— â‚¬/TON ==========
        {
          id: 7, numero: 'RES-2025-007', clienteId: 5, cliente: 'LogÃ­stica Silva Lda',
          localCarga: 'Braga, Portugal', localDescarga: 'Viana do Castelo, Portugal',
          refCliente: 'SV-100', ldm: '13.6', pesoCarga: 21000, pesoDescarga: 20980,
          precoTon: 30, tipoMercadoria: 'Normal', valorFixo: null,
          cmrCarga: 'CMR-007-C', cmrDescarga: 'CMR-007-D',
          dataExecucao: '2025-12-13', faturada: false
        },
        
        // ========== MAIS FATURAÃ‡ÃƒO POR LDM + VALOR FIXO ==========
        {
          id: 8, numero: 'RES-2025-008', clienteId: 5, cliente: 'LogÃ­stica Silva Lda',
          localCarga: 'GuimarÃ£es, Portugal', localDescarga: 'Porto, Portugal',
          refCliente: 'SV-101', ldm: '6.8', pesoCarga: null, pesoDescarga: null,
          precoTon: null, tipoMercadoria: 'Paletes', valorFixo: 320.00,
          cmrCarga: 'CMR-008-C', cmrDescarga: 'CMR-008-D',
          dataExecucao: '2025-12-14', faturada: false
        },
        {
          id: 9, numero: 'RES-2025-009', clienteId: 2, cliente: 'Transport Europe SA',
          localCarga: 'Porto, Portugal', localDescarga: 'Madrid, Espanha',
          refCliente: 'FR-98766', ldm: '10.2', pesoCarga: null, pesoDescarga: null,
          precoTon: null, tipoMercadoria: 'Grupagem', valorFixo: 680.00,
          cmrCarga: 'CMR-009-C', cmrDescarga: 'CMR-009-D',
          dataExecucao: '2025-12-15', faturada: false
        },
        
        // ========== FATURAÃ‡ÃƒO POR PESO Ã— â‚¬/TON (Internacional) ==========
        {
          id: 10, numero: 'RES-2025-010', clienteId: 3, cliente: 'Global Logistics UK Ltd',
          localCarga: 'Lisboa, Portugal', localDescarga: 'Londres, Reino Unido',
          refCliente: 'UK-5001', ldm: '13.6', pesoCarga: 16000, pesoDescarga: 15950,
          precoTon: 120, tipoMercadoria: 'Normal', valorFixo: null,
          cmrCarga: 'CMR-010-C', cmrDescarga: 'CMR-010-D',
          dataExecucao: '2025-12-12', faturada: false
        },
        
        // ========== MAIS FATURAÃ‡ÃƒO POR LDM + VALOR FIXO ==========
        {
          id: 11, numero: 'RES-2025-011', clienteId: 3, cliente: 'Global Logistics UK Ltd',
          localCarga: 'Porto, Portugal', localDescarga: 'Dublin, Irlanda',
          refCliente: 'UK-5002', ldm: '7.5', pesoCarga: null, pesoDescarga: null,
          precoTon: null, tipoMercadoria: 'Paletes', valorFixo: 1250.00,
          cmrCarga: 'CMR-011-C', cmrDescarga: 'CMR-011-D',
          dataExecucao: '2025-12-13', faturada: false
        },
        {
          id: 12, numero: 'RES-2025-012', clienteId: 1, cliente: 'Empresa Nacional Lda',
          localCarga: 'Leiria, Portugal', localDescarga: 'Viseu, Portugal',
          refCliente: 'PO-12347', ldm: '3.5', pesoCarga: null, pesoDescarga: null,
          precoTon: null, tipoMercadoria: 'Grupagem', valorFixo: 145.00,
          cmrCarga: 'CMR-012-C', cmrDescarga: 'CMR-012-D',
          dataExecucao: '2025-12-17', faturada: false
        }
      ];
      
      localStorage.setItem('erpReservasExecutadas', JSON.stringify(reservas));
      renderizarPreFaturacao();
      alert('âœ… Reservas de teste repostas com sucesso!\n\nğŸ“Š 12 reservas disponÃ­veis:\nâ€¢ 5 por Peso Ã— â‚¬/TON\nâ€¢ 7 por LDM + Valor Fixo');
    }
    
    function exportarFaturas() {
      alert('ğŸ“¥ A exportar faturas para Excel...');
    }
    
    // ==================== INICIALIZAÃ‡ÃƒO ====================
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ğŸ§ª FUNÃ‡ÃƒO DE TESTE v6.34 - LIMPAR E CARREGAR DADOS DE TESTE
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ğŸ§¹ FUNÃ‡Ã•ES DE LIMPEZA DE LOCALSTORAGE v6.34
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    function limparLocalStorageCompleto() {
      if (confirm('âš ï¸ ATENÃ‡ÃƒO!\n\nIsto vai apagar TODOS os dados:\n- Reservas\n- Clientes\n- Faturas\n- Ficheiros CMR\n- ConfiguraÃ§Ãµes\n\nTem a certeza?')) {
        localStorage.clear();
        alert('âœ… LocalStorage completamente limpo!\n\nA pÃ¡gina vai recarregar para criar novos dados de teste.');
        location.reload();
      }
    }
    
    function limparApenasReservas() {
      if (confirm('âš ï¸ Isto vai apagar:\n- Todas as reservas\n- Todas as faturas\n\nOs clientes serÃ£o mantidos.\n\nContinuar?')) {
        localStorage.removeItem('erpReservasExecutadas');
        localStorage.removeItem('erpReservas');
        localStorage.removeItem('erpFaturas');
        localStorage.removeItem('erpNotasCredito');
        localStorage.removeItem('erpRecibos');
        alert('âœ… Reservas e faturas apagadas!\n\nA pÃ¡gina vai recarregar para criar novos dados de teste.');
        location.reload();
      }
    }
    
    function limparApenasChavesCMR() {
      if (confirm('âš ï¸ Isto vai apagar apenas os ficheiros CMR anexados.\n\nAs reservas e faturas serÃ£o mantidas.\n\nContinuar?')) {
        let count = 0;
        const keysToRemove = [];
        
        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          if (key && key.startsWith('cmr_')) {
            keysToRemove.push(key);
            count++;
          }
        }
        
        keysToRemove.forEach(key => localStorage.removeItem(key));
        
        // TambÃ©m limpar as referÃªncias nas reservas
        try {
          let reservasExec = JSON.parse(localStorage.getItem('erpReservasExecutadas') || '[]');
          reservasExec.forEach(r => {
            r.cmrCarga = '';
            r.cmrDescarga = '';
            r.cmrCargaAnexado = false;
            r.cmrDescargaAnexado = false;
            r.cmrCargaBase64Key = null;
            r.cmrDescargaBase64Key = null;
          });
          localStorage.setItem('erpReservasExecutadas', JSON.stringify(reservasExec));
        } catch (e) {}
        
        alert(`âœ… ${count} ficheiros CMR apagados!\n\nA pÃ¡gina vai recarregar.`);
        location.reload();
      }
    }
    
    function verEspacoLocalStorage() {
      let total = 0;
      let detalhes = [];
      
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        const value = localStorage.getItem(key);
        const size = (key.length + value.length) * 2; // UTF-16
        total += size;
        
        if (size > 1024) { // Mostrar sÃ³ chaves > 1KB
          detalhes.push({
            key: key,
            size: size,
            sizeFormatted: (size / 1024).toFixed(2) + ' KB'
          });
        }
      }
      
      detalhes.sort((a, b) => b.size - a.size);
      
      let msg = `ğŸ“Š ESPAÃ‡O USADO NO LOCALSTORAGE\n\n`;
      msg += `Total: ${(total / 1024 / 1024).toFixed(2)} MB de ~5 MB disponÃ­veis\n`;
      msg += `UtilizaÃ§Ã£o: ${((total / (5 * 1024 * 1024)) * 100).toFixed(1)}%\n\n`;
      msg += `Maiores chaves:\n`;
      
      detalhes.slice(0, 10).forEach((d, i) => {
        const keyShort = d.key.length > 30 ? d.key.substring(0, 30) + '...' : d.key;
        msg += `${i + 1}. ${keyShort}: ${d.sizeFormatted}\n`;
      });
      
      if (total > 4 * 1024 * 1024) {
        msg += `\nâš ï¸ ATENÃ‡ÃƒO: EspaÃ§o quase cheio!\nRecomendo limpar ficheiros CMR.`;
      }
      
      alert(msg);
    }
    
    function carregarDadosTeste() {
      console.log('ğŸ§ª â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
      console.log('ğŸ§ª VERSÃƒO 6.34 - DADOS DE TESTE PARA FATURAÃ‡ÃƒO');
      console.log('ğŸ§ª â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
      console.log('');
      console.log('ğŸ“‹ RESERVAS DE TESTE DISPONÃVEIS:');
      console.log('â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€');
      console.log('');
      console.log('C0001 - Transportes RÃ¡pidos do Norte (MANUAL)');
      console.log('   â†’ RES-2025-001: Lisboa â†’ Porto (PTâ†’PT = 23% IVA) âœ…');
      console.log('   â†’ RES-2025-002: Porto â†’ Madrid (PTâ†’EUR = 0% IVA) âœ…');
      console.log('');
      console.log('C0002 - LogÃ­stica Centro Sul (AUTOMÃTICA) âš¡');
      console.log('   â†’ RES-2025-003: SetÃºbal â†’ Lisboa (PTâ†’PT = 23% IVA) âœ…');
      console.log('   â†’ RES-2025-004: Lisboa â†’ Paris (PTâ†’EUR = 0% IVA) âœ…');
      console.log('');
      console.log('C0003 - Mercadorias IbÃ©ricas (MANUAL)');
      console.log('   â†’ RES-2025-005: Porto â†’ Braga (PTâ†’PT = 23% IVA) âœ…');
      console.log('   â†’ RES-2025-006: Braga â†’ Barcelona (PTâ†’EUR = 0% IVA) âœ…');
      console.log('');
      console.log('C0004 - DistribuiÃ§Ã£o Expressa Porto (MANUAL)');
      console.log('   â†’ RES-2025-007: Coimbra â†’ Aveiro (PTâ†’PT = 23% IVA) âœ…');
      console.log('   â†’ RES-2025-008: Aveiro â†’ Bordeaux (PTâ†’EUR = 0% IVA) âœ…');
      console.log('');
      console.log('ğŸ§ª â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
      console.log('');
      console.log('ğŸ“Œ COMO TESTAR:');
      console.log('1. Ir a Reservas â†’ Executadas');
      console.log('2. Clicar em qualquer reserva');
      console.log('3. Na SecÃ§Ã£o 5, anexar um ficheiro CMR de Carga');
      console.log('4. Para AUTOMÃTICA (C0002): Fatura Ã© criada automaticamente');
      console.log('5. Para MANUAL: Vai para PrÃ©-FaturaÃ§Ã£o');
      console.log('6. Verificar IVA na fatura: 23% ou 0% conforme destino');
      console.log('');
      console.log('ğŸ§ª â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    }
    
    // FunÃ§Ã£o para limpar dados corrompidos e iniciar fresh
    function limparDadosTesteAntigos() {
      // Verificar se jÃ¡ temos os novos dados de teste
      const reservasLS = localStorage.getItem('erpReservasExecutadas');
      if (reservasLS) {
        try {
          const reservas = JSON.parse(reservasLS);
          // Se alguma reserva tem 'descricaoTeste', sÃ£o os novos dados
          const temDadosNovos = reservas.some(r => r.descricaoTeste);
          if (temDadosNovos) {
            console.log('âœ… Dados de teste v6.34 jÃ¡ carregados');
            return false; // NÃ£o limpar
          }
        } catch (e) {
          // Dados corrompidos, limpar
        }
      }
      
      // Limpar dados antigos
      console.log('ğŸ§¹ Limpando dados de teste antigos...');
      localStorage.removeItem('erpReservasExecutadas');
      localStorage.removeItem('erpReservas');
      localStorage.removeItem('erpFaturas');
      return true; // Dados foram limpos
    }
    
    document.addEventListener('DOMContentLoaded', function() {
      // Carregar dados de teste v6.34
      limparDadosTesteAntigos();
      carregarDadosTeste();
      
      carregarDados();
      atualizarDashboard();
      carregarDadosEmpresaForm(); // Carregar dados da empresa para o formulÃ¡rio de configuraÃ§Ãµes
      
      // Criar clientes de teste se nÃ£o existirem
      criarClientesTeste();
      
      // Configurar event listeners para filtros NC
      const filtroNCNumero = document.getElementById('filtroNCNumero');
      const filtroNCCliente = document.getElementById('filtroNCCliente');
      const filtroNCFatura = document.getElementById('filtroNCFatura');
      const filtroNCMotivo = document.getElementById('filtroNCMotivo');
      const filtroNCDataDe = document.getElementById('filtroNCDataDe');
      const filtroNCDataAte = document.getElementById('filtroNCDataAte');
      
      if (filtroNCNumero) {
        filtroNCNumero.addEventListener('input', filtrarNotasCredito);
        filtroNCNumero.addEventListener('keyup', filtrarNotasCredito);
      }
      if (filtroNCCliente) {
        filtroNCCliente.addEventListener('input', filtrarNotasCredito);
        filtroNCCliente.addEventListener('keyup', filtrarNotasCredito);
      }
      if (filtroNCFatura) {
        filtroNCFatura.addEventListener('input', filtrarNotasCredito);
        filtroNCFatura.addEventListener('keyup', filtrarNotasCredito);
      }
      if (filtroNCMotivo) {
        filtroNCMotivo.addEventListener('change', filtrarNotasCredito);
      }
      if (filtroNCDataDe) {
        filtroNCDataDe.addEventListener('change', filtrarNotasCredito);
      }
      if (filtroNCDataAte) {
        filtroNCDataAte.addEventListener('change', filtrarNotasCredito);
      }
      
      // Configurar event listeners para filtros Recibos
      const filtroReciboNumero = document.getElementById('filtroReciboNumero');
      const filtroReciboCliente = document.getElementById('filtroReciboCliente');
      const filtroReciboFatura = document.getElementById('filtroReciboFatura');
      const filtroReciboMetodo = document.getElementById('filtroReciboMetodo');
      const filtroReciboDataDe = document.getElementById('filtroReciboDataDe');
      const filtroReciboDataAte = document.getElementById('filtroReciboDataAte');
      
      if (filtroReciboNumero) {
        filtroReciboNumero.addEventListener('input', filtrarRecibos);
        filtroReciboNumero.addEventListener('keyup', filtrarRecibos);
      }
      if (filtroReciboCliente) {
        filtroReciboCliente.addEventListener('input', filtrarRecibos);
        filtroReciboCliente.addEventListener('keyup', filtrarRecibos);
      }
      if (filtroReciboFatura) {
        filtroReciboFatura.addEventListener('input', filtrarRecibos);
        filtroReciboFatura.addEventListener('keyup', filtrarRecibos);
      }
      if (filtroReciboMetodo) {
        filtroReciboMetodo.addEventListener('change', filtrarRecibos);
      }
      if (filtroReciboDataDe) {
        filtroReciboDataDe.addEventListener('change', filtrarRecibos);
      }
      if (filtroReciboDataAte) {
        filtroReciboDataAte.addEventListener('change', filtrarRecibos);
      }
      
      console.log('âœ… MÃ³dulo FaturaÃ§Ã£o v4.3 com Layout A4 carregado');
      console.log('   Faturas:', faturas.length);
      console.log('   Recibos:', recibos.length);
      console.log('   Notas de CrÃ©dito:', notasCredito.length);
      console.log('   Clientes:', clientes.length);
      console.log('   Reservas:', reservas.length);
      console.log('   Empresa:', empresaConfig.nome || 'NÃ£o configurada');
      console.log('   Filtros NC configurados:', filtroNCNumero ? 'Sim' : 'NÃ£o');
      console.log('   Filtros Recibos configurados:', filtroReciboNumero ? 'Sim' : 'NÃ£o');
      
      // Inicializar mÃ³dulo de reservas
      inicializarModuloReservas();
      
      // Inicializar mÃ³dulo Agenda 1
      inicializarAgenda1();
      
      // Inicializar mÃ³dulo Agenda 2
      inicializarAgenda2();
    });
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // MÃ“DULO RESERVAS - JAVASCRIPT ORIGINAL (NÃƒO ALTERAR)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    let reservaFaturada = false;
    let numReserva = null;
    let historicoInc = [];
    let tipoMsg = null;
    let reservaCriada = false;
    let clienteAtualBloqueio = null;
    let todasReservas = [];
    let campoDestinoSelecao = null;
    
    // â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    // â•‘  ğŸ“œ SISTEMA DE HISTÃ“RICO DE RESERVAS                                                 â•‘
    // â•‘  Implementado em: 21/12/2024                                                         â•‘
    // â•‘  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•‘
    // â•‘  â€¢ Regista TODAS as alteraÃ§Ãµes feitas Ã s reservas                                    â•‘
    // â•‘  â€¢ Reserva faturada = campos bloqueados (exceto R62 IncidÃªncias)                     â•‘
    // â•‘  â€¢ Utilizadores com permissÃ£o podem desbloquear                                      â•‘
    // â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    let historicoReservas = []; // Array global para histÃ³rico
    
    // Carregar histÃ³rico do localStorage
    function carregarHistoricoReservas() {
        try {
            const dados = localStorage.getItem('erpHistoricoReservas');
            if (dados) {
                historicoReservas = JSON.parse(dados);
                console.log('âœ… Carregados ' + historicoReservas.length + ' registos de histÃ³rico');
            }
        } catch (e) {
            console.error('Erro ao carregar histÃ³rico:', e);
            historicoReservas = [];
        }
    }
    
    // Guardar histÃ³rico no localStorage
    function guardarHistoricoReservas() {
        try {
            localStorage.setItem('erpHistoricoReservas', JSON.stringify(historicoReservas));
            console.log('ğŸ’¾ HistÃ³rico guardado: ' + historicoReservas.length + ' registos');
        } catch (e) {
            console.error('Erro ao guardar histÃ³rico:', e);
        }
    }
    
    /**
     * Regista uma alteraÃ§Ã£o no histÃ³rico de reservas
     * @param {string} numeroReserva - NÃºmero da reserva (ex: RES-2025-001)
     * @param {string} tipoAcao - Tipo de aÃ§Ã£o: CRIACAO, ALTERACAO, FATURACAO, CMR_CARGA, CMR_DESCARGA, etc.
     * @param {string} descricao - DescriÃ§Ã£o da alteraÃ§Ã£o
     * @param {object} camposAlterados - Objeto com {campo: {antes, depois}}
     */
    function registarHistoricoReserva(numeroReserva, tipoAcao, descricao, camposAlterados = null) {
        const registo = {
            id: Date.now(),
            numeroReserva: numeroReserva,
            tipoAcao: tipoAcao,
            descricao: descricao,
            camposAlterados: camposAlterados,
            dataHora: new Date().toISOString(),
            dataFormatada: new Date().toLocaleString('pt-PT'),
            utilizador: utilizadorActual?.nome || utilizador?.nome || 'Sistema',
            utilizadorId: utilizadorActual?.id || 1
        };
        
        historicoReservas.push(registo);
        guardarHistoricoReservas();
        
        console.log('ğŸ“œ HistÃ³rico registado:', registo);
        
        return registo;
    }
    
    /**
     * ObtÃ©m o histÃ³rico de uma reserva especÃ­fica
     */
    function obterHistoricoReserva(numeroReserva) {
        return historicoReservas.filter(h => h.numeroReserva === numeroReserva)
            .sort((a, b) => new Date(b.dataHora) - new Date(a.dataHora));
    }
    
    /**
     * Verifica se o utilizador tem permissÃ£o para editar reservas faturadas
     */
    function temPermissaoEditarFaturadas() {
        // Verificar no sistema de permissÃµes
        if (utilizadorActual?.perfil === 'admin') return true;
        if (utilizadorActual?.permissoes?.editarReservasFaturadas) return true;
        return false;
    }
    
    /**
     * Bloqueia todos os campos da reserva (exceto R62)
     */
    function bloquearCamposReserva() {
        // Lista de todos os IDs de campos das secÃ§Ãµes 1-6 (exceto R62)
        const camposParaBloquear = [
            // SecÃ§Ã£o 1 - Dados do Cliente
            'cliente_reserva', 'nome_cliente', 'contribuinte', 'cliente_rua', 'cliente_nr',
            'cliente_local', 'cliente_freg', 'cliente_cp', 'cliente_cidade', 'cliente_concelho',
            'cliente_pais', 'cliente_tel', 'equipa',
            // SecÃ§Ã£o 2 - Detalhes da Carga
            'ldm', 'num_bultos', 'descricao_carga', 'peso', 'preco_reserva', 'volume',
            'ton_carga', 'ton_descarga', 'complementar',
            // SecÃ§Ã£o 3 - Local de Carga
            'empresa_carga', 'carga_rua', 'carga_nr', 'carga_local', 'carga_freg',
            'carga_cp', 'carga_cidade', 'carga_concelho', 'carga_pais',
            'motorista_carga', 'trator_carga', 'reboque_carga', 'ref_carga',
            'contacto_carga', 'tel_carga', 'data_carga_sol', 'data_carga_ef',
            // SecÃ§Ã£o 4 - Local de Descarga
            'empresa_descarga', 'descarga_rua', 'descarga_nr', 'descarga_local', 'descarga_freg',
            'descarga_cp', 'descarga_cidade', 'descarga_concelho', 'descarga_pais',
            'motorista_descarga', 'trator_descarga', 'reboque_descarga', 'ref_descarga',
            'contacto_descarga', 'tel_descarga', 'data_descarga_sol', 'data_descarga_ef',
            // SecÃ§Ã£o 6 - SubcontrataÃ§Ã£o
            'fornecedor_sub', 'reboque_sub', 'motorista_sub', 'preco_sub'
        ];
        
        camposParaBloquear.forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                el.disabled = true;
                el.style.backgroundColor = '#f0f0f0';
                el.style.cursor = 'not-allowed';
            }
        });
        
        // âš ï¸ v6.10: BOTÃ•ES PERMANECEM ATIVOS!
        // Os botÃµes de aÃ§Ã£o (Enviar Etiquetas, CMR, Mensagens, etc.) ficam funcionais
        // para permitir operaÃ§Ãµes mesmo apÃ³s a reserva estar bloqueada.
        // Apenas os campos de input sÃ£o bloqueados.
        
        // Adicionar indicador visual de bloqueio nas secÃ§Ãµes
        ['secao1', 'secao2', 'secao3', 'secao4', 'secao6'].forEach(id => {
            const secao = document.getElementById(id);
            if (secao) {
                secao.classList.add('reserva-bloqueada');
                // Adicionar badge de bloqueado se nÃ£o existir
                const header = secao.querySelector('h2');
                if (header && !header.querySelector('.badge-bloqueado')) {
                    const badge = document.createElement('span');
                    badge.className = 'badge-bloqueado';
                    badge.innerHTML = ' ğŸ”’';
                    badge.title = 'Reserva criada - Campos bloqueados (botÃµes ativos)';
                    badge.style.cssText = 'color: #dc3545; font-size: 14px;';
                    header.appendChild(badge);
                }
            }
        });
        
        // Garantir que R62 (IncidÃªncias) permanece SEMPRE livre
        const campoIncidencias = document.getElementById('incidencias');
        if (campoIncidencias) {
            campoIncidencias.disabled = false;
            campoIncidencias.style.backgroundColor = '#fff';
            campoIncidencias.style.cursor = 'text';
            campoIncidencias.style.border = '2px solid #28a745'; // Destaque verde
        }
        
        console.log('ğŸ”’ Campos da reserva bloqueados (botÃµes de aÃ§Ã£o permanecem ATIVOS)');
    }
    
    /**
     * Desbloqueia todos os campos da reserva (para utilizadores com permissÃ£o)
     */
    function desbloquearCamposReserva() {
        // Verificar permissÃ£o
        if (!temPermissaoEditarFaturadas()) {
            alert('âš ï¸ NÃ£o tem permissÃ£o para editar reservas faturadas!\n\nContacte um administrador.');
            return false;
        }
        
        // Registar no histÃ³rico
        registarHistoricoReserva(numReserva, 'DESBLOQUEIO', 
            'Reserva desbloqueada para ediÃ§Ã£o por utilizador com permissÃ£o');
        
        // Campos que devem permanecer SEMPRE bloqueados (preenchimento automÃ¡tico pelo sistema)
        const camposSempreBloqueados = ['data_abertura', 'numero_reserva', 'numero_fatura', 'data_carga_ef', 'data_descarga_ef'];
        
        // Desbloquear todos os campos (exceto os que sÃ£o sempre bloqueados)
        const todosCampos = document.querySelectorAll('#page-reservas input, #page-reservas select, #page-reservas textarea');
        todosCampos.forEach(el => {
            if (!camposSempreBloqueados.includes(el.id)) {
                el.disabled = false;
                el.style.backgroundColor = '';
                el.style.cursor = '';
            }
        });
        
        // Garantir que R42 e R61 permanecem bloqueados
        const campoR42 = document.getElementById('data_carga_ef');
        const campoR61 = document.getElementById('data_descarga_ef');
        if (campoR42) { campoR42.style.backgroundColor = '#e9ecef'; campoR42.style.cursor = 'not-allowed'; }
        if (campoR61) { campoR61.style.backgroundColor = '#e9ecef'; campoR61.style.cursor = 'not-allowed'; }
        
        // Desbloquear botÃµes
        document.querySelectorAll('#page-reservas .reservas-btn').forEach(btn => {
            btn.disabled = false;
            btn.style.opacity = '1';
            btn.style.cursor = 'pointer';
        });
        
        // Remover badges de bloqueado
        document.querySelectorAll('.badge-bloqueado').forEach(b => b.remove());
        
        // Remover classe de bloqueio
        ['secao1', 'secao2', 'secao3', 'secao4', 'secao6'].forEach(id => {
            const secao = document.getElementById(id);
            if (secao) secao.classList.remove('reserva-bloqueada');
        });
        
        alert('ğŸ”“ Reserva desbloqueada para ediÃ§Ã£o!\n\nâš ï¸ Todas as alteraÃ§Ãµes serÃ£o registadas no histÃ³rico.');
        
        return true;
    }
    
    /**
     * Mostra o histÃ³rico de uma reserva em modal
     */
    function mostrarHistoricoReserva(numeroReserva) {
        const historico = obterHistoricoReserva(numeroReserva || numReserva);
        
        let html = `
            <div style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:99999;display:flex;align-items:center;justify-content:center;" onclick="this.remove()">
                <div style="background:white;border-radius:12px;max-width:700px;width:90%;max-height:80vh;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,0.3);" onclick="event.stopPropagation()">
                    <div style="background:linear-gradient(135deg,#1e3c72,#2a5298);color:white;padding:20px;display:flex;justify-content:space-between;align-items:center;">
                        <h3 style="margin:0;font-size:18px;">ğŸ“œ HistÃ³rico da Reserva ${numeroReserva || numReserva}</h3>
                        <button onclick="this.closest('div[style*=position]').remove()" style="background:rgba(255,255,255,0.2);border:none;color:white;width:32px;height:32px;border-radius:50%;cursor:pointer;font-size:18px;">Ã—</button>
                    </div>
                    <div style="padding:20px;max-height:60vh;overflow-y:auto;">
        `;
        
        if (historico.length === 0) {
            html += '<p style="text-align:center;color:#666;padding:40px;">Nenhum registo de histÃ³rico encontrado.</p>';
        } else {
            historico.forEach((reg, idx) => {
                const corTipo = {
                    'CRIACAO': '#28a745',
                    'ALTERACAO': '#ffc107',
                    'FATURACAO': '#17a2b8',
                    'CMR_CARGA': '#6f42c1',
                    'CMR_DESCARGA': '#6f42c1',
                    'DESBLOQUEIO': '#dc3545',
                    'INCIDENCIA': '#fd7e14'
                }[reg.tipoAcao] || '#6c757d';
                
                html += `
                    <div style="border-left:4px solid ${corTipo};padding:15px;margin-bottom:15px;background:#f8f9fa;border-radius:0 8px 8px 0;">
                        <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
                            <span style="background:${corTipo};color:white;padding:3px 10px;border-radius:12px;font-size:11px;font-weight:600;">${reg.tipoAcao}</span>
                            <span style="color:#666;font-size:12px;">ğŸ“… ${reg.dataFormatada}</span>
                        </div>
                        <p style="margin:0 0 8px 0;font-size:14px;">${reg.descricao}</p>
                        <div style="font-size:12px;color:#666;">ğŸ‘¤ ${reg.utilizador}</div>
                        ${reg.camposAlterados ? `
                            <details style="margin-top:10px;">
                                <summary style="cursor:pointer;color:#007bff;font-size:12px;">Ver campos alterados</summary>
                                <pre style="background:#fff;padding:10px;border-radius:4px;font-size:11px;overflow-x:auto;margin-top:8px;">${JSON.stringify(reg.camposAlterados, null, 2)}</pre>
                            </details>
                        ` : ''}
                    </div>
                `;
            });
        }
        
        html += `
                    </div>
                    <div style="padding:15px 20px;border-top:1px solid #dee2e6;text-align:right;">
                        <span style="color:#666;font-size:12px;">Total: ${historico.length} registo(s)</span>
                    </div>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', html);
    }
    
    // Inicializar histÃ³rico ao carregar
    carregarHistoricoReservas();
    
    const utilizador = {
        nome: 'JoÃ£o Silva',
        podeApagarIncidencias: false
    };
    
    // Dados da Frota - Motoristas
    const motoristasReservas = [
        { id: 1, nome: 'JoÃ£o Silva', telemovel: '912345678', carta: 'CE', status: 'disponivel' },
        { id: 2, nome: 'Pedro Santos', telemovel: '923456789', carta: 'CE', status: 'disponivel' },
        { id: 3, nome: 'Manuel Costa', telemovel: '934567890', carta: 'CE', status: 'em_servico' },
        { id: 4, nome: 'AntÃ³nio Ferreira', telemovel: '945678901', carta: 'CE', status: 'disponivel' },
        { id: 5, nome: 'Carlos Oliveira', telemovel: '956789012', carta: 'CE', status: 'disponivel' },
        { id: 6, nome: 'Rui Pereira', telemovel: '967890123', carta: 'CE', status: 'ferias' },
        { id: 7, nome: 'JosÃ© Rodrigues', telemovel: '978901234', carta: 'CE', status: 'disponivel' }
    ];

    // Dados da Frota - Tratores
    const tratoresReservas = [
        { matricula: '00-AA-00', marca: 'Volvo FH', ano: 2022, status: 'disponivel' },
        { matricula: '11-BB-11', marca: 'Scania R450', ano: 2021, status: 'disponivel' },
        { matricula: '22-CC-22', marca: 'Mercedes Actros', ano: 2023, status: 'em_servico' },
        { matricula: '33-DD-33', marca: 'DAF XF', ano: 2020, status: 'disponivel' },
        { matricula: '44-EE-44', marca: 'MAN TGX', ano: 2022, status: 'disponivel' },
        { matricula: '55-FF-55', marca: 'Iveco S-Way', ano: 2021, status: 'manutencao' },
        { matricula: '66-GG-66', marca: 'Renault T', ano: 2023, status: 'disponivel' }
    ];

    // Dados da Frota - Reboques
    const reboquesReservas = [
        { matricula: 'R-00-AA-00', tipo: 'Lona', capacidade: '24 ton', status: 'disponivel' },
        { matricula: 'R-11-BB-11', tipo: 'Lona', capacidade: '24 ton', status: 'disponivel' },
        { matricula: 'R-22-CC-22', tipo: 'FrigorÃ­fico', capacidade: '22 ton', status: 'em_servico' },
        { matricula: 'R-33-DD-33', tipo: 'Caixa', capacidade: '24 ton', status: 'disponivel' },
        { matricula: 'R-44-EE-44', tipo: 'Lona', capacidade: '24 ton', status: 'disponivel' },
        { matricula: 'R-55-FF-55', tipo: 'Basculante', capacidade: '26 ton', status: 'manutencao' },
        { matricula: 'R-66-GG-66', tipo: 'Porta-Contentores', capacidade: '28 ton', status: 'disponivel' }
    ];
    
    // Reservas pendentes (sem CMR de Carga na SecÃ§Ã£o 5)
    const reservasPendentes = [
        { numero: 'RES-2024-1001', cliente: 'Empresa ABC', cidade: 'Lisboa', cp: '1000-001', lat: 38.7223, lng: -9.1393, temCMR: false },
        { numero: 'RES-2024-1002', cliente: 'LogÃ­stica XYZ', cidade: 'Porto', cp: '4000-001', lat: 41.1579, lng: -8.6291, temCMR: false },
        { numero: 'RES-2024-1003', cliente: 'Transportes Silva', cidade: 'Coimbra', cp: '3000-001', lat: 40.2033, lng: -8.4103, temCMR: false },
        { numero: 'RES-2024-1004', cliente: 'Global Trade', cidade: 'Faro', cp: '8000-001', lat: 37.0194, lng: -7.9322, temCMR: false },
        { numero: 'RES-2024-1005', cliente: 'Norte Cargas', cidade: 'Braga', cp: '4700-001', lat: 41.5518, lng: -8.4229, temCMR: true }
    ];
    
    // Viaturas com GPS Frotcom
    const viaturasFrotcom = [
        { matricula: '00-AA-00', motorista: 'JoÃ£o Silva', lat: 38.7500, lng: -9.1000, status: 'disponivel' },
        { matricula: '11-BB-11', motorista: 'Pedro Santos', lat: 41.2000, lng: -8.5500, status: 'disponivel' },
        { matricula: '22-CC-22', motorista: 'Manuel Costa', lat: 40.1500, lng: -8.4500, status: 'em_rota' },
        { matricula: '33-DD-33', motorista: 'AntÃ³nio Ferreira', lat: 39.5000, lng: -8.0000, status: 'disponivel' },
        { matricula: '44-EE-44', motorista: 'Carlos Oliveira', lat: 37.1000, lng: -7.9000, status: 'disponivel' }
    ];
    
    function inicializarModuloReservas() {
        carregarReservasLS();
        document.getElementById('data_abertura').value = new Date().toISOString().split('T')[0];
        
        // Carregar clientes do mÃ³dulo de clientes (clientesLista)
        const dl = document.getElementById('listaClientesReservas');
        if (dl) {
            dl.innerHTML = ''; // Limpar opÃ§Ãµes existentes
            // Primeiro tentar clientesLista (mÃ³dulo de clientes)
            if (typeof clientesLista !== 'undefined' && clientesLista.length > 0) {
                clientesLista.forEach(c => {
                    const opt = document.createElement('option');
                    opt.value = c.nome_completo || c.nome || '';
                    opt.setAttribute('data-numero', c.numero || '');
                    dl.appendChild(opt);
                });
                console.log('âœ… ' + clientesLista.length + ' clientes carregados no datalist das Reservas');
            } 
            // Fallback para clientes (mÃ³dulo de faturaÃ§Ã£o)
            else if (typeof clientes !== 'undefined' && Array.isArray(clientes) && clientes.length > 0) {
                clientes.forEach(c => {
                    const opt = document.createElement('option');
                    opt.value = c.nome || c.nome_completo || '';
                    dl.appendChild(opt);
                });
            }
        }
        
        const formReserva = document.getElementById('formReserva');
        if (formReserva) {
            // Preencher R2 (Data) automaticamente com a data atual
            const campoData = document.getElementById('data_abertura');
            if (campoData && !campoData.value) {
                campoData.value = new Date().toISOString().split('T')[0];
            }
            
            // Atualizar asteriscos de obrigatoriedade R18/R19/R20 vs R23/R24/R25
            atualizarObrigatoriedadeR18R20();
            
            formReserva.addEventListener('submit', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                console.log('ğŸ“‹ FormulÃ¡rio de reserva submetido');
                
                // Validar campos condicionalmente obrigatÃ³rios
                const validacao = validarCamposObrigatoriosCondicionais();
                if (!validacao.valido) {
                    alert(validacao.mensagem);
                    return false;
                }
                
                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                // VERIFICAR SE CLIENTE ESTÃ BLOQUEADO - NÃƒO PERMITIR CRIAR RESERVA
                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                const nomeClienteForm = document.getElementById('cliente').value;
                if (nomeClienteForm) {
                    const clienteVerificado = verificarClienteBloqueado(nomeClienteForm);
                    if (clienteVerificado && clienteVerificado.bloqueado) {
                        alert('ğŸš« NÃƒO Ã‰ POSSÃVEL CRIAR RESERVA!\n\n' +
                              'âš ï¸ Cliente: ' + nomeClienteForm + '\n\n' +
                              'ğŸ”’ CLIENTE BLOQUEADO!\n\n' +
                              'Motivo: ' + (clienteVerificado.motivo || 'Verifique com o departamento financeiro') + '\n\n' +
                              'Contacte o departamento financeiro para regularizar a situaÃ§Ã£o.');
                        return false;
                    }
                }
                
                if (reservaCriada && !reservaFaturada) {
                    guardarReservaAtual();
                    document.getElementById('btnCriar').textContent = 'âœ“ Criar Reserva';
                    alert('âœ… ALTERAÃ‡Ã•ES GUARDADAS COM SUCESSO!\n\nğŸ’¾ Dados guardados no localStorage.');
                    return false;
                }
                
                if (reservaCriada) return false;
                
                // Garantir que R2 tem a data atual
                if (!document.getElementById('data_abertura').value) {
                    document.getElementById('data_abertura').value = new Date().toISOString().split('T')[0];
                }
                
                // Gerar nÃºmero de reserva Ãºnico
                const ano = new Date().getFullYear();
                let proximoNum = 1;
                
                // Encontrar o maior nÃºmero existente para este ano
                todasReservas.forEach(r => {
                    if (r.numero && r.numero.startsWith('RES-' + ano + '-')) {
                        const numStr = r.numero.split('-')[2];
                        const num = parseInt(numStr, 10);
                        if (!isNaN(num) && num >= proximoNum) {
                            proximoNum = num + 1;
                        }
                    }
                });
                
                numReserva = 'RES-' + ano + '-' + String(proximoNum).padStart(3, '0');
                document.getElementById('numero_reserva').value = numReserva;
                gerarQR();
                
                reservaCriada = true;
                const dadosGuardados = guardarReservaAtual();
                
                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                // BLOQUEAR RESERVA APÃ“S CRIAÃ‡ÃƒO
                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                
                // Bloquear todos os campos (exceto os sempre bloqueados)
                bloquearReservaParaVisualizacao();
                
                // Mudar texto do botÃ£o Criar para "Guardar AlteraÃ§Ãµes" e desabilitar
                const btnCriar = document.getElementById('btnCriar');
                if (btnCriar) {
                    btnCriar.textContent = 'ğŸ’¾ Guardar AlteraÃ§Ãµes';
                    btnCriar.disabled = true;
                    btnCriar.style.opacity = '0.5';
                    btnCriar.style.cursor = 'not-allowed';
                    btnCriar.style.background = 'linear-gradient(135deg, #95a5a6, #7f8c8d)';
                }
                
                // Desabilitar botÃ£o "Alterar" (lÃ¡pis)
                const btnAlterar = document.getElementById('btnAlterar');
                if (btnAlterar) {
                    btnAlterar.disabled = false; // Este fica ativo para permitir alteraÃ§Ãµes
                }
                
                alert('âœ… RESERVA CRIADA E GUARDADA!\n\nNÂº: ' + numReserva + '\n\nğŸ’¾ Guardada no localStorage\nğŸ”’ Reserva bloqueada para visualizaÃ§Ã£o\n\nğŸ“‹ Para ver todas as reservas: "Ver Reservas"\nâœï¸ Para editar: clique em "Alterar Reserva"\nâ• Para criar outra: clique em "Nova Reserva"');
                return false;
            });
        }
        
        console.log('âœ… MÃ³dulo Reservas v5.2 inicializado');
        console.log('   Total reservas no sistema: ' + todasReservas.length);
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // NAVEGAÃ‡ÃƒO POR TECLADO (ENTER e SETAS)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        inicializarNavegacaoTecladoReservas();
    }
    
    /**
     * Inicializa a navegaÃ§Ã£o por teclado nos campos da ficha de reservas
     * ENTER: passa para o prÃ³ximo campo
     * SETAS: navega entre campos
     */
    function inicializarNavegacaoTecladoReservas() {
        const pageReservas = document.getElementById('page-reservas');
        if (!pageReservas) return;
        
        // Obter TODOS os campos navegÃ¡veis (inputs, selects, textareas)
        // Incluindo readonly mas excluindo hidden e file
        function obterCamposNavegaveis() {
            const seletores = 'input:not([type="hidden"]):not([type="file"]):not([type="checkbox"]):not([type="radio"]), select, textarea';
            return Array.from(pageReservas.querySelectorAll(seletores)).filter(el => {
                // Filtrar elementos visÃ­veis
                const style = window.getComputedStyle(el);
                const rect = el.getBoundingClientRect();
                return style.display !== 'none' && 
                       style.visibility !== 'hidden' && 
                       rect.width > 0 && 
                       rect.height > 0 &&
                       !el.disabled; // IMPORTANTE: Saltar campos desabilitados
            });
        }
        
        // FunÃ§Ã£o auxiliar para encontrar o prÃ³ximo campo ATIVO (nÃ£o disabled)
        function encontrarProximoCampoAtivo(campos, indexAtual, direcao) {
            let novoIndex = indexAtual + direcao;
            while (novoIndex >= 0 && novoIndex < campos.length) {
                if (!campos[novoIndex].disabled) {
                    return novoIndex;
                }
                novoIndex += direcao;
            }
            // Se nÃ£o encontrou, retornar o Ãºltimo/primeiro vÃ¡lido
            return direcao > 0 ? campos.length - 1 : 0;
        }
        
        // Handler para navegaÃ§Ã£o por teclado
        pageReservas.addEventListener('keydown', function(e) {
            const target = e.target;
            
            // SÃ³ processar se o elemento ativo Ã© um campo de input
            if (!['INPUT', 'SELECT', 'TEXTAREA'].includes(target.tagName)) return;
            
            // Ignorar se Ã© o campo de incidÃªncias (textarea) para permitir Enter normal (nova linha)
            if (target.tagName === 'TEXTAREA' && e.key === 'Enter' && !e.ctrlKey) return;
            
            const campos = obterCamposNavegaveis();
            const indexAtual = campos.indexOf(target);
            
            if (indexAtual === -1) return;
            
            let novoIndex = indexAtual;
            
            switch(e.key) {
                case 'Enter':
                    e.preventDefault();
                    e.stopPropagation();
                    // AvanÃ§ar para o prÃ³ximo campo ATIVO (saltar disabled)
                    novoIndex = encontrarProximoCampoAtivo(campos, indexAtual, 1);
                    break;
                    
                case 'ArrowDown':
                    if (target.tagName !== 'SELECT') {
                        e.preventDefault();
                        novoIndex = encontrarProximoCampoAtivo(campos, indexAtual, 1);
                    }
                    break;
                    
                case 'ArrowUp':
                    if (target.tagName !== 'SELECT') {
                        e.preventDefault();
                        novoIndex = encontrarProximoCampoAtivo(campos, indexAtual, -1);
                    }
                    break;
                    
                default:
                    return; // NÃ£o processar outras teclas
            }
            
            // Focar no novo campo
            if (novoIndex !== indexAtual && campos[novoIndex]) {
                campos[novoIndex].focus();
                // Se for input de texto, selecionar todo o conteÃºdo
                if (campos[novoIndex].tagName === 'INPUT') {
                    setTimeout(() => campos[novoIndex].select(), 10);
                }
            }
        });
        
        console.log('âŒ¨ï¸ NavegaÃ§Ã£o por teclado (ENTER/Setas) ativada nas Reservas - ' + obterCamposNavegaveis().length + ' campos');
    }
    
    /**
     * Limpa o formulÃ¡rio para criar uma nova reserva
     * @param {boolean} silencioso - Se true, nÃ£o mostra alert (usado na navegaÃ§Ã£o)
     */
    function novaReservaLimpa(silencioso) {
        // Resetar flags
        reservaCriada = false;
        reservaFaturada = false;
        numReserva = null;
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // v6.30: LIMPAR CAMPOS DE FICHEIRO PRIMEIRO
        // CRÃTICO: Evita que ficheiros de outras reservas apareÃ§am no formulÃ¡rio
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        if (typeof limparCamposFicheiro === 'function') {
            limparCamposFicheiro();
        }
        
        // Limpar todos os campos do formulÃ¡rio
        const form = document.getElementById('formReserva');
        if (form) form.reset();
        
        // Preencher R2 com data atual
        document.getElementById('data_abertura').value = new Date().toISOString().split('T')[0];
        
        // Limpar nÃºmero de reserva e fatura
        document.getElementById('numero_reserva').value = '';
        document.getElementById('numero_fatura').value = '-';
        
        // Remover estado de bloqueio
        document.querySelectorAll('.badge-bloqueado').forEach(b => b.remove());
        ['secao1','secao2','secao3','secao4','secao5','secao6'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.classList.remove('bloqueada', 'reserva-bloqueada');
        });
        
        // Desbloquear todos os campos (exceto os que sÃ£o sempre bloqueados)
        const camposSempreBloqueados = ['data_abertura', 'numero_reserva', 'numero_fatura', 'data_carga_ef', 'data_descarga_ef'];
        document.querySelectorAll('#page-reservas input, #page-reservas select, #page-reservas textarea').forEach(el => {
            if (!camposSempreBloqueados.includes(el.id)) {
                el.disabled = false;
                el.style.backgroundColor = '';
                el.style.cursor = '';
            }
        });
        
        // Garantir que R42 e R61 permanecem bloqueados e com estilo correto
        const campoR42 = document.getElementById('data_carga_ef');
        const campoR61 = document.getElementById('data_descarga_ef');
        if (campoR42) { campoR42.style.backgroundColor = '#e9ecef'; campoR42.style.cursor = 'not-allowed'; }
        if (campoR61) { campoR61.style.backgroundColor = '#e9ecef'; campoR61.style.cursor = 'not-allowed'; }
        
        // Restaurar botÃµes
        document.querySelectorAll('#page-reservas .reservas-btn').forEach(btn => {
            btn.disabled = false;
            btn.style.opacity = '1';
            btn.style.cursor = 'pointer';
        });
        
        // Restaurar botÃ£o Criar Reserva especificamente
        const btnCriar = document.getElementById('btnCriar');
        if (btnCriar) {
            btnCriar.textContent = 'âœ“ Criar Reserva';
            btnCriar.disabled = false;
            btnCriar.style.opacity = '1';
            btnCriar.style.cursor = 'pointer';
            btnCriar.style.background = '';
        }
        
        document.getElementById('btnAlterar').disabled = false;
        document.getElementById('btnAlterar').style.background = '';
        document.getElementById('btnAlterar').style.cursor = 'pointer';
        
        // Banner de fatura
        document.getElementById('faturaBanner').classList.remove('bloqueada');
        document.getElementById('numFaturaDisplay').textContent = '-';
        document.getElementById('statusFatura').innerHTML = 'ğŸ”“ Reserva EditÃ¡vel';
        
        // Limpar QR Code da SecÃ§Ã£o 1 (v6.10)
        const reservaQRCode = document.getElementById('reservaQRCode');
        if (reservaQRCode) {
            reservaQRCode.innerHTML = '<span style="font-size:9px; color:#999;">QR</span>';
        }
        
        // Limpar histÃ³rico de incidÃªncias
        historicoInc = [];
        
        // Atualizar asteriscos de obrigatoriedade R18/R19/R20
        atualizarObrigatoriedadeR18R20();
        
        // Mostrar mensagem apenas se nÃ£o for silencioso
        if (!silencioso) {
            alert('ğŸ“ FormulÃ¡rio limpo!\n\nPode criar uma nova reserva.\n\nğŸ“… Data preenchida automaticamente: ' + new Date().toLocaleDateString('pt-PT'));
        } else {
            console.log('ğŸ“ FormulÃ¡rio de reservas resetado silenciosamente');
        }
    }
    
    /**
     * Reseta apenas as flags de controlo sem limpar o formulÃ¡rio
     * Usado quando se navega para a pÃ¡gina de reservas
     */
    function resetarFlagsReservas() {
        // Apenas resetar flags de controlo
        reservaCriada = false;
        reservaFaturada = false;
        numReserva = null;
        
        // Recarregar reservas do localStorage
        carregarReservasLS();
        
        // Preencher R2 com data atual se estiver vazio
        const campoData = document.getElementById('data_abertura');
        if (campoData && !campoData.value) {
            campoData.value = new Date().toISOString().split('T')[0];
        }
        
        // Restaurar botÃ£o Criar Reserva
        const btnCriar = document.getElementById('btnCriar');
        if (btnCriar) {
            btnCriar.textContent = 'âœ“ Criar Reserva';
            btnCriar.disabled = false;
            btnCriar.style.opacity = '1';
            btnCriar.style.cursor = 'pointer';
            btnCriar.style.background = '';
        }
        
        // Atualizar obrigatoriedade dos campos
        atualizarObrigatoriedadeR18R20();
        
        console.log('ğŸ”„ Flags de reservas resetadas - ' + todasReservas.length + ' reservas em memÃ³ria');
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // FUNÃ‡ÃƒO PARA RECARREGAR CLIENTES NAS RESERVAS
    // Chamada sempre que se navega para o mÃ³dulo de Reservas
    // Garante sincronizaÃ§Ã£o com o mÃ³dulo Financeiro/Clientes
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function recarregarClientesReservas() {
        const dl = document.getElementById('listaClientesReservas');
        if (!dl) return;
        
        dl.innerHTML = ''; // Limpar opÃ§Ãµes existentes
        
        // Verificar se clientesLista existe e tem dados
        if (typeof clientesLista !== 'undefined' && clientesLista.length > 0) {
            clientesLista.forEach(c => {
                const opt = document.createElement('option');
                // Mostrar nÃºmero do cliente + nome para facilitar seleÃ§Ã£o
                opt.value = c.nome_completo || c.nome || '';
                opt.setAttribute('data-numero', c.numero || '');
                opt.setAttribute('data-contribuinte', c.contribuinte || '');
                dl.appendChild(opt);
            });
            console.log('âœ… Reservas: ' + clientesLista.length + ' clientes carregados no datalist (C0001-C0010)');
        } 
        // Fallback: tentar carregar do localStorage se clientesLista estiver vazia
        else {
            try {
                const dadosLS = localStorage.getItem('erpClientes');
                if (dadosLS) {
                    const parsed = JSON.parse(dadosLS);
                    const listaLS = parsed.lista || [];
                    if (listaLS.length > 0) {
                        listaLS.forEach(c => {
                            const opt = document.createElement('option');
                            opt.value = c.nome_completo || c.nome || '';
                            opt.setAttribute('data-numero', c.numero || '');
                            dl.appendChild(opt);
                        });
                        console.log('âœ… Reservas: ' + listaLS.length + ' clientes carregados do localStorage');
                    }
                }
            } catch (e) {
                console.error('Erro ao carregar clientes do localStorage:', e);
            }
        }
    }
    
    function carregarReservasLS() {
        console.log('ğŸ“‚ carregarReservasLS() - InÃ­cio');
        
        const dados = localStorage.getItem('erpReservasExecutadas');
        console.log('ğŸ“Š Dados no localStorage:', dados ? 'SIM (' + Math.round(dados.length/1024) + ' KB)' : 'NÃƒO');
        
        if (dados) {
            try {
                todasReservas = JSON.parse(dados);
                console.log('âœ… Carregadas ' + todasReservas.length + ' reservas do localStorage');
                
                // Listar as reservas carregadas
                todasReservas.forEach(r => {
                    console.log('   ğŸ“‹ ' + r.numero + ' - ' + (r.cliente || 'Sem cliente') + ' | Campos: ' + Object.keys(r).length);
                });
            } catch (e) {
                console.error('âŒ Erro ao fazer parse das reservas:', e);
                todasReservas = criarReservasTeste();
                guardarReservasLS();
            }
        } else {
            console.log('ğŸ“‹ localStorage vazio - criando reservas de teste...');
            // Criar reservas de teste se nÃ£o existirem
            todasReservas = criarReservasTeste();
            guardarReservasLS();
            console.log('ğŸ“‹ Criadas ' + todasReservas.length + ' reservas de teste');
        }
        
        // Atualizar reservasPendentes para o mapa de recolhas
        atualizarReservasPendentes();
        
        console.log('ğŸ“‚ carregarReservasLS() - Fim | Total em memÃ³ria:', todasReservas.length);
    }
    
    function criarReservasTeste() {
        const hoje = new Date().toISOString().split('T')[0];
        return [
            {
                id: 1, numero: 'RES-2025-001', dataAbertura: hoje,
                cliente: 'Transportes RÃ¡pidos do Norte, Lda', clienteNumero: 'C0001',
                clienteCidade: 'Braga', cargaCidade: 'Braga', cargaCP: '4705-419',
                descargaCidade: 'Lisboa', descargaCP: '1000-001',
                ldm: '2', preco: '450', comercial: 'JoÃ£o Silva', equipa: 'Equipa Norte',
                faturada: false, lat: 41.5518, lng: -8.4229, temCMR: false
            },
            {
                id: 2, numero: 'RES-2025-002', dataAbertura: hoje,
                cliente: 'LogÃ­stica Centro Sul, SA', clienteNumero: 'C0002',
                clienteCidade: 'Lisboa', cargaCidade: 'Lisboa', cargaCP: '1000-001',
                descargaCidade: 'Porto', descargaCP: '4000-001',
                ldm: '3', preco: '520', comercial: 'Maria Santos', equipa: 'Equipa Centro',
                faturada: false, lat: 38.7223, lng: -9.1393, temCMR: false
            },
            {
                id: 3, numero: 'RES-2025-003', dataAbertura: hoje,
                cliente: 'Mercadorias IbÃ©ricas, Lda', clienteNumero: 'C0003',
                clienteCidade: 'Porto', cargaCidade: 'Porto', cargaCP: '4000-001',
                descargaCidade: 'Coimbra', descargaCP: '3000-001',
                ldm: '1.5', preco: '280', comercial: 'Pedro Costa', equipa: 'Equipa Norte',
                faturada: false, lat: 41.1579, lng: -8.6291, temCMR: false
            },
            {
                id: 4, numero: 'RES-2025-004', dataAbertura: hoje,
                cliente: 'Global Trade', clienteNumero: 'C0004',
                clienteCidade: 'Faro', cargaCidade: 'Faro', cargaCP: '8000-001',
                descargaCidade: 'Lisboa', descargaCP: '1000-001',
                ldm: '4', preco: '680', comercial: 'Ana Ferreira', equipa: 'Equipa Sul',
                faturada: false, lat: 37.0194, lng: -7.9322, temCMR: false
            },
            {
                id: 5, numero: 'RES-2025-005', dataAbertura: hoje,
                cliente: 'ExportaÃ§Ãµes Algarve Premium, SA', clienteNumero: 'C0010',
                clienteCidade: 'Faro', cargaCidade: 'Faro', cargaCP: '8000-077',
                descargaCidade: 'Porto', descargaCP: '4000-001',
                ldm: '2.5', preco: '750', comercial: 'Rui Almeida', equipa: 'Equipa Sul',
                faturada: true, faturaNumero: 'FT2025/001', lat: 37.0500, lng: -7.9000, temCMR: true
            }
        ];
    }
    
    function atualizarReservasPendentes() {
        // Atualizar a lista de reservas pendentes para o mapa de recolhas
        // Usar as reservas reais que nÃ£o tÃªm CMR de Carga
        reservasPendentes.length = 0; // Limpar array
        todasReservas.forEach(r => {
            if (!r.temCMR && !r.cmrCarga) {
                reservasPendentes.push({
                    numero: r.numero,
                    cliente: r.cliente,
                    cidade: r.cargaCidade || r.clienteCidade || 'Portugal',
                    cp: r.cargaCP || r.clienteCP || '0000-000',
                    lat: r.lat || 39.5 + (Math.random() * 3 - 1.5),
                    lng: r.lng || -8.5 + (Math.random() * 2 - 1),
                    temCMR: false
                });
            }
        });
        console.log('ğŸ“ ' + reservasPendentes.length + ' recolhas pendentes atualizadas');
    }
    
    function guardarReservasLS() {
        console.log('ğŸ’¾ guardarReservasLS() - InÃ­cio');
        console.log('ğŸ“¦ Reservas a guardar:', todasReservas.length);
        
        try {
            const dados = JSON.stringify(todasReservas);
            console.log('ğŸ“Š Tamanho dos dados:', Math.round(dados.length/1024), 'KB');
            
            localStorage.setItem('erpReservasExecutadas', dados);
            console.log('âœ… localStorage.setItem executado');
            
            // Verificar se foi guardado corretamente
            const verificacao = localStorage.getItem('erpReservasExecutadas');
            if (verificacao) {
                const parsed = JSON.parse(verificacao);
                console.log('âœ… VERIFICAÃ‡ÃƒO: ' + parsed.length + ' reservas confirmadas no localStorage');
                
                // Listar as reservas guardadas
                parsed.forEach(r => {
                    console.log('   ğŸ“‹ ' + r.numero + ' - ' + (r.cliente || 'Sem cliente'));
                });
            } else {
                console.error('âŒ ERRO: localStorage estÃ¡ vazio apÃ³s setItem!');
                alert('âŒ ERRO CRÃTICO!\n\nNÃ£o foi possÃ­vel guardar as reservas no browser.\n\nVerifique se o browser permite localStorage.');
            }
        } catch (e) {
            console.error('âŒ ERRO ao guardar reservas:', e);
            console.error('Stack:', e.stack);
            alert('âŒ ERRO ao guardar reservas!\n\n' + e.message + '\n\nVerifique o espaÃ§o disponÃ­vel no browser ou se as cookies estÃ£o ativadas.');
        }
        
        console.log('ğŸ’¾ guardarReservasLS() - Fim');
    }
    
    function recolherDadosReserva() {
        const nomeCliente = document.getElementById('cliente').value;
        const clienteSel = clientes.find(c => c.nome === nomeCliente);
        const clienteId = clienteSel ? clienteSel.id : null;
        
        // Obter dados adicionais do cliente (nÃºmero, NIF, modo faturaÃ§Ã£o)
        const clienteNumero = document.getElementById('cliente_numero')?.value || '';
        const clienteNIF = document.getElementById('cliente_nif')?.value || '';
        const clienteModoFaturacao = document.getElementById('cliente_modo_faturacao')?.value || 'Manual';
        
        const localCarga = [
            document.getElementById('carga_cidade').value,
            document.getElementById('carga_pais').value
        ].filter(x => x).join(', ');
        
        const localDescarga = [
            document.getElementById('descarga_cidade').value,
            document.getElementById('descarga_pais').value
        ].filter(x => x).join(', ');
        
        return {
            id: Date.now(),
            numero: document.getElementById('numero_reserva').value,
            dataAbertura: document.getElementById('data_abertura').value,
            clienteId: clienteId,
            cliente: nomeCliente,
            clienteNumero: clienteNumero,           // NÂº do cliente (C0001, C0002, etc.)
            clienteNIF: clienteNIF,                 // NIF/Contribuinte
            modoFaturacao: clienteModoFaturacao,    // Modo FaturaÃ§Ã£o (AutomÃ¡tica/Manual) - C52
            clienteRua: document.getElementById('cliente_rua').value,
            clienteNr: document.getElementById('cliente_nr').value,
            clienteLocal: document.getElementById('cliente_local').value,
            clienteCP: document.getElementById('cliente_cp').value,
            clienteCidade: document.getElementById('cliente_cidade').value,
            clienteConcelho: document.getElementById('cliente_concelho').value,
            clientePais: document.getElementById('cliente_pais').value,
            clienteTel: document.getElementById('cliente_tel').value,
            clienteFreg: document.getElementById('cliente_freg').value,
            comercial: document.getElementById('comercial').value,
            equipa: document.getElementById('equipa').value,
            ldm: document.getElementById('ldm').value,
            numBultos: document.getElementById('num_bultos').value,
            descricaoCarga: document.getElementById('descricao_carga').value,
            peso: parseFloat(document.getElementById('peso').value) || 0,
            preco: parseFloat(document.getElementById('preco').value) || 0,
            volumes: document.getElementById('volumes').value,
            tipoMercadoria: document.getElementById('tipo_merc').value || 'Normal',
            tonCarga: parseFloat(document.getElementById('ton_carga').value) || 0,
            tonDescarga: parseFloat(document.getElementById('ton_descarga').value) || 0,
            precoTon: parseFloat(document.getElementById('preco_ton').value) || 0,
            localCarga: localCarga,
            empresaCarga: document.getElementById('empresa_carga').value,
            cargaRua: document.getElementById('carga_rua').value,
            cargaNr: document.getElementById('carga_nr').value,
            cargaLocal: document.getElementById('carga_local').value,
            cargaFreg: document.getElementById('carga_freg').value,
            cargaCP: document.getElementById('carga_cp').value,
            cargaCidade: document.getElementById('carga_cidade').value,
            cargaConcelho: document.getElementById('carga_concelho').value,
            cargaPais: document.getElementById('carga_pais').value,
            motoristaCarga: document.getElementById('motorista_carga').value,
            tratorCarga: document.getElementById('trator_carga').value,
            reboqueCarga: document.getElementById('reboque_carga').value,
            refCombustivel: document.getElementById('ref_comb').value,
            contactoCarga: document.getElementById('contacto_carga').value,
            telCarga: document.getElementById('tel_carga').value,
            dataCargaSol: document.getElementById('data_carga_sol').value,
            dataCargaEf: document.getElementById('data_carga_ef').value,
            refCarga: document.getElementById('ref_carga').value,
            refCliente: document.getElementById('ref_cliente').value,
            localDescarga: localDescarga,
            empresaDescarga: document.getElementById('empresa_descarga').value,
            descargaRua: document.getElementById('descarga_rua').value,
            descargaNr: document.getElementById('descarga_nr').value,
            descargaLocal: document.getElementById('descarga_local').value,
            descargaFreg: document.getElementById('descarga_freg').value,
            descargaCP: document.getElementById('descarga_cp').value,
            descargaCidade: document.getElementById('descarga_cidade').value,
            descargaConcelho: document.getElementById('descarga_concelho').value,
            descargaPais: document.getElementById('descarga_pais').value,
            motoristaDescarga: document.getElementById('motorista_descarga').value,
            tratorDescarga: document.getElementById('trator_descarga').value,
            reboqueDescarga: document.getElementById('reboque_descarga').value,
            refDescarga: document.getElementById('ref_descarga').value,
            contactoDescarga: document.getElementById('contacto_descarga').value,
            telDescarga: document.getElementById('tel_descarga').value,
            dataDescargaSol: document.getElementById('data_descarga_sol').value,
            dataDescargaEf: document.getElementById('data_descarga_ef').value,
            pesoCarga: parseFloat(document.getElementById('peso').value) || parseFloat(document.getElementById('ton_carga').value) * 1000 || 0,
            pesoDescarga: parseFloat(document.getElementById('ton_descarga').value) * 1000 || parseFloat(document.getElementById('peso').value) || 0,
            dataExecucao: document.getElementById('data_carga_ef').value?.split('T')[0] || document.getElementById('data_abertura').value,
            // CORREÃ‡ÃƒO v6.19: Campos de referÃªncia (texto livre)
            refCargaTexto: document.getElementById('ref_carga').value || '',
            refDescargaTexto: document.getElementById('ref_descarga').value || '',
            // CORREÃ‡ÃƒO v6.19: CMR sÃ³ Ã© preenchido quando ficheiro Ã© REALMENTE anexado
            // Estes campos sÃ£o preenchidos pela funÃ§Ã£o ficheiroAnexado() -> processarCMRAnexado()
            // NÃ£o devem ser preenchidos aqui com valores de texto
            cmrCarga: '',  // SerÃ¡ preenchido quando ficheiro CMR for anexado
            cmrDescarga: '', // SerÃ¡ preenchido quando ficheiro CMR for anexado
            cmrCargaAnexado: false,  // Flag: ficheiro CMR Carga foi anexado?
            cmrDescargaAnexado: false, // Flag: ficheiro CMR Descarga foi anexado?
            faturada: false,
            faturaNumero: null,
            dataFaturacao: null,
            incidencias: historicoInc,
            dataCriacao: new Date().toISOString(),
            ultimaAlteracao: new Date().toISOString(),
            criadoPor: utilizador.nome
        };
    }
    
    function guardarReservaAtual() {
        console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
        console.log('ğŸ“ INÃCIO - guardarReservaAtual()');
        console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
        
        const dadosReserva = recolherDadosReserva();
        console.log('ğŸ“‹ Dados recolhidos:', dadosReserva.numero, '| Cliente:', dadosReserva.cliente);
        console.log('ğŸ“Š Total de campos recolhidos:', Object.keys(dadosReserva).length);
        
        const index = todasReservas.findIndex(r => r.numero === dadosReserva.numero);
        console.log('ğŸ” Procurando reserva existente... Index:', index);
        console.log('ğŸ“¦ Total reservas em memÃ³ria ANTES:', todasReservas.length);
        
        if (index >= 0) {
            // Reserva existente - verificar se estÃ¡ faturada
            const reservaAnterior = todasReservas[index];
            
            if (reservaAnterior.faturada && !temPermissaoEditarFaturadas()) {
                alert('ğŸ”’ Esta reserva estÃ¡ FATURADA e nÃ£o pode ser alterada!\n\nApenas o campo R62 (IncidÃªncias) pode ser editado.');
                return null;
            }
            
            // Detetar campos alterados
            const camposAlterados = {};
            Object.keys(dadosReserva).forEach(campo => {
                if (dadosReserva[campo] !== reservaAnterior[campo] && 
                    campo !== 'id' && campo !== 'dataCriacao' && campo !== 'criadoPor') {
                    camposAlterados[campo] = {
                        antes: reservaAnterior[campo],
                        depois: dadosReserva[campo]
                    };
                }
            });
            
            // Preservar dados originais
            dadosReserva.id = reservaAnterior.id;
            dadosReserva.dataCriacao = reservaAnterior.dataCriacao;
            dadosReserva.criadoPor = reservaAnterior.criadoPor;
            dadosReserva.faturada = reservaAnterior.faturada;
            dadosReserva.faturaNumero = reservaAnterior.faturaNumero;
            
            // CORREÃ‡ÃƒO v6.28: Preservar campos CMR (nÃ£o podem ser perdidos ao guardar)
            if (reservaAnterior.cmrCarga) dadosReserva.cmrCarga = reservaAnterior.cmrCarga;
            if (reservaAnterior.cmr_carga) dadosReserva.cmr_carga = reservaAnterior.cmr_carga;
            if (reservaAnterior.cmrCargaAnexado) dadosReserva.cmrCargaAnexado = reservaAnterior.cmrCargaAnexado;
            if (reservaAnterior.cmrCargaData) dadosReserva.cmrCargaData = reservaAnterior.cmrCargaData;
            if (reservaAnterior.cmrDescarga) dadosReserva.cmrDescarga = reservaAnterior.cmrDescarga;
            if (reservaAnterior.cmr_descarga) dadosReserva.cmr_descarga = reservaAnterior.cmr_descarga;
            if (reservaAnterior.cmrDescargaAnexado) dadosReserva.cmrDescargaAnexado = reservaAnterior.cmrDescargaAnexado;
            if (reservaAnterior.cmrDescargaData) dadosReserva.cmrDescargaData = reservaAnterior.cmrDescargaData;
            if (reservaAnterior.cmrCompleto) dadosReserva.cmrCompleto = reservaAnterior.cmrCompleto;
            if (reservaAnterior.faturaIdC52) dadosReserva.faturaIdC52 = reservaAnterior.faturaIdC52;
            if (reservaAnterior.numero_fatura) dadosReserva.numero_fatura = reservaAnterior.numero_fatura;
            if (reservaAnterior.dataFaturacao) dadosReserva.dataFaturacao = reservaAnterior.dataFaturacao;
            if (reservaAnterior.prontaParaFaturacao) dadosReserva.prontaParaFaturacao = reservaAnterior.prontaParaFaturacao;
            if (reservaAnterior.emailEnviado) dadosReserva.emailEnviado = reservaAnterior.emailEnviado;
            if (reservaAnterior.dataEnvioEmail) dadosReserva.dataEnvioEmail = reservaAnterior.dataEnvioEmail;
            
            todasReservas[index] = dadosReserva;
            
            // Registar no histÃ³rico se houve alteraÃ§Ãµes
            if (Object.keys(camposAlterados).length > 0) {
                const descricao = 'AlteraÃ§Ã£o de ' + Object.keys(camposAlterados).length + ' campo(s)';
                registarHistoricoReserva(dadosReserva.numero, 'ALTERACAO', descricao, camposAlterados);
            }
            
            console.log('âœï¸ Reserva ATUALIZADA: ' + dadosReserva.numero);
        } else {
            // Nova reserva - ADICIONAR AO ARRAY
            console.log('â• NOVA reserva - adicionando ao array...');
            todasReservas.push(dadosReserva);
            console.log('ğŸ“¦ Total reservas em memÃ³ria DEPOIS:', todasReservas.length);
            
            // Registar criaÃ§Ã£o no histÃ³rico
            registarHistoricoReserva(dadosReserva.numero, 'CRIACAO', 
                'Reserva criada para cliente: ' + dadosReserva.cliente);
            
            console.log('â• Nova reserva ADICIONADA: ' + dadosReserva.numero);
        }
        
        // GUARDAR NO LOCALSTORAGE
        console.log('ğŸ’¾ A guardar no localStorage...');
        guardarReservasLS();
        
        // VERIFICAÃ‡ÃƒO IMEDIATA
        const verificacao = localStorage.getItem('erpReservasExecutadas');
        if (verificacao) {
            const parsed = JSON.parse(verificacao);
            console.log('âœ… VERIFICAÃ‡ÃƒO: ' + parsed.length + ' reservas no localStorage');
            console.log('ğŸ“‹ Reservas guardadas:', parsed.map(r => r.numero).join(', '));
        } else {
            console.error('âŒ ERRO: localStorage estÃ¡ vazio apÃ³s guardar!');
        }
        
        console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
        console.log('âœ… FIM - guardarReservaAtual()');
        console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // SINCRONIZAÃ‡ÃƒO: Atualizar Agenda 1 com dados R35, R36, R37 e R54, R55, R56
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        if (typeof sincronizarReservaParaAgenda1 === 'function') {
            sincronizarReservaParaAgenda1(
                dadosReserva.numero,
                dadosReserva.motoristaCarga,
                dadosReserva.tratorCarga,
                dadosReserva.reboqueCarga,
                dadosReserva.motoristaDescarga,
                dadosReserva.tratorDescarga,
                dadosReserva.reboqueDescarga
            );
        }
        
        return dadosReserva;
    }
    
    function expandirMotivoBloqueio() {
        const conteudo = document.getElementById('bloqueioConteudo');
        if (!clienteAtualBloqueio || !clienteAtualBloqueio.historicoBloqueio || clienteAtualBloqueio.historicoBloqueio.length === 0) {
            conteudo.innerHTML = '<p style="color:#28a745;"><strong>âœ… Cliente sem bloqueio</strong></p><p>Este cliente nÃ£o possui nenhum registo de bloqueio.</p>';
            conteudo.style.background = '#d4edda';
            conteudo.style.borderColor = '#28a745';
        } else {
            let html = '<p style="color:#721c24;margin-bottom:15px;"><strong>âš ï¸ CLIENTE BLOQUEADO</strong></p>';
            clienteAtualBloqueio.historicoBloqueio.forEach((item) => {
                html += '<div style="background:white;padding:12px;border-radius:6px;margin-bottom:10px;border-left:4px solid #dc3545;">';
                html += '<div style="font-size:11px;color:#6c757d;margin-bottom:5px;">ğŸ“… ' + item.data + ' - ğŸ‘¤ ' + item.usuario + '</div>';
                html += '<div style="font-size:13px;">' + item.motivo + '</div>';
                html += '</div>';
            });
            conteudo.innerHTML = html;
            conteudo.style.background = '#f8d7da';
            conteudo.style.borderColor = '#dc3545';
        }
        document.getElementById('modalBloqueio').classList.add('active');
    }

    function preencherCliente() {
        const nome = document.getElementById('cliente').value;
        
        if (!nome || nome.trim() === '') {
            alert('âš ï¸ Por favor, selecione ou escreva o nome do cliente primeiro.');
            return;
        }
        
        console.log('ğŸ” Procurando cliente:', nome);
        
        // Garantir que temos a lista de clientes carregada
        let listaClientes = window.clientesLista;
        
        // Se nÃ£o existe em window, tentar carregar do localStorage
        if (!listaClientes || listaClientes.length === 0) {
            try {
                const dados = localStorage.getItem('erpClientes');
                if (dados) {
                    const parsed = JSON.parse(dados);
                    listaClientes = parsed.lista || [];
                    window.clientesLista = listaClientes;
                    console.log('ğŸ“¦ Clientes carregados do localStorage:', listaClientes.length);
                }
            } catch (e) {
                console.error('Erro ao carregar clientes:', e);
            }
        }
        
        console.log('ğŸ“‹ Lista de clientes disponÃ­vel:', listaClientes ? listaClientes.length : 0);
        
        // Procurar o cliente pelo nome (case-insensitive)
        let cliente = null;
        if (listaClientes && listaClientes.length > 0) {
            cliente = listaClientes.find(c => {
                const nomeCliente = (c.nome_completo || c.nome || '').toLowerCase().trim();
                const nomeProcurado = nome.toLowerCase().trim();
                return nomeCliente === nomeProcurado;
            });
        }
        
        // Fallback: procurar por correspondÃªncia parcial
        if (!cliente && listaClientes && listaClientes.length > 0) {
            cliente = listaClientes.find(c => {
                const nomeCliente = (c.nome_completo || c.nome || '').toLowerCase();
                return nomeCliente.includes(nome.toLowerCase()) || nome.toLowerCase().includes(nomeCliente);
            });
        }
        
        if (cliente) {
            console.log('âœ… Cliente encontrado:', cliente.numero, cliente.nome_completo);
            clienteAtualBloqueio = cliente;
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // PREENCHER DADOS DO CLIENTE (NÂº, NIF, Modo FaturaÃ§Ã£o)
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            const campoNumero = document.getElementById('cliente_numero');
            const campoNIF = document.getElementById('cliente_nif');
            const campoModoFat = document.getElementById('cliente_modo_faturacao');
            
            if (campoNumero) campoNumero.value = cliente.numero || '';
            if (campoNIF) campoNIF.value = cliente.contribuinte || cliente.nif || '';
            
            // Modo de FaturaÃ§Ã£o (C52) - IMPORTANTE para saber quando faturar
            const modoFat = cliente.modo_faturacao || cliente.modoFaturacao || 'Manual';
            if (campoModoFat) {
                campoModoFat.value = modoFat;
                
                // Colorir campo de modo faturaÃ§Ã£o conforme o tipo
                if (modoFat === 'AutomÃ¡tica' || modoFat === 'Automatica') {
                    campoModoFat.style.background = '#d4edda';
                    campoModoFat.style.borderColor = '#28a745';
                    campoModoFat.style.color = '#155724';
                } else {
                    campoModoFat.style.background = '#fff3cd';
                    campoModoFat.style.borderColor = '#e67e22';
                    campoModoFat.style.color = '#856404';
                }
            }
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // PREENCHER MORADA DO CLIENTE (R5-R13)
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            document.getElementById('cliente_rua').value = cliente.sede_rua || cliente.rua || '';
            document.getElementById('cliente_nr').value = cliente.sede_porta || cliente.numero_porta || '';
            document.getElementById('cliente_local').value = cliente.sede_lugar || cliente.localidade || '';
            document.getElementById('cliente_cp').value = cliente.sede_cp || cliente.codigo_postal || cliente.codigoPostal || '';
            document.getElementById('cliente_cidade').value = cliente.sede_cidade || cliente.cidade || '';
            document.getElementById('cliente_concelho').value = cliente.sede_concelho || cliente.concelho || '';
            document.getElementById('cliente_pais').value = cliente.pais || 'Portugal';
            document.getElementById('cliente_tel').value = cliente.telefone_geral || cliente.telefone || '';
            document.getElementById('cliente_freg').value = cliente.sede_freguesia || cliente.freguesia || '';
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // VERIFICAR BLOQUEIO DO CLIENTE (R3)
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            const div = document.getElementById('motivoBloqueio');
            const txt = document.getElementById('motivoTexto');
            const estaBloqueado = cliente.bloqueado || cliente.status === 'Bloqueado';
            
            if (estaBloqueado && cliente.historicoBloqueio && cliente.historicoBloqueio.length > 0) {
                div.classList.add('bloqueado');
                const ultimo = cliente.historicoBloqueio[cliente.historicoBloqueio.length - 1];
                let textoResumido = ultimo.motivo.length > 40 ? ultimo.motivo.substring(0, 40) + '...' : ultimo.motivo;
                txt.innerHTML = 'âš ï¸ <b>BLOQUEADO</b> (' + ultimo.data.split(' ')[0] + '): ' + textoResumido;
                alert('âš ï¸ ATENÃ‡ÃƒO: CLIENTE BLOQUEADO!\n\nÃšltimo registo: ' + ultimo.data + '\n\nMotivo: ' + ultimo.motivo);
            } else if (estaBloqueado) {
                div.classList.add('bloqueado');
                txt.innerHTML = 'âš ï¸ <b>BLOQUEADO</b> - Verifique situaÃ§Ã£o com o departamento financeiro';
                alert('âš ï¸ ATENÃ‡ÃƒO: CLIENTE BLOQUEADO!\n\nVerifique a situaÃ§Ã£o com o departamento financeiro.');
            } else {
                div.classList.remove('bloqueado');
                txt.textContent = 'âœ… Cliente sem bloqueio';
            }
            
            // Mensagem de sucesso com informaÃ§Ã£o do modo de faturaÃ§Ã£o
            const msgFaturacao = modoFat === 'AutomÃ¡tica' || modoFat === 'Automatica' 
                ? 'ğŸ“„ FaturaÃ§Ã£o AUTOMÃTICA - Fatura serÃ¡ criada automaticamente apÃ³s CMR de Carga'
                : 'ğŸ“ FaturaÃ§Ã£o MANUAL - Reserva irÃ¡ para PrÃ©-FaturaÃ§Ã£o apÃ³s CMR completo';
            
            alert('âœ… Dados do cliente preenchidos!\n\n' +
                  'ğŸ“‹ Cliente: ' + cliente.numero + ' - ' + (cliente.nome_completo || cliente.nome) + '\n' +
                  'ğŸ¢ NIF: ' + (cliente.contribuinte || '-') + '\n' +
                  'ğŸ“ Cidade: ' + (cliente.sede_cidade || cliente.cidade || '-') + '\n\n' +
                  msgFaturacao);
            
            console.log('âœ… Cliente carregado:', cliente.numero, '| Modo FaturaÃ§Ã£o:', modoFat);
        } else {
            console.log('âŒ Cliente nÃ£o encontrado. Lista tem:', listaClientes ? listaClientes.length : 0, 'clientes');
            if (listaClientes && listaClientes.length > 0) {
                console.log('Clientes disponÃ­veis:', listaClientes.map(c => c.nome_completo || c.nome).join(', '));
            }
            alert('âš ï¸ Cliente nÃ£o encontrado!\n\nNome procurado: "' + nome + '"\n\nVerifique o nome ou adicione-o no mÃ³dulo Financeiro â†’ Clientes.');
        }
    }
    
    // Expor funÃ§Ã£o ao window para poder ser chamada pelo onclick
    window.preencherCliente = preencherCliente;
    
    /**
     * Verifica se um cliente estÃ¡ bloqueado
     * @param {string} nomeCliente - Nome do cliente a verificar
     * @returns {Object|null} - {bloqueado: true/false, motivo: string} ou null se nÃ£o encontrado
     */
    function verificarClienteBloqueado(nomeCliente) {
        if (!nomeCliente) return null;
        
        // Procurar cliente na lista
        let cliente = null;
        
        // Primeiro tentar na clientesLista (mÃ³dulo clientes)
        if (typeof clientesLista !== 'undefined' && clientesLista.length > 0) {
            cliente = clientesLista.find(c => 
                (c.nome_completo && c.nome_completo.toLowerCase() === nomeCliente.toLowerCase()) ||
                (c.nome && c.nome.toLowerCase() === nomeCliente.toLowerCase())
            );
        }
        
        // Fallback para clientes (mÃ³dulo faturaÃ§Ã£o)
        if (!cliente && typeof clientes !== 'undefined' && clientes.length > 0) {
            cliente = clientes.find(c => 
                (c.nome && c.nome.toLowerCase() === nomeCliente.toLowerCase()) ||
                (c.nome_completo && c.nome_completo.toLowerCase() === nomeCliente.toLowerCase())
            );
        }
        
        if (!cliente) {
            console.log('âš ï¸ Cliente nÃ£o encontrado para verificaÃ§Ã£o de bloqueio:', nomeCliente);
            return null;
        }
        
        const estaBloqueado = cliente.bloqueado || cliente.status === 'Bloqueado';
        
        if (estaBloqueado) {
            let motivo = 'Verifique com o departamento financeiro';
            if (cliente.historicoBloqueio && cliente.historicoBloqueio.length > 0) {
                const ultimo = cliente.historicoBloqueio[cliente.historicoBloqueio.length - 1];
                motivo = ultimo.motivo || motivo;
            }
            console.log('ğŸ”’ Cliente BLOQUEADO:', nomeCliente, '| Motivo:', motivo);
            return { bloqueado: true, motivo: motivo, cliente: cliente };
        }
        
        return { bloqueado: false, motivo: null, cliente: cliente };
    }
    
    // Expor funÃ§Ã£o globalmente
    window.verificarClienteBloqueado = verificarClienteBloqueado;

    function copiarMoradaCarga() {
        document.getElementById('carga_rua').value = document.getElementById('cliente_rua').value;
        document.getElementById('carga_nr').value = document.getElementById('cliente_nr').value;
        document.getElementById('carga_local').value = document.getElementById('cliente_local').value;
        document.getElementById('carga_freg').value = document.getElementById('cliente_freg').value; // R13 â†’ R30
        document.getElementById('carga_cp').value = document.getElementById('cliente_cp').value;
        document.getElementById('carga_cidade').value = document.getElementById('cliente_cidade').value;
        document.getElementById('carga_concelho').value = document.getElementById('cliente_concelho').value;
        document.getElementById('carga_pais').value = document.getElementById('cliente_pais').value;
        alert('âœ… Morada copiada para Local de Carga!');
    }
    
    // Expor funÃ§Ã£o ao window
    window.copiarMoradaCarga = copiarMoradaCarga;

    function copiarMoradaDescarga() {
        document.getElementById('descarga_rua').value = document.getElementById('cliente_rua').value;
        document.getElementById('descarga_nr').value = document.getElementById('cliente_nr').value;
        document.getElementById('descarga_local').value = document.getElementById('cliente_local').value;
        document.getElementById('descarga_freg').value = document.getElementById('cliente_freg').value; // R13 â†’ R49
        document.getElementById('descarga_cp').value = document.getElementById('cliente_cp').value;
        document.getElementById('descarga_cidade').value = document.getElementById('cliente_cidade').value;
        document.getElementById('descarga_concelho').value = document.getElementById('cliente_concelho').value;
        document.getElementById('descarga_pais').value = document.getElementById('cliente_pais').value;
        alert('âœ… Morada copiada para Local de Descarga!');
    }
    
    // Expor funÃ§Ã£o ao window
    window.copiarMoradaDescarga = copiarMoradaDescarga;

    function mensagemMotoristaCarga() {
        tipoMsg = 'carga';
        document.getElementById('msgConteudo').innerHTML = '<p><b>A mensagem incluirÃ¡:</b></p><ul><li>Todos os campos da SecÃ§Ã£o 3</li><li>LDM e NÂº Bultos da SecÃ§Ã£o 2</li></ul><p><b>Deseja incluir tambÃ©m os dados do Local de Descarga (SecÃ§Ã£o 4)?</b></p>';
        document.getElementById('modalMsg').classList.add('active');
    }

    function mensagemMotoristaDescarga() {
        tipoMsg = 'descarga';
        document.getElementById('msgConteudo').innerHTML = '<p><b>Escolha uma opÃ§Ã£o:</b></p><p>âœ… <b>SIM</b> = Enviar apenas SecÃ§Ã£o 4</p><p>âŒ <b>NÃƒO</b> = Incluir tambÃ©m SecÃ§Ã£o 3 + LDM + Bultos</p>';
        document.getElementById('modalMsg').classList.add('active');
    }

    function enviarMsg(opcao) {
        let msg = '';
        if (tipoMsg === 'carga') {
            msg = 'ğŸ“¦ SecÃ§Ã£o 3 + LDM + NÂº Bultos';
            if (opcao) msg += '\nğŸ“ + SecÃ§Ã£o 4 (Local de Descarga)';
        } else {
            msg = opcao ? 'ğŸ“ Apenas SecÃ§Ã£o 4' : 'ğŸ“¦ SecÃ§Ã£o 3 + 4 + LDM + Bultos';
        }
        fecharModalReservas('modalMsg');
        alert('âœ… Mensagem enviada para o motorista!\n\nConteÃºdo:\n' + msg);
    }

    function enviarEtiquetas() {
        if (!numReserva) { alert('âš ï¸ Crie a reserva primeiro!'); return; }
        document.getElementById('etiqNum').textContent = numReserva;
        document.getElementById('etiqOrig').textContent = (document.getElementById('carga_cidade').value || '-') + ' (' + (document.getElementById('carga_cp').value || '-') + ')';
        document.getElementById('etiqDest').textContent = (document.getElementById('descarga_cidade').value || '-') + ' (' + (document.getElementById('descarga_cp').value || '-') + ')';
        document.getElementById('etiqQR').innerHTML = '';
        if (typeof QRCode !== 'undefined') {
            new QRCode(document.getElementById('etiqQR'), {text: numReserva, width: 100, height: 100});
        }
        document.getElementById('modalEtiq').classList.add('active');
    }

    function selecionarMotorista(campoDestino) {
        campoDestinoSelecao = campoDestino;
        document.getElementById('pesquisaMotorista').value = '';
        renderizarMotoristas(motoristasReservas);
        document.getElementById('modalMotorista').classList.add('active');
    }

    function renderizarMotoristas(lista) {
        let html = '';
        lista.forEach(m => {
            const corStatus = m.status === 'disponivel' ? '#27ae60' : (m.status === 'em_servico' ? '#f39c12' : '#6c757d');
            const textoStatus = m.status === 'disponivel' ? 'âœ… DisponÃ­vel' : (m.status === 'em_servico' ? 'ğŸš› Em ServiÃ§o' : 'ğŸ–ï¸ FÃ©rias');
            html += '<div onclick="escolherMotorista(\'' + m.nome + '\')" style="background:white; border-radius:8px; padding:15px; margin-bottom:10px; cursor:pointer; border-left:4px solid ' + corStatus + '; transition:all 0.3s; display:flex; justify-content:space-between; align-items:center;" onmouseover="this.style.transform=\'translateX(5px)\';this.style.boxShadow=\'0 2px 10px rgba(0,0,0,0.1)\'" onmouseout="this.style.transform=\'translateX(0)\';this.style.boxShadow=\'none\'">';
            html += '<div><div style="font-weight:bold; color:#1e3c72; font-size:15px;">ğŸ‘¤ ' + m.nome + '</div>';
            html += '<div style="font-size:12px; color:#6c757d;">ğŸ“± ' + m.telemovel + ' | ğŸªª Carta ' + m.carta + '</div></div>';
            html += '<div style="font-size:12px; color:' + corStatus + '; font-weight:bold;">' + textoStatus + '</div>';
            html += '</div>';
        });
        document.getElementById('listaMotoristas').innerHTML = html || '<p style="text-align:center;color:#6c757d;">Nenhum motorista encontrado</p>';
    }

    function filtrarMotoristas() {
        const termo = document.getElementById('pesquisaMotorista').value.toLowerCase();
        const filtrados = motoristasReservas.filter(m => m.nome.toLowerCase().includes(termo) || m.telemovel.includes(termo));
        renderizarMotoristas(filtrados);
    }

    function escolherMotorista(nome) {
        document.getElementById(campoDestinoSelecao).value = nome;
        fecharModalReservas('modalMotorista');
    }

    function selecionarTrator(campoDestino) {
        campoDestinoSelecao = campoDestino;
        document.getElementById('pesquisaTrator').value = '';
        renderizarTratores(tratoresReservas);
        document.getElementById('modalTrator').classList.add('active');
    }

    function renderizarTratores(lista) {
        let html = '';
        lista.forEach(t => {
            const corStatus = t.status === 'disponivel' ? '#27ae60' : (t.status === 'em_servico' ? '#f39c12' : '#dc3545');
            const textoStatus = t.status === 'disponivel' ? 'âœ… DisponÃ­vel' : (t.status === 'em_servico' ? 'ğŸš› Em ServiÃ§o' : 'ğŸ”§ ManutenÃ§Ã£o');
            html += '<div onclick="escolherTrator(\'' + t.matricula + '\')" style="background:white; border-radius:8px; padding:15px; margin-bottom:10px; cursor:pointer; border-left:4px solid ' + corStatus + '; transition:all 0.3s; display:flex; justify-content:space-between; align-items:center;" onmouseover="this.style.transform=\'translateX(5px)\';this.style.boxShadow=\'0 2px 10px rgba(0,0,0,0.1)\'" onmouseout="this.style.transform=\'translateX(0)\';this.style.boxShadow=\'none\'">';
            html += '<div><div style="font-weight:bold; color:#1e3c72; font-size:15px;">ğŸš› ' + t.matricula + '</div>';
            html += '<div style="font-size:12px; color:#6c757d;">' + t.marca + ' | Ano: ' + t.ano + '</div></div>';
            html += '<div style="font-size:12px; color:' + corStatus + '; font-weight:bold;">' + textoStatus + '</div>';
            html += '</div>';
        });
        document.getElementById('listaTratores').innerHTML = html || '<p style="text-align:center;color:#6c757d;">Nenhum trator encontrado</p>';
    }

    function filtrarTratores() {
        const termo = document.getElementById('pesquisaTrator').value.toLowerCase();
        const filtrados = tratoresReservas.filter(t => t.matricula.toLowerCase().includes(termo) || t.marca.toLowerCase().includes(termo));
        renderizarTratores(filtrados);
    }

    function escolherTrator(matricula) {
        document.getElementById(campoDestinoSelecao).value = matricula;
        fecharModalReservas('modalTrator');
    }

    function selecionarReboque(campoDestino) {
        campoDestinoSelecao = campoDestino;
        document.getElementById('pesquisaReboque').value = '';
        renderizarReboques(reboquesReservas);
        document.getElementById('modalReboque').classList.add('active');
    }

    function renderizarReboques(lista) {
        let html = '';
        lista.forEach(r => {
            const corStatus = r.status === 'disponivel' ? '#27ae60' : (r.status === 'em_servico' ? '#f39c12' : '#dc3545');
            const textoStatus = r.status === 'disponivel' ? 'âœ… DisponÃ­vel' : (r.status === 'em_servico' ? 'ğŸš› Em ServiÃ§o' : 'ğŸ”§ ManutenÃ§Ã£o');
            html += '<div onclick="escolherReboque(\'' + r.matricula + '\')" style="background:white; border-radius:8px; padding:15px; margin-bottom:10px; cursor:pointer; border-left:4px solid ' + corStatus + '; transition:all 0.3s; display:flex; justify-content:space-between; align-items:center;" onmouseover="this.style.transform=\'translateX(5px)\';this.style.boxShadow=\'0 2px 10px rgba(0,0,0,0.1)\'" onmouseout="this.style.transform=\'translateX(0)\';this.style.boxShadow=\'none\'">';
            html += '<div><div style="font-weight:bold; color:#1e3c72; font-size:15px;">ğŸš› ' + r.matricula + '</div>';
            html += '<div style="font-size:12px; color:#6c757d;">Tipo: ' + r.tipo + ' | ' + r.capacidade + '</div></div>';
            html += '<div style="font-size:12px; color:' + corStatus + '; font-weight:bold;">' + textoStatus + '</div>';
            html += '</div>';
        });
        document.getElementById('listaReboques').innerHTML = html || '<p style="text-align:center;color:#6c757d;">Nenhum reboque encontrado</p>';
    }

    function filtrarReboques() {
        const termo = document.getElementById('pesquisaReboque').value.toLowerCase();
        const filtrados = reboquesReservas.filter(r => r.matricula.toLowerCase().includes(termo) || r.tipo.toLowerCase().includes(termo));
        renderizarReboques(filtrados);
    }

    function escolherReboque(matricula) {
        document.getElementById(campoDestinoSelecao).value = matricula;
        fecharModalReservas('modalReboque');
    }

    function guardarIncidencia() {
        const txt = document.getElementById('incidencias').value.trim();
        if (!txt) { alert('âš ï¸ Escreva a incidÃªncia antes de guardar!'); return; }
        const data = new Date().toLocaleString('pt-PT');
        historicoInc.push({data: data, usuario: utilizador.nome, texto: txt, ficheiros: []});
        atualizarHistorico();
        document.getElementById('incidencias').value = '';
        alert('âœ… IncidÃªncia guardada!\n\nData/Hora: ' + data);
    }

    function atualizarHistorico() {
        const div = document.getElementById('historicoInc');
        if (historicoInc.length === 0) { 
            div.innerHTML = '<p style="color:#6c757d;font-style:italic;">Nenhuma incidÃªncia registada.</p>'; 
            return; 
        }
        let html = '';
        historicoInc.forEach((inc, idx) => {
            html += '<div class="reservas-historico-item">';
            html += '<div class="data">ğŸ“… ' + inc.data + ' - ğŸ‘¤ ' + inc.usuario + '</div>';
            html += '<div style="margin-top:5px;">' + inc.texto + '</div>';
            if (utilizador.podeApagarIncidencias) {
                html += '<button onclick="apagarIncidencia(' + idx + ')" style="margin-top:5px;font-size:10px;background:#dc3545;color:white;border:none;padding:3px 8px;border-radius:4px;cursor:pointer;">ğŸ—‘ï¸ Apagar</button>';
            }
            html += '</div>';
        });
        div.innerHTML = html;
    }

    function apagarIncidencia(idx) {
        if (!utilizador.podeApagarIncidencias) {
            alert('âš ï¸ NÃ£o tem permissÃ£o para apagar incidÃªncias!\n\nContacte um administrador.');
            return;
        }
        if (confirm('Tem a certeza que deseja apagar esta incidÃªncia?')) {
            historicoInc.splice(idx, 1);
            atualizarHistorico();
        }
    }

    function ficheiroInc(inp) { 
        if (inp.files.length > 0) alert('âœ… ' + inp.files.length + ' ficheiro(s) anexado(s) Ã  incidÃªncia'); 
    }
    
    // â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    // â•‘  ğŸ”´ TRIGGER C52 - MODO FATURAÃ‡ÃƒO (MemÃ³ria Descritiva - SecÃ§Ã£o 4)                     â•‘
    // â•‘  Implementado em: 21/12/2024                                                         â•‘
    // â•‘  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•‘
    // â•‘  AUTOMÃTICA: CMR Carga â†’ Cria fatura rascunho                                        â•‘
    // â•‘              CMR Descarga â†’ Envia fatura+CMR (C41+C44) e sÃ³ CMR (C47)                â•‘
    // â•‘  MANUAL:     CMR Carga+Descarga â†’ DisponÃ­vel na PrÃ©-FaturaÃ§Ã£o                        â•‘
    // â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    // VariÃ¡vel para guardar a reserva atualmente em ediÃ§Ã£o
    let reservaEmEdicao = null;
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // v6.31: VARIÃVEL GLOBAL DE SESSÃƒO - Rastreia ficheiros REALMENTE anexados nesta sessÃ£o
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // IMPORTANTE: Os browsers NÃƒO guardam ficheiros fÃ­sicos no localStorage!
    // SÃ³ guardam o NOME do ficheiro. Esta variÃ¡vel rastreia quais ficheiros existem de verdade.
    // Quando a pÃ¡gina Ã© recarregada, esta variÃ¡vel Ã© resetada (ficheiros perdidos).
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const ficheirosAnexadosSessao = {};
    
    /**
     * v6.31: Limpa TODOS os campos CMR de TODAS as reservas no localStorage
     * Use esta funÃ§Ã£o para corrigir dados corrompidos pelo bug anterior
     */
    function limparTodosCMRsStorage() {
        console.log('ğŸ§¹ v6.32 limparTodosCMRsStorage() - Limpando TODOS os CMRs e Base64...');
        
        if (!confirm('âš ï¸ ATENÃ‡ÃƒO!\n\nIsto vai APAGAR:\n- Todos os registos de CMR de TODAS as reservas\n- Todos os ficheiros Base64 guardados\n\nUse apenas se os dados estÃ£o corrompidos.\n\nTem a certeza que deseja continuar?')) {
            return;
        }
        
        // 1. Apagar TODOS os ficheiros Base64 do localStorage
        let base64Apagados = 0;
        const chavesParaApagar = [];
        for (let i = 0; i < localStorage.length; i++) {
            const chave = localStorage.key(i);
            if (chave && chave.startsWith('cmr_')) {
                chavesParaApagar.push(chave);
            }
        }
        chavesParaApagar.forEach(chave => {
            localStorage.removeItem(chave);
            base64Apagados++;
            console.log('ğŸ—‘ï¸ Base64 apagado:', chave);
        });
        
        // 2. Limpar metadados nas reservas
        const chavesStorage = ['erpReservasExecutadas', 'erpReservas'];
        let totalLimpas = 0;
        
        chavesStorage.forEach(chave => {
            try {
                const dadosStr = localStorage.getItem(chave);
                if (!dadosStr) return;
                
                const arrayReservas = JSON.parse(dadosStr);
                if (!Array.isArray(arrayReservas)) return;
                
                arrayReservas.forEach(reserva => {
                    // Limpar TODOS os campos relacionados com CMR
                    delete reserva.cmrCarga;
                    delete reserva.cmr_carga;
                    delete reserva.cmrCargaAnexado;
                    delete reserva.cmrCargaData;
                    delete reserva.cmrCargaFile;
                    delete reserva.cmrCargaBase64Key; // v6.32
                    delete reserva.cmrDescarga;
                    delete reserva.cmr_descarga;
                    delete reserva.cmrDescargaAnexado;
                    delete reserva.cmrDescargaData;
                    delete reserva.cmrDescargaFile;
                    delete reserva.cmrDescargaBase64Key; // v6.32
                    delete reserva.cmrCompleto;
                    totalLimpas++;
                });
                
                localStorage.setItem(chave, JSON.stringify(arrayReservas));
                console.log('âœ… Limpo em ' + chave + ': ' + arrayReservas.length + ' reservas');
                
            } catch (e) {
                console.error('Erro ao limpar ' + chave + ':', e);
            }
        });
        
        // 3. Limpar tambÃ©m a variÃ¡vel de sessÃ£o
        Object.keys(ficheirosAnexadosSessao).forEach(key => {
            delete ficheirosAnexadosSessao[key];
        });
        
        // 4. Limpar badges visuais
        document.querySelectorAll('.cmr-indicator-badge').forEach(el => el.remove());
        
        // 5. Recarregar dados em memÃ³ria
        if (typeof carregarReservasLS === 'function') {
            carregarReservasLS();
        }
        
        alert('âœ… LIMPEZA CONCLUÃDA!\n\n' + totalLimpas + ' reservas limpas\n' + base64Apagados + ' ficheiros Base64 apagados\n\nAgora pode anexar ficheiros normalmente.');
        
        console.log('ğŸ§¹ Limpeza concluÃ­da - ' + totalLimpas + ' reservas, ' + base64Apagados + ' ficheiros Base64');
    }
    
    /**
     * v6.31: Regista que um ficheiro foi anexado nesta sessÃ£o
     */
    function registarFicheiroSessao(numeroReserva, tipoCMR, nomeFicheiro) {
        const chave = numeroReserva + '_' + tipoCMR;
        ficheirosAnexadosSessao[chave] = {
            nome: nomeFicheiro,
            timestamp: new Date().toISOString()
        };
        console.log('ğŸ“ Registado na sessÃ£o:', chave, '=', nomeFicheiro);
    }
    
    /**
     * v6.31: Verifica se um ficheiro foi anexado nesta sessÃ£o
     */
    function ficheiroExisteNaSessao(numeroReserva, tipoCMR) {
        const chave = numeroReserva + '_' + tipoCMR;
        return ficheirosAnexadosSessao[chave] !== undefined;
    }
    
    function ficheiroAnexado(inp, tipo) { 
        if (!inp.files || inp.files.length === 0) return;
        
        const ficheiro = inp.files[0];
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // VERSÃƒO v6.32 - FICHEIROS PERSISTENTES EM BASE64
        // Converte o ficheiro para Base64 e guarda no localStorage
        // Permite ficheiros persistirem entre sessÃµes
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        // 1. Obter nÃºmero da reserva do formulÃ¡rio (ÃšNICA fonte de verdade)
        const campoNumero = document.getElementById('numero_reserva');
        if (!campoNumero || !campoNumero.value || campoNumero.value.trim() === '') {
            alert('âš ï¸ Guarde a reserva primeiro antes de anexar ficheiros.');
            inp.value = ''; // Limpar o input
            return;
        }
        
        const NUMERO_RESERVA_ALVO = campoNumero.value.trim();
        
        // Verificar tamanho do ficheiro (limite ~4MB para Base64 no localStorage)
        const MAX_SIZE = 4 * 1024 * 1024; // 4MB
        if (ficheiro.size > MAX_SIZE) {
            alert('âš ï¸ Ficheiro demasiado grande!\n\nTamanho mÃ¡ximo: 4MB\nTamanho do ficheiro: ' + (ficheiro.size / 1024 / 1024).toFixed(2) + 'MB\n\nPor favor, reduza o tamanho do ficheiro.');
            inp.value = '';
            return;
        }
        
        console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
        console.log('ğŸ“ v6.32 BASE64 - FICHEIRO ANEXADO');
        console.log('ğŸ“‹ Reserva ALVO:', NUMERO_RESERVA_ALVO);
        console.log('ğŸ“‹ Tipo:', tipo);
        console.log('ğŸ“‹ Ficheiro:', ficheiro.name);
        console.log('ğŸ“‹ Tamanho:', (ficheiro.size / 1024).toFixed(2), 'KB');
        console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
        
        // 2. Determinar qual campo atualizar
        const isCarga = (tipo === 'CMR Carga');
        const isDescarga = (tipo === 'CMR Descarga');
        
        if (!isCarga && !isDescarga) {
            // Outros tipos de ficheiro - apenas mostrar confirmaÃ§Ã£o
            mostrarNotificacaoC52('success', `âœ… ${tipo} anexado: ${ficheiro.name}`);
            return;
        }
        
        // 3. CONVERTER FICHEIRO PARA BASE64 (assÃ­ncrono)
        const reader = new FileReader();
        
        reader.onload = function(e) {
            const base64Data = e.target.result; // Data URL completo (inclui tipo MIME)
            
            console.log('âœ… Ficheiro convertido para Base64');
            console.log('ğŸ“Š Tamanho Base64:', (base64Data.length / 1024).toFixed(2), 'KB');
            
            // 4. Preencher data automÃ¡tica
            const dataHoraAtual = new Date().toISOString().slice(0, 16);
            
            if (isCarga) {
                const campo = document.getElementById('data_carga_ef');
                if (campo) {
                    campo.value = dataHoraAtual;
                    campo.style.background = '#d4edda';
                    setTimeout(() => { campo.style.background = '#e9ecef'; }, 2000);
                }
            } else if (isDescarga) {
                const campo = document.getElementById('data_descarga_ef');
                if (campo) {
                    campo.value = dataHoraAtual;
                    campo.style.background = '#d4edda';
                    setTimeout(() => { campo.style.background = '#e9ecef'; }, 2000);
                }
            }
            
            // 5. GUARDAR BASE64 NO LOCALSTORAGE
            const dataISO = new Date().toISOString();
            const tipoCMR = isCarga ? 'carga' : 'descarga';
            
            // Guardar ficheiro Base64 numa chave separada (para nÃ£o sobrecarregar a reserva)
            const chaveBase64 = `cmr_${NUMERO_RESERVA_ALVO}_${tipoCMR}`;
            const dadosFicheiro = {
                nome: ficheiro.name,
                tipo: ficheiro.type,
                tamanho: ficheiro.size,
                data: dataISO,
                base64: base64Data
            };
            
            try {
                localStorage.setItem(chaveBase64, JSON.stringify(dadosFicheiro));
                console.log('ğŸ’¾ Ficheiro Base64 guardado em:', chaveBase64);
            } catch (e) {
                console.error('âŒ Erro ao guardar Base64:', e);
                alert('âŒ Erro ao guardar ficheiro!\n\nO localStorage pode estar cheio.\nTente apagar alguns ficheiros antigos.');
                return;
            }
            
            // 6. Atualizar metadados na reserva
            const chavesStorage = ['erpReservasExecutadas', 'erpReservas'];
            let atualizouAlguma = false;
            
            chavesStorage.forEach(chave => {
                try {
                    const dadosStr = localStorage.getItem(chave);
                    if (!dadosStr) return;
                    
                    const arrayReservas = JSON.parse(dadosStr);
                    if (!Array.isArray(arrayReservas)) return;
                    
                    let modificou = false;
                    
                    for (let i = 0; i < arrayReservas.length; i++) {
                        const reserva = arrayReservas[i];
                        if (!reserva) continue;
                        
                        // COMPARAÃ‡ÃƒO ESTRITA
                        if (reserva.numero !== NUMERO_RESERVA_ALVO) continue;
                        
                        console.log('âœ… Encontrada em ' + chave + '[' + i + ']:', reserva.numero);
                        
                        // Atualizar campos CMR
                        if (isCarga) {
                            arrayReservas[i].cmrCarga = ficheiro.name;
                            arrayReservas[i].cmr_carga = ficheiro.name;
                            arrayReservas[i].cmrCargaAnexado = true;
                            arrayReservas[i].cmrCargaData = dataISO;
                            arrayReservas[i].cmrCargaBase64Key = chaveBase64; // ReferÃªncia ao ficheiro
                        } else if (isDescarga) {
                            arrayReservas[i].cmrDescarga = ficheiro.name;
                            arrayReservas[i].cmr_descarga = ficheiro.name;
                            arrayReservas[i].cmrDescargaAnexado = true;
                            arrayReservas[i].cmrDescargaData = dataISO;
                            arrayReservas[i].cmrDescargaBase64Key = chaveBase64; // ReferÃªncia ao ficheiro
                            arrayReservas[i].cmrCompleto = true;
                        }
                        
                        modificou = true;
                        atualizouAlguma = true;
                        break;
                    }
                    
                    if (modificou) {
                        localStorage.setItem(chave, JSON.stringify(arrayReservas));
                        console.log('ğŸ’¾ Metadados guardados em ' + chave);
                    }
                    
                } catch (e) {
                    console.error('Erro ao processar ' + chave + ':', e);
                }
            });
            
            // 7. Recarregar array em memÃ³ria
            if (typeof todasReservas !== 'undefined') {
                try {
                    const dadosAtualizados = localStorage.getItem('erpReservasExecutadas');
                    if (dadosAtualizados) {
                        const novoArray = JSON.parse(dadosAtualizados);
                        todasReservas.length = 0;
                        novoArray.forEach(r => todasReservas.push(r));
                    }
                } catch (e) {}
            }
            
            // 8. Registar na sessÃ£o e mostrar badge
            if (atualizouAlguma) {
                registarFicheiroSessao(NUMERO_RESERVA_ALVO, tipoCMR, ficheiro.name);
                
                const inputId = isCarga ? 'cmr_carga' : 'cmr_descarga';
                adicionarIndicadorCMR(inputId, ficheiro.name, tipo, true);
                
                mostrarNotificacaoC52('success', `âœ… ${tipo} anexado e GUARDADO permanentemente!`);
                console.log('âœ… CMR guardado com sucesso:', NUMERO_RESERVA_ALVO);
                
                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                // ğŸ”´ TRIGGER C52 - PROCESSAR CMR PARA FATURAÃ‡ÃƒO
                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                // IMPORTANTE: Chamar APÃ“S guardar os dados no localStorage
                // Este trigger verifica o modo de faturaÃ§Ã£o e:
                //   - Se AUTOMÃTICA: Cria fatura imediatamente
                //   - Se MANUAL: Envia para PrÃ©-FaturaÃ§Ã£o
                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                console.log('ğŸ”´ Chamando trigger C52 para:', tipoCMR);
                processarCMRAnexado(tipoCMR, ficheiro);
                
            } else {
                mostrarNotificacaoC52('warning', `âš ï¸ Reserva ${NUMERO_RESERVA_ALVO} nÃ£o encontrada`);
                console.warn('âš ï¸ Reserva nÃ£o encontrada:', NUMERO_RESERVA_ALVO);
            }
        };
        
        reader.onerror = function() {
            alert('âŒ Erro ao ler o ficheiro!');
            console.error('Erro FileReader:', reader.error);
        };
        
        // Iniciar leitura do ficheiro como Data URL (Base64)
        reader.readAsDataURL(ficheiro);
        
        console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    }
    
    /**
     * FunÃ§Ã£o principal do Trigger C52
     * Processa a anexaÃ§Ã£o de um CMR (Carga ou Descarga)
     */
    function processarCMRAnexado(tipoCMR, ficheiro) {
        // Obter reserva atual (da variÃ¡vel global ou do formulÃ¡rio)
        const reservaId = obterReservaAtualId();
        const numeroReserva = document.getElementById('numero_reserva')?.value;
        
        if (!reservaId && !numeroReserva) {
            console.warn('Trigger C52: Nenhuma reserva em ediÃ§Ã£o');
            return;
        }
        
        console.log('ğŸ” Trigger C52: Procurando reserva ID:', reservaId, '| NÃºmero:', numeroReserva);
        
        // Encontrar a reserva em TODOS os arrays possÃ­veis
        let reserva = null;
        
        // 1. CORREÃ‡ÃƒO v6.34: Procurar PRIMEIRO em erpReservasExecutadas (fonte principal dos dados de teste)
        if (!reserva) {
            try {
                const reservasExec = JSON.parse(localStorage.getItem('erpReservasExecutadas') || '[]');
                reserva = reservasExec.find(r => r.id === reservaId || r.numero === numeroReserva);
                if (reserva) {
                    console.log('âœ… Reserva encontrada em erpReservasExecutadas:', reserva.numero);
                }
            } catch (e) {
                console.warn('Erro ao ler erpReservasExecutadas:', e);
            }
        }
        
        // 2. Procurar em reservas globais
        if (!reserva && typeof reservas !== 'undefined' && reservas.length > 0) {
            reserva = reservas.find(r => r.id === reservaId || r.numero === numeroReserva);
            if (reserva) console.log('âœ… Reserva encontrada em reservas[]:', reserva.numero);
        }
        
        // 3. Procurar em todasReservas
        if (!reserva && typeof todasReservas !== 'undefined' && todasReservas.length > 0) {
            reserva = todasReservas.find(r => r.id === reservaId || r.numero === numeroReserva);
            if (reserva) console.log('âœ… Reserva encontrada em todasReservas[]:', reserva.numero);
        }
        
        // 4. Procurar no localStorage erpReservas
        if (!reserva) {
            try {
                const reservasLS = JSON.parse(localStorage.getItem('erpReservas') || '[]');
                reserva = reservasLS.find(r => r.id === reservaId || r.numero === numeroReserva);
                if (reserva) console.log('âœ… Reserva encontrada em erpReservas:', reserva.numero);
            } catch (e) {
                console.warn('Erro ao ler reservas do localStorage:', e);
            }
        }
        
        // 5. Se ainda nÃ£o encontrou, criar objeto com dados do formulÃ¡rio
        if (!reserva) {
            console.log('ğŸ“ Reserva nÃ£o encontrada - usando dados do formulÃ¡rio');
            reserva = {
                id: reservaId || Date.now(),
                numero: numeroReserva,
                clienteId: document.getElementById('cliente_reserva')?.value || null,
                clienteNumero: document.getElementById('cliente_numero')?.value || '',
                cliente: document.getElementById('nome_cliente')?.value || '',
                modoFaturacao: document.getElementById('cliente_modo_faturacao')?.value || 'Manual',
                descricao_carga: document.getElementById('descricao_carga')?.value || 'ServiÃ§o de transporte',
                preco: parseFloat(document.getElementById('preco')?.value) || 0
            };
        }
        
        console.log('ğŸ“‹ Reserva encontrada:', reserva.numero, '| Cliente:', reserva.cliente, '| ModoFaturaÃ§Ã£o:', reserva.modoFaturacao);
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // MODO DE FATURAÃ‡ÃƒO - PRIORIDADE:
        // 1. Campo do formulÃ¡rio (atual, em tempo real)
        // 2. Campo da reserva guardada (modoFaturacao ou modo_faturacao)
        // 3. Procurar no cliente pelo nÃºmero ou nome
        // 4. Default: Manual
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        // 1. Verificar campo do formulÃ¡rio PRIMEIRO (mais atual)
        let modoFaturacao = document.getElementById('cliente_modo_faturacao')?.value;
        console.log('ğŸ” Modo faturaÃ§Ã£o do formulÃ¡rio:', modoFaturacao);
        
        // 2. Se nÃ£o tem no formulÃ¡rio, verificar na reserva guardada
        if (!modoFaturacao || modoFaturacao === '') {
            modoFaturacao = reserva.modoFaturacao || reserva.modo_faturacao;
            console.log('ğŸ” Modo faturaÃ§Ã£o da reserva:', modoFaturacao);
        }
        
        // 3. Se ainda nÃ£o tem, procurar no cliente
        if (!modoFaturacao || modoFaturacao === '') {
            // Obter nÃºmero do cliente para procurar
            const clienteNumero = reserva.clienteNumero || document.getElementById('cliente_numero')?.value;
            const clienteNome = reserva.cliente || document.getElementById('nome_cliente')?.value;
            
            console.log('ğŸ” Procurando cliente por nÃºmero:', clienteNumero, '| nome:', clienteNome);
            
            // Procurar no mÃ³dulo de Clientes (clientesLista)
            let cliente = null;
            if (typeof clientesLista !== 'undefined' && clientesLista.length > 0) {
                cliente = clientesLista.find(c => 
                    c.numero === clienteNumero || 
                    c.nome_completo === clienteNome ||
                    (c.nome_completo && c.nome_completo.includes(clienteNome))
                );
            }
            
            // Procurar tambÃ©m no array clientes (mÃ³dulo faturaÃ§Ã£o)
            if (!cliente && typeof clientes !== 'undefined' && clientes.length > 0) {
                cliente = clientes.find(c => 
                    c.id === reserva.clienteId || 
                    c.numeroCliente === clienteNumero ||
                    c.nome === clienteNome
                );
            }
            
            if (cliente) {
                console.log('âœ… Cliente encontrado:', cliente.nome_completo || cliente.nome);
                modoFaturacao = cliente.modo_faturacao || cliente.modoFaturacao;
                console.log('ğŸ” Modo faturaÃ§Ã£o do cliente:', modoFaturacao);
            }
        }
        
        // 4. Default se nada foi encontrado
        if (!modoFaturacao || modoFaturacao === '') {
            modoFaturacao = 'Manual';
            console.log('âš ï¸ Modo faturaÃ§Ã£o nÃ£o encontrado - usando default: Manual');
        }
        
        console.log(`ğŸ”´ Trigger C52: ${tipoCMR.toUpperCase()} recebido | Modo FINAL: ${modoFaturacao}`);
        
        // Obter cliente para passar Ã s funÃ§Ãµes seguintes
        // CORREÃ‡ÃƒO v6.34: Procurar por clienteNumero OU clienteId
        const clienteNumero = reserva.clienteNumero || reserva.clienteId || document.getElementById('cliente_numero')?.value;
        let cliente = null;
        if (typeof clientesLista !== 'undefined' && clientesLista.length > 0) {
            cliente = clientesLista.find(c => 
                c.numero === clienteNumero || 
                c.id === clienteNumero ||
                c.numero === reserva.clienteId
            );
            if (cliente) {
                console.log('âœ… Cliente encontrado em clientesLista:', cliente.nome_completo || cliente.nome);
            }
        }
        if (!cliente && typeof clientes !== 'undefined' && clientes.length > 0) {
            cliente = clientes.find(c => 
                c.id === reserva.clienteId || 
                c.numero === clienteNumero ||
                c.numeroCliente === clienteNumero
            );
            if (cliente) {
                console.log('âœ… Cliente encontrado em clientes:', cliente.nome_completo || cliente.nome);
            }
        }
        
        // Se ainda nÃ£o encontrou cliente, criar objeto temporÃ¡rio com dados da reserva
        if (!cliente) {
            console.log('âš ï¸ Cliente nÃ£o encontrado - usando dados da reserva');
            cliente = {
                numero: clienteNumero,
                nome_completo: reserva.cliente,
                nome: reserva.cliente,
                contribuinte: reserva.clienteNIF,
                modo_faturacao: modoFaturacao
            };
        }
        
        // Processar conforme o tipo de CMR
        if (tipoCMR === 'carga') {
            processarCMRCarga(reserva, cliente, modoFaturacao, ficheiro);
        } else if (tipoCMR === 'descarga') {
            processarCMRDescarga(reserva, cliente, modoFaturacao, ficheiro);
        }
    }
    
    /**
     * Processa a receÃ§Ã£o do CMR de Carga (FASE 1 das regras C52)
     * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     * REGRA IMPORTANTE: Na faturaÃ§Ã£o automÃ¡tica, a fatura Ã© criada IMEDIATAMENTE
     * quando o CMR de Carga chega, e o nÃºmero da fatura vai para o campo verde
     * da reserva (NÂº Fatura na SecÃ§Ã£o 1).
     * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     */
    function processarCMRCarga(reserva, cliente, modoFaturacao, ficheiro) {
        console.log('ğŸ”´ processarCMRCarga - Modo:', modoFaturacao, '| Cliente:', cliente ? (cliente.nome_completo || cliente.nome) : 'NÃƒO ENCONTRADO');
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // CORREÃ‡ÃƒO v6.23: Atualizar APENAS esta reserva especÃ­fica
        // O ficheiro CMR sÃ³ deve ser adicionado a ESTA reserva, nÃ£o a outras
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        // Guardar ID e nÃºmero exactos ANTES de qualquer alteraÃ§Ã£o
        const reservaIdExacto = reserva.id;
        const reservaNumeroExacto = reserva.numero;
        
        // Atualizar reserva com dados do CMR - APENAS quando ficheiro Ã© realmente anexado
        reserva.cmrCarga = ficheiro.name;
        reserva.cmr_carga = ficheiro.name; // Compatibilidade
        reserva.cmrCargaAnexado = true;    // FLAG: CMR foi realmente anexado
        reserva.cmrCargaData = new Date().toISOString();
        reserva.cmrCargaFile = ficheiro;
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // VERIFICAR MODO DE FATURAÃ‡ÃƒO
        // Se Ã© AutomÃ¡tica, criar fatura mesmo sem cliente completo (usar dados da reserva)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        if (modoFaturacao === 'AutomÃ¡tica') {
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // MODO AUTOMÃTICO: Criar fatura IMEDIATAMENTE quando CMR Carga chega
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            
            // Se nÃ£o tem cliente, criar objeto cliente temporÃ¡rio com dados da reserva
            const clienteParaFatura = cliente || {
                nome_completo: reserva.cliente || 'Cliente nÃ£o identificado',
                nome: reserva.cliente || 'Cliente nÃ£o identificado',
                numero: reserva.clienteNumero || '',
                contribuinte: reserva.clienteNIF || document.getElementById('cliente_nif')?.value || '',
                prazo_pagamento_dias: 30,
                tipo_pais: 'nacional',
                // Campos de email para envio posterior (se disponÃ­veis)
                resp_contabilidade_email: '',
                resp_financeiro_email: '',
                resp_logistica_email: ''
            };
            
            console.log('ğŸ“„ Criando fatura automÃ¡tica para cliente:', clienteParaFatura.nome_completo);
            
            const fatura = criarFaturaAutomaticaC52(reserva, clienteParaFatura);
            
            // IMPORTANTE: Atualizar TODOS os campos de faturaÃ§Ã£o na reserva
            reserva.faturaIdC52 = fatura.id;
            reserva.faturaNumero = fatura.numero;      // Campo principal para controlo
            reserva.numero_fatura = fatura.numero;     // Compatibilidade com formulÃ¡rio
            reserva.faturada = true;                    // Marcar como faturada
            reserva.dataFaturacao = new Date().toISOString();
            
            // Atualizar o campo visual na interface (campo verde na SecÃ§Ã£o 1)
            const campoFaturaVisual = document.getElementById('numero_fatura');
            if (campoFaturaVisual) {
                campoFaturaVisual.value = fatura.numero;
                // Feedback visual - piscar verde
                campoFaturaVisual.style.background = '#22c55e';
                campoFaturaVisual.style.color = 'white';
                setTimeout(() => {
                    campoFaturaVisual.style.background = '#e8f5e9';
                    campoFaturaVisual.style.color = '#27ae60';
                }, 2000);
            }
            
            // Atualizar tambÃ©m o display do banner
            const numFaturaDisplay = document.getElementById('numFaturaDisplay');
            if (numFaturaDisplay) {
                numFaturaDisplay.textContent = fatura.numero;
            }
            
            // Atualizar status
            const statusFatura = document.getElementById('statusFatura');
            if (statusFatura) {
                statusFatura.textContent = 'âœ… Faturada Automaticamente';
                statusFatura.style.color = '#22c55e';
            }
            
            mostrarNotificacaoC52('success', 
                `âœ… FATURA AUTOMÃTICA CRIADA!\n\n` +
                `ğŸ“„ Fatura: ${fatura.numero}\n` +
                `ğŸ‘¤ Cliente: ${clienteParaFatura.nome_completo}\n` +
                `ğŸ’° Valor: ${formatCurrency(fatura.total)}\n\n` +
                `O nÃºmero da fatura foi preenchido no campo verde da reserva.`,
                6000
            );
            
        } else {
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // MODO MANUAL: Reserva vai para PrÃ©-FaturaÃ§Ã£o
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            reserva.prontaParaFaturacao = true;
            
            mostrarNotificacaoC52('info', 
                `ğŸ“‹ CMR Carga recebido.\n\n` +
                `Modo de faturaÃ§Ã£o: MANUAL\n` +
                `A reserva estÃ¡ disponÃ­vel na PrÃ©-FaturaÃ§Ã£o.`,
                4000
            );
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // GUARDAR RESERVA - APENAS ESTA RESERVA ESPECÃFICA
        // CORREÃ‡ÃƒO v6.23: Atualizar apenas os campos de CMR, nÃ£o substituir toda a reserva
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        // 1. Atualizar no array global 'reservas' (mÃ³dulo faturaÃ§Ã£o)
        if (typeof reservas !== 'undefined') {
            const idx = reservas.findIndex(r => r.id === reservaIdExacto && r.numero === reservaNumeroExacto);
            if (idx !== -1) {
                // Atualizar APENAS os campos de CMR Carga
                reservas[idx].cmrCarga = reserva.cmrCarga;
                reservas[idx].cmr_carga = reserva.cmr_carga;
                reservas[idx].cmrCargaAnexado = reserva.cmrCargaAnexado;
                reservas[idx].cmrCargaData = reserva.cmrCargaData;
                reservas[idx].cmrCargaFile = reserva.cmrCargaFile;
                // Campos de faturaÃ§Ã£o se aplicÃ¡vel
                if (reserva.faturada) reservas[idx].faturada = reserva.faturada;
                if (reserva.faturaNumero) reservas[idx].faturaNumero = reserva.faturaNumero;
                if (reserva.numero_fatura) reservas[idx].numero_fatura = reserva.numero_fatura;
                if (reserva.faturaIdC52) reservas[idx].faturaIdC52 = reserva.faturaIdC52;
                if (reserva.dataFaturacao) reservas[idx].dataFaturacao = reserva.dataFaturacao;
                if (reserva.prontaParaFaturacao) reservas[idx].prontaParaFaturacao = reserva.prontaParaFaturacao;
                console.log('âœ… CMR Carga atualizado em reservas[' + idx + '] - ID:', reservaIdExacto);
            } else {
                // Adicionar se nÃ£o existir
                reservas.push(reserva);
                console.log('âœ… Reserva adicionada ao array reservas - ID:', reservaIdExacto);
            }
        }
        
        // 2. Atualizar no array 'todasReservas' (mÃ³dulo reservas)
        if (typeof todasReservas !== 'undefined') {
            const idxTodas = todasReservas.findIndex(r => r.id === reservaIdExacto && r.numero === reservaNumeroExacto);
            if (idxTodas !== -1) {
                todasReservas[idxTodas].cmrCarga = reserva.cmrCarga;
                todasReservas[idxTodas].cmr_carga = reserva.cmr_carga;
                todasReservas[idxTodas].cmrCargaAnexado = reserva.cmrCargaAnexado;
                todasReservas[idxTodas].cmrCargaData = reserva.cmrCargaData;
                todasReservas[idxTodas].cmrCargaFile = reserva.cmrCargaFile;
                if (reserva.faturada) todasReservas[idxTodas].faturada = reserva.faturada;
                if (reserva.faturaNumero) todasReservas[idxTodas].faturaNumero = reserva.faturaNumero;
                if (reserva.numero_fatura) todasReservas[idxTodas].numero_fatura = reserva.numero_fatura;
                if (reserva.faturaIdC52) todasReservas[idxTodas].faturaIdC52 = reserva.faturaIdC52;
                if (reserva.dataFaturacao) todasReservas[idxTodas].dataFaturacao = reserva.dataFaturacao;
                if (reserva.prontaParaFaturacao) todasReservas[idxTodas].prontaParaFaturacao = reserva.prontaParaFaturacao;
                console.log('âœ… CMR Carga atualizado em todasReservas[' + idxTodas + '] - ID:', reservaIdExacto);
            } else {
                // Adicionar se nÃ£o existir (a reserva acabou de ser criada)
                todasReservas.push(reserva);
                console.log('âœ… Reserva adicionada ao array todasReservas - ID:', reservaIdExacto);
            }
            // IMPORTANTE: Guardar atravÃ©s de guardarReservasLS() que preserva TODAS as reservas
            guardarReservasLS();
        }
        
        // 3. Guardar faturas (sem tocar nas reservas)
        if (typeof faturas !== 'undefined') {
            localStorage.setItem('erpFaturas', JSON.stringify(faturas));
        }
        
        // 4. Guardar no localStorage - erpReservas (APENAS esta reserva)
        try {
            let reservasLS = JSON.parse(localStorage.getItem('erpReservas') || '[]');
            const idxLS = reservasLS.findIndex(r => r.id === reservaIdExacto && r.numero === reservaNumeroExacto);
            if (idxLS !== -1) {
                reservasLS[idxLS].cmrCarga = reserva.cmrCarga;
                reservasLS[idxLS].cmr_carga = reserva.cmr_carga;
                reservasLS[idxLS].cmrCargaAnexado = reserva.cmrCargaAnexado;
                reservasLS[idxLS].cmrCargaData = reserva.cmrCargaData;
                if (reserva.faturada) reservasLS[idxLS].faturada = reserva.faturada;
                if (reserva.faturaNumero) reservasLS[idxLS].faturaNumero = reserva.faturaNumero;
                if (reserva.numero_fatura) reservasLS[idxLS].numero_fatura = reserva.numero_fatura;
                if (reserva.faturaIdC52) reservasLS[idxLS].faturaIdC52 = reserva.faturaIdC52;
                if (reserva.dataFaturacao) reservasLS[idxLS].dataFaturacao = reserva.dataFaturacao;
                if (reserva.prontaParaFaturacao) reservasLS[idxLS].prontaParaFaturacao = reserva.prontaParaFaturacao;
                console.log('âœ… CMR Carga atualizado em erpReservas[' + idxLS + '] - ID:', reservaIdExacto);
            } else {
                // Adicionar se nÃ£o existir
                reservasLS.push(reserva);
                console.log('âœ… Reserva adicionada ao localStorage erpReservas - ID:', reservaIdExacto);
            }
            localStorage.setItem('erpReservas', JSON.stringify(reservasLS));
        } catch (e) {
            console.warn('Erro ao atualizar erpReservas:', e);
        }
        
        // 5. CORREÃ‡ÃƒO v6.34: Guardar no localStorage - erpReservasExecutadas (fonte principal de dados de teste)
        try {
            let reservasExec = JSON.parse(localStorage.getItem('erpReservasExecutadas') || '[]');
            const idxExec = reservasExec.findIndex(r => r.id === reservaIdExacto || r.numero === reservaNumeroExacto);
            if (idxExec !== -1) {
                reservasExec[idxExec].cmrCarga = reserva.cmrCarga;
                reservasExec[idxExec].cmr_carga = reserva.cmr_carga;
                reservasExec[idxExec].cmrCargaAnexado = reserva.cmrCargaAnexado;
                reservasExec[idxExec].cmrCargaData = reserva.cmrCargaData;
                if (reserva.faturada) reservasExec[idxExec].faturada = reserva.faturada;
                if (reserva.faturaNumero) reservasExec[idxExec].faturaNumero = reserva.faturaNumero;
                if (reserva.numero_fatura) reservasExec[idxExec].numero_fatura = reserva.numero_fatura;
                if (reserva.faturaIdC52) reservasExec[idxExec].faturaIdC52 = reserva.faturaIdC52;
                if (reserva.dataFaturacao) reservasExec[idxExec].dataFaturacao = reserva.dataFaturacao;
                if (reserva.prontaParaFaturacao) reservasExec[idxExec].prontaParaFaturacao = reserva.prontaParaFaturacao;
                localStorage.setItem('erpReservasExecutadas', JSON.stringify(reservasExec));
                console.log('âœ… CMR Carga atualizado em erpReservasExecutadas[' + idxExec + '] - ID:', reservaIdExacto);
            }
        } catch (e) {
            console.warn('Erro ao atualizar erpReservasExecutadas:', e);
        }
        
        console.log('âœ… CMR Carga processado - Reserva:', reservaNumeroExacto, '| ID:', reservaIdExacto);
    }
    
    /**
     * Processa a receÃ§Ã£o do CMR de Descarga (FASE 2 das regras C52)
     * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     * REGRA DE ENVIO DE EMAILS (SEMPRE AUTOMÃTICO):
     * 
     * O TRIGGER para enviar emails Ã©: FATURA + CMR DESCARGA (ambos presentes)
     * 
     * CenÃ¡rio 1: CMR Descarga chega + SEM fatura â†’ NÃƒO envia (espera pela fatura)
     * CenÃ¡rio 2: CMR Descarga chega + COM fatura â†’ ENVIA automaticamente
     * 
     * Emails enviados:
     * - C41 + C44 (Contabilidade + Financeiro) â†’ Fatura + CMR(s) num sÃ³ ficheiro
     * - C47 (LogÃ­stica) â†’ sÃ³ CMR
     * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     */
    function processarCMRDescarga(reserva, cliente, modoFaturacao, ficheiro) {
        console.log('ğŸ”´ processarCMRDescarga - Reserva:', reserva.numero || reserva.id);
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // CORREÃ‡ÃƒO v6.23: Atualizar APENAS esta reserva especÃ­fica
        // O ficheiro CMR sÃ³ deve ser adicionado a ESTA reserva, nÃ£o a outras
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        // Criar cÃ³pia para nÃ£o afetar outras referÃªncias
        const reservaAtualizada = { ...reserva };
        reservaAtualizada.cmrDescarga = ficheiro.name;
        reservaAtualizada.cmr_descarga = ficheiro.name; // Compatibilidade
        reservaAtualizada.cmrDescargaAnexado = true;    // FLAG: CMR foi realmente anexado
        reservaAtualizada.cmrDescargaData = new Date().toISOString();
        reservaAtualizada.cmrDescargaFile = ficheiro;
        reservaAtualizada.cmrCompleto = true;
        
        // Verificar se a reserva jÃ¡ estÃ¡ faturada (independente do modo)
        const estaFaturada = reservaAtualizada.faturada || reservaAtualizada.faturaNumero || reservaAtualizada.numero_fatura;
        
        // Encontrar a fatura correspondente (se existir)
        let fatura = null;
        if (reservaAtualizada.faturaIdC52) {
            fatura = faturas.find(f => f.id === reservaAtualizada.faturaIdC52);
        }
        if (!fatura && reservaAtualizada.faturaNumero) {
            fatura = faturas.find(f => f.numero === reservaAtualizada.faturaNumero);
        }
        if (!fatura && reservaAtualizada.numero_fatura) {
            fatura = faturas.find(f => f.numero === reservaAtualizada.numero_fatura);
        }
        if (!fatura && reservaAtualizada.faturaId) {
            fatura = faturas.find(f => f.id === reservaAtualizada.faturaId);
        }
        
        console.log('ğŸ“Š Estado: Faturada=', estaFaturada, '| Fatura encontrada=', fatura ? fatura.numero : 'NÃƒO');
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // REGRA v6.23: Verificar se TODAS as reservas da fatura tÃªm CMR de Descarga
        // SÃ³ envia email quando TODAS tiverem
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        if (estaFaturada && fatura && cliente) {
            // Verificar se jÃ¡ foi enviado
            if (fatura.emailEnviado) {
                mostrarNotificacaoC52('info', 
                    `ğŸ“§ CMR Descarga recebido.\n\nA fatura ${fatura.numero} jÃ¡ foi enviada anteriormente.`,
                    4000
                );
            } else {
                // Encontrar TODAS as reservas desta fatura
                const reservasDaFatura = [];
                
                // Procurar por linhas da fatura
                if (fatura.linhas && fatura.linhas.length > 0) {
                    fatura.linhas.forEach(linha => {
                        const numReserva = linha.cmr || linha.reservaNum || linha.referencia;
                        if (numReserva) {
                            // Procurar a reserva correspondente
                            let res = reservas.find(r => r.numero === numReserva || r.id === linha.reservaId);
                            if (!res && typeof todasReservas !== 'undefined') {
                                res = todasReservas.find(r => r.numero === numReserva);
                            }
                            if (res && !reservasDaFatura.find(rf => rf.id === res.id)) {
                                // Se esta Ã© a reserva que estamos a atualizar, usar a versÃ£o atualizada
                                if (res.id === reservaAtualizada.id || res.numero === reservaAtualizada.numero) {
                                    reservasDaFatura.push(reservaAtualizada);
                                } else {
                                    reservasDaFatura.push(res);
                                }
                            }
                        }
                    });
                }
                
                // Se nÃ£o encontrou por linhas, usar reservasIds se existir
                if (reservasDaFatura.length === 0 && fatura.reservasIds) {
                    fatura.reservasIds.forEach(id => {
                        let res = reservas.find(r => r.id === id);
                        if (res) {
                            if (res.id === reservaAtualizada.id) {
                                reservasDaFatura.push(reservaAtualizada);
                            } else {
                                reservasDaFatura.push(res);
                            }
                        }
                    });
                }
                
                // Se ainda nÃ£o encontrou, assumir que Ã© sÃ³ esta reserva
                if (reservasDaFatura.length === 0) {
                    reservasDaFatura.push(reservaAtualizada);
                }
                
                // Verificar quantas tÃªm CMR de Descarga
                const totalReservas = reservasDaFatura.length;
                const reservasComCMR = reservasDaFatura.filter(r => 
                    r.cmrDescargaAnexado === true || 
                    (r.cmrDescarga && r.cmrDescarga.includes('.')) ||
                    (r.cmr_descarga && r.cmr_descarga.includes('.'))
                );
                
                console.log(`ğŸ“Š Fatura ${fatura.numero}: ${reservasComCMR.length}/${totalReservas} reservas com CMR Descarga`);
                
                if (reservasComCMR.length === totalReservas) {
                    // TODAS as reservas tÃªm CMR â†’ ENVIAR EMAILS
                    console.log('âœ… TODAS as reservas tÃªm CMR - enviando emails...');
                    enviarEmailsFaturaCompleta(fatura, reservaAtualizada, cliente);
                    
                    mostrarNotificacaoC52('success', 
                        `âœ… CMR Descarga recebido!\n\n` +
                        `Todas as ${totalReservas} reserva(s) da fatura ${fatura.numero} tÃªm CMR.\n` +
                        `ğŸ“§ Emails enviados automaticamente!`,
                        5000
                    );
                } else {
                    // Faltam CMRs
                    const faltam = totalReservas - reservasComCMR.length;
                    mostrarNotificacaoC52('info', 
                        `ğŸ“‹ CMR Descarga recebido e guardado.\n\n` +
                        `Fatura ${fatura.numero}: ${reservasComCMR.length}/${totalReservas} CMRs recebidos.\n` +
                        `â³ Aguardando mais ${faltam} CMR(s) para enviar email.`,
                        5000
                    );
                }
            }
            
        } else if (estaFaturada && !fatura) {
            // Faturada mas nÃ£o encontrou a fatura (erro de dados)
            mostrarNotificacaoC52('warning', 
                `âš ï¸ CMR Descarga recebido.\n\nA reserva estÃ¡ marcada como faturada mas a fatura nÃ£o foi encontrada.\nVerifique no Controlo de FaturaÃ§Ã£o.`,
                5000
            );
            
        } else {
            // NÃƒO estÃ¡ faturada - guardar CMR e esperar pela fatura
            reservaAtualizada.prontaParaFaturacao = true;
            reservaAtualizada.aguardandoEnvioEmail = true; // Flag para enviar quando faturar
            
            mostrarNotificacaoC52('info', 
                `ğŸ“‹ CMR Descarga recebido e guardado.\n\n` +
                `A reserva ainda nÃ£o estÃ¡ faturada.\n` +
                `Quando for faturada, o sistema verificarÃ¡ se todos os CMRs estÃ£o presentes.`,
                5000
            );
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // GUARDAR RESERVA - APENAS ESTA RESERVA ESPECÃFICA
        // CORREÃ‡ÃƒO v6.23: Usar ID e nÃºmero exactos para nÃ£o afetar outras reservas
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        const reservaIdExacto = reservaAtualizada.id;
        const reservaNumeroExacto = reservaAtualizada.numero;
        
        // 1. Atualizar no array global 'reservas' (mÃ³dulo faturaÃ§Ã£o)
        if (typeof reservas !== 'undefined') {
            const idx = reservas.findIndex(r => r.id === reservaIdExacto && r.numero === reservaNumeroExacto);
            if (idx !== -1) {
                // Atualizar APENAS os campos de CMR, nÃ£o substituir toda a reserva
                reservas[idx].cmrDescarga = reservaAtualizada.cmrDescarga;
                reservas[idx].cmr_descarga = reservaAtualizada.cmr_descarga;
                reservas[idx].cmrDescargaAnexado = reservaAtualizada.cmrDescargaAnexado;
                reservas[idx].cmrDescargaData = reservaAtualizada.cmrDescargaData;
                reservas[idx].cmrDescargaFile = reservaAtualizada.cmrDescargaFile;
                reservas[idx].cmrCompleto = reservaAtualizada.cmrCompleto;
                if (reservaAtualizada.prontaParaFaturacao) reservas[idx].prontaParaFaturacao = true;
                if (reservaAtualizada.aguardandoEnvioEmail) reservas[idx].aguardandoEnvioEmail = true;
                console.log('âœ… Reserva atualizada em reservas[' + idx + '] - ID:', reservaIdExacto);
            }
        }
        
        // 2. Atualizar no array 'todasReservas' (mÃ³dulo reservas)
        if (typeof todasReservas !== 'undefined') {
            const idxTodas = todasReservas.findIndex(r => r.id === reservaIdExacto && r.numero === reservaNumeroExacto);
            if (idxTodas !== -1) {
                todasReservas[idxTodas].cmrDescarga = reservaAtualizada.cmrDescarga;
                todasReservas[idxTodas].cmr_descarga = reservaAtualizada.cmr_descarga;
                todasReservas[idxTodas].cmrDescargaAnexado = reservaAtualizada.cmrDescargaAnexado;
                todasReservas[idxTodas].cmrDescargaData = reservaAtualizada.cmrDescargaData;
                todasReservas[idxTodas].cmrDescargaFile = reservaAtualizada.cmrDescargaFile;
                todasReservas[idxTodas].cmrCompleto = reservaAtualizada.cmrCompleto;
                if (reservaAtualizada.prontaParaFaturacao) todasReservas[idxTodas].prontaParaFaturacao = true;
                if (reservaAtualizada.aguardandoEnvioEmail) todasReservas[idxTodas].aguardandoEnvioEmail = true;
                console.log('âœ… Reserva atualizada em todasReservas[' + idxTodas + '] - ID:', reservaIdExacto);
            }
            guardarReservasLS();
        }
        
        // 3. Guardar faturas (sem tocar nas reservas)
        if (typeof faturas !== 'undefined') {
            localStorage.setItem('erpFaturas', JSON.stringify(faturas));
        }
        
        // 4. Guardar no localStorage - erpReservas (APENAS esta reserva)
        try {
            let reservasLS = JSON.parse(localStorage.getItem('erpReservas') || '[]');
            const idxLS = reservasLS.findIndex(r => r.id === reservaIdExacto && r.numero === reservaNumeroExacto);
            if (idxLS !== -1) {
                reservasLS[idxLS].cmrDescarga = reservaAtualizada.cmrDescarga;
                reservasLS[idxLS].cmr_descarga = reservaAtualizada.cmr_descarga;
                reservasLS[idxLS].cmrDescargaAnexado = reservaAtualizada.cmrDescargaAnexado;
                reservasLS[idxLS].cmrDescargaData = reservaAtualizada.cmrDescargaData;
                reservasLS[idxLS].cmrCompleto = reservaAtualizada.cmrCompleto;
                if (reservaAtualizada.prontaParaFaturacao) reservasLS[idxLS].prontaParaFaturacao = true;
                if (reservaAtualizada.aguardandoEnvioEmail) reservasLS[idxLS].aguardandoEnvioEmail = true;
                localStorage.setItem('erpReservas', JSON.stringify(reservasLS));
                console.log('âœ… Reserva atualizada em erpReservas[' + idxLS + '] - ID:', reservaIdExacto);
            }
        } catch (e) {
            console.warn('Erro ao atualizar erpReservas:', e);
        }
        
        // Atualizar interface se PrÃ©-FaturaÃ§Ã£o estiver aberta
        if (document.getElementById('page-prefaturacao') && 
            !document.getElementById('page-prefaturacao').classList.contains('hidden')) {
            renderizarPreFaturacao();
        }
        
        // Atualizar Controlo de FaturaÃ§Ã£o se estiver aberto
        if (document.getElementById('page-controlofaturacao') && 
            !document.getElementById('page-controlofaturacao').classList.contains('hidden')) {
            renderizarControloFaturacao();
        }
        
        console.log('âœ… CMR Descarga processado - Reserva:', reservaNumeroExacto, '| ID:', reservaIdExacto);
    }
    
    /**
     * Envia emails de fatura completa (Fatura + CMR)
     * Chamada quando: FATURA + CMR DESCARGA estÃ£o ambos presentes
     * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     * REGRA DE EMAILS:
     * - C41 + C44 (Contabilidade + Financeiro) â†’ Fatura + CMR(s) num sÃ³ ficheiro
     * - C47 (LogÃ­stica) â†’ sÃ³ CMR
     * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     */
    function enviarEmailsFaturaCompleta(fatura, reserva, cliente) {
        console.log('ğŸ“§ enviarEmailsFaturaCompleta - Fatura:', fatura.numero);
        
        // Obter emails do cliente
        const emailContabilidade = cliente.resp_contabilidade_email || cliente.respContabilidadeEmail || 
                                   (cliente.emailsContabilidade ? cliente.emailsContabilidade[0] : null);
        const emailFinanceiro = cliente.resp_financeiro_email || cliente.respFinanceiroEmail ||
                               (cliente.emailsFinanceiro ? cliente.emailsFinanceiro[0] : null);
        const emailLogistica = cliente.resp_logistica_email || cliente.respLogisticaEmail ||
                              (cliente.emailsLogistica ? cliente.emailsLogistica[0] : null);
        
        // EMAIL 1: Fatura + CMR para Contabilidade e Financeiro (C41 + C44)
        const emailsContabFinanc = [emailContabilidade, emailFinanceiro].filter(e => e && e.trim() !== '');
        
        if (emailsContabFinanc.length > 0) {
            enviarEmailC52(emailsContabFinanc, 'FATURA_CMR', fatura, reserva, cliente);
            console.log('ğŸ“§ Email FATURA+CMR enviado para:', emailsContabFinanc.join(', '));
        }
        
        // EMAIL 2: SÃ³ CMR para LogÃ­stica (C47)
        if (emailLogistica && emailLogistica.trim() !== '') {
            enviarEmailC52([emailLogistica], 'CMR', null, reserva, cliente);
            console.log('ğŸ“§ Email CMR enviado para:', emailLogistica);
        }
        
        // Atualizar estados
        const dataEnvio = new Date().toISOString();
        fatura.estado = 'Enviada';
        fatura.dataEnvio = dataEnvio;
        fatura.emailEnviado = true;
        reserva.emailEnviado = true;
        reserva.dataEnvioEmail = dataEnvio;
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // CORREÃ‡ÃƒO v6.34: Atualizar emailEnviado em TODAS as fontes de dados
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        const reservaNumero = reserva.numero;
        const reservaId = reserva.id;
        
        // 1. Atualizar em erpReservasExecutadas
        try {
            let reservasExec = JSON.parse(localStorage.getItem('erpReservasExecutadas') || '[]');
            const idxExec = reservasExec.findIndex(r => r.id === reservaId || r.numero === reservaNumero);
            if (idxExec !== -1) {
                reservasExec[idxExec].emailEnviado = true;
                reservasExec[idxExec].dataEnvioEmail = dataEnvio;
                reservasExec[idxExec].cmrDescargaAnexado = true;
                localStorage.setItem('erpReservasExecutadas', JSON.stringify(reservasExec));
                console.log('âœ… emailEnviado atualizado em erpReservasExecutadas[' + idxExec + ']');
            }
        } catch (e) {
            console.warn('Erro ao atualizar erpReservasExecutadas:', e);
        }
        
        // 2. Atualizar em erpReservas
        try {
            let reservasLS = JSON.parse(localStorage.getItem('erpReservas') || '[]');
            const idxLS = reservasLS.findIndex(r => r.id === reservaId || r.numero === reservaNumero);
            if (idxLS !== -1) {
                reservasLS[idxLS].emailEnviado = true;
                reservasLS[idxLS].dataEnvioEmail = dataEnvio;
                localStorage.setItem('erpReservas', JSON.stringify(reservasLS));
                console.log('âœ… emailEnviado atualizado em erpReservas[' + idxLS + ']');
            }
        } catch (e) {
            console.warn('Erro ao atualizar erpReservas:', e);
        }
        
        // 3. Atualizar em todasReservas (memÃ³ria)
        if (typeof todasReservas !== 'undefined') {
            const idxTodas = todasReservas.findIndex(r => r.id === reservaId || r.numero === reservaNumero);
            if (idxTodas !== -1) {
                todasReservas[idxTodas].emailEnviado = true;
                todasReservas[idxTodas].dataEnvioEmail = dataEnvio;
            }
        }
        
        // 4. Atualizar em reservas (memÃ³ria)
        if (typeof reservas !== 'undefined') {
            const idxRes = reservas.findIndex(r => r.id === reservaId || r.numero === reservaNumero);
            if (idxRes !== -1) {
                reservas[idxRes].emailEnviado = true;
                reservas[idxRes].dataEnvioEmail = dataEnvio;
            }
        }
        
        // Mostrar notificaÃ§Ã£o
        mostrarNotificacaoC52('success', 
            `âœ… EMAILS ENVIADOS AUTOMATICAMENTE!\n\n` +
            `ğŸ“„ Fatura: ${fatura.numero}\n` +
            `ğŸ“§ Contab./Financ. (C41+C44): ${emailsContabFinanc.length > 0 ? emailsContabFinanc.join(', ') : 'nÃ£o configurado'}\n` +
            `ğŸ“§ LogÃ­stica (C47): ${emailLogistica || 'nÃ£o configurado'}\n\n` +
            `Anexos: Fatura + CMR(s) num sÃ³ ficheiro`,
            8000
        );
        
        // Guardar alteraÃ§Ãµes nas faturas
        guardarDados();
        
        // CORREÃ‡ÃƒO v6.34: Atualizar tabela de Controlo de FaturaÃ§Ã£o se estiver visÃ­vel
        setTimeout(() => {
            if (typeof renderizarControloFaturacao === 'function') {
                renderizarControloFaturacao();
                console.log('ğŸ”„ Tabela de Controlo de FaturaÃ§Ã£o atualizada');
            }
        }, 500);
    }
    
    /**
     * Gera o prÃ³ximo nÃºmero de documento baseado na sÃ©rie
     */
    function gerarNumeroDocumento(tipoSerie) {
        // Encontrar a sÃ©rie correspondente
        const serie = series.find(s => s.serie === tipoSerie || s.prefixo === tipoSerie);
        
        if (!serie) {
            console.error('SÃ©rie nÃ£o encontrada:', tipoSerie);
            // Gerar nÃºmero baseado no timestamp como fallback
            return `${tipoSerie} ${new Date().getFullYear()}/${Date.now() % 10000}`;
        }
        
        const numero = `${tipoSerie} ${serie.ano}/${serie.proxNum}`;
        serie.proxNum++;
        
        // Guardar a atualizaÃ§Ã£o da sÃ©rie
        guardarDados();
        
        console.log(`ğŸ“‹ NÃºmero de documento gerado: ${numero}`);
        return numero;
    }
    
    /**
     * Cria uma fatura automaticamente (Modo C52 AutomÃ¡tico)
     * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     * CORREÃ‡ÃƒO v6.15: Obter TODOS os dados do formulÃ¡rio e do cliente
     * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     */
    function criarFaturaAutomaticaC52(reserva, cliente) {
        const novoId = faturas.length > 0 ? Math.max(...faturas.map(f => f.id || 0)) + 1 : 1;
        const numeroFatura = gerarNumeroDocumento('FT');
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // OBTER DADOS DO CLIENTE - do formulÃ¡rio e do objeto cliente
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        // NÃºmero do cliente
        const clienteNumero = document.getElementById('cliente_numero')?.value || 
                             cliente?.numero || 
                             reserva.clienteNumero || 
                             '';
        
        // Nome do cliente
        const clienteNome = document.getElementById('nome_cliente')?.value || 
                           cliente?.nome_completo || 
                           cliente?.nome || 
                           reserva.cliente || 
                           'Cliente nÃ£o identificado';
        
        // NIF/Contribuinte
        const clienteNIF = document.getElementById('cliente_nif')?.value || 
                          cliente?.contribuinte || 
                          cliente?.nif || 
                          reserva.clienteNIF || 
                          '';
        
        // Morada completa
        let clienteMorada = '';
        const moradaRua = document.getElementById('cliente_rua')?.value || cliente?.sede_rua || '';
        const moradaNr = document.getElementById('cliente_nr')?.value || cliente?.sede_porta || '';
        const moradaCP = document.getElementById('cliente_cp')?.value || cliente?.sede_cp || '';
        const moradaCidade = document.getElementById('cliente_cidade')?.value || cliente?.sede_cidade || '';
        const moradaPais = document.getElementById('cliente_pais')?.value || cliente?.pais || 'Portugal';
        
        if (moradaRua) {
            clienteMorada = [
                moradaRua + (moradaNr ? ' nÂº ' + moradaNr : ''),
                moradaCP,
                moradaCidade,
                moradaPais
            ].filter(p => p && p.trim() !== '').join(', ');
        }
        
        // Prazo de pagamento e data de vencimento
        const prazoPagamento = cliente?.prazo_pagamento_dias || 30;
        const dataVencimento = new Date();
        dataVencimento.setDate(dataVencimento.getDate() + prazoPagamento);
        const dataVencimentoStr = dataVencimento.toISOString().split('T')[0];
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // OBTER DADOS DA RESERVA - locais de carga/descarga, ref cliente, etc
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        // Local de carga
        const localCarga = document.getElementById('carga_cidade')?.value || 
                          reserva.cargaCidade || 
                          reserva.localCarga || 
                          '';
        
        // Local de descarga
        const localDescarga = document.getElementById('descarga_cidade')?.value || 
                             reserva.descargaCidade || 
                             reserva.localDescarga || 
                             '';
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // CORREÃ‡ÃƒO v6.34: CALCULAR IVA BASEADO NOS LOCAIS DE CARGA E DESCARGA
        // Usar obterRegraIVA() que considera PTâ†’PT (23%) vs PTâ†’EUR (0%)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const tipoCliente = cliente?.tipoCliente || cliente?.tipo_pais || '21111'; // Default: cliente portuguÃªs
        const tipoClienteIVA = tipoCliente === 'nacional' ? '21111' : (tipoCliente === 'europeu' ? '21112' : '21111');
        const tipoMercadoria = reserva.tipoMercadoria || 'Normal';
        
        // Usar a funÃ§Ã£o correta para obter a regra de IVA
        const regraIVA = obterRegraIVA(tipoClienteIVA, tipoMercadoria, localCarga, localDescarga);
        const taxaIVA = regraIVA ? regraIVA.taxa * 100 : 23; // Taxa em percentagem
        const artigoIsencao = regraIVA?.artigo || '';
        const motivoIsencao = regraIVA?.motivo || '';
        
        console.log(`ğŸ“Š IVA CALCULADO: ${localCarga} â†’ ${localDescarga} = ${taxaIVA}%`);
        console.log(`   Artigo: ${artigoIsencao}`);
        
        // ReferÃªncia do cliente
        const refCliente = document.getElementById('ref_cliente')?.value || 
                          reserva.refCliente || 
                          '';
        
        // LDM
        const ldm = document.getElementById('ldm')?.value || reserva.ldm || '';
        
        // NÃºmero de bultos
        const numBultos = document.getElementById('num_bultos')?.value || reserva.numBultos || '';
        
        // Peso
        const peso = parseFloat(document.getElementById('peso')?.value) || 
                    parseFloat(reserva.peso) || 
                    parseFloat(reserva.pesoCarga) || 
                    0;
        
        // PreÃ§o por tonelada
        const precoTon = parseFloat(document.getElementById('preco_ton')?.value) || 
                        parseFloat(reserva.precoTon) || 
                        0;
        
        // DescriÃ§Ã£o da carga
        const descricaoCarga = document.getElementById('descricao_carga')?.value || 
                              reserva.descricaoCarga || 
                              reserva.descricao_carga || 
                              'Transporte de mercadorias';
        
        // CMR (nome do ficheiro anexado - guardado para referÃªncia)
        const cmrCargaFicheiro = reserva.cmrCarga || document.getElementById('ref_carga')?.value || '';
        
        // NÃºmero da reserva (para mostrar na linha da fatura)
        const numeroReservaLinha = reserva.numero || document.getElementById('numero_reserva')?.value || `RES-${reserva.id}`;
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // CALCULAR VALOR - vÃ¡rias fontes possÃ­veis
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        let valorBase = 0;
        
        // 1. Campo preÃ§o do formulÃ¡rio
        const precoFormulario = parseFloat(document.getElementById('preco')?.value) || 0;
        if (precoFormulario > 0) {
            valorBase = precoFormulario;
            console.log('ğŸ’° PreÃ§o obtido do formulÃ¡rio:', valorBase);
        }
        // 2. Reserva.preco
        else if (reserva.preco && parseFloat(reserva.preco) > 0) {
            valorBase = parseFloat(reserva.preco);
            console.log('ğŸ’° PreÃ§o obtido da reserva.preco:', valorBase);
        }
        // 3. Reserva.valorFixo (CORREÃ‡ÃƒO v6.34)
        else if (reserva.valorFixo && parseFloat(reserva.valorFixo) > 0) {
            valorBase = parseFloat(reserva.valorFixo);
            console.log('ğŸ’° PreÃ§o obtido da reserva.valorFixo:', valorBase);
        }
        // 4. Calcular peso Ã— preÃ§o/ton
        else if (peso > 0 && precoTon > 0) {
            valorBase = (peso / 1000) * precoTon;
            console.log('ğŸ’° PreÃ§o calculado (peso x â‚¬/ton):', valorBase);
        }
        // 5. Outros campos da reserva
        else if (reserva.valor || reserva.total) {
            valorBase = parseFloat(reserva.valor || reserva.total) || 0;
            console.log('ğŸ’° PreÃ§o obtido de reserva.valor/total:', valorBase);
        }
        
        const valorIVA = valorBase * (taxaIVA / 100);
        const valorTotal = valorBase + valorIVA;
        
        console.log('ğŸ“„ Criando fatura automÃ¡tica:');
        console.log('   Cliente:', clienteNumero, '-', clienteNome);
        console.log('   NIF:', clienteNIF);
        console.log('   Valor:', valorBase, '+ IVA', taxaIVA + '%', '=', valorTotal);
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // CRIAR OBJETO DA FATURA - formato compatÃ­vel com gerarPreviewFatura()
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const novaFatura = {
            id: novoId,
            numero: numeroFatura,
            data: new Date().toISOString().split('T')[0],
            vencimento: dataVencimentoStr,
            dataVencimento: dataVencimentoStr,
            
            // Dados do cliente
            clienteId: cliente?.id || clienteNumero,
            cliente: clienteNome,
            clienteNome: clienteNome,
            nif: clienteNIF,
            clienteNIF: clienteNIF,
            morada: clienteMorada,
            clienteMorada: clienteMorada,
            tipoCliente: tipoClienteIVA,
            taxaIVA: taxaIVA,
            
            // Dados da reserva
            reservaId: reserva.id,
            reservaNumero: reserva.numero || `RES-${reserva.id}`,
            
            // Linhas da fatura (formato compatÃ­vel com layout A4)
            linhas: [{
                cmr: numeroReservaLinha,
                reservaNum: numeroReservaLinha,
                localCarga: localCarga,
                localDescarga: localDescarga,
                refCliente: refCliente,
                ldm: ldm,
                numBultos: numBultos,
                peso: peso,
                precoTon: precoTon,
                descricao: descricaoCarga,
                quantidade: 1,
                unidade: 'UN',
                precoUnitario: valorBase,
                valor: valorBase,
                taxaIVA: taxaIVA,
                valorIVA: valorIVA,
                total: valorTotal
            }],
            
            // Totais
            subtotal: valorBase,
            iva23: taxaIVA === 23 ? valorIVA : 0,
            iva6: taxaIVA === 6 ? valorIVA : 0,
            iva0: taxaIVA === 0 ? valorBase : 0,
            totalIVA: valorIVA,
            total: valorTotal,
            
            // Estado e metadados
            pago: 0,
            estado: 'Pendente',
            origem: 'C52_AUTOMATICA',
            cmrCarga: cmrCargaFicheiro,
            cmrDescarga: reserva.cmrDescarga || null,
            emailEnviado: false,
            dataCriacao: new Date().toISOString(),
            
            // Artigo de isenÃ§Ã£o se aplicÃ¡vel - usar valores da regra de IVA
            artigoIsencao: artigoIsencao || (taxaIVA === 0 ? 'Art. 14Âº RITI' : ''),
            motivoIsencao: motivoIsencao || (taxaIVA === 0 ? 'Isento - Transporte IntracomunitÃ¡rio' : '')
        };
        
        faturas.push(novaFatura);
        guardarDados();
        
        console.log('ğŸ“„ Fatura C52 criada com sucesso:', novaFatura);
        
        return novaFatura;
    }
    
    /**
     * Simula o envio de email (em produÃ§Ã£o, chamaria API real)
     */
    function enviarEmailC52(destinatarios, tipo, fatura, reserva, cliente) {
        const tipoTexto = tipo === 'FATURA_CMR' ? 'Fatura + CMR' : 'CMR Descarga';
        
        console.log(`ğŸ“§ Email C52 enviado:`);
        console.log(`   Tipo: ${tipoTexto}`);
        console.log(`   DestinatÃ¡rios: ${destinatarios.join(', ')}`);
        console.log(`   Cliente: ${cliente.nome_completo || cliente.nome}`);
        if (fatura) console.log(`   Fatura: ${fatura.numero}`);
        console.log(`   CMR: ${reserva.cmrDescarga}`);
        
        // Em produÃ§Ã£o, aqui seria feita a chamada Ã  API de email
        // Exemplo: fetch('/api/email/enviar', { ... })
        
        // Por agora, simular com um log visual
        const logEmail = {
            data: new Date().toISOString(),
            tipo: tipo,
            destinatarios: destinatarios,
            cliente: cliente.nome_completo || cliente.nome,
            fatura: fatura?.numero || null,
            cmr: reserva.cmrDescarga,
            estado: 'ENVIADO_SIMULADO'
        };
        
        // Guardar log (em produÃ§Ã£o, guardaria na BD)
        if (!window.logsEmailC52) window.logsEmailC52 = [];
        window.logsEmailC52.push(logEmail);
        
        return true;
    }
    
    /**
     * ObtÃ©m o ID da reserva atualmente em ediÃ§Ã£o
     */
    function obterReservaAtualId() {
        // Tentar obter do campo hidden ou da variÃ¡vel global
        const campoId = document.getElementById('reserva_id');
        if (campoId && campoId.value) {
            return parseInt(campoId.value);
        }
        
        // Tentar obter do nÃºmero da reserva
        const campoNumero = document.getElementById('numero_reserva');
        if (campoNumero && campoNumero.value) {
            const res = reservas.find(r => r.numero === campoNumero.value);
            if (res) return res.id;
        }
        
        // Usar variÃ¡vel global se existir
        if (reservaEmEdicao) {
            return reservaEmEdicao.id;
        }
        
        // Gerar ID temporÃ¡rio para novas reservas
        return Date.now();
    }
    
    /**
     * ObtÃ©m cliente por ID
     */
    function obterClientePorId(clienteId) {
        if (!clienteId) return null;
        
        // Procurar no array de clientes
        let cliente = clientes.find(c => c.id === clienteId || c.numero === clienteId);
        
        // Procurar tambÃ©m no clientesLista (mÃ³dulo clientes)
        if (!cliente && typeof clientesLista !== 'undefined') {
            cliente = clientesLista.find(c => c.id === clienteId || c.numero === clienteId);
        }
        
        return cliente;
    }
    
    /**
     * Determina a taxa de IVA baseado no tipo de cliente
     */
    function determinarTaxaIVA(cliente) {
        if (!cliente) return 23; // IVA padrÃ£o PT
        
        const tipoPais = cliente.tipo_pais || cliente.tipoPais || 'nacional';
        
        switch (tipoPais.toLowerCase()) {
            case 'nacional':
                return 23;
            case 'europeu':
            case 'intracomunitario':
                return 0; // Reverse charge
            case 'extracomunitario':
            case 'internacional':
                return 0; // Isento
            default:
                return 23;
        }
    }
    
    /**
     * Calcula a data de vencimento baseado no prazo do cliente
     */
    function calcularDataVencimento(cliente) {
        const prazo = cliente?.prazo_pagamento_dias || 30;
        const data = new Date();
        data.setDate(data.getDate() + prazo);
        return data.toISOString().split('T')[0];
    }
    
    /**
     * Formata a morada completa do cliente
     */
    function formatarMoradaCliente(cliente) {
        if (!cliente) return '';
        
        const partes = [
            cliente.sede_rua || cliente.morada,
            cliente.sede_porta ? `nÂº ${cliente.sede_porta}` : '',
            cliente.sede_cp || cliente.cp,
            cliente.sede_cidade || cliente.cidade,
            cliente.pais
        ].filter(p => p && p.trim() !== '');
        
        return partes.join(', ');
    }
    
    /**
     * Mostra notificaÃ§Ã£o toast para o Trigger C52
     */
    function mostrarNotificacaoC52(tipo, mensagem, duracao = 4000) {
        // Criar container se nÃ£o existir
        let container = document.getElementById('notificacoes-c52');
        if (!container) {
            container = document.createElement('div');
            container.id = 'notificacoes-c52';
            container.style.cssText = 'position: fixed; top: 80px; right: 20px; z-index: 99999; display: flex; flex-direction: column; gap: 10px;';
            document.body.appendChild(container);
        }
        
        // Criar notificaÃ§Ã£o
        const notif = document.createElement('div');
        notif.style.cssText = `
            padding: 16px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            max-width: 400px;
            font-size: 14px;
            line-height: 1.4;
            animation: slideInC52 0.3s ease;
            white-space: pre-line;
        `;
        
        switch (tipo) {
            case 'success':
                notif.style.background = 'linear-gradient(135deg, #10b981, #059669)';
                notif.style.color = 'white';
                break;
            case 'warning':
                notif.style.background = 'linear-gradient(135deg, #f59e0b, #d97706)';
                notif.style.color = 'white';
                break;
            case 'error':
                notif.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
                notif.style.color = 'white';
                break;
            default: // info
                notif.style.background = 'linear-gradient(135deg, #3b82f6, #2563eb)';
                notif.style.color = 'white';
        }
        
        notif.innerHTML = mensagem;
        container.appendChild(notif);
        
        // Adicionar animaÃ§Ã£o CSS se nÃ£o existir
        if (!document.getElementById('css-animacoes-c52')) {
            const style = document.createElement('style');
            style.id = 'css-animacoes-c52';
            style.textContent = `
                @keyframes slideInC52 {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
                @keyframes slideOutC52 {
                    from { transform: translateX(0); opacity: 1; }
                    to { transform: translateX(100%); opacity: 0; }
                }
            `;
            document.head.appendChild(style);
        }
        
        // Remover apÃ³s duraÃ§Ã£o
        setTimeout(() => {
            notif.style.animation = 'slideOutC52 0.3s ease';
            setTimeout(() => notif.remove(), 300);
        }, duracao);
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // FIM DO TRIGGER C52
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    function abrirInc() { 
        const inp = document.getElementById('anexo_inc'); 
        if (inp.files.length > 0) window.open(URL.createObjectURL(inp.files[0]), '_blank'); 
        else alert('âš ï¸ Nenhum ficheiro anexado!'); 
    }
    
    /**
     * v6.32: Abre ficheiro - primeiro tenta Base64 do localStorage, depois o input
     */
    function abrirFicheiro(id) { 
        console.log('ğŸ“‚ v6.33 abrirFicheiro() - id:', id);
        
        // 1. Tentar abrir do localStorage (Base64)
        if (id === 'cmr_carga' || id === 'cmr_descarga') {
            const numeroReserva = document.getElementById('numero_reserva')?.value;
            if (numeroReserva) {
                const tipoCMR = id === 'cmr_carga' ? 'carga' : 'descarga';
                const chaveBase64 = `cmr_${numeroReserva}_${tipoCMR}`;
                
                console.log('ğŸ” A procurar Base64 em:', chaveBase64);
                
                try {
                    const dadosStr = localStorage.getItem(chaveBase64);
                    if (dadosStr) {
                        const dados = JSON.parse(dadosStr);
                        if (dados.base64) {
                            console.log('âœ… Ficheiro Base64 encontrado:', dados.nome);
                            
                            // v6.33: FAZER DOWNLOAD em vez de abrir no browser
                            // Criar link de download
                            const link = document.createElement('a');
                            link.href = dados.base64;
                            link.download = dados.nome || `CMR_${numeroReserva}_${tipoCMR}.pdf`;
                            link.style.display = 'none';
                            document.body.appendChild(link);
                            link.click();
                            document.body.removeChild(link);
                            
                            mostrarNotificacaoC52('success', `ğŸ“¥ A descarregar: ${dados.nome}`);
                            return;
                        }
                    }
                } catch (e) {
                    console.error('Erro ao ler Base64:', e);
                }
            }
        }
        
        // 2. Se nÃ£o encontrou Base64, tentar o input file
        const inp = document.getElementById(id); 
        if (inp && inp.files && inp.files.length > 0) {
            // Fazer download do ficheiro do input
            const ficheiro = inp.files[0];
            const link = document.createElement('a');
            link.href = URL.createObjectURL(ficheiro);
            link.download = ficheiro.name;
            link.style.display = 'none';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            mostrarNotificacaoC52('success', `ğŸ“¥ A descarregar: ${ficheiro.name}`);
        } else {
            // 3. Verificar se existe registo no localStorage (dados antigos sem Base64)
            const numeroReserva = document.getElementById('numero_reserva')?.value;
            if (numeroReserva && (id === 'cmr_carga' || id === 'cmr_descarga')) {
                alert('âš ï¸ Ficheiro nÃ£o disponÃ­vel!\n\nO registo existe mas o ficheiro nÃ£o foi guardado em Base64.\n\nPor favor, anexe o ficheiro novamente para guardÃ¡-lo permanentemente.');
            } else {
                alert('âš ï¸ Nenhum ficheiro anexado!');
            }
        }
    }
    
    /**
     * v6.32: Apaga um anexo - do input E do localStorage (Base64)
     */
    function apagarAnexo(id, nomeAnexo) {
        const inp = document.getElementById(id);
        const numeroReserva = document.getElementById('numero_reserva')?.value;
        
        // Verificar se existe ficheiro no input OU no localStorage
        let temFicheiroInput = inp && inp.files && inp.files.length > 0;
        let temBase64 = false;
        let nomeFicheiro = '';
        
        if (id === 'cmr_carga' || id === 'cmr_descarga') {
            const tipoCMR = id === 'cmr_carga' ? 'carga' : 'descarga';
            if (numeroReserva) {
                temBase64 = verificarBase64Existe(numeroReserva, tipoCMR);
                if (temBase64) {
                    const chaveBase64 = `cmr_${numeroReserva}_${tipoCMR}`;
                    try {
                        const dados = JSON.parse(localStorage.getItem(chaveBase64));
                        nomeFicheiro = dados?.nome || nomeAnexo;
                    } catch(e) {}
                }
            }
        }
        
        if (!temFicheiroInput && !temBase64) {
            alert('âš ï¸ NÃ£o existe ficheiro para apagar em: ' + nomeAnexo);
            return;
        }
        
        const nomeExibir = temFicheiroInput ? inp.files[0].name : nomeFicheiro;
        
        if (confirm('ğŸ—‘ï¸ Tem a certeza que deseja apagar o ficheiro?\n\n' + nomeAnexo + ': ' + nomeExibir)) {
            // 1. Limpar o input
            if (inp) inp.value = '';
            
            // 2. Apagar Base64 do localStorage
            if ((id === 'cmr_carga' || id === 'cmr_descarga') && numeroReserva) {
                const tipoCMR = id === 'cmr_carga' ? 'carga' : 'descarga';
                const chaveBase64 = `cmr_${numeroReserva}_${tipoCMR}`;
                localStorage.removeItem(chaveBase64);
                console.log('ğŸ—‘ï¸ Base64 apagado:', chaveBase64);
                
                // 3. Limpar metadados na reserva
                limparCMRReserva(numeroReserva, tipoCMR);
            }
            
            // 4. Limpar datas R42 e R61
            if (id === 'cmr_carga') {
                const campoR42 = document.getElementById('data_carga_ef');
                if (campoR42) {
                    campoR42.value = '';
                    console.log('ğŸ“… R42 (Data Efetiva Carga) limpo');
                }
            } else if (id === 'cmr_descarga') {
                const campoR61 = document.getElementById('data_descarga_ef');
                if (campoR61) {
                    campoR61.value = '';
                    console.log('ğŸ“… R61 (Data Efetiva Descarga) limpo');
                }
            }
            
            // 5. Remover badge visual
            const container = inp?.closest('div') || inp?.parentElement;
            if (container) {
                const badge = container.querySelector('.cmr-indicator-badge');
                if (badge) badge.remove();
            }
            
            alert('âœ… Ficheiro apagado permanentemente: ' + nomeAnexo);
            
            // Registar no histÃ³rico
            if (numReserva) {
                registarHistoricoReserva(numReserva, 'ALTERACAO', 
                    'Anexo apagado: ' + nomeAnexo, 
                    { [id]: { antes: nomeExibir, depois: 'removido' } }
                );
            }
        }
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // NOTA: Comerciais e Equipas sÃ£o carregados do localStorage (AdministraÃ§Ã£o)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    /**
     * Abre modal para selecionar Comercial (R14)
     */
    function abrirModalComerciais() {
        // Carregar comerciais do localStorage (dados do mÃ³dulo AdministraÃ§Ã£o)
        var comerciais = JSON.parse(localStorage.getItem('erpComerciais') || '[]');
        
        // Se nÃ£o houver comerciais no localStorage, usar lista de exemplo
        if (comerciais.length === 0) {
            comerciais = [
                { id: 1, nome: 'Carlos Silva', email: 'carlos.silva@emeutrans.pt', telefone: '912345678', estado: 'Ativo' },
                { id: 2, nome: 'Ana Santos', email: 'ana.santos@emeutrans.pt', telefone: '923456789', estado: 'Ativo' },
                { id: 3, nome: 'Pedro Costa', email: 'pedro.costa@emeutrans.pt', telefone: '934567890', estado: 'Ativo' },
                { id: 4, nome: 'Maria Ferreira', email: 'maria.ferreira@emeutrans.pt', telefone: '945678901', estado: 'Ativo' },
                { id: 5, nome: 'JoÃ£o Oliveira', email: 'joao.oliveira@emeutrans.pt', telefone: '956789012', estado: 'Ativo' }
            ];
            // Guardar no localStorage para uso futuro
            localStorage.setItem('erpComerciais', JSON.stringify(comerciais));
        }
        
        // Filtrar apenas comerciais ativos
        var comerciaisAtivos = comerciais.filter(function(c) { return c.estado !== 'Inativo'; });
        
        let html = `
            <div id="modalComerciaisOverlay" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:99999;display:flex;align-items:center;justify-content:center;" onclick="if(event.target===this)this.remove()">
                <div style="background:white;border-radius:12px;width:500px;max-height:80vh;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,0.3);">
                    <div style="background:linear-gradient(135deg,#ff6b35,#ff8c42);color:white;padding:20px;display:flex;justify-content:space-between;align-items:center;">
                        <h3 style="margin:0;font-size:18px;">ğŸ‘¤ Selecionar Comercial</h3>
                        <button onclick="this.closest('#modalComerciaisOverlay').remove()" style="background:rgba(255,255,255,0.2);border:none;color:white;width:32px;height:32px;border-radius:50%;cursor:pointer;font-size:18px;">Ã—</button>
                    </div>
                    <div style="padding:15px;max-height:50vh;overflow-y:auto;">
                        <input type="text" id="pesquisaComercial" placeholder="ğŸ” Pesquisar comercial..." 
                               style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;margin-bottom:15px;"
                               onkeyup="filtrarComerciais(this.value)">
                        <div id="listaComerciais">
        `;
        
        if (comerciaisAtivos.length === 0) {
            html += `<div style="padding:20px;text-align:center;color:#666;">
                <p>âš ï¸ Nenhum comercial encontrado.</p>
                <p style="font-size:12px;margin-top:10px;">Adicione comerciais em:<br><strong>AdministraÃ§Ã£o â†’ Comerciais</strong></p>
            </div>`;
        } else {
            comerciaisAtivos.forEach(c => {
                html += `
                    <div class="comercial-item" onclick="selecionarComercial('${c.nome}')" 
                         style="padding:12px;border:1px solid #e0e0e0;border-radius:8px;margin-bottom:8px;cursor:pointer;transition:all 0.2s;"
                         onmouseover="this.style.background='#fff3e0';this.style.borderColor='#ff6b35';"
                         onmouseout="this.style.background='white';this.style.borderColor='#e0e0e0';">
                        <div style="font-weight:600;color:#333;">${c.nome}</div>
                        <div style="font-size:12px;color:#666;">ğŸ“§ ${c.email || 'N/A'} | ğŸ“ ${c.telefone || 'N/A'}</div>
                    </div>
                `;
            });
        }
        
        html += `
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', html);
    }
    
    function filtrarComerciais(termo) {
        const items = document.querySelectorAll('.comercial-item');
        termo = termo.toLowerCase();
        items.forEach(item => {
            const texto = item.textContent.toLowerCase();
            item.style.display = texto.includes(termo) ? 'block' : 'none';
        });
    }
    
    function selecionarComercial(nome) {
        document.getElementById('comercial').value = nome;
        document.getElementById('modalComerciaisOverlay').remove();
    }
    
    /**
     * Abre modal para selecionar Equipa (R15)
     */
    function abrirModalEquipas() {
        // Carregar equipas do localStorage (dados do mÃ³dulo AdministraÃ§Ã£o)
        var equipas = JSON.parse(localStorage.getItem('erpEquipas') || '[]');
        
        // Se nÃ£o houver equipas no localStorage, usar lista de exemplo
        if (equipas.length === 0) {
            equipas = [
                { id: 1, nome: 'Equipa Norte', responsavel: 'Manuel Costa', zona: 'Porto, Braga, Viana', estado: 'Ativo' },
                { id: 2, nome: 'Equipa Centro', responsavel: 'AntÃ³nio Silva', zona: 'Lisboa, SantarÃ©m, Leiria', estado: 'Ativo' },
                { id: 3, nome: 'Equipa Sul', responsavel: 'JosÃ© Santos', zona: 'SetÃºbal, Ã‰vora, Faro', estado: 'Ativo' },
                { id: 4, nome: 'Equipa Internacional', responsavel: 'Rui Pereira', zona: 'Espanha, FranÃ§a, Alemanha', estado: 'Ativo' },
                { id: 5, nome: 'Equipa Especial', responsavel: 'Carlos Rodrigues', zona: 'Cargas especiais', estado: 'Ativo' }
            ];
            // Guardar no localStorage para uso futuro
            localStorage.setItem('erpEquipas', JSON.stringify(equipas));
        }
        
        // Filtrar apenas equipas ativas
        var equipasAtivas = equipas.filter(function(e) { return e.estado !== 'Inativo'; });
        
        let html = `
            <div id="modalEquipasOverlay" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:99999;display:flex;align-items:center;justify-content:center;" onclick="if(event.target===this)this.remove()">
                <div style="background:white;border-radius:12px;width:550px;max-height:80vh;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,0.3);">
                    <div style="background:linear-gradient(135deg,#3498db,#2980b9);color:white;padding:20px;display:flex;justify-content:space-between;align-items:center;">
                        <h3 style="margin:0;font-size:18px;">ğŸ‘¥ Selecionar Equipa</h3>
                        <button onclick="this.closest('#modalEquipasOverlay').remove()" style="background:rgba(255,255,255,0.2);border:none;color:white;width:32px;height:32px;border-radius:50%;cursor:pointer;font-size:18px;">Ã—</button>
                    </div>
                    <div style="padding:15px;max-height:50vh;overflow-y:auto;">
                        <input type="text" id="pesquisaEquipa" placeholder="ğŸ” Pesquisar equipa..." 
                               style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;margin-bottom:15px;"
                               onkeyup="filtrarEquipas(this.value)">
                        <div id="listaEquipasModal">
        `;
        
        if (equipasAtivas.length === 0) {
            html += `<div style="padding:20px;text-align:center;color:#666;">
                <p>âš ï¸ Nenhuma equipa encontrada.</p>
                <p style="font-size:12px;margin-top:10px;">Adicione equipas em:<br><strong>AdministraÃ§Ã£o â†’ Equipas</strong></p>
            </div>`;
        } else {
            equipasAtivas.forEach(e => {
                html += `
                    <div class="equipa-item" onclick="selecionarEquipa('${e.nome}')" 
                         style="padding:15px;border:1px solid #e0e0e0;border-radius:8px;margin-bottom:10px;cursor:pointer;transition:all 0.2s;"
                         onmouseover="this.style.background='#e3f2fd';this.style.borderColor='#3498db';"
                         onmouseout="this.style.background='white';this.style.borderColor='#e0e0e0';">
                        <div style="font-weight:600;color:#333;font-size:15px;">${e.nome}</div>
                        <div style="font-size:12px;color:#666;margin-top:4px;">ğŸ‘¤ ResponsÃ¡vel: ${e.responsavel || 'N/A'}</div>
                        <div style="font-size:12px;color:#888;">ğŸ“ Zona: ${e.zona || 'N/A'}</div>
                    </div>
                `;
            });
        }
        
        html += `
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', html);
    }
    
    function filtrarEquipas(termo) {
        const items = document.querySelectorAll('.equipa-item');
        termo = termo.toLowerCase();
        items.forEach(item => {
            const texto = item.textContent.toLowerCase();
            item.style.display = texto.includes(termo) ? 'block' : 'none';
        });
    }
    
    function selecionarEquipa(nome) {
        document.getElementById('equipa').value = nome;
        document.getElementById('modalEquipasOverlay').remove();
    }
    
    /**
     * Atualiza dinamicamente a obrigatoriedade dos campos R17, R19, R21
     * REGRAS:
     * - R18, R20, R22 sÃ£o SEMPRE obrigatÃ³rios (asterisco fixo no HTML)
     * - R17, R19, R21 sÃ£o obrigatÃ³rios EXCETO quando R23+R24+R25 estÃ£o todos preenchidos
     */
    function atualizarObrigatoriedadeCampos() {
        // Campos de detalhe (R16-R21)
        const r16 = document.getElementById('ldm').value.trim();
        const r17 = document.getElementById('num_bultos').value.trim();
        const r19 = document.getElementById('peso').value.trim();
        const r20 = document.getElementById('preco').value.trim();
        const r21 = document.getElementById('volumes').value.trim();
        
        // Campos de tonelagem (R23-R25)
        const r23 = document.getElementById('ton_carga').value.trim();
        const r24 = document.getElementById('ton_descarga').value.trim();
        const r25 = document.getElementById('preco_ton').value.trim();
        
        // Elementos dos campos
        const campoR16 = document.getElementById('ldm');
        const campoR17 = document.getElementById('num_bultos');
        const campoR19 = document.getElementById('peso');
        const campoR20 = document.getElementById('preco');
        const campoR21 = document.getElementById('volumes');
        const campoR23 = document.getElementById('ton_carga');
        const campoR24 = document.getElementById('ton_descarga');
        const campoR25 = document.getElementById('preco_ton');
        
        // Asteriscos de obrigatoriedade
        const astR17 = document.getElementById('astR17');
        const astR19 = document.getElementById('astR19');
        const astR21 = document.getElementById('astR21');
        
        // Verificar se campos de detalhe estÃ£o preenchidos (R16, R17, R19, R20, R21)
        const detalhesPreenchidos = r16 !== '' && r17 !== '' && r19 !== '' && r20 !== '' && r21 !== '';
        
        // Verificar se campos de tonelagem estÃ£o preenchidos (R23, R24, R25)
        const tonelagemPreenchida = r23 !== '' && r24 !== '' && r25 !== '';
        
        // Verificar se pelo menos um campo de tonelagem foi tocado
        const tonelagemTocada = r23 !== '' || r24 !== '' || r25 !== '';
        
        // Verificar se pelo menos um campo de detalhe foi tocado
        const detalhesTocados = r16 !== '' || r17 !== '' || r19 !== '' || r20 !== '' || r21 !== '';
        
        // REGRA 1: Se R23+R24+R25 estÃ£o TODOS preenchidos â†’ R16, R17, R19, R20, R21 deixam de ser obrigatÃ³rios
        if (tonelagemPreenchida) {
            // Remover asteriscos de obrigatoriedade
            if (astR17) astR17.style.display = 'none';
            if (astR19) astR19.style.display = 'none';
            if (astR21) astR21.style.display = 'none';
            
            // Desbloquear campos de detalhe (caso estivessem bloqueados)
            [campoR16, campoR17, campoR19, campoR20, campoR21].forEach(c => {
                if (c) {
                    c.disabled = false;
                    c.style.backgroundColor = '';
                    c.style.cursor = '';
                }
            });
            
            console.log('ğŸ“‹ Tonelagem preenchida (R23+R24+R25): R16, R17, R19, R20, R21 opcionais');
        }
        // REGRA 2: Se R16+R17+R19+R20+R21 estÃ£o preenchidos â†’ R23, R24, R25 ficam BLOQUEADOS (cinzentos)
        else if (detalhesPreenchidos) {
            // Bloquear campos de tonelagem
            [campoR23, campoR24, campoR25].forEach(c => {
                if (c) {
                    c.disabled = true;
                    c.style.backgroundColor = '#e9ecef';
                    c.style.cursor = 'not-allowed';
                }
            });
            
            // Manter asteriscos visÃ­veis nos campos obrigatÃ³rios
            if (astR17) astR17.style.display = 'inline';
            if (astR19) astR19.style.display = 'inline';
            if (astR21) astR21.style.display = 'inline';
            
            console.log('ğŸ“‹ Detalhes preenchidos (R16-R21): R23, R24, R25 bloqueados');
        }
        // REGRA 3: Se nenhum grupo estÃ¡ completo, desbloquear todos
        else {
            // Desbloquear campos de tonelagem
            [campoR23, campoR24, campoR25].forEach(c => {
                if (c) {
                    c.disabled = false;
                    c.style.backgroundColor = '';
                    c.style.cursor = '';
                }
            });
            
            // Desbloquear campos de detalhe
            [campoR16, campoR17, campoR19, campoR20, campoR21].forEach(c => {
                if (c) {
                    c.disabled = false;
                    c.style.backgroundColor = '';
                    c.style.cursor = '';
                }
            });
            
            // Manter asteriscos visÃ­veis (campos obrigatÃ³rios por defeito)
            if (astR17) astR17.style.display = 'inline';
            if (astR19) astR19.style.display = 'inline';
            if (astR21) astR21.style.display = 'inline';
        }
    }
    
    // Alias para compatibilidade
    function atualizarObrigatoriedadeR18R20() {
        atualizarObrigatoriedadeCampos();
    }
    
    /**
     * Valida campos obrigatÃ³rios da ficha de reserva
     * REGRAS:
     * - R18, R20, R22 sÃ£o SEMPRE obrigatÃ³rios
     * - R17, R19, R21 sÃ£o obrigatÃ³rios EXCETO quando R23+R24+R25 estÃ£o todos preenchidos
     */
    function validarCamposObrigatoriosCondicionais() {
        // Campos SEMPRE obrigatÃ³rios
        const r18 = document.getElementById('descricao_carga').value.trim();
        const r20 = document.getElementById('preco').value.trim();
        const r22 = document.getElementById('tipo_merc').value.trim();
        
        // Campos condicionalmente obrigatÃ³rios
        const r17 = document.getElementById('num_bultos').value.trim();
        const r19 = document.getElementById('peso').value.trim();
        const r21 = document.getElementById('volumes').value.trim();
        
        // Campos de tonelagem
        const r23 = document.getElementById('ton_carga').value.trim();
        const r24 = document.getElementById('ton_descarga').value.trim();
        const r25 = document.getElementById('preco_ton').value.trim();
        
        // Verificar campos SEMPRE obrigatÃ³rios (R18, R20, R22)
        let erros = [];
        if (r18 === '') erros.push('â€¢ R18 - DescriÃ§Ã£o da carga âŒ');
        if (r20 === '') erros.push('â€¢ R20 - PreÃ§o (â‚¬) âŒ');
        if (r22 === '') erros.push('â€¢ R22 - Tipo Mercadoria âŒ');
        
        // Verificar se tonelagem estÃ¡ completa
        const tonelagemCompleta = r23 !== '' && r24 !== '' && r25 !== '';
        
        // Se tonelagem NÃƒO estÃ¡ completa, R17, R19, R21 sÃ£o obrigatÃ³rios
        if (!tonelagemCompleta) {
            if (r17 === '') erros.push('â€¢ R17 - NÂº Bultos âŒ');
            if (r19 === '') erros.push('â€¢ R19 - Peso (kg) âŒ');
            if (r21 === '') erros.push('â€¢ R21 - NÂº Volumes âŒ');
        }
        
        if (erros.length > 0) {
            let mensagem = 'âš ï¸ Campos obrigatÃ³rios em falta!\n\n' + erros.join('\n');
            
            if (!tonelagemCompleta) {
                mensagem += '\n\nğŸ’¡ DICA: Se preencher todos os campos de tonelagem (R23, R24, R25),\nos campos R17, R19 e R21 tornam-se opcionais.';
            }
            
            return {
                valido: false,
                mensagem: mensagem
            };
        }
        
        console.log('âœ… ValidaÃ§Ã£o de campos obrigatÃ³rios: OK');
        return { valido: true };
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ECRÃƒ DE HISTÃ“RICO DE RESERVAS (Lista de reservas feitas)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    /**
     * Abre ecrÃ£ com lista de todas as reservas jÃ¡ criadas
     */
    function abrirListaReservas() {
        console.log('ğŸ“‹ abrirListaReservas() - InÃ­cio');
        
        // Carregar reservas do localStorage
        let reservasGuardadas = [];
        try {
            const dados = localStorage.getItem('erpReservasExecutadas');
            console.log('ğŸ“Š Dados no localStorage:', dados ? 'SIM' : 'NÃƒO');
            
            if (dados) {
                reservasGuardadas = JSON.parse(dados);
                console.log('âœ… Reservas carregadas:', reservasGuardadas.length);
                reservasGuardadas.forEach(r => {
                    console.log('   ğŸ“‹', r.numero, '-', r.cliente, '| Campos:', Object.keys(r).length);
                });
            }
        } catch(e) {
            console.error('âŒ Erro ao carregar reservas:', e);
        }
        
        let html = `
            <div id="modalListaReservasOverlay" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.6);z-index:99999;display:flex;align-items:center;justify-content:center;" onclick="if(event.target===this)this.remove()">
                <div style="background:white;border-radius:12px;width:95%;max-width:1200px;max-height:90vh;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,0.3);">
                    <div style="background:linear-gradient(135deg,#1e3c72,#2a5298);color:white;padding:20px;display:flex;justify-content:space-between;align-items:center;">
                        <h3 style="margin:0;font-size:20px;">ğŸ“‹ HistÃ³rico de Reservas (${reservasGuardadas.length} reservas)</h3>
                        <div>
                            <button onclick="exportarReservasCSV()" style="background:rgba(255,255,255,0.2);border:none;color:white;padding:8px 15px;border-radius:6px;cursor:pointer;margin-right:10px;">ğŸ“¥ Exportar CSV</button>
                            <button onclick="this.closest('#modalListaReservasOverlay').remove()" style="background:rgba(255,255,255,0.2);border:none;color:white;width:36px;height:36px;border-radius:50%;cursor:pointer;font-size:20px;">Ã—</button>
                        </div>
                    </div>
                    
                    <!-- Filtros -->
                    <div style="padding:15px;background:#f8f9fa;border-bottom:1px solid #dee2e6;display:flex;gap:15px;flex-wrap:wrap;align-items:center;">
                        <input type="text" id="filtroReservaPesquisa" placeholder="ğŸ” Pesquisar..." style="padding:8px 12px;border:1px solid #ddd;border-radius:6px;width:200px;" onkeyup="filtrarListaReservas()">
                        <select id="filtroReservaEstado" onchange="filtrarListaReservas()" style="padding:8px 12px;border:1px solid #ddd;border-radius:6px;">
                            <option value="">Todos os estados</option>
                            <option value="faturada">âœ… Faturadas</option>
                            <option value="pendente">â³ Pendentes</option>
                        </select>
                        <input type="date" id="filtroReservaDataDe" onchange="filtrarListaReservas()" style="padding:8px;border:1px solid #ddd;border-radius:6px;" title="Data de">
                        <input type="date" id="filtroReservaDataAte" onchange="filtrarListaReservas()" style="padding:8px;border:1px solid #ddd;border-radius:6px;" title="Data atÃ©">
                        <button onclick="limparFiltrosReservas()" style="padding:8px 15px;background:#6c757d;color:white;border:none;border-radius:6px;cursor:pointer;">ğŸ”„ Limpar</button>
                    </div>
                    
                    <div style="padding:20px;max-height:60vh;overflow-y:auto;">
                        <table id="tabelaReservas" style="width:100%;border-collapse:collapse;font-size:13px;">
                            <thead>
                                <tr style="background:#f1f5f9;">
                                    <th style="padding:12px;text-align:left;border-bottom:2px solid #dee2e6;">NÂº Reserva</th>
                                    <th style="padding:12px;text-align:left;border-bottom:2px solid #dee2e6;">Data</th>
                                    <th style="padding:12px;text-align:left;border-bottom:2px solid #dee2e6;">Cliente</th>
                                    <th style="padding:12px;text-align:left;border-bottom:2px solid #dee2e6;">Origem â†’ Destino</th>
                                    <th style="padding:12px;text-align:right;border-bottom:2px solid #dee2e6;">PreÃ§o</th>
                                    <th style="padding:12px;text-align:center;border-bottom:2px solid #dee2e6;">Estado</th>
                                    <th style="padding:12px;text-align:center;border-bottom:2px solid #dee2e6;">AÃ§Ãµes</th>
                                </tr>
                            </thead>
                            <tbody id="corpoTabelaReservas">
        `;
        
        if (reservasGuardadas.length === 0) {
            html += `<tr><td colspan="7" style="padding:40px;text-align:center;color:#666;">Nenhuma reserva encontrada.<br>As reservas criadas aparecerÃ£o aqui.</td></tr>`;
        } else {
            reservasGuardadas.forEach(r => {
                const estado = r.faturada 
                    ? '<span style="background:#d4edda;color:#155724;padding:4px 10px;border-radius:12px;font-size:11px;">âœ… Faturada</span>'
                    : '<span style="background:#fff3cd;color:#856404;padding:4px 10px;border-radius:12px;font-size:11px;">â³ Pendente</span>';
                
                const origem = r.cargaCidade || r.cargaLocal || '-';
                const destino = r.descargaCidade || r.descargaLocal || '-';
                const preco = r.preco ? 'â‚¬ ' + parseFloat(r.preco).toFixed(2) : '-';
                
                html += `
                    <tr class="linha-reserva" data-numero="${r.numero}" data-cliente="${r.cliente || ''}" data-estado="${r.faturada ? 'faturada' : 'pendente'}" data-data="${r.dataAbertura || ''}"
                        style="border-bottom:1px solid #eee;" onmouseover="this.style.background='#f8f9fa'" onmouseout="this.style.background='white'">
                        <td style="padding:12px;font-weight:600;color:#1e3c72;">${r.numero || '-'}</td>
                        <td style="padding:12px;">${r.dataAbertura || '-'}</td>
                        <td style="padding:12px;">${r.cliente || '-'}</td>
                        <td style="padding:12px;">${origem} â†’ ${destino}</td>
                        <td style="padding:12px;text-align:right;font-weight:600;">${preco}</td>
                        <td style="padding:12px;text-align:center;">${estado}</td>
                        <td style="padding:12px;text-align:center;">
                            <button onclick="verDetalheReserva('${r.numero}')" style="background:#3498db;color:white;border:none;padding:5px 10px;border-radius:4px;cursor:pointer;margin-right:5px;" title="Ver detalhes">ğŸ‘ï¸</button>
                            <button onclick="mostrarHistoricoReserva('${r.numero}')" style="background:#6f42c1;color:white;border:none;padding:5px 10px;border-radius:4px;cursor:pointer;" title="Ver histÃ³rico">ğŸ“œ</button>
                        </td>
                    </tr>
                `;
            });
        }
        
        html += `
                            </tbody>
                        </table>
                    </div>
                    
                    <div style="padding:15px;background:#f8f9fa;border-top:1px solid #dee2e6;text-align:right;">
                        <span id="contadorReservas" style="color:#666;font-size:13px;">Mostrando ${reservasGuardadas.length} reserva(s)</span>
                    </div>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', html);
    }
    
    function filtrarListaReservas() {
        const pesquisa = (document.getElementById('filtroReservaPesquisa').value || '').toLowerCase();
        const estado = document.getElementById('filtroReservaEstado').value;
        const dataDe = document.getElementById('filtroReservaDataDe').value;
        const dataAte = document.getElementById('filtroReservaDataAte').value;
        
        const linhas = document.querySelectorAll('.linha-reserva');
        let visiveis = 0;
        
        linhas.forEach(linha => {
            const numero = (linha.dataset.numero || '').toLowerCase();
            const cliente = (linha.dataset.cliente || '').toLowerCase();
            const estadoLinha = linha.dataset.estado || '';
            const dataLinha = linha.dataset.data || '';
            
            let mostrar = true;
            
            if (pesquisa && !numero.includes(pesquisa) && !cliente.includes(pesquisa)) mostrar = false;
            if (estado && estadoLinha !== estado) mostrar = false;
            if (dataDe && dataLinha < dataDe) mostrar = false;
            if (dataAte && dataLinha > dataAte) mostrar = false;
            
            linha.style.display = mostrar ? '' : 'none';
            if (mostrar) visiveis++;
        });
        
        document.getElementById('contadorReservas').textContent = `Mostrando ${visiveis} reserva(s)`;
    }
    
    function limparFiltrosReservas() {
        document.getElementById('filtroReservaPesquisa').value = '';
        document.getElementById('filtroReservaEstado').value = '';
        document.getElementById('filtroReservaDataDe').value = '';
        document.getElementById('filtroReservaDataAte').value = '';
        filtrarListaReservas();
    }
    
    function verDetalheReserva(numero) {
        console.log('ğŸ‘ï¸ verDetalheReserva() - InÃ­cio | Reserva:', numero);
        
        // Fechar modal de lista
        const modalLista = document.getElementById('modalListaReservasOverlay');
        if (modalLista) modalLista.remove();
        
        // Carregar reserva
        let reservasGuardadas = [];
        try {
            const dados = localStorage.getItem('erpReservasExecutadas');
            if (dados) reservasGuardadas = JSON.parse(dados);
            console.log('ğŸ“¦ Reservas no localStorage:', reservasGuardadas.length);
        } catch(e) {
            console.error('âŒ Erro ao carregar reservas:', e);
        }
        
        const reserva = reservasGuardadas.find(r => r.numero === numero);
        if (!reserva) {
            alert('âŒ Reserva nÃ£o encontrada: ' + numero);
            return;
        }
        
        console.log('ğŸ“‹ Reserva encontrada:', reserva.numero, '| Cliente:', reserva.cliente);
        console.log('ğŸ“Š Total de campos na reserva:', Object.keys(reserva).length);
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // VERIFICAR SE CLIENTE ESTÃ BLOQUEADO
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        if (reserva.cliente) {
            const verificacao = verificarClienteBloqueado(reserva.cliente);
            if (verificacao && verificacao.bloqueado) {
                const continuar = confirm(
                    'âš ï¸ ATENÃ‡ÃƒO: CLIENTE BLOQUEADO!\n\n' +
                    'ğŸ”’ Cliente: ' + reserva.cliente + '\n\n' +
                    'Motivo: ' + (verificacao.motivo || 'Verifique com o departamento financeiro') + '\n\n' +
                    'Deseja continuar a visualizar a reserva?\n\n' +
                    '(NÃ£o serÃ¡ possÃ­vel criar novas reservas para este cliente)'
                );
                
                if (!continuar) {
                    console.log('âŒ Utilizador cancelou - cliente bloqueado');
                    return;
                }
            }
        }
        
        // Navegar para o mÃ³dulo de reservas e preencher
        navegarPara('reservas');
        
        // Aguardar renderizaÃ§Ã£o e preencher campos
        setTimeout(() => {
            console.log('â³ A preencher formulÃ¡rio com os dados da reserva...');
            preencherReservaNoFormulario(reserva);
            console.log('âœ… verDetalheReserva() - Fim');
        }, 300);
    }
    
    function preencherReservaNoFormulario(reserva) {
        console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
        console.log('ğŸ“ preencherReservaNoFormulario() - INÃCIO');
        console.log('ğŸ“‹ Reserva:', reserva.numero);
        console.log('ğŸ“Š Campos disponÃ­veis:', Object.keys(reserva).length);
        console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // v6.30: LIMPAR CAMPOS DE FICHEIRO PRIMEIRO
        // CORREÃ‡ÃƒO: Os campos <input type="file"> mantinham ficheiros de outras reservas
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        limparCamposFicheiro();
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // PREENCHER TODOS OS CAMPOS DA RESERVA
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        // R1 - NÂº Reserva
        document.getElementById('numero_reserva').value = reserva.numero || '';
        
        // R2 - Data Abertura
        document.getElementById('data_abertura').value = reserva.dataAbertura || '';
        
        // F - NÂº Fatura
        document.getElementById('numero_fatura').value = reserva.faturaNumero || '-';
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // SECÃ‡ÃƒO 1 - DADOS DO CLIENTE
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        // R3 - Cliente (nome)
        document.getElementById('cliente').value = reserva.cliente || '';
        
        // Campos ocultos do cliente
        if (document.getElementById('cliente_numero')) {
            document.getElementById('cliente_numero').value = reserva.clienteNumero || '';
        }
        if (document.getElementById('cliente_nif')) {
            document.getElementById('cliente_nif').value = reserva.clienteNIF || '';
        }
        if (document.getElementById('cliente_modo_faturacao')) {
            document.getElementById('cliente_modo_faturacao').value = reserva.modoFaturacao || 'Manual';
        }
        
        // R5-R13 - Morada do cliente
        document.getElementById('cliente_rua').value = reserva.clienteRua || '';
        document.getElementById('cliente_nr').value = reserva.clienteNr || '';
        document.getElementById('cliente_local').value = reserva.clienteLocal || '';
        document.getElementById('cliente_cp').value = reserva.clienteCP || '';
        document.getElementById('cliente_cidade').value = reserva.clienteCidade || '';
        document.getElementById('cliente_concelho').value = reserva.clienteConcelho || '';
        document.getElementById('cliente_pais').value = reserva.clientePais || '';
        document.getElementById('cliente_tel').value = reserva.clienteTel || '';
        document.getElementById('cliente_freg').value = reserva.clienteFreg || '';
        
        // R14-R15 - Comercial e Equipa
        document.getElementById('comercial').value = reserva.comercial || '';
        document.getElementById('equipa').value = reserva.equipa || '';
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // SECÃ‡ÃƒO 2 - DETALHES DA CARGA
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        // R16 - LDM
        document.getElementById('ldm').value = reserva.ldm || '';
        
        // R17 - NÂº Bultos
        document.getElementById('num_bultos').value = reserva.numBultos || '';
        
        // R18 - DescriÃ§Ã£o
        document.getElementById('descricao_carga').value = reserva.descricaoCarga || '';
        
        // R19 - Peso
        document.getElementById('peso').value = reserva.peso || '';
        
        // R20 - PreÃ§o
        document.getElementById('preco').value = reserva.preco || '';
        
        // R21 - NÂº Volumes
        document.getElementById('volumes').value = reserva.volumes || '';
        
        // R22 - Tipo Mercadoria
        document.getElementById('tipo_merc').value = reserva.tipoMercadoria || '';
        
        // R23 - Ton. Carga
        document.getElementById('ton_carga').value = reserva.tonCarga || '';
        
        // R24 - Ton. Descarga
        document.getElementById('ton_descarga').value = reserva.tonDescarga || '';
        
        // R25 - PreÃ§o/Ton
        document.getElementById('preco_ton').value = reserva.precoTon || '';
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // SECÃ‡ÃƒO 3 - LOCAL DE CARGA
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        // R26 - Empresa de Carga
        document.getElementById('empresa_carga').value = reserva.empresaCarga || '';
        
        // R27-R34 - Morada de Carga
        document.getElementById('carga_rua').value = reserva.cargaRua || '';
        document.getElementById('carga_nr').value = reserva.cargaNr || '';
        document.getElementById('carga_local').value = reserva.cargaLocal || '';
        document.getElementById('carga_freg').value = reserva.cargaFreg || '';
        document.getElementById('carga_cp').value = reserva.cargaCP || '';
        document.getElementById('carga_cidade').value = reserva.cargaCidade || '';
        document.getElementById('carga_concelho').value = reserva.cargaConcelho || '';
        document.getElementById('carga_pais').value = reserva.cargaPais || '';
        
        // R35-R38 - LogÃ­stica Carga
        document.getElementById('motorista_carga').value = reserva.motoristaCarga || '';
        document.getElementById('trator_carga').value = reserva.tratorCarga || '';
        document.getElementById('reboque_carga').value = reserva.reboqueCarga || '';
        document.getElementById('ref_comb').value = reserva.refCombustivel || '';
        
        // R39-R44 - Contactos e Datas Carga
        document.getElementById('contacto_carga').value = reserva.contactoCarga || '';
        document.getElementById('tel_carga').value = reserva.telCarga || '';
        document.getElementById('data_carga_sol').value = reserva.dataCargaSol || '';
        document.getElementById('data_carga_ef').value = reserva.dataCargaEf || '';
        document.getElementById('ref_carga').value = reserva.refCarga || '';
        document.getElementById('ref_cliente').value = reserva.refCliente || '';
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // SECÃ‡ÃƒO 4 - LOCAL DE DESCARGA
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        // R45 - Empresa de Descarga
        document.getElementById('empresa_descarga').value = reserva.empresaDescarga || '';
        
        // R46-R53 - Morada de Descarga
        document.getElementById('descarga_rua').value = reserva.descargaRua || '';
        document.getElementById('descarga_nr').value = reserva.descargaNr || '';
        document.getElementById('descarga_local').value = reserva.descargaLocal || '';
        document.getElementById('descarga_freg').value = reserva.descargaFreg || '';
        document.getElementById('descarga_cp').value = reserva.descargaCP || '';
        document.getElementById('descarga_cidade').value = reserva.descargaCidade || '';
        document.getElementById('descarga_concelho').value = reserva.descargaConcelho || '';
        document.getElementById('descarga_pais').value = reserva.descargaPais || '';
        
        // R54-R57 - LogÃ­stica Descarga
        document.getElementById('motorista_descarga').value = reserva.motoristaDescarga || '';
        document.getElementById('trator_descarga').value = reserva.tratorDescarga || '';
        document.getElementById('reboque_descarga').value = reserva.reboqueDescarga || '';
        document.getElementById('ref_descarga').value = reserva.refDescarga || '';
        
        // R58-R61 - Contactos e Datas Descarga
        document.getElementById('contacto_descarga').value = reserva.contactoDescarga || '';
        document.getElementById('tel_descarga').value = reserva.telDescarga || '';
        document.getElementById('data_descarga_sol').value = reserva.dataDescargaSol || '';
        document.getElementById('data_descarga_ef').value = reserva.dataDescargaEf || '';
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // FLAGS E ESTADO
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        // Marcar como criada
        reservaCriada = true;
        numReserva = reserva.numero;
        
        // Se faturada, marcar como tal
        if (reserva.faturada) {
            reservaFaturada = true;
            document.getElementById('numero_fatura').value = reserva.faturaNumero || '-';
        } else {
            reservaFaturada = false;
        }
        
        // Carregar histÃ³rico de incidÃªncias
        historicoInc = reserva.incidencias || [];
        
        // Atualizar asteriscos de obrigatoriedade R16-R21 vs R23-R25
        atualizarObrigatoriedadeR18R20();
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // v6.30: MOSTRAR INDICADORES DE CMRs ANEXADOS
        // Se a reserva tem CMRs no localStorage, mostrar visualmente
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        mostrarIndicadoresCMR(reserva);
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // SEMPRE bloquear a reserva quando Ã© carregada (sÃ³ visualizaÃ§Ã£o)
        // Para editar, o utilizador DEVE clicar no botÃ£o "Alterar Reserva"
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        bloquearReservaParaVisualizacao();
        
        // Gerar QR code
        if (typeof gerarQR === 'function') {
            gerarQR();
        }
        
        console.log('ğŸ“‹ Reserva ' + reserva.numero + ' carregada com ' + Object.keys(reserva).length + ' campos');
        alert('ğŸ“‹ Reserva ' + reserva.numero + ' carregada em modo visualizaÃ§Ã£o!\n\nğŸ”’ Para editar, clique no botÃ£o "Alterar Reserva" em baixo.');
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // v6.30: FUNÃ‡Ã•ES DE LIMPEZA E INDICADORES DE CMR
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    /**
     * v6.30: Limpa TODOS os campos de ficheiro do formulÃ¡rio
     * CRÃTICO: Deve ser chamado ANTES de carregar uma nova reserva
     * Resolve o bug de ficheiros que apareciam em todas as reservas
     */
    function limparCamposFicheiro() {
        console.log('ğŸ§¹ v6.30 limparCamposFicheiro() - Limpando campos de ficheiro');
        
        // Lista de todos os campos de ficheiro
        const camposFicheiro = ['cmr_carga', 'cmr_descarga', 'fotos_carga', 'fotos_descarga', 'ordem_carga'];
        
        camposFicheiro.forEach(id => {
            const input = document.getElementById(id);
            if (input) {
                input.value = ''; // Limpa o ficheiro
                console.log('   âœ“ Limpo:', id);
            }
        });
        
        // Remover indicadores visuais anteriores
        document.querySelectorAll('.cmr-indicator-badge').forEach(el => el.remove());
        
        console.log('ğŸ§¹ Campos de ficheiro limpos');
    }
    
    /**
     * v6.32: Mostra indicadores visuais de CMRs anexados
     * MODIFICADO: Verifica se ficheiro BASE64 existe no localStorage
     */
    function mostrarIndicadoresCMR(reserva) {
        console.log('ğŸ·ï¸ v6.32 mostrarIndicadoresCMR() - Reserva:', reserva.numero);
        
        // CMR de Carga
        const cmrCarga = reserva.cmrCarga || reserva.cmr_carga;
        if (cmrCarga && cmrCarga.length > 0) {
            // Verificar se existe Base64 no localStorage
            const base64Existe = verificarBase64Existe(reserva.numero, 'carga');
            adicionarIndicadorCMR('cmr_carga', cmrCarga, 'CMR Carga', base64Existe);
            console.log('   ' + (base64Existe ? 'âœ“' : 'âš ï¸') + ' CMR Carga:', cmrCarga);
        }
        
        // CMR de Descarga
        const cmrDescarga = reserva.cmrDescarga || reserva.cmr_descarga;
        if (cmrDescarga && cmrDescarga.length > 0) {
            const base64Existe = verificarBase64Existe(reserva.numero, 'descarga');
            adicionarIndicadorCMR('cmr_descarga', cmrDescarga, 'CMR Descarga', base64Existe);
            console.log('   ' + (base64Existe ? 'âœ“' : 'âš ï¸') + ' CMR Descarga:', cmrDescarga);
        }
    }
    
    /**
     * v6.32: Verifica se ficheiro Base64 existe no localStorage
     */
    function verificarBase64Existe(numeroReserva, tipoCMR) {
        const chaveBase64 = `cmr_${numeroReserva}_${tipoCMR}`;
        try {
            const dadosStr = localStorage.getItem(chaveBase64);
            if (dadosStr) {
                const dados = JSON.parse(dadosStr);
                return dados.base64 && dados.base64.length > 0;
            }
        } catch (e) {}
        return false;
    }
    
    /**
     * v6.33: Adiciona badge visual indicando ficheiro anexado
     * CORRIGIDO: Badge agora aparece NA MESMA LINHA junto aos botÃµes
     * @param existeBase64 - true = badge verde (pode abrir), false = badge laranja (sem ficheiro)
     */
    function adicionarIndicadorCMR(inputId, nomeFicheiro, tipoAnexo, existeBase64 = true) {
        // Encontrar o input
        const input = document.getElementById(inputId);
        if (!input) {
            console.log('âš ï¸ Input nÃ£o encontrado:', inputId);
            return;
        }
        
        // v6.33: Encontrar o <li> pai (container correto)
        const liContainer = input.closest('li');
        if (!liContainer) {
            console.log('âš ï¸ Container LI nÃ£o encontrado para:', inputId);
            return;
        }
        
        // Verificar se jÃ¡ existe um indicador neste LI e remover
        const existente = liContainer.querySelector('.cmr-indicator-badge');
        if (existente) existente.remove();
        
        // Criar badge como SPAN (inline)
        const badge = document.createElement('span');
        badge.className = 'cmr-indicator-badge';
        
        // Truncar nome do ficheiro
        const nomeExibir = nomeFicheiro.length > 20 ? nomeFicheiro.substring(0, 17) + '...' : nomeFicheiro;
        
        if (existeBase64) {
            // Badge VERDE - ficheiro pode ser aberto/descarregado
            badge.style.cssText = `
                display: inline-flex;
                align-items: center;
                gap: 4px;
                margin-left: 10px;
                padding: 4px 10px;
                background: linear-gradient(135deg, #10b981, #059669);
                color: white;
                border-radius: 4px;
                font-size: 11px;
                font-weight: 600;
                white-space: nowrap;
            `;
            badge.innerHTML = `âœ… ${nomeExibir}`;
            badge.title = `${tipoAnexo}: ${nomeFicheiro}\n\nClique em "Abrir" para descarregar.`;
        } else {
            // Badge LARANJA - ficheiro nÃ£o disponÃ­vel
            badge.style.cssText = `
                display: inline-flex;
                align-items: center;
                gap: 4px;
                margin-left: 10px;
                padding: 4px 10px;
                background: linear-gradient(135deg, #f59e0b, #d97706);
                color: white;
                border-radius: 4px;
                font-size: 11px;
                font-weight: 600;
                cursor: pointer;
                white-space: nowrap;
            `;
            badge.innerHTML = `âš ï¸ ${nomeExibir}`;
            badge.title = `${tipoAnexo}: ${nomeFicheiro}\n\nâš ï¸ Ficheiro nÃ£o disponÃ­vel.\nClique para limpar este registo.`;
            
            // Ao clicar, permite limpar o registo
            badge.onclick = function(e) {
                e.stopPropagation();
                if (confirm(`Deseja limpar o registo de "${nomeFicheiro}"?\n\nO ficheiro nÃ£o estÃ¡ disponÃ­vel.`)) {
                    limparCMRReserva(document.getElementById('numero_reserva')?.value, inputId === 'cmr_carga' ? 'carga' : 'descarga');
                    badge.remove();
                }
            };
        }
        
        // Adicionar badge no final do LI (depois dos botÃµes)
        liContainer.appendChild(badge);
        
        console.log('ğŸ·ï¸ Badge adicionado a:', inputId, '| Ficheiro:', nomeFicheiro);
    }
    
    /**
     * v6.32: Limpa CMR de uma reserva especÃ­fica - inclui Base64
     */
    function limparCMRReserva(numeroReserva, tipoCMR) {
        if (!numeroReserva) return;
        
        // 1. Apagar ficheiro Base64
        const chaveBase64 = `cmr_${numeroReserva}_${tipoCMR}`;
        localStorage.removeItem(chaveBase64);
        console.log('ğŸ—‘ï¸ Base64 apagado:', chaveBase64);
        
        // 2. Limpar metadados nas reservas
        const chavesStorage = ['erpReservasExecutadas', 'erpReservas'];
        
        chavesStorage.forEach(chave => {
            try {
                const dadosStr = localStorage.getItem(chave);
                if (!dadosStr) return;
                
                const arrayReservas = JSON.parse(dadosStr);
                if (!Array.isArray(arrayReservas)) return;
                
                const idx = arrayReservas.findIndex(r => r.numero === numeroReserva);
                if (idx !== -1) {
                    if (tipoCMR === 'carga') {
                        delete arrayReservas[idx].cmrCarga;
                        delete arrayReservas[idx].cmr_carga;
                        delete arrayReservas[idx].cmrCargaAnexado;
                        delete arrayReservas[idx].cmrCargaData;
                        delete arrayReservas[idx].cmrCargaBase64Key;
                    } else {
                        delete arrayReservas[idx].cmrDescarga;
                        delete arrayReservas[idx].cmr_descarga;
                        delete arrayReservas[idx].cmrDescargaAnexado;
                        delete arrayReservas[idx].cmrDescargaData;
                        delete arrayReservas[idx].cmrDescargaBase64Key;
                        delete arrayReservas[idx].cmrCompleto;
                    }
                    localStorage.setItem(chave, JSON.stringify(arrayReservas));
                    console.log('âœ… CMR ' + tipoCMR + ' limpo da reserva ' + numeroReserva + ' em ' + chave);
                }
            } catch (e) {
                console.error('Erro:', e);
            }
        });
        
        mostrarNotificacaoC52('success', `âœ… CMR ${tipoCMR} apagado da reserva ${numeroReserva}`);
    }
    
    /**
     * Bloqueia a reserva para modo de visualizaÃ§Ã£o (nÃ£o ediÃ§Ã£o)
     * SÃ³ pode ser desbloqueada pelo botÃ£o "Alterar Reserva"
     */
    function bloquearReservaParaVisualizacao() {
        // Lista de todos os campos editÃ¡veis
        const camposSempreBloqueados = ['data_abertura', 'numero_reserva', 'numero_fatura', 'data_carga_ef', 'data_descarga_ef'];
        
        // Bloquear todos os inputs, selects e textareas
        // EXCETO: inputs de tipo file (anexos) e campos da secÃ§Ã£o 5
        document.querySelectorAll('#page-reservas input, #page-reservas select, #page-reservas textarea').forEach(el => {
            // NÃ£o bloquear se Ã© um campo sempre bloqueado
            if (camposSempreBloqueados.includes(el.id)) return;
            
            // NÃ£o bloquear inputs de tipo file (anexos)
            if (el.type === 'file') return;
            
            // NÃ£o bloquear campos da secÃ§Ã£o 5 (incidÃªncias e anexos)
            if (el.closest('#secao5')) return;
            
            // Bloquear o resto
            el.disabled = true;
            el.style.backgroundColor = '#f5f5f5';
            el.style.cursor = 'not-allowed';
        });
        
        // âš ï¸ v6.10: BLOQUEAR APENAS BOTÃ•ES ESPECÃFICOS
        // BotÃµes que devem ficar BLOQUEADOS apÃ³s criar reserva:
        const botoesParaBloquear = [
            'btnClienteConfig',      // BotÃ£o âš™ï¸ do Cliente (R4)
            'btnComercial',          // BotÃ£o ğŸ‘¤ do Comercial (R14)
            'btnEquipaLogistica',    // BotÃ£o ğŸ‘¥ da Equipa LogÃ­stica (R15)
            'btnEmpresaDescarga'     // BotÃ£o âš™ï¸ da Empresa de Descarga (R45)
        ];
        
        botoesParaBloquear.forEach(id => {
            const btn = document.getElementById(id);
            if (btn) {
                btn.disabled = true;
                btn.style.opacity = '0.5';
                btn.style.cursor = 'not-allowed';
            }
        });
        
        // TODOS OS OUTROS BOTÃ•ES permanecem ATIVOS!
        // (Enviar Etiquetas, CMR, Mensagens, Motorista, Trator, Reboque, etc.)
        
        // Adicionar indicador visual de modo visualizaÃ§Ã£o
        ['secao1', 'secao2', 'secao3', 'secao4', 'secao6'].forEach(id => {
            const secao = document.getElementById(id);
            if (secao) {
                secao.classList.add('reserva-bloqueada');
                const header = secao.querySelector('h2');
                if (header && !header.querySelector('.badge-visualizacao')) {
                    const badge = document.createElement('span');
                    badge.className = 'badge-visualizacao';
                    badge.innerHTML = ' ğŸ‘ï¸';
                    badge.title = 'Modo visualizaÃ§Ã£o - Clique em "Alterar Reserva" para editar campos';
                    badge.style.cssText = 'color: #3498db; font-size: 14px;';
                    header.appendChild(badge);
                }
            }
        });
        
        // Garantir que R62 (IncidÃªncias) permanece livre para adicionar
        const campoIncidencias = document.getElementById('incidencias');
        if (campoIncidencias) {
            campoIncidencias.disabled = false;
            campoIncidencias.style.backgroundColor = '#fff';
            campoIncidencias.style.cursor = 'text';
        }
        
        // Atualizar botÃ£o Criar para mostrar que estÃ¡ em modo visualizaÃ§Ã£o
        const btnCriar = document.getElementById('btnCriar');
        if (btnCriar) {
            btnCriar.disabled = true;
            btnCriar.style.opacity = '0.5';
        }
        
        // Garantir que o botÃ£o Alterar estÃ¡ ativo
        const btnAlterar = document.getElementById('btnAlterar');
        if (btnAlterar) {
            btnAlterar.disabled = false;
            btnAlterar.style.opacity = '1';
            btnAlterar.style.cursor = 'pointer';
            btnAlterar.style.background = 'linear-gradient(135deg, #e67e22, #d35400)';
        }
        
        console.log('ğŸ‘ï¸ Reserva em modo visualizaÃ§Ã£o (campos bloqueados, BOTÃ•ES DE AÃ‡ÃƒO ATIVOS)');
    }
    
    /**
     * Desbloqueia a reserva para ediÃ§Ã£o (chamada pelo botÃ£o "Alterar Reserva")
     */
    function desbloquearReservaParaEdicao() {
        // Verificar se hÃ¡ reserva carregada
        if (!reservaCriada || !numReserva) {
            alert('âš ï¸ Nenhuma reserva carregada para editar.');
            return;
        }
        
        // Se a reserva estÃ¡ faturada, verificar permissÃ£o
        if (reservaFaturada && !temPermissaoEditarFaturadas()) {
            alert('ğŸ”’ Esta reserva estÃ¡ FATURADA!\n\nApenas utilizadores com permissÃ£o podem editar reservas faturadas.');
            return;
        }
        
        // Campos que devem permanecer SEMPRE bloqueados
        const camposSempreBloqueados = ['data_abertura', 'numero_reserva', 'numero_fatura', 'data_carga_ef', 'data_descarga_ef'];
        
        // Desbloquear todos os campos
        document.querySelectorAll('#page-reservas input, #page-reservas select, #page-reservas textarea').forEach(el => {
            if (!camposSempreBloqueados.includes(el.id)) {
                el.disabled = false;
                el.style.backgroundColor = '';
                el.style.cursor = '';
            }
        });
        
        // Garantir que R42 e R61 permanecem bloqueados
        const campoR42 = document.getElementById('data_carga_ef');
        const campoR61 = document.getElementById('data_descarga_ef');
        if (campoR42) { campoR42.style.backgroundColor = '#e9ecef'; campoR42.style.cursor = 'not-allowed'; }
        if (campoR61) { campoR61.style.backgroundColor = '#e9ecef'; campoR61.style.cursor = 'not-allowed'; }
        
        // Desbloquear botÃµes
        document.querySelectorAll('#page-reservas .reservas-btn').forEach(btn => {
            btn.disabled = false;
            btn.style.opacity = '1';
            btn.style.cursor = 'pointer';
        });
        
        // Remover badges de visualizaÃ§Ã£o
        document.querySelectorAll('.badge-visualizacao').forEach(b => b.remove());
        document.querySelectorAll('.badge-bloqueado').forEach(b => b.remove());
        
        // Remover classe de bloqueio
        ['secao1', 'secao2', 'secao3', 'secao4', 'secao6'].forEach(id => {
            const secao = document.getElementById(id);
            if (secao) secao.classList.remove('reserva-bloqueada');
        });
        
        // Ativar botÃ£o Criar para guardar alteraÃ§Ãµes
        const btnCriar = document.getElementById('btnCriar');
        if (btnCriar) {
            btnCriar.disabled = false;
            btnCriar.style.opacity = '1';
            btnCriar.textContent = 'ğŸ’¾ Guardar AlteraÃ§Ãµes';
        }
        
        // Registar no histÃ³rico
        registarHistoricoReserva(numReserva, 'EDICAO_INICIADA', 'Reserva aberta para ediÃ§Ã£o');
        
        alert('âœï¸ Reserva desbloqueada para ediÃ§Ã£o!\n\nPode agora alterar os campos.\n\nClique em "ğŸ’¾ Guardar AlteraÃ§Ãµes" quando terminar.');
        
        console.log('âœï¸ Reserva desbloqueada para ediÃ§Ã£o');
    }
    
    function exportarReservasCSV() {
        let reservasGuardadas = [];
        try {
            const dados = localStorage.getItem('erpReservasExecutadas');
            if (dados) reservasGuardadas = JSON.parse(dados);
        } catch(e) {}
        
        if (reservasGuardadas.length === 0) {
            alert('âš ï¸ NÃ£o existem reservas para exportar');
            return;
        }
        
        // Criar CSV
        let csv = 'Numero;Data;Cliente;Origem;Destino;Preco;Estado;Fatura\n';
        reservasGuardadas.forEach(r => {
            csv += `${r.numero || ''};${r.dataAbertura || ''};${r.cliente || ''};${r.cargaCidade || ''};${r.descargaCidade || ''};${r.preco || ''};${r.faturada ? 'Faturada' : 'Pendente'};${r.faturaNumero || ''}\n`;
        });
        
        // Download
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = 'reservas_' + new Date().toISOString().split('T')[0] + '.csv';
        link.click();
    }
    
    function fecharModalReservas(id) { document.getElementById(id).classList.remove('active'); }

    function abrirPainelRecolhas() {
        // Atualizar lista de recolhas pendentes com dados reais
        atualizarReservasPendentes();
        
        const lista = document.getElementById('listaRecolhasPendentes');
        const pendentes = reservasPendentes.filter(r => !r.temCMR);
        
        if (pendentes.length === 0) {
            lista.innerHTML = '<p style="color:#27ae60; text-align:center; padding:20px;">âœ… Todas as recolhas tÃªm CMR!</p>';
        } else {
            let html = '';
            pendentes.forEach(r => {
                let menorDist = Infinity;
                let viaturaMaisProxima = null;
                viaturasFrotcom.forEach(v => {
                    const dist = calcularDistanciaReservas(r.lat, r.lng, v.lat, v.lng);
                    if (dist < menorDist) {
                        menorDist = dist;
                        viaturaMaisProxima = v;
                    }
                });
                
                html += '<div onclick="selecionarRecolha(\'' + r.numero + '\')" style="background:white; border-radius:8px; padding:12px; margin-bottom:10px; cursor:pointer; border-left:4px solid #e74c3c; transition:all 0.3s; box-shadow:0 2px 5px rgba(0,0,0,0.1);" onmouseover="this.style.transform=\'translateX(5px)\'; this.style.boxShadow=\'0 4px 12px rgba(0,0,0,0.15)\'" onmouseout="this.style.transform=\'translateX(0)\'; this.style.boxShadow=\'0 2px 5px rgba(0,0,0,0.1)\'">';
                html += '<div style="font-weight:bold; color:#1e3c72; font-size:14px;">' + r.numero + '</div>';
                html += '<div style="font-size:13px; color:#495057; margin-top:4px;">' + r.cliente + '</div>';
                html += '<div style="font-size:12px; color:#6c757d; margin-top:4px;">ğŸ“ ' + r.cidade + ' (' + r.cp + ')</div>';
                if (viaturaMaisProxima) {
                    html += '<div style="font-size:12px; color:#27ae60; margin-top:6px; padding-top:6px; border-top:1px solid #eee;">';
                    html += 'ğŸš› Mais prÃ³ximo: <strong>' + viaturaMaisProxima.matricula + '</strong> (' + menorDist.toFixed(1) + ' km)';
                    html += '</div>';
                }
                html += '</div>';
            });
            lista.innerHTML = html;
        }
        
        // âœ… CORREÃ‡ÃƒO v6.13: Abrir modal PRIMEIRO, depois criar mapa
        // O Leaflet precisa que o container esteja visÃ­vel para calcular dimensÃµes
        document.getElementById('modalRecolhas').classList.add('active');
        
        // Criar mapa DEPOIS do modal estar visÃ­vel (com delay)
        setTimeout(function() {
            desenharMapaRecolhas();
            // ForÃ§ar invalidateSize se o mapa jÃ¡ existir
            if (leafletMapRecolhas) {
                leafletMapRecolhas.invalidateSize();
            }
        }, 250);
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ğŸ—ºï¸ FUNÃ‡Ã•ES PARA VER LOCAL DE CARGA / DESCARGA (v6.13 - Google Places API)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    // VariÃ¡veis para guardar estado dos mapas e resultados
    var mapaLocalCargaLeaflet = null;
    var mapaLocalDescargaLeaflet = null;
    var localCargaSelecionado = null;
    var localDescargaSelecionado = null;
    var markersLocalCarga = null;
    var markersLocalDescarga = null;
    var googlePlacesService = null;
    var googleAutocompleteService = null;
    
    /**
     * Abre modal para pesquisar local de carga
     */
    function abrirModalLocalCarga() {
        // Reset estado
        localCargaSelecionado = null;
        document.getElementById('pesquisaLocalCarga').value = '';
        document.getElementById('resultadosPesquisaCarga').innerHTML = '<p style="color:#999; text-align:center; padding:20px;">Pesquise uma empresa para ver resultados</p>';
        document.getElementById('detalheLocalCarga').innerHTML = '<p style="color:#999;">Nenhum local selecionado</p>';
        document.getElementById('btnPreencherCarga').style.display = 'none';
        document.getElementById('statusPesquisaCarga').textContent = '';
        
        // Abrir modal primeiro (Leaflet precisa de container visÃ­vel)
        document.getElementById('modalLocalCarga').classList.add('active');
        
        // Criar mapa depois do modal estar visÃ­vel
        setTimeout(function() {
            criarMapaLocal('carga');
            inicializarGooglePlaces();
        }, 250);
    }
    
    /**
     * Abre modal para pesquisar local de descarga
     */
    function abrirModalLocalDescarga() {
        // Reset estado
        localDescargaSelecionado = null;
        document.getElementById('pesquisaLocalDescarga').value = '';
        document.getElementById('resultadosPesquisaDescarga').innerHTML = '<p style="color:#999; text-align:center; padding:20px;">Pesquise uma empresa para ver resultados</p>';
        document.getElementById('detalheLocalDescarga').innerHTML = '<p style="color:#999;">Nenhum local selecionado</p>';
        document.getElementById('btnPreencherDescarga').style.display = 'none';
        document.getElementById('statusPesquisaDescarga').textContent = '';
        
        // Abrir modal primeiro
        document.getElementById('modalLocalDescarga').classList.add('active');
        
        // Criar mapa depois
        setTimeout(function() {
            criarMapaLocal('descarga');
            inicializarGooglePlaces();
        }, 250);
    }
    
    /**
     * Inicializa Google Places Services
     */
    function inicializarGooglePlaces() {
        if (typeof google !== 'undefined' && google.maps && google.maps.places) {
            // Criar elemento temporÃ¡rio para PlacesService
            const mapDiv = document.createElement('div');
            const tempMap = new google.maps.Map(mapDiv, { center: { lat: 39.5, lng: -8.0 }, zoom: 6 });
            googlePlacesService = new google.maps.places.PlacesService(tempMap);
            googleAutocompleteService = new google.maps.places.AutocompleteService();
            console.log('âœ… Google Places Services inicializados');
        } else {
            // Carregar Google Maps se ainda nÃ£o estiver carregado
            carregarGoogleMaps(function() {
                const mapDiv = document.createElement('div');
                const tempMap = new google.maps.Map(mapDiv, { center: { lat: 39.5, lng: -8.0 }, zoom: 6 });
                googlePlacesService = new google.maps.places.PlacesService(tempMap);
                googleAutocompleteService = new google.maps.places.AutocompleteService();
                console.log('âœ… Google Places Services inicializados (async)');
            });
        }
    }
    
    // VariÃ¡veis para guardar tile layers atuais
    var tileLayerCarga = null;
    var tileLayerDescarga = null;
    
    // DefiniÃ§Ã£o dos tipos de mapa disponÃ­veis
    var tiposMapa = {
        mapa: {
            url: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
            attribution: 'Â© OpenStreetMap | Pesquisa: Google Places',
            maxZoom: 19
        },
        satelite: {
            url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
            attribution: 'Â© Esri | Pesquisa: Google Places',
            maxZoom: 19
        },
        terreno: {
            url: 'https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png',
            attribution: 'Â© OpenTopoMap | Pesquisa: Google Places',
            maxZoom: 17
        },
        hibrido: {
            url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
            attribution: 'Â© Esri + Labels | Pesquisa: Google Places',
            maxZoom: 19,
            labels: true
        }
    };
    
    /**
     * Altera o tipo de mapa (mapa, satÃ©lite, terreno, hÃ­brido)
     */
    function alterarTipoMapa(modalTipo, tipoMapa) {
        const map = modalTipo === 'carga' ? mapaLocalCargaLeaflet : mapaLocalDescargaLeaflet;
        if (!map) return;
        
        const config = tiposMapa[tipoMapa];
        if (!config) return;
        
        // Remover tile layer anterior
        if (modalTipo === 'carga' && tileLayerCarga) {
            map.removeLayer(tileLayerCarga);
            // Remover labels se existirem
            if (window.labelsLayerCarga) {
                map.removeLayer(window.labelsLayerCarga);
                window.labelsLayerCarga = null;
            }
        }
        if (modalTipo === 'descarga' && tileLayerDescarga) {
            map.removeLayer(tileLayerDescarga);
            if (window.labelsLayerDescarga) {
                map.removeLayer(window.labelsLayerDescarga);
                window.labelsLayerDescarga = null;
            }
        }
        
        // Criar novo tile layer
        const newLayer = L.tileLayer(config.url, {
            attribution: config.attribution,
            maxZoom: config.maxZoom
        }).addTo(map);
        
        // Se for hÃ­brido, adicionar camada de labels
        if (config.labels) {
            const labelsLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}{r}.png', {
                maxZoom: 19,
                pane: 'overlayPane'
            }).addTo(map);
            
            if (modalTipo === 'carga') {
                window.labelsLayerCarga = labelsLayer;
            } else {
                window.labelsLayerDescarga = labelsLayer;
            }
        }
        
        // Guardar referÃªncia
        if (modalTipo === 'carga') {
            tileLayerCarga = newLayer;
        } else {
            tileLayerDescarga = newLayer;
        }
        
        // Atualizar estilo dos botÃµes
        const tipos = ['mapa', 'satelite', 'terreno', 'hibrido'];
        tipos.forEach(t => {
            const btn = document.getElementById('btnMapa' + (modalTipo === 'carga' ? 'Carga' : 'Descarga') + '_' + t);
            if (btn) {
                if (t === tipoMapa) {
                    btn.style.background = '#4285f4';
                    btn.style.color = 'white';
                } else {
                    btn.style.background = '#e9ecef';
                    btn.style.color = '#333';
                }
            }
        });
        
        console.log('âœ… Tipo de mapa alterado para:', tipoMapa);
    }
    
    /**
     * Cria mapa Leaflet para pesquisa de local
     */
    function criarMapaLocal(tipo) {
        const containerId = tipo === 'carga' ? 'mapaLocalCarga' : 'mapaLocalDescarga';
        const container = document.getElementById(containerId);
        if (!container) return;
        
        // Limpar mapa anterior
        if (tipo === 'carga' && mapaLocalCargaLeaflet) {
            mapaLocalCargaLeaflet.remove();
            mapaLocalCargaLeaflet = null;
            tileLayerCarga = null;
        }
        if (tipo === 'descarga' && mapaLocalDescargaLeaflet) {
            mapaLocalDescargaLeaflet.remove();
            mapaLocalDescargaLeaflet = null;
            tileLayerDescarga = null;
        }
        
        // Verificar Leaflet
        if (typeof L === 'undefined') {
            container.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100%;color:#999;">Mapa nÃ£o disponÃ­vel</div>';
            return;
        }
        
        // Criar mapa centrado em Portugal
        const map = L.map(containerId).setView([39.5, -8.0], 6);
        
        // Adicionar tiles (mapa padrÃ£o)
        const defaultLayer = L.tileLayer(tiposMapa.mapa.url, {
            attribution: tiposMapa.mapa.attribution,
            maxZoom: tiposMapa.mapa.maxZoom
        }).addTo(map);
        
        // Guardar referÃªncia
        if (tipo === 'carga') {
            mapaLocalCargaLeaflet = map;
            tileLayerCarga = defaultLayer;
            markersLocalCarga = L.layerGroup().addTo(map);
        } else {
            mapaLocalDescargaLeaflet = map;
            tileLayerDescarga = defaultLayer;
            markersLocalDescarga = L.layerGroup().addTo(map);
        }
        
        // Reset botÃµes para estado inicial
        const tipos = ['mapa', 'satelite', 'terreno', 'hibrido'];
        tipos.forEach(t => {
            const btn = document.getElementById('btnMapa' + (tipo === 'carga' ? 'Carga' : 'Descarga') + '_' + t);
            if (btn) {
                if (t === 'mapa') {
                    btn.style.background = '#4285f4';
                    btn.style.color = 'white';
                } else {
                    btn.style.background = '#e9ecef';
                    btn.style.color = '#333';
                }
            }
        });
        
        console.log('âœ… Mapa Local de ' + tipo + ' criado');
    }
    
    /**
     * Pesquisa empresa usando Google Places API
     */
    async function pesquisarLocalMapa(tipo) {
        const inputId = tipo === 'carga' ? 'pesquisaLocalCarga' : 'pesquisaLocalDescarga';
        const paisId = tipo === 'carga' ? 'paisPesquisaCarga' : 'paisPesquisaDescarga';
        const statusId = tipo === 'carga' ? 'statusPesquisaCarga' : 'statusPesquisaDescarga';
        const resultadosId = tipo === 'carga' ? 'resultadosPesquisaCarga' : 'resultadosPesquisaDescarga';
        
        const termo = document.getElementById(inputId).value.trim();
        const pais = document.getElementById(paisId).value;
        
        if (!termo) {
            alert('âš ï¸ Por favor, digite o nome da empresa para pesquisar.');
            return;
        }
        
        // Mostrar loading
        document.getElementById(statusId).innerHTML = '<span style="color:#667eea;">ğŸ”„ A pesquisar "' + termo + '" no Google Maps...</span>';
        document.getElementById(resultadosId).innerHTML = '<p style="color:#667eea; text-align:center; padding:20px;">ğŸ”„ A carregar resultados...</p>';
        
        // Verificar se Google Places estÃ¡ disponÃ­vel
        if (!googlePlacesService || !googleAutocompleteService) {
            // Tentar inicializar
            if (typeof google !== 'undefined' && google.maps && google.maps.places) {
                const mapDiv = document.createElement('div');
                const tempMap = new google.maps.Map(mapDiv, { center: { lat: 39.5, lng: -8.0 }, zoom: 6 });
                googlePlacesService = new google.maps.places.PlacesService(tempMap);
                googleAutocompleteService = new google.maps.places.AutocompleteService();
            } else {
                document.getElementById(statusId).innerHTML = '<span style="color:#e74c3c;">âŒ Google Maps nÃ£o estÃ¡ carregado. A usar pesquisa alternativa...</span>';
                // Fallback para pesquisa alternativa
                await pesquisarLocalMapaFallback(tipo, termo, pais);
                return;
            }
        }
        
        try {
            // Configurar restriÃ§Ã£o de paÃ­s
            const paisesMap = {
                'pt': 'pt',
                'es': 'es',
                'fr': 'fr',
                'de': 'de',
                'it': 'it',
                'nl': 'nl',
                'be': 'be'
            };
            
            // Usar Text Search para encontrar empresas
            const request = {
                query: termo,
                type: 'establishment'
            };
            
            // Adicionar bias de localizaÃ§Ã£o baseado no paÃ­s
            const paisCoordenadas = {
                'pt': { lat: 39.5, lng: -8.0 },
                'es': { lat: 40.4, lng: -3.7 },
                'fr': { lat: 46.2, lng: 2.2 },
                'de': { lat: 51.2, lng: 10.4 },
                'it': { lat: 41.9, lng: 12.5 },
                'nl': { lat: 52.1, lng: 5.3 },
                'be': { lat: 50.5, lng: 4.4 }
            };
            
            if (pais && paisCoordenadas[pais]) {
                request.location = new google.maps.LatLng(paisCoordenadas[pais].lat, paisCoordenadas[pais].lng);
                request.radius = 500000; // 500km
            }
            
            // Executar pesquisa
            googlePlacesService.textSearch(request, function(results, status) {
                if (status === google.maps.places.PlacesServiceStatus.OK && results && results.length > 0) {
                    document.getElementById(statusId).innerHTML = '<span style="color:#27ae60;">âœ… ' + results.length + ' resultado(s) encontrado(s) no Google Maps</span>';
                    
                    // Filtrar por paÃ­s se especificado
                    let resultadosFiltrados = results;
                    if (pais) {
                        resultadosFiltrados = results.filter(r => {
                            const endereco = r.formatted_address || '';
                            const paisNomes = {
                                'pt': ['Portugal'],
                                'es': ['Spain', 'EspaÃ±a', 'Espanha'],
                                'fr': ['France', 'FranÃ§a'],
                                'de': ['Germany', 'Deutschland', 'Alemanha'],
                                'it': ['Italy', 'Italia', 'ItÃ¡lia'],
                                'nl': ['Netherlands', 'Nederland', 'Holanda', 'PaÃ­ses Baixos'],
                                'be': ['Belgium', 'BelgiÃ«', 'Belgique', 'BÃ©lgica']
                            };
                            return paisNomes[pais]?.some(nome => endereco.includes(nome)) || true;
                        });
                    }
                    
                    // Limitar a 10 resultados
                    resultadosFiltrados = resultadosFiltrados.slice(0, 10);
                    
                    // Mostrar resultados
                    mostrarResultadosGoogle(tipo, resultadosFiltrados);
                    mostrarMarcadoresGoogle(tipo, resultadosFiltrados);
                    
                } else if (status === google.maps.places.PlacesServiceStatus.ZERO_RESULTS) {
                    document.getElementById(statusId).innerHTML = '<span style="color:#e74c3c;">âŒ Nenhum resultado encontrado para "' + termo + '"</span>';
                    document.getElementById(resultadosId).innerHTML = '<p style="color:#e74c3c; text-align:center; padding:20px;">Nenhum resultado encontrado.<br><br>Tente:<br>â€¢ Outro nome da empresa<br>â€¢ Nome + cidade (ex: "Nervacero Bilbao")<br>â€¢ Mudar o paÃ­s de pesquisa</p>';
                } else {
                    console.error('Erro Google Places:', status);
                    document.getElementById(statusId).innerHTML = '<span style="color:#e74c3c;">âŒ Erro na pesquisa. A usar pesquisa alternativa...</span>';
                    // Fallback
                    pesquisarLocalMapaFallback(tipo, termo, pais);
                }
            });
            
        } catch (error) {
            console.error('Erro na pesquisa Google:', error);
            document.getElementById(statusId).innerHTML = '<span style="color:#e74c3c;">âŒ Erro. A usar pesquisa alternativa...</span>';
            await pesquisarLocalMapaFallback(tipo, termo, pais);
        }
    }
    
    /**
     * Fallback: Pesquisa usando Nominatim (caso Google nÃ£o funcione)
     */
    async function pesquisarLocalMapaFallback(tipo, termo, pais) {
        const statusId = tipo === 'carga' ? 'statusPesquisaCarga' : 'statusPesquisaDescarga';
        const resultadosId = tipo === 'carga' ? 'resultadosPesquisaCarga' : 'resultadosPesquisaDescarga';
        
        try {
            let url = 'https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&limit=10&q=' + encodeURIComponent(termo);
            if (pais) {
                url += '&countrycodes=' + pais;
            }
            
            const response = await fetch(url, {
                headers: { 'Accept': 'application/json', 'User-Agent': 'ERP-EMEUTRANS/6.13' }
            });
            
            const resultados = await response.json();
            
            if (resultados.length === 0) {
                document.getElementById(statusId).innerHTML = '<span style="color:#e74c3c;">âŒ Nenhum resultado encontrado</span>';
                document.getElementById(resultadosId).innerHTML = '<p style="color:#e74c3c; text-align:center; padding:20px;">Nenhum resultado encontrado.</p>';
                return;
            }
            
            document.getElementById(statusId).innerHTML = '<span style="color:#f39c12;">âš ï¸ ' + resultados.length + ' resultado(s) (pesquisa alternativa)</span>';
            mostrarResultadosFallback(tipo, resultados);
            mostrarMarcadoresFallback(tipo, resultados);
            
        } catch (error) {
            console.error('Erro fallback:', error);
            document.getElementById(statusId).innerHTML = '<span style="color:#e74c3c;">âŒ Erro na pesquisa</span>';
        }
    }
    
    /**
     * Mostra resultados do Google Places na lista
     */
    function mostrarResultadosGoogle(tipo, resultados) {
        const containerId = tipo === 'carga' ? 'resultadosPesquisaCarga' : 'resultadosPesquisaDescarga';
        let html = '';
        
        resultados.forEach((r, index) => {
            const nome = r.name || 'Sem nome';
            const endereco = r.formatted_address || '';
            const rating = r.rating ? 'â­ ' + r.rating : '';
            
            html += '<div onclick="selecionarResultadoGoogle(\'' + tipo + '\', ' + index + ')" data-index="' + index + '" data-place-id="' + r.place_id + '" style="background:white; border-radius:6px; padding:10px; margin-bottom:8px; cursor:pointer; border-left:3px solid #4285f4; transition:all 0.2s;" onmouseover="this.style.transform=\'translateX(3px)\';this.style.boxShadow=\'0 2px 8px rgba(0,0,0,0.1)\'" onmouseout="this.style.transform=\'translateX(0)\';this.style.boxShadow=\'none\'">';
            html += '<div style="font-weight:bold; color:#1e3c72; font-size:13px;">ğŸ“ ' + nome + ' ' + rating + '</div>';
            html += '<div style="font-size:11px; color:#666; margin-top:3px;">' + endereco + '</div>';
            html += '</div>';
        });
        
        document.getElementById(containerId).innerHTML = html;
        
        // Guardar resultados
        if (tipo === 'carga') {
            window.resultadosPesquisaCargaData = resultados;
        } else {
            window.resultadosPesquisaDescargaData = resultados;
        }
    }
    
    /**
     * Mostra marcadores do Google Places no mapa
     */
    function mostrarMarcadoresGoogle(tipo, resultados) {
        const map = tipo === 'carga' ? mapaLocalCargaLeaflet : mapaLocalDescargaLeaflet;
        const markersGroup = tipo === 'carga' ? markersLocalCarga : markersLocalDescarga;
        
        if (!map || !markersGroup) return;
        
        markersGroup.clearLayers();
        const bounds = [];
        
        resultados.forEach((r, index) => {
            if (!r.geometry || !r.geometry.location) return;
            
            const lat = r.geometry.location.lat();
            const lng = r.geometry.location.lng();
            const nome = r.name || 'Sem nome';
            
            bounds.push([lat, lng]);
            
            const icone = L.divIcon({
                className: 'leaflet-google-marker',
                html: '<div style="background:#4285f4;color:white;width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:bold;border:2px solid white;box-shadow:0 2px 5px rgba(0,0,0,0.3);font-size:12px;">' + (index + 1) + '</div>',
                iconSize: [28, 28],
                iconAnchor: [14, 14]
            });
            
            L.marker([lat, lng], {icon: icone})
                .bindPopup(
                    '<div style="min-width:200px;">' +
                    '<b style="color:#4285f4;">' + nome + '</b><br>' +
                    '<span style="font-size:11px;color:#666;">' + (r.formatted_address || '').substring(0, 60) + '...</span><br>' +
                    (r.rating ? '<span style="font-size:11px;">â­ ' + r.rating + '</span><br>' : '') +
                    '<button onclick="selecionarResultadoGoogle(\'' + tipo + '\', ' + index + ')" style="margin-top:8px;background:#4285f4;color:white;border:none;padding:6px 12px;border-radius:5px;cursor:pointer;width:100%;font-size:12px;">âœ… Selecionar este local</button>' +
                    '</div>'
                )
                .addTo(markersGroup);
        });
        
        if (bounds.length > 0) {
            if (bounds.length === 1) {
                map.setView(bounds[0], 15);
            } else {
                map.fitBounds(bounds, {padding: [30, 30]});
            }
        }
    }
    
    /**
     * Seleciona um resultado do Google Places e obtÃ©m detalhes completos
     */
    function selecionarResultadoGoogle(tipo, index) {
        const resultados = tipo === 'carga' ? window.resultadosPesquisaCargaData : window.resultadosPesquisaDescargaData;
        if (!resultados || !resultados[index]) return;
        
        const r = resultados[index];
        const placeId = r.place_id;
        
        // Obter detalhes completos do local
        if (googlePlacesService && placeId) {
            const request = {
                placeId: placeId,
                fields: ['name', 'formatted_address', 'address_components', 'geometry', 'formatted_phone_number', 'website', 'rating', 'opening_hours']
            };
            
            googlePlacesService.getDetails(request, function(place, status) {
                if (status === google.maps.places.PlacesServiceStatus.OK && place) {
                    processarDetalhesGoogle(tipo, place);
                } else {
                    // Usar dados bÃ¡sicos se detalhes falhar
                    processarDadosBasicos(tipo, r);
                }
            });
        } else {
            processarDadosBasicos(tipo, r);
        }
    }
    
    /**
     * Processa detalhes completos do Google Places
     */
    function processarDetalhesGoogle(tipo, place) {
        const components = place.address_components || [];
        
        // Extrair componentes da morada
        const getComponent = function(types) {
            const comp = components.find(c => types.some(t => c.types.includes(t)));
            return comp ? comp.long_name : '';
        };
        
        const dadosLocal = {
            nome: place.name || '',
            rua: getComponent(['route', 'street_address']),
            numero: getComponent(['street_number']),
            localidade: getComponent(['sublocality', 'sublocality_level_1', 'neighborhood']),
            freguesia: getComponent(['administrative_area_level_3', 'locality']),
            cp: getComponent(['postal_code']),
            cidade: getComponent(['locality', 'administrative_area_level_2']),
            concelho: getComponent(['administrative_area_level_2']),
            pais: getComponent(['country']),
            lat: place.geometry?.location?.lat() || 0,
            lng: place.geometry?.location?.lng() || 0,
            moradaCompleta: place.formatted_address || '',
            telefone: place.formatted_phone_number || '',
            website: place.website || '',
            rating: place.rating || null,
            horario: place.opening_hours?.weekday_text?.join(', ') || ''
        };
        
        mostrarDetalhesSelecionado(tipo, dadosLocal);
    }
    
    /**
     * Processa dados bÃ¡sicos quando detalhes nÃ£o disponÃ­veis
     */
    function processarDadosBasicos(tipo, r) {
        const dadosLocal = {
            nome: r.name || '',
            rua: '',
            numero: '',
            localidade: '',
            freguesia: '',
            cp: '',
            cidade: '',
            concelho: '',
            pais: '',
            lat: r.geometry?.location?.lat() || 0,
            lng: r.geometry?.location?.lng() || 0,
            moradaCompleta: r.formatted_address || '',
            telefone: '',
            website: '',
            rating: r.rating || null
        };
        
        // Tentar extrair dados da morada formatada
        const partes = (r.formatted_address || '').split(',').map(p => p.trim());
        if (partes.length >= 3) {
            dadosLocal.rua = partes[0] || '';
            dadosLocal.cidade = partes[partes.length - 2] || '';
            dadosLocal.pais = partes[partes.length - 1] || '';
            
            // Extrair cÃ³digo postal se presente
            const cpMatch = r.formatted_address.match(/\d{4,5}[-\s]?\d{0,3}/);
            if (cpMatch) {
                dadosLocal.cp = cpMatch[0];
            }
        }
        
        mostrarDetalhesSelecionado(tipo, dadosLocal);
    }
    
    /**
     * Mostra detalhes do local selecionado
     */
    function mostrarDetalhesSelecionado(tipo, dadosLocal) {
        // Guardar seleÃ§Ã£o
        if (tipo === 'carga') {
            localCargaSelecionado = dadosLocal;
        } else {
            localDescargaSelecionado = dadosLocal;
        }
        
        const detalheId = tipo === 'carga' ? 'detalheLocalCarga' : 'detalheLocalDescarga';
        const btnId = tipo === 'carga' ? 'btnPreencherCarga' : 'btnPreencherDescarga';
        
        let html = '<div style="line-height:1.6;">';
        html += '<div style="font-weight:bold; color:#1e3c72; font-size:14px; margin-bottom:8px;">ğŸ¢ ' + dadosLocal.nome + '</div>';
        if (dadosLocal.rating) html += '<div style="font-size:12px; color:#f39c12; margin-bottom:5px;">â­ ' + dadosLocal.rating + '</div>';
        html += '<div style="font-size:12px; color:#495057;">';
        if (dadosLocal.moradaCompleta) html += 'ğŸ“ ' + dadosLocal.moradaCompleta + '<br>';
        if (dadosLocal.telefone) html += 'ğŸ“ ' + dadosLocal.telefone + '<br>';
        if (dadosLocal.website) html += 'ğŸŒ <a href="' + dadosLocal.website + '" target="_blank" style="color:#4285f4;">Website</a><br>';
        html += '</div>';
        html += '<div style="margin-top:10px; padding-top:10px; border-top:1px solid #eee; font-size:11px; color:#666;">';
        html += '<b>Dados extraÃ­dos:</b><br>';
        if (dadosLocal.rua) html += 'Rua: ' + dadosLocal.rua + (dadosLocal.numero ? ', ' + dadosLocal.numero : '') + '<br>';
        if (dadosLocal.cp) html += 'CP: ' + dadosLocal.cp + '<br>';
        if (dadosLocal.cidade) html += 'Cidade: ' + dadosLocal.cidade + '<br>';
        if (dadosLocal.pais) html += 'PaÃ­s: ' + dadosLocal.pais + '<br>';
        html += '</div>';
        html += '</div>';
        
        document.getElementById(detalheId).innerHTML = html;
        document.getElementById(btnId).style.display = 'block';
        
        // Centrar mapa
        const map = tipo === 'carga' ? mapaLocalCargaLeaflet : mapaLocalDescargaLeaflet;
        if (map && dadosLocal.lat && dadosLocal.lng) {
            map.setView([dadosLocal.lat, dadosLocal.lng], 16);
        }
        
        console.log('âœ… Local selecionado (' + tipo + '):', dadosLocal);
    }
    
    // Fallback functions para Nominatim (mantidas para backup)
    function mostrarResultadosFallback(tipo, resultados) {
        const containerId = tipo === 'carga' ? 'resultadosPesquisaCarga' : 'resultadosPesquisaDescarga';
        let html = '';
        
        resultados.forEach((r, index) => {
            const nome = r.display_name.split(',')[0];
            const morada = r.display_name.split(',').slice(1, 4).join(',');
            
            html += '<div onclick="selecionarResultadoFallback(\'' + tipo + '\', ' + index + ')" data-index="' + index + '" style="background:white; border-radius:6px; padding:10px; margin-bottom:8px; cursor:pointer; border-left:3px solid #f39c12; transition:all 0.2s;" onmouseover="this.style.transform=\'translateX(3px)\'" onmouseout="this.style.transform=\'translateX(0)\'">';
            html += '<div style="font-weight:bold; color:#1e3c72; font-size:13px;">ğŸ“ ' + nome + '</div>';
            html += '<div style="font-size:11px; color:#666; margin-top:3px;">' + morada + '</div>';
            html += '</div>';
        });
        
        document.getElementById(containerId).innerHTML = html;
        
        if (tipo === 'carga') {
            window.resultadosPesquisaCargaDataFallback = resultados;
        } else {
            window.resultadosPesquisaDescargaDataFallback = resultados;
        }
    }
    
    function mostrarMarcadoresFallback(tipo, resultados) {
        const map = tipo === 'carga' ? mapaLocalCargaLeaflet : mapaLocalDescargaLeaflet;
        const markersGroup = tipo === 'carga' ? markersLocalCarga : markersLocalDescarga;
        
        if (!map || !markersGroup) return;
        markersGroup.clearLayers();
        const bounds = [];
        
        resultados.forEach((r, index) => {
            const lat = parseFloat(r.lat);
            const lng = parseFloat(r.lon);
            bounds.push([lat, lng]);
            
            const icone = L.divIcon({
                className: 'leaflet-fallback-marker',
                html: '<div style="background:#f39c12;color:white;width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:bold;border:2px solid white;box-shadow:0 2px 5px rgba(0,0,0,0.3);font-size:12px;">' + (index + 1) + '</div>',
                iconSize: [28, 28],
                iconAnchor: [14, 14]
            });
            
            L.marker([lat, lng], {icon: icone}).addTo(markersGroup);
        });
        
        if (bounds.length > 0) {
            bounds.length === 1 ? map.setView(bounds[0], 15) : map.fitBounds(bounds, {padding: [30, 30]});
        }
    }
    
    function selecionarResultadoFallback(tipo, index) {
        const resultados = tipo === 'carga' ? window.resultadosPesquisaCargaDataFallback : window.resultadosPesquisaDescargaDataFallback;
        if (!resultados || !resultados[index]) return;
        
        const r = resultados[index];
        const addr = r.address || {};
        
        const dadosLocal = {
            nome: r.display_name.split(',')[0],
            rua: addr.road || addr.street || '',
            numero: addr.house_number || '',
            localidade: addr.suburb || addr.neighbourhood || '',
            freguesia: addr.town || addr.municipality || '',
            cp: addr.postcode || '',
            cidade: addr.city || addr.town || '',
            concelho: addr.county || '',
            pais: addr.country || '',
            lat: parseFloat(r.lat),
            lng: parseFloat(r.lon),
            moradaCompleta: r.display_name
        };
        
        mostrarDetalhesSelecionado(tipo, dadosLocal);
    }
    
    /**
     * Preenche formulÃ¡rio de carga com os dados do local selecionado
     * Campos: R26-R34
     */
    function preencherFormularioCarga() {
        if (!localCargaSelecionado) {
            alert('âš ï¸ Nenhum local selecionado!');
            return;
        }
        
        const dados = localCargaSelecionado;
        
        // Preencher campos R26-R34
        document.getElementById('empresa_carga').value = dados.nome || '';      // R26
        document.getElementById('carga_rua').value = dados.rua || '';           // R27
        document.getElementById('carga_nr').value = dados.numero || 'S/N';      // R28
        document.getElementById('carga_local').value = dados.localidade || dados.freguesia || ''; // R29
        document.getElementById('carga_freg').value = dados.freguesia || '';    // R30
        document.getElementById('carga_cp').value = dados.cp || '';             // R31
        document.getElementById('carga_cidade').value = dados.cidade || '';     // R32
        document.getElementById('carga_concelho').value = dados.concelho || ''; // R33
        document.getElementById('carga_pais').value = dados.pais || 'Portugal'; // R34
        
        // Fechar modal
        fecharModalReservas('modalLocalCarga');
        
        // Feedback visual
        const secao3 = document.getElementById('secao3');
        if (secao3) {
            secao3.style.transition = 'background 0.3s';
            secao3.style.background = '#d4edda';
            setTimeout(() => { secao3.style.background = ''; }, 1500);
        }
        
        alert('âœ… Morada de CARGA preenchida!\n\nğŸ¢ ' + dados.nome + '\nğŸ“ ' + (dados.moradaCompleta || dados.rua));
        
        console.log('âœ… FormulÃ¡rio de CARGA preenchido com:', dados);
    }
    
    /**
     * Preenche formulÃ¡rio de descarga com os dados do local selecionado
     * Campos: R45-R53
     */
    function preencherFormularioDescarga() {
        if (!localDescargaSelecionado) {
            alert('âš ï¸ Nenhum local selecionado!');
            return;
        }
        
        const dados = localDescargaSelecionado;
        
        // Preencher campos R45-R53
        document.getElementById('empresa_descarga').value = dados.nome || '';      // R45
        document.getElementById('descarga_rua').value = dados.rua || '';           // R46
        document.getElementById('descarga_nr').value = dados.numero || 'S/N';      // R47
        document.getElementById('descarga_local').value = dados.localidade || dados.freguesia || ''; // R48
        document.getElementById('descarga_freg').value = dados.freguesia || '';    // R49
        document.getElementById('descarga_cp').value = dados.cp || '';             // R50
        document.getElementById('descarga_cidade').value = dados.cidade || '';     // R51
        document.getElementById('descarga_concelho').value = dados.concelho || ''; // R52
        document.getElementById('descarga_pais').value = dados.pais || 'Portugal'; // R53
        
        // Fechar modal
        fecharModalReservas('modalLocalDescarga');
        
        // Feedback visual
        const secao4 = document.getElementById('secao4');
        if (secao4) {
            secao4.style.transition = 'background 0.3s';
            secao4.style.background = '#fff3cd';
            setTimeout(() => { secao4.style.background = ''; }, 1500);
        }
        
        alert('âœ… Morada de DESCARGA preenchida!\n\nğŸ¢ ' + dados.nome + '\nğŸ“ ' + (dados.moradaCompleta || dados.rua));
        
        console.log('âœ… FormulÃ¡rio de DESCARGA preenchido com:', dados);
    }
    
    // Permitir pesquisar com Enter
    document.addEventListener('DOMContentLoaded', function() {
        setTimeout(function() {
            const inputCarga = document.getElementById('pesquisaLocalCarga');
            const inputDescarga = document.getElementById('pesquisaLocalDescarga');
            
            if (inputCarga) {
                inputCarga.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        pesquisarLocalMapa('carga');
                    }
                });
            }
            
            if (inputDescarga) {
                inputDescarga.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        pesquisarLocalMapa('descarga');
                    }
                });
            }
        }, 1000);
    });
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // FIM - FUNÃ‡Ã•ES VER LOCAL DE CARGA / DESCARGA (Google Places API)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ğŸ“„ FUNÃ‡Ã•ES PARA LER ORDEM DE CARGA - OCR (v6.13)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    var ordemCargaTextoAtual = '';
    var ordemCargaCamposExtraidos = {};
    
    /**
     * Abre o modal de Ordem de Carga
     */
    function abrirModalOrdemCarga() {
        limparOrdemCarga();
        document.getElementById('modalOrdemCarga').classList.add('active');
    }
    
    /**
     * Limpa todos os dados da ordem de carga
     */
    function limparOrdemCarga() {
        ordemCargaTextoAtual = '';
        ordemCargaCamposExtraidos = {};
        
        // Reset upload
        document.getElementById('inputOrdemCarga').value = '';
        document.getElementById('zonaUploadOrdem').style.display = 'block';
        
        // Esconder secÃ§Ãµes
        document.getElementById('progressoOrdemCarga').style.display = 'none';
        document.getElementById('previewOrdemCarga').style.display = 'none';
        document.getElementById('textoExtraidoContainer').style.display = 'none';
        document.getElementById('camposIdentificados').style.display = 'none';
        document.getElementById('btnPreencherReserva').style.display = 'none';
        
        // Limpar campos
        const camposOCR = ['ocr_cliente', 'ocr_referencia', 'ocr_ldm', 'ocr_bultos', 'ocr_peso',
            'ocr_empresa_carga', 'ocr_morada_carga', 'ocr_cp_carga', 'ocr_cidade_carga', 'ocr_data_carga', 'ocr_hora_carga',
            'ocr_empresa_descarga', 'ocr_morada_descarga', 'ocr_cp_descarga', 'ocr_cidade_descarga', 'ocr_pais_descarga',
            'ocr_data_descarga', 'ocr_hora_descarga', 'ocr_observacoes'];
        camposOCR.forEach(id => {
            const el = document.getElementById(id);
            if (el) el.value = '';
        });
        
        document.getElementById('textoExtraido').value = '';
        document.getElementById('previewContainer').innerHTML = '';
    }
    
    /**
     * Handle drag & drop
     */
    function handleDropOrdemCarga(event) {
        event.preventDefault();
        document.getElementById('zonaUploadOrdem').style.background = '#f8f9ff';
        document.getElementById('zonaUploadOrdem').style.borderColor = '#667eea';
        
        const files = event.dataTransfer.files;
        if (files.length > 0) {
            processarOrdemCarga(files[0]);
        }
    }
    
    /**
     * Processa o ficheiro da ordem de carga
     */
    async function processarOrdemCarga(file) {
        if (!file) return;
        
        // Verificar tamanho
        if (file.size > 10 * 1024 * 1024) {
            alert('âš ï¸ Ficheiro muito grande! Tamanho mÃ¡ximo: 10 MB');
            return;
        }
        
        // Verificar tipo
        const tiposPermitidos = ['application/pdf', 'image/png', 'image/jpeg', 'image/jpg', 'image/gif', 'image/bmp', 'image/webp'];
        if (!tiposPermitidos.includes(file.type) && !file.name.toLowerCase().endsWith('.pdf')) {
            alert('âš ï¸ Tipo de ficheiro nÃ£o suportado!\n\nFormatos aceites: PDF, PNG, JPG, JPEG, GIF, BMP, WEBP');
            return;
        }
        
        // Esconder zona de upload e mostrar progresso
        document.getElementById('zonaUploadOrdem').style.display = 'none';
        document.getElementById('progressoOrdemCarga').style.display = 'block';
        atualizarProgressoOrdem(0, 'A iniciar processamento...');
        
        try {
            let textoExtraido = '';
            
            if (file.type === 'application/pdf' || file.name.toLowerCase().endsWith('.pdf')) {
                // Processar PDF
                textoExtraido = await processarPDF(file);
            } else {
                // Processar Imagem com OCR
                textoExtraido = await processarImagem(file);
            }
            
            if (!textoExtraido || textoExtraido.trim().length < 10) {
                throw new Error('NÃ£o foi possÃ­vel extrair texto do documento. Tente com uma imagem mais clara ou um PDF com texto selecionÃ¡vel.');
            }
            
            ordemCargaTextoAtual = textoExtraido;
            
            // Mostrar texto extraÃ­do
            document.getElementById('textoExtraido').value = textoExtraido;
            document.getElementById('textoExtraidoContainer').style.display = 'block';
            
            // Analisar e extrair campos
            atualizarProgressoOrdem(90, 'A identificar campos...');
            await analisarTextoOrdemCarga(textoExtraido);
            
            // Mostrar preview
            mostrarPreviewDocumento(file);
            
            // Completar
            atualizarProgressoOrdem(100, 'âœ… Documento processado com sucesso!');
            setTimeout(() => {
                document.getElementById('progressoOrdemCarga').style.display = 'none';
                document.getElementById('camposIdentificados').style.display = 'block';
                document.getElementById('btnPreencherReserva').style.display = 'inline-block';
            }, 500);
            
        } catch (error) {
            console.error('Erro ao processar ordem de carga:', error);
            alert('âŒ Erro ao processar documento:\n\n' + error.message);
            limparOrdemCarga();
        }
    }
    
    /**
     * Atualiza barra de progresso
     */
    function atualizarProgressoOrdem(percentagem, texto) {
        document.getElementById('barraProgressoOrdem').style.width = percentagem + '%';
        document.getElementById('statusOrdemCarga').textContent = texto;
    }
    
    /**
     * Processa PDF e extrai texto
     */
    async function processarPDF(file) {
        atualizarProgressoOrdem(10, 'A carregar PDF...');
        
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    if (typeof pdfjsLib === 'undefined') {
                        throw new Error('Biblioteca PDF.js nÃ£o carregada');
                    }
                    
                    atualizarProgressoOrdem(30, 'A extrair texto do PDF...');
                    
                    const typedarray = new Uint8Array(e.target.result);
                    const pdf = await pdfjsLib.getDocument(typedarray).promise;
                    
                    let textoCompleto = '';
                    const numPaginas = pdf.numPages;
                    
                    for (let i = 1; i <= Math.min(numPaginas, 5); i++) { // MÃ¡ximo 5 pÃ¡ginas
                        atualizarProgressoOrdem(30 + (i / numPaginas) * 40, 'A processar pÃ¡gina ' + i + ' de ' + numPaginas + '...');
                        
                        const page = await pdf.getPage(i);
                        const textContent = await page.getTextContent();
                        const textosPagina = textContent.items.map(item => item.str).join(' ');
                        textoCompleto += textosPagina + '\n\n';
                    }
                    
                    resolve(textoCompleto);
                } catch (err) {
                    reject(err);
                }
            };
            reader.onerror = () => reject(new Error('Erro ao ler ficheiro PDF'));
            reader.readAsArrayBuffer(file);
        });
    }
    
    /**
     * Processa Imagem com OCR (Tesseract.js)
     */
    async function processarImagem(file) {
        atualizarProgressoOrdem(10, 'A carregar imagem...');
        
        return new Promise((resolve, reject) => {
            if (typeof Tesseract === 'undefined') {
                reject(new Error('Biblioteca Tesseract.js nÃ£o carregada'));
                return;
            }
            
            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    atualizarProgressoOrdem(20, 'A iniciar OCR (pode demorar 30-60 segundos)...');
                    
                    const result = await Tesseract.recognize(
                        e.target.result,
                        'por+eng+spa+fra+deu+pol+ita+nld', // PortuguÃªs, InglÃªs, Espanhol, FrancÃªs, AlemÃ£o, Polaco, Italiano, HolandÃªs
                        {
                            logger: m => {
                                if (m.status === 'recognizing text') {
                                    const progresso = 20 + (m.progress * 60);
                                    atualizarProgressoOrdem(progresso, 'OCR em progresso: ' + Math.round(m.progress * 100) + '%');
                                }
                            }
                        }
                    );
                    
                    resolve(result.data.text);
                } catch (err) {
                    reject(err);
                }
            };
            reader.onerror = () => reject(new Error('Erro ao ler imagem'));
            reader.readAsDataURL(file);
        });
    }
    
    /**
     * Mostra preview do documento
     */
    function mostrarPreviewDocumento(file) {
        const container = document.getElementById('previewContainer');
        
        if (file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = function(e) {
                container.innerHTML = '<img src="' + e.target.result + '" style="max-width:100%; max-height:180px; border-radius:5px;">';
            };
            reader.readAsDataURL(file);
        } else {
            container.innerHTML = '<div style="text-align:center; padding:30px;"><span style="font-size:40px;">ğŸ“„</span><br><strong>' + file.name + '</strong><br><span style="color:#666; font-size:12px;">' + (file.size / 1024).toFixed(1) + ' KB</span></div>';
        }
        
        document.getElementById('previewOrdemCarga').style.display = 'block';
    }
    
    /**
     * Analisa o texto extraÃ­do e identifica campos
     */
    async function analisarTextoOrdemCarga(texto) {
        const textoLower = texto.toLowerCase();
        const textoNormalizado = texto.replace(/\s+/g, ' ').trim();
        
        ordemCargaCamposExtraidos = {};
        
        // === PADRÃ•ES DE EXTRAÃ‡ÃƒO (MULTI-IDIOMA) ===
        
        // Cliente / Expedidor / Remetente
        // PT: cliente, expedidor, remetente | EN: shipper, sender, consignor | ES: remitente, expedidor
        // DE: Absender, Versender, Auftraggeber | FR: expÃ©diteur, envoyeur | PL: nadawca, wysyÅ‚ajÄ…cy
        // IT: mittente, speditore | NL: afzender, verzender
        const clientePatterns = [
            /(?:cliente|expedidor|remetente|shipper|sender|consignor|remitente|absender|versender|auftraggeber|exp[Ã©e]diteur|envoyeur|nadawca|wysy[Å‚l]aj[aÄ…]cy|mittente|speditore|afzender|verzender)[:\s]*([^\n]{3,50})/i,
            /(?:de|from|von|du|od|da|van)[:\s]*([A-Z][^\n]{3,50})/i
        ];
        for (const pattern of clientePatterns) {
            const match = texto.match(pattern);
            if (match) {
                ordemCargaCamposExtraidos.cliente = match[1].trim();
                break;
            }
        }
        
        // ReferÃªncia / Pedido / Ordem
        // PT: referÃªncia, pedido, ordem | EN: reference, order | ES: referencia, pedido
        // DE: Referenz, Bestellung, Auftrag | FR: rÃ©fÃ©rence, commande | PL: referencja, zamÃ³wienie
        // IT: riferimento, ordine | NL: referentie, bestelling
        const refPatterns = [
            /(?:refer[ÃªeÃ©]n(?:cia|ce|z)|ref\.?|order|pedido|ordem|bestellung|auftrag|commande|zam[oÃ³]wienie|ordine|bestelling|n[ÂºoÂ°]?\s*ordem)[:\s#]*([A-Z0-9\-\/]{3,30})/i,
            /(?:PO|SO|OC|OV|AB|BE|CMD)[:\s#-]*([A-Z0-9\-\/]{3,20})/i
        ];
        for (const pattern of refPatterns) {
            const match = texto.match(pattern);
            if (match) {
                ordemCargaCamposExtraidos.referencia = match[1].trim();
                break;
            }
        }
        
        // LDM / Metros Lineares
        // PT: metros lineares | EN: linear meters, loading meters | ES: metros lineales
        // DE: Lademeter, laufende Meter | FR: mÃ¨tres linÃ©aires, mÃ¨tres de plancher
        // PL: metry Å‚adunkowe | IT: metri lineari | NL: laadmeters, strekkende meters
        const ldmPatterns = [
            /(?:ldm|metros?\s*lineares?|linear\s*meters?|loading\s*meters?|metros?\s*lineales?|lademeter|laufende\s*meter|m[eÃ¨]tres?\s*lin[eÃ©]aires?|m[eÃ¨]tres?\s*de\s*plancher|metry\s*[Å‚l]adunkowe|metri\s*lineari|laadmeters?|strekkende\s*meters?)[:\s]*([0-9]+[,.]?[0-9]*)\s*(?:m|ldm)?/i,
            /([0-9]+[,.]?[0-9]*)\s*(?:ldm|ml|lm|metros?\s*lineares?|linear\s*m|lademeter)/i
        ];
        for (const pattern of ldmPatterns) {
            const match = texto.match(pattern);
            if (match) {
                ordemCargaCamposExtraidos.ldm = match[1].replace(',', '.');
                break;
            }
        }
        
        // NÃºmero de Bultos / Volumes / Paletes
        // PT: bultos, volumes, paletes | EN: packages, pallets, pieces | ES: bultos, palets
        // DE: PackstÃ¼cke, Paletten, StÃ¼ck, Kolli | FR: colis, palettes, piÃ¨ces
        // PL: paczki, palety, sztuk | IT: colli, pallet, pezzi | NL: colli, pallets, stuks
        const bultosPatterns = [
            /(?:bultos?|volumes?|paletes?|pallets?|palets?|caixas?|packages?|pieces?|packst[Ã¼u]cke?|st[Ã¼u]ck|kolli|colis|palettes?|pi[eÃ¨]ces?|paczki?|palety?|sztuk|pallet|pezzi|stuks?|qty|quantidade|quantity|menge|quantit[eÃ©]|ilo[sÅ›][cÄ‡])[:\s]*([0-9]+)/i,
            /([0-9]+)\s*(?:bultos?|volumes?|paletes?|pallets?|plt|pcs|un|stk|stÃ¼ck|colli|pz|szt)/i
        ];
        for (const pattern of bultosPatterns) {
            const match = texto.match(pattern);
            if (match) {
                ordemCargaCamposExtraidos.bultos = match[1];
                break;
            }
        }
        
        // Peso
        // PT: peso, bruto | EN: weight, gross weight | ES: peso, bruto
        // DE: Gewicht, Bruttogewicht | FR: poids, poids brut | PL: waga, masa brutto
        // IT: peso, peso lordo | NL: gewicht, brutogewicht
        const pesoPatterns = [
            /(?:peso|weight|gross\s*weight|bruto|gewicht|bruttogewicht|poids|poids\s*brut|waga|masa\s*brutto|peso\s*lordo|brutogewicht)[:\s]*([0-9]+[,.]?[0-9]*)\s*(?:kg|ton|t)?/i,
            /([0-9]+[,.]?[0-9]*)\s*(?:kg|ton|t)\s*(?:bruto|gross|brut|lordo)?/i
        ];
        for (const pattern of pesoPatterns) {
            const match = texto.match(pattern);
            if (match) {
                ordemCargaCamposExtraidos.peso = match[1].replace(',', '.');
                break;
            }
        }
        
        // === LOCAL DE CARGA ===
        
        // Empresa de Carga
        // PT: local de carga, carregar em | EN: loading, pick up, origin | ES: carga, origen
        // DE: Beladung, Ladestelle, Abholung | FR: chargement, enlÃ¨vement | PL: zaÅ‚adunek, miejsce zaÅ‚adunku
        // IT: carico, punto di carico | NL: laden, laadplaats, ophalen
        const cargaPatterns = [
            /(?:local\s*(?:de\s*)?carga|loading|pick\s*up|origin|carga\s*em|carregar\s*em|origen|beladung|ladestelle|abholung|chargement|enl[eÃ¨]vement|za[Å‚l]adunek|miejsce\s*za[Å‚l]adunku|carico|punto\s*di\s*carico|laden|laadplaats|ophalen)[:\s]*([^\n]{3,60})/i,
            /(?:from|de|von|du|od|da|van|ab)[:\s]*([A-Z][A-Za-z\s\-\.]{3,50}?)(?=\n|,|\s{2})/i
        ];
        for (const pattern of cargaPatterns) {
            const match = texto.match(pattern);
            if (match) {
                ordemCargaCamposExtraidos.empresa_carga = match[1].trim();
                break;
            }
        }
        
        // CÃ³digo Postal de Carga (formato europeu - 4 a 5 dÃ­gitos)
        const cpCargaMatch = texto.match(/(?:carga|loading|origin|from|beladung|chargement|za[Å‚l]adunek|carico|laden)[^]*?([0-9]{4,5}[\s\-]?[0-9]{0,3})/i);
        if (cpCargaMatch) {
            ordemCargaCamposExtraidos.cp_carga = cpCargaMatch[1].trim();
        }
        
        // === LOCAL DE DESCARGA ===
        
        // Empresa de Descarga
        // PT: local de descarga, entregar em, destinatÃ¡rio | EN: unloading, delivery, destination | ES: descarga, destino
        // DE: Entladung, Entladestelle, Lieferung, EmpfÃ¤nger | FR: dÃ©chargement, livraison, destinataire
        // PL: rozÅ‚adunek, miejsce rozÅ‚adunku, odbiorca | IT: scarico, consegna, destinatario | NL: lossen, levering, ontvanger
        const descargaPatterns = [
            /(?:local\s*(?:de\s*)?descarga|unloading|delivery|destination|destino?|descarga\s*em|entregar?\s*em|destinat[aÃ¡]rio|entladung|entladestelle|lieferung|empf[aÃ¤]nger|d[eÃ©]chargement|livraison|roz[Å‚l]adunek|miejsce\s*roz[Å‚l]adunku|odbiorca|scarico|consegna|lossen|levering|ontvanger)[:\s]*([^\n]{3,60})/i,
            /(?:to|para|a|nach|zu|vers|[aÃ ]|do|naar|an)[:\s]*([A-Z][A-Za-z\s\-\.]{3,50}?)(?=\n|,|\s{2})/i
        ];
        for (const pattern of descargaPatterns) {
            const match = texto.match(pattern);
            if (match) {
                ordemCargaCamposExtraidos.empresa_descarga = match[1].trim();
                break;
            }
        }
        
        // CÃ³digo Postal de Descarga
        const cpDescargaMatch = texto.match(/(?:descarga|unloading|delivery|destino|to|entladung|livraison|roz[Å‚l]adunek|scarico|lossen)[^]*?([0-9]{4,5}[\s\-]?[0-9]{0,3})/i);
        if (cpDescargaMatch && cpDescargaMatch[1] !== ordemCargaCamposExtraidos.cp_carga) {
            ordemCargaCamposExtraidos.cp_descarga = cpDescargaMatch[1].trim();
        }
        
        // Todos os cÃ³digos postais encontrados (formatos europeus)
        // PT: 1234-567 | ES: 12345 | FR: 12345 | DE: 12345 | PL: 12-345 | IT: 12345 | NL: 1234 AB
        const todosCP = texto.match(/[0-9]{4,5}[\s\-]?[0-9]{0,3}[A-Z]{0,2}/g);
        if (todosCP && todosCP.length >= 2) {
            if (!ordemCargaCamposExtraidos.cp_carga) ordemCargaCamposExtraidos.cp_carga = todosCP[0];
            if (!ordemCargaCamposExtraidos.cp_descarga) ordemCargaCamposExtraidos.cp_descarga = todosCP[todosCP.length - 1];
        }
        
        // === DATAS ===
        
        const datasEncontradas = texto.match(/([0-9]{1,2})[\/\-\.]([0-9]{1,2})[\/\-\.]([0-9]{2,4})/g);
        if (datasEncontradas && datasEncontradas.length >= 1) {
            const primeiraData = datasEncontradas[0];
            const [dia, mes, ano] = primeiraData.split(/[\/\-\.]/);
            const anoCompleto = ano.length === 2 ? '20' + ano : ano;
            ordemCargaCamposExtraidos.data_carga = anoCompleto + '-' + mes.padStart(2, '0') + '-' + dia.padStart(2, '0');
            
            if (datasEncontradas.length >= 2) {
                const segundaData = datasEncontradas[datasEncontradas.length - 1];
                const [dia2, mes2, ano2] = segundaData.split(/[\/\-\.]/);
                const anoCompleto2 = ano2.length === 2 ? '20' + ano2 : ano2;
                ordemCargaCamposExtraidos.data_descarga = anoCompleto2 + '-' + mes2.padStart(2, '0') + '-' + dia2.padStart(2, '0');
            }
        }
        
        // === HORAS ===
        
        const horasEncontradas = texto.match(/([0-9]{1,2})[:\.]([0-9]{2})(?:\s*(?:h|hrs?|horas?))?/gi);
        if (horasEncontradas) {
            for (const hora of horasEncontradas) {
                const [h, m] = hora.split(/[:\.]/).map(n => parseInt(n.replace(/\D/g, '')));
                if (h >= 0 && h <= 23 && m >= 0 && m <= 59) {
                    if (!ordemCargaCamposExtraidos.hora_carga) {
                        ordemCargaCamposExtraidos.hora_carga = h.toString().padStart(2, '0') + ':' + m.toString().padStart(2, '0');
                    } else if (!ordemCargaCamposExtraidos.hora_descarga) {
                        ordemCargaCamposExtraidos.hora_descarga = h.toString().padStart(2, '0') + ':' + m.toString().padStart(2, '0');
                    }
                }
            }
        }
        
        // === CIDADES (procurar no texto) ===
        
        const cidadesConhecidas = [
            // Portugal
            'Lisboa', 'Porto', 'Faro', 'Braga', 'Coimbra', 'SetÃºbal', 'Aveiro', 'Leiria', 'Ã‰vora', 'Viseu', 'GuimarÃ£es', 'Funchal',
            // Espanha
            'Madrid', 'Barcelona', 'Valencia', 'Sevilla', 'Bilbao', 'Zaragoza', 'MÃ¡laga', 'Murcia', 'Palma', 'Alicante', 'Vigo', 'GijÃ³n',
            // FranÃ§a
            'Paris', 'Lyon', 'Marseille', 'Toulouse', 'Bordeaux', 'Lille', 'Nice', 'Nantes', 'Strasbourg', 'Montpellier', 'Rennes', 'Le Havre',
            // Alemanha
            'Berlin', 'Munich', 'Hamburg', 'Frankfurt', 'Cologne', 'Stuttgart', 'DÃ¼sseldorf', 'Dortmund', 'Essen', 'Leipzig', 'Bremen', 'Dresden', 'Hannover', 'NÃ¼rnberg', 'Duisburg', 'Bochum', 'Wuppertal', 'Bielefeld', 'Bonn', 'MÃ¼nster', 'Karlsruhe', 'Mannheim', 'Augsburg', 'Wiesbaden', 'Gelsenkirchen', 'MÃ¶nchengladbach', 'Braunschweig', 'Chemnitz', 'Kiel', 'Aachen', 'Halle', 'Magdeburg', 'Freiburg', 'Krefeld', 'LÃ¼beck', 'Oberhausen', 'Erfurt', 'Mainz', 'Rostock', 'Kassel', 'Hagen', 'Hamm', 'SaarbrÃ¼cken', 'MÃ¼lheim', 'Potsdam', 'Ludwigshafen', 'Oldenburg', 'Leverkusen', 'OsnabrÃ¼ck', 'Solingen', 'Heidelberg', 'Herne', 'Neuss', 'Darmstadt', 'Paderborn', 'Regensburg', 'Ingolstadt', 'WÃ¼rzburg', 'Wolfsburg', 'FÃ¼rth', 'Ulm', 'Heilbronn', 'Pforzheim', 'GÃ¶ttingen', 'Bottrop', 'Trier', 'Recklinghausen', 'Reutlingen', 'Bremerhaven', 'Koblenz', 'Bergisch Gladbach', 'Jena', 'Remscheid', 'Erlangen', 'Moers', 'Siegen', 'Hildesheim', 'Salzgitter',
            // PolÃ³nia
            'Warszawa', 'Warsaw', 'VarsÃ³via', 'KrakÃ³w', 'CracÃ³via', 'ÅÃ³dÅº', 'WrocÅ‚aw', 'PoznaÅ„', 'GdaÅ„sk', 'Szczecin', 'Bydgoszcz', 'Lublin', 'BiaÅ‚ystok', 'Katowice', 'Gdynia', 'CzÄ™stochowa', 'Radom', 'Sosnowiec', 'ToruÅ„', 'Kielce', 'Gliwice', 'Zabrze', 'Bytom', 'Olsztyn', 'Bielsko-BiaÅ‚a', 'RzeszÃ³w', 'Ruda ÅšlÄ…ska', 'Rybnik', 'Tychy', 'DÄ…browa GÃ³rnicza', 'PÅ‚ock', 'ElblÄ…g', 'Opole', 'GorzÃ³w Wielkopolski', 'WaÅ‚brzych', 'Zielona GÃ³ra', 'WÅ‚ocÅ‚awek', 'TarnÃ³w', 'ChorzÃ³w', 'Koszalin', 'Kalisz', 'Legnica', 'GrudziÄ…dz', 'Jaworzno', 'SÅ‚upsk', 'JastrzÄ™bie-ZdrÃ³j', 'Nowy SÄ…cz', 'Jelenia GÃ³ra', 'Siedlce', 'MysÅ‚owice', 'Konin', 'PiÅ‚a', 'PiotrkÃ³w Trybunalski', 'InowrocÅ‚aw', 'Lubin', 'OstrÃ³w Wielkopolski', 'SuwaÅ‚ki', 'Stargard', 'Gniezno', 'Ostrowiec ÅšwiÄ™tokrzyski', 'Siemianowice ÅšlÄ…skie', 'GÅ‚ogÃ³w', 'Pabianice', 'Leszno', 'Å»ory', 'PruszkÃ³w', 'ZamoÅ›Ä‡', 'ÅomÅ¼a', 'EÅ‚k', 'TomaszÃ³w Mazowiecki', 'CheÅ‚m', 'Mielec', 'KÄ™dzierzyn-KoÅºle', 'PrzemyÅ›l', 'Stalowa Wola', 'Tczew', 'BiaÅ‚a Podlaska', 'BeÅ‚chatÃ³w', 'Åšwidnica', 'BÄ™dzin', 'Zgierz', 'Piekary ÅšlÄ…skie', 'RacibÃ³rz', 'Legionowo', 'OÅ›wiÄ™cim',
            // ItÃ¡lia
            'Roma', 'Milano', 'Napoli', 'Torino', 'Palermo', 'Genova', 'Bologna', 'Firenze', 'Bari', 'Catania', 'Venezia', 'Verona', 'Messina', 'Padova', 'Trieste', 'Taranto', 'Brescia', 'Parma', 'Prato', 'Modena', 'Reggio Calabria', 'Reggio Emilia', 'Perugia', 'Ravenna', 'Livorno', 'Cagliari', 'Foggia', 'Rimini', 'Salerno', 'Ferrara', 'Sassari', 'Latina', 'Giugliano', 'Monza', 'Siracusa', 'Pescara', 'Bergamo', 'ForlÃ¬', 'Trento', 'Vicenza', 'Terni', 'Bolzano', 'Novara', 'Piacenza', 'Ancona', 'Andria', 'Arezzo', 'Udine', 'Cesena', 'Lecce', 'Pesaro', 'Barletta', 'Alessandria', 'La Spezia', 'Pisa', 'Catanzaro', 'Brindisi', 'Lucca', 'Como', 'Treviso', 'Marsala', 'Grosseto', 'Varese', 'Caserta', 'Asti', 'Ragusa', 'Cremona', 'Cosenza', 'Massa', 'Trapani', 'Potenza', 'Viterbo', 'Crotone', 'Caltanissetta', 'Benevento', 'Matera', 'Pavia', 'Lodi', 'Campobasso', 'Agrigento', 'Fermo', 'Trani', 'Savona', 'Carrara', 'Vercelli', 'Olbia', 'Sanremo',
            // Holanda
            'Amsterdam', 'Rotterdam', 'Den Haag', 'The Hague', 'Utrecht', 'Eindhoven', 'Tilburg', 'Groningen', 'Almere', 'Breda', 'Nijmegen', 'Enschede', 'Haarlem', 'Arnhem', 'Zaanstad', 'Amersfoort', 'Apeldoorn', 'Hoofddorp', 'Maastricht', 'Leiden', 'Dordrecht', 'Zoetermeer', 'Zwolle', 'Deventer', 'Delft', 'Alkmaar', 'Heerlen', 'Venlo', 'Leeuwarden', 'Amstelveen', 'Helmond', 'Hilversum', 'Oss', 'Schiedam', 'Spijkenisse', 'Purmerend', 'Roosendaal', 'Vlaardingen', 'Almelo', 'Gouda', 'Middelburg', 'Ede', 'Bergen op Zoom', 'Veenendaal', 'Capelle aan den IJssel', 'Nieuwegein', 'Zeist', 'Hardenberg', 'Doetinchem', 'Lelystad', 'Terneuzen', 'Kampen', 'Weert', 'Woerden', 'Heerhugowaard', 'Barneveld', 'Drachten', 'Veldhoven', 'Den Helder', 'Roermond', 'Kerkrade', 'Hoorn', 'Hengelo', 'Rijswijk', 'Schagen', 'Hoogeveen', 'Heemskerk', 'Beverwijk', 'Ten Boer', 'Harderwijk', 'Tiel', 'Waalwijk', 'Emmen', 'Bussum', 'Meppel', 'Huizen', 'Steenwijk', 'Coevorden', 'Gorinchem', 'Waddinxveen', 'Zevenaar', 'Culemborg', 'Zwijndrecht', 'Soest', 'Oldenzaal', 'Zutphen',
            // BÃ©lgica
            'Bruxelles', 'Brussels', 'Antwerpen', 'Gent', 'Charleroi', 'LiÃ¨ge', 'Brugge', 'Namur', 'Leuven', 'Mons', 'Aalst', 'Mechelen', 'La LouviÃ¨re', 'Kortrijk', 'Hasselt', 'Sint-Niklaas', 'Oostende', 'Tournai', 'Genk', 'Seraing', 'Roeselare', 'Verviers', 'Mouscron', 'Beveren', 'Dendermonde', 'Beringen', 'Turnhout', 'Dilbeek', 'Heist-op-den-Berg', 'Sint-Truiden', 'Lokeren', 'Brasschaat', 'Vilvoorde', 'Maasmechelen', 'Waregem', 'ChÃ¢telet', 'Knokke-Heist', 'Ninove', 'Geel', 'Tienen', 'Ieper', 'Binche', 'Tongeren', 'Koksijde', 'Schoten', 'Diest', 'Braine-lAlleud', 'Mol', 'Wevelgem', 'Geraardsbergen', 'Soignies', 'Grimbergen', 'Bilzen', 'Lommel', 'Wetteren', 'Halle', 'Zaventem', 'Aarschot', 'Walcourt', 'Lier', 'Lessines', 'Fleurus', 'Wavre', 'Izegem', 'Deinze', 'Herstal', 'Zottegem', 'Poperinge', 'Ronse', 'Braine-le-Comte', 'Mortsel', 'Blankenberge', 'Harelbeke', 'Ath', 'Overijse', 'Westerlo', 'Evergem', 'Hoboken', 'Temse', 'Eeklo', 'Ciney',
            // Ãustria
            'Wien', 'Vienna', 'Graz', 'Linz', 'Salzburg', 'Innsbruck', 'Klagenfurt', 'Villach', 'Wels', 'Sankt PÃ¶lten', 'Dornbirn', 'Wiener Neustadt', 'Steyr', 'Feldkirch', 'Bregenz', 'Leonding', 'Klosterneuburg', 'Baden bei Wien', 'Wolfsberg', 'Leoben', 'Krems', 'Traun', 'Amstetten', 'Lustenau', 'Kapfenberg', 'MÃ¶dling', 'Hallein', 'Kufstein', 'Traiskirchen', 'Schwechat', 'Braunau am Inn', 'Stockerau', 'Saalfelden', 'Ansfelden', 'Tulln', 'Hohenems', 'Spittal', 'Telfs', 'Ternitz', 'Perchtoldsdorf', 'Feldkirchen', 'Bludenz', 'Bad Ischl', 'Eisenstadt', 'Schwaz', 'Hall in Tirol', 'Gmunden', 'WÃ¶rgl', 'Wals-Siezenheim', 'Marchtrenk', 'Bruck an der Mur', 'Lienz', 'Rankweil', 'Bad VÃ¶slau', 'Korneuburg', 'Neunkirchen', 'Hard', 'VÃ¶cklabruck', 'Enns', 'Ried im Innkreis', 'Hollabrunn', 'Mistelbach', 'VÃ¶lkermarkt', 'GÃ¶tzis', 'Sankt Veit', 'Zwettl', 'Ebreichsdorf', 'Waidhofen', 'Knittelfeld', 'Trofaiach', 'Judenburg', 'Weiz', 'Gleisdorf', 'Voitsberg', 'KÃ¶flach', 'Leibnitz', 'Hartberg', 'Deutschlandsberg', 'Feldbach', 'FÃ¼rstenfeld', 'Radkersburg', 'Mureck', 'Kindberg', 'MÃ¼rzzuschlag', 'Bruck an der Leitha', 'GÃ¤nserndorf', 'GroÃŸ-Enzersdorf', 'Wolkersdorf', 'Gerasdorf', 'Brunn am Gebirge', 'Maria Enzersdorf', 'VÃ¶sendorf', 'Himberg', 'Laxenburg', 'Biedermannsdorf', 'Trumau', 'Ebenfurth',
            // SuÃ­Ã§a
            'ZÃ¼rich', 'GenÃ¨ve', 'Basel', 'Lausanne', 'Bern', 'Winterthur', 'Luzern', 'St. Gallen', 'Lugano', 'Biel', 'Thun', 'KÃ¶niz', 'La Chaux-de-Fonds', 'Fribourg', 'Schaffhausen', 'Chur', 'Vernier', 'NeuchÃ¢tel', 'Uster', 'Sion', 'Emmen', 'Zug', 'Yverdon-les-Bains', 'DÃ¼bendorf', 'Kriens', 'Rapperswil-Jona', 'Dietikon', 'Montreux', 'Frauenfeld', 'Wetzikon', 'Carouge', 'WÃ¤denswil', 'Meyrin', 'Bulle', 'Allschwil', 'Baar', 'Reinach', 'Onex', 'Horgen', 'Kreuzlingen', 'Riehen', 'Nyon', 'Bellinzona', 'Wil', 'Renens', 'Vevey', 'Opfikon', 'Illnau-Effretikon', 'Schlieren', 'Pully', 'Pratteln', 'Adliswil', 'Kloten', 'Monthey', 'Sierre', 'Muttenz', 'Olten', 'Solothurn', 'BÃ¼lach', 'Langenthal', 'Grenchen', 'Liestal', 'Morges', 'Mendrisio', 'Locarno', 'Arbon', 'Burgdorf', 'Wohlen', 'Baden', 'ThÃ´nex', 'Lancy', 'Gossau', 'La Tour-de-Peilz', 'Ebikon', 'Herisau', 'Ostermundigen', 'Volketswil', 'Regensdorf', 'Steffisburg', 'Wallisellen', 'Thalwil', 'KÃ¼snacht', 'Martigny', 'Meilen', 'Binningen', 'Lyss', 'Aarau', 'Wettingen', 'Ecublens', 'Zollikon', 'Horw', 'Gland', 'Prilly', 'StÃ¤fa', 'Amriswil', 'Cham', 'MÃ¼nsingen', 'Richterswil', 'RÃ¼ti', 'Spiez', 'Einsiedeln'
        ];
        
        for (const cidade of cidadesConhecidas) {
            if (textoNormalizado.toLowerCase().includes(cidade.toLowerCase())) {
                if (!ordemCargaCamposExtraidos.cidade_carga) {
                    ordemCargaCamposExtraidos.cidade_carga = cidade;
                } else if (!ordemCargaCamposExtraidos.cidade_descarga && cidade !== ordemCargaCamposExtraidos.cidade_carga) {
                    ordemCargaCamposExtraidos.cidade_descarga = cidade;
                    break;
                }
            }
        }
        
        // === PAÃS (multi-idioma) ===
        const paisesMap = {
            // Portugal
            'portugal': 'Portugal', 'pt': 'Portugal', 'portugalia': 'Portugal',
            // Espanha
            'espanha': 'Espanha', 'espaÃ±a': 'Espanha', 'spain': 'Espanha', 'spanien': 'Espanha', 'espagne': 'Espanha', 'hiszpania': 'Espanha', 'spagna': 'Espanha', 'spanje': 'Espanha', 'es': 'Espanha',
            // FranÃ§a
            'franÃ§a': 'FranÃ§a', 'france': 'FranÃ§a', 'frankreich': 'FranÃ§a', 'francja': 'FranÃ§a', 'francia': 'FranÃ§a', 'frankrijk': 'FranÃ§a', 'fr': 'FranÃ§a',
            // Alemanha
            'alemanha': 'Alemanha', 'germany': 'Alemanha', 'deutschland': 'Alemanha', 'niemcy': 'Alemanha', 'germania': 'Alemanha', 'duitsland': 'Alemanha', 'allemagne': 'Alemanha', 'de': 'Alemanha',
            // ItÃ¡lia
            'italia': 'ItÃ¡lia', 'italy': 'ItÃ¡lia', 'italien': 'ItÃ¡lia', 'wÅ‚ochy': 'ItÃ¡lia', 'italiÃ«': 'ItÃ¡lia', 'italie': 'ItÃ¡lia', 'it': 'ItÃ¡lia',
            // Holanda
            'holanda': 'Holanda', 'netherlands': 'Holanda', 'niederlande': 'Holanda', 'holandia': 'Holanda', 'paesi bassi': 'Holanda', 'pays-bas': 'Holanda', 'nederland': 'Holanda', 'nl': 'Holanda',
            // BÃ©lgica
            'belgica': 'BÃ©lgica', 'belgium': 'BÃ©lgica', 'belgien': 'BÃ©lgica', 'belgia': 'BÃ©lgica', 'belgio': 'BÃ©lgica', 'belgique': 'BÃ©lgica', 'belgiÃ«': 'BÃ©lgica', 'be': 'BÃ©lgica',
            // PolÃ³nia
            'polonia': 'PolÃ³nia', 'poland': 'PolÃ³nia', 'polen': 'PolÃ³nia', 'polska': 'PolÃ³nia', 'pologne': 'PolÃ³nia', 'pl': 'PolÃ³nia',
            // Ãustria
            'austria': 'Ãustria', 'Ã¶sterreich': 'Ãustria', 'autriche': 'Ãustria', 'oostenrijk': 'Ãustria', 'at': 'Ãustria',
            // SuÃ­Ã§a
            'suiÃ§a': 'SuÃ­Ã§a', 'switzerland': 'SuÃ­Ã§a', 'schweiz': 'SuÃ­Ã§a', 'suisse': 'SuÃ­Ã§a', 'svizzera': 'SuÃ­Ã§a', 'zwitserland': 'SuÃ­Ã§a', 'szwajcaria': 'SuÃ­Ã§a', 'ch': 'SuÃ­Ã§a',
            // Reino Unido
            'reino unido': 'Reino Unido', 'united kingdom': 'Reino Unido', 'uk': 'Reino Unido', 'groÃŸbritannien': 'Reino Unido', 'royaume-uni': 'Reino Unido', 'wielka brytania': 'Reino Unido', 'gran bretagna': 'Reino Unido',
            // RepÃºblica Checa
            'republica checa': 'Rep. Checa', 'czech republic': 'Rep. Checa', 'tschechien': 'Rep. Checa', 'czechy': 'Rep. Checa', 'repubblica ceca': 'Rep. Checa', 'rÃ©publique tchÃ¨que': 'Rep. Checa', 'tsjechiÃ«': 'Rep. Checa', 'cz': 'Rep. Checa',
            // Hungria
            'hungria': 'Hungria', 'hungary': 'Hungria', 'ungarn': 'Hungria', 'wÄ™gry': 'Hungria', 'ungheria': 'Hungria', 'hongrie': 'Hungria', 'hongarije': 'Hungria', 'hu': 'Hungria',
            // RomÃ©nia
            'romenia': 'RomÃ©nia', 'romania': 'RomÃ©nia', 'rumÃ¤nien': 'RomÃ©nia', 'rumunia': 'RomÃ©nia', 'roumanie': 'RomÃ©nia', 'roemeniÃ«': 'RomÃ©nia', 'ro': 'RomÃ©nia',
            // EslovÃ¡quia
            'eslovaquia': 'EslovÃ¡quia', 'slovakia': 'EslovÃ¡quia', 'slowakei': 'EslovÃ¡quia', 'sÅ‚owacja': 'EslovÃ¡quia', 'slovacchia': 'EslovÃ¡quia', 'slovaquie': 'EslovÃ¡quia', 'slowakije': 'EslovÃ¡quia', 'sk': 'EslovÃ¡quia',
            // EslovÃ©nia
            'eslovenia': 'EslovÃ©nia', 'slovenia': 'EslovÃ©nia', 'slowenien': 'EslovÃ©nia', 'sÅ‚owenia': 'EslovÃ©nia', 'slovÃ©nie': 'EslovÃ©nia', 'sloveniÃ«': 'EslovÃ©nia', 'si': 'EslovÃ©nia',
            // CroÃ¡cia
            'croacia': 'CroÃ¡cia', 'croatia': 'CroÃ¡cia', 'kroatien': 'CroÃ¡cia', 'chorwacja': 'CroÃ¡cia', 'croatie': 'CroÃ¡cia', 'kroatiÃ«': 'CroÃ¡cia', 'hr': 'CroÃ¡cia',
            // GrÃ©cia
            'grecia': 'GrÃ©cia', 'greece': 'GrÃ©cia', 'griechenland': 'GrÃ©cia', 'grecja': 'GrÃ©cia', 'grÃ¨ce': 'GrÃ©cia', 'griekenland': 'GrÃ©cia', 'gr': 'GrÃ©cia',
            // Dinamarca
            'dinamarca': 'Dinamarca', 'denmark': 'Dinamarca', 'dÃ¤nemark': 'Dinamarca', 'dania': 'Dinamarca', 'danemark': 'Dinamarca', 'denemarken': 'Dinamarca', 'dk': 'Dinamarca',
            // SuÃ©cia
            'suecia': 'SuÃ©cia', 'sweden': 'SuÃ©cia', 'schweden': 'SuÃ©cia', 'szwecja': 'SuÃ©cia', 'svezia': 'SuÃ©cia', 'suÃ¨de': 'SuÃ©cia', 'zweden': 'SuÃ©cia', 'se': 'SuÃ©cia',
            // Noruega
            'noruega': 'Noruega', 'norway': 'Noruega', 'norwegen': 'Noruega', 'norwegia': 'Noruega', 'norvegia': 'Noruega', 'norvÃ¨ge': 'Noruega', 'noorwegen': 'Noruega', 'no': 'Noruega',
            // FinlÃ¢ndia
            'finlandia': 'FinlÃ¢ndia', 'finland': 'FinlÃ¢ndia', 'finnland': 'FinlÃ¢ndia', 'finlandia': 'FinlÃ¢ndia', 'finlande': 'FinlÃ¢ndia', 'fi': 'FinlÃ¢ndia',
            // Irlanda
            'irlanda': 'Irlanda', 'ireland': 'Irlanda', 'irland': 'Irlanda', 'irlandia': 'Irlanda', 'irlande': 'Irlanda', 'ierland': 'Irlanda', 'ie': 'Irlanda',
            // Luxemburgo
            'luxemburgo': 'Luxemburgo', 'luxembourg': 'Luxemburgo', 'luxemburg': 'Luxemburgo', 'luksemburg': 'Luxemburgo', 'lussemburgo': 'Luxemburgo', 'lu': 'Luxemburgo'
        };
        
        for (const [key, value] of Object.entries(paisesMap)) {
            if (textoLower.includes(key)) {
                ordemCargaCamposExtraidos.pais_descarga = value;
                break;
            }
        }
        
        // === OBSERVAÃ‡Ã•ES (multi-idioma) ===
        // PT: observaÃ§Ãµes, instruÃ§Ãµes | EN: notes, remarks, instructions | ES: observaciones, instrucciones
        // DE: Bemerkungen, Anmerkungen, Hinweise | FR: observations, remarques, instructions
        // PL: uwagi, instrukcje | IT: osservazioni, note, istruzioni | NL: opmerkingen, instructies
        const obsPatterns = [
            /(?:observa[Ã§c][Ãµo]es?|notes?|remarks?|instru[Ã§c][Ãµo]es?|observaciones?|instrucciones?|bemerkungen?|anmerkungen?|hinweise?|remarques?|uwagi|instrukcje|osservazioni|istruzioni|opmerkingen)[:\s]*([^\n]{5,200})/i
        ];
        for (const pattern of obsPatterns) {
            const match = texto.match(pattern);
            if (match) {
                ordemCargaCamposExtraidos.observacoes = match[1].trim();
                break;
            }
        }
        
        // Preencher campos no formulÃ¡rio do modal
        preencherCamposOCR();
        
        console.log('âœ… Campos extraÃ­dos:', ordemCargaCamposExtraidos);
    }
    
    /**
     * Preenche os campos do formulÃ¡rio OCR
     */
    function preencherCamposOCR() {
        const mapeamento = {
            'ocr_cliente': 'cliente',
            'ocr_referencia': 'referencia',
            'ocr_ldm': 'ldm',
            'ocr_bultos': 'bultos',
            'ocr_peso': 'peso',
            'ocr_empresa_carga': 'empresa_carga',
            'ocr_morada_carga': 'morada_carga',
            'ocr_cp_carga': 'cp_carga',
            'ocr_cidade_carga': 'cidade_carga',
            'ocr_data_carga': 'data_carga',
            'ocr_hora_carga': 'hora_carga',
            'ocr_empresa_descarga': 'empresa_descarga',
            'ocr_morada_descarga': 'morada_descarga',
            'ocr_cp_descarga': 'cp_descarga',
            'ocr_cidade_descarga': 'cidade_descarga',
            'ocr_pais_descarga': 'pais_descarga',
            'ocr_data_descarga': 'data_descarga',
            'ocr_hora_descarga': 'hora_descarga',
            'ocr_observacoes': 'observacoes'
        };
        
        for (const [campoId, campoNome] of Object.entries(mapeamento)) {
            const elemento = document.getElementById(campoId);
            if (elemento && ordemCargaCamposExtraidos[campoNome]) {
                elemento.value = ordemCargaCamposExtraidos[campoNome];
            }
        }
    }
    
    /**
     * Reprocessa o texto editado manualmente
     */
    function reprocessarTexto() {
        const textoEditado = document.getElementById('textoExtraido').value;
        if (!textoEditado.trim()) {
            alert('âš ï¸ NÃ£o hÃ¡ texto para processar!');
            return;
        }
        
        analisarTextoOrdemCarga(textoEditado);
        document.getElementById('camposIdentificados').style.display = 'block';
        document.getElementById('btnPreencherReserva').style.display = 'inline-block';
        alert('âœ… Texto reprocessado! Verifique os campos identificados.');
    }
    
    /**
     * Preenche o formulÃ¡rio de reserva com os dados extraÃ­dos
     */
    function preencherReservaComOCR() {
        // Obter valores dos campos OCR (jÃ¡ podem ter sido editados pelo utilizador)
        const dados = {
            cliente: document.getElementById('ocr_cliente')?.value || '',
            ldm: document.getElementById('ocr_ldm')?.value || '',
            bultos: document.getElementById('ocr_bultos')?.value || '',
            peso: document.getElementById('ocr_peso')?.value || '',
            empresa_carga: document.getElementById('ocr_empresa_carga')?.value || '',
            morada_carga: document.getElementById('ocr_morada_carga')?.value || '',
            cp_carga: document.getElementById('ocr_cp_carga')?.value || '',
            cidade_carga: document.getElementById('ocr_cidade_carga')?.value || '',
            data_carga: document.getElementById('ocr_data_carga')?.value || '',
            hora_carga: document.getElementById('ocr_hora_carga')?.value || '',
            empresa_descarga: document.getElementById('ocr_empresa_descarga')?.value || '',
            morada_descarga: document.getElementById('ocr_morada_descarga')?.value || '',
            cp_descarga: document.getElementById('ocr_cp_descarga')?.value || '',
            cidade_descarga: document.getElementById('ocr_cidade_descarga')?.value || '',
            pais_descarga: document.getElementById('ocr_pais_descarga')?.value || '',
            data_descarga: document.getElementById('ocr_data_descarga')?.value || '',
            hora_descarga: document.getElementById('ocr_hora_descarga')?.value || '',
            observacoes: document.getElementById('ocr_observacoes')?.value || ''
        };
        
        // Preencher campos da reserva
        let camposPreenchidos = 0;
        
        // SecÃ§Ã£o 1 - Cliente
        if (dados.cliente && document.getElementById('cliente')) {
            document.getElementById('cliente').value = dados.cliente;
            camposPreenchidos++;
        }
        
        // SecÃ§Ã£o 2 - Dados de Carga
        if (dados.ldm && document.getElementById('ldm')) {
            document.getElementById('ldm').value = dados.ldm;
            camposPreenchidos++;
        }
        if (dados.bultos && document.getElementById('num_bultos')) {
            document.getElementById('num_bultos').value = dados.bultos;
            camposPreenchidos++;
        }
        if (dados.peso && document.getElementById('peso')) {
            document.getElementById('peso').value = dados.peso;
            camposPreenchidos++;
        }
        
        // SecÃ§Ã£o 3 - Local de Carga
        if (dados.empresa_carga && document.getElementById('empresa_carga')) {
            document.getElementById('empresa_carga').value = dados.empresa_carga;
            camposPreenchidos++;
        }
        if (dados.morada_carga && document.getElementById('carga_rua')) {
            document.getElementById('carga_rua').value = dados.morada_carga;
            camposPreenchidos++;
        }
        if (dados.cp_carga && document.getElementById('carga_cp')) {
            document.getElementById('carga_cp').value = dados.cp_carga;
            camposPreenchidos++;
        }
        if (dados.cidade_carga && document.getElementById('carga_cidade')) {
            document.getElementById('carga_cidade').value = dados.cidade_carga;
            camposPreenchidos++;
        }
        if (dados.data_carga && document.getElementById('data_carga_prev')) {
            document.getElementById('data_carga_prev').value = dados.data_carga;
            camposPreenchidos++;
        }
        if (dados.hora_carga && document.getElementById('hora_carga_prev')) {
            document.getElementById('hora_carga_prev').value = dados.hora_carga;
            camposPreenchidos++;
        }
        
        // SecÃ§Ã£o 4 - Local de Descarga
        if (dados.empresa_descarga && document.getElementById('empresa_descarga')) {
            document.getElementById('empresa_descarga').value = dados.empresa_descarga;
            camposPreenchidos++;
        }
        if (dados.morada_descarga && document.getElementById('descarga_rua')) {
            document.getElementById('descarga_rua').value = dados.morada_descarga;
            camposPreenchidos++;
        }
        if (dados.cp_descarga && document.getElementById('descarga_cp')) {
            document.getElementById('descarga_cp').value = dados.cp_descarga;
            camposPreenchidos++;
        }
        if (dados.cidade_descarga && document.getElementById('descarga_cidade')) {
            document.getElementById('descarga_cidade').value = dados.cidade_descarga;
            camposPreenchidos++;
        }
        if (dados.pais_descarga && document.getElementById('descarga_pais')) {
            document.getElementById('descarga_pais').value = dados.pais_descarga;
            camposPreenchidos++;
        }
        if (dados.data_descarga && document.getElementById('data_descarga_prev')) {
            document.getElementById('data_descarga_prev').value = dados.data_descarga;
            camposPreenchidos++;
        }
        if (dados.hora_descarga && document.getElementById('hora_descarga_prev')) {
            document.getElementById('hora_descarga_prev').value = dados.hora_descarga;
            camposPreenchidos++;
        }
        
        // ObservaÃ§Ãµes
        if (dados.observacoes && document.getElementById('observacoes')) {
            const obsAtual = document.getElementById('observacoes').value;
            document.getElementById('observacoes').value = obsAtual ? obsAtual + '\n\n[OCR] ' + dados.observacoes : '[OCR] ' + dados.observacoes;
            camposPreenchidos++;
        }
        
        // Fechar modal
        fecharModalReservas('modalOrdemCarga');
        
        // Feedback visual nas secÃ§Ãµes preenchidas
        ['secao1', 'secao2', 'secao3', 'secao4'].forEach(secaoId => {
            const secao = document.getElementById(secaoId);
            if (secao) {
                secao.style.transition = 'background 0.5s';
                secao.style.background = '#d4edda';
                setTimeout(() => { secao.style.background = ''; }, 2000);
            }
        });
        
        // Mensagem de sucesso
        alert('âœ… Reserva preenchida!\n\n' + camposPreenchidos + ' campo(s) preenchido(s) automaticamente.\n\nâš ï¸ Por favor, revise os dados e complete os campos em falta.');
        
        console.log('âœ… Reserva preenchida com dados OCR:', dados);
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // FIM - FUNÃ‡Ã•ES LER ORDEM DE CARGA
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    function calcularDistanciaReservas(lat1, lng1, lat2, lng2) {
        const R = 6371;
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLng = (lng2 - lng1) * Math.PI / 180;
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLng/2) * Math.sin(dLng/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
    }
    
    function desenharMapaRecolhas() {
        const container = document.getElementById('mapaRecolhas');
        if (!container) return;
        
        // Verificar se Leaflet estÃ¡ disponÃ­vel
        if (typeof L === 'undefined') {
            console.warn('âš ï¸ Leaflet nÃ£o disponÃ­vel - usando fallback SVG');
            desenharMapaRecolhasSVG();
            return;
        }
        
        try {
            // Criar mapa Leaflet centrado em Portugal
            const map = leafletCriarMapa('mapaRecolhas', 39.5, -8.0, 7);
            if (!map) {
                desenharMapaRecolhasSVG();
                return;
            }
            
            const markersGroup = L.layerGroup().addTo(map);
            
            // Adicionar recolhas pendentes (marcadores vermelhos)
            const pendentes = reservasPendentes.filter(r => !r.temCMR);
            pendentes.forEach(r => {
                const iconeRecolha = L.divIcon({
                    className: 'leaflet-recolha-marker',
                    html: '<div style="background:#e74c3c;color:white;width:35px;height:35px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:16px;border:3px solid white;box-shadow:0 2px 5px rgba(0,0,0,0.3);cursor:pointer;">ğŸ“¦</div>',
                    iconSize: [35, 35],
                    iconAnchor: [17, 17]
                });
                
                const marker = L.marker([r.lat, r.lng], {icon: iconeRecolha})
                    .bindPopup(
                        '<div style="min-width:180px;">' +
                        '<b style="color:#e74c3c;">ğŸ“¦ ' + r.numero + '</b><br>' +
                        '<span style="color:#495057;">' + r.cliente + '</span><br>' +
                        '<span style="color:#6c757d;">ğŸ“ ' + r.cidade + '</span><br>' +
                        '<button onclick="selecionarRecolha(\'' + r.numero + '\')" style="margin-top:8px;background:#27ae60;color:white;border:none;padding:5px 10px;border-radius:5px;cursor:pointer;width:100%;">ğŸš› Atribuir Viatura</button>' +
                        '</div>'
                    )
                    .addTo(markersGroup);
            });
            
            // Adicionar viaturas (marcadores verdes/amarelos)
            viaturasFrotcom.forEach(v => {
                const cor = v.status === 'disponivel' ? '#27ae60' : '#f39c12';
                const status = v.status === 'disponivel' ? 'âœ… DisponÃ­vel' : 'âš ï¸ Em rota';
                
                const iconeViatura = L.divIcon({
                    className: 'leaflet-viatura-marker',
                    html: '<div style="background:' + cor + ';color:white;padding:3px 8px;border-radius:5px;font-size:11px;font-weight:bold;border:2px solid white;box-shadow:0 2px 5px rgba(0,0,0,0.3);white-space:nowrap;">ğŸš› ' + v.matricula + '</div>',
                    iconSize: [80, 25],
                    iconAnchor: [40, 12]
                });
                
                L.marker([v.lat, v.lng], {icon: iconeViatura})
                    .bindPopup(
                        '<div style="min-width:150px;">' +
                        '<b style="color:' + cor + ';">ğŸš› ' + v.matricula + '</b><br>' +
                        'ğŸ‘¤ ' + v.motorista + '<br>' +
                        'Estado: ' + status +
                        '</div>'
                    )
                    .addTo(markersGroup);
            });
            
            // Ajustar vista se houver markers
            if (pendentes.length > 0 || viaturasFrotcom.length > 0) {
                const allMarkers = [];
                pendentes.forEach(r => allMarkers.push([r.lat, r.lng]));
                viaturasFrotcom.forEach(v => allMarkers.push([v.lat, v.lng]));
                
                if (allMarkers.length > 1) {
                    map.fitBounds(allMarkers, {padding: [30, 30]});
                } else if (allMarkers.length === 1) {
                    map.setView(allMarkers[0], 10);
                }
            }
            
            console.log('âœ… Mapa de recolhas Leaflet criado com ' + pendentes.length + ' recolhas e ' + viaturasFrotcom.length + ' viaturas');
            
        } catch (error) {
            console.error('âŒ Erro ao criar mapa Leaflet:', error);
            desenharMapaRecolhasSVG();
        }
    }
    
    // Fallback SVG para mapa de recolhas
    function desenharMapaRecolhasSVG() {
        const mapa = document.getElementById('mapaRecolhas');
        let svg = '<svg viewBox="0 0 300 450" preserveAspectRatio="xMidYMid meet" style="width:100%;height:100%;background:linear-gradient(180deg, #87CEEB 0%, #b8e0f7 50%, #E0F7FA 100%);">';
        
        // Desenhar contorno de Portugal (mais detalhado)
        svg += '<path d="M120,30 L140,25 L160,25 L180,30 L200,35 L215,55 L225,80 L230,110 L228,150 L225,190 L218,230 L210,270 L200,310 L188,350 L170,385 L145,410 L120,420 L95,415 L80,390 L70,350 L62,310 L58,270 L55,230 L58,190 L65,150 L75,110 L88,70 L105,45 Z" fill="#F5F5DC" stroke="#8B7355" stroke-width="2" filter="drop-shadow(2px 2px 3px rgba(0,0,0,0.3))"/>';
        
        // Adicionar algumas cidades de referÃªncia
        svg += '<text x="150" y="140" text-anchor="middle" fill="#666" font-size="9" font-weight="bold">Porto</text>';
        svg += '<text x="120" y="290" text-anchor="middle" fill="#666" font-size="9" font-weight="bold">Lisboa</text>';
        svg += '<text x="170" y="400" text-anchor="middle" fill="#666" font-size="9" font-weight="bold">Faro</text>';
        
        // Desenhar recolhas pendentes (pontos vermelhos com Ã­cone)
        const pendentes = reservasPendentes.filter(r => !r.temCMR);
        pendentes.forEach(r => {
            const x = mapearLng2(r.lng);
            const y = mapearLat2(r.lat);
            // CÃ­rculo vermelho com sombra
            svg += '<circle cx="' + x + '" cy="' + y + '" r="12" fill="#e74c3c" stroke="white" stroke-width="2" style="cursor:pointer; filter:drop-shadow(1px 1px 2px rgba(0,0,0,0.3));"/>';
            // Ponto interior
            svg += '<circle cx="' + x + '" cy="' + y + '" r="4" fill="white"/>';
        });
        
        // Desenhar viaturas (retÃ¢ngulos verdes/amarelos com matrÃ­cula)
        viaturasFrotcom.forEach(v => {
            const x = mapearLng2(v.lng);
            const y = mapearLat2(v.lat);
            const cor = v.status === 'disponivel' ? '#27ae60' : '#f39c12';
            const corBorda = v.status === 'disponivel' ? '#1e8449' : '#d68910';
            // Fundo do camiÃ£o
            svg += '<rect x="' + (x-22) + '" y="' + (y-10) + '" width="44" height="20" rx="4" fill="' + cor + '" stroke="' + corBorda + '" stroke-width="1" style="filter:drop-shadow(1px 1px 2px rgba(0,0,0,0.3));"/>';
            // Ãcone de camiÃ£o
            svg += '<text x="' + (x-14) + '" y="' + (y+4) + '" fill="white" font-size="10">ğŸš›</text>';
            // MatrÃ­cula
            svg += '<text x="' + (x+8) + '" y="' + (y+4) + '" text-anchor="middle" fill="white" font-size="7" font-weight="bold">' + v.matricula + '</text>';
        });
        
        svg += '</svg>';
        mapa.innerHTML = svg;
    }
    
    function mapearLat2(lat) {
        // Converter latitude para coordenada Y (Portugal: 37-42 graus)
        return 420 - ((lat - 36.5) / 6) * 400;
    }
    
    function mapearLng2(lng) {
        // Converter longitude para coordenada X (Portugal: -9.5 a -6 graus)
        return 50 + ((lng + 9.5) / 4) * 200;
    }
    
    function selecionarRecolha(numReservaRec) {
        const reserva = reservasPendentes.find(r => r.numero === numReservaRec);
        if (reserva) {
            // Encontrar viatura mais prÃ³xima
            let menorDist = Infinity;
            let viaturaMaisProxima = null;
            viaturasFrotcom.forEach(v => {
                const dist = calcularDistanciaReservas(reserva.lat, reserva.lng, v.lat, v.lng);
                if (dist < menorDist) {
                    menorDist = dist;
                    viaturaMaisProxima = v;
                }
            });
            
            let msg = 'ğŸ“¦ RECOLHA SELECIONADA\n';
            msg += 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n';
            msg += 'ğŸ“‹ NÂº Reserva: ' + reserva.numero + '\n';
            msg += 'ğŸ¢ Cliente: ' + reserva.cliente + '\n';
            msg += 'ğŸ“ Local: ' + reserva.cidade + ' (' + reserva.cp + ')\n\n';
            
            if (viaturaMaisProxima) {
                msg += 'ğŸš› VIATURA MAIS PRÃ“XIMA:\n';
                msg += '   MatrÃ­cula: ' + viaturaMaisProxima.matricula + '\n';
                msg += '   Motorista: ' + viaturaMaisProxima.motorista + '\n';
                msg += '   DistÃ¢ncia: ' + menorDist.toFixed(1) + ' km\n';
                msg += '   Estado: ' + (viaturaMaisProxima.status === 'disponivel' ? 'âœ… DisponÃ­vel' : 'âš ï¸ Em rota') + '\n\n';
                msg += 'ğŸ’¡ Deseja atribuir esta recolha Ã  viatura ' + viaturaMaisProxima.matricula + '?';
            }
            
            if (confirm(msg)) {
                alert('âœ… Recolha atribuÃ­da!\n\nğŸ“± Mensagem enviada para o motorista ' + viaturaMaisProxima.motorista + '\nğŸš› Viatura: ' + viaturaMaisProxima.matricula);
            }
        }
    }

    function abrirMapaRota() {
        const cidadeCarga = document.getElementById('carga_cidade').value || 'Lisboa';
        const cpCarga = document.getElementById('carga_cp').value || '1000-001';
        const cidadeDescarga = document.getElementById('descarga_cidade').value || 'Porto';
        const cpDescarga = document.getElementById('descarga_cp').value || '4000-001';
        
        document.getElementById('rotaOrigem').textContent = cidadeCarga + ' (' + cpCarga + ')';
        document.getElementById('rotaDestino').textContent = cidadeDescarga + ' (' + cpDescarga + ')';
        
        const dadosRota = calcularRotaFrotcom(cidadeCarga, cidadeDescarga);
        
        document.getElementById('rotaDistancia').textContent = dadosRota.distancia + ' km';
        document.getElementById('rotaTempo').textContent = dadosRota.tempo;
        document.getElementById('rotaPortagens').textContent = dadosRota.portagens.toFixed(2) + ' â‚¬';
        document.getElementById('rotaCombustivel').textContent = dadosRota.combustivel.toFixed(2) + ' â‚¬';
        document.getElementById('rotaCustoTotal').textContent = dadosRota.custoTotal.toFixed(2) + ' â‚¬';
        
        desenharMapaRota(cidadeCarga, cidadeDescarga, dadosRota);
        
        document.getElementById('modalMapaRota').classList.add('active');
    }
    
    function calcularRotaFrotcom(origem, destino) {
        const cidades = {
            'Lisboa': { lat: 38.7223, lng: -9.1393 },
            'Porto': { lat: 41.1579, lng: -8.6291 },
            'Coimbra': { lat: 40.2033, lng: -8.4103 },
            'Faro': { lat: 37.0194, lng: -7.9322 },
            'Braga': { lat: 41.5518, lng: -8.4229 },
            'SetÃºbal': { lat: 38.5244, lng: -8.8882 },
            'Ã‰vora': { lat: 38.5667, lng: -7.9 },
            'Aveiro': { lat: 40.6405, lng: -8.6538 },
            'Leiria': { lat: 39.7437, lng: -8.8071 },
            'Viseu': { lat: 40.6610, lng: -7.9097 }
        };
        
        const orig = cidades[origem] || cidades['Lisboa'];
        const dest = cidades[destino] || cidades['Porto'];
        
        const distancia = Math.round(calcularDistanciaReservas(orig.lat, orig.lng, dest.lat, dest.lng) * 1.3);
        
        const horas = Math.floor(distancia / 80);
        const minutos = Math.round((distancia / 80 - horas) * 60);
        const tempo = horas + 'h ' + minutos + 'min';
        
        const portagens = distancia * 0.12;
        const combustivel = (distancia / 100) * 32 * 1.50;
        const custoTotal = portagens + combustivel;
        
        return {
            distancia: distancia,
            tempo: tempo,
            portagens: portagens,
            combustivel: combustivel,
            custoTotal: custoTotal,
            coordOrigem: orig,
            coordDestino: dest
        };
    }
    
    function desenharMapaRota(origem, destino, dados) {
        const mapa = document.getElementById('mapaRota');
        
        let svg = '<svg viewBox="0 0 300 450" preserveAspectRatio="xMidYMid meet" style="width:100%;height:100%;background:linear-gradient(180deg, #87CEEB 0%, #E0F7FA 100%);">';
        svg += '<path d="M120,30 L160,25 L200,35 L220,60 L230,100 L225,150 L220,200 L210,250 L200,300 L185,350 L160,400 L130,420 L100,410 L85,370 L75,320 L65,270 L60,220 L65,170 L75,120 L90,70 L110,40 Z" fill="#F5F5DC" stroke="#8B7355" stroke-width="2"/>';
        
        const x1 = mapearLng2(dados.coordOrigem.lng);
        const y1 = mapearLat2(dados.coordOrigem.lat);
        const x2 = mapearLng2(dados.coordDestino.lng);
        const y2 = mapearLat2(dados.coordDestino.lat);
        
        svg += '<line x1="' + x1 + '" y1="' + y1 + '" x2="' + x2 + '" y2="' + y2 + '" stroke="#667eea" stroke-width="4" stroke-dasharray="10,5"/>';
        
        svg += '<circle cx="' + x1 + '" cy="' + y1 + '" r="15" fill="#27ae60" stroke="white" stroke-width="3"/>';
        svg += '<text x="' + x1 + '" y="' + (y1 + 5) + '" text-anchor="middle" fill="white" font-size="12" font-weight="bold">A</text>';
        svg += '<text x="' + x1 + '" y="' + (y1 + 30) + '" text-anchor="middle" fill="#1e3c72" font-size="10" font-weight="bold">' + origem + '</text>';
        
        svg += '<circle cx="' + x2 + '" cy="' + y2 + '" r="15" fill="#e74c3c" stroke="white" stroke-width="3"/>';
        svg += '<text x="' + x2 + '" y="' + (y2 + 5) + '" text-anchor="middle" fill="white" font-size="12" font-weight="bold">B</text>';
        svg += '<text x="' + x2 + '" y="' + (y2 + 30) + '" text-anchor="middle" fill="#1e3c72" font-size="10" font-weight="bold">' + destino + '</text>';
        
        const xMeio = (x1 + x2) / 2;
        const yMeio = (y1 + y2) / 2;
        svg += '<rect x="' + (xMeio - 30) + '" y="' + (yMeio - 10) + '" width="60" height="20" rx="10" fill="white" stroke="#667eea" stroke-width="2"/>';
        svg += '<text x="' + xMeio + '" y="' + (yMeio + 4) + '" text-anchor="middle" fill="#1e3c72" font-size="10" font-weight="bold">' + dados.distancia + ' km</text>';
        
        svg += '</svg>';
        mapa.innerHTML = svg;
    }
    
    function exportarRotaPDF() {
        alert('ğŸ“„ A gerar PDF da rota...\n\nO documento serÃ¡ descarregado em breve.\n\n(Funcionalidade requer integraÃ§Ã£o com biblioteca de PDF)');
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // HERE MAPS + FROTCOM GPS - SISTEMA INTEGRADO v1.0
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // 
    // ARQUITETURA:
    // â”œâ”€â”€ HERE Maps: Geocoding, Rotas para camiÃµes, TrÃ¢nsito
    // â”œâ”€â”€ Frotcom GPS: PosiÃ§Ã£o frota, Mensagens bidirecionais, Telemetria
    // â””â”€â”€ Fallback SVG: Quando APIs nÃ£o disponÃ­veis
    //
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // CONFIGURAÃ‡ÃƒO - APIs
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    const mapsConfig = {
        // HERE Maps (obter chave em developer.here.com)
        here: {
            apiKey: 'YOUR_HERE_API_KEY',
            enabled: false  // Desativado - usando OpenRouteService
        },
        // OpenRouteService - GRATUITO para camiÃµes (2000 requests/dia)
        openRouteService: {
            apiKey: 'eyJvcmciOiI1YjNjZTM1OTc4NTExMTAwMDFjZjYyNDgiLCJpZCI6ImQxY2E4MjlhMmM5NDQ0ODFhZTcxNWNiZjdjYTAxMDhmIiwiaCI6Im11cm11cjY0In0=',
            enabled: true,
            // Perfil: driving-hgv = Heavy Goods Vehicle (camiÃµes)
            profile: 'driving-hgv'
        },
        // Frotcom GPS (obter credenciais com Frotcom)
        frotcom: {
            apiUrl: 'https://api.frotcom.com/v1',
            apiKey: 'YOUR_FROTCOM_API_KEY',
            accountId: 'YOUR_ACCOUNT_ID',
            enabled: true,
            // Intervalo de atualizaÃ§Ã£o posiÃ§Ãµes (ms)
            refreshInterval: 30000
        },
        // Usar fallback quando APIs nÃ£o disponÃ­veis
        useFallback: true
    };

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // OPENROUTESERVICE + LEAFLET - SISTEMA INTEGRADO
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    let leafletMap = null;
    let leafletMapRecolhas = null;
    let leafletRouteLayer = null;
    let leafletMarkersLayer = null;

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // OPENROUTESERVICE - FUNÃ‡Ã•ES DE ROTAS PARA CAMIÃ•ES
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    // Calcular rota usando OpenRouteService (GRATUITO - 2000/dia)
    async function orsCalcularRotaCamiao(origem, destino, opcoes) {
        const apiKey = mapsConfig.openRouteService.apiKey;
        const profile = mapsConfig.openRouteService.profile || 'driving-hgv';
        
        // Coordenadas no formato [lng, lat] para ORS
        const coordenadas = [
            [origem.lng, origem.lat],
            [destino.lng, destino.lat]
        ];
        
        // OpÃ§Ãµes do veÃ­culo pesado
        const body = {
            coordinates: coordenadas,
            profile: profile,
            format: 'geojson',
            units: 'km',
            language: 'pt',
            instructions: true,
            // RestriÃ§Ãµes para camiÃµes
            options: {
                vehicle_type: 'hgv',
                profile_params: {
                    restrictions: {
                        height: opcoes?.altura || 4.0,      // metros
                        width: opcoes?.largura || 2.5,      // metros
                        weight: opcoes?.peso || 40,         // toneladas
                        axleload: opcoes?.cargaEixo || 11.5 // toneladas por eixo
                    }
                }
            }
        };
        
        try {
            console.log('ğŸš› OpenRouteService: A calcular rota para camiÃ£o...');
            
            const response = await fetch('https://api.openrouteservice.org/v2/directions/' + profile, {
                method: 'POST',
                headers: {
                    'Authorization': apiKey,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(body)
            });
            
            if (!response.ok) {
                throw new Error('Erro ORS: ' + response.status);
            }
            
            const data = await response.json();
            
            if (data.features && data.features.length > 0) {
                const route = data.features[0];
                const props = route.properties;
                const summary = props.summary || {};
                
                // Converter metros para km e segundos para horas
                const distanciaKm = Math.round(summary.distance || 0);
                const duracaoSeg = summary.duration || 0;
                const horas = Math.floor(duracaoSeg / 3600);
                const minutos = Math.round((duracaoSeg % 3600) / 60);
                
                // Estimar portagens (â‚¬0.12/km em autoestrada)
                const portagens = distanciaKm * 0.12;
                
                // Estimar combustÃ­vel (32L/100km a â‚¬1.50/L)
                const combustivel = (distanciaKm / 100) * 32 * 1.50;
                
                const resultado = {
                    distancia: distanciaKm,
                    tempo: horas + 'h ' + minutos + 'min',
                    duracaoSegundos: duracaoSeg,
                    portagens: portagens,
                    combustivel: combustivel,
                    custoTotal: portagens + combustivel,
                    coordOrigem: origem,
                    coordDestino: destino,
                    polyline: route.geometry.coordinates,
                    instrucoes: props.segments ? props.segments[0].steps : [],
                    fonte: 'OpenRouteService'
                };
                
                console.log('âœ… OpenRouteService: Rota calculada - ' + distanciaKm + ' km, ' + horas + 'h' + minutos + 'min');
                return resultado;
            }
            
            throw new Error('Sem rota encontrada');
            
        } catch (error) {
            console.error('âŒ OpenRouteService erro:', error);
            // Fallback para cÃ¡lculo local
            return orsCalcularRotaFallback(origem, destino);
        }
    }
    
    // Fallback quando API nÃ£o disponÃ­vel
    function orsCalcularRotaFallback(origem, destino) {
        const distancia = Math.round(calcularDistanciaReservas(origem.lat, origem.lng, destino.lat, destino.lng) * 1.3);
        const horas = Math.floor(distancia / 70);
        const minutos = Math.round((distancia / 70 - horas) * 60);
        
        return {
            distancia: distancia,
            tempo: horas + 'h ' + minutos + 'min',
            duracaoSegundos: (horas * 60 + minutos) * 60,
            portagens: distancia * 0.12,
            combustivel: (distancia / 100) * 32 * 1.50,
            custoTotal: distancia * 0.12 + (distancia / 100) * 32 * 1.50,
            coordOrigem: origem,
            coordDestino: destino,
            polyline: null,
            fonte: 'Estimativa'
        };
    }
    
    // Criar mapa Leaflet
    function leafletCriarMapa(containerId, centerLat, centerLng, zoom) {
        const container = document.getElementById(containerId);
        if (!container) return null;
        
        // Limpar mapa anterior se existir
        if (containerId === 'mapaRota' && leafletMap) {
            leafletMap.remove();
            leafletMap = null;
        }
        if (containerId === 'mapaRecolhas' && leafletMapRecolhas) {
            leafletMapRecolhas.remove();
            leafletMapRecolhas = null;
        }
        
        // Criar novo mapa
        const map = L.map(containerId).setView([centerLat, centerLng], zoom);
        
        // Adicionar camada de tiles (OpenStreetMap)
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap | Rotas: OpenRouteService',
            maxZoom: 19
        }).addTo(map);
        
        // Guardar referÃªncia
        if (containerId === 'mapaRota') {
            leafletMap = map;
        } else if (containerId === 'mapaRecolhas') {
            leafletMapRecolhas = map;
        }
        
        console.log('âœ… Leaflet mapa criado:', containerId);
        return map;
    }
    
    // Desenhar rota no mapa Leaflet
    function leafletDesenharRota(map, dados, cidadeOrigem, cidadeDestino) {
        if (!map || !dados) return;
        
        // Limpar camadas anteriores
        if (leafletRouteLayer) {
            map.removeLayer(leafletRouteLayer);
        }
        if (leafletMarkersLayer) {
            map.removeLayer(leafletMarkersLayer);
        }
        
        leafletMarkersLayer = L.layerGroup().addTo(map);
        
        // Criar Ã­cones personalizados
        const iconeOrigem = L.divIcon({
            className: 'leaflet-marker-custom',
            html: '<div style="background:#27ae60;color:white;width:30px;height:30px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:bold;border:3px solid white;box-shadow:0 2px 5px rgba(0,0,0,0.3);">A</div>',
            iconSize: [30, 30],
            iconAnchor: [15, 15]
        });
        
        const iconeDestino = L.divIcon({
            className: 'leaflet-marker-custom',
            html: '<div style="background:#e74c3c;color:white;width:30px;height:30px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:bold;border:3px solid white;box-shadow:0 2px 5px rgba(0,0,0,0.3);">B</div>',
            iconSize: [30, 30],
            iconAnchor: [15, 15]
        });
        
        // Adicionar marcadores
        const markerOrigem = L.marker([dados.coordOrigem.lat, dados.coordOrigem.lng], {icon: iconeOrigem})
            .bindPopup('<b>ğŸŸ¢ Origem</b><br>' + cidadeOrigem)
            .addTo(leafletMarkersLayer);
            
        const markerDestino = L.marker([dados.coordDestino.lat, dados.coordDestino.lng], {icon: iconeDestino})
            .bindPopup('<b>ğŸ”´ Destino</b><br>' + cidadeDestino)
            .addTo(leafletMarkersLayer);
        
        // Desenhar polyline se disponÃ­vel
        if (dados.polyline && dados.polyline.length > 0) {
            // ORS retorna [lng, lat], Leaflet precisa [lat, lng]
            const latLngs = dados.polyline.map(coord => [coord[1], coord[0]]);
            
            leafletRouteLayer = L.polyline(latLngs, {
                color: '#667eea',
                weight: 5,
                opacity: 0.8,
                dashArray: '10, 10'
            }).addTo(map);
            
            // Ajustar vista para mostrar toda a rota
            map.fitBounds(leafletRouteLayer.getBounds(), {padding: [30, 30]});
        } else {
            // Linha reta se nÃ£o houver polyline
            leafletRouteLayer = L.polyline([
                [dados.coordOrigem.lat, dados.coordOrigem.lng],
                [dados.coordDestino.lat, dados.coordDestino.lng]
            ], {
                color: '#667eea',
                weight: 4,
                opacity: 0.8,
                dashArray: '10, 10'
            }).addTo(map);
            
            map.fitBounds(leafletRouteLayer.getBounds(), {padding: [50, 50]});
        }
        
        // Adicionar label de distÃ¢ncia no meio da rota
        const midLat = (dados.coordOrigem.lat + dados.coordDestino.lat) / 2;
        const midLng = (dados.coordOrigem.lng + dados.coordDestino.lng) / 2;
        
        const labelDistancia = L.divIcon({
            className: 'leaflet-distance-label',
            html: '<div style="background:white;padding:5px 10px;border-radius:15px;border:2px solid #667eea;font-weight:bold;font-size:12px;color:#1e3c72;box-shadow:0 2px 5px rgba(0,0,0,0.2);">' + dados.distancia + ' km</div>',
            iconSize: [80, 30],
            iconAnchor: [40, 15]
        });
        
        L.marker([midLat, midLng], {icon: labelDistancia}).addTo(leafletMarkersLayer);
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // HERE MAPS - VARIÃVEIS GLOBAIS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    let herePlatform = null;
    let hereMap = null;
    let hereUI = null;
    let hereBehavior = null;
    let hereRoutingService = null;
    let hereSearchService = null;
    let hereRouteGroup = null;
    let hereMarkersGroup = null;
    let hereMapInitialized = false;

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // FROTCOM GPS - VARIÃVEIS GLOBAIS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    let frotcomVeiculos = [];
    let frotcomMensagens = [];
    let frotcomRefreshTimer = null;
    let frotcomConnected = false;

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // HERE MAPS - INICIALIZAÃ‡ÃƒO
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    function hereInit() {
        if (typeof H === 'undefined') {
            console.warn('âš ï¸ HERE Maps: API nÃ£o carregada');
            return false;
        }
        
        if (mapsConfig.here.apiKey === 'YOUR_HERE_API_KEY') {
            console.warn('âš ï¸ HERE Maps: API Key nÃ£o configurada. Modo demonstraÃ§Ã£o.');
            return false;
        }
        
        try {
            herePlatform = new H.service.Platform({
                apikey: mapsConfig.here.apiKey
            });
            
            hereRoutingService = herePlatform.getRoutingService(null, 8);
            hereSearchService = herePlatform.getSearchService();
            
            console.log('âœ… HERE Maps inicializado');
            return true;
        } catch (error) {
            console.error('âŒ HERE Maps erro:', error);
            return false;
        }
    }

    // Criar mapa HERE num container
    function hereCreateMap(containerId, lat, lng, zoom) {
        const container = document.getElementById(containerId);
        if (!container) return null;
        
        if (!herePlatform && !hereInit()) {
            console.log('ğŸ“ Usando mapa SVG (fallback)');
            return null;
        }
        
        try {
            container.innerHTML = '';
            const defaultLayers = herePlatform.createDefaultLayers();
            
            hereMap = new H.Map(container, defaultLayers.vector.normal.map, {
                center: { lat: lat || 39.5, lng: lng || -8.0 },
                zoom: zoom || 7,
                pixelRatio: window.devicePixelRatio || 1
            });
            
            hereBehavior = new H.mapevents.Behavior(new H.mapevents.MapEvents(hereMap));
            hereUI = H.ui.UI.createDefault(hereMap, defaultLayers, 'pt-PT');
            
            hereRouteGroup = new H.map.Group();
            hereMarkersGroup = new H.map.Group();
            hereMap.addObject(hereRouteGroup);
            hereMap.addObject(hereMarkersGroup);
            
            window.addEventListener('resize', function() {
                if (hereMap) hereMap.getViewPort().resize();
            });
            
            hereMapInitialized = true;
            console.log('âœ… HERE Map criado');
            return hereMap;
        } catch (error) {
            console.error('âŒ HERE Map erro:', error);
            return null;
        }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // HERE MAPS - GEOCODING (Pesquisar moradas)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    // Pesquisar morada por texto
    function herePesquisarMorada(texto, callback) {
        if (!hereSearchService) {
            callback(null, 'ServiÃ§o nÃ£o disponÃ­vel');
            return;
        }
        
        hereSearchService.geocode({
            q: texto + ', Portugal'
        }, function(result) {
            if (result.items && result.items.length > 0) {
                const item = result.items[0];
                callback({
                    endereco: item.address.label,
                    lat: item.position.lat,
                    lng: item.position.lng,
                    cidade: item.address.city || '',
                    codigoPostal: item.address.postalCode || '',
                    pais: item.address.countryName || 'Portugal',
                    rua: item.address.street || '',
                    numero: item.address.houseNumber || ''
                }, null);
            } else {
                callback(null, 'Morada nÃ£o encontrada');
            }
        }, function(error) {
            callback(null, error.message);
        });
    }

    // Pesquisar empresa por nome
    function herePesquisarEmpresa(nomeEmpresa, cidade, callback) {
        if (!hereSearchService) {
            callback([], 'ServiÃ§o nÃ£o disponÃ­vel');
            return;
        }
        
        const query = nomeEmpresa + (cidade ? ', ' + cidade : '') + ', Portugal';
        
        hereSearchService.discover({
            q: query,
            at: '39.5,-8.0',
            limit: 10
        }, function(result) {
            const empresas = (result.items || []).map(function(item) {
                return {
                    nome: item.title,
                    endereco: item.address ? item.address.label : '',
                    lat: item.position ? item.position.lat : 0,
                    lng: item.position ? item.position.lng : 0,
                    cidade: item.address ? item.address.city : '',
                    codigoPostal: item.address ? item.address.postalCode : '',
                    telefone: item.contacts ? (item.contacts[0]?.phone?.[0]?.value || '') : '',
                    categoria: item.categories ? item.categories[0]?.name : ''
                };
            });
            callback(empresas, null);
        }, function(error) {
            callback([], error.message);
        });
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // HERE MAPS - ROUTING (Rotas para camiÃµes)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    // Calcular rota para veÃ­culos pesados
    function hereCalcularRotaCamiao(origem, destino, opcoes, callback) {
        // Se HERE nÃ£o disponÃ­vel, usar fallback
        if (!hereRoutingService) {
            const dadosFallback = calcularRotaFallback(origem, destino);
            callback(dadosFallback, 'Modo fallback');
            return;
        }
        
        const params = {
            transportMode: 'truck',
            origin: origem.lat + ',' + origem.lng,
            destination: destino.lat + ',' + destino.lng,
            return: 'polyline,travelSummary,tolls',
            'truck[grossWeight]': opcoes?.peso || 40000,
            'truck[height]': opcoes?.altura || 400,
            'truck[width]': opcoes?.largura || 255,
            'truck[length]': opcoes?.comprimento || 1650,
            'truck[axleCount]': opcoes?.eixos || 5,
            'avoid[features]': 'ferry',
            'departureTime': 'now'
        };
        
        if (opcoes?.adr) {
            params['truck[hazardousGoods]'] = opcoes.adr;
        }
        
        hereRoutingService.calculateRoute(params, 
            function(result) {
                if (result.routes && result.routes.length > 0) {
                    const section = result.routes[0].sections[0];
                    const distKm = Math.round(section.travelSummary.length / 1000);
                    
                    callback({
                        distancia: distKm,
                        tempo: formatarTempo(section.travelSummary.duration),
                        tempoSegundos: section.travelSummary.duration,
                        portagens: Math.round(distKm * 0.12 * 100) / 100,
                        combustivel: Math.round((distKm / 100) * 32 * 1.50 * 100) / 100,
                        custoTotal: 0,
                        polyline: section.polyline,
                        coordOrigem: origem,
                        coordDestino: destino,
                        transito: section.travelSummary.trafficDelay || 0,
                        fonte: 'HERE'
                    }, null);
                } else {
                    callback(null, 'Rota nÃ£o encontrada');
                }
            },
            function(error) {
                const dadosFallback = calcularRotaFallback(origem, destino);
                callback(dadosFallback, error.message);
            }
        );
    }

    // Desenhar rota no mapa HERE
    function hereDesenharRota(dados) {
        if (!hereMap || !hereRouteGroup) return;
        
        hereRouteGroup.removeAll();
        hereMarkersGroup.removeAll();
        
        try {
            if (dados.polyline) {
                const lineString = H.geo.LineString.fromFlexiblePolyline(dados.polyline);
                const routeLine = new H.map.Polyline(lineString, {
                    style: { strokeColor: '#667eea', lineWidth: 6, lineCap: 'round' }
                });
                hereRouteGroup.addObject(routeLine);
            }
            
            // Marcador origem
            hereMarkersGroup.addObject(new H.map.Marker(
                { lat: dados.coordOrigem.lat, lng: dados.coordOrigem.lng },
                { icon: hereCreateIcon('#27ae60', 'A') }
            ));
            
            // Marcador destino
            hereMarkersGroup.addObject(new H.map.Marker(
                { lat: dados.coordDestino.lat, lng: dados.coordDestino.lng },
                { icon: hereCreateIcon('#e74c3c', 'B') }
            ));
            
            hereMap.getViewModel().setLookAtData({
                bounds: hereRouteGroup.getBoundingBox()
            });
        } catch (error) {
            console.error('âŒ HERE desenhar rota:', error);
        }
    }

    // Criar Ã­cone SVG para marcadores
    function hereCreateIcon(cor, letra) {
        const svg = '<svg width="32" height="40" xmlns="http://www.w3.org/2000/svg">' +
            '<path d="M16 0C7.2 0 0 7.2 0 16c0 12 16 24 16 24s16-12 16-24C32 7.2 24.8 0 16 0z" fill="' + cor + '"/>' +
            '<circle cx="16" cy="14" r="10" fill="white"/>' +
            '<text x="16" y="18" text-anchor="middle" font-size="12" font-weight="bold" fill="' + cor + '">' + letra + '</text>' +
            '</svg>';
        return new H.map.Icon(svg, { size: { w: 32, h: 40 }, anchor: { x: 16, y: 40 } });
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // FROTCOM GPS - API BIDIRECIONAL
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    // Inicializar conexÃ£o Frotcom
    function frotcomInit() {
        if (mapsConfig.frotcom.apiKey === 'YOUR_FROTCOM_API_KEY') {
            console.warn('âš ï¸ Frotcom: API Key nÃ£o configurada. Modo simulaÃ§Ã£o.');
            frotcomCarregarDadosSimulados();
            return false;
        }
        
        frotcomConnected = true;
        frotcomIniciarAtualizacao();
        console.log('âœ… Frotcom GPS conectado');
        return true;
    }

    // Iniciar atualizaÃ§Ã£o automÃ¡tica de posiÃ§Ãµes
    function frotcomIniciarAtualizacao() {
        if (frotcomRefreshTimer) clearInterval(frotcomRefreshTimer);
        
        frotcomObterPosicoes();
        frotcomRefreshTimer = setInterval(function() {
            frotcomObterPosicoes();
        }, mapsConfig.frotcom.refreshInterval);
    }

    // Parar atualizaÃ§Ã£o
    function frotcomPararAtualizacao() {
        if (frotcomRefreshTimer) {
            clearInterval(frotcomRefreshTimer);
            frotcomRefreshTimer = null;
        }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // FROTCOM GPS - RECEBER DADOS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    // Obter posiÃ§Ãµes de todos os veÃ­culos
    function frotcomObterPosicoes(callback) {
        if (!frotcomConnected) {
            if (callback) callback(frotcomVeiculos, 'Modo simulaÃ§Ã£o');
            return;
        }
        
        fetch(mapsConfig.frotcom.apiUrl + '/vehicles/positions', {
            method: 'GET',
            headers: {
                'Authorization': 'Bearer ' + mapsConfig.frotcom.apiKey,
                'X-Account-Id': mapsConfig.frotcom.accountId,
                'Content-Type': 'application/json'
            }
        })
        .then(function(response) { return response.json(); })
        .then(function(data) {
            frotcomVeiculos = data.vehicles || [];
            console.log('ğŸ“ Frotcom: ' + frotcomVeiculos.length + ' veÃ­culos atualizados');
            if (callback) callback(frotcomVeiculos, null);
            
            // Disparar evento para atualizar UI
            document.dispatchEvent(new CustomEvent('frotcomPosicaoAtualizada', {
                detail: { veiculos: frotcomVeiculos }
            }));
        })
        .catch(function(error) {
            console.error('âŒ Frotcom posiÃ§Ãµes:', error);
            if (callback) callback(frotcomVeiculos, error.message);
        });
    }

    // Obter detalhes de um veÃ­culo especÃ­fico
    function frotcomObterVeiculo(matricula, callback) {
        if (!frotcomConnected) {
            const veiculo = frotcomVeiculos.find(function(v) { return v.matricula === matricula; });
            if (callback) callback(veiculo, 'Modo simulaÃ§Ã£o');
            return;
        }
        
        fetch(mapsConfig.frotcom.apiUrl + '/vehicles/' + matricula, {
            method: 'GET',
            headers: {
                'Authorization': 'Bearer ' + mapsConfig.frotcom.apiKey,
                'X-Account-Id': mapsConfig.frotcom.accountId
            }
        })
        .then(function(response) { return response.json(); })
        .then(function(data) {
            if (callback) callback(data, null);
        })
        .catch(function(error) {
            if (callback) callback(null, error.message);
        });
    }

    // Obter telemetria (consumo, velocidade, etc.)
    function frotcomObterTelemetria(matricula, callback) {
        if (!frotcomConnected) {
            if (callback) callback({
                consumoMedio: 32.5,
                velocidadeMedia: 72,
                kmPercorridos: 1250,
                tempoConducao: '08:45'
            }, 'Modo simulaÃ§Ã£o');
            return;
        }
        
        fetch(mapsConfig.frotcom.apiUrl + '/vehicles/' + matricula + '/telemetry', {
            method: 'GET',
            headers: {
                'Authorization': 'Bearer ' + mapsConfig.frotcom.apiKey,
                'X-Account-Id': mapsConfig.frotcom.accountId
            }
        })
        .then(function(response) { return response.json(); })
        .then(function(data) {
            if (callback) callback(data, null);
        })
        .catch(function(error) {
            if (callback) callback(null, error.message);
        });
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // FROTCOM GPS - ENVIAR DADOS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    // Enviar mensagem para motorista
    function frotcomEnviarMensagem(matricula, mensagem, callback) {
        const msg = {
            id: 'MSG-' + Date.now(),
            matricula: matricula,
            texto: mensagem,
            dataEnvio: new Date().toISOString(),
            estado: 'enviada',
            lida: false
        };
        
        if (!frotcomConnected) {
            // Modo simulaÃ§Ã£o - guardar localmente
            frotcomMensagens.push(msg);
            console.log('ğŸ“¨ Frotcom (simulaÃ§Ã£o): Mensagem enviada para ' + matricula);
            if (callback) callback(msg, 'Modo simulaÃ§Ã£o');
            return;
        }
        
        fetch(mapsConfig.frotcom.apiUrl + '/messages', {
            method: 'POST',
            headers: {
                'Authorization': 'Bearer ' + mapsConfig.frotcom.apiKey,
                'X-Account-Id': mapsConfig.frotcom.accountId,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                vehicleId: matricula,
                message: mensagem,
                priority: 'normal'
            })
        })
        .then(function(response) { return response.json(); })
        .then(function(data) {
            msg.id = data.messageId;
            frotcomMensagens.push(msg);
            console.log('ğŸ“¨ Frotcom: Mensagem enviada - ' + msg.id);
            if (callback) callback(msg, null);
        })
        .catch(function(error) {
            console.error('âŒ Frotcom enviar mensagem:', error);
            if (callback) callback(null, error.message);
        });
    }

    // Enviar ordem de serviÃ§o (rota/destino)
    function frotcomEnviarOrdem(matricula, ordem, callback) {
        const ordemServico = {
            id: 'ORD-' + Date.now(),
            matricula: matricula,
            tipo: ordem.tipo || 'recolha',
            reservaNumero: ordem.reservaNumero,
            cliente: ordem.cliente,
            morada: ordem.morada,
            cidade: ordem.cidade,
            codigoPostal: ordem.codigoPostal,
            lat: ordem.lat,
            lng: ordem.lng,
            instrucoes: ordem.instrucoes || '',
            dataEnvio: new Date().toISOString(),
            estado: 'pendente'
        };
        
        if (!frotcomConnected) {
            console.log('ğŸ“‹ Frotcom (simulaÃ§Ã£o): Ordem enviada para ' + matricula);
            if (callback) callback(ordemServico, 'Modo simulaÃ§Ã£o');
            return;
        }
        
        fetch(mapsConfig.frotcom.apiUrl + '/orders', {
            method: 'POST',
            headers: {
                'Authorization': 'Bearer ' + mapsConfig.frotcom.apiKey,
                'X-Account-Id': mapsConfig.frotcom.accountId,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                vehicleId: matricula,
                order: ordemServico
            })
        })
        .then(function(response) { return response.json(); })
        .then(function(data) {
            ordemServico.id = data.orderId;
            console.log('ğŸ“‹ Frotcom: Ordem enviada - ' + ordemServico.id);
            if (callback) callback(ordemServico, null);
        })
        .catch(function(error) {
            console.error('âŒ Frotcom enviar ordem:', error);
            if (callback) callback(null, error.message);
        });
    }

    // Enviar rota calculada para GPS do veÃ­culo
    function frotcomEnviarRota(matricula, rota, callback) {
        if (!frotcomConnected) {
            console.log('ğŸ—ºï¸ Frotcom (simulaÃ§Ã£o): Rota enviada para ' + matricula);
            if (callback) callback({ success: true }, 'Modo simulaÃ§Ã£o');
            return;
        }
        
        fetch(mapsConfig.frotcom.apiUrl + '/vehicles/' + matricula + '/route', {
            method: 'POST',
            headers: {
                'Authorization': 'Bearer ' + mapsConfig.frotcom.apiKey,
                'X-Account-Id': mapsConfig.frotcom.accountId,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                waypoints: rota.waypoints,
                polyline: rota.polyline
            })
        })
        .then(function(response) { return response.json(); })
        .then(function(data) {
            console.log('ğŸ—ºï¸ Frotcom: Rota enviada para GPS');
            if (callback) callback(data, null);
        })
        .catch(function(error) {
            console.error('âŒ Frotcom enviar rota:', error);
            if (callback) callback(null, error.message);
        });
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // FROTCOM GPS - DADOS SIMULADOS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    function frotcomCarregarDadosSimulados() {
        frotcomVeiculos = [
            { id: 1, matricula: 'AA-00-BB', motorista: 'Manuel Costa', lat: 38.7223, lng: -9.1393, cidade: 'Lisboa', velocidade: 0, estado: 'parado', ultimaAtualizacao: new Date().toISOString() },
            { id: 2, matricula: 'EE-22-FF', motorista: 'Carlos Ferreira', lat: 41.1579, lng: -8.6291, cidade: 'Porto', velocidade: 78, estado: 'em_transito', ultimaAtualizacao: new Date().toISOString() },
            { id: 3, matricula: 'YY-30-ZZ', motorista: 'Rui Martins', lat: 40.2033, lng: -8.4103, cidade: 'Coimbra', velocidade: 65, estado: 'em_transito', ultimaAtualizacao: new Date().toISOString() },
            { id: 4, matricula: 'MN-70-OP', motorista: 'AntÃ³nio Lopes', lat: 37.0194, lng: -7.9322, cidade: 'Faro', velocidade: 0, estado: 'descarga', ultimaAtualizacao: new Date().toISOString() },
            { id: 5, matricula: 'UV-90-WX', motorista: 'Pedro Santos', lat: 41.5518, lng: -8.4229, cidade: 'Braga', velocidade: 82, estado: 'em_transito', ultimaAtualizacao: new Date().toISOString() },
            { id: 6, matricula: 'CD-12-EF', motorista: 'JoÃ£o Oliveira', lat: 38.5244, lng: -8.8882, cidade: 'SetÃºbal', velocidade: 0, estado: 'carga', ultimaAtualizacao: new Date().toISOString() },
            { id: 7, matricula: 'KL-34-MN', motorista: 'Miguel Pereira', lat: 39.7437, lng: -8.8071, cidade: 'Leiria', velocidade: 55, estado: 'em_transito', ultimaAtualizacao: new Date().toISOString() },
            { id: 8, matricula: 'ST-56-UV', motorista: 'Bruno Fernandes', lat: 40.6610, lng: -7.9097, cidade: 'Viseu', velocidade: 0, estado: 'descanso', ultimaAtualizacao: new Date().toISOString() }
        ];
        console.log('ğŸ“ Frotcom: Dados simulados carregados (' + frotcomVeiculos.length + ' veÃ­culos)');
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // FUNÃ‡Ã•ES AUXILIARES
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    function formatarTempo(segundos) {
        const horas = Math.floor(segundos / 3600);
        const minutos = Math.round((segundos % 3600) / 60);
        return horas + 'h ' + minutos + 'min';
    }

    // CÃ¡lculo fallback quando APIs nÃ£o disponÃ­veis
    function calcularRotaFallback(origem, destino) {
        const distancia = calcularDistanciaReservas(
            origem.lat || 39.5, origem.lng || -8.0,
            destino.lat || 41.0, destino.lng || -8.6
        );
        const distanciaAjustada = Math.round(distancia * 1.3);
        
        const horas = Math.floor(distanciaAjustada / 80);
        const minutos = Math.round((distanciaAjustada / 80 - horas) * 60);
        
        const portagens = Math.round(distanciaAjustada * 0.12 * 100) / 100;
        const combustivel = Math.round((distanciaAjustada / 100) * 32 * 1.50 * 100) / 100;
        
        return {
            distancia: distanciaAjustada,
            tempo: horas + 'h ' + minutos + 'min',
            tempoSegundos: (horas * 3600) + (minutos * 60),
            portagens: portagens,
            combustivel: combustivel,
            custoTotal: Math.round((portagens + combustivel) * 100) / 100,
            coordOrigem: origem,
            coordDestino: destino,
            polyline: null,
            fonte: 'Fallback'
        };
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // INTEGRAÃ‡ÃƒO COM MÃ“DULO RESERVAS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    // Abrir mapa de rota (versÃ£o melhorada)
    function abrirMapaRotaIntegrado() {
        const cidadeCarga = document.getElementById('carga_cidade')?.value?.trim() || '';
        const cpCarga = document.getElementById('carga_cp')?.value || '';
        const cidadeDescarga = document.getElementById('descarga_cidade')?.value?.trim() || '';
        const cpDescarga = document.getElementById('descarga_cp')?.value || '';
        
        // âœ… CORREÃ‡ÃƒO v6.13: Validar se cidades estÃ£o preenchidas
        if (!cidadeCarga || !cidadeDescarga) {
            alert('âš ï¸ Por favor, preencha as cidades de Carga (R32) e Descarga (R51) antes de ver o mapa.');
            return;
        }
        
        // âœ… CORREÃ‡ÃƒO v6.13: Validar se cidades sÃ£o diferentes
        if (cidadeCarga.toLowerCase() === cidadeDescarga.toLowerCase()) {
            alert('âš ï¸ A cidade de Carga e Descarga sÃ£o iguais!\n\nPreencha cidades diferentes para calcular a rota.\n\nCarga (R32): ' + cidadeCarga + '\nDescarga (R51): ' + cidadeDescarga);
            return;
        }
        
        // Reset estado
        veiculoSelecionadoRota = null;
        rotaAtualDados = null;
        
        // Reset UI Frotcom
        const divVeiculo = document.getElementById('frotcomVeiculoAtribuido');
        if (divVeiculo) divVeiculo.innerHTML = 'Nenhum veÃ­culo atribuÃ­do';
        const btnEnviar = document.getElementById('btnEnviarRotaGPS');
        if (btnEnviar) btnEnviar.style.display = 'none';
        
        document.getElementById('rotaOrigem').textContent = cidadeCarga + (cpCarga ? ' (' + cpCarga + ')' : '');
        document.getElementById('rotaDestino').textContent = cidadeDescarga + (cpDescarga ? ' (' + cpDescarga + ')' : '');
        
        // Loading state
        document.getElementById('rotaDistancia').innerHTML = '<span style="color:#999">A calcular...</span>';
        document.getElementById('rotaTempo').innerHTML = '<span style="color:#999">A calcular...</span>';
        document.getElementById('rotaPortagens').innerHTML = '<span style="color:#999">...</span>';
        document.getElementById('rotaCombustivel').innerHTML = '<span style="color:#999">...</span>';
        document.getElementById('rotaCustoTotal').innerHTML = '<span style="color:#999">...</span>';
        
        // Reset indicadores
        const fonteIndicador = document.getElementById('rotaFonteIndicador');
        if (fonteIndicador) {
            fonteIndicador.textContent = 'A calcular...';
            fonteIndicador.style.background = '#999';
        }
        
        // Geocoding das cidades (expandido)
        const cidadesCoordenadas = {
            'Lisboa': { lat: 38.7223, lng: -9.1393 },
            'Porto': { lat: 41.1579, lng: -8.6291 },
            'Coimbra': { lat: 40.2033, lng: -8.4103 },
            'Faro': { lat: 37.0194, lng: -7.9322 },
            'Braga': { lat: 41.5518, lng: -8.4229 },
            'SetÃºbal': { lat: 38.5244, lng: -8.8882 },
            'Ã‰vora': { lat: 38.5667, lng: -7.9 },
            'Aveiro': { lat: 40.6405, lng: -8.6538 },
            'Leiria': { lat: 39.7437, lng: -8.8071 },
            'Viseu': { lat: 40.6610, lng: -7.9097 },
            'GuimarÃ£es': { lat: 41.4433, lng: -8.2924 },
            'SantarÃ©m': { lat: 39.2369, lng: -8.6870 },
            'Beja': { lat: 38.0150, lng: -7.8631 },
            'Castelo Branco': { lat: 39.8225, lng: -7.4920 },
            'Vila Real': { lat: 41.3006, lng: -7.7442 },
            'BraganÃ§a': { lat: 41.8061, lng: -6.7567 },
            'Viana do Castelo': { lat: 41.6918, lng: -8.8344 },
            'Funchal': { lat: 32.6669, lng: -16.9241 },
            'Ponta Delgada': { lat: 37.7394, lng: -25.6687 },
            // Espanha
            'Madrid': { lat: 40.4168, lng: -3.7038 },
            'Barcelona': { lat: 41.3851, lng: 2.1734 },
            'Sevilha': { lat: 37.3891, lng: -5.9845 },
            'ValÃªncia': { lat: 39.4699, lng: -0.3763 },
            'Bilbao': { lat: 43.2630, lng: -2.9350 },
            'Zaragoza': { lat: 41.6488, lng: -0.8891 },
            // Europa
            'Paris': { lat: 48.8566, lng: 2.3522 },
            'AmesterdÃ£o': { lat: 52.3676, lng: 4.9041 },
            'Bruxelas': { lat: 50.8503, lng: 4.3517 },
            'Munique': { lat: 48.1351, lng: 11.5820 },
            'Roma': { lat: 41.9028, lng: 12.4964 },
            'MilÃ£o': { lat: 45.4642, lng: 9.1900 },
            'Londres': { lat: 51.5074, lng: -0.1278 },
            'Zurique': { lat: 47.3769, lng: 8.5417 },
            'Viena': { lat: 48.2082, lng: 16.3738 },
            'Frankfurt': { lat: 50.1109, lng: 8.6821 },
            'Hamburgo': { lat: 53.5511, lng: 9.9937 },
            'Berlim': { lat: 52.5200, lng: 13.4050 },
            'VarsÃ³via': { lat: 52.2297, lng: 21.0122 },
            'Praga': { lat: 50.0755, lng: 14.4378 },
            'Budapeste': { lat: 47.4979, lng: 19.0402 },
            'Lyon': { lat: 45.7640, lng: 4.8357 },
            'Marselha': { lat: 43.2965, lng: 5.3698 },
            'BordÃ©us': { lat: 44.8378, lng: -0.5792 }
        };
        
        const orig = cidadesCoordenadas[cidadeCarga] || { lat: 39.5, lng: -8.0 };
        const dest = cidadesCoordenadas[cidadeDescarga] || { lat: 41.0, lng: -8.6 };
        
        // Abrir modal primeiro
        document.getElementById('modalMapaRota').classList.add('active');
        
        // Criar mapa Leaflet
        setTimeout(async function() {
            // Criar mapa
            const map = leafletCriarMapa('mapaRota', 39.5, -8.0, 6);
            
            // Calcular rota com OpenRouteService
            const dados = await orsCalcularRotaCamiao(orig, dest, {
                altura: 4.0,
                largura: 2.5,
                peso: 40,
                cargaEixo: 11.5
            });
            
            if (dados) {
                // Guardar dados da rota para uso posterior
                rotaAtualDados = dados;
                
                // Atualizar UI
                document.getElementById('rotaDistancia').textContent = dados.distancia + ' km';
                document.getElementById('rotaTempo').textContent = dados.tempo;
                document.getElementById('rotaPortagens').textContent = dados.portagens.toFixed(2) + ' â‚¬';
                document.getElementById('rotaCombustivel').textContent = dados.combustivel.toFixed(2) + ' â‚¬';
                document.getElementById('rotaCustoTotal').textContent = dados.custoTotal.toFixed(2) + ' â‚¬';
                
                // Atualizar indicador de fonte
                const fonteInd = document.getElementById('rotaFonteIndicador');
                if (fonteInd) {
                    if (dados.fonte === 'OpenRouteService') {
                        fonteInd.textContent = 'ğŸš› OpenRouteService';
                        fonteInd.style.background = '#27ae60';
                    } else {
                        fonteInd.textContent = 'Estimativa';
                        fonteInd.style.background = '#6c757d';
                    }
                }
                
                // Desenhar rota no mapa Leaflet
                if (map) {
                    leafletDesenharRota(map, dados, cidadeCarga, cidadeDescarga);
                }
            }
        }, 200);
    }

    // Desenhar mapa SVG (fallback)
    function desenharMapaRotaSVG(origem, destino, dados) {
        const mapa = document.getElementById('mapaRota');
        if (!mapa) return;
        
        let svg = '<svg viewBox="0 0 300 450" preserveAspectRatio="xMidYMid meet" style="width:100%;height:100%;background:linear-gradient(180deg, #87CEEB 0%, #E0F7FA 100%);">';
        svg += '<path d="M120,30 L160,25 L200,35 L220,60 L230,100 L225,150 L220,200 L210,250 L200,300 L185,350 L160,400 L130,420 L100,410 L85,370 L75,320 L65,270 L60,220 L65,170 L75,120 L90,70 L110,40 Z" fill="#F5F5DC" stroke="#8B7355" stroke-width="2"/>';
        
        const x1 = mapearLng2(dados.coordOrigem.lng);
        const y1 = mapearLat2(dados.coordOrigem.lat);
        const x2 = mapearLng2(dados.coordDestino.lng);
        const y2 = mapearLat2(dados.coordDestino.lat);
        
        svg += '<line x1="' + x1 + '" y1="' + y1 + '" x2="' + x2 + '" y2="' + y2 + '" stroke="#667eea" stroke-width="4" stroke-dasharray="10,5"/>';
        
        svg += '<circle cx="' + x1 + '" cy="' + y1 + '" r="15" fill="#27ae60" stroke="white" stroke-width="3"/>';
        svg += '<text x="' + x1 + '" y="' + (y1 + 5) + '" text-anchor="middle" fill="white" font-size="12" font-weight="bold">A</text>';
        svg += '<text x="' + x1 + '" y="' + (y1 + 30) + '" text-anchor="middle" fill="#1e3c72" font-size="10" font-weight="bold">' + origem + '</text>';
        
        svg += '<circle cx="' + x2 + '" cy="' + y2 + '" r="15" fill="#e74c3c" stroke="white" stroke-width="3"/>';
        svg += '<text x="' + x2 + '" y="' + (y2 + 5) + '" text-anchor="middle" fill="white" font-size="12" font-weight="bold">B</text>';
        svg += '<text x="' + x2 + '" y="' + (y2 + 30) + '" text-anchor="middle" fill="#1e3c72" font-size="10" font-weight="bold">' + destino + '</text>';
        
        const xMeio = (x1 + x2) / 2;
        const yMeio = (y1 + y2) / 2;
        svg += '<rect x="' + (xMeio - 30) + '" y="' + (yMeio - 10) + '" width="60" height="20" rx="10" fill="white" stroke="#667eea" stroke-width="2"/>';
        svg += '<text x="' + xMeio + '" y="' + (yMeio + 4) + '" text-anchor="middle" fill="#1e3c72" font-size="10" font-weight="bold">' + dados.distancia + ' km</text>';
        
        // Indicador modo fallback
        svg += '<text x="150" y="440" text-anchor="middle" fill="#999" font-size="8">Mapa ilustrativo</text>';
        
        svg += '</svg>';
        mapa.innerHTML = svg;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // PESQUISA DE EMPRESAS (para campos morada)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    function pesquisarEmpresaParaCampo(nomeEmpresa, campoPrefix) {
        herePesquisarEmpresa(nomeEmpresa, null, function(empresas, erro) {
            if (empresas && empresas.length > 0) {
                mostrarResultadosPesquisaEmpresa(empresas, campoPrefix);
            } else {
                alert('Nenhuma empresa encontrada com esse nome.');
            }
        });
    }

    function mostrarResultadosPesquisaEmpresa(empresas, campoPrefix) {
        let html = '<div style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:white;padding:20px;border-radius:10px;box-shadow:0 10px 40px rgba(0,0,0,0.3);z-index:10001;max-height:80vh;overflow-y:auto;min-width:400px;">';
        html += '<h3 style="margin-bottom:15px;color:#1e3c72;">ğŸ“ Selecionar Empresa</h3>';
        html += '<div style="max-height:300px;overflow-y:auto;">';
        
        empresas.forEach(function(emp, idx) {
            html += '<div onclick="selecionarEmpresaPesquisa(' + idx + ', \'' + campoPrefix + '\')" style="padding:12px;margin:5px 0;border:1px solid #ddd;border-radius:8px;cursor:pointer;transition:all 0.2s;" onmouseover="this.style.background=\'#f0f4ff\'" onmouseout="this.style.background=\'white\'">';
            html += '<strong>' + emp.nome + '</strong><br>';
            html += '<small style="color:#666;">' + emp.endereco + '</small>';
            if (emp.telefone) html += '<br><small style="color:#27ae60;">ğŸ“ ' + emp.telefone + '</small>';
            html += '</div>';
        });
        
        html += '</div>';
        html += '<button onclick="this.parentElement.remove()" style="margin-top:15px;padding:10px 20px;background:#6c757d;color:white;border:none;border-radius:5px;cursor:pointer;">Fechar</button>';
        html += '</div>';
        html += '<div onclick="this.previousSibling.remove();this.remove();" style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:10000;"></div>';
        
        // Guardar empresas temporariamente
        window.empresasPesquisaTemp = empresas;
        
        document.body.insertAdjacentHTML('beforeend', html);
    }

    function selecionarEmpresaPesquisa(idx, campoPrefix) {
        const emp = window.empresasPesquisaTemp[idx];
        if (!emp) return;
        
        // Preencher campos
        const campoMorada = document.getElementById(campoPrefix + '_morada');
        const campoCidade = document.getElementById(campoPrefix + '_cidade');
        const campoCP = document.getElementById(campoPrefix + '_cp');
        
        if (campoMorada) campoMorada.value = emp.endereco;
        if (campoCidade) campoCidade.value = emp.cidade;
        if (campoCP) campoCP.value = emp.codigoPostal;
        
        // Fechar modal
        document.querySelector('[onclick*="empresasPesquisaTemp"]')?.parentElement?.remove();
        document.querySelector('[style*="z-index:10000"]')?.remove();
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // INICIALIZAÃ‡ÃƒO
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    // Inicializar sistemas de mapa quando pÃ¡gina carrega
    document.addEventListener('DOMContentLoaded', function() {
        // Inicializar HERE Maps
        setTimeout(function() {
            hereInit();
        }, 1000);
        
        // Inicializar Frotcom GPS
        setTimeout(function() {
            frotcomInit();
        }, 1500);
        
        console.log('ğŸ—ºï¸ Sistemas de Mapa/GPS iniciados');
    });

    // Substituir funÃ§Ã£o original por versÃ£o integrada
    var abrirMapaRotaOriginal = typeof abrirMapaRota === 'function' ? abrirMapaRota : null;
    abrirMapaRota = function() {
        abrirMapaRotaIntegrado();
    };

    console.log('âœ… HERE Maps + Frotcom GPS v1.0 carregado');

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // FUNÃ‡Ã•ES AUXILIARES FROTCOM
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    var veiculoSelecionadoRota = null;
    var rotaAtualDados = null;

    // Abrir modal para selecionar veÃ­culo
    function abrirSelecionarVeiculoFrotcom() {
        let html = '<div id="modalSelecionarVeiculo" style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);z-index:10002;display:flex;align-items:center;justify-content:center;">';
        html += '<div style="background:white;padding:25px;border-radius:12px;max-width:600px;width:90%;max-height:80vh;overflow-y:auto;">';
        html += '<h3 style="margin-bottom:20px;color:#1e3c72;border-bottom:2px solid #17a2b8;padding-bottom:10px;">ğŸš› Selecionar VeÃ­culo da Frota</h3>';
        html += '<input type="text" id="pesquisaVeiculoFrotcom" placeholder="ğŸ” Pesquisar por matrÃ­cula ou motorista..." style="width:100%;padding:12px;border:2px solid #dee2e6;border-radius:8px;margin-bottom:15px;font-size:14px;" oninput="filtrarVeiculosFrotcom()">';
        html += '<div id="listaVeiculosFrotcom" style="max-height:400px;overflow-y:auto;">';
        
        frotcomVeiculos.forEach(function(v) {
            const estadoCor = v.estado === 'em_transito' ? '#27ae60' : 
                              v.estado === 'parado' ? '#6c757d' :
                              v.estado === 'carga' ? '#f39c12' :
                              v.estado === 'descarga' ? '#3498db' : '#e74c3c';
            const estadoTexto = v.estado === 'em_transito' ? 'Em TrÃ¢nsito' :
                                v.estado === 'parado' ? 'Parado' :
                                v.estado === 'carga' ? 'Em Carga' :
                                v.estado === 'descarga' ? 'Em Descarga' : 'Descanso';
            
            html += '<div class="veiculo-item-frotcom" onclick="selecionarVeiculoFrotcom(\'' + v.matricula + '\')" style="padding:15px;margin:8px 0;border:2px solid #dee2e6;border-radius:10px;cursor:pointer;display:flex;justify-content:space-between;align-items:center;transition:all 0.2s;" onmouseover="this.style.borderColor=\'#17a2b8\';this.style.background=\'#f0f9ff\'" onmouseout="this.style.borderColor=\'#dee2e6\';this.style.background=\'white\'">';
            html += '<div>';
            html += '<strong style="font-size:16px;color:#1e3c72;">' + v.matricula + '</strong>';
            html += '<br><span style="color:#666;font-size:13px;">ğŸ‘¤ ' + v.motorista + '</span>';
            html += '<br><span style="color:#888;font-size:12px;">ğŸ“ ' + v.cidade + '</span>';
            html += '</div>';
            html += '<div style="text-align:right;">';
            html += '<span style="background:' + estadoCor + ';color:white;padding:4px 10px;border-radius:12px;font-size:11px;font-weight:bold;">' + estadoTexto + '</span>';
            if (v.velocidade > 0) {
                html += '<br><span style="color:#27ae60;font-size:12px;margin-top:5px;display:inline-block;">ğŸš› ' + v.velocidade + ' km/h</span>';
            }
            html += '</div>';
            html += '</div>';
        });
        
        html += '</div>';
        html += '<div style="margin-top:20px;text-align:right;">';
        html += '<button onclick="fecharModalVeiculoFrotcom()" style="padding:12px 25px;background:#6c757d;color:white;border:none;border-radius:8px;font-weight:bold;cursor:pointer;">Cancelar</button>';
        html += '</div>';
        html += '</div>';
        html += '</div>';
        
        document.body.insertAdjacentHTML('beforeend', html);
    }

    // Filtrar veÃ­culos na pesquisa
    function filtrarVeiculosFrotcom() {
        const termo = document.getElementById('pesquisaVeiculoFrotcom').value.toLowerCase();
        const items = document.querySelectorAll('.veiculo-item-frotcom');
        
        items.forEach(function(item) {
            const texto = item.textContent.toLowerCase();
            item.style.display = texto.includes(termo) ? 'flex' : 'none';
        });
    }

    // Selecionar veÃ­culo
    function selecionarVeiculoFrotcom(matricula) {
        const veiculo = frotcomVeiculos.find(function(v) { return v.matricula === matricula; });
        if (!veiculo) return;
        
        veiculoSelecionadoRota = veiculo;
        
        // Atualizar UI
        const divVeiculo = document.getElementById('frotcomVeiculoAtribuido');
        if (divVeiculo) {
            divVeiculo.innerHTML = '<strong style="color:#1e3c72;">' + veiculo.matricula + '</strong><br>' +
                '<span style="font-size:11px;">ğŸ‘¤ ' + veiculo.motorista + '</span><br>' +
                '<span style="font-size:11px;">ğŸ“ ' + veiculo.cidade + '</span>';
        }
        
        // Mostrar botÃ£o de enviar rota
        const btnEnviar = document.getElementById('btnEnviarRotaGPS');
        if (btnEnviar) btnEnviar.style.display = 'block';
        
        fecharModalVeiculoFrotcom();
        
        console.log('âœ… VeÃ­culo selecionado:', veiculo.matricula);
    }

    // Fechar modal de seleÃ§Ã£o
    function fecharModalVeiculoFrotcom() {
        const modal = document.getElementById('modalSelecionarVeiculo');
        if (modal) modal.remove();
    }

    // Enviar rota para GPS do veÃ­culo
    function enviarRotaParaGPS() {
        if (!veiculoSelecionadoRota) {
            alert('âš ï¸ Selecione primeiro um veÃ­culo!');
            return;
        }
        
        if (!rotaAtualDados) {
            alert('âš ï¸ Calcule a rota primeiro!');
            return;
        }
        
        // Preparar dados da rota
        const dadosRota = {
            waypoints: [
                { lat: rotaAtualDados.coordOrigem.lat, lng: rotaAtualDados.coordOrigem.lng, tipo: 'origem' },
                { lat: rotaAtualDados.coordDestino.lat, lng: rotaAtualDados.coordDestino.lng, tipo: 'destino' }
            ],
            polyline: rotaAtualDados.polyline,
            distancia: rotaAtualDados.distancia,
            tempoEstimado: rotaAtualDados.tempoSegundos
        };
        
        frotcomEnviarRota(veiculoSelecionadoRota.matricula, dadosRota, function(resultado, erro) {
            if (erro && erro !== 'Modo simulaÃ§Ã£o') {
                alert('âŒ Erro ao enviar rota: ' + erro);
            } else {
                alert('âœ… Rota enviada com sucesso!\n\nğŸš› VeÃ­culo: ' + veiculoSelecionadoRota.matricula + '\nğŸ‘¤ Motorista: ' + veiculoSelecionadoRota.motorista + '\n\nA rota serÃ¡ exibida no GPS do veÃ­culo.');
                
                // Enviar tambÃ©m mensagem informativa
                const mensagem = 'ğŸ“‹ Nova rota atribuÃ­da. DistÃ¢ncia: ' + rotaAtualDados.distancia + ' km. Tempo estimado: ' + rotaAtualDados.tempo;
                frotcomEnviarMensagem(veiculoSelecionadoRota.matricula, mensagem, function() {
                    console.log('ğŸ“¨ Mensagem de rota enviada');
                });
            }
        });
    }

    // Recalcular rota
    function recalcularRota() {
        abrirMapaRotaIntegrado();
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // FIM HERE MAPS + FROTCOM GPS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function faturarReserva(numFatura) {
        reservaFaturada = true;
        
        const campoFatura = document.getElementById('numero_fatura');
        campoFatura.value = numFatura;
        campoFatura.style.background = '#f8d7da';
        campoFatura.style.borderColor = '#dc3545';
        campoFatura.style.color = '#dc3545';
        
        document.getElementById('faturaBanner').classList.add('bloqueada');
        document.getElementById('numFaturaDisplay').textContent = numFatura;
        document.getElementById('statusFatura').innerHTML = 'ğŸ”’ Reserva Faturada - Bloqueada';
        
        ['secao1','secao2','secao3','secao4','secao6'].forEach(id => {
            document.getElementById(id).classList.add('bloqueada');
        });
        
        document.getElementById('btnAlterar').disabled = true;
        document.getElementById('btnAlterar').style.background = '#ccc';
        document.getElementById('btnAlterar').style.cursor = 'not-allowed';
        document.getElementById('btnAlterar').title = 'Reserva faturada - nÃ£o pode ser alterada';
        
        if (numReserva) {
            const index = todasReservas.findIndex(r => r.numero === numReserva);
            if (index >= 0) {
                todasReservas[index].faturada = true;
                todasReservas[index].faturaNumero = numFatura;
                todasReservas[index].dataFaturacao = new Date().toISOString();
                guardarReservasLS();
                console.log('ğŸ’¾ Reserva marcada como faturada no localStorage');
                
                // ğŸ“œ REGISTAR NO HISTÃ“RICO
                registarHistoricoReserva(numReserva, 'FATURACAO', 
                    'Reserva faturada com nÃºmero: ' + numFatura, 
                    { faturaNumero: { antes: null, depois: numFatura } }
                );
            }
        }
        
        // ğŸ”’ BLOQUEAR TODOS OS CAMPOS (exceto R62 IncidÃªncias)
        bloquearCamposReserva();
        
        alert('ğŸ“„ RESERVA FATURADA!\n\nNÂº Fatura: ' + numFatura + '\n\nğŸ”’ A reserva estÃ¡ agora BLOQUEADA.\n\nâš ï¸ Apenas o campo de IncidÃªncias (SecÃ§Ã£o 5, Campo R62) pode ser editado.\n\nğŸ“œ Clique em "Ver HistÃ³rico" para consultar todas as alteraÃ§Ãµes.');
    }

    function alterarReserva() {
        // Chamar a nova funÃ§Ã£o de desbloqueio para ediÃ§Ã£o
        desbloquearReservaParaEdicao();
    }

    function gerarQR() {
        // Gerar QR Code na SecÃ§Ã£o 1 (ao lado do R3) - v6.10
        const qrContainer = document.getElementById('reservaQRCode');
        if (qrContainer && typeof QRCode !== 'undefined' && numReserva) {
            qrContainer.innerHTML = '';
            qrContainer.style.display = 'flex';
            qrContainer.style.alignItems = 'center';
            qrContainer.style.justifyContent = 'center';
            new QRCode(qrContainer, {
                text: numReserva,
                width: 65,
                height: 65,
                colorDark: '#1e3c72',
                colorLight: '#ffffff',
                correctLevel: QRCode.CorrectLevel.M
            });
            console.log('ğŸ“± QR Code gerado para:', numReserva);
        }
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // MÃ“DULO AGENDA 1 v29 - JAVASCRIPT ORIGINAL (NÃƒO ALTERAR)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
// ========== DADOS ==========
    let agenda1Dados = [
      { id: 1, tipo: 'reserva', visivel: true, ordemCarga: null, numeroReserva: 'RES-001', msgEnviada: false, comercial: 'JoÃ£o Silva', dataCarga: '2025-01-15', cliente: 'Empresa ABC Lda', cmrCarga: null, cmrDescarga: null, ldm: 3.5, peso: 1200, quantidadeBultos: 15, cidadeCarga: 'Lisboa', codigoPostalCarga: 'PT-1000-001', codigoPostalDescarga: 'PT-4000-001', cidadeDescarga: 'Porto', prioridadeCarga: 'Alta', dataEntrega: '2025-01-17', motoristaRecolha: null, tratorRecolha: null, reboqueRecolha: null, valorServico: 850.00, estadoReserva: 'No Cliente', selected: false, grupagemId: null },
      { id: 2, tipo: 'reserva', visivel: true, ordemCarga: null, numeroReserva: 'RES-002', msgEnviada: false, comercial: 'Ana Santos', dataCarga: '2025-01-16', cliente: 'Transportes XYZ', cmrCarga: null, cmrDescarga: null, ldm: 5.0, peso: 2500, quantidadeBultos: 30, cidadeCarga: 'Coimbra', codigoPostalCarga: 'PT-3000-001', codigoPostalDescarga: 'PT-1200-001', cidadeDescarga: 'Lisboa', prioridadeCarga: 'Urgente', dataEntrega: '2025-01-17', motoristaRecolha: null, tratorRecolha: null, reboqueRecolha: null, valorServico: 1250.00, estadoReserva: 'Em TrÃ¢nsito', selected: false, grupagemId: null },
      { id: 3, tipo: 'reserva', visivel: true, ordemCarga: null, numeroReserva: 'RES-003', msgEnviada: false, comercial: 'Pedro Oliveira', dataCarga: '2025-01-14', cliente: 'LogÃ­stica Norte SA', cmrCarga: 'cmr_003.pdf', cmrDescarga: null, ldm: 2.0, peso: 800, quantidadeBultos: 8, cidadeCarga: 'Braga', codigoPostalCarga: 'PT-4700-001', codigoPostalDescarga: 'DE-80331', cidadeDescarga: 'Munique', prioridadeCarga: 'Normal', dataEntrega: '2025-01-16', motoristaRecolha: null, tratorRecolha: null, reboqueRecolha: null, valorServico: 580.00, estadoReserva: 'Entregue', selected: false, grupagemId: null },
      { id: 4, tipo: 'reserva', visivel: true, ordemCarga: null, numeroReserva: 'RES-004', msgEnviada: false, comercial: 'Maria Fernandes', dataCarga: '2025-01-18', cliente: 'IndÃºstria Global SA', cmrCarga: null, cmrDescarga: null, ldm: 6.2, peso: 3200, quantidadeBultos: 45, cidadeCarga: 'SetÃºbal', codigoPostalCarga: 'PT-2900-001', codigoPostalDescarga: 'ES-08001', cidadeDescarga: 'Barcelona', prioridadeCarga: 'Alta', dataEntrega: '2025-01-20', motoristaRecolha: null, tratorRecolha: null, reboqueRecolha: null, valorServico: 1450.00, estadoReserva: 'No Cliente', selected: false, grupagemId: null },
      { id: 5, tipo: 'reserva', visivel: true, ordemCarga: null, numeroReserva: 'RES-005', msgEnviada: false, comercial: 'JoÃ£o Silva', dataCarga: '2025-01-19', cliente: 'MetalÃºrgica Centro Lda', cmrCarga: null, cmrDescarga: null, ldm: 4.0, peso: 1800, quantidadeBultos: 22, cidadeCarga: 'Aveiro', codigoPostalCarga: 'PT-3800-001', codigoPostalDescarga: 'FR-75001', cidadeDescarga: 'Paris', prioridadeCarga: 'Normal', dataEntrega: '2025-01-21', motoristaRecolha: null, tratorRecolha: null, reboqueRecolha: null, valorServico: 920.00, estadoReserva: 'No Cliente', selected: false, grupagemId: null },
      { id: 6, tipo: 'reserva', visivel: true, ordemCarga: null, numeroReserva: 'RES-006', msgEnviada: false, comercial: 'Ana Santos', dataCarga: '2025-01-17', cliente: 'Distribuidora Sul SA', cmrCarga: 'cmr_006.pdf', cmrDescarga: null, ldm: 7.5, peso: 4100, quantidadeBultos: 55, cidadeCarga: 'Ã‰vora', codigoPostalCarga: 'PT-7000-001', codigoPostalDescarga: 'NL-1012', cidadeDescarga: 'AmesterdÃ£o', prioridadeCarga: 'Urgente', dataEntrega: '2025-01-18', motoristaRecolha: null, tratorRecolha: null, reboqueRecolha: null, valorServico: 1680.00, estadoReserva: 'Em TrÃ¢nsito', selected: false, grupagemId: null },
      { id: 7, tipo: 'reserva', visivel: true, ordemCarga: null, numeroReserva: 'RES-007', msgEnviada: false, comercial: 'Pedro Oliveira', dataCarga: '2025-01-20', cliente: 'TÃªxteis Minho Lda', cmrCarga: null, cmrDescarga: null, ldm: 2.8, peso: 950, quantidadeBultos: 12, cidadeCarga: 'GuimarÃ£es', codigoPostalCarga: 'PT-4800-001', codigoPostalDescarga: 'BE-1000', cidadeDescarga: 'Bruxelas', prioridadeCarga: 'Baixa', dataEntrega: '2025-01-23', motoristaRecolha: null, tratorRecolha: null, reboqueRecolha: null, valorServico: 520.00, estadoReserva: 'No Cliente', selected: false, grupagemId: null },
      { id: 8, tipo: 'reserva', visivel: true, ordemCarga: null, numeroReserva: 'RES-008', msgEnviada: false, comercial: 'Maria Fernandes', dataCarga: '2025-01-13', cliente: 'ConstruÃ§Ãµes Tejo SA', cmrCarga: 'cmr_008.pdf', cmrDescarga: 'cmr_desc_008.pdf', ldm: 8.0, peso: 5500, quantidadeBultos: 18, cidadeCarga: 'SantarÃ©m', codigoPostalCarga: 'PT-2000-001', codigoPostalDescarga: 'IT-00100', cidadeDescarga: 'Roma', prioridadeCarga: 'Alta', dataEntrega: '2025-01-15', motoristaRecolha: null, tratorRecolha: null, reboqueRecolha: null, valorServico: 2100.00, estadoReserva: 'Entregue', selected: false, grupagemId: null },
      { id: 9, tipo: 'reserva', visivel: true, ordemCarga: null, numeroReserva: 'RES-009', msgEnviada: false, comercial: 'JoÃ£o Silva', dataCarga: '2025-01-21', cliente: 'Alimentar Express Lda', cmrCarga: null, cmrDescarga: null, ldm: 3.2, peso: 1400, quantidadeBultos: 35, cidadeCarga: 'Porto', codigoPostalCarga: 'PT-4000-001', codigoPostalDescarga: 'PT-1500-001', cidadeDescarga: 'Lisboa', prioridadeCarga: 'Urgente', dataEntrega: '2025-01-22', motoristaRecolha: null, tratorRecolha: null, reboqueRecolha: null, valorServico: 780.00, estadoReserva: 'No Cliente', selected: false, grupagemId: null },
      { id: 10, tipo: 'reserva', visivel: true, ordemCarga: null, numeroReserva: 'RES-010', msgEnviada: false, comercial: 'Ana Santos', dataCarga: '2025-01-22', cliente: 'Pharma DistribuiÃ§Ã£o SA', cmrCarga: null, cmrDescarga: null, ldm: 1.5, peso: 450, quantidadeBultos: 28, cidadeCarga: 'Lisboa', codigoPostalCarga: 'PT-1100-001', codigoPostalDescarga: 'PT-3000-001', cidadeDescarga: 'Coimbra', prioridadeCarga: 'Alta', dataEntrega: '2025-01-23', motoristaRecolha: null, tratorRecolha: null, reboqueRecolha: null, valorServico: 650.00, estadoReserva: 'No Cliente', selected: false, grupagemId: null },
      { id: 11, tipo: 'reserva', visivel: true, ordemCarga: null, numeroReserva: 'RES-011', msgEnviada: false, comercial: 'Pedro Oliveira', dataCarga: '2025-01-12', cliente: 'MÃ³veis Alentejo Lda', cmrCarga: 'cmr_011.pdf', cmrDescarga: 'cmr_desc_011.pdf', ldm: 9.0, peso: 2800, quantidadeBultos: 6, cidadeCarga: 'Beja', codigoPostalCarga: 'PT-7800-001', codigoPostalDescarga: 'ES-28001', cidadeDescarga: 'Madrid', prioridadeCarga: 'Normal', dataEntrega: '2025-01-14', motoristaRecolha: null, tratorRecolha: null, reboqueRecolha: null, valorServico: 1890.00, estadoReserva: 'Entregue', selected: false, grupagemId: null },
      { id: 12, tipo: 'reserva', visivel: true, ordemCarga: null, numeroReserva: 'RES-012', msgEnviada: false, comercial: 'Maria Fernandes', dataCarga: '2025-01-23', cliente: 'Tech Solutions SA', cmrCarga: null, cmrDescarga: null, ldm: 2.2, peso: 380, quantidadeBultos: 42, cidadeCarga: 'Oeiras', codigoPostalCarga: 'PT-2780-001', codigoPostalDescarga: 'PT-4100-001', cidadeDescarga: 'Porto', prioridadeCarga: 'Urgente', dataEntrega: '2025-01-24', motoristaRecolha: null, tratorRecolha: null, reboqueRecolha: null, valorServico: 720.00, estadoReserva: 'No Cliente', selected: false, grupagemId: null },
      { id: 13, tipo: 'reserva', visivel: true, ordemCarga: null, numeroReserva: 'RES-013', msgEnviada: false, comercial: 'JoÃ£o Silva', dataCarga: '2025-01-11', cliente: 'Vinhos do Douro Lda', cmrCarga: 'cmr_013.pdf', cmrDescarga: 'cmr_desc_013.pdf', ldm: 4.5, peso: 3800, quantidadeBultos: 120, cidadeCarga: 'Vila Real', codigoPostalCarga: 'PT-5000-001', codigoPostalDescarga: 'UK-SW1A', cidadeDescarga: 'Londres', prioridadeCarga: 'Normal', dataEntrega: '2025-01-13', motoristaRecolha: null, tratorRecolha: null, reboqueRecolha: null, valorServico: 1350.00, estadoReserva: 'Entregue', selected: false, grupagemId: null },
      { id: 14, tipo: 'reserva', visivel: true, ordemCarga: null, numeroReserva: 'RES-014', msgEnviada: false, comercial: 'Ana Santos', dataCarga: '2025-01-24', cliente: 'CerÃ¢mica Portuguesa SA', cmrCarga: null, cmrDescarga: null, ldm: 5.8, peso: 4200, quantidadeBultos: 85, cidadeCarga: 'Caldas da Rainha', codigoPostalCarga: 'PT-2500-001', codigoPostalDescarga: 'CH-8001', cidadeDescarga: 'Zurique', prioridadeCarga: 'Baixa', dataEntrega: '2025-01-27', motoristaRecolha: null, tratorRecolha: null, reboqueRecolha: null, valorServico: 1580.00, estadoReserva: 'No Cliente', selected: false, grupagemId: null },
      { id: 15, tipo: 'reserva', visivel: true, ordemCarga: null, numeroReserva: 'RES-015', msgEnviada: false, comercial: 'Pedro Oliveira', dataCarga: '2025-01-10', cliente: 'Auto PeÃ§as Nacional Lda', cmrCarga: 'cmr_015.pdf', cmrDescarga: null, ldm: 3.8, peso: 1650, quantidadeBultos: 58, cidadeCarga: 'Maia', codigoPostalCarga: 'PT-4470-001', codigoPostalDescarga: 'AT-1010', cidadeDescarga: 'Viena', prioridadeCarga: 'Alta', dataEntrega: '2025-01-12', motoristaRecolha: null, tratorRecolha: null, reboqueRecolha: null, valorServico: 890.00, estadoReserva: 'Cancelada', selected: false, grupagemId: null }
    ];

    // ========== FROTA (MÃ³dulo GestÃ£o de Frota) ==========
    const agenda1FrotaMotoristas = [
      { id: 1, nome: 'Manuel Costa' },
      { id: 2, nome: 'Carlos Ferreira' },
      { id: 3, nome: 'Rui Martins' },
      { id: 4, nome: 'AntÃ³nio Lopes' },
      { id: 5, nome: 'JosÃ© Rodrigues' },
      { id: 6, nome: 'Francisco Alves' }
    ];
    
    const agenda1FrotaTratores = [
      { id: 1, matricula: 'AA-00-BB', gps: true },
      { id: 2, matricula: 'EE-22-FF', gps: true },
      { id: 3, matricula: 'YY-30-ZZ', gps: true },
      { id: 4, matricula: 'MN-70-OP', gps: true },
      { id: 5, matricula: 'UV-90-WX', gps: true },
      { id: 6, matricula: 'CD-12-EF', gps: true },
      { id: 7, matricula: 'KL-34-MN', gps: true },
      { id: 8, matricula: 'ST-56-UV', gps: true },
      { id: 9, matricula: 'AB-78-CD', gps: true },
      { id: 10, matricula: 'IJ-90-KL', gps: true }
    ];
    
    const agenda1FrotaReboques = [
      { id: 1, matricula: 'CC-11-DD', gps: true },
      { id: 2, matricula: 'GG-33-HH', gps: true },
      { id: 3, matricula: 'AB-40-CD', gps: true },
      { id: 4, matricula: 'QR-80-ST', gps: true },
      { id: 5, matricula: 'YZ-01-AB', gps: true },
      { id: 6, matricula: 'GH-23-IJ', gps: true },
      { id: 7, matricula: 'OP-45-QR', gps: true },
      { id: 8, matricula: 'WX-67-YZ', gps: true },
      { id: 9, matricula: 'EF-89-GH', gps: true },
      { id: 10, matricula: 'MN-01-OP', gps: true }
    ];

    let agenda1Grupagens = [];
    let agenda1CargasDiretas = [];
    let agenda1ContadorGrupagens = 0;
    let agenda1ContadorCargasDiretas = 0;
    let agenda1ContadorBlancos = 0;
    let agenda1CurrentZoom = 100;
    let agenda1DraggedId = null;
    let agenda1GruposIds = [];
    let agenda1SortDirection = {};

    // ========== UTILITÃRIOS ==========
    function agenda1FormatDate(d) { return d ? new Date(d).toLocaleDateString('pt-PT') : ''; }
    function agenda1FormatCurrency(v) { return new Intl.NumberFormat('pt-PT', { style: 'currency', currency: 'EUR' }).format(v || 0); }
    function agenda1GetPrioridadeClass(p) { return { 'Baixa': 'bg-gray-200 text-gray-700', 'Normal': 'bg-blue-200 text-blue-700', 'Alta': 'bg-orange-200 text-orange-700', 'Urgente': 'bg-red-200 text-red-700' }[p] || 'bg-gray-200'; }
    function agenda1GetEstadoClass(e) { return { 'No Cliente': 'bg-yellow-200 text-yellow-800', 'Em TrÃ¢nsito': 'bg-purple-200 text-purple-800', 'Entregue': 'bg-green-200 text-green-800', 'Cancelada': 'bg-red-200 text-red-800' }[e] || 'bg-gray-200'; }
    function agenda1IsAtrasado(r) { if (!r.dataCarga || r.cmrCarga) return false; const h = new Date(); h.setHours(0,0,0,0); const d = new Date(r.dataCarga); d.setHours(0,0,0,0); return d <= h; }
    function agenda1CalcularKM(cp1, cp2) { return Math.round(Math.abs(parseInt(cp1.replace('-','')) - parseInt(cp2.replace('-',''))) / 10 + 100); }

    // ========== ORDENAR POR COLUNA ==========
    function agenda1SortBy(campo) {
      // Toggle direction
      agenda1SortDirection[campo] = !agenda1SortDirection[campo];
      const asc = agenda1SortDirection[campo];
      
      // Separar agenda1Dados livres
      const livres = agenda1Dados.filter(d => d.tipo === 'reserva' && !d.grupagemId);
      const outros = agenda1Dados.filter(d => d.tipo !== 'reserva' || d.grupagemId);
      
      livres.sort((a, b) => {
        let valA = a[campo];
        let valB = b[campo];
        
        // Tratar nulls
        if (valA === null || valA === undefined) valA = '';
        if (valB === null || valB === undefined) valB = '';
        
        // Comparar
        if (typeof valA === 'number' && typeof valB === 'number') {
          return asc ? valA - valB : valB - valA;
        }
        
        valA = String(valA).toLowerCase();
        valB = String(valB).toLowerCase();
        
        if (asc) {
          return valA.localeCompare(valB);
        } else {
          return valB.localeCompare(valA);
        }
      });
      
      // Reconstruir array mantendo blanks
      const blanks = agenda1Dados.filter(d => d.tipo === 'blank');
      agenda1Dados = [...outros, ...livres, ...blanks];
      
      agenda1RenderTable();
    }

    // ========== GUARDAR ORDEM ==========
    window.agenda1GuardarOrdem = function(id, valor) {
      const r = agenda1Dados.find(d => d.id === id);
      if (r) {
        if (valor === '' || valor === null || isNaN(parseInt(valor))) {
          r.ordemCarga = null;
        } else {
          r.ordemCarga = parseInt(valor);
        }
      }
    };

    // ========== ORDENAR GRUPO ESPECÃFICO ==========
    window.agenda1OrdenarGrupo = function(grupoIndex) {
      if (!agenda1GruposIds[grupoIndex] || agenda1GruposIds[grupoIndex].length < 2) {
        alert('Este grupo precisa de pelo menos 2 reservas para ordenar.');
        return;
      }
      
      const idsDoGrupo = agenda1GruposIds[grupoIndex];
      const reservasDoGrupo = agenda1Dados.filter(d => idsDoGrupo.includes(d.id));
      
      // Verificar se hÃ¡ ordens definidas pelo utilizador
      const comOrdem = reservasDoGrupo.filter(r => r.ordemCarga !== null && r.ordemCarga !== undefined && r.ordemCarga !== '');
      const semOrdem = reservasDoGrupo.filter(r => r.ordemCarga === null || r.ordemCarga === undefined || r.ordemCarga === '');
      
      if (comOrdem.length === 0) {
        alert('âš ï¸ Defina primeiro a ordem (1, 2, 3...) na coluna Ord para cada reserva deste grupo.');
        return;
      }
      
      // Ordenar as que tÃªm ordem definida pelo valor de ordemCarga (1, 2, 3...)
      comOrdem.sort((a, b) => {
        const ordA = parseInt(a.ordemCarga) || 999;
        const ordB = parseInt(b.ordemCarga) || 999;
        return ordA - ordB;
      });
      
      // As sem ordem ficam no final
      const ordenadas = [...comOrdem, ...semOrdem];
      
      // Encontrar posiÃ§Ã£o inicial do grupo
      const primeiraPos = agenda1Dados.findIndex(d => idsDoGrupo.includes(d.id));
      
      // Remover todas do grupo
      agenda1Dados = agenda1Dados.filter(d => !idsDoGrupo.includes(d.id));
      
      // Inserir ordenadas na posiÃ§Ã£o correta
      agenda1Dados.splice(primeiraPos, 0, ...ordenadas);
      
      agenda1RenderTable();
      alert('âœ… Grupo ' + (grupoIndex + 1) + ' ordenado pela coluna Ord!');
    };

    // ========== RENDERIZAÃ‡ÃƒO ==========
    function agenda1RenderTable() {
      const tbody = document.getElementById('agenda1TableBody');
      const search = document.getElementById('agenda1SearchInput').value.toLowerCase();
      const estado = document.getElementById('agenda1FilterEstado').value;
      const prioridade = document.getElementById('agenda1FilterPrioridade').value;

      let html = '';
      agenda1GruposIds = [];
      
      // 1. Grupagens
      agenda1Grupagens.forEach(g => {
        const reservasG = agenda1Dados.filter(d => d.tipo === 'reserva' && d.grupagemId === g.id);
        const dest = g.destino ? `<span style="background:#2563eb;color:white;padding:3px 10px;border-radius:4px;font-size:12px;">ğŸ“ ${g.destino}</span>` : '<span style="color:#ea580c;font-size:12px;font-weight:bold;">âš  Sem destino</span>';
        const st = g.fechada ? 'ğŸ”’' : 'ğŸ”“';
        
        html += `<tr class="agenda1-row-group-header">
          <td colspan="24" style="line-height:1.6;">
            ğŸ“¦ <strong>#${g.numero}</strong> ${st} &nbsp;&nbsp;
            <strong>${g.tipoGrupagem}</strong> &nbsp;|&nbsp;
            <strong>${g.intermodal}</strong> &nbsp;|&nbsp;
            Forn: <strong>${g.fornecedor || 'N/A'}</strong> &nbsp;|&nbsp;
            ğŸ‘¤ <strong>${g.motorista}</strong> &nbsp;
            ğŸš› <strong>${g.matriculaTrator}</strong> &nbsp;
            ğŸš <strong>${g.matriculaReboque}</strong> &nbsp;|&nbsp;
            <span style="font-weight:bold;">BOOKING:</span> <input type="text" value="${g.booking || ''}" onchange="agenda1Grupagens.find(x=>x.id===${g.id}).booking=this.value" style="width:180px;border:1px solid #ccc;border-radius:3px;padding:3px 6px;font-size:12px;">
            &nbsp;|&nbsp; ${dest}
          </td>
        </tr>`;
        reservasG.forEach(r => { html += agenda1RenderReservaRow(r, true); });
        const t = agenda1CalcTotais(reservasG);
        html += agenda1RenderSumRow(t);
      });
      
      // 2. Cargas Diretas
      agenda1CargasDiretas.forEach(cd => {
        const r = agenda1Dados.find(d => d.id === cd.reservaId);
        if (!r) return;
        const dest = cd.destino ? `<span style="background:#2563eb;color:white;padding:3px 10px;border-radius:4px;font-size:12px;">ğŸ“ ${cd.destino}</span>` : '<span style="color:#ea580c;font-size:12px;font-weight:bold;">âš  Sem destino</span>';
        
        html += `<tr class="agenda1-row-group-header">
          <td colspan="24" style="line-height:1.6;">
            ğŸš› <strong>CD#${cd.numero}</strong> &nbsp;&nbsp;
            <strong>CARGA DIRETA</strong> &nbsp;|&nbsp;
            <strong>${cd.intermodal}</strong> &nbsp;|&nbsp;
            Forn: <strong>${cd.fornecedor || 'N/A'}</strong> &nbsp;|&nbsp;
            ğŸ‘¤ <strong>${cd.motorista}</strong> &nbsp;
            ğŸš› <strong>${cd.matriculaTrator}</strong> &nbsp;
            ğŸš <strong>${cd.matriculaReboque}</strong> &nbsp;|&nbsp;
            KM: <strong>${cd.km}</strong> &nbsp;
            â‚¬/KM: <strong>${agenda1FormatCurrency(cd.valorKm)}</strong> &nbsp;|&nbsp;
            <span style="font-weight:bold;">BOOKING:</span> <input type="text" value="${cd.booking || ''}" onchange="agenda1CargasDiretas.find(x=>x.id===${cd.id}).booking=this.value" style="width:180px;border:1px solid #ccc;border-radius:3px;padding:3px 6px;font-size:12px;">
            &nbsp;|&nbsp; ${dest}
          </td>
        </tr>`;
        html += agenda1RenderReservaRow(r, true);
        html += agenda1RenderSumRow({ ldm: r.ldm, peso: r.peso, bultos: r.quantidadeBultos, valor: r.valorServico });
      });
      
      // 3. Dados livres com grupos
      const dadosLivres = agenda1Dados.filter(d => !d.grupagemId);
      let grupoAtual = [];
      let grupoIndex = 0;
      
      dadosLivres.forEach((item) => {
        if (item.tipo === 'blank') {
          if (grupoAtual.length > 0) {
            agenda1GruposIds[grupoIndex] = grupoAtual.map(r => r.id);
            html += agenda1RenderSubtotalRow(agenda1CalcTotais(grupoAtual), grupoIndex);
            grupoAtual = [];
            grupoIndex++;
          }
          html += `<tr class="agenda1-row-blank"><td colspan="24"></td></tr>`;
        } else if (item.tipo === 'reserva') {
          const matchSearch = !search || Object.values(item).some(v => String(v).toLowerCase().includes(search));
          const matchEstado = !estado || item.estadoReserva === estado;
          const matchPrioridade = !prioridade || item.prioridadeCarga === prioridade;
          if (matchSearch && matchEstado && matchPrioridade && item.visivel) {
            grupoAtual.push(item);
            html += agenda1RenderReservaRow(item, false);
          }
        }
      });
      
      // Ãšltimo grupo
      if (grupoAtual.length > 0) {
        agenda1GruposIds[grupoIndex] = grupoAtual.map(r => r.id);
        html += agenda1RenderSubtotalRow(agenda1CalcTotais(grupoAtual), grupoIndex);
      }

      tbody.innerHTML = html;
      
      document.getElementById('agenda1CountDisplay').textContent = `${agenda1Dados.filter(d => d.tipo === 'reserva' && !d.grupagemId && d.visivel).length} reservas`;
      document.getElementById('agenda1CountGrupagens').textContent = agenda1Grupagens.length;
      document.getElementById('agenda1CountDiretas').textContent = agenda1CargasDiretas.length;
      agenda1UpdateSelectedCount();
      agenda1UpdateBotoes();
    }

    function agenda1RenderReservaRow(r, inGroup) {
      const rowClass = r.selected ? 'agenda1-row-selected' : (agenda1IsAtrasado(r) ? 'agenda1-row-alert' : 'agenda1-row-normal');
      const ordemVal = (r.ordemCarga !== null && r.ordemCarga !== undefined) ? r.ordemCarga : '';
      
      return `<tr class="agenda1-compact-row ${rowClass} hover:bg-blue-50" data-id="${r.id}" 
        draggable="${!inGroup}" ondragstart="agenda1OnDragStart(event, ${r.id})" ondragover="agenda1OnDragOver(event)" 
        ondrop="agenda1OnDrop(event, ${r.id})" ondragend="agenda1OnDragEnd(event)">
        <td class="text-center border-r border-slate-200">
          <input type="checkbox" ${r.selected ? 'checked' : ''} onchange="agenda1ToggleSelect(${r.id})" class="agenda1-custom-checkbox" ${inGroup ? 'disabled' : ''}>
        </td>
        <td class="text-center border-r border-slate-200 agenda1-drag-handle">â˜°</td>
        <td class="border-r border-slate-200 font-semibold text-blue-700 agenda1-reserva-link" onclick="agenda1AbrirReserva(${r.id})">${r.numeroReserva}</td>
        <td class="text-center border-r border-slate-200 bg-blue-50">
          <div onclick="agenda1AbrirFormularioReserva(${r.id})" class="cursor-pointer hover:bg-blue-200 p-1 rounded" title="Abrir formulÃ¡rio reserva - Enviar mensagem ao motorista">
            ${r.msgEnviada ? '<span style="color:#16a34a;font-size:14px;font-weight:bold;">âœ“</span>' : '<span style="color:#1e40af;font-size:14px;font-weight:bold;">â—‹</span>'}
          </div>
        </td>
        <td class="border-r border-slate-200">${r.comercial}</td>
        <td class="border-r border-slate-200">${agenda1FormatDate(r.dataCarga)}</td>
        <td class="border-r border-slate-200">${r.cliente}</td>
        <td class="text-center border-r border-slate-200">${r.cmrCarga ? '<span style="color:#16a34a;font-size:14px;font-weight:bold;">âœ“</span>' : '<span style="color:#cbd5e1;font-size:14px;">â—‹</span>'}</td>
        <td class="text-center border-r border-slate-200">${r.cmrDescarga ? '<span style="color:#16a34a;font-size:14px;font-weight:bold;">âœ“</span>' : '<span style="color:#cbd5e1;font-size:14px;">â—‹</span>'}</td>
        <td class="text-right border-r border-slate-200 font-semibold">${r.ldm}</td>
        <td class="text-right border-r border-slate-200 font-semibold">${r.peso}</td>
        <td class="text-right border-r border-slate-200 font-semibold">${r.quantidadeBultos}</td>
        <td class="border-r border-slate-200">${r.cidadeCarga}</td>
        <td class="border-r border-slate-200 font-bold" style="color:#334155;">${r.codigoPostalCarga}</td>
        <td class="border-r border-slate-200 font-bold" style="color:#334155;">${r.codigoPostalDescarga}</td>
        <td class="border-r border-slate-200">${r.cidadeDescarga}</td>
        <td class="text-center border-r border-slate-200">
          <input type="number" 
            class="agenda1-input-ord"
            data-row-id="${r.id}"
            value="${ordemVal}" 
            onchange="agenda1GuardarOrdem(${r.id}, this.value)"
            onkeydown="agenda1NavegacaoTeclado(event, ${r.id})"
            style="width:36px;height:24px;text-align:center;font-size:12px;font-weight:bold;border:2px solid #3b82f6;border-radius:3px;background:white;"
            min="1" max="999">
        </td>
        <td class="text-center border-r border-slate-200"><span style="font-size:11px;padding:2px 6px;border-radius:4px;font-weight:700;" class="${agenda1GetPrioridadeClass(r.prioridadeCarga)}">${r.prioridadeCarga}</span></td>
        <td class="border-r border-slate-200">${agenda1FormatDate(r.dataEntrega)}</td>
        <td class="border-r border-slate-200 bg-amber-50">
          <div onclick="agenda1AbrirSelecionarMotorista(${r.id})" class="cursor-pointer hover:bg-amber-200 px-1 py-0.5 rounded ${r.motoristaRecolha ? 'agenda1-col-recolha' : 'agenda1-col-recolha-vazio'}">
            ${r.motoristaRecolha || '-- clique --'}
          </div>
        </td>
        <td class="border-r border-slate-200 bg-amber-50">
          <div onclick="agenda1AbrirSelecionarTrator(${r.id})" class="cursor-pointer hover:bg-amber-200 px-1 py-0.5 rounded ${r.tratorRecolha ? 'agenda1-col-recolha' : 'agenda1-col-recolha-vazio'}">
            ${r.tratorRecolha || 'clique'}
          </div>
        </td>
        <td class="border-r border-slate-200 bg-amber-50">
          <div onclick="agenda1AbrirSelecionarReboque(${r.id})" class="cursor-pointer hover:bg-amber-200 px-1 py-0.5 rounded ${r.reboqueRecolha ? 'agenda1-col-recolha' : 'agenda1-col-recolha-vazio'}">
            ${r.reboqueRecolha || 'clique'}
          </div>
        </td>
        <td class="text-right border-r border-slate-200 font-bold text-green-700">${agenda1FormatCurrency(r.valorServico)}</td>
        <td class="text-center"><span style="font-size:11px;padding:2px 6px;border-radius:4px;font-weight:700;" class="${agenda1GetEstadoClass(r.estadoReserva)}">${r.estadoReserva}</span></td>
      </tr>`;
    }

    function agenda1RenderSumRow(t) {
      return `<tr class="agenda1-row-sum agenda1-compact-row">
        <td colspan="9" class="text-right pr-2 font-bold">TOTAIS:</td>
        <td class="text-right font-bold">${t.ldm.toFixed(1)}</td>
        <td class="text-right font-bold">${t.peso}</td>
        <td class="text-right font-bold">${t.bultos}</td>
        <td colspan="10"></td>
        <td class="text-right font-bold">${agenda1FormatCurrency(t.valor)}</td>
        <td></td>
      </tr>`;
    }

    function agenda1RenderSubtotalRow(t, grupoIdx) {
      return `<tr class="agenda1-row-sum agenda1-compact-row">
        <td colspan="9" class="text-right pr-2 font-bold text-slate-700">
          <button class="agenda1-btn-ordenar-grupo" onclick="agenda1OrdenarGrupo(${grupoIdx})">ğŸ¤– Ord.Grupo ${grupoIdx + 1}</button>
          SUBTOTAL:
        </td>
        <td class="text-right font-bold">${t.ldm.toFixed(1)}</td>
        <td class="text-right font-bold">${t.peso}</td>
        <td class="text-right font-bold">${t.bultos}</td>
        <td colspan="10"></td>
        <td class="text-right font-bold">${agenda1FormatCurrency(t.valor)}</td>
        <td></td>
      </tr>`;
    }

    function agenda1CalcTotais(lista) {
      return {
        ldm: lista.reduce((s, r) => s + (r.ldm || 0), 0),
        peso: lista.reduce((s, r) => s + (r.peso || 0), 0),
        bultos: lista.reduce((s, r) => s + (r.quantidadeBultos || 0), 0),
        valor: lista.reduce((s, r) => s + (r.valorServico || 0), 0)
      };
    }

    // ========== DRAG AND DROP ==========
    function agenda1OnDragStart(e, id) {
      const r = agenda1Dados.find(d => d.id === id);
      if (!r || r.grupagemId || r.tipo !== 'reserva') { e.preventDefault(); return; }
      agenda1DraggedId = id;
      e.target.classList.add('agenda1-dragging');
      e.dataTransfer.effectAllowed = 'move';
    }

    function agenda1OnDragOver(e) {
      e.preventDefault();
      const row = e.target.closest('tr');
      if (row) {
        document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('agenda1-drag-over'));
        row.classList.add('agenda1-drag-over');
      }
    }

    function agenda1OnDrop(e, targetId) {
      e.preventDefault();
      document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('agenda1-drag-over'));
      if (!agenda1DraggedId || agenda1DraggedId === targetId) return;
      const dragIdx = agenda1Dados.findIndex(d => d.id === agenda1DraggedId);
      const targetIdx = agenda1Dados.findIndex(d => d.id === targetId);
      if (dragIdx === -1 || targetIdx === -1) return;
      const [item] = agenda1Dados.splice(dragIdx, 1);
      agenda1Dados.splice(targetIdx, 0, item);
      agenda1DraggedId = null;
      agenda1RenderTable();
    }

    function agenda1OnDragEnd(e) {
      e.target.classList.remove('agenda1-dragging');
      document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('agenda1-drag-over'));
      agenda1DraggedId = null;
    }

    // ========== SELEÃ‡ÃƒO ==========
    function agenda1ToggleSelect(id) {
      const r = agenda1Dados.find(d => d.id === id);
      if (r && !r.grupagemId && r.tipo === 'reserva') {
        r.selected = !r.selected;
        agenda1RenderTable();
      }
    }

    function agenda1ToggleSelectAll() {
      const checked = document.getElementById('agenda1SelectAllCheckbox').checked;
      agenda1Dados.filter(d => d.tipo === 'reserva' && !d.grupagemId).forEach(d => d.selected = checked);
      agenda1RenderTable();
    }

    function agenda1SelectAll() {
      agenda1Dados.filter(d => d.tipo === 'reserva' && !d.grupagemId).forEach(d => d.selected = true);
      document.getElementById('agenda1SelectAllCheckbox').checked = true;
      agenda1RenderTable();
    }

    function agenda1DeselectAll() {
      agenda1Dados.filter(d => d.tipo === 'reserva').forEach(d => d.selected = false);
      document.getElementById('agenda1SelectAllCheckbox').checked = false;
      agenda1RenderTable();
    }

    function agenda1UpdateSelectedCount() {
      const count = agenda1Dados.filter(d => d.selected).length;
      const el = document.getElementById('agenda1SelectedCount');
      el.textContent = `${count} selecionadas`;
      el.classList.toggle('hidden', count === 0);
    }

    function agenda1UpdateBotoes() {
      const sel = agenda1Dados.filter(d => d.selected && !d.grupagemId && d.tipo === 'reserva');
      const btn = document.getElementById('agenda1BtnCargaDireta');
      btn.disabled = sel.length !== 1;
      btn.classList.toggle('agenda1-btn-disabled', sel.length !== 1);
      
      const tem = agenda1Grupagens.length > 0 || agenda1CargasDiretas.length > 0;
      ['btnDiretoClientes', 'btnDiretoArmazem'].forEach(id => {
        const b = document.getElementById(id);
        if (b) {
          b.disabled = !tem;
          b.classList.toggle('agenda1-btn-disabled', !tem);
        }
      });
    }

    // ========== LINHAS EM BRANCO ==========
    function agenda1InserirLinhaEmBranco() {
      const sel = agenda1Dados.filter(d => d.selected && !d.grupagemId && d.tipo === 'reserva');
      if (sel.length === 0) { alert('Selecione uma reserva.'); return; }
      const ultimaId = sel[sel.length - 1].id;
      const idx = agenda1Dados.findIndex(d => d.id === ultimaId);
      agenda1ContadorBlancos++;
      agenda1Dados.splice(idx + 1, 0, { id: 'blank-' + agenda1ContadorBlancos, tipo: 'blank' });
      agenda1RenderTable();
    }

    function agenda1RemoverLinhasEmBranco() {
      agenda1Dados = agenda1Dados.filter(d => d.tipo !== 'blank');
      agenda1RenderTable();
    }

    // ========== MODAL ==========
    function agenda1ShowModal(title, content, color = 'blue') {
      const colors = { blue: 'bg-blue-600', green: 'bg-green-600', teal: 'bg-teal-600', red: 'bg-red-500', amber: 'bg-amber-600', cyan: 'bg-cyan-600' };
      document.getElementById('agenda1ModalContainer').innerHTML = `
        <div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 modal-overlay">
          <div class="bg-white rounded-lg shadow-2xl w-full max-w-lg modal-content">
            <div class="${colors[color]} text-white px-4 py-2 rounded-t-lg flex items-center justify-between">
              <h2 class="font-bold">${title}</h2>
              <button onclick="agenda1CloseModal()" class="text-white/80 hover:text-white text-xl">&times;</button>
            </div>
            <div class="p-4">${content}</div>
          </div>
        </div>`;
    }

    function agenda1CloseModal() { document.getElementById('agenda1ModalContainer').innerHTML = ''; }

    // ========== GRUPAGEM ==========
    function agenda1AbrirModalGrupagem() {
      const sel = agenda1Dados.filter(d => d.selected && !d.grupagemId && d.tipo === 'reserva');
      if (sel.length < 2) { alert('Selecione pelo menos 2 reservas.'); return; }
      
      // Gerar lista de reservas selecionadas com estado de recolha
      const listaReservas = sel.map(r => {
        const temMot = r.motoristaRecolha && String(r.motoristaRecolha).trim() !== '';
        const temTrat = r.tratorRecolha && String(r.tratorRecolha).trim() !== '';
        const temReb = r.reboqueRecolha && String(r.reboqueRecolha).trim() !== '';
        const completo = temMot && temTrat && temReb;
        const iconEstado = completo ? 'âœ…' : 'âš ï¸';
        const bgClass = completo ? 'bg-green-50' : 'bg-red-50';
        return '<div class="flex items-center justify-between p-1.5 ' + bgClass + ' rounded text-xs border-b">' +
          '<span class="font-semibold">' + iconEstado + ' ' + r.numeroReserva + '</span>' +
          '<span class="text-slate-500">' + 
          (temMot ? 'ğŸ‘¤âœ“' : 'ğŸ‘¤âŒ') + ' ' + 
          (temTrat ? 'ğŸš›âœ“' : 'ğŸš›âŒ') + ' ' + 
          (temReb ? 'ğŸšâœ“' : 'ğŸšâŒ') + 
          '</span></div>';
      }).join('');
      
      agenda1ShowModal('ğŸ“¦ Criar Grupagem NÂº ' + (agenda1ContadorGrupagens + 1), `
        <div class="grid grid-cols-2 gap-3 mb-3">
          <div><label class="block text-xs font-semibold mb-1">Tipo *</label>
            <select id="mTipo" class="w-full text-sm border rounded px-2 py-1">
              <option value="">-- Selecione --</option>
              <option value="Portugal Â» Barcelona">Portugal Â» Barcelona</option>
              <option value="Portugal Â» Madrid">Portugal Â» Madrid</option>
              <option value="Portugal Â» Alemanha">Portugal Â» Alemanha</option>
            </select></div>
          <div><label class="block text-xs font-semibold mb-1">Intermodal *</label>
            <select id="mIntermodal" onchange="agenda1CheckFornecedorRequired()" class="w-full text-sm border rounded px-2 py-1">
              <option value="">-- Selecione --</option>
              <option value="Rodovia PrÃ³pria">Rodovia PrÃ³pria</option>
              <option value="Rodovia Contratada">Rodovia Contratada</option>
              <option value="Navio">Navio</option>
              <option value="Comboio">Comboio</option>
            </select></div>
        </div>
        <div class="grid grid-cols-2 gap-3 mb-3">
          <div><label class="block text-xs font-semibold mb-1">Fornecedor <span id="fornAsterisco">*</span></label>
            <select id="mFornecedor" class="w-full text-sm border rounded px-2 py-1">
              <option value="">-- Selecione --</option>
              <option value="Transportes Silva Lda">Transportes Silva Lda</option>
              <option value="Trans Europa">Trans Europa</option>
            </select></div>
          <div><label class="block text-xs font-semibold mb-1">ğŸ‘¤ Motorista *</label>
            <select id="mMotorista" class="w-full text-sm border rounded px-2 py-1">
              <option value="">-- Selecione --</option>
              <option value="Manuel Costa">Manuel Costa</option>
              <option value="Carlos Ferreira">Carlos Ferreira</option>
              <option value="Rui Martins">Rui Martins</option>
            </select></div>
        </div>
        <div class="grid grid-cols-2 gap-3 mb-3">
          <div><label class="block text-xs font-semibold mb-1">ğŸš› Trator *</label>
            <select id="mTrator" class="w-full text-sm border rounded px-2 py-1">
              <option value="">-- Selecione --</option>
              <option value="AA-00-BB">AA-00-BB</option>
              <option value="EE-22-FF">EE-22-FF</option>
            </select></div>
          <div><label class="block text-xs font-semibold mb-1">ğŸš Reboque *</label>
            <select id="mReboque" class="w-full text-sm border rounded px-2 py-1">
              <option value="">-- Selecione --</option>
              <option value="CC-11-DD">CC-11-DD</option>
              <option value="GG-33-HH">GG-33-HH</option>
            </select></div>
        </div>
        <div class="mb-3"><label class="block text-xs font-semibold mb-1">ğŸ“‹ Booking</label>
          <input type="text" id="mBooking" class="w-full text-sm border rounded px-2 py-1"></div>
        <div class="bg-slate-100 rounded p-2 mb-3">
          <div class="text-xs font-semibold mb-2">ğŸ“‹ Reservas Selecionadas (${sel.length}):</div>
          <div class="max-h-24 overflow-y-auto">${listaReservas}</div>
          <div class="text-xs text-slate-500 mt-2">âœ… = campos recolha OK | âš ï¸ = faltam campos</div>
        </div>
        <div class="flex justify-end gap-2">
          <button onclick="agenda1CloseModal()" class="px-3 py-1.5 text-sm bg-slate-200 rounded">Cancelar</button>
          <button onclick="agenda1ConfirmarGrupagem()" class="px-3 py-1.5 text-sm bg-green-600 text-white rounded font-semibold">Criar</button>
        </div>`, 'green');
    }

    function agenda1CheckFornecedorRequired() {
      const a = document.getElementById('fornAsterisco');
      if (a) a.textContent = document.getElementById('mIntermodal').value === 'Rodovia PrÃ³pria' ? '' : '*';
    }

    function agenda1ConfirmarGrupagem() {
      const tipo = document.getElementById('mTipo').value;
      const inter = document.getElementById('mIntermodal').value;
      const forn = document.getElementById('mFornecedor').value;
      const mot = document.getElementById('mMotorista').value;
      const trat = document.getElementById('mTrator').value;
      const reb = document.getElementById('mReboque').value;
      const book = document.getElementById('mBooking').value;
      if (!tipo || !inter || !mot || !trat || !reb) { alert('âš ï¸ Preencha campos obrigatÃ³rios:\n- Tipo Grupagem\n- Intermodal\n- Motorista\n- Trator\n- Reboque'); return; }
      if (inter !== 'Rodovia PrÃ³pria' && !forn) { alert('Selecione Fornecedor.'); return; }
      
      // Obter as reservas selecionadas NO MOMENTO (atualizadas)
      const sel = agenda1Dados.filter(d => d.selected === true && !d.grupagemId && d.tipo === 'reserva');
      
      // Verificar se todas as reservas selecionadas tÃªm campos de recolha preenchidos
      const semRecolha = sel.filter(r => {
        const temMot = r.motoristaRecolha && String(r.motoristaRecolha).trim() !== '';
        const temTrat = r.tratorRecolha && String(r.tratorRecolha).trim() !== '';
        const temReb = r.reboqueRecolha && String(r.reboqueRecolha).trim() !== '';
        return !temMot || !temTrat || !temReb;
      });
      
      if (semRecolha.length > 0) {
        const listaRes = semRecolha.map(r => {
          return r.numeroReserva + '\n   â†’ Mot: ' + (r.motoristaRecolha || 'âŒ vazio') + 
                 ' | Trat: ' + (r.tratorRecolha || 'âŒ vazio') + 
                 ' | Reb: ' + (r.reboqueRecolha || 'âŒ vazio');
        }).join('\n\n');
        alert('âš ï¸ As seguintes reservas nÃ£o tÃªm todos os campos de recolha preenchidos:\n\n' + listaRes + '\n\nğŸ“Œ Preencha Motorista, Trator e Reboque de Recolha clicando nas cÃ©lulas da tabela antes de criar a grupagem.');
        return;
      }
      
      // Verificar cÃ³digos postais vÃ¡lidos
      const semCP = sel.filter(r => !agenda1ValidarCodigoPostal(r.codigoPostalCarga) || !agenda1ValidarCodigoPostal(r.codigoPostalDescarga));
      if (semCP.length > 0) {
        const listaRes = semCP.map(r => r.numeroReserva).join(', ');
        alert('âš ï¸ As seguintes reservas nÃ£o tÃªm cÃ³digos postais vÃ¡lidos:\n\n' + listaRes + '\n\nOs cÃ³digos postais devem ter prefixo do paÃ­s (PT, DE, NL, FR, ES, etc.)');
        return;
      }
      
      agenda1ContadorGrupagens++;
      const gId = Date.now();
      agenda1Grupagens.push({ id: gId, numero: agenda1ContadorGrupagens, tipoGrupagem: tipo, fornecedor: inter === 'Rodovia PrÃ³pria' ? 'N/A' : forn, matriculaTrator: trat, matriculaReboque: reb, motorista: mot, intermodal: inter, booking: book, fechada: false, destino: null });
      sel.forEach(r => { r.grupagemId = gId; r.selected = false; });
      agenda1CloseModal(); agenda1RenderTable();
      alert(`âœ“ Grupagem #${agenda1ContadorGrupagens} criada.`);
    }
    
    // Validar cÃ³digo postal com prefixo de paÃ­s
    function agenda1ValidarCodigoPostal(cp) {
      if (!cp) return false;
      const prefixos = ['PT', 'ES', 'FR', 'DE', 'NL', 'BE', 'IT', 'UK', 'CH', 'AT', 'PL', 'CZ', 'DK', 'SE', 'NO', 'FI', 'IE', 'LU', 'GR', 'HU', 'RO', 'BG', 'HR', 'SK', 'SI', 'LT', 'LV', 'EE'];
      const partes = cp.split('-');
      if (partes.length < 2) return false;
      return prefixos.includes(partes[0].toUpperCase());
    }

    function agenda1AbrirGrupagemModal() {
      if (agenda1Grupagens.length === 0) { alert('NÃ£o hÃ¡ agenda1Grupagens.'); return; }
      const opts = agenda1Grupagens.map(g => `<option value="${g.id}">#${g.numero} - ${g.tipoGrupagem}</option>`).join('');
      agenda1ShowModal('ğŸ”“ Abrir Grupagem', `
        <div class="mb-4"><label class="block text-xs font-semibold mb-1">Selecione *</label>
          <select id="mGrupagem" class="w-full text-sm border rounded px-2 py-1"><option value="">--</option>${opts}</select></div>
        <div class="flex justify-end gap-2">
          <button onclick="agenda1CloseModal()" class="px-3 py-1.5 text-sm bg-slate-200 rounded">Cancelar</button>
          <button onclick="agenda1ConfirmarAbrirGrupagem()" class="px-3 py-1.5 text-sm bg-blue-500 text-white rounded">Abrir</button>
        </div>`);
    }

    function agenda1ConfirmarAbrirGrupagem() {
      const gId = parseInt(document.getElementById('mGrupagem').value);
      if (!gId) { alert('Selecione.'); return; }
      agenda1Dados.filter(d => d.grupagemId === gId).forEach(d => d.grupagemId = null);
      agenda1Grupagens = agenda1Grupagens.filter(x => x.id !== gId);
      agenda1Grupagens.forEach((x, i) => x.numero = i + 1);
      agenda1ContadorGrupagens = agenda1Grupagens.length;
      agenda1CloseModal(); agenda1RenderTable();
      alert(`âœ“ Grupagem aberta.`);
    }

    function agenda1FecharGrupagem() {
      const g = agenda1Grupagens.find(x => !x.fechada);
      if (!g) { alert('NÃ£o hÃ¡ agenda1Grupagens abertas.'); return; }
      g.fechada = true; agenda1RenderTable();
      alert(`âœ“ Grupagem #${g.numero} fechada.`);
    }

    // ========== CARGA DIRETA ==========
    function agenda1AbrirModalCargaDireta() {
      const sel = agenda1Dados.filter(d => d.selected && !d.grupagemId && d.tipo === 'reserva');
      if (sel.length !== 1) { alert('Selecione 1 reserva.'); return; }
      const r = sel[0];
      const km = agenda1CalcularKM(r.codigoPostalCarga, r.codigoPostalDescarga);
      const valorPorKm = r.valorServico / km;
      agenda1ShowModal('ğŸš› Carga Direta NÂº ' + (agenda1ContadorCargasDiretas + 1), `
        <div class="bg-teal-50 border rounded p-2 mb-3 text-sm">
          <strong>${r.numeroReserva}</strong> - KM: ${km} | Valor: ${agenda1FormatCurrency(r.valorServico)} | <strong>â‚¬/KM: ${valorPorKm.toFixed(2)} â‚¬</strong>
        </div>
        <div class="grid grid-cols-2 gap-3 mb-3">
          <div><label class="block text-xs font-semibold mb-1">Intermodal *</label>
            <select id="mIntermodal" onchange="agenda1CheckFornecedorRequiredCD()" class="w-full text-sm border rounded px-2 py-1">
              <option value="">--</option>
              <option value="Rodovia PrÃ³pria">Rodovia PrÃ³pria</option>
              <option value="Rodovia Contratada">Rodovia Contratada</option>
            </select></div>
          <div><label class="block text-xs font-semibold mb-1">Fornecedor <span id="fornAsteriscoCD">*</span></label>
            <select id="mFornecedor" class="w-full text-sm border rounded px-2 py-1">
              <option value="">--</option>
              <option value="Transportes Silva Lda">Transportes Silva Lda</option>
            </select></div>
        </div>
        <div class="grid grid-cols-2 gap-3 mb-3">
          <div><label class="block text-xs font-semibold mb-1">ğŸ‘¤ Motorista *</label>
            <select id="mMotorista" class="w-full text-sm border rounded px-2 py-1">
              <option value="">--</option><option value="Manuel Costa">Manuel Costa</option>
            </select></div>
          <div><label class="block text-xs font-semibold mb-1">ğŸš› Trator *</label>
            <select id="mTrator" class="w-full text-sm border rounded px-2 py-1">
              <option value="">--</option><option value="AA-00-BB">AA-00-BB</option>
            </select></div>
        </div>
        <div class="grid grid-cols-2 gap-3 mb-3">
          <div><label class="block text-xs font-semibold mb-1">ğŸš Reboque *</label>
            <select id="mReboque" class="w-full text-sm border rounded px-2 py-1">
              <option value="">--</option><option value="CC-11-DD">CC-11-DD</option>
            </select></div>
          <div><label class="block text-xs font-semibold mb-1">ğŸ“‹ Booking</label>
            <input type="text" id="mBooking" class="w-full text-sm border rounded px-2 py-1"></div>
        </div>
        <div class="bg-amber-50 border border-amber-200 rounded p-2 mb-3">
          <div class="grid grid-cols-2 gap-3 text-sm">
            <div><span class="text-slate-600">KM:</span> <strong>${km}</strong></div>
            <div><span class="text-slate-600">â‚¬/KM:</span> <strong class="text-green-700">${valorPorKm.toFixed(2)} â‚¬</strong></div>
          </div>
        </div>
        <input type="hidden" id="mReservaId" value="${r.id}">
        <input type="hidden" id="mKM" value="${km}">
        <input type="hidden" id="mValorKM" value="${valorPorKm}">
        <div class="flex justify-end gap-2">
          <button onclick="agenda1CloseModal()" class="px-3 py-1.5 text-sm bg-slate-200 rounded">Cancelar</button>
          <button onclick="agenda1ConfirmarCargaDireta()" class="px-3 py-1.5 text-sm bg-teal-600 text-white rounded">Criar</button>
        </div>`, 'teal');
    }

    function agenda1CheckFornecedorRequiredCD() {
      const a = document.getElementById('fornAsteriscoCD');
      if (a) a.textContent = document.getElementById('mIntermodal').value === 'Rodovia PrÃ³pria' ? '' : '*';
    }

    function agenda1ConfirmarCargaDireta() {
      const inter = document.getElementById('mIntermodal').value;
      const forn = document.getElementById('mFornecedor').value;
      const mot = document.getElementById('mMotorista').value;
      const trat = document.getElementById('mTrator').value;
      const reb = document.getElementById('mReboque').value;
      const book = document.getElementById('mBooking').value;
      const resId = parseInt(document.getElementById('mReservaId').value);
      const km = parseInt(document.getElementById('mKM').value);
      const valorKm = parseFloat(document.getElementById('mValorKM').value);
      if (!inter || !mot || !trat || !reb) { alert('âš ï¸ Preencha campos obrigatÃ³rios:\n- Intermodal\n- Motorista\n- Trator\n- Reboque'); return; }
      if (inter !== 'Rodovia PrÃ³pria' && !forn) { alert('Selecione Fornecedor.'); return; }
      
      // Verificar se a reserva tem campos de recolha preenchidos
      const r = agenda1Dados.find(d => d.id === resId);
      const temMot = r.motoristaRecolha && String(r.motoristaRecolha).trim() !== '';
      const temTrat = r.tratorRecolha && String(r.tratorRecolha).trim() !== '';
      const temReb = r.reboqueRecolha && String(r.reboqueRecolha).trim() !== '';
      
      if (!temMot || !temTrat || !temReb) {
        alert('âš ï¸ A reserva ' + r.numeroReserva + ' nÃ£o tem todos os campos de recolha preenchidos:\n\n' +
              '   â†’ Mot: ' + (r.motoristaRecolha || 'âŒ vazio') + '\n' +
              '   â†’ Trat: ' + (r.tratorRecolha || 'âŒ vazio') + '\n' +
              '   â†’ Reb: ' + (r.reboqueRecolha || 'âŒ vazio') + '\n\n' +
              'ğŸ“Œ Preencha clicando nas cÃ©lulas da tabela antes de criar a carga direta.');
        return;
      }
      
      // Verificar cÃ³digos postais vÃ¡lidos
      if (!agenda1ValidarCodigoPostal(r.codigoPostalCarga) || !agenda1ValidarCodigoPostal(r.codigoPostalDescarga)) {
        alert('âš ï¸ A reserva ' + r.numeroReserva + ' nÃ£o tem cÃ³digos postais vÃ¡lidos.\n\nOs cÃ³digos postais devem ter prefixo do paÃ­s (PT, DE, NL, FR, ES, etc.)');
        return;
      }
      
      agenda1ContadorCargasDiretas++;
      const cdId = Date.now();
      agenda1CargasDiretas.push({ id: cdId, numero: agenda1ContadorCargasDiretas, reservaId: resId, intermodal: inter, fornecedor: inter === 'Rodovia PrÃ³pria' ? 'N/A' : forn, motorista: mot, matriculaTrator: trat, matriculaReboque: reb, km, valorKm, booking: book, destino: null });
      if (r) { r.grupagemId = 'cd-' + cdId; r.selected = false; }
      agenda1CloseModal(); agenda1RenderTable();
      alert(`âœ“ CD #${agenda1ContadorCargasDiretas} criada.`);
    }

    function agenda1AbrirAnularCDModal() {
      if (agenda1CargasDiretas.length === 0) { alert('NÃ£o hÃ¡ CDs.'); return; }
      const opts = agenda1CargasDiretas.map(cd => `<option value="${cd.id}">CD #${cd.numero}</option>`).join('');
      agenda1ShowModal('ğŸ—‘ Anular CD', `
        <div class="mb-4"><select id="mCD" class="w-full text-sm border rounded px-2 py-1"><option value="">--</option>${opts}</select></div>
        <div class="flex justify-end gap-2">
          <button onclick="agenda1CloseModal()" class="px-3 py-1.5 text-sm bg-slate-200 rounded">Cancelar</button>
          <button onclick="agenda1ConfirmarAnularCD()" class="px-3 py-1.5 text-sm bg-red-500 text-white rounded">Anular</button>
        </div>`, 'red');
    }

    function agenda1ConfirmarAnularCD() {
      const cdId = parseInt(document.getElementById('mCD').value);
      if (!cdId) return;
      const cd = agenda1CargasDiretas.find(x => x.id === cdId);
      const r = agenda1Dados.find(d => d.id === cd.reservaId);
      if (r) r.grupagemId = null;
      agenda1CargasDiretas = agenda1CargasDiretas.filter(x => x.id !== cdId);
      agenda1CargasDiretas.forEach((x, i) => x.numero = i + 1);
      agenda1ContadorCargasDiretas = agenda1CargasDiretas.length;
      agenda1CloseModal(); agenda1RenderTable();
    }

    // ========== DESTINOS ==========
    function agenda1AbrirDestinoModal(tipo) {
      if (agenda1Grupagens.length === 0 && agenda1CargasDiretas.length === 0) { alert('NÃ£o hÃ¡ agenda1Grupagens/CDs.'); return; }
      const opts = agenda1Grupagens.map(g => `<option value="g-${g.id}">Grup #${g.numero}</option>`).join('') +
                   agenda1CargasDiretas.map(cd => `<option value="cd-${cd.id}">CD #${cd.numero}</option>`).join('');
      const armHtml = tipo === 'armazem' ? `<div class="mb-4"><label class="block text-xs font-semibold mb-1">ArmazÃ©m *</label>
        <select id="mArmazem" class="w-full text-sm border rounded px-2 py-1"><option value="">--</option>
        <option value="ArmazÃ©m Lisboa">ArmazÃ©m Lisboa</option><option value="ArmazÃ©m Porto">ArmazÃ©m Porto</option><option value="ArmazÃ©m Holanda">ArmazÃ©m Holanda</option></select></div>` : '';
      agenda1ShowModal(tipo === 'clientes' ? 'ğŸšš Direto Clientes' : 'ğŸ­ Direto ArmazÃ©m', `
        <div class="mb-4"><select id="mItem" class="w-full text-sm border rounded px-2 py-1"><option value="">--</option>${opts}</select></div>
        ${armHtml}
        <input type="hidden" id="mDestinoTipo" value="${tipo}">
        <div class="flex justify-end gap-2">
          <button onclick="agenda1CloseModal()" class="px-3 py-1.5 text-sm bg-slate-200 rounded">Cancelar</button>
          <button onclick="agenda1ConfirmarDestino()" class="px-3 py-1.5 text-sm bg-cyan-600 text-white rounded">OK</button>
        </div>`, tipo === 'clientes' ? 'cyan' : 'amber');
    }

    function agenda1ConfirmarDestino() {
      const item = document.getElementById('mItem').value;
      const tipo = document.getElementById('mDestinoTipo').value;
      if (!item) return;
      let destino = tipo === 'clientes' ? 'Direto Clientes' : document.getElementById('mArmazem')?.value;
      if (tipo !== 'clientes' && !destino) { alert('Selecione armazÃ©m.'); return; }
      const [t, id] = item.split('-');
      if (t === 'g') { const g = agenda1Grupagens.find(x => x.id === parseInt(id)); if (g) g.destino = destino; }
      else { const cd = agenda1CargasDiretas.find(x => x.id === parseInt(id)); if (cd) cd.destino = destino; }
      agenda1CloseModal(); agenda1RenderTable();
    }

    // ========== AGENDA 2 ==========
    function agenda1AbrirAgenda2Modal() {
      const gProntas = agenda1Grupagens.filter(g => g.fechada && g.destino);
      const cdProntas = agenda1CargasDiretas.filter(cd => cd.destino);
      if (gProntas.length === 0 && cdProntas.length === 0) { alert('Nada pronto.'); return; }
      const opts = gProntas.map(g => `<option value="g-${g.id}">Grup #${g.numero} â†’ ${g.destino}</option>`).join('') +
                   cdProntas.map(cd => `<option value="cd-${cd.id}">CD #${cd.numero} â†’ ${cd.destino}</option>`).join('');
      agenda1ShowModal('â¡ Passar Agenda 2', `
        <div class="mb-4"><select id="mItem" class="w-full text-sm border rounded px-2 py-1"><option value="">--</option>${opts}</select></div>
        <div class="flex justify-end gap-2">
          <button onclick="agenda1CloseModal()" class="px-3 py-1.5 text-sm bg-slate-200 rounded">Cancelar</button>
          <button onclick="agenda1ConfirmarAgenda2()" class="px-3 py-1.5 text-sm bg-blue-700 text-white rounded">Passar</button>
        </div>`);
    }

    function agenda1ConfirmarAgenda2() {
      const item = document.getElementById('mItem').value;
      if (!item) return;
      const [t, id] = item.split('-');
      if (t === 'g') {
        const g = agenda1Grupagens.find(x => x.id === parseInt(id));
        if (g) {
          agenda1Dados = agenda1Dados.filter(d => d.grupagemId !== g.id);
          agenda1Grupagens = agenda1Grupagens.filter(x => x.id !== g.id);
          agenda1Grupagens.forEach((x, i) => x.numero = i + 1);
          agenda1ContadorGrupagens = agenda1Grupagens.length;
        }
      } else {
        const cd = agenda1CargasDiretas.find(x => x.id === parseInt(id));
        if (cd) {
          agenda1Dados = agenda1Dados.filter(d => d.id !== cd.reservaId);
          agenda1CargasDiretas = agenda1CargasDiretas.filter(x => x.id !== cd.id);
          agenda1CargasDiretas.forEach((x, i) => x.numero = i + 1);
          agenda1ContadorCargasDiretas = agenda1CargasDiretas.length;
        }
      }
      agenda1CloseModal(); agenda1RenderTable();
      alert('âœ“ Passado para Agenda 2!');
    }

    function agenda1EnviarOrdenacao() {
      // Verificar se hÃ¡ agenda1Grupagens com reservas ordenadas
      const grupagensComOrdem = agenda1Grupagens.filter(g => {
        const reservasG = agenda1Dados.filter(d => d.tipo === 'reserva' && d.grupagemId === g.id);
        return reservasG.some(r => r.ordemCarga !== null && r.ordemCarga !== undefined && r.ordemCarga !== '');
      });
      
      // Verificar se hÃ¡ cargas diretas (todas podem ser enviadas)
      const cargasDiretasDisponiveis = agenda1CargasDiretas.filter(cd => {
        const r = agenda1Dados.find(d => d.id === cd.reservaId);
        return r !== undefined;
      });
      
      if (grupagensComOrdem.length === 0 && cargasDiretasDisponiveis.length === 0) {
        alert('Nenhuma grupagem com ordenaÃ§Ã£o definida e nenhuma carga direta disponÃ­vel.\n\nDefina a ordem (1, 2, 3...) na coluna Ord das reservas dentro de uma grupagem, ou crie uma carga direta.');
        return;
      }
      
      // Criar lista de agenda1Grupagens para selecionar (mostrar estado do destino)
      let listaItens = '';
      
      // GRUPAGENS
      if (grupagensComOrdem.length > 0) {
        listaItens += '<div class="bg-green-50 px-3 py-1 font-bold text-green-800 text-sm border-b">ğŸ“¦ GRUPAGENS</div>';
        listaItens += grupagensComOrdem.map(g => {
          const reservasG = agenda1Dados.filter(d => d.tipo === 'reserva' && d.grupagemId === g.id && d.ordemCarga);
          const temDestino = g.destino ? true : false;
          const destinoHtml = temDestino 
            ? '<span class="text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded font-semibold">ğŸ“ ' + g.destino + '</span>'
            : '<span class="text-xs bg-red-100 text-red-600 px-2 py-0.5 rounded font-semibold">ğŸš« SEM DESTINO</span>';
          
          const disabledAttr = temDestino ? '' : 'disabled';
          const bgClass = temDestino ? 'hover:bg-green-50 cursor-pointer' : 'bg-red-50/50 opacity-60 cursor-not-allowed';
          
          return '<label class="flex items-center gap-2 p-3 ' + bgClass + ' rounded border-b">' +
            '<input type="radio" name="itemEnviar" class="item-enviar-radio" value="g-' + g.id + '" data-tipo="grupagem" ' + disabledAttr + '>' +
            '<div class="flex-1">' +
            '<div class="flex items-center gap-2 mb-1">' +
            '<span class="font-bold ' + (temDestino ? 'text-green-700' : 'text-red-400') + '">#' + g.numero + ' - ' + g.tipoGrupagem + '</span>' +
            '<span class="text-sm text-slate-500">(' + reservasG.length + ' reservas)</span>' +
            destinoHtml +
            '</div>' +
            '<div class="text-xs text-slate-500">ğŸ‘¤ ' + g.motorista + ' | ğŸš› ' + g.matriculaTrator + ' | ğŸš ' + g.matriculaReboque + '</div>' +
            '</div></label>';
        }).join('');
      }
      
      // CARGAS DIRETAS
      if (cargasDiretasDisponiveis.length > 0) {
        listaItens += '<div class="bg-teal-50 px-3 py-1 font-bold text-teal-800 text-sm border-b mt-2">ğŸš› CARGAS DIRETAS</div>';
        listaItens += cargasDiretasDisponiveis.map(cd => {
          const r = agenda1Dados.find(d => d.id === cd.reservaId);
          const temDestino = cd.destino ? true : false;
          const destinoHtml = temDestino 
            ? '<span class="text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded font-semibold">ğŸ“ ' + cd.destino + '</span>'
            : '<span class="text-xs bg-red-100 text-red-600 px-2 py-0.5 rounded font-semibold">ğŸš« SEM DESTINO</span>';
          
          const disabledAttr = temDestino ? '' : 'disabled';
          const bgClass = temDestino ? 'hover:bg-teal-50 cursor-pointer' : 'bg-red-50/50 opacity-60 cursor-not-allowed';
          
          return '<label class="flex items-center gap-2 p-3 ' + bgClass + ' rounded border-b">' +
            '<input type="radio" name="itemEnviar" class="item-enviar-radio" value="cd-' + cd.id + '" data-tipo="cargadireta" ' + disabledAttr + '>' +
            '<div class="flex-1">' +
            '<div class="flex items-center gap-2 mb-1">' +
            '<span class="font-bold ' + (temDestino ? 'text-teal-700' : 'text-red-400') + '">CD#' + cd.numero + ' - ' + (r ? r.numeroReserva : 'N/A') + '</span>' +
            '<span class="text-sm text-slate-500">(1 reserva)</span>' +
            destinoHtml +
            '</div>' +
            '<div class="text-xs text-slate-500">ğŸ‘¤ ' + cd.motorista + ' | ğŸš› ' + cd.matriculaTrator + ' | ğŸš ' + cd.matriculaReboque + ' | KM: ' + cd.km + '</div>' +
            '</div></label>';
        }).join('');
      }
      
      // Verificar se hÃ¡ pelo menos um item com destino
      const grupagensComDestino = grupagensComOrdem.filter(g => g.destino);
      const cargasDiretasComDestino = cargasDiretasDisponiveis.filter(cd => cd.destino);
      const temAlgumComDestino = grupagensComDestino.length > 0 || cargasDiretasComDestino.length > 0;
      
      const avisoSemDestino = !temAlgumComDestino 
        ? '<div class="bg-red-100 border border-red-300 text-red-700 p-3 rounded mb-3 text-sm font-semibold">ğŸš« Nenhum item tem DESTINO definido. Use os botÃµes "DIRETO CLIENTES" ou "DIRETO ARMAZÃ‰M" antes de enviar.</div>'
        : '';
      
      agenda1ShowModal('ğŸ“‹ Enviar Ord. ArmazÃ©m', 
        '<div class="mb-3">' +
        avisoSemDestino +
        '<p class="text-sm text-slate-600 mb-2">Selecione a grupagem ou carga direta a enviar para o ArmazÃ©m:</p>' +
        '<p class="text-xs text-amber-600 mb-2">âš ï¸ <strong>Nota:</strong> SÃ³ Ã© possÃ­vel enviar itens com DESTINO definido (use os botÃµes "DIRETO CLIENTES" ou "DIRETO ARMAZÃ‰M")</p>' +
        '<div class="border rounded max-h-64 overflow-y-auto">' + listaItens + '</div>' +
        '</div>' +
        '<div class="flex justify-end gap-2 mt-4 pt-3 border-t">' +
        '<button onclick="agenda1CloseModal()" class="px-4 py-2 text-sm bg-slate-200 hover:bg-slate-300 rounded">Cancelar</button>' +
        '<button onclick="agenda1ConfirmarEnvioArmazem()" class="px-4 py-2 text-sm bg-indigo-600 hover:bg-indigo-700 text-white rounded font-semibold">ğŸ“¤ Continuar</button>' +
        '</div>', 'blue');
    }

    function agenda1ConfirmarEnvioArmazem() {
      // Verificar item selecionado (grupagem ou carga direta)
      const radioSelecionado = document.querySelector('.item-enviar-radio:checked');
      if (!radioSelecionado) {
        alert('âš ï¸ Selecione uma grupagem ou carga direta para enviar.');
        return;
      }
      
      const valor = radioSelecionado.value;
      const [tipo, idStr] = valor.split('-');
      const itemId = parseInt(idStr);
      
      // GRUPAGEM
      if (tipo === 'g') {
        const grupagem = agenda1Grupagens.find(g => g.id === itemId);
        
        if (!grupagem) {
          alert('Erro: Grupagem nÃ£o encontrada.');
          return;
        }
        
        // Verificar se cabeÃ§alho estÃ¡ completo
        if (!grupagem.motorista || !grupagem.matriculaTrator || !grupagem.matriculaReboque) {
          alert('âš ï¸ A grupagem nÃ£o tem todos os campos preenchidos:\n- Motorista\n- Trator\n- Reboque\n\nEdite a grupagem antes de enviar.');
          return;
        }
        
        // Verificar se o DESTINO estÃ¡ definido
        if (!grupagem.destino) {
          alert('âš ï¸ A grupagem nÃ£o tem o DESTINO FINAL definido!\n\nUtilize os botÃµes:\nâ€¢ "DIRETO CLIENTES" ou\nâ€¢ "DIRETO ARMAZÃ‰M"\n\npara definir o destino antes de enviar para o ArmazÃ©m.');
          return;
        }
        
        // Recolher reservas da grupagem com ordem
        const reservasEnviar = agenda1Dados.filter(d => d.tipo === 'reserva' && d.grupagemId === itemId && d.ordemCarga)
          .sort((a, b) => {
            const ordA = parseInt(a.ordemCarga) || 999;
            const ordB = parseInt(b.ordemCarga) || 999;
            return ordA - ordB;
          });
        
        if (reservasEnviar.length === 0) {
          alert('âš ï¸ Esta grupagem nÃ£o tem reservas com ordem definida.');
          return;
        }
        
        agenda1CloseModal();
        agenda1GerarDocumentoArmazemGrupagem(grupagem, reservasEnviar);
        
      // CARGA DIRETA
      } else if (tipo === 'cd') {
        const cargaDireta = agenda1CargasDiretas.find(cd => cd.id === itemId);
        
        if (!cargaDireta) {
          alert('Erro: Carga Direta nÃ£o encontrada.');
          return;
        }
        
        // Verificar se cabeÃ§alho estÃ¡ completo
        if (!cargaDireta.motorista || !cargaDireta.matriculaTrator || !cargaDireta.matriculaReboque) {
          alert('âš ï¸ A carga direta nÃ£o tem todos os campos preenchidos:\n- Motorista\n- Trator\n- Reboque\n\nEdite a carga direta antes de enviar.');
          return;
        }
        
        // Verificar se o DESTINO estÃ¡ definido
        if (!cargaDireta.destino) {
          alert('âš ï¸ A carga direta nÃ£o tem o DESTINO FINAL definido!\n\nUtilize os botÃµes:\nâ€¢ "DIRETO CLIENTES" ou\nâ€¢ "DIRETO ARMAZÃ‰M"\n\npara definir o destino antes de enviar para o ArmazÃ©m.');
          return;
        }
        
        const reserva = agenda1Dados.find(d => d.id === cargaDireta.reservaId);
        if (!reserva) {
          alert('Erro: Reserva da carga direta nÃ£o encontrada.');
          return;
        }
        
        agenda1CloseModal();
        agenda1GerarDocumentoArmazemCargaDireta(cargaDireta, reserva);
      }
    }
    
    function agenda1GerarDocumentoArmazemGrupagem(grupagem, reservasEnviar) {
      const dataHoje = new Date().toLocaleDateString('pt-PT', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
      
      let linhasTabela = '';
      for (let i = 0; i < reservasEnviar.length; i++) {
        const r = reservasEnviar[i];
        linhasTabela += '<tr>' +
          '<td style="border:1px solid #333;padding:10px;font-size:16px;font-weight:bold;text-align:center;">' + (r.ordemCarga || '-') + '</td>' +
          '<td style="border:1px solid #333;padding:10px;font-size:16px;font-weight:bold;">' + r.numeroReserva + '</td>' +
          '<td style="border:1px solid #333;padding:10px;font-size:15px;">' + r.cliente + '</td>' +
          '<td style="border:1px solid #333;padding:10px;font-size:15px;">' + r.cidadeCarga + '</td>' +
          '<td style="border:1px solid #333;padding:10px;font-size:15px;">' + r.codigoPostalCarga + '</td>' +
          '<td style="border:1px solid #333;padding:10px;font-size:15px;">' + r.cidadeDescarga + '</td>' +
          '<td style="border:1px solid #333;padding:10px;font-size:15px;">' + r.codigoPostalDescarga + '</td>' +
          '<td style="border:1px solid #333;padding:10px;font-size:16px;text-align:center;font-weight:bold;">' + r.quantidadeBultos + '</td>' +
          '<td style="border:1px solid #333;padding:10px;font-size:15px;text-align:center;">' + r.ldm + '</td>' +
          '</tr>';
      }
      
      let totalBultos = 0;
      let totalLdm = 0;
      for (let i = 0; i < reservasEnviar.length; i++) {
        totalBultos += reservasEnviar[i].quantidadeBultos || 0;
        totalLdm += reservasEnviar[i].ldm || 0;
      }
      
      const htmlImpressao = '<!DOCTYPE html>' +
        '<html><head><meta charset="UTF-8">' +
        '<title>Ordem de Carga - ArmazÃ©m - Grupagem #' + grupagem.numero + '</title>' +
        '<style>' +
        '@media print { body { margin: 0; padding: 20px; } .no-print { display: none !important; } }' +
        'body { font-family: Arial, sans-serif; padding: 20px; background: white; }' +
        '.header { text-align: center; margin-bottom: 30px; border-bottom: 3px solid #1e3a5f; padding-bottom: 20px; }' +
        '.header h1 { color: #1e3a5f; font-size: 28px; margin: 0 0 10px 0; }' +
        '.header p { color: #666; font-size: 14px; margin: 5px 0; }' +
        '.info-box { background: #f0f9ff; border: 2px solid #1e3a5f; border-radius: 8px; padding: 20px; margin-bottom: 25px; }' +
        '.info-box h2 { color: #1e3a5f; font-size: 20px; margin: 0 0 15px 0; border-bottom: 1px solid #1e3a5f; padding-bottom: 10px; }' +
        '.info-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 15px; }' +
        '.info-item { background: white; padding: 12px; border-radius: 5px; border: 1px solid #ddd; }' +
        '.info-item label { display: block; font-size: 12px; color: #666; margin-bottom: 5px; text-transform: uppercase; }' +
        '.info-item span { display: block; font-size: 18px; font-weight: bold; color: #1e3a5f; }' +
        'table { width: 100%; border-collapse: collapse; margin-top: 20px; }' +
        'th { background: #1e3a5f; color: white; padding: 12px 10px; font-size: 14px; text-align: left; border: 1px solid #333; }' +
        '.totais { margin-top: 20px; text-align: right; font-size: 18px; }' +
        '.totais strong { color: #1e3a5f; }' +
        '.btn-acao { border: none; padding: 15px 40px; font-size: 18px; border-radius: 8px; cursor: pointer; margin: 30px 5px 0 5px; }' +
        '.btn-enviar { background: #16a34a; color: white; }' +
        '.btn-enviar:hover { background: #15803d; }' +
        '.btn-enviar:disabled { background: #9ca3af; cursor: not-allowed; }' +
        '.btn-imprimir { background: #1e3a5f; color: white; }' +
        '.btn-imprimir:hover { background: #2d4a6f; }' +
        '.btn-fechar { background: #64748b; color: white; }' +
        '.status-msg { margin-top: 20px; padding: 15px 25px; border-radius: 8px; font-size: 16px; text-align: center; }' +
        '.status-success { background: #dcfce7; color: #166534; border: 2px solid #16a34a; }' +
        '.status-error { background: #fee2e2; color: #991b1b; border: 2px solid #dc2626; }' +
        '.footer { margin-top: 40px; padding-top: 20px; border-top: 1px solid #ddd; color: #666; font-size: 12px; text-align: center; }' +
        '</style></head><body>' +
        '<div class="header">' +
        '<h1>ğŸ“¦ ORDEM DE CARGA - ARMAZÃ‰M</h1>' +
        '<p><strong>GRUPAGEM #' + grupagem.numero + '</strong></p>' +
        '<p>Data/Hora: ' + dataHoje + '</p>' +
        '</div>' +
        '<div class="info-box">' +
        '<h2>ğŸš› Dados da Grupagem</h2>' +
        '<div class="info-grid">' +
        '<div class="info-item"><label>ğŸ“ Tipo / Destino</label><span>' + grupagem.tipoGrupagem + '</span></div>' +
        '<div class="info-item"><label>ğŸšš Intermodal</label><span>' + grupagem.intermodal + '</span></div>' +
        '<div class="info-item"><label>ğŸ¢ Fornecedor</label><span>' + (grupagem.fornecedor || 'N/A') + '</span></div>' +
        '</div>' +
        '<div class="info-grid">' +
        '<div class="info-item"><label>ğŸ‘¤ Motorista</label><span>' + grupagem.motorista + '</span></div>' +
        '<div class="info-item"><label>ğŸš› Trator</label><span>' + grupagem.matriculaTrator + '</span></div>' +
        '<div class="info-item"><label>ğŸš Reboque</label><span>' + grupagem.matriculaReboque + '</span></div>' +
        '</div>' +
        '<div class="info-grid" style="grid-template-columns: repeat(2, 1fr);">' +
        '<div class="info-item"><label>ğŸ“‹ Booking</label><span>' + (grupagem.booking || '-') + '</span></div>' +
        '<div class="info-item"><label>ğŸ“ Destino Final</label><span>' + (grupagem.destino || 'NÃ£o definido') + '</span></div>' +
        '</div>' +
        '</div>' +
        '<h2 style="color:#1e3a5f;font-size:20px;">ğŸ“‹ Reservas a Carregar (' + reservasEnviar.length + ')</h2>' +
        '<table><thead><tr>' +
        '<th style="width:60px;text-align:center;">ORD</th>' +
        '<th style="width:100px;">NÂº RESERVA</th>' +
        '<th>CLIENTE</th>' +
        '<th>CIDADE CARGA</th>' +
        '<th style="width:100px;">CP CARGA</th>' +
        '<th>CIDADE DESCARGA</th>' +
        '<th style="width:100px;">CP DESCARGA</th>' +
        '<th style="width:80px;text-align:center;">BULTOS</th>' +
        '<th style="width:70px;text-align:center;">LDM</th>' +
        '</tr></thead><tbody>' + linhasTabela + '</tbody></table>' +
        '<div class="totais">' +
        '<p><strong>Total Reservas:</strong> ' + reservasEnviar.length + '</p>' +
        '<p><strong>Total Bultos:</strong> ' + totalBultos + '</p>' +
        '<p><strong>Total LDM:</strong> ' + totalLdm.toFixed(1) + '</p>' +
        '</div>' +
        '<div style="text-align:center;" class="no-print">' +
        '<button class="btn-acao btn-enviar" id="btnEnviar" onclick="agenda1EnviarParaModuloArmazem()">ğŸ“¤ ENVIAR ARMAZÃ‰M</button>' +
        '<button class="btn-acao btn-imprimir" onclick="window.print()">ğŸ–¨ï¸ IMPRIMIR</button>' +
        '<button class="btn-acao btn-fechar" onclick="window.close()">âœ• FECHAR</button>' +
        '<div id="statusMsg" class="status-msg" style="display:none;"></div>' +
        '</div>' +
        '<script>' +
        'function agenda1EnviarParaModuloArmazem() {' +
        '  var btn = document.getElementById("btnEnviar");' +
        '  var statusDiv = document.getElementById("statusMsg");' +
        '  btn.disabled = true;' +
        '  btn.innerHTML = "â³ A enviar...";' +
        '  statusDiv.style.display = "none";' +
        '  setTimeout(function() {' +
        '    var sucesso = Math.random() > 0.1;' +
        '    if (sucesso) {' +
        '      btn.innerHTML = "âœ… ENVIADO";' +
        '      btn.style.background = "#166534";' +
        '      statusDiv.className = "status-msg status-success";' +
        '      statusDiv.innerHTML = "âœ… <strong>Enviado com sucesso!</strong><br>A ordem de carga foi enviada para o MÃ³dulo ArmazÃ©ns.<br>O utilizador do armazÃ©m pode agora aceder e imprimir.";' +
        '      statusDiv.style.display = "block";' +
        '    } else {' +
        '      btn.disabled = false;' +
        '      btn.innerHTML = "ğŸ“¤ ENVIAR ARMAZÃ‰M";' +
        '      statusDiv.className = "status-msg status-error";' +
        '      statusDiv.innerHTML = "âŒ <strong>Erro no envio!</strong><br>NÃ£o foi possÃ­vel enviar para o MÃ³dulo ArmazÃ©ns.<br>Verifique a ligaÃ§Ã£o e tente novamente.";' +
        '      statusDiv.style.display = "block";' +
        '    }' +
        '  }, 1500);' +
        '}' +
        '<\/script>' +
        '<div class="footer"><p>ERP Transportes - MÃ³dulo ArmazÃ©m | Documento gerado automaticamente</p></div>' +
        '</body></html>';
      
      // Abrir nova janela com documento para impressÃ£o
      const janelaImpressao = window.open('', '_blank', 'width=900,height=700');
      janelaImpressao.document.write(htmlImpressao);
      janelaImpressao.document.close();
    }
    
    function agenda1GerarDocumentoArmazemCargaDireta(cargaDireta, reserva) {
      const dataHoje = new Date().toLocaleDateString('pt-PT', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
      
      const htmlImpressao = '<!DOCTYPE html>' +
        '<html><head><meta charset="UTF-8">' +
        '<title>Ordem de Carga - ArmazÃ©m - Carga Direta #' + cargaDireta.numero + '</title>' +
        '<style>' +
        '@media print { body { margin: 0; padding: 20px; } .no-print { display: none !important; } }' +
        'body { font-family: Arial, sans-serif; padding: 20px; background: white; }' +
        '.header { text-align: center; margin-bottom: 30px; border-bottom: 3px solid #0d9488; padding-bottom: 20px; }' +
        '.header h1 { color: #0d9488; font-size: 28px; margin: 0 0 10px 0; }' +
        '.header p { color: #666; font-size: 14px; margin: 5px 0; }' +
        '.info-box { background: #f0fdfa; border: 2px solid #0d9488; border-radius: 8px; padding: 20px; margin-bottom: 25px; }' +
        '.info-box h2 { color: #0d9488; font-size: 20px; margin: 0 0 15px 0; border-bottom: 1px solid #0d9488; padding-bottom: 10px; }' +
        '.info-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 15px; }' +
        '.info-item { background: white; padding: 12px; border-radius: 5px; border: 1px solid #ddd; }' +
        '.info-item label { display: block; font-size: 12px; color: #666; margin-bottom: 5px; text-transform: uppercase; }' +
        '.info-item span { display: block; font-size: 18px; font-weight: bold; color: #0d9488; }' +
        'table { width: 100%; border-collapse: collapse; margin-top: 20px; }' +
        'th { background: #0d9488; color: white; padding: 12px 10px; font-size: 14px; text-align: left; border: 1px solid #333; }' +
        'td { border: 1px solid #333; padding: 10px; font-size: 15px; }' +
        '.totais { margin-top: 20px; text-align: right; font-size: 18px; }' +
        '.totais strong { color: #0d9488; }' +
        '.btn-acao { border: none; padding: 15px 40px; font-size: 18px; border-radius: 8px; cursor: pointer; margin: 30px 5px 0 5px; }' +
        '.btn-enviar { background: #16a34a; color: white; }' +
        '.btn-enviar:hover { background: #15803d; }' +
        '.btn-enviar:disabled { background: #9ca3af; cursor: not-allowed; }' +
        '.btn-imprimir { background: #0d9488; color: white; }' +
        '.btn-imprimir:hover { background: #0f766e; }' +
        '.btn-fechar { background: #64748b; color: white; }' +
        '.status-msg { margin-top: 20px; padding: 15px 25px; border-radius: 8px; font-size: 16px; text-align: center; }' +
        '.status-success { background: #dcfce7; color: #166534; border: 2px solid #16a34a; }' +
        '.status-error { background: #fee2e2; color: #991b1b; border: 2px solid #dc2626; }' +
        '.footer { margin-top: 40px; padding-top: 20px; border-top: 1px solid #ddd; color: #666; font-size: 12px; text-align: center; }' +
        '</style></head><body>' +
        '<div class="header">' +
        '<h1>ğŸš› ORDEM DE CARGA - CARGA DIRETA</h1>' +
        '<p><strong>CARGA DIRETA #' + cargaDireta.numero + '</strong></p>' +
        '<p>Data/Hora: ' + dataHoje + '</p>' +
        '</div>' +
        '<div class="info-box">' +
        '<h2>ğŸš› Dados da Carga Direta</h2>' +
        '<div class="info-grid">' +
        '<div class="info-item"><label>ğŸšš Intermodal</label><span>' + cargaDireta.intermodal + '</span></div>' +
        '<div class="info-item"><label>ğŸ¢ Fornecedor</label><span>' + (cargaDireta.fornecedor || 'N/A') + '</span></div>' +
        '<div class="info-item"><label>ğŸ“ KM / â‚¬KM</label><span>' + cargaDireta.km + ' km / ' + (cargaDireta.valorKm || 0).toFixed(2) + ' â‚¬</span></div>' +
        '</div>' +
        '<div class="info-grid">' +
        '<div class="info-item"><label>ğŸ‘¤ Motorista</label><span>' + cargaDireta.motorista + '</span></div>' +
        '<div class="info-item"><label>ğŸš› Trator</label><span>' + cargaDireta.matriculaTrator + '</span></div>' +
        '<div class="info-item"><label>ğŸš Reboque</label><span>' + cargaDireta.matriculaReboque + '</span></div>' +
        '</div>' +
        '<div class="info-grid" style="grid-template-columns: repeat(2, 1fr);">' +
        '<div class="info-item"><label>ğŸ“‹ Booking</label><span>' + (cargaDireta.booking || '-') + '</span></div>' +
        '<div class="info-item"><label>ğŸ“ Destino Final</label><span>' + (cargaDireta.destino || 'NÃ£o definido') + '</span></div>' +
        '</div>' +
        '</div>' +
        '<h2 style="color:#0d9488;font-size:20px;">ğŸ“‹ Reserva a Carregar</h2>' +
        '<table><thead><tr>' +
        '<th style="width:100px;">NÂº RESERVA</th>' +
        '<th>CLIENTE</th>' +
        '<th>CIDADE CARGA</th>' +
        '<th style="width:100px;">CP CARGA</th>' +
        '<th>CIDADE DESCARGA</th>' +
        '<th style="width:100px;">CP DESCARGA</th>' +
        '<th style="width:80px;text-align:center;">BULTOS</th>' +
        '<th style="width:70px;text-align:center;">LDM</th>' +
        '<th style="width:80px;text-align:right;">PESO</th>' +
        '</tr></thead><tbody>' +
        '<tr>' +
        '<td style="font-weight:bold;">' + reserva.numeroReserva + '</td>' +
        '<td>' + reserva.cliente + '</td>' +
        '<td>' + reserva.cidadeCarga + '</td>' +
        '<td>' + reserva.codigoPostalCarga + '</td>' +
        '<td>' + reserva.cidadeDescarga + '</td>' +
        '<td>' + reserva.codigoPostalDescarga + '</td>' +
        '<td style="text-align:center;font-weight:bold;">' + reserva.quantidadeBultos + '</td>' +
        '<td style="text-align:center;">' + reserva.ldm + '</td>' +
        '<td style="text-align:right;">' + reserva.peso + ' kg</td>' +
        '</tr>' +
        '</tbody></table>' +
        '<div class="totais">' +
        '<p><strong>Bultos:</strong> ' + reserva.quantidadeBultos + '</p>' +
        '<p><strong>LDM:</strong> ' + reserva.ldm + '</p>' +
        '<p><strong>Peso:</strong> ' + reserva.peso + ' kg</p>' +
        '</div>' +
        '<div style="text-align:center;" class="no-print">' +
        '<button class="btn-acao btn-enviar" id="btnEnviar" onclick="agenda1EnviarParaModuloArmazem()">ğŸ“¤ ENVIAR ARMAZÃ‰M</button>' +
        '<button class="btn-acao btn-imprimir" onclick="window.print()">ğŸ–¨ï¸ IMPRIMIR</button>' +
        '<button class="btn-acao btn-fechar" onclick="window.close()">âœ• FECHAR</button>' +
        '<div id="statusMsg" class="status-msg" style="display:none;"></div>' +
        '</div>' +
        '<script>' +
        'function agenda1EnviarParaModuloArmazem() {' +
        '  var btn = document.getElementById("btnEnviar");' +
        '  var statusDiv = document.getElementById("statusMsg");' +
        '  btn.disabled = true;' +
        '  btn.innerHTML = "â³ A enviar...";' +
        '  statusDiv.style.display = "none";' +
        '  setTimeout(function() {' +
        '    var sucesso = Math.random() > 0.1;' +
        '    if (sucesso) {' +
        '      btn.innerHTML = "âœ… ENVIADO";' +
        '      btn.style.background = "#166534";' +
        '      statusDiv.className = "status-msg status-success";' +
        '      statusDiv.innerHTML = "âœ… <strong>Enviado com sucesso!</strong><br>A ordem de carga foi enviada para o MÃ³dulo ArmazÃ©ns.<br>O utilizador do armazÃ©m pode agora aceder e imprimir.";' +
        '      statusDiv.style.display = "block";' +
        '    } else {' +
        '      btn.disabled = false;' +
        '      btn.innerHTML = "ğŸ“¤ ENVIAR ARMAZÃ‰M";' +
        '      statusDiv.className = "status-msg status-error";' +
        '      statusDiv.innerHTML = "âŒ <strong>Erro no envio!</strong><br>NÃ£o foi possÃ­vel enviar para o MÃ³dulo ArmazÃ©ns.<br>Verifique a ligaÃ§Ã£o e tente novamente.";' +
        '      statusDiv.style.display = "block";' +
        '    }' +
        '  }, 1500);' +
        '}' +
        '<\/script>' +
        '<div class="footer"><p>ERP Transportes - MÃ³dulo ArmazÃ©m - Carga Direta | Documento gerado automaticamente</p></div>' +
        '</body></html>';
      
      // Abrir nova janela com documento para impressÃ£o
      const janelaImpressao = window.open('', '_blank', 'width=900,height=700');
      janelaImpressao.document.write(htmlImpressao);
      janelaImpressao.document.close();
    }

    // ========== SELEÃ‡ÃƒO DE RECOLHA ==========
    let reservaAtualRecolha = null;
    
    function agenda1AbrirSelecionarMotorista(reservaId) {
      reservaAtualRecolha = reservaId;
      const r = agenda1Dados.find(d => d.id === reservaId);
      const listaMotoristas = agenda1FrotaMotoristas.map(m => 
        '<div onclick="agenda1SelecionarMotorista(\'' + m.nome + '\')" class="p-2 hover:bg-blue-100 cursor-pointer border-b text-sm">' +
        '<span class="font-medium">ğŸ‘¤ ' + m.nome + '</span>' +
        '</div>'
      ).join('');
      
      agenda1ShowModal('ğŸ‘¤ Selecionar Motorista Recolha', 
        '<p class="text-sm text-slate-600 mb-3">Reserva: <strong>' + r.numeroReserva + '</strong></p>' +
        '<div class="border rounded max-h-64 overflow-y-auto">' + listaMotoristas + '</div>' +
        '<div class="flex justify-end gap-2 mt-4 pt-3 border-t">' +
        '<button onclick="agenda1LimparMotorista()" class="px-3 py-1.5 text-sm bg-red-100 text-red-700 rounded">Limpar</button>' +
        '<button onclick="agenda1CloseModal()" class="px-3 py-1.5 text-sm bg-slate-200 rounded">Cancelar</button>' +
        '</div>', 'blue');
    }
    
    function agenda1SelecionarMotorista(nome) {
      const r = agenda1Dados.find(d => d.id === reservaAtualRecolha);
      if (r) {
        r.motoristaRecolha = nome;
        agenda1RenderTable();
      }
      agenda1CloseModal();
    }
    
    function agenda1LimparMotorista() {
      const r = agenda1Dados.find(d => d.id === reservaAtualRecolha);
      if (r) {
        r.motoristaRecolha = null;
        agenda1RenderTable();
      }
      agenda1CloseModal();
    }
    
    function agenda1AbrirSelecionarTrator(reservaId) {
      reservaAtualRecolha = reservaId;
      const r = agenda1Dados.find(d => d.id === reservaId);
      
      agenda1ShowModal('ğŸš› Selecionar Trator Recolha', 
        '<p class="text-sm text-slate-600 mb-3">Reserva: <strong>' + r.numeroReserva + '</strong> | Local: <strong>' + r.cidadeCarga + '</strong></p>' +
        '<div class="grid grid-cols-2 gap-3 mb-4">' +
        '<button onclick="agenda1MostrarListaTratores()" class="p-4 border-2 border-blue-500 rounded-lg hover:bg-blue-50 text-center">' +
        '<div class="text-2xl mb-2">ğŸ“‹</div>' +
        '<div class="font-semibold text-blue-700">Escolher MatrÃ­cula</div>' +
        '<div class="text-xs text-slate-500">Lista da GestÃ£o de Frota</div>' +
        '</button>' +
        '<button onclick="agenda1VerMapaGPSTrator()" class="p-4 border-2 border-green-500 rounded-lg hover:bg-green-50 text-center">' +
        '<div class="text-2xl mb-2">ğŸ“</div>' +
        '<div class="font-semibold text-green-700">Ver Mapa</div>' +
        '<div class="text-xs text-slate-500">GPS Fortcom - Mais prÃ³ximo</div>' +
        '</button>' +
        '</div>' +
        '<div class="flex justify-end gap-2 pt-3 border-t">' +
        '<button onclick="agenda1LimparTrator()" class="px-3 py-1.5 text-sm bg-red-100 text-red-700 rounded">Limpar</button>' +
        '<button onclick="agenda1CloseModal()" class="px-3 py-1.5 text-sm bg-slate-200 rounded">Cancelar</button>' +
        '</div>', 'teal');
    }
    
    function agenda1MostrarListaTratores() {
      const listaTratores = agenda1FrotaTratores.map(t => 
        '<div onclick="agenda1SelecionarTrator(\'' + t.matricula + '\')" class="p-2 hover:bg-blue-100 cursor-pointer border-b text-sm flex justify-between items-center">' +
        '<span class="font-medium">ğŸš› ' + t.matricula + '</span>' +
        (t.gps ? '<span class="text-xs text-green-600">GPS âœ“</span>' : '') +
        '</div>'
      ).join('');
      
      agenda1ShowModal('ğŸš› Escolher MatrÃ­cula - Trator', 
        '<p class="text-sm text-slate-600 mb-3">Selecione da lista de GestÃ£o de Frota:</p>' +
        '<div class="border rounded max-h-64 overflow-y-auto">' + listaTratores + '</div>' +
        '<div class="flex justify-end gap-2 mt-4 pt-3 border-t">' +
        '<button onclick="agenda1AbrirSelecionarTrator(' + reservaAtualRecolha + ')" class="px-3 py-1.5 text-sm bg-slate-200 rounded">â† Voltar</button>' +
        '</div>', 'blue');
    }
    
    function agenda1VerMapaGPSTrator() {
      const r = agenda1Dados.find(d => d.id === reservaAtualRecolha);
      
      agenda1ShowModal('ğŸ“ GPS Fortcom - Tratores', 
        '<div class="mb-3">' +
        '<p class="text-sm text-slate-600 mb-2">Local de recolha: <strong>' + r.cidadeCarga + '</strong></p>' +
        '<div id="gpsLoadingTrator" class="text-center py-4">' +
        '<div class="inline-block animate-spin rounded-full h-8 w-8 border-4 border-green-500 border-t-transparent"></div>' +
        '<p class="text-sm text-slate-500 mt-2">A comunicar com Fortcom...</p>' +
        '</div>' +
        '<div id="gpsResultadosTrator" class="hidden"></div>' +
        '</div>' +
        '<div class="flex justify-end gap-2 mt-4 pt-3 border-t">' +
        '<button onclick="agenda1AbrirSelecionarTrator(' + reservaAtualRecolha + ')" class="px-3 py-1.5 text-sm bg-slate-200 rounded">â† Voltar</button>' +
        '</div>', 'green');
      
      // Simular GPS instantÃ¢neo (500ms)
      setTimeout(function() {
        const tratoresGPS = [
          { matricula: 'AA-00-BB', distancia: '2.3 km', tempo: '5 min' },
          { matricula: 'EE-22-FF', distancia: '4.1 km', tempo: '8 min' },
          { matricula: 'MN-70-OP', distancia: '6.8 km', tempo: '12 min' },
          { matricula: 'UV-90-WX', distancia: '8.2 km', tempo: '15 min' },
          { matricula: 'CD-12-EF', distancia: '12.5 km', tempo: '22 min' }
        ];
        
        document.getElementById('gpsLoadingTrator').classList.add('hidden');
        const div = document.getElementById('gpsResultadosTrator');
        div.classList.remove('hidden');
        
        let html = '<div class="bg-green-50 border border-green-200 rounded p-3 mb-3 cursor-pointer hover:bg-green-100" onclick="agenda1SelecionarTrator(\'' + tratoresGPS[0].matricula + '\')">' +
          '<p class="text-xs text-green-600 font-semibold">âœ“ MAIS PRÃ“XIMO</p>' +
          '<p class="text-xl font-bold text-green-800">ğŸš› ' + tratoresGPS[0].matricula + '</p>' +
          '<p class="text-sm text-green-600">' + tratoresGPS[0].distancia + ' (~' + tratoresGPS[0].tempo + ')</p>' +
          '</div>' +
          '<p class="text-xs font-semibold text-slate-600 mb-2">Outros disponÃ­veis:</p>' +
          '<div class="space-y-1 max-h-32 overflow-y-auto">';
        
        for (var i = 1; i < tratoresGPS.length; i++) {
          html += '<div class="flex justify-between items-center p-2 bg-slate-50 rounded text-sm cursor-pointer hover:bg-slate-100" onclick="agenda1SelecionarTrator(\'' + tratoresGPS[i].matricula + '\')">' +
            '<span class="font-medium">ğŸš› ' + tratoresGPS[i].matricula + '</span>' +
            '<span class="text-slate-500">' + tratoresGPS[i].distancia + '</span>' +
            '</div>';
        }
        html += '</div>';
        div.innerHTML = html;
      }, 500);
    }
    
    function agenda1SelecionarTrator(matricula) {
      const r = agenda1Dados.find(d => d.id === reservaAtualRecolha);
      if (r) {
        r.tratorRecolha = matricula;
        agenda1RenderTable();
      }
      agenda1CloseModal();
    }
    
    function agenda1LimparTrator() {
      const r = agenda1Dados.find(d => d.id === reservaAtualRecolha);
      if (r) {
        r.tratorRecolha = null;
        agenda1RenderTable();
      }
      agenda1CloseModal();
    }
    
    function agenda1AbrirSelecionarReboque(reservaId) {
      reservaAtualRecolha = reservaId;
      const r = agenda1Dados.find(d => d.id === reservaId);
      
      agenda1ShowModal('ğŸš Selecionar Reboque Recolha', 
        '<p class="text-sm text-slate-600 mb-3">Reserva: <strong>' + r.numeroReserva + '</strong> | Local: <strong>' + r.cidadeCarga + '</strong></p>' +
        '<div class="grid grid-cols-2 gap-3 mb-4">' +
        '<button onclick="agenda1MostrarListaReboques()" class="p-4 border-2 border-blue-500 rounded-lg hover:bg-blue-50 text-center">' +
        '<div class="text-2xl mb-2">ğŸ“‹</div>' +
        '<div class="font-semibold text-blue-700">Escolher MatrÃ­cula</div>' +
        '<div class="text-xs text-slate-500">Lista da GestÃ£o de Frota</div>' +
        '</button>' +
        '<button onclick="agenda1VerMapaGPSReboque()" class="p-4 border-2 border-green-500 rounded-lg hover:bg-green-50 text-center">' +
        '<div class="text-2xl mb-2">ğŸ“</div>' +
        '<div class="font-semibold text-green-700">Ver Mapa</div>' +
        '<div class="text-xs text-slate-500">GPS Fortcom - Mais prÃ³ximo</div>' +
        '</button>' +
        '</div>' +
        '<div class="flex justify-end gap-2 pt-3 border-t">' +
        '<button onclick="agenda1LimparReboque()" class="px-3 py-1.5 text-sm bg-red-100 text-red-700 rounded">Limpar</button>' +
        '<button onclick="agenda1CloseModal()" class="px-3 py-1.5 text-sm bg-slate-200 rounded">Cancelar</button>' +
        '</div>', 'teal');
    }
    
    function agenda1MostrarListaReboques() {
      const listaReboques = agenda1FrotaReboques.map(t => 
        '<div onclick="agenda1SelecionarReboque(\'' + t.matricula + '\')" class="p-2 hover:bg-blue-100 cursor-pointer border-b text-sm flex justify-between items-center">' +
        '<span class="font-medium">ğŸš ' + t.matricula + '</span>' +
        (t.gps ? '<span class="text-xs text-green-600">GPS âœ“</span>' : '') +
        '</div>'
      ).join('');
      
      agenda1ShowModal('ğŸš Escolher MatrÃ­cula - Reboque', 
        '<p class="text-sm text-slate-600 mb-3">Selecione da lista de GestÃ£o de Frota:</p>' +
        '<div class="border rounded max-h-64 overflow-y-auto">' + listaReboques + '</div>' +
        '<div class="flex justify-end gap-2 mt-4 pt-3 border-t">' +
        '<button onclick="agenda1AbrirSelecionarReboque(' + reservaAtualRecolha + ')" class="px-3 py-1.5 text-sm bg-slate-200 rounded">â† Voltar</button>' +
        '</div>', 'blue');
    }
    
    function agenda1VerMapaGPSReboque() {
      const r = agenda1Dados.find(d => d.id === reservaAtualRecolha);
      
      agenda1ShowModal('ğŸ“ GPS Fortcom - Reboques', 
        '<div class="mb-3">' +
        '<p class="text-sm text-slate-600 mb-2">Local de recolha: <strong>' + r.cidadeCarga + '</strong></p>' +
        '<div id="gpsLoadingReboque" class="text-center py-4">' +
        '<div class="inline-block animate-spin rounded-full h-8 w-8 border-4 border-green-500 border-t-transparent"></div>' +
        '<p class="text-sm text-slate-500 mt-2">A comunicar com Fortcom...</p>' +
        '</div>' +
        '<div id="gpsResultadosReboque" class="hidden"></div>' +
        '</div>' +
        '<div class="flex justify-end gap-2 mt-4 pt-3 border-t">' +
        '<button onclick="agenda1AbrirSelecionarReboque(' + reservaAtualRecolha + ')" class="px-3 py-1.5 text-sm bg-slate-200 rounded">â† Voltar</button>' +
        '</div>', 'green');
      
      // Simular GPS instantÃ¢neo (500ms)
      setTimeout(function() {
        const reboquesGPS = [
          { matricula: 'CC-11-DD', distancia: '1.8 km', tempo: '4 min' },
          { matricula: 'GG-33-HH', distancia: '3.5 km', tempo: '7 min' },
          { matricula: 'AB-40-CD', distancia: '5.2 km', tempo: '10 min' },
          { matricula: 'QR-80-ST', distancia: '7.9 km', tempo: '14 min' },
          { matricula: 'YZ-01-AB', distancia: '11.3 km', tempo: '20 min' }
        ];
        
        document.getElementById('gpsLoadingReboque').classList.add('hidden');
        const div = document.getElementById('gpsResultadosReboque');
        div.classList.remove('hidden');
        
        let html = '<div class="bg-green-50 border border-green-200 rounded p-3 mb-3 cursor-pointer hover:bg-green-100" onclick="agenda1SelecionarReboque(\'' + reboquesGPS[0].matricula + '\')">' +
          '<p class="text-xs text-green-600 font-semibold">âœ“ MAIS PRÃ“XIMO</p>' +
          '<p class="text-xl font-bold text-green-800">ğŸš ' + reboquesGPS[0].matricula + '</p>' +
          '<p class="text-sm text-green-600">' + reboquesGPS[0].distancia + ' (~' + reboquesGPS[0].tempo + ')</p>' +
          '</div>' +
          '<p class="text-xs font-semibold text-slate-600 mb-2">Outros disponÃ­veis:</p>' +
          '<div class="space-y-1 max-h-32 overflow-y-auto">';
        
        for (var i = 1; i < reboquesGPS.length; i++) {
          html += '<div class="flex justify-between items-center p-2 bg-slate-50 rounded text-sm cursor-pointer hover:bg-slate-100" onclick="agenda1SelecionarReboque(\'' + reboquesGPS[i].matricula + '\')">' +
            '<span class="font-medium">ğŸš ' + reboquesGPS[i].matricula + '</span>' +
            '<span class="text-slate-500">' + reboquesGPS[i].distancia + '</span>' +
            '</div>';
        }
        html += '</div>';
        div.innerHTML = html;
      }, 500);
    }
    
    function agenda1SelecionarReboque(matricula) {
      const r = agenda1Dados.find(d => d.id === reservaAtualRecolha);
      if (r) {
        r.reboqueRecolha = matricula;
        agenda1RenderTable();
      }
      agenda1CloseModal();
    }
    
    function agenda1LimparReboque() {
      const r = agenda1Dados.find(d => d.id === reservaAtualRecolha);
      if (r) {
        r.reboqueRecolha = null;
        agenda1RenderTable();
      }
      agenda1CloseModal();
    }

    // ========== FORMULÃRIO DA RESERVA - ENVIAR MENSAGEM AO MOTORISTA ==========
    let agenda1ReservaMensagemAtual = null;
    
    function agenda1AbrirFormularioReserva(reservaId) {
      // Abre o formulÃ¡rio da reserva com opÃ§Ã£o de enviar mensagem ao motorista via GPS Fortcom
      const r = agenda1Dados.find(d => d.id === reservaId);
      if (!r) return;
      agenda1ReservaMensagemAtual = reservaId;
      
      const listaTratores = agenda1FrotaTratores.map(t => 
        '<option value="' + t.matricula + '" ' + (t.matricula === r.tratorRecolha ? 'selected' : '') + '>' + t.matricula + '</option>'
      ).join('');
      
      const listaReboques = agenda1FrotaReboques.map(t => 
        '<option value="' + t.matricula + '" ' + (t.matricula === r.reboqueRecolha ? 'selected' : '') + '>' + t.matricula + '</option>'
      ).join('');
      
      const listaMotoristas = agenda1FrotaMotoristas.map(m => 
        '<option value="' + m.nome + '" ' + (m.nome === r.motoristaRecolha ? 'selected' : '') + '>' + m.nome + '</option>'
      ).join('');
      
      agenda1ShowModal('ğŸ“‹ Reserva ' + r.numeroReserva + ' - Enviar Mensagem ao Motorista', `
        <div class="grid grid-cols-2 gap-4 mb-4">
          <div class="bg-slate-50 rounded p-3">
            <h4 class="font-bold text-base mb-2 text-slate-800">ğŸ“¦ Dados da Carga</h4>
            <div class="text-sm space-y-1.5">
              <p><strong class="text-slate-700">Cliente:</strong> <span class="text-black font-semibold">${r.cliente}</span></p>
              <p><strong class="text-slate-700">Comercial:</strong> <span class="text-black font-medium">${r.comercial}</span></p>
              <p><strong class="text-slate-700">LDM:</strong> <span class="text-black font-bold">${r.ldm}</span> | <strong class="text-slate-700">Peso:</strong> <span class="text-black font-bold">${r.peso} kg</span></p>
              <p><strong class="text-slate-700">Bultos:</strong> <span class="text-black font-bold">${r.quantidadeBultos}</span></p>
              <p><strong class="text-slate-700">Prioridade:</strong> <span class="text-black font-semibold">${r.prioridadeCarga}</span></p>
            </div>
          </div>
          <div class="bg-slate-50 rounded p-3">
            <h4 class="font-bold text-base mb-2 text-slate-800">ğŸ“ Trajeto</h4>
            <div class="text-sm space-y-1.5">
              <p><strong class="text-slate-700">Carga:</strong> <span class="text-black font-semibold">${r.cidadeCarga}</span> <span class="text-slate-600">(${r.codigoPostalCarga})</span></p>
              <p><strong class="text-slate-700">Descarga:</strong> <span class="text-black font-semibold">${r.cidadeDescarga}</span> <span class="text-slate-600">(${r.codigoPostalDescarga})</span></p>
              <p><strong class="text-slate-700">Data Carga:</strong> <span class="text-black font-semibold">${agenda1FormatDate(r.dataCarga)}</span></p>
              <p><strong class="text-slate-700">Data Entrega:</strong> <span class="text-black font-semibold">${agenda1FormatDate(r.dataEntrega)}</span></p>
            </div>
          </div>
        </div>
        
        <div class="bg-amber-50 border-2 border-amber-300 rounded p-3 mb-4">
          <h4 class="font-bold text-base mb-3 text-amber-900">ğŸš› Dados de Recolha</h4>
          <div class="grid grid-cols-3 gap-3">
            <div>
              <label class="block text-sm font-bold mb-1 text-slate-800">ğŸ‘¤ Motorista Recolha</label>
              <select id="formMotorista" class="w-full text-sm font-semibold border-2 border-amber-300 rounded px-2 py-2 bg-white" onchange="agenda1AtualizarRecolhaFormulario()">
                <option value="">-- Selecione --</option>
                ${listaMotoristas}
              </select>
            </div>
            <div>
              <label class="block text-sm font-bold mb-1 text-slate-800">ğŸš› Trator Recolha</label>
              <div class="flex gap-1">
                <select id="formTrator" class="flex-1 text-sm font-bold border-2 border-amber-300 rounded px-2 py-2 bg-white" onchange="agenda1AtualizarRecolhaFormulario()">
                  <option value="">-- Selecione --</option>
                  ${listaTratores}
                </select>
                <button onclick="agenda1VerMapaTratorFormulario()" class="px-3 py-2 text-sm bg-green-600 text-white rounded font-bold" title="Ver Mapa GPS">ğŸ“</button>
              </div>
            </div>
            <div>
              <label class="block text-sm font-bold mb-1 text-slate-800">ğŸš Reboque Recolha</label>
              <div class="flex gap-1">
                <select id="formReboque" class="flex-1 text-sm font-bold border-2 border-amber-300 rounded px-2 py-2 bg-white" onchange="agenda1AtualizarRecolhaFormulario()">
                  <option value="">-- Selecione --</option>
                  ${listaReboques}
                </select>
                <button onclick="agenda1VerMapaReboqueFormulario()" class="px-3 py-2 text-sm bg-green-600 text-white rounded font-bold" title="Ver Mapa GPS">ğŸ“</button>
              </div>
            </div>
          </div>
        </div>
        
        <div class="bg-blue-50 border-2 border-blue-300 rounded p-3 mb-4">
          <h4 class="font-bold text-base mb-2 text-blue-900">ğŸ“¨ Mensagem para o Motorista (GPS Fortcom)</h4>
          <textarea id="formMensagem" rows="3" class="w-full text-sm font-medium border-2 border-blue-300 rounded px-2 py-2" placeholder="Escreva a mensagem...">Recolha: ${r.cidadeCarga} (${r.codigoPostalCarga})
Entrega: ${r.cidadeDescarga} (${r.codigoPostalDescarga})
Cliente: ${r.cliente}
Bultos: ${r.quantidadeBultos} | LDM: ${r.ldm}</textarea>
        </div>
        
        <div id="formMsgStatus" class="hidden mb-3"></div>
        
        <div class="flex justify-between items-center">
          <div class="text-sm text-slate-600">
            ${r.msgEnviada ? '<span class="text-green-600 font-semibold">âœ“ Mensagem jÃ¡ enviada anteriormente</span>' : '<span class="text-slate-500">â—‹ Mensagem ainda nÃ£o enviada</span>'}
          </div>
          <div class="flex gap-2">
            <button onclick="agenda1FecharFormularioReserva()" class="px-4 py-2 text-sm bg-slate-200 hover:bg-slate-300 rounded font-medium">Fechar</button>
            <button onclick="agenda1EnviarMensagemFormulario()" class="px-4 py-2 text-sm bg-blue-600 hover:bg-blue-700 text-white rounded font-bold">ğŸ“¤ Enviar Mensagem</button>
          </div>
        </div>
      `, 'blue');
    }
    
    function agenda1FecharFormularioReserva() {
      // Atualiza a tabela antes de fechar o modal
      agenda1AtualizarRecolhaFormulario();
      agenda1CloseModal();
      agenda1RenderTable();
    }
    
    function agenda1AtualizarRecolhaFormulario() {
      // Atualiza automaticamente na linha da Agenda 1
      const r = agenda1Dados.find(d => d.id === agenda1ReservaMensagemAtual);
      if (!r) return;
      
      const mot = document.getElementById('formMotorista').value;
      const trat = document.getElementById('formTrator').value;
      const reb = document.getElementById('formReboque').value;
      
      if (mot) r.motoristaRecolha = mot;
      if (trat) r.tratorRecolha = trat;
      if (reb) r.reboqueRecolha = reb;
      
      // Sincronizar com a reserva (R35, R36, R37)
      sincronizarAgenda1ParaReserva(r.numeroReserva, mot, trat, reb);
    }
    
    function agenda1VerMapaTratorFormulario() {
      const r = agenda1Dados.find(d => d.id === agenda1ReservaMensagemAtual);
      const tratoresGPS = [
        { matricula: 'AA-00-BB', distancia: '2.3 km' },
        { matricula: 'EE-22-FF', distancia: '4.1 km' },
        { matricula: 'MN-70-OP', distancia: '6.8 km' }
      ];
      
      const maisProximo = tratoresGPS[0].matricula;
      document.getElementById('formTrator').value = maisProximo;
      agenda1AtualizarRecolhaFormulario();
      alert('ğŸ“ GPS Fortcom - Trator mais prÃ³ximo de ' + r.cidadeCarga + ':\n\n' + 
        tratoresGPS.map((t,i) => (i===0 ? 'âœ“ ' : '  ') + t.matricula + ' - ' + t.distancia).join('\n') +
        '\n\nSelecionado: ' + maisProximo);
    }
    
    function agenda1VerMapaReboqueFormulario() {
      const r = agenda1Dados.find(d => d.id === agenda1ReservaMensagemAtual);
      const reboquesGPS = [
        { matricula: 'CC-11-DD', distancia: '1.8 km' },
        { matricula: 'GG-33-HH', distancia: '3.5 km' },
        { matricula: 'AB-40-CD', distancia: '5.2 km' }
      ];
      
      const maisProximo = reboquesGPS[0].matricula;
      document.getElementById('formReboque').value = maisProximo;
      agenda1AtualizarRecolhaFormulario();
      alert('ğŸ“ GPS Fortcom - Reboque mais prÃ³ximo de ' + r.cidadeCarga + ':\n\n' + 
        reboquesGPS.map((t,i) => (i===0 ? 'âœ“ ' : '  ') + t.matricula + ' - ' + t.distancia).join('\n') +
        '\n\nSelecionado: ' + maisProximo);
    }
    
    function agenda1EnviarMensagemFormulario() {
      const r = agenda1Dados.find(d => d.id === agenda1ReservaMensagemAtual);
      if (!r) return;
      
      const mot = document.getElementById('formMotorista').value;
      const trat = document.getElementById('formTrator').value;
      const reb = document.getElementById('formReboque').value;
      const msg = document.getElementById('formMensagem').value;
      
      if (!trat || !reb) {
        alert('âš ï¸ Selecione o Trator e Reboque para enviar a mensagem.');
        return;
      }
      
      // Atualizar reserva na Agenda 1
      if (mot) r.motoristaRecolha = mot;
      r.tratorRecolha = trat;
      r.reboqueRecolha = reb;
      r.msgEnviada = true;
      
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // SINCRONIZAÃ‡ÃƒO: Atualizar tambÃ©m a reserva no localStorage (R35/R36/R37)
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      sincronizarAgenda1ParaReserva(r.numeroReserva, mot, trat, reb);
      
      const statusDiv = document.getElementById('formMsgStatus');
      statusDiv.className = 'mb-3 p-3 bg-yellow-50 border border-yellow-200 rounded text-center';
      statusDiv.innerHTML = 'â³ A enviar via GPS Fortcom...';
      statusDiv.classList.remove('hidden');
      
      setTimeout(function() {
        statusDiv.className = 'mb-3 p-3 bg-green-50 border border-green-200 rounded text-center';
        statusDiv.innerHTML = 'âœ… <strong>Mensagem enviada com sucesso!</strong>';
        
        setTimeout(function() {
          agenda1CloseModal();
          agenda1RenderTable();
        }, 800);
      }, 600);
    }
    
    /**
     * Sincroniza dados da Agenda 1 â†’ Reserva (R35, R36, R37 e R54, R55, R56)
     */
    function sincronizarAgenda1ParaReserva(numeroReserva, motorista, trator, reboque, motoristaDescarga, tratorDescarga, reboqueDescarga) {
      try {
        let reservas = JSON.parse(localStorage.getItem('erpReservasExecutadas') || '[]');
        const index = reservas.findIndex(r => r.numero === numeroReserva);
        
        if (index !== -1) {
          // Atualizar campos R35, R36, R37 (Carga)
          if (motorista) reservas[index].motoristaCarga = motorista;
          if (trator) reservas[index].tratorCarga = trator;
          if (reboque) reservas[index].reboqueCarga = reboque;
          
          // Atualizar campos R54, R55, R56 (Descarga)
          if (motoristaDescarga) reservas[index].motoristaDescarga = motoristaDescarga;
          if (tratorDescarga) reservas[index].tratorDescarga = tratorDescarga;
          if (reboqueDescarga) reservas[index].reboqueDescarga = reboqueDescarga;
          
          // Guardar no localStorage
          localStorage.setItem('erpReservasExecutadas', JSON.stringify(reservas));
          console.log('ğŸ”„ SincronizaÃ§Ã£o Agenda1 â†’ Reserva: ' + numeroReserva);
        }
      } catch(e) {
        console.error('Erro na sincronizaÃ§Ã£o Agenda1 â†’ Reserva:', e);
      }
    }
    
    /**
     * Sincroniza dados da Reserva â†’ Agenda 1 (chamada quando reserva Ã© guardada)
     */
    function sincronizarReservaParaAgenda1(numeroReserva, motorista, trator, reboque, motoristaDescarga, tratorDescarga, reboqueDescarga) {
      try {
        const reservaAgenda1 = agenda1Dados.find(d => d.numeroReserva === numeroReserva);
        
        if (reservaAgenda1) {
          // Atualizar campos na Agenda 1 (Carga/Recolha)
          if (motorista) reservaAgenda1.motoristaRecolha = motorista;
          if (trator) reservaAgenda1.tratorRecolha = trator;
          if (reboque) reservaAgenda1.reboqueRecolha = reboque;
          
          // Atualizar campos na Agenda 1 (Descarga/Entrega)
          if (motoristaDescarga) reservaAgenda1.motoristaEntrega = motoristaDescarga;
          if (tratorDescarga) reservaAgenda1.tratorEntrega = tratorDescarga;
          if (reboqueDescarga) reservaAgenda1.reboqueEntrega = reboqueDescarga;
          
          console.log('ğŸ”„ SincronizaÃ§Ã£o Reserva â†’ Agenda1: ' + numeroReserva);
          
          // Atualizar a tabela se estiver visÃ­vel
          if (typeof agenda1RenderTable === 'function') {
            agenda1RenderTable();
          }
        }
      } catch(e) {
        console.error('Erro na sincronizaÃ§Ã£o Reserva â†’ Agenda1:', e);
      }
    }

    function agenda1AbrirReserva(id) {
      const r = agenda1Dados.find(d => d.id === id);
      if (!r) return;
      
      // Tentar encontrar a reserva no localStorage
      let reservasGuardadas = [];
      try {
        const dados = localStorage.getItem('erpReservasExecutadas');
        if (dados) reservasGuardadas = JSON.parse(dados);
      } catch(e) {}
      
      const reservaCompleta = reservasGuardadas.find(res => res.numero === r.numeroReserva);
      
      if (reservaCompleta) {
        // Abrir a ficha de reserva completa
        navegarPara('reservas');
        setTimeout(() => {
          preencherReservaNoFormulario(reservaCompleta);
        }, 300);
      } else {
        // Mostrar modal resumido se nÃ£o encontrar dados completos
        agenda1ShowModal('ğŸ“‹ ' + r.numeroReserva, `
          <div class="grid grid-cols-2 gap-3 text-sm">
            <p><strong>Cliente:</strong> ${r.cliente}</p>
            <p><strong>Comercial:</strong> ${r.comercial}</p>
            <p><strong>Carga:</strong> ${r.cidadeCarga}</p>
            <p><strong>Descarga:</strong> ${r.cidadeDescarga}</p>
            <p><strong>LDM:</strong> ${r.ldm}</p>
            <p><strong>Peso:</strong> ${r.peso}</p>
            <p><strong>Valor:</strong> ${agenda1FormatCurrency(r.valorServico)}</p>
          </div>
          <div class="mt-4 p-3 bg-amber-50 rounded border border-amber-200 text-sm">
            <p>âš ï¸ Reserva nÃ£o encontrada no histÃ³rico local.</p>
            <p class="mt-1">A reserva pode ter sido criada antes do sistema de histÃ³rico.</p>
          </div>
          <div class="mt-4 flex justify-end gap-2">
            <button onclick="navegarPara('reservas'); agenda1CloseModal();" class="px-3 py-1.5 text-sm bg-blue-500 text-white rounded hover:bg-blue-600">Ir para Reservas</button>
            <button onclick="agenda1CloseModal()" class="px-3 py-1.5 text-sm bg-slate-200 rounded">Fechar</button>
          </div>`);
      }
    }

    // Zoom
    document.addEventListener('wheel', (e) => {
      if (e.ctrlKey) {
        e.preventDefault();
        agenda1CurrentZoom = Math.min(200, Math.max(50, agenda1CurrentZoom + (e.deltaY > 0 ? -10 : 10)));
        document.getElementById('agenda1ZoomContainer').style.transform = `scale(${agenda1CurrentZoom / 100})`;
        document.getElementById('agenda1ZoomLevel').textContent = `${agenda1CurrentZoom}%`;
      }
    }, { passive: false });

    // FunÃ§Ã£o de navegaÃ§Ã£o por teclado para os campos ORD
    function agenda1NavegacaoTeclado(event, rowId) {
      var key = event.key;
      var currentInput = event.target;
      
      // Obter todos os inputs de ordenaÃ§Ã£o visÃ­veis
      var allInputs = Array.from(document.querySelectorAll('.agenda1-input-ord'));
      var currentIndex = allInputs.indexOf(currentInput);
      
      if (currentIndex === -1) return;
      
      var nextIndex = -1;
      
      // Enter ou Seta para baixo - prÃ³ximo input
      if (key === 'Enter' || key === 'ArrowDown') {
        nextIndex = currentIndex + 1;
        event.preventDefault();
      }
      
      // Seta para cima - input anterior
      if (key === 'ArrowUp') {
        nextIndex = currentIndex - 1;
        event.preventDefault();
      }
      
      // Navegar se vÃ¡lido
      if (nextIndex >= 0 && nextIndex < allInputs.length) {
        allInputs[nextIndex].focus();
        allInputs[nextIndex].select();
      }
    }

    function inicializarAgenda1() {
      console.log('âœ… MÃ³dulo Agenda 1 v5.2 (v29 completo) inicializado');
      agenda1RenderTable();
      
      // Zoom com Ctrl+scroll apenas na Ã¡rea da Agenda 1
      var agenda1Page = document.getElementById('page-agenda1');
      if (agenda1Page) {
        agenda1Page.addEventListener('wheel', function(e) {
          if (e.ctrlKey) {
            e.preventDefault();
            agenda1CurrentZoom = Math.min(200, Math.max(50, agenda1CurrentZoom + (e.deltaY > 0 ? -10 : 10)));
            var zoomContainer = document.getElementById('agenda1ZoomContainer');
            if (zoomContainer) zoomContainer.style.transform = 'scale(' + (agenda1CurrentZoom / 100) + ')';
            var zoomLevel = document.getElementById('agenda1ZoomLevel');
            if (zoomLevel) zoomLevel.textContent = agenda1CurrentZoom + '%';
          }
        }, { passive: false });
      }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // MÃ“DULO AGENDA 2 v6 - JAVASCRIPT COMPLETO (NÃƒO ALTERAR LÃ“GICA)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    // ConfiguraÃ§Ã£o Agenda 2
    var AGENDA2_EQUIPA_ATUAL = 'Lisboa';
    var AGENDA2_EQUIPAS_DISPONIVEIS = ['Lisboa', 'Porto', 'Alemanha', 'Holanda', 'Espanha', 'ExportaÃ§Ã£o', 'ImportaÃ§Ã£o'];
    
    var agenda2ContadorGrupagens = 0;
    var agenda2ContadorCargasDiretas = 0;
    var agenda2Grupagens = [];
    var agenda2CargasDiretas = [];
    var agenda2ExpandedGrupagens = {};
    var agenda2ExpandedCDs = {};
    var agenda2SortColumn = null;
    var agenda2SortDirection = 'asc';
    var agenda2Charts = {};
    var agenda2CurrentZoom = 100;
    
    // Dados exemplo Agenda 2
    function agenda2InicializarDadosExemplo() {
      agenda2Grupagens = [
        {
          id: 1, numero: 1, tipoGrupagem: 'Portugal Â» Alemanha', intermodal: 'Rodovia Contratada',
          fornecedor: 'Transportes Silva Lda', motorista: 'Manuel Costa', matriculaTrator: 'AA-00-BB',
          matriculaReboque: 'CC-11-DD', booking: 'rgrhsath', bookingBloqueado: true, destino: 'Direto Clientes',
          dataCriacao: '2025-01-15', passadoAgenda3: false, enviadoPara: null,
          reservas: [
            { numeroReserva: 'RES-001', cliente: 'Empresa ABC Lda', cidadeCarga: 'Lisboa', cidadeDescarga: 'Munique', ldm: 3.5, peso: 1500, bultos: 18, valor: 900 },
            { numeroReserva: 'RES-002', cliente: 'Transportes XYZ', cidadeCarga: 'Coimbra', cidadeDescarga: 'Frankfurt', ldm: 5.0, peso: 2200, bultos: 25, valor: 1200 },
            { numeroReserva: 'RES-003', cliente: 'LogÃ­stica Norte SA', cidadeCarga: 'Braga', cidadeDescarga: 'Berlim', ldm: 2.0, peso: 800, bultos: 10, valor: 580 }
          ]
        },
        {
          id: 2, numero: 2, tipoGrupagem: 'Portugal Â» Holanda', intermodal: 'Navio',
          fornecedor: 'Trans Europa', motorista: 'Carlos Ferreira', matriculaTrator: 'EE-22-FF',
          matriculaReboque: 'GG-33-HH', booking: 'qwerf', bookingBloqueado: false, destino: 'ArmazÃ©m Holanda',
          dataCriacao: '2025-01-16', passadoAgenda3: true, enviadoPara: 'Agenda 3 Holanda',
          reservas: [
            { numeroReserva: 'RES-006', cliente: 'Distribuidora Sul SA', cidadeCarga: 'Ã‰vora', cidadeDescarga: 'AmesterdÃ£o', ldm: 7.5, peso: 4100, bultos: 55, valor: 1680 },
            { numeroReserva: 'RES-007', cliente: 'TÃªxteis Minho Lda', cidadeCarga: 'GuimarÃ£es', cidadeDescarga: 'RoterdÃ£o', ldm: 2.8, peso: 950, bultos: 12, valor: 520 }
          ]
        },
        {
          id: 3, numero: 3, tipoGrupagem: 'Portugal Â» Barcelona', intermodal: 'Comboio',
          fornecedor: 'Rail Cargo', motorista: 'Rui Martins', matriculaTrator: 'MN-70-OP',
          matriculaReboque: 'AB-40-CD', booking: 'RAIL2025-0', bookingBloqueado: false, destino: 'Direto Clientes',
          dataCriacao: '2025-01-17', passadoAgenda3: false, enviadoPara: null,
          reservas: [
            { numeroReserva: 'RES-004', cliente: 'IndÃºstria Global SA', cidadeCarga: 'SetÃºbal', cidadeDescarga: 'Barcelona', ldm: 6.2, peso: 3200, bultos: 45, valor: 1450 }
          ]
        },
        {
          id: 4, numero: 4, tipoGrupagem: 'Portugal Â» Madrid', intermodal: 'Rodovia PrÃ³pria',
          fornecedor: 'N/A', motorista: 'JosÃ© Santos', matriculaTrator: 'QR-45-ST',
          matriculaReboque: 'UV-67-WX', booking: '', bookingBloqueado: true, destino: 'Direto Clientes',
          dataCriacao: '2025-01-18', passadoAgenda3: true, enviadoPara: 'Agenda 3 Espanha',
          reservas: [
            { numeroReserva: 'RES-020', cliente: 'IbÃ©rica Trade', cidadeCarga: 'Porto', cidadeDescarga: 'Madrid', ldm: 4.5, peso: 2200, bultos: 25, valor: 980 },
            { numeroReserva: 'RES-021', cliente: 'Castela Logistics', cidadeCarga: 'Aveiro', cidadeDescarga: 'Madrid', ldm: 3.2, peso: 1500, bultos: 18, valor: 720 }
          ]
        }
      ];
      
      agenda2CargasDiretas = [
        {
          id: 1, numero: 1, intermodal: 'Rodovia Contratada', fornecedor: 'Transportes Silva Lda',
          motorista: 'Manuel Costa', matriculaTrator: 'AA-00-BB', matriculaReboque: 'CC-11-DD',
          km: 1850, valorKm: 1.14, booking: '', bookingBloqueado: true, destino: 'Direto Clientes',
          dataCriacao: '2025-01-13', passadoAgenda3: false, enviadoPara: null,
          reserva: { numeroReserva: 'RES-008', cliente: 'ConstruÃ§Ãµes Tejo SA', cidadeCarga: 'SantarÃ©m', cidadeDescarga: 'Roma', ldm: 8.0, peso: 5500, bultos: 18, valor: 2100 }
        },
        {
          id: 2, numero: 2, intermodal: 'Navio', fornecedor: 'Sea Transport',
          motorista: 'AntÃ³nio Lopes', matriculaTrator: 'YY-30-ZZ', matriculaReboque: 'QR-80-ST',
          km: 2200, valorKm: 0.86, booking: 'qetg', bookingBloqueado: false, destino: 'ArmazÃ©m Lisboa',
          dataCriacao: '2025-01-14', passadoAgenda3: true, enviadoPara: 'Agenda 3 Lisboa',
          reserva: { numeroReserva: 'RES-011', cliente: 'MÃ³veis Alentejo Lda', cidadeCarga: 'Beja', cidadeDescarga: 'Madrid', ldm: 9.0, peso: 2800, bultos: 6, valor: 1890 }
        }
      ];
      
      agenda2ContadorGrupagens = 4;
      agenda2ContadorCargasDiretas = 2;
    }
    
    // UtilitÃ¡rios Agenda 2
    function agenda2FormatCurrency(v) { return new Intl.NumberFormat('pt-PT', { style: 'currency', currency: 'EUR' }).format(v || 0); }
    function agenda2FormatNumber(v) { return new Intl.NumberFormat('pt-PT').format(v || 0); }
    
    function agenda2CalcularTotaisGrupagem(g) {
      var ldm = g.reservas.reduce(function(s, r) { return s + (r.ldm || 0); }, 0);
      var peso = g.reservas.reduce(function(s, r) { return s + (r.peso || 0); }, 0);
      var bultos = g.reservas.reduce(function(s, r) { return s + (r.bultos || 0); }, 0);
      var valor = g.reservas.reduce(function(s, r) { return s + (r.valor || 0); }, 0);
      var euroLdm = ldm > 0 ? valor / ldm : 0;
      return { ldm: ldm, peso: peso, bultos: bultos, valor: valor, euroLdm: euroLdm };
    }
    
    function agenda2PodeEditarBooking(intermodal) {
      return intermodal === 'Navio' || intermodal === 'Comboio';
    }
    
    // Limpar TODOS os filtros (botÃ£o X)
    function agenda2LimparTodosFiltros() {
      document.getElementById('agenda2FilterTipo').value = '';
      document.getElementById('agenda2FilterIntermodal').value = '';
      document.getElementById('agenda2FilterRota').value = '';
      document.getElementById('agenda2FilterEnviado').value = '';
      document.getElementById('agenda2FilterDataInicio').value = '';
      document.getElementById('agenda2FilterDataFim').value = '';
      document.getElementById('agenda2SearchInput').value = '';
      agenda2RenderTable();
    }
    
    // Tabs Agenda 2
    function agenda2MostrarTab(tab) {
      document.getElementById('agenda2AreaListagem').classList.toggle('hidden', tab !== 'listagem');
      document.getElementById('agenda2AreaDashboards').classList.toggle('hidden', tab !== 'dashboards');
      document.getElementById('agenda2FiltrosArea').classList.toggle('hidden', tab !== 'listagem');
      document.getElementById('agenda2TabListagem').classList.toggle('active', tab === 'listagem');
      document.getElementById('agenda2TabDashboards').classList.toggle('active', tab === 'dashboards');
      if (tab === 'dashboards') agenda2AtualizarDashboards();
    }
    
    // OrdenaÃ§Ã£o Agenda 2
    function agenda2OrdenarPor(coluna) {
      if (agenda2SortColumn === coluna) {
        agenda2SortDirection = agenda2SortDirection === 'asc' ? 'desc' : 'asc';
      } else {
        agenda2SortColumn = coluna;
        agenda2SortDirection = 'asc';
      }
      
      document.querySelectorAll('.agenda2-sort-indicator').forEach(function(el) { el.textContent = ''; });
      var indicator = document.getElementById('agenda2-sort-' + coluna);
      if (indicator) {
        indicator.textContent = agenda2SortDirection === 'asc' ? 'â–²' : 'â–¼';
      }
      
      agenda2RenderTable();
    }
    
    function agenda2OrdenarDados(dados, tipo) {
      if (!agenda2SortColumn) return dados;
      
      return dados.slice().sort(function(a, b) {
        var valA, valB;
        
        if (tipo === 'grupagem') {
          var totaisA = agenda2CalcularTotaisGrupagem(a);
          var totaisB = agenda2CalcularTotaisGrupagem(b);
          
          switch(agenda2SortColumn) {
            case 'numero': valA = a.numero; valB = b.numero; break;
            case 'tipo': valA = 'grupagem'; valB = 'grupagem'; break;
            case 'rota': valA = a.tipoGrupagem; valB = b.tipoGrupagem; break;
            case 'intermodal': valA = a.intermodal; valB = b.intermodal; break;
            case 'ldm': valA = totaisA.ldm; valB = totaisB.ldm; break;
            case 'peso': valA = totaisA.peso; valB = totaisB.peso; break;
            case 'valor': valA = totaisA.valor; valB = totaisB.valor; break;
            default: return 0;
          }
        } else {
          switch(agenda2SortColumn) {
            case 'numero': valA = a.numero; valB = b.numero; break;
            case 'tipo': valA = 'cargadireta'; valB = 'cargadireta'; break;
            case 'rota': valA = a.reserva.cidadeCarga; valB = b.reserva.cidadeCarga; break;
            case 'intermodal': valA = a.intermodal; valB = b.intermodal; break;
            case 'ldm': valA = a.reserva.ldm; valB = b.reserva.ldm; break;
            case 'peso': valA = a.reserva.peso; valB = b.reserva.peso; break;
            case 'valor': valA = a.reserva.valor; valB = b.reserva.valor; break;
            default: return 0;
          }
        }
        
        if (typeof valA === 'string') {
          return agenda2SortDirection === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
        }
        return agenda2SortDirection === 'asc' ? valA - valB : valB - valA;
      });
    }
    
    // RenderizaÃ§Ã£o Agenda 2
    function agenda2RenderTable() {
      var tbody = document.getElementById('agenda2TableBody');
      var search = document.getElementById('agenda2SearchInput').value.toLowerCase();
      var filterTipo = document.getElementById('agenda2FilterTipo').value;
      var filterIntermodal = document.getElementById('agenda2FilterIntermodal').value;
      var filterRota = document.getElementById('agenda2FilterRota').value;
      var filterEnviado = document.getElementById('agenda2FilterEnviado').value;
      var filterDataInicio = document.getElementById('agenda2FilterDataInicio').value;
      var filterDataFim = document.getElementById('agenda2FilterDataFim').value;
      
      var html = '';
      var countItens = 0;
      var totaisGerais = { ldm: 0, peso: 0, bultos: 0, valor: 0, km: 0 };
      
      // Filtrar e ordenar grupagens
      var grupagensFiltradas = agenda2Grupagens.filter(function(g) {
        if (filterTipo === 'cargadireta') return false;
        if (filterIntermodal && g.intermodal !== filterIntermodal) return false;
        if (filterRota && g.tipoGrupagem !== filterRota) return false;
        if (filterEnviado === 'nao' && g.enviadoPara) return false;
        if (filterEnviado === 'sim' && !g.enviadoPara) return false;
        if (filterDataInicio && g.dataCriacao < filterDataInicio) return false;
        if (filterDataFim && g.dataCriacao > filterDataFim) return false;
        
        if (search) {
          var searchFields = [
            g.tipoGrupagem, g.intermodal, g.fornecedor, g.motorista, g.matriculaTrator,
            g.matriculaReboque, g.booking, g.destino, String(g.numero)
          ].concat(g.reservas.map(function(r) { return r.numeroReserva; }))
           .concat(g.reservas.map(function(r) { return r.cliente; }))
           .concat(g.reservas.map(function(r) { return r.cidadeCarga; }))
           .concat(g.reservas.map(function(r) { return r.cidadeDescarga; }))
           .filter(Boolean).join(' ').toLowerCase();
          if (searchFields.indexOf(search) === -1) return false;
        }
        return true;
      });
      
      grupagensFiltradas = agenda2OrdenarDados(grupagensFiltradas, 'grupagem');
      
      // Renderizar grupagens
      grupagensFiltradas.forEach(function(g) {
        var totais = agenda2CalcularTotaisGrupagem(g);
        var canEditBooking = agenda2PodeEditarBooking(g.intermodal);
        var bookingInputClass = canEditBooking && !g.bookingBloqueado ? 'agenda2-booking-input-enabled' : 'agenda2-booking-input-disabled';
        var bookingDisabled = !canEditBooking || g.bookingBloqueado ? 'disabled' : '';
        var isExpanded = agenda2ExpandedGrupagens[g.id] || false;
        var btnIcon = isExpanded ? 'â–¼' : 'â–¶';
        var rowEnviadoClass = g.enviadoPara ? 'agenda2-row-enviado' : 'agenda2-row-nao-enviado';
        var iconEnvio = g.enviadoPara ? '' : 'âš ï¸ ';
        
        html += '<tr class="agenda2-row-group-header-grupagem ' + rowEnviadoClass + '">' +
          '<td class="font-bold text-green-800">' + iconEnvio + 'Grupagem ' + g.numero + '</td>' +
          '<td><span class="bg-green-600 text-white text-xs px-2 py-0.5 rounded">GRUPAGEM</span></td>' +
          '<td class="font-semibold">' + g.tipoGrupagem + '</td>' +
          '<td><span class="' + (g.intermodal === 'Navio' ? 'text-blue-600' : g.intermodal === 'Comboio' ? 'text-purple-600' : '') + ' font-semibold">' + g.intermodal + '</span></td>' +
          '<td>' + g.fornecedor + '</td>' +
          '<td>ğŸ‘¤ ' + g.motorista + '</td>' +
          '<td>ğŸš› ' + g.matriculaTrator + '</td>' +
          '<td>ğŸš ' + g.matriculaReboque + '</td>' +
          '<td class="text-right font-bold">' + totais.ldm.toFixed(1) + '</td>' +
          '<td class="text-right font-bold">' + agenda2FormatNumber(totais.peso) + '</td>' +
          '<td class="text-right font-bold">' + totais.bultos + '</td>' +
          '<td class="text-right font-bold text-green-700">' + agenda2FormatCurrency(totais.valor) + '</td>' +
          '<td class="text-right font-bold text-amber-700">' + agenda2FormatCurrency(totais.euroLdm) + '</td>' +
          '<td class="text-right text-slate-400">-</td>' +
          '<td class="text-right text-slate-400">-</td>' +
          '<td>' +
            '<div class="flex items-center gap-1">' +
              '<input type="text" id="agenda2-booking-g-' + g.id + '" value="' + (g.booking || '') + '" ' +
                'class="text-xs px-2 py-1 rounded w-20 agenda2-input-nav ' + bookingInputClass + '" ' + bookingDisabled + ' ' +
                'onkeydown="agenda2NavegacaoTeclado(event)">' +
              (canEditBooking ? (g.bookingBloqueado 
                ? '<button onclick="agenda2EditarBookingGrupagem(' + g.id + ')" class="agenda2-btn-editar text-xs px-1 py-1 rounded">âœï¸</button>'
                : '<button onclick="agenda2GravarBookingGrupagem(' + g.id + ')" class="agenda2-btn-gravar text-xs px-1 py-1 rounded">ğŸ’¾</button>') 
              : '') +
            '</div>' +
          '</td>' +
          '<td class="text-center"><span class="text-xs bg-blue-100 text-blue-700 px-1 py-0.5 rounded">' + g.destino + '</span></td>' +
          '<td class="text-center">' + (g.enviadoPara ? '<span class="text-xs bg-purple-100 text-purple-700 px-1 py-0.5 rounded font-semibold">ğŸ“¤ ' + g.enviadoPara.replace('Agenda 3 ', '') + '</span>' : '<span class="text-xs text-amber-600 font-bold">âš ï¸ Por enviar</span>') + '</td>' +
          '<td class="text-center">' +
            '<button onclick="agenda2ToggleGrupagem(' + g.id + ')" class="agenda2-btn-expand text-xs bg-green-200 hover:bg-green-300 text-green-800 px-2 py-1 rounded font-bold">' + btnIcon + ' ' + g.reservas.length + '</button>' +
          '</td>' +
        '</tr>';
        
        if (isExpanded) {
          g.reservas.forEach(function(r, idx) {
            html += '<tr class="agenda2-row-reserva-grupagem agenda2-compact-row">' +
              '<td class="pl-8 text-slate-500 text-xs">' + (idx + 1) + '.</td>' +
              '<td colspan="2" class="font-semibold text-blue-700">' + r.numeroReserva + '</td>' +
              '<td colspan="2">' + r.cliente + '</td>' +
              '<td colspan="3">' + r.cidadeCarga + ' â†’ ' + r.cidadeDescarga + '</td>' +
              '<td class="text-right">' + r.ldm + '</td>' +
              '<td class="text-right">' + agenda2FormatNumber(r.peso) + '</td>' +
              '<td class="text-right">' + r.bultos + '</td>' +
              '<td class="text-right text-green-700">' + agenda2FormatCurrency(r.valor) + '</td>' +
              '<td colspan="7"></td>' +
            '</tr>';
          });
        }
        
        totaisGerais.ldm += totais.ldm;
        totaisGerais.peso += totais.peso;
        totaisGerais.bultos += totais.bultos;
        totaisGerais.valor += totais.valor;
        countItens++;
      });
      
      // Filtrar e ordenar cargas diretas
      var cdFiltradas = agenda2CargasDiretas.filter(function(cd) {
        if (filterTipo === 'grupagem') return false;
        if (filterIntermodal && cd.intermodal !== filterIntermodal) return false;
        if (filterEnviado === 'nao' && cd.enviadoPara) return false;
        if (filterEnviado === 'sim' && !cd.enviadoPara) return false;
        if (filterDataInicio && cd.dataCriacao < filterDataInicio) return false;
        if (filterDataFim && cd.dataCriacao > filterDataFim) return false;
        
        if (search) {
          var r = cd.reserva;
          var searchFields = [
            cd.intermodal, cd.fornecedor, cd.motorista, cd.matriculaTrator, cd.matriculaReboque,
            cd.booking, cd.destino, String(cd.numero), String(cd.km),
            r.numeroReserva, r.cliente, r.cidadeCarga, r.cidadeDescarga
          ].filter(Boolean).join(' ').toLowerCase();
          if (searchFields.indexOf(search) === -1) return false;
        }
        return true;
      });
      
      cdFiltradas = agenda2OrdenarDados(cdFiltradas, 'cargadireta');
      
      // Renderizar cargas diretas
      cdFiltradas.forEach(function(cd) {
        var r = cd.reserva;
        var canEditBooking = agenda2PodeEditarBooking(cd.intermodal);
        var bookingInputClass = canEditBooking && !cd.bookingBloqueado ? 'agenda2-booking-input-enabled' : 'agenda2-booking-input-disabled';
        var bookingDisabled = !canEditBooking || cd.bookingBloqueado ? 'disabled' : '';
        var isExpanded = agenda2ExpandedCDs[cd.id] || false;
        var btnIcon = isExpanded ? 'â–¼' : 'â–¶';
        var rowEnviadoClass = cd.enviadoPara ? 'agenda2-row-enviado' : 'agenda2-row-nao-enviado';
        var iconEnvio = cd.enviadoPara ? '' : 'âš ï¸ ';
        
        html += '<tr class="agenda2-row-group-header-cargadireta ' + rowEnviadoClass + '">' +
          '<td class="font-bold text-teal-800">' + iconEnvio + 'CD ' + cd.numero + '</td>' +
          '<td><span class="bg-teal-600 text-white text-xs px-2 py-0.5 rounded">CARGA DIRETA</span></td>' +
          '<td class="font-semibold">' + r.cidadeCarga + ' â†’ ' + r.cidadeDescarga + '</td>' +
          '<td><span class="' + (cd.intermodal === 'Navio' ? 'text-blue-600' : cd.intermodal === 'Comboio' ? 'text-purple-600' : '') + ' font-semibold">' + cd.intermodal + '</span></td>' +
          '<td>' + cd.fornecedor + '</td>' +
          '<td>ğŸ‘¤ ' + cd.motorista + '</td>' +
          '<td>ğŸš› ' + cd.matriculaTrator + '</td>' +
          '<td>ğŸš ' + cd.matriculaReboque + '</td>' +
          '<td class="text-right font-bold">' + r.ldm.toFixed(1) + '</td>' +
          '<td class="text-right font-bold">' + agenda2FormatNumber(r.peso) + '</td>' +
          '<td class="text-right font-bold">' + r.bultos + '</td>' +
          '<td class="text-right font-bold text-green-700">' + agenda2FormatCurrency(r.valor) + '</td>' +
          '<td class="text-right text-slate-400">-</td>' +
          '<td class="text-right font-bold">' + agenda2FormatNumber(cd.km) + '</td>' +
          '<td class="text-right font-bold text-amber-700">' + agenda2FormatCurrency(cd.valorKm) + '</td>' +
          '<td>' +
            '<div class="flex items-center gap-1">' +
              '<input type="text" id="agenda2-booking-cd-' + cd.id + '" value="' + (cd.booking || '') + '" ' +
                'class="text-xs px-2 py-1 rounded w-20 agenda2-input-nav ' + bookingInputClass + '" ' + bookingDisabled + ' ' +
                'onkeydown="agenda2NavegacaoTeclado(event)">' +
              (canEditBooking ? (cd.bookingBloqueado 
                ? '<button onclick="agenda2EditarBookingCD(' + cd.id + ')" class="agenda2-btn-editar text-xs px-1 py-1 rounded">âœï¸</button>'
                : '<button onclick="agenda2GravarBookingCD(' + cd.id + ')" class="agenda2-btn-gravar text-xs px-1 py-1 rounded">ğŸ’¾</button>') 
              : '') +
            '</div>' +
          '</td>' +
          '<td class="text-center"><span class="text-xs bg-blue-100 text-blue-700 px-1 py-0.5 rounded">' + cd.destino + '</span></td>' +
          '<td class="text-center">' + (cd.enviadoPara ? '<span class="text-xs bg-purple-100 text-purple-700 px-1 py-0.5 rounded font-semibold">ğŸ“¤ ' + cd.enviadoPara.replace('Agenda 3 ', '') + '</span>' : '<span class="text-xs text-amber-600 font-bold">âš ï¸ Por enviar</span>') + '</td>' +
          '<td class="text-center">' +
            '<button onclick="agenda2ToggleCD(' + cd.id + ')" class="agenda2-btn-expand text-xs bg-teal-200 hover:bg-teal-300 text-teal-800 px-2 py-1 rounded font-bold">' + btnIcon + ' 1</button>' +
          '</td>' +
        '</tr>';
        
        if (isExpanded) {
          html += '<tr class="agenda2-row-reserva-cd agenda2-compact-row">' +
            '<td class="pl-8 text-slate-500 text-xs">1.</td>' +
            '<td colspan="2" class="font-semibold text-blue-700">' + r.numeroReserva + '</td>' +
            '<td colspan="2">' + r.cliente + '</td>' +
            '<td colspan="3">' + r.cidadeCarga + ' â†’ ' + r.cidadeDescarga + '</td>' +
            '<td class="text-right">' + r.ldm + '</td>' +
            '<td class="text-right">' + agenda2FormatNumber(r.peso) + '</td>' +
            '<td class="text-right">' + r.bultos + '</td>' +
            '<td class="text-right text-green-700">' + agenda2FormatCurrency(r.valor) + '</td>' +
            '<td colspan="7"></td>' +
          '</tr>';
        }
        
        totaisGerais.ldm += r.ldm;
        totaisGerais.peso += r.peso;
        totaisGerais.bultos += r.bultos;
        totaisGerais.valor += r.valor;
        totaisGerais.km += cd.km;
        countItens++;
      });
      
      tbody.innerHTML = html;
      
      // Atualizar totais
      document.getElementById('agenda2TotalLDM').textContent = totaisGerais.ldm.toFixed(1);
      document.getElementById('agenda2TotalPeso').textContent = agenda2FormatNumber(totaisGerais.peso);
      document.getElementById('agenda2TotalBultos').textContent = totaisGerais.bultos;
      document.getElementById('agenda2TotalValor').textContent = agenda2FormatCurrency(totaisGerais.valor);
      document.getElementById('agenda2TotalEuroLDM').textContent = totaisGerais.ldm > 0 ? agenda2FormatCurrency(totaisGerais.valor / totaisGerais.ldm) : '0 â‚¬';
      document.getElementById('agenda2TotalKM').textContent = agenda2FormatNumber(totaisGerais.km);
      
      // Atualizar contadores
      var porEnviar = agenda2Grupagens.filter(function(g) { return !g.enviadoPara; }).length + agenda2CargasDiretas.filter(function(cd) { return !cd.enviadoPara; }).length;
      document.getElementById('agenda2CountDisplay').textContent = countItens + ' itens';
      document.getElementById('agenda2CountGrupagens').textContent = agenda2Grupagens.length;
      document.getElementById('agenda2CountDiretas').textContent = agenda2CargasDiretas.length;
      document.getElementById('agenda2CountNavio').textContent = agenda2Grupagens.filter(function(g) { return g.intermodal === 'Navio'; }).length + agenda2CargasDiretas.filter(function(cd) { return cd.intermodal === 'Navio'; }).length;
      document.getElementById('agenda2CountComboio').textContent = agenda2Grupagens.filter(function(g) { return g.intermodal === 'Comboio'; }).length + agenda2CargasDiretas.filter(function(cd) { return cd.intermodal === 'Comboio'; }).length;
      document.getElementById('agenda2CountPorEnviar').textContent = porEnviar;
      document.getElementById('agenda2NomeEquipa').textContent = AGENDA2_EQUIPA_ATUAL;
    }
    
    // Toggle Expandir/Colapsar
    function agenda2ToggleGrupagem(id) {
      agenda2ExpandedGrupagens[id] = !agenda2ExpandedGrupagens[id];
      agenda2RenderTable();
    }
    
    function agenda2ToggleCD(id) {
      agenda2ExpandedCDs[id] = !agenda2ExpandedCDs[id];
      agenda2RenderTable();
    }
    
    // Booking
    function agenda2GravarBookingGrupagem(id) {
      var g = agenda2Grupagens.find(function(x) { return x.id === id; });
      if (!g) return;
      var input = document.getElementById('agenda2-booking-g-' + id);
      var valor = input.value.trim();
      if (!valor) { alert('âš ï¸ Digite um valor para o Booking.'); return; }
      g.booking = valor;
      g.bookingBloqueado = true;
      agenda2RenderTable();
      alert('âœ… Booking gravado!');
    }
    
    function agenda2EditarBookingGrupagem(id) {
      var g = agenda2Grupagens.find(function(x) { return x.id === id; });
      if (!g) return;
      if (confirm('Deseja editar o Booking?')) {
        g.bookingBloqueado = false;
        agenda2RenderTable();
      }
    }
    
    function agenda2GravarBookingCD(id) {
      var cd = agenda2CargasDiretas.find(function(x) { return x.id === id; });
      if (!cd) return;
      var input = document.getElementById('agenda2-booking-cd-' + id);
      var valor = input.value.trim();
      if (!valor) { alert('âš ï¸ Digite um valor para o Booking.'); return; }
      cd.booking = valor;
      cd.bookingBloqueado = true;
      agenda2RenderTable();
      alert('âœ… Booking gravado!');
    }
    
    function agenda2EditarBookingCD(id) {
      var cd = agenda2CargasDiretas.find(function(x) { return x.id === id; });
      if (!cd) return;
      if (confirm('Deseja editar o Booking?')) {
        cd.bookingBloqueado = false;
        agenda2RenderTable();
      }
    }
    
    // Exportar Excel
    function agenda2ExportarExcel() {
      var dados = [];
      
      // CabeÃ§alhos
      dados.push(['NÂº', 'Tipo', 'Rota', 'Intermodal', 'Fornecedor', 'Motorista', 'Trator', 'Reboque', 'LDM', 'Peso', 'Bultos', 'Valor â‚¬', 'â‚¬/LDM', 'KM', 'â‚¬/KM', 'Booking', 'Destino', 'Enviado Para']);
      
      // Grupagens
      agenda2Grupagens.forEach(function(g) {
        var totais = agenda2CalcularTotaisGrupagem(g);
        dados.push([
          'Grupagem ' + g.numero, 'GRUPAGEM', g.tipoGrupagem, g.intermodal, g.fornecedor,
          g.motorista, g.matriculaTrator, g.matriculaReboque, totais.ldm, totais.peso,
          totais.bultos, totais.valor, totais.euroLdm.toFixed(2), '-', '-',
          g.booking, g.destino, g.enviadoPara || 'Por enviar'
        ]);
        
        g.reservas.forEach(function(r) {
          dados.push([
            '  â†’ ' + r.numeroReserva, '', r.cliente, '', '', '', '', '',
            r.ldm, r.peso, r.bultos, r.valor, '', '', '', '', r.cidadeCarga + ' â†’ ' + r.cidadeDescarga, ''
          ]);
        });
      });
      
      // Cargas Diretas
      agenda2CargasDiretas.forEach(function(cd) {
        var r = cd.reserva;
        dados.push([
          'CD ' + cd.numero, 'CARGA DIRETA', r.cidadeCarga + ' â†’ ' + r.cidadeDescarga, cd.intermodal,
          cd.fornecedor, cd.motorista, cd.matriculaTrator, cd.matriculaReboque,
          r.ldm, r.peso, r.bultos, r.valor, '-', cd.km, cd.valorKm.toFixed(2),
          cd.booking, cd.destino, cd.enviadoPara || 'Por enviar'
        ]);
      });
      
      // Criar workbook
      var ws = XLSX.utils.aoa_to_sheet(dados);
      var wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Agenda 2');
      
      ws['!cols'] = [
        {wch: 15}, {wch: 12}, {wch: 20}, {wch: 15}, {wch: 20},
        {wch: 15}, {wch: 10}, {wch: 10}, {wch: 8}, {wch: 8},
        {wch: 8}, {wch: 12}, {wch: 10}, {wch: 8}, {wch: 10},
        {wch: 15}, {wch: 15}, {wch: 20}
      ];
      
      var dataHora = new Date().toISOString().slice(0, 10);
      XLSX.writeFile(wb, 'Agenda2_' + AGENDA2_EQUIPA_ATUAL + '_' + dataHora + '.xlsx');
      
      alert('âœ… Ficheiro Excel exportado com sucesso!');
    }
    
    // Modal Agenda 3
    function agenda2AbrirAgenda3Modal() {
      var gDisponiveis = agenda2Grupagens;
      var cdDisponiveis = agenda2CargasDiretas;
      
      if (gDisponiveis.length === 0 && cdDisponiveis.length === 0) {
        alert('NÃ£o hÃ¡ itens para passar para a Agenda 3.');
        return;
      }
      
      var optsGrupagens = gDisponiveis.map(function(g) {
        var jaEnviado = g.enviadoPara ? ' âœ“ (' + g.enviadoPara.replace('Agenda 3 ', '') + ')' : ' âš ï¸';
        return '<option value="g-' + g.id + '">Grupagem ' + g.numero + ' - ' + g.tipoGrupagem + jaEnviado + '</option>';
      }).join('');
      
      var optsCargasDiretas = cdDisponiveis.map(function(cd) {
        var jaEnviado = cd.enviadoPara ? ' âœ“ (' + cd.enviadoPara.replace('Agenda 3 ', '') + ')' : ' âš ï¸';
        return '<option value="cd-' + cd.id + '">CD ' + cd.numero + ' - ' + cd.reserva.numeroReserva + jaEnviado + '</option>';
      }).join('');
      
      var optsEquipas = AGENDA2_EQUIPAS_DISPONIVEIS.map(function(e) {
        return '<option value="' + e + '"' + (e === AGENDA2_EQUIPA_ATUAL ? ' selected' : '') + '>Agenda 3 ' + e + '</option>';
      }).join('');
      
      agenda2ShowModal('â¡ Passar para Agenda 3', 
        '<div class="mb-4">' +
          '<label class="block text-sm font-semibold mb-1">Selecione o item a passar:</label>' +
          '<select id="agenda2MItem" class="w-full text-sm border rounded px-2 py-2 agenda2-input-nav" onchange="agenda2AtualizarPreviewReservas()" onkeydown="agenda2NavegacaoTeclado(event)">' +
            '<option value="">-- Selecione --</option>' +
            (optsGrupagens ? '<optgroup label="ğŸ“¦ Grupagens">' + optsGrupagens + '</optgroup>' : '') +
            (optsCargasDiretas ? '<optgroup label="ğŸš› Cargas Diretas">' + optsCargasDiretas + '</optgroup>' : '') +
          '</select>' +
        '</div>' +
        '<div id="agenda2PreviewReservas" class="mb-4"></div>' +
        '<div class="mb-4">' +
          '<label class="block text-sm font-semibold mb-1">Selecione a Agenda 3 de destino:</label>' +
          '<select id="agenda2MEquipaDestino" class="w-full text-sm border rounded px-2 py-2 agenda2-input-nav" onkeydown="agenda2NavegacaoTeclado(event)">' +
            optsEquipas +
          '</select>' +
        '</div>' +
        '<div class="bg-amber-50 border border-amber-200 rounded p-3 mb-4">' +
          '<p class="text-sm text-amber-800"><strong>âš ï¸ Nota:</strong> O item original permanece na Agenda 2. Uma <strong>cÃ³pia</strong> serÃ¡ enviada para a Agenda 3 selecionada.</p>' +
        '</div>' +
        '<div class="flex justify-end gap-2">' +
          '<button onclick="agenda2CloseModal()" class="px-4 py-2 text-sm bg-slate-200 rounded">Cancelar</button>' +
          '<button onclick="agenda2ConfirmarAgenda3()" class="px-4 py-2 text-sm bg-green-600 text-white rounded font-semibold">âœ“ Confirmar</button>' +
        '</div>', 'green');
    }
    
    function agenda2AtualizarPreviewReservas() {
      var item = document.getElementById('agenda2MItem').value;
      var container = document.getElementById('agenda2PreviewReservas');
      
      if (!item) { container.innerHTML = ''; return; }
      
      var parts = item.split('-');
      var tipo = parts[0];
      var itemId = parseInt(parts[1]);
      var html = '';
      
      if (tipo === 'g') {
        var g = agenda2Grupagens.find(function(x) { return x.id === itemId; });
        if (g) {
          var totais = agenda2CalcularTotaisGrupagem(g);
          var avisoReenvio = g.enviadoPara ? '<div class="bg-amber-100 border border-amber-300 rounded p-2 mb-2 text-sm text-amber-800"><strong>âš ï¸ AtenÃ§Ã£o:</strong> Esta grupagem jÃ¡ foi enviada para <strong>' + g.enviadoPara + '</strong>. Se confirmar, serÃ¡ reenviada para o novo destino.</div>' : '';
          html = '<div class="bg-green-50 border border-green-200 rounded p-3">' +
            avisoReenvio +
            '<div class="flex items-center gap-2 mb-2">' +
              '<span class="bg-green-600 text-white text-xs px-2 py-0.5 rounded">GRUPAGEM</span>' +
              '<span class="font-bold">' + g.tipoGrupagem + '</span>' +
              '<span class="text-slate-500">|</span>' +
              '<span>' + g.intermodal + '</span>' +
            '</div>' +
            '<div class="text-xs text-slate-600 mb-3">ğŸ‘¤ ' + g.motorista + ' | ğŸš› ' + g.matriculaTrator + ' | ğŸš ' + g.matriculaReboque + '</div>' +
            '<div class="text-sm font-semibold mb-2">ğŸ“‹ Reservas incluÃ­das (' + g.reservas.length + '):</div>' +
            '<div class="bg-white border rounded max-h-40 overflow-y-auto">' +
              '<table class="w-full text-xs">' +
                '<thead class="bg-slate-100 sticky top-0"><tr>' +
                  '<th class="p-1.5 text-left">Reserva</th><th class="p-1.5 text-left">Cliente</th>' +
                  '<th class="p-1.5 text-left">Rota</th><th class="p-1.5 text-right">LDM</th><th class="p-1.5 text-right">Valor</th>' +
                '</tr></thead>' +
                '<tbody>' + g.reservas.map(function(r) {
                  return '<tr class="border-b">' +
                    '<td class="p-1.5 font-semibold text-blue-700">' + r.numeroReserva + '</td>' +
                    '<td class="p-1.5">' + r.cliente + '</td>' +
                    '<td class="p-1.5">' + r.cidadeCarga + ' â†’ ' + r.cidadeDescarga + '</td>' +
                    '<td class="p-1.5 text-right">' + r.ldm + '</td>' +
                    '<td class="p-1.5 text-right text-green-700">' + agenda2FormatCurrency(r.valor) + '</td>' +
                  '</tr>';
                }).join('') + '</tbody>' +
              '</table>' +
            '</div>' +
            '<div class="mt-2 pt-2 border-t text-sm">' +
              '<span class="text-slate-600">Totais:</span>' +
              '<strong class="ml-2">LDM: ' + totais.ldm.toFixed(1) + '</strong>' +
              '<strong class="ml-3 text-green-700">Valor: ' + agenda2FormatCurrency(totais.valor) + '</strong>' +
            '</div>' +
          '</div>';
        }
      } else if (tipo === 'cd') {
        var cd = agenda2CargasDiretas.find(function(x) { return x.id === itemId; });
        if (cd) {
          var r = cd.reserva;
          var avisoReenvio = cd.enviadoPara ? '<div class="bg-amber-100 border border-amber-300 rounded p-2 mb-2 text-sm text-amber-800"><strong>âš ï¸ AtenÃ§Ã£o:</strong> Esta carga direta jÃ¡ foi enviada para <strong>' + cd.enviadoPara + '</strong>. Se confirmar, serÃ¡ reenviada para o novo destino.</div>' : '';
          html = '<div class="bg-teal-50 border border-teal-200 rounded p-3">' +
            avisoReenvio +
            '<div class="flex items-center gap-2 mb-2">' +
              '<span class="bg-teal-600 text-white text-xs px-2 py-0.5 rounded">CARGA DIRETA</span>' +
              '<span class="font-bold">' + r.cidadeCarga + ' â†’ ' + r.cidadeDescarga + '</span>' +
              '<span class="text-slate-500">|</span>' +
              '<span>' + cd.intermodal + '</span>' +
            '</div>' +
            '<div class="text-xs text-slate-600 mb-3">ğŸ‘¤ ' + cd.motorista + ' | ğŸš› ' + cd.matriculaTrator + ' | ğŸš ' + cd.matriculaReboque + ' | KM: ' + agenda2FormatNumber(cd.km) + '</div>' +
            '<div class="text-sm font-semibold mb-2">ğŸ“‹ Reserva incluÃ­da:</div>' +
            '<div class="bg-white border rounded p-2">' +
              '<div class="flex items-center justify-between">' +
                '<div><span class="font-semibold text-blue-700">' + r.numeroReserva + '</span> | ' + r.cliente + '</div>' +
                '<div class="text-right"><span class="text-slate-600">LDM: ' + r.ldm + '</span> <span class="ml-3 font-bold text-green-700">' + agenda2FormatCurrency(r.valor) + '</span></div>' +
              '</div>' +
            '</div>' +
          '</div>';
        }
      }
      container.innerHTML = html;
    }
    
    function agenda2ConfirmarAgenda3() {
      var item = document.getElementById('agenda2MItem').value;
      var equipaDestino = document.getElementById('agenda2MEquipaDestino').value;
      
      if (!item) { alert('Selecione um item para passar.'); return; }
      
      var parts = item.split('-');
      var tipo = parts[0];
      var itemId = parseInt(parts[1]);
      var nomeItem = '', reenvio = false;
      
      if (tipo === 'g') {
        var g = agenda2Grupagens.find(function(x) { return x.id === itemId; });
        if (g) {
          reenvio = g.enviadoPara !== null;
          g.passadoAgenda3 = true;
          g.enviadoPara = 'Agenda 3 ' + equipaDestino;
          nomeItem = 'Grupagem ' + g.numero;
        }
      } else if (tipo === 'cd') {
        var cd = agenda2CargasDiretas.find(function(x) { return x.id === itemId; });
        if (cd) {
          reenvio = cd.enviadoPara !== null;
          cd.passadoAgenda3 = true;
          cd.enviadoPara = 'Agenda 3 ' + equipaDestino;
          nomeItem = 'Carga Direta ' + cd.numero;
        }
      }
      
      agenda2CloseModal();
      agenda2RenderTable();
      
      alert(reenvio 
        ? 'âœ… ' + nomeItem + ' REENVIADA para Agenda 3 ' + equipaDestino + '!\n\nğŸ“Œ O destino foi atualizado.'
        : 'âœ… ' + nomeItem + ' copiada para Agenda 3 ' + equipaDestino + '!\n\nğŸ“Œ O original permanece aqui na Agenda 2.');
    }
    
    // Modal Agenda 2
    function agenda2ShowModal(title, content, color) {
      color = color || 'blue';
      var colors = { blue: 'bg-blue-600', green: 'bg-green-600', teal: 'bg-teal-600', red: 'bg-red-500', amber: 'bg-amber-600' };
      document.getElementById('agenda2ModalContainer').innerHTML = 
        '<div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 agenda2-modal-overlay">' +
          '<div class="bg-white rounded-lg shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-auto agenda2-modal-content">' +
            '<div class="' + colors[color] + ' text-white px-4 py-2 rounded-t-lg flex items-center justify-between sticky top-0">' +
              '<h2 class="font-bold">' + title + '</h2>' +
              '<button onclick="agenda2CloseModal()" class="text-white/80 hover:text-white text-xl">&times;</button>' +
            '</div>' +
            '<div class="p-4">' + content + '</div>' +
          '</div>' +
        '</div>';
    }
    
    function agenda2CloseModal() { 
      document.getElementById('agenda2ModalContainer').innerHTML = ''; 
    }
    
    // Dashboards Agenda 2
    function agenda2AtualizarDashboards() {
      var totalGrupagens = agenda2Grupagens.length;
      var totalCD = agenda2CargasDiretas.length;
      var totalNavio = agenda2Grupagens.filter(function(g) { return g.intermodal === 'Navio'; }).length + agenda2CargasDiretas.filter(function(cd) { return cd.intermodal === 'Navio'; }).length;
      var totalComboio = agenda2Grupagens.filter(function(g) { return g.intermodal === 'Comboio'; }).length + agenda2CargasDiretas.filter(function(cd) { return cd.intermodal === 'Comboio'; }).length;
      
      var valorTotalGrupagens = 0, ldmTotalGrupagens = 0;
      agenda2Grupagens.forEach(function(g) {
        var totais = agenda2CalcularTotaisGrupagem(g);
        valorTotalGrupagens += totais.valor;
        ldmTotalGrupagens += totais.ldm;
      });
      
      var valorTotalCD = 0;
      agenda2CargasDiretas.forEach(function(cd) { valorTotalCD += cd.reserva.valor; });
      
      var valorTotal = valorTotalGrupagens + valorTotalCD;
      var mediaLDM = ldmTotalGrupagens > 0 ? valorTotalGrupagens / ldmTotalGrupagens : 0;
      
      document.getElementById('agenda2DashTotalGrupagens').textContent = totalGrupagens;
      document.getElementById('agenda2DashTotalCD').textContent = totalCD;
      document.getElementById('agenda2DashTotalNavio').textContent = totalNavio;
      document.getElementById('agenda2DashTotalComboio').textContent = totalComboio;
      document.getElementById('agenda2DashValorTotal').textContent = agenda2FormatCurrency(valorTotal);
      document.getElementById('agenda2DashMediaLDM').textContent = agenda2FormatCurrency(mediaLDM);
      
      document.getElementById('agenda2DashCompGrupagens').innerHTML = '<span class="agenda2-comparison-up">â†‘ +2 vs perÃ­odo anterior</span>';
      document.getElementById('agenda2DashCompCD').innerHTML = '<span class="agenda2-comparison-down">â†“ -1 vs perÃ­odo anterior</span>';
      document.getElementById('agenda2DashCompValor').innerHTML = '<span class="agenda2-comparison-up">â†‘ +15% vs perÃ­odo anterior</span>';
      
      agenda2CriarGraficos();
      agenda2AtualizarTabelasAnalise();
    }
    
    function agenda2CriarGraficos() {
      Object.values(agenda2Charts).forEach(function(chart) { chart.destroy(); });
      agenda2Charts = {};
      
      // GrÃ¡fico Intermodal
      var intermodalData = {};
      agenda2Grupagens.forEach(function(g) { intermodalData[g.intermodal] = (intermodalData[g.intermodal] || 0) + 1; });
      agenda2CargasDiretas.forEach(function(cd) { intermodalData[cd.intermodal] = (intermodalData[cd.intermodal] || 0) + 1; });
      
      agenda2Charts.intermodal = new Chart(document.getElementById('agenda2ChartIntermodal'), {
        type: 'doughnut',
        data: {
          labels: Object.keys(intermodalData),
          datasets: [{ data: Object.values(intermodalData), backgroundColor: ['#10b981', '#3b82f6', '#8b5cf6', '#f59e0b'] }]
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
      });
      
      // GrÃ¡fico Rotas
      var rotasData = {};
      agenda2Grupagens.forEach(function(g) {
        var totais = agenda2CalcularTotaisGrupagem(g);
        rotasData[g.tipoGrupagem] = (rotasData[g.tipoGrupagem] || 0) + totais.valor;
      });
      
      agenda2Charts.rotas = new Chart(document.getElementById('agenda2ChartRotas'), {
        type: 'bar',
        data: {
          labels: Object.keys(rotasData),
          datasets: [{ label: 'Valor â‚¬', data: Object.values(rotasData), backgroundColor: '#10b981' }]
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
      });
      
      // GrÃ¡fico Tipos
      agenda2Charts.tipos = new Chart(document.getElementById('agenda2ChartTipos'), {
        type: 'pie',
        data: {
          labels: ['Grupagens', 'Cargas Diretas'],
          datasets: [{ data: [agenda2Grupagens.length, agenda2CargasDiretas.length], backgroundColor: ['#22c55e', '#14b8a6'] }]
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
      });
      
      // GrÃ¡fico Envio
      var enviados = agenda2Grupagens.filter(function(g) { return g.enviadoPara; }).length + agenda2CargasDiretas.filter(function(cd) { return cd.enviadoPara; }).length;
      var porEnviar = agenda2Grupagens.filter(function(g) { return !g.enviadoPara; }).length + agenda2CargasDiretas.filter(function(cd) { return !cd.enviadoPara; }).length;
      
      agenda2Charts.envio = new Chart(document.getElementById('agenda2ChartEnvio'), {
        type: 'doughnut',
        data: {
          labels: ['Enviados âœ“', 'Por Enviar âš ï¸'],
          datasets: [{ data: [enviados, porEnviar], backgroundColor: ['#10b981', '#f59e0b'] }]
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
      });
    }
    
    function agenda2AtualizarTabelasAnalise() {
      var rotasMap = {};
      agenda2Grupagens.forEach(function(g) {
        var rota = g.tipoGrupagem;
        if (!rotasMap[rota]) rotasMap[rota] = { qtd: 0, ldm: 0, valor: 0 };
        var totais = agenda2CalcularTotaisGrupagem(g);
        rotasMap[rota].qtd++;
        rotasMap[rota].ldm += totais.ldm;
        rotasMap[rota].valor += totais.valor;
      });
      
      var htmlRotas = '';
      Object.keys(rotasMap).forEach(function(rota) {
        var r = rotasMap[rota];
        var euroLdm = r.ldm > 0 ? r.valor / r.ldm : 0;
        htmlRotas += '<tr class="border-b hover:bg-slate-50">' +
          '<td class="p-2 font-semibold">' + rota + '</td>' +
          '<td class="p-2 text-right">' + r.qtd + '</td>' +
          '<td class="p-2 text-right">' + r.ldm.toFixed(1) + '</td>' +
          '<td class="p-2 text-right text-green-700 font-bold">' + agenda2FormatCurrency(r.valor) + '</td>' +
          '<td class="p-2 text-right text-amber-700 font-bold">' + agenda2FormatCurrency(euroLdm) + '</td>' +
        '</tr>';
      });
      document.getElementById('agenda2TbodyRotas').innerHTML = htmlRotas || '<tr><td colspan="5" class="p-4 text-center text-slate-500">Sem dados</td></tr>';
      
      var cdRotasMap = {};
      agenda2CargasDiretas.forEach(function(cd) {
        var rota = cd.reserva.cidadeCarga + ' â†’ ' + cd.reserva.cidadeDescarga;
        if (!cdRotasMap[rota]) cdRotasMap[rota] = { qtd: 0, km: 0, valor: 0 };
        cdRotasMap[rota].qtd++;
        cdRotasMap[rota].km += cd.km;
        cdRotasMap[rota].valor += cd.reserva.valor;
      });
      
      var htmlCDRotas = '';
      Object.keys(cdRotasMap).forEach(function(rota) {
        var r = cdRotasMap[rota];
        var euroKm = r.km > 0 ? r.valor / r.km : 0;
        htmlCDRotas += '<tr class="border-b hover:bg-slate-50">' +
          '<td class="p-2 font-semibold">' + rota + '</td>' +
          '<td class="p-2 text-right">' + r.qtd + '</td>' +
          '<td class="p-2 text-right">' + agenda2FormatNumber(r.km) + ' km</td>' +
          '<td class="p-2 text-right text-green-700 font-bold">' + agenda2FormatCurrency(r.valor) + '</td>' +
          '<td class="p-2 text-right text-amber-700 font-bold">' + agenda2FormatCurrency(euroKm) + '</td>' +
        '</tr>';
      });
      document.getElementById('agenda2TbodyCDRotas').innerHTML = htmlCDRotas || '<tr><td colspan="5" class="p-4 text-center text-slate-500">Sem dados</td></tr>';
    }
    
    // NavegaÃ§Ã£o por Teclado Agenda 2 (TODOS os campos)
    function agenda2NavegacaoTeclado(event) {
      var key = event.key;
      var currentInput = event.target;
      
      // Obter todos os inputs navegÃ¡veis da Agenda 2
      var allInputs = Array.from(document.querySelectorAll('#page-agenda2 .agenda2-input-nav:not([disabled]), #page-agenda2 input:not([disabled]), #page-agenda2 select:not([disabled])'));
      var currentIndex = allInputs.indexOf(currentInput);
      
      if (currentIndex === -1) return;
      
      var nextIndex = -1;
      
      // Enter ou Seta para baixo - prÃ³ximo input
      if (key === 'Enter' || key === 'ArrowDown') {
        nextIndex = currentIndex + 1;
        event.preventDefault();
      }
      
      // Seta para cima - input anterior
      if (key === 'ArrowUp') {
        nextIndex = currentIndex - 1;
        event.preventDefault();
      }
      
      // Seta para direita - prÃ³ximo input (em campos de texto)
      if (key === 'ArrowRight' && currentInput.tagName === 'SELECT') {
        nextIndex = currentIndex + 1;
        event.preventDefault();
      }
      
      // Seta para esquerda - input anterior (em campos de texto)
      if (key === 'ArrowLeft' && currentInput.tagName === 'SELECT') {
        nextIndex = currentIndex - 1;
        event.preventDefault();
      }
      
      // Navegar se vÃ¡lido
      if (nextIndex >= 0 && nextIndex < allInputs.length) {
        allInputs[nextIndex].focus();
        if (allInputs[nextIndex].select) allInputs[nextIndex].select();
      }
    }
    
    // InicializaÃ§Ã£o Agenda 2
    function inicializarAgenda2() {
      console.log('âœ… MÃ³dulo Agenda 2 v6 inicializado');
      agenda2InicializarDadosExemplo();
      agenda2RenderTable();
      
      var hoje = new Date();
      var inicioMes = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
      document.getElementById('agenda2DataInicio').value = inicioMes.toISOString().split('T')[0];
      document.getElementById('agenda2DataFim').value = hoje.toISOString().split('T')[0];
      
      // Zoom com Ctrl+scroll
      var agenda2Page = document.getElementById('page-agenda2');
      if (agenda2Page) {
        agenda2Page.addEventListener('wheel', function(e) {
          if (e.ctrlKey) {
            e.preventDefault();
            agenda2CurrentZoom = Math.min(200, Math.max(50, agenda2CurrentZoom + (e.deltaY > 0 ? -10 : 10)));
            var zoomContainer = document.getElementById('agenda2ZoomContainer');
            if (zoomContainer) zoomContainer.style.transform = 'scale(' + (agenda2CurrentZoom / 100) + ')';
            var zoomLevel = document.getElementById('agenda2ZoomLevel');
            if (zoomLevel) zoomLevel.textContent = agenda2CurrentZoom + '%';
          }
        }, { passive: false });
      }
      
      // Adicionar navegaÃ§Ã£o por teclado a todos os inputs
      document.querySelectorAll('#page-agenda2 input, #page-agenda2 select').forEach(function(input) {
        input.addEventListener('keydown', agenda2NavegacaoTeclado);
      });
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // AGENDA 3 - JAVASCRIPT PREFIXADO (Integrado v5.4)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    // Dados da Agenda 3
    var agenda3Dados = [
      { id: 1, numeroReserva: 'RES-001', comercial: 'JoÃ£o Silva', dataCarga: '15/01/2025', cliente: 'Empresa ABC Lda', ldm: 3.5, peso: 1200, quantidadeBultos: 15, cidadeCarga: 'Lisboa', codigoPostalCarga: 'PT-1000-001', codigoPostalDescarga: 'PT-4000-001', cidadeDescarga: 'Porto', ordenacao: 1, prioridade: 'Alta', dataEntrega: '17/01/2025', motoristaRecolha: 'Carlos Ferreira', tratorRecolha: 'YY-30-ZZ', reboqueRecolha: 'GG-33-HH', valorServico: 850, estadoEntrega: 'No Cliente', isComplementar: false, cmrCarga: true, cmrDescarga: false, distribuicaoId: 1, msgEnviada: true },
      { id: 2, numeroReserva: 'RES-002', comercial: 'Ana Santos', dataCarga: '16/01/2025', cliente: 'Transportes XYZ', ldm: 5, peso: 2500, quantidadeBultos: 30, cidadeCarga: 'Coimbra', codigoPostalCarga: 'PT-3000-001', codigoPostalDescarga: 'PT-1200-001', cidadeDescarga: 'Lisboa', ordenacao: 2, prioridade: 'Urgente', dataEntrega: '17/01/2025', motoristaRecolha: 'Francisco Alves', tratorRecolha: 'MN-70-OP', reboqueRecolha: 'QR-80-ST', valorServico: 1250, estadoEntrega: 'Em TrÃ¢nsito', isComplementar: false, cmrCarga: true, cmrDescarga: false, distribuicaoId: 1, msgEnviada: false },
      { id: 3, numeroReserva: 'RES-003', comercial: 'Pedro Oliveira', dataCarga: '14/01/2025', cliente: 'LogÃ­stica Norte SA', ldm: 2, peso: 800, quantidadeBultos: 8, cidadeCarga: 'Braga', codigoPostalCarga: 'PT-4700-001', codigoPostalDescarga: 'DE-80331', cidadeDescarga: 'Munique', ordenacao: 3, prioridade: 'Normal', dataEntrega: '16/01/2025', motoristaRecolha: 'Carlos Ferreira', tratorRecolha: 'EE-22-FF', reboqueRecolha: 'OP-45-QR', valorServico: 580, estadoEntrega: 'Entregue', isComplementar: false, cmrCarga: true, cmrDescarga: true, distribuicaoId: 1, msgEnviada: true },
      { id: 4, numeroReserva: 'RES-006', comercial: 'Ana Santos', dataCarga: '17/01/2025', cliente: 'Distribuidora Sul SA', ldm: 7.5, peso: 4100, quantidadeBultos: 55, cidadeCarga: 'Ã‰vora', codigoPostalCarga: 'PT-7000-001', codigoPostalDescarga: 'NL-1012', cidadeDescarga: 'AmesterdÃ£o', ordenacao: 1, prioridade: 'Urgente', dataEntrega: '18/01/2025', motoristaRecolha: 'Francisco Alves', tratorRecolha: 'CD-12-EF', reboqueRecolha: 'CC-11-DD', valorServico: 1680, estadoEntrega: 'Em TrÃ¢nsito', isComplementar: false, cmrCarga: false, cmrDescarga: false, distribuicaoId: 2, msgEnviada: false },
      { id: 5, numeroReserva: 'RES-005', comercial: 'JoÃ£o Silva', dataCarga: '19/01/2025', cliente: 'MetalÃºrgica Centro Lda', ldm: 4, peso: 1800, quantidadeBultos: 22, cidadeCarga: 'Aveiro', codigoPostalCarga: 'PT-3800-001', codigoPostalDescarga: 'FR-75001', cidadeDescarga: 'Paris', ordenacao: 2, prioridade: 'Normal', dataEntrega: '21/01/2025', motoristaRecolha: 'JosÃ© Rodrigues', tratorRecolha: 'EE-22-FF', reboqueRecolha: 'CC-11-DD', valorServico: 920, estadoEntrega: 'Em TrÃ¢nsito', isComplementar: false, cmrCarga: false, cmrDescarga: false, distribuicaoId: 2, msgEnviada: false },
      { id: 6, numeroReserva: 'RES-007', comercial: 'Pedro Oliveira', dataCarga: '20/01/2025', cliente: 'TÃªxteis Minho Lda', ldm: 2.8, peso: 950, quantidadeBultos: 12, cidadeCarga: 'GuimarÃ£es', codigoPostalCarga: 'PT-4800-001', codigoPostalDescarga: 'BE-1000', cidadeDescarga: 'Bruxelas', ordenacao: 3, prioridade: 'Baixa', dataEntrega: '23/01/2025', motoristaRecolha: 'Rui Martins', tratorRecolha: 'YY-30-ZZ', reboqueRecolha: 'QR-80-ST', valorServico: 520, estadoEntrega: 'Em TrÃ¢nsito', isComplementar: false, cmrCarga: false, cmrDescarga: false, distribuicaoId: 2, msgEnviada: false },
      { id: 7, numeroReserva: 'RES-010', comercial: 'Maria Fernandes', dataCarga: '18/01/2025', cliente: 'IndÃºstria Global SA', ldm: 6.2, peso: 3200, quantidadeBultos: 45, cidadeCarga: 'SetÃºbal', codigoPostalCarga: 'PT-2900-001', codigoPostalDescarga: 'ES-08001', cidadeDescarga: 'Barcelona', ordenacao: null, prioridade: 'Alta', dataEntrega: '20/01/2025', motoristaRecolha: 'Rui Martins', tratorRecolha: 'MN-70-OP', reboqueRecolha: 'CC-11-DD', valorServico: 1450, estadoEntrega: 'Em TrÃ¢nsito', isComplementar: false, cmrCarga: false, cmrDescarga: false, distribuicaoId: null, msgEnviada: false },
      { id: 8, numeroReserva: 'RES-COMP-001', comercial: 'JoÃ£o Silva', dataCarga: '17/01/2025', cliente: 'Complemento Express', ldm: 1.5, peso: 450, quantidadeBultos: 5, cidadeCarga: 'Lisboa', codigoPostalCarga: 'PT-1100-001', codigoPostalDescarga: 'PT-4000-001', cidadeDescarga: 'Porto', ordenacao: null, prioridade: 'Alta', dataEntrega: '17/01/2025', motoristaRecolha: '', tratorRecolha: '', reboqueRecolha: '', valorServico: 280, estadoEntrega: 'Em TrÃ¢nsito', isComplementar: true, cmrCarga: false, cmrDescarga: false, distribuicaoId: null, msgEnviada: false }
    ];

    var agenda3Distribuicoes = [
      { id: 1, numero: 1, estado: 'FECHADA', fornecedor: 'Transportes Silva Lda', multimodal: 'Rodovia Contratada', motorista: 'Carlos Ferreira', trator: 'AA-00-BB', reboque: 'CC-11-DD', booking: '', destino: 'ARMAZEM', armazem: 'ArmazÃ©m Holanda', ordemEnviada: false },
      { id: 2, numero: 2, estado: 'FECHADA', fornecedor: 'LogÃ­stica Express', multimodal: 'Navio', motorista: 'Francisco Alves', trator: 'EE-22-FF', reboque: 'GG-33-HH', booking: 'BK-2025-001', destino: 'DIRETO', armazem: null, ordemEnviada: false }
    ];

    // Dados GPS Fortcom - Frota de Tratores
    var agenda3FrotaTratores = [
      { matricula: 'AA-00-BB', modelo: 'Volvo FH16', distanciaKm: 12, horasDisponiveis: 8.5, motorista: 'Carlos Ferreira', localizacao: 'Lisboa' },
      { matricula: 'EE-22-FF', modelo: 'Scania R500', distanciaKm: 45, horasDisponiveis: 6.2, motorista: 'Francisco Alves', localizacao: 'Porto' },
      { matricula: 'MN-70-OP', modelo: 'Mercedes Actros', distanciaKm: 8, horasDisponiveis: 9.1, motorista: 'JosÃ© Rodrigues', localizacao: 'SetÃºbal' },
      { matricula: 'YY-30-ZZ', modelo: 'DAF XF', distanciaKm: 78, horasDisponiveis: 4.3, motorista: 'Rui Martins', localizacao: 'Coimbra' },
      { matricula: 'CD-12-EF', modelo: 'Iveco S-Way', distanciaKm: 23, horasDisponiveis: 7.8, motorista: 'Manuel Costa', localizacao: 'Braga' }
    ];
    
    var agenda3FrotaReboques = [
      { matricula: 'CC-11-DD', tipo: 'Cortinas', disponivel: true },
      { matricula: 'GG-33-HH', tipo: 'FrigorÃ­fico', disponivel: true },
      { matricula: 'QR-80-ST', tipo: 'Caixa', disponivel: false },
      { matricula: 'OP-45-QR', tipo: 'Cortinas', disponivel: true }
    ];

    var agenda3Selecionadas = new Set();
    var agenda3DistribuicaoSelecionada = null;
    var agenda3LinhasEmBranco = [];
    var agenda3CurrentZoom = 100;
    var agenda3SortColumn = null;
    var agenda3SortDirection = 'asc';
    var agenda3ReservasDevolvidas = [];
    var agenda3DraggedRow = null;
    var agenda3ContadorDistribuicao = 3;
    var agenda3DistribuicaoEmEdicao = null;
    var agenda3ModoSelecaoMatricula = 'frota';
    var agenda3OrdenacaoLinhasAsc = {};
    var agenda3ReservasSelecionadasParaGrupagem = [];
    var agenda3ArmazemPadraoEquipa = 'ArmazÃ©m Holanda';
    var agenda3ArmazensDisponiveis = [
      { id: 'holanda', nome: 'ArmazÃ©m Holanda' },
      { id: 'alemanha', nome: 'ArmazÃ©m Alemanha' },
      { id: 'franca', nome: 'ArmazÃ©m FranÃ§a' },
      { id: 'loureiro', nome: 'ArmazÃ©m Loureiro' }
    ];
    var agenda3AgendaArquivo = [];

    function agenda3FormatCurrency(value) {
      return parseFloat(value || 0).toLocaleString('pt-PT', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' â‚¬';
    }

    function agenda3GetEstadoClass(estado) {
      var classes = { 'Em TrÃ¢nsito': 'agenda3-estado-em-transito', 'No Cliente': 'agenda3-estado-no-cliente', 'Entregue': 'agenda3-estado-entregue' };
      return classes[estado] || 'agenda3-estado-em-transito';
    }

    function agenda3GetPrioridadeClass(prioridade) {
      var classes = { 'Baixa': 'bg-slate-100 text-slate-600', 'Normal': 'bg-green-100 text-green-700', 'Alta': 'bg-orange-100 text-orange-700', 'Urgente': 'bg-red-100 text-red-700' };
      return classes[prioridade] || 'bg-slate-100';
    }

    function agenda3ShowMessage(msg) {
      var toast = document.createElement('div');
      toast.className = 'fixed bottom-4 right-4 bg-slate-800 text-white px-4 py-3 rounded-lg shadow-lg z-[100] flex items-center gap-2';
      toast.innerHTML = '<span class="text-green-400 text-lg">âœ“</span> ' + msg;
      document.body.appendChild(toast);
      setTimeout(function() { toast.remove(); }, 3000);
    }

    function agenda3RenderDistribuicoes() {
      var container = document.getElementById('agenda3ListaDistribuicoes');
      var html = '';
      agenda3Distribuicoes.forEach(function(d) {
        var isSelected = agenda3DistribuicaoSelecionada === d.id;
        var reservaCount = agenda3Dados.filter(function(r) { return r.distribuicaoId === d.id; }).length;
        var isFechada = d.estado === 'FECHADA';
        var bgClass = isFechada ? 'bg-green-100 border-green-500 text-green-800' : 'bg-amber-100 border-amber-500 text-amber-800';
        html += '<button onclick="agenda3SelecionarDistribuicao(' + d.id + ')" class="agenda3-dist-btn text-xs px-3 py-1.5 rounded border-2 ' + bgClass + ' ' + (isSelected ? 'ring-4 ring-red-500 ring-offset-1' : '') + ' hover:opacity-80 flex items-center gap-2"><span class="font-bold">#' + d.numero + '</span><span class="text-[10px] uppercase">' + d.estado + '</span><span class="bg-white/50 px-1.5 rounded text-[10px]">' + reservaCount + '</span>' + (d.ordemEnviada ? '<span class="text-blue-600">âœ“ ENV</span>' : '') + '</button>';
      });
      container.innerHTML = html;
      document.getElementById('agenda3CountDistribuicoes').textContent = agenda3Distribuicoes.length;
    }

    function agenda3SelecionarDistribuicao(id) {
      agenda3DistribuicaoSelecionada = (agenda3DistribuicaoSelecionada === id) ? null : id;
      agenda3RenderDistribuicoes();
      agenda3RenderTable();
      agenda3ValidarEnvio();
    }

    function agenda3RenderTable() {
      var tbody = document.getElementById('agenda3TableBody');
      var filterEstado = document.getElementById('agenda3FilterEstado').value;
      var filterPrioridade = document.getElementById('agenda3FilterPrioridade').value;
      var filterComplementar = document.getElementById('agenda3FilterComplementar').checked;
      var searchTerm = document.getElementById('agenda3SearchInput').value.toLowerCase();

      var dadosFiltrados = agenda3Dados.filter(function(r) {
        if (filterEstado && r.estadoEntrega !== filterEstado) return false;
        if (filterPrioridade && r.prioridade !== filterPrioridade) return false;
        if (filterComplementar && !r.isComplementar) return false;
        if (searchTerm) {
          var searchFields = [r.numeroReserva, r.cliente, r.comercial, r.cidadeCarga, r.cidadeDescarga].join(' ').toLowerCase();
          if (!searchFields.includes(searchTerm)) return false;
        }
        return true;
      });

      var html = '';
      var totalLDM = 0, totalPeso = 0, totalBultos = 0, totalValorComplementar = 0;

      // Renderizar distribuiÃ§Ãµes
      agenda3Distribuicoes.forEach(function(dist) {
        var reservasDist = dadosFiltrados.filter(function(r) { return r.distribuicaoId === dist.id; });
        if (reservasDist.length === 0) return;
        
        var isSelected = agenda3DistribuicaoSelecionada === dist.id;
        var isFechada = dist.estado === 'FECHADA';
        var headerClass = isFechada ? 'agenda3-row-group-header-fechada' : 'agenda3-row-group-header-aberta';
        var estadoIcon = isFechada ? 'ğŸ”’' : 'ğŸ”“';
        var estadoBadgeClass = isFechada ? 'bg-green-500' : 'bg-amber-500';
        
        var destinoInfo = '';
        if (dist.destino === 'ARMAZEM' && dist.armazem) {
          destinoInfo = '<span class="agenda3-badge-destino agenda3-badge-armazem">ğŸ­ ' + dist.armazem + '</span>';
        } else if (dist.destino === 'DIRETO') {
          destinoInfo = '<span class="agenda3-badge-destino agenda3-badge-direto">ğŸšš Direto aos Clientes</span>';
        }
        
        html += '<tr class="' + headerClass + ' ' + (isSelected ? 'ring-4 ring-red-500' : '') + '" onclick="agenda3SelecionarDistribuicao(' + dist.id + ')" style="cursor:pointer;"><td colspan="25" class="text-slate-800"><div class="flex items-center justify-between"><div class="flex items-center gap-3"><span class="text-purple-700 font-bold">' + estadoIcon + ' DistribuiÃ§Ã£o #' + dist.numero + '</span><span class="' + estadoBadgeClass + ' text-white px-2 py-0.5 rounded text-[10px] font-bold">' + dist.estado + '</span>' + (dist.multimodal ? '<span>| ' + dist.multimodal + '</span>' : '') + (dist.fornecedor ? '<span>| Forn: ' + dist.fornecedor + '</span>' : '') + (dist.motorista ? '<span>| ğŸ‘¤ ' + dist.motorista + '</span>' : '') + (dist.trator ? '<span>| ğŸš› ' + dist.trator + '</span>' : '') + (dist.reboque ? '<span>| ğŸš ' + dist.reboque + '</span>' : '') + (dist.booking ? '<span>| ğŸ“‹ <strong>Booking: ' + dist.booking + '</strong></span>' : '') + '</div><div class="flex items-center gap-2">' + (dist.armazemEnviado ? '<span class="bg-blue-600 text-white px-3 py-1 rounded text-sm font-bold">ğŸ­ ' + dist.armazemEnviado + '</span>' : '') + destinoInfo + (dist.ordemEnviada ? '<span class="bg-blue-500 text-white px-2 py-0.5 rounded text-[10px] font-bold ml-2">âœ“ ENVIADA</span><span class="text-xs text-slate-500 ml-1">' + (dist.dataEnvio || '') + '</span>' : '') + '<button onclick="event.stopPropagation(); agenda3AbrirModalEditar(' + dist.id + ')" class="bg-purple-600 hover:bg-purple-700 text-white px-2 py-0.5 rounded text-[10px] font-bold ml-2">âœï¸ Editar</button></div></div></td></tr>';

        reservasDist.forEach(function(r) {
          html += agenda3RenderReservaRow(r, !isFechada);
          totalLDM += parseFloat(r.ldm) || 0;
          totalPeso += parseFloat(r.peso) || 0;
          totalBultos += parseInt(r.quantidadeBultos) || 0;
          if (r.isComplementar) totalValorComplementar += parseFloat(r.valorServico) || 0;
        });

        var grupoLDM = reservasDist.reduce(function(s, r) { return s + (parseFloat(r.ldm) || 0); }, 0);
        var grupoBultos = reservasDist.reduce(function(s, r) { return s + (parseInt(r.quantidadeBultos) || 0); }, 0);
        var grupoValorComp = reservasDist.filter(function(r) { return r.isComplementar; }).reduce(function(s, r) { return s + (parseFloat(r.valorServico) || 0); }, 0);
        
        html += '<tr class="agenda3-row-sum"><td colspan="10" class="text-right text-xs font-bold">TOTAIS #' + dist.numero + ':</td><td class="text-right text-xs font-bold">' + grupoLDM.toFixed(1) + '</td><td></td><td class="text-right text-xs font-bold">' + grupoBultos + '</td><td colspan="4"></td><td class="text-center"><button onclick="agenda3OrdenarLinhasGrupo(' + dist.id + ')" class="text-[10px] bg-blue-600 hover:bg-blue-700 text-white px-2 py-0.5 rounded font-bold">Ordenar Linhas</button></td><td colspan="5"></td><td class="text-right text-xs font-bold text-green-700">' + agenda3FormatCurrency(grupoValorComp) + '</td><td></td></tr>';
      });

      // Reservas soltas
      var reservasSoltas = dadosFiltrados.filter(function(r) { return !r.distribuicaoId; });
      if (reservasSoltas.length > 0) {
        reservasSoltas.forEach(function(r, idx) {
          html += agenda3RenderReservaRow(r, true);
          totalLDM += parseFloat(r.ldm) || 0;
          totalPeso += parseFloat(r.peso) || 0;
          totalBultos += parseInt(r.quantidadeBultos) || 0;
          if (r.isComplementar) totalValorComplementar += parseFloat(r.valorServico) || 0;
          
          var linhaEmBranco = agenda3LinhasEmBranco.find(function(lb) { return lb.afterId === r.id; });
          if (linhaEmBranco) {
            var grpLDM = reservasSoltas.slice(0, idx + 1).reduce(function(s, x) { return s + (parseFloat(x.ldm) || 0); }, 0);
            var grpBultos = reservasSoltas.slice(0, idx + 1).reduce(function(s, x) { return s + (parseInt(x.quantidadeBultos) || 0); }, 0);
            var grpValorComp = reservasSoltas.slice(0, idx + 1).filter(function(x) { return x.isComplementar; }).reduce(function(s, x) { return s + (parseFloat(x.valorServico) || 0); }, 0);
            
            html += '<tr class="agenda3-row-sum"><td colspan="10" class="text-right text-xs font-bold">SUBTOTAL:</td><td class="text-right text-xs font-bold">' + grpLDM.toFixed(1) + '</td><td></td><td class="text-right text-xs font-bold">' + grpBultos + '</td><td colspan="4"></td><td class="text-center"><button onclick="agenda3OrdenarLinhasSoltas()" class="text-[10px] bg-blue-600 hover:bg-blue-700 text-white px-2 py-0.5 rounded font-bold">Ordenar Linhas</button></td><td colspan="5"></td><td class="text-right text-xs font-bold text-green-700">' + agenda3FormatCurrency(grpValorComp) + '</td><td></td></tr>';
            
            for (var i = 1; i < linhaEmBranco.count; i++) {
              html += '<tr class="agenda3-row-blank"><td colspan="25"></td></tr>';
            }
          }
        });
      }

      tbody.innerHTML = html;
      document.getElementById('agenda3CountDisplay').textContent = dadosFiltrados.length + ' reservas';
      document.getElementById('agenda3CountReservas').textContent = agenda3Dados.length;
      document.getElementById('agenda3TotalLDM').textContent = totalLDM.toFixed(1);
      document.getElementById('agenda3TotalPeso').textContent = totalPeso;
      document.getElementById('agenda3TotalBultos').textContent = totalBultos;
      document.getElementById('agenda3TotalValorComplementar').textContent = agenda3FormatCurrency(totalValorComplementar);
      agenda3UpdateSelectedCount();
    }

    function agenda3RenderReservaRow(r, podeSelecionar) {
      var isSelected = agenda3Selecionadas.has(r.id);
      var rowClass = isSelected ? 'agenda3-row-selected' : (r.isComplementar ? 'agenda3-row-complementar' : 'agenda3-row-normal');
      var valorClass = r.isComplementar ? 'agenda3-valor-complementar' : 'agenda3-valor-indicativo';
      
      var cmrDescargaHTML = r.cmrDescarga 
        ? '<span class="text-green-600 font-bold cursor-pointer" title="CMR Descarga confirmado">âœ“</span>' 
        : '<span class="text-slate-300 cursor-pointer hover:text-green-400" onclick="event.stopPropagation(); agenda3MarcarCMRDescarga(' + r.id + ')" title="Clique para marcar CMR Descarga">â—‹</span>';
      
      return '<tr class="agenda3-compact-row border-b border-slate-200 hover:bg-slate-50 ' + rowClass + '" data-id="' + r.id + '" draggable="true" ondragstart="agenda3HandleDragStart(event, ' + r.id + ')" ondragover="agenda3HandleDragOver(event)" ondragleave="agenda3HandleDragLeave(event)" ondrop="agenda3HandleDrop(event, ' + r.id + ')" ondragend="agenda3HandleDragEnd(event)"><td class="text-center"><input type="checkbox" class="agenda3-custom-checkbox" ' + (isSelected ? 'checked' : '') + ' ' + (podeSelecionar ? '' : 'disabled') + ' onchange="agenda3ToggleSelect(' + r.id + ')" onclick="event.stopPropagation()"></td><td class="text-center agenda3-drag-handle" title="Arraste para reordenar">â ¿</td><td><span class="agenda3-reserva-link text-blue-600 font-semibold" onclick="agenda3AbrirReserva(' + r.id + ')">' + r.numeroReserva + '</span></td><td class="text-center">' + (r.msgEnviada ? '<span class="text-green-600">âœ‰</span>' : '') + '</td><td class="text-center">' + (r.isComplementar ? '<span class="bg-green-500 text-white px-1 rounded text-[10px] font-bold">COMP</span>' : '') + '</td><td class="truncate">' + r.comercial + '</td><td>' + r.dataCarga + '</td><td class="truncate font-medium">' + r.cliente + '</td><td class="text-center">' + (r.cmrCarga ? '<span class="text-green-600 font-bold">âœ“</span>' : '<span class="text-slate-300">â—‹</span>') + '</td><td class="text-center">' + cmrDescargaHTML + '</td><td class="text-right font-medium">' + r.ldm + '</td><td class="text-right">' + r.peso + '</td><td class="text-right">' + r.quantidadeBultos + '</td><td class="truncate">' + r.cidadeCarga + '</td><td>' + r.codigoPostalCarga + '</td><td>' + r.codigoPostalDescarga + '</td><td class="truncate">' + r.cidadeDescarga + '</td><td class="text-center"><input type="text" inputmode="numeric" pattern="[0-9]*" value="' + (r.ordenacao || '') + '" class="agenda3-ordenacao-input" data-id="' + r.id + '" onchange="agenda3UpdateOrdenacao(' + r.id + ', this.value)" onkeydown="agenda3HandleOrdenacaoKeydown(event, ' + r.id + ')" onclick="event.stopPropagation(); this.select()"></td><td class="text-center"><span class="px-1.5 py-0.5 rounded text-[10px] font-semibold ' + agenda3GetPrioridadeClass(r.prioridade) + '">' + r.prioridade + '</span></td><td>' + r.dataEntrega + '</td><td class="agenda3-col-entrega truncate">' + (r.motoristaRecolha || '-') + '</td><td class="agenda3-col-entrega">' + (r.tratorRecolha || '-') + '</td><td class="agenda3-col-entrega">' + (r.reboqueRecolha || '-') + '</td><td class="text-right ' + valorClass + '">' + agenda3FormatCurrency(r.valorServico) + '</td><td class="text-center"><select class="text-[10px] px-1 py-0.5 rounded font-bold ' + agenda3GetEstadoClass(r.estadoEntrega) + '" onchange="agenda3UpdateEstado(' + r.id + ', this.value)" onclick="event.stopPropagation()"><option value="Em TrÃ¢nsito"' + (r.estadoEntrega === 'Em TrÃ¢nsito' ? ' selected' : '') + '>Em TrÃ¢nsito</option><option value="No Cliente"' + (r.estadoEntrega === 'No Cliente' ? ' selected' : '') + '>No Cliente</option><option value="Entregue"' + (r.estadoEntrega === 'Entregue' ? ' selected' : '') + '>Entregue</option></select></td></tr>';
    }
    
    function agenda3MarcarCMRDescarga(id) {
      var r = agenda3Dados.find(function(d) { return d.id === id; });
      if (!r) return;
      
      if (confirm('Marcar CMR Descarga para ' + r.numeroReserva + '?\n\nA linha serÃ¡ arquivada em 10 segundos (modo teste).')) {
        r.cmrDescarga = true;
        r.dataCMRDescarga = new Date();
        r.timerArquivoIniciado = true;
        agenda3RenderTable();
        agenda3ShowMessage('CMR Descarga marcado! Linha serÃ¡ arquivada em 10 segundos...');
        
        var TEMPO_ARQUIVO = 10000;
        
        setTimeout(function() {
          agenda3ArquivarReserva(id);
        }, TEMPO_ARQUIVO);
      }
    }
    
    function agenda3ArquivarReserva(id) {
      var r = agenda3Dados.find(function(d) { return d.id === id; });
      if (!r) return;
      
      agenda3CarregarAgendaArquivo();
      
      var dist = agenda3Distribuicoes.find(function(d) { return d.id === r.distribuicaoId; });
      var grupagemEnviada = dist && dist.ordemEnviada;
      
      if (grupagemEnviada) {
        var grupagemNoArquivo = agenda3AgendaArquivo.find(function(a) {
          return a.tipo === 'grupagem_enviada' && a.distribuicao && a.distribuicao.id === dist.id;
        });
        
        if (grupagemNoArquivo) {
          var reservaNoArquivo = grupagemNoArquivo.reservas.find(function(res) { return res.id === r.id || res.numeroReserva === r.numeroReserva; });
          if (reservaNoArquivo) {
            reservaNoArquivo.cmrDescarga = true;
            reservaNoArquivo.dataCMRDescarga = new Date().toLocaleString('pt-PT');
          }
          agenda3GuardarAgendaArquivo();
          console.log('âœ… CMR Descarga atualizado na grupagem #' + dist.numero);
        }
      }
      
      agenda3Dados = agenda3Dados.filter(function(d) { return d.id !== id; });
      
      if (dist) {
        var reservasRestantes = agenda3Dados.filter(function(d) { return d.distribuicaoId === dist.id; });
        if (reservasRestantes.length === 0) {
          agenda3Distribuicoes = agenda3Distribuicoes.filter(function(d) { return d.id !== dist.id; });
          if (agenda3DistribuicaoSelecionada === dist.id) {
            agenda3DistribuicaoSelecionada = null;
          }
          agenda3ShowMessage('âœ… Grupagem #' + dist.numero + ' totalmente arquivada!');
        }
      }
      
      agenda3RenderTable();
      agenda3RenderDistribuicoes();
      agenda3ShowMessage('Reserva ' + r.numeroReserva + ' arquivada!');
    }

    // DRAG AND DROP
    function agenda3HandleDragStart(e, id) {
      agenda3DraggedRow = id;
      e.target.classList.add('agenda3-dragging');
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/plain', id);
    }
    
    function agenda3HandleDragOver(e) {
      e.preventDefault();
      var row = e.target.closest('tr');
      if (row && row.dataset.id) {
        row.classList.add('agenda3-drag-over');
      }
    }
    
    function agenda3HandleDragLeave(e) {
      var row = e.target.closest('tr');
      if (row) {
        row.classList.remove('agenda3-drag-over');
      }
    }
    
    function agenda3HandleDrop(e, targetId) {
      e.preventDefault();
      var row = e.target.closest('tr');
      if (row) row.classList.remove('agenda3-drag-over');
      
      if (agenda3DraggedRow === targetId) return;
      
      var draggedIndex = agenda3Dados.findIndex(function(d) { return d.id === agenda3DraggedRow; });
      var targetIndex = agenda3Dados.findIndex(function(d) { return d.id === targetId; });
      
      if (draggedIndex === -1 || targetIndex === -1) return;
      
      var removed = agenda3Dados.splice(draggedIndex, 1)[0];
      agenda3Dados.splice(targetIndex, 0, removed);
      
      agenda3RenderTable();
      agenda3ShowMessage('Linha movida!');
    }
    
    function agenda3HandleDragEnd(e) {
      e.target.classList.remove('agenda3-dragging');
      document.querySelectorAll('.agenda3-drag-over').forEach(function(el) { el.classList.remove('agenda3-drag-over'); });
      agenda3DraggedRow = null;
    }

    function agenda3OrdenarLinhasGrupo(distId) {
      var reservasDist = agenda3Dados.filter(function(r) { return r.distribuicaoId === distId; });
      var asc = agenda3OrdenacaoLinhasAsc[distId] !== false;
      reservasDist.sort(function(a, b) {
        var ordA = a.ordenacao || 9999;
        var ordB = b.ordenacao || 9999;
        return asc ? ordA - ordB : ordB - ordA;
      });
      var outrasReservas = agenda3Dados.filter(function(r) { return r.distribuicaoId !== distId; });
      agenda3Dados = outrasReservas.concat(reservasDist);
      agenda3OrdenacaoLinhasAsc[distId] = !asc;
      agenda3RenderTable();
      agenda3ShowMessage('Linhas ordenadas ' + (asc ? '1â†’9' : '9â†’1'));
    }
    
    function agenda3OrdenarLinhasSoltas() {
      var reservasSoltas = agenda3Dados.filter(function(r) { return !r.distribuicaoId; });
      var outrasReservas = agenda3Dados.filter(function(r) { return r.distribuicaoId; });
      var asc = agenda3OrdenacaoLinhasAsc['soltas'] !== false;
      reservasSoltas.sort(function(a, b) {
        var ordA = a.ordenacao || 9999;
        var ordB = b.ordenacao || 9999;
        return asc ? ordA - ordB : ordB - ordA;
      });
      agenda3Dados = outrasReservas.concat(reservasSoltas);
      agenda3OrdenacaoLinhasAsc['soltas'] = !asc;
      agenda3RenderTable();
      agenda3ShowMessage('Linhas ordenadas ' + (asc ? '1â†’9' : '9â†’1'));
    }

    function agenda3ToggleSelect(id) {
      var r = agenda3Dados.find(function(d) { return d.id === id; });
      if (!r) return;
      var dist = r.distribuicaoId ? agenda3Distribuicoes.find(function(d) { return d.id === r.distribuicaoId; }) : null;
      if (dist && dist.estado === 'FECHADA') return;
      agenda3Selecionadas.has(id) ? agenda3Selecionadas.delete(id) : agenda3Selecionadas.add(id);
      agenda3RenderTable();
    }
    
    function agenda3ToggleAll(cb) {
      if (cb.checked) {
        agenda3Dados.forEach(function(r) {
          var dist = r.distribuicaoId ? agenda3Distribuicoes.find(function(d) { return d.id === r.distribuicaoId; }) : null;
          if (!dist || dist.estado !== 'FECHADA') agenda3Selecionadas.add(r.id);
        });
      } else {
        agenda3Selecionadas.clear();
      }
      agenda3RenderTable();
    }
    
    function agenda3SelectAll() {
      agenda3Dados.forEach(function(r) {
        var dist = r.distribuicaoId ? agenda3Distribuicoes.find(function(d) { return d.id === r.distribuicaoId; }) : null;
        if (!dist || dist.estado !== 'FECHADA') agenda3Selecionadas.add(r.id);
      });
      agenda3RenderTable();
    }
    
    function agenda3DeselectAll() { agenda3Selecionadas.clear(); agenda3RenderTable(); }
    
    function agenda3UpdateSelectedCount() {
      var el = document.getElementById('agenda3SelectedCount');
      if (agenda3Selecionadas.size > 0) { el.textContent = agenda3Selecionadas.size + ' selecionadas'; el.classList.remove('hidden'); }
      else { el.classList.add('hidden'); }
    }

    function agenda3UpdateOrdenacao(id, valor) { 
      var r = agenda3Dados.find(function(d) { return d.id === id; }); 
      if (r) {
        var num = valor.replace(/[^0-9]/g, '');
        r.ordenacao = num ? parseInt(num) : null;
      }
      agenda3ValidarEnvio(); 
    }
    
    // NAVEGAÃ‡ÃƒO POR TECLADO - Enter e Setas
    function agenda3HandleOrdenacaoKeydown(event, id) {
      var input = event.target;
      var allInputs = Array.from(document.querySelectorAll('#page-agenda3 .agenda3-ordenacao-input'));
      var currentIndex = allInputs.indexOf(input);
      
      if (event.key.length === 1 && !/[0-9]/.test(event.key)) {
        event.preventDefault();
        return;
      }
      
      if (event.key === 'Enter' || event.key === 'ArrowDown') {
        event.preventDefault();
        if (currentIndex < allInputs.length - 1) {
          allInputs[currentIndex + 1].focus();
          allInputs[currentIndex + 1].select();
        }
      } else if (event.key === 'ArrowUp') {
        event.preventDefault();
        if (currentIndex > 0) {
          allInputs[currentIndex - 1].focus();
          allInputs[currentIndex - 1].select();
        }
      }
    }
    
    function agenda3UpdateEstado(id, estado) { 
      var r = agenda3Dados.find(function(d) { return d.id === id; }); 
      if (r) r.estadoEntrega = estado; 
      agenda3RenderTable(); 
    }

    function agenda3InserirLinhaEmBranco() {
      var ultimaId = null;
      if (agenda3Selecionadas.size > 0) {
        var reservasSoltas = agenda3Dados.filter(function(r) { return !r.distribuicaoId; });
        reservasSoltas.forEach(function(r) { if (agenda3Selecionadas.has(r.id)) ultimaId = r.id; });
      } else {
        var reservasSoltas = agenda3Dados.filter(function(r) { return !r.distribuicaoId; });
        if (reservasSoltas.length > 0) ultimaId = reservasSoltas[reservasSoltas.length - 1].id;
      }
      if (!ultimaId) { agenda3ShowMessage('Sem reservas soltas'); return; }
      var existente = agenda3LinhasEmBranco.find(function(lb) { return lb.afterId === ultimaId; });
      if (existente) { existente.count++; agenda3ShowMessage('Linha cinza adicionada'); }
      else { agenda3LinhasEmBranco.push({ afterId: ultimaId, count: 1 }); agenda3ShowMessage('Linha de subtotais inserida'); }
      agenda3RenderTable();
    }
    
    function agenda3RemoverLinhasEmBranco() { agenda3LinhasEmBranco = []; agenda3RenderTable(); agenda3ShowMessage('Linhas removidas'); }

    function agenda3AbrirGrupagem() {
      if (!agenda3DistribuicaoSelecionada) { alert('âš ï¸ Selecione uma grupagem.'); return; }
      var d = agenda3Distribuicoes.find(function(x) { return x.id === agenda3DistribuicaoSelecionada; });
      if (!d || d.estado !== 'FECHADA') { alert('â„¹ï¸ Grupagem jÃ¡ estÃ¡ aberta.'); return; }
      
      if (d.ordemEnviada) {
        agenda3LimparGrupagemDoArquivo(d.id);
        agenda3ShowMessage('âš ï¸ Grupagem removida do arquivo para re-ediÃ§Ã£o');
      }
      
      agenda3Dados.forEach(function(r) { if (r.distribuicaoId === d.id) { r.distribuicaoId = null; r.ordenacao = null; } });
      agenda3Distribuicoes = agenda3Distribuicoes.filter(function(x) { return x.id !== d.id; });
      agenda3DistribuicaoSelecionada = null;
      agenda3RenderDistribuicoes();
      agenda3RenderTable();
      agenda3ShowMessage('Grupagem aberta!');
    }

    function agenda3CriarGrupagem() {
      if (agenda3Selecionadas.size === 0) { alert('âš ï¸ Selecione reservas.'); return; }
      agenda3ReservasSelecionadasParaGrupagem = Array.from(agenda3Selecionadas);
      agenda3AbrirModalNovaGrupagem();
    }

    function agenda3AbrirModalNovaGrupagem() {
      var novoNumero = agenda3ContadorDistribuicao;
      
      var tratoresOrdenados = agenda3FrotaTratores.slice().sort(function(a, b) { return a.distanciaKm - b.distanciaKm; });
      
      var tratoresGPSHTML = '<option value="">-- Selecione --</option>';
      tratoresOrdenados.forEach(function(t, idx) {
        var isMaisPerto = idx === 0;
        tratoresGPSHTML += '<option value="' + t.matricula + '" data-motorista="' + t.motorista + '">' + t.matricula + ' | ' + t.distanciaKm + ' km | ' + t.horasDisponiveis + 'h disp. | ' + t.motorista + (isMaisPerto ? ' â­ MAIS PERTO' : '') + '</option>';
      });
      
      var tratoresListaHTML = '<option value="">-- Selecione --</option>';
      agenda3FrotaTratores.forEach(function(t) {
        tratoresListaHTML += '<option value="' + t.matricula + '">' + t.matricula + ' - ' + t.modelo + '</option>';
      });
      
      var reboquesHTML = '<option value="">-- Selecione --</option>';
      agenda3FrotaReboques.forEach(function(r) {
        reboquesHTML += '<option value="' + r.matricula + '">' + r.matricula + ' - ' + r.tipo + (r.disponivel ? ' âœ“' : ' (IndisponÃ­vel)') + '</option>';
      });
      
      document.getElementById('agenda3ModalTitle').textContent = 'ğŸ“¦ Nova Grupagem #' + novoNumero;
      document.getElementById('agenda3ModalBody').innerHTML = 
        '<div class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded"><p class="text-xs text-blue-700 font-semibold">ğŸ“¡ Dados GPS Fortcom atualizados em tempo real</p></div>' +
        '<div class="grid grid-cols-2 gap-4">' +
        '<div><label class="block text-sm font-bold mb-1" id="agenda3LabelFornecedor">Fornecedor <span class="text-red-500">*</span></label><select id="agenda3EditFornecedor" class="w-full border-2 border-slate-300 rounded px-2 py-1.5 text-sm"><option value="">-- Selecione --</option><option value="Transportes Silva Lda">Transportes Silva Lda</option><option value="LogÃ­stica Express">LogÃ­stica Express</option><option value="TransEuropa">TransEuropa</option></select></div>' +
        '<div><label class="block text-sm font-bold mb-1">Multimodal <span class="text-red-500">*</span></label><select id="agenda3EditMultimodal" class="w-full border-2 border-slate-300 rounded px-2 py-1.5 text-sm" onchange="agenda3OnMultimodalChangeNovo()"><option value="">-- Selecione --</option><option value="Navio">Navio</option><option value="Comboio">Comboio</option><option value="Rodovia PrÃ³pria">Rodovia PrÃ³pria</option><option value="Rodovia Contratada">Rodovia Contratada</option></select></div>' +
        '<div><label class="block text-sm font-bold mb-1">Motorista <span class="text-red-500">*</span></label><select id="agenda3EditMotorista" class="w-full border-2 border-slate-300 rounded px-2 py-1.5 text-sm"><option value="">-- Selecione --</option><option value="Carlos Ferreira">Carlos Ferreira</option><option value="Francisco Alves">Francisco Alves</option><option value="Manuel Costa">Manuel Costa</option><option value="JosÃ© Rodrigues">JosÃ© Rodrigues</option><option value="Rui Martins">Rui Martins</option></select></div>' +
        '<div><label class="block text-sm font-bold mb-1">Booking</label><input type="text" id="agenda3EditBooking" class="w-full border-2 border-slate-300 rounded px-2 py-1.5 text-sm" placeholder="CÃ³digo booking..."></div></div>' +
        '<div id="agenda3SecaoFrotaPropria" class="mt-4"><div class="p-3 bg-green-50 border border-green-200 rounded"><div class="flex items-center justify-between mb-2"><p class="text-xs text-green-700 font-bold">ğŸš› FROTA PRÃ“PRIA</p><div class="flex items-center gap-2"><button type="button" onclick="agenda3AlternarModoMatricula(\'gps\')" id="agenda3BtnModoGPS" class="px-2 py-1 text-xs rounded bg-green-600 text-white font-semibold">ğŸ“¡ GPS Fortcom</button><button type="button" onclick="agenda3AlternarModoMatricula(\'lista\')" id="agenda3BtnModoLista" class="px-2 py-1 text-xs rounded bg-slate-200 text-slate-600 font-semibold">ğŸ“‹ Lista Manual</button></div></div><p id="agenda3InfoModoMatricula" class="text-[10px] text-green-600">Ordenados por proximidade (dados GPS em tempo real)</p></div><div class="grid grid-cols-2 gap-4 mt-2"><div id="agenda3ContainerTratorGPS"><label class="block text-sm font-bold mb-1">MatrÃ­cula Trator <span class="text-red-500">*</span></label><select id="agenda3EditTrator" class="w-full border-2 border-slate-300 rounded px-2 py-1.5 text-sm" onchange="agenda3OnTratorChange()">' + tratoresGPSHTML + '</select><div id="agenda3InfoTrator" class="mt-1 p-2 bg-slate-100 rounded text-xs hidden"></div></div><div id="agenda3ContainerTratorLista" class="hidden"><label class="block text-sm font-bold mb-1">MatrÃ­cula Trator <span class="text-red-500">*</span></label><select id="agenda3EditTratorLista" class="w-full border-2 border-slate-300 rounded px-2 py-1.5 text-sm">' + tratoresListaHTML + '</select></div><div><label class="block text-sm font-bold mb-1">MatrÃ­cula Reboque <span class="text-red-500">*</span></label><select id="agenda3EditReboque" class="w-full border-2 border-slate-300 rounded px-2 py-1.5 text-sm">' + reboquesHTML + '</select></div></div></div>' +
        '<div id="agenda3SecaoRodoviaContratada" class="mt-4 hidden"><div class="p-3 bg-amber-50 border border-amber-200 rounded"><p class="text-xs text-amber-700 font-bold mb-2">ğŸšš RODOVIA CONTRATADA - VeÃ­culo Externo</p><p class="text-[10px] text-amber-600">Insira a matrÃ­cula do veÃ­culo contratado manualmente</p></div><div class="grid grid-cols-2 gap-4 mt-2"><div><label class="block text-sm font-bold mb-1">MatrÃ­cula Trator <span class="text-red-500">*</span></label><input type="text" id="agenda3EditTratorManual" class="w-full border-2 border-amber-300 rounded px-2 py-1.5 text-sm font-mono uppercase" placeholder="XX-00-XX" maxlength="10"></div><div><label class="block text-sm font-bold mb-1">MatrÃ­cula Reboque <span class="text-red-500">*</span></label><input type="text" id="agenda3EditReboqueManual" class="w-full border-2 border-amber-300 rounded px-2 py-1.5 text-sm font-mono uppercase" placeholder="XX-00-XX" maxlength="10"></div></div></div>' +
        '<div class="grid grid-cols-2 gap-4 mt-4"><div><label class="block text-sm font-bold mb-1">Destino <span class="text-red-500">*</span></label><select id="agenda3EditDestino" class="w-full border-2 border-slate-300 rounded px-2 py-1.5 text-sm" onchange="agenda3OnDestinoChange()"><option value="">-- Selecione --</option><option value="ARMAZEM">ArmazÃ©m</option><option value="DIRETO">Direto aos Clientes</option></select></div><div id="agenda3ArmazemContainer" class="hidden"><label class="block text-sm font-bold mb-1">ArmazÃ©m Destino <span class="text-red-500">*</span></label><select id="agenda3EditArmazem" class="w-full border-2 border-slate-300 rounded px-2 py-1.5 text-sm"><option value="">-- Selecione --</option><option value="ArmazÃ©m Holanda">ArmazÃ©m Holanda</option><option value="ArmazÃ©m Alemanha">ArmazÃ©m Alemanha</option><option value="ArmazÃ©m FranÃ§a">ArmazÃ©m FranÃ§a</option></select></div></div>' +
        '<div class="flex justify-end gap-2 mt-6"><button onclick="agenda3CancelarNovaGrupagem()" class="px-4 py-2 bg-slate-200 hover:bg-slate-300 rounded text-sm">Cancelar</button><button onclick="agenda3GravarNovaGrupagem()" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded text-sm font-bold">ğŸ’¾ Gravar</button></div>';
      document.getElementById('agenda3Modal').classList.remove('hidden');
    }
    
    function agenda3AlternarModoMatricula(modo) {
      var btnGPS = document.getElementById('agenda3BtnModoGPS');
      var btnLista = document.getElementById('agenda3BtnModoLista');
      var containerGPS = document.getElementById('agenda3ContainerTratorGPS');
      var containerLista = document.getElementById('agenda3ContainerTratorLista');
      var infoModo = document.getElementById('agenda3InfoModoMatricula');
      
      if (modo === 'gps') {
        btnGPS.className = 'px-2 py-1 text-xs rounded bg-green-600 text-white font-semibold';
        btnLista.className = 'px-2 py-1 text-xs rounded bg-slate-200 text-slate-600 font-semibold';
        containerGPS.classList.remove('hidden');
        containerLista.classList.add('hidden');
        infoModo.textContent = 'Ordenados por proximidade (dados GPS em tempo real)';
        agenda3ModoSelecaoMatricula = 'gps';
      } else {
        btnGPS.className = 'px-2 py-1 text-xs rounded bg-slate-200 text-slate-600 font-semibold';
        btnLista.className = 'px-2 py-1 text-xs rounded bg-green-600 text-white font-semibold';
        containerGPS.classList.add('hidden');
        containerLista.classList.remove('hidden');
        infoModo.textContent = 'Lista da GestÃ£o de Frota (sem dados GPS)';
        agenda3ModoSelecaoMatricula = 'lista';
      }
    }
    
    function agenda3OnMultimodalChangeNovo() {
      var multimodal = document.getElementById('agenda3EditMultimodal').value;
      var labelFornecedor = document.getElementById('agenda3LabelFornecedor');
      var secaoFrotaPropria = document.getElementById('agenda3SecaoFrotaPropria');
      var secaoRodoviaContratada = document.getElementById('agenda3SecaoRodoviaContratada');
      
      if (multimodal === 'Rodovia PrÃ³pria') {
        labelFornecedor.innerHTML = 'Fornecedor <span class="text-slate-400 text-xs">(opcional)</span>';
        secaoFrotaPropria.classList.remove('hidden');
        secaoRodoviaContratada.classList.add('hidden');
      } else if (multimodal === 'Rodovia Contratada') {
        labelFornecedor.innerHTML = 'Fornecedor <span class="text-red-500">*</span>';
        secaoFrotaPropria.classList.add('hidden');
        secaoRodoviaContratada.classList.remove('hidden');
      } else {
        labelFornecedor.innerHTML = 'Fornecedor <span class="text-red-500">*</span>';
        secaoFrotaPropria.classList.remove('hidden');
        secaoRodoviaContratada.classList.add('hidden');
      }
    }
    
    function agenda3OnTratorChange() {
      var matricula = document.getElementById('agenda3EditTrator').value;
      var infoDiv = document.getElementById('agenda3InfoTrator');
      var motoristaSelect = document.getElementById('agenda3EditMotorista');
      
      if (!matricula) { infoDiv.classList.add('hidden'); return; }
      
      var trator = agenda3FrotaTratores.find(function(t) { return t.matricula === matricula; });
      if (trator) {
        infoDiv.innerHTML = '<div class="grid grid-cols-3 gap-2"><div><span class="text-slate-500">ğŸ“ DistÃ¢ncia:</span><br><strong class="text-blue-600">' + trator.distanciaKm + ' km</strong></div><div><span class="text-slate-500">â±ï¸ Horas disp.:</span><br><strong class="text-green-600">' + trator.horasDisponiveis + 'h</strong></div><div><span class="text-slate-500">ğŸ‘¤ Motorista:</span><br><strong>' + trator.motorista + '</strong></div></div>';
        infoDiv.classList.remove('hidden');
        motoristaSelect.value = trator.motorista;
      }
    }

    function agenda3OnDestinoChange() {
      var destino = document.getElementById('agenda3EditDestino').value;
      var container = document.getElementById('agenda3ArmazemContainer');
      if (container) container.classList.toggle('hidden', destino !== 'ARMAZEM');
    }

    function agenda3CancelarNovaGrupagem() {
      agenda3ReservasSelecionadasParaGrupagem = [];
      agenda3FecharModal();
    }

    function agenda3GravarNovaGrupagem() {
      var multimodal = document.getElementById('agenda3EditMultimodal').value;
      var motorista = document.getElementById('agenda3EditMotorista').value;
      var destino = document.getElementById('agenda3EditDestino').value;
      var fornecedor = document.getElementById('agenda3EditFornecedor').value;
      var booking = document.getElementById('agenda3EditBooking').value;
      var armazemEl = document.getElementById('agenda3EditArmazem');
      var armazem = armazemEl ? armazemEl.value : null;
      
      var trator, reboque;
      
      if (multimodal === 'Rodovia Contratada') {
        trator = document.getElementById('agenda3EditTratorManual').value.trim().toUpperCase();
        reboque = document.getElementById('agenda3EditReboqueManual').value.trim().toUpperCase();
      } else if (agenda3ModoSelecaoMatricula === 'lista') {
        trator = document.getElementById('agenda3EditTratorLista').value;
        reboque = document.getElementById('agenda3EditReboque').value;
      } else {
        trator = document.getElementById('agenda3EditTrator').value;
        reboque = document.getElementById('agenda3EditReboque').value;
      }
      
      var fornecedorObrigatorio = multimodal !== 'Rodovia PrÃ³pria';
      if (!multimodal) { alert('âš ï¸ Selecione o Multimodal.'); return; }
      if (fornecedorObrigatorio && !fornecedor) { alert('âš ï¸ Selecione o Fornecedor.'); return; }
      if (!motorista) { alert('âš ï¸ Selecione o Motorista.'); return; }
      if (!trator) { alert('âš ï¸ Preencha a MatrÃ­cula do Trator.'); return; }
      if (!reboque) { alert('âš ï¸ Preencha a MatrÃ­cula do Reboque.'); return; }
      if (!destino) { alert('âš ï¸ Selecione o Destino.'); return; }
      if (destino === 'ARMAZEM' && !armazem) { alert('âš ï¸ Selecione o ArmazÃ©m.'); return; }

      var novoId = Date.now();
      var novoNumero = agenda3ContadorDistribuicao++;
      
      agenda3Distribuicoes.push({
        id: novoId, numero: novoNumero, estado: 'ABERTA', fornecedor: fornecedor, multimodal: multimodal,
        motorista: motorista, trator: trator, reboque: reboque, booking: booking, destino: destino,
        armazem: armazem, ordemEnviada: false
      });
      
      var ord = 1;
      agenda3ReservasSelecionadasParaGrupagem.forEach(function(id) {
        var r = agenda3Dados.find(function(d) { return d.id === id; });
        if (r) { r.distribuicaoId = novoId; r.ordenacao = ord++; }
      });
      
      agenda3Selecionadas.clear();
      agenda3ReservasSelecionadasParaGrupagem = [];
      agenda3DistribuicaoSelecionada = novoId;
      
      agenda3FecharModal();
      agenda3RenderDistribuicoes();
      agenda3RenderTable();
      agenda3ValidarEnvio();
      agenda3ShowMessage('Grupagem #' + novoNumero + ' criada!');
    }

    function agenda3FecharGrupagem() {
      var distAberta = agenda3Distribuicoes.find(function(d) { return d.estado === 'ABERTA'; });
      if (!distAberta) { alert('âš ï¸ NÃ£o existe grupagem aberta.'); return; }
      
      var reservasDist = agenda3Dados.filter(function(r) { return r.distribuicaoId === distAberta.id; });
      if (reservasDist.length === 0) { alert('âš ï¸ Grupagem sem reservas.'); return; }
      
      var todasComOrdenacao = reservasDist.every(function(r) { return r.ordenacao && r.ordenacao > 0; });
      if (!todasComOrdenacao) { alert('âš ï¸ Preencha ordenaÃ§Ã£o em todas as linhas.'); return; }
      
      distAberta.estado = 'FECHADA';
      agenda3DistribuicaoSelecionada = distAberta.id;
      agenda3RenderDistribuicoes();
      agenda3RenderTable();
      agenda3ValidarEnvio();
      agenda3ShowMessage('Grupagem fechada!');
    }

    function agenda3AbrirModalEditar(id) {
      var d = agenda3Distribuicoes.find(function(x) { return x.id === id; });
      if (!d) return;
      agenda3DistribuicaoEmEdicao = id;
      var fornecedorLabel = d.multimodal === 'Rodovia PrÃ³pria' ? 'Fornecedor <span class="text-slate-400 text-xs">(opcional)</span>' : 'Fornecedor <span class="text-red-500">*</span>';
      document.getElementById('agenda3ModalTitle').textContent = 'âœï¸ Editar DistribuiÃ§Ã£o #' + d.numero;
      document.getElementById('agenda3ModalBody').innerHTML = '<div class="grid grid-cols-2 gap-4"><div><label class="block text-sm font-bold mb-1" id="agenda3LabelFornecedor">' + fornecedorLabel + '</label><select id="agenda3EditFornecedor" class="w-full border-2 border-slate-300 rounded px-2 py-1.5 text-sm"><option value="">-- Selecione --</option><option value="Transportes Silva Lda"' + (d.fornecedor === 'Transportes Silva Lda' ? ' selected' : '') + '>Transportes Silva Lda</option><option value="LogÃ­stica Express"' + (d.fornecedor === 'LogÃ­stica Express' ? ' selected' : '') + '>LogÃ­stica Express</option><option value="TransEuropa"' + (d.fornecedor === 'TransEuropa' ? ' selected' : '') + '>TransEuropa</option></select></div><div><label class="block text-sm font-bold mb-1">Multimodal <span class="text-red-500">*</span></label><select id="agenda3EditMultimodal" class="w-full border-2 border-slate-300 rounded px-2 py-1.5 text-sm" onchange="agenda3OnMultimodalChange()"><option value="">-- Selecione --</option><option value="Navio"' + (d.multimodal === 'Navio' ? ' selected' : '') + '>Navio</option><option value="Comboio"' + (d.multimodal === 'Comboio' ? ' selected' : '') + '>Comboio</option><option value="Rodovia PrÃ³pria"' + (d.multimodal === 'Rodovia PrÃ³pria' ? ' selected' : '') + '>Rodovia PrÃ³pria</option><option value="Rodovia Contratada"' + (d.multimodal === 'Rodovia Contratada' ? ' selected' : '') + '>Rodovia Contratada</option></select></div><div><label class="block text-sm font-bold mb-1">Motorista <span class="text-red-500">*</span></label><select id="agenda3EditMotorista" class="w-full border-2 border-slate-300 rounded px-2 py-1.5 text-sm"><option value="">-- Selecione --</option><option value="Carlos Ferreira"' + (d.motorista === 'Carlos Ferreira' ? ' selected' : '') + '>Carlos Ferreira</option><option value="Francisco Alves"' + (d.motorista === 'Francisco Alves' ? ' selected' : '') + '>Francisco Alves</option><option value="Manuel Costa"' + (d.motorista === 'Manuel Costa' ? ' selected' : '') + '>Manuel Costa</option><option value="JosÃ© Rodrigues"' + (d.motorista === 'JosÃ© Rodrigues' ? ' selected' : '') + '>JosÃ© Rodrigues</option><option value="Rui Martins"' + (d.motorista === 'Rui Martins' ? ' selected' : '') + '>Rui Martins</option></select></div><div><label class="block text-sm font-bold mb-1">MatrÃ­cula Trator <span class="text-red-500">*</span></label><select id="agenda3EditTrator" class="w-full border-2 border-slate-300 rounded px-2 py-1.5 text-sm"><option value="">-- Selecione --</option>' + agenda3FrotaTratores.map(function(t) { return '<option value="' + t.matricula + '"' + (d.trator === t.matricula ? ' selected' : '') + '>' + t.matricula + '</option>'; }).join('') + '</select></div><div><label class="block text-sm font-bold mb-1">MatrÃ­cula Reboque <span class="text-red-500">*</span></label><select id="agenda3EditReboque" class="w-full border-2 border-slate-300 rounded px-2 py-1.5 text-sm"><option value="">-- Selecione --</option>' + agenda3FrotaReboques.map(function(r) { return '<option value="' + r.matricula + '"' + (d.reboque === r.matricula ? ' selected' : '') + '>' + r.matricula + '</option>'; }).join('') + '</select></div><div><label class="block text-sm font-bold mb-1">Booking</label><input type="text" id="agenda3EditBooking" value="' + (d.booking || '') + '" class="w-full border-2 border-slate-300 rounded px-2 py-1.5 text-sm"></div><div><label class="block text-sm font-bold mb-1">Destino <span class="text-red-500">*</span></label><select id="agenda3EditDestino" class="w-full border-2 border-slate-300 rounded px-2 py-1.5 text-sm" onchange="agenda3OnDestinoChange()"><option value="">-- Selecione --</option><option value="ARMAZEM"' + (d.destino === 'ARMAZEM' ? ' selected' : '') + '>ArmazÃ©m</option><option value="DIRETO"' + (d.destino === 'DIRETO' ? ' selected' : '') + '>Direto aos Clientes</option></select></div><div id="agenda3ArmazemContainer" class="' + (d.destino === 'ARMAZEM' ? '' : 'hidden') + '"><label class="block text-sm font-bold mb-1">ArmazÃ©m Destino <span class="text-red-500">*</span></label><select id="agenda3EditArmazem" class="w-full border-2 border-slate-300 rounded px-2 py-1.5 text-sm"><option value="">-- Selecione --</option><option value="ArmazÃ©m Holanda"' + (d.armazem === 'ArmazÃ©m Holanda' ? ' selected' : '') + '>ArmazÃ©m Holanda</option><option value="ArmazÃ©m Alemanha"' + (d.armazem === 'ArmazÃ©m Alemanha' ? ' selected' : '') + '>ArmazÃ©m Alemanha</option><option value="ArmazÃ©m FranÃ§a"' + (d.armazem === 'ArmazÃ©m FranÃ§a' ? ' selected' : '') + '>ArmazÃ©m FranÃ§a</option></select></div></div><div class="flex justify-end gap-2 mt-4"><button onclick="agenda3FecharModal()" class="px-4 py-2 bg-slate-200 hover:bg-slate-300 rounded text-sm">Cancelar</button><button onclick="agenda3GravarDistribuicao()" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded text-sm font-bold">ğŸ’¾ Gravar</button></div>';
      document.getElementById('agenda3Modal').classList.remove('hidden');
    }

    function agenda3OnMultimodalChange() {
      var multimodal = document.getElementById('agenda3EditMultimodal').value;
      var labelFornecedor = document.getElementById('agenda3LabelFornecedor');
      if (multimodal === 'Rodovia PrÃ³pria') {
        labelFornecedor.innerHTML = 'Fornecedor <span class="text-slate-400 text-xs">(opcional)</span>';
      } else {
        labelFornecedor.innerHTML = 'Fornecedor <span class="text-red-500">*</span>';
      }
    }

    function agenda3GravarDistribuicao() {
      if (!agenda3DistribuicaoEmEdicao) return;
      var d = agenda3Distribuicoes.find(function(x) { return x.id === agenda3DistribuicaoEmEdicao; });
      if (!d) return;
      d.fornecedor = document.getElementById('agenda3EditFornecedor').value;
      d.multimodal = document.getElementById('agenda3EditMultimodal').value;
      d.motorista = document.getElementById('agenda3EditMotorista').value;
      d.trator = document.getElementById('agenda3EditTrator').value;
      d.reboque = document.getElementById('agenda3EditReboque').value;
      d.booking = document.getElementById('agenda3EditBooking').value;
      d.destino = document.getElementById('agenda3EditDestino').value;
      var armazemEl = document.getElementById('agenda3EditArmazem');
      d.armazem = armazemEl ? armazemEl.value : null;
      agenda3FecharModal();
      agenda3RenderDistribuicoes();
      agenda3RenderTable();
      agenda3ValidarEnvio();
      agenda3ShowMessage('DistribuiÃ§Ã£o gravada!');
    }

    function agenda3FecharModal() {
      document.getElementById('agenda3Modal').classList.add('hidden');
      agenda3DistribuicaoEmEdicao = null;
    }

    function agenda3ValidarEnvio() {
      var btn = document.getElementById('agenda3BtnEnviarOrdem');
      var temGrupagemFechada = agenda3Distribuicoes.some(function(d) { return d.estado === 'FECHADA'; });
      if (temGrupagemFechada) { 
        btn.disabled = false; 
        btn.classList.remove('agenda3-btn-disabled'); 
      } else { 
        btn.disabled = true; 
        btn.classList.add('agenda3-btn-disabled'); 
      }
    }

    // LOCALSTORAGE - SincronizaÃ§Ã£o com Agenda Arquivo
    function agenda3CarregarAgendaArquivo() {
      var dados = localStorage.getItem('agendaArquivo');
      if (dados) {
        try {
          var parsed = JSON.parse(dados);
          agenda3AgendaArquivo = parsed.registos || [];
        } catch (e) {
          console.error('Erro ao carregar Agenda Arquivo:', e);
          agenda3AgendaArquivo = [];
        }
      }
    }
    
    function agenda3GuardarAgendaArquivo() {
      var dadosParaGuardar = {
        registos: agenda3AgendaArquivo,
        ultimaAtualizacao: new Date().toISOString()
      };
      try {
        localStorage.setItem('agendaArquivo', JSON.stringify(dadosParaGuardar));
        console.log('âœ… Agenda Arquivo guardada no localStorage:', agenda3AgendaArquivo.length, 'registos');
      } catch (e) {
        console.error('âŒ Erro ao guardar no localStorage:', e);
        alert('âŒ Erro ao guardar dados: ' + e.message);
      }
    }
    
    function agenda3LimparGrupagemDoArquivo(distId) {
      var indexGrupagem = agenda3AgendaArquivo.findIndex(function(a) {
        return a.tipo === 'grupagem_enviada' && a.distribuicao && a.distribuicao.id === distId;
      });
      
      if (indexGrupagem >= 0) {
        agenda3AgendaArquivo.splice(indexGrupagem, 1);
        agenda3GuardarAgendaArquivo();
        console.log('ğŸ—‘ï¸ Grupagem removida do arquivo (re-aberta)');
      }
    }
    
    function agenda3LimparReservaDoArquivo(reservaId, numeroReserva) {
      var indexReserva = agenda3AgendaArquivo.findIndex(function(a) {
        return (a.tipo === 'reserva' && a.reserva && a.reserva.id === reservaId) ||
               (a.tipo === 'devolucao' && a.numeroReserva === numeroReserva);
      });
      
      if (indexReserva >= 0) {
        agenda3AgendaArquivo.splice(indexReserva, 1);
        agenda3GuardarAgendaArquivo();
        console.log('ğŸ—‘ï¸ Reserva/DevoluÃ§Ã£o removida do arquivo (revertida)');
      }
    }

    function agenda3EnviarOrdemArmazem() {
      var grupagensFechadas = agenda3Distribuicoes.filter(function(d) { return d.estado === 'FECHADA'; });
      
      if (grupagensFechadas.length === 0) {
        alert('âš ï¸ NÃ£o existem grupagens fechadas para enviar.');
        return;
      }
      
      var armazensOrdenados = agenda3ArmazensDisponiveis.slice().sort(function(a, b) {
        if (a.nome === agenda3ArmazemPadraoEquipa) return -1;
        if (b.nome === agenda3ArmazemPadraoEquipa) return 1;
        return 0;
      });
      
      var grupagemHTML = '';
      grupagensFechadas.forEach(function(d, index) {
        var reservasDist = agenda3Dados.filter(function(r) { return r.distribuicaoId === d.id; });
        var totalReservas = reservasDist.length;
        var destinoFinal = d.destino === 'ARMAZEM' ? d.armazem : 'Direto aos Clientes';
        var badgeClass = d.destino === 'ARMAZEM' ? 'bg-amber-500 text-white' : 'bg-green-500 text-white';
        var isFirst = index === 0;
        
        grupagemHTML += '<div class="border-2 ' + (isFirst ? 'border-green-500 bg-green-50' : 'border-slate-300 bg-white') + ' rounded-lg p-3 mb-2 hover:border-green-400 hover:bg-green-50 transition-all"><label class="flex items-center gap-3 cursor-pointer"><input type="radio" name="agenda3GrupagemEnviar" value="' + d.id + '" ' + (isFirst ? 'checked' : '') + ' class="w-4 h-4" onchange="agenda3ActualizarSelecaoGrupagem(this)"><span class="font-bold">#' + d.numero + '</span><span class="text-sm text-slate-600">(' + totalReservas + ' reservas)</span><span class="' + badgeClass + ' text-xs px-3 py-1 rounded font-semibold">' + destinoFinal + '</span></label><div class="mt-2 text-xs text-slate-600 ml-7">ğŸ‘¤ ' + d.motorista + ' | ğŸš› ' + d.trator + ' | ğŸš ' + d.reboque + '</div></div>';
      });
      
      var armazemHTML = '<div class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded"><label class="block text-sm font-bold mb-2">ğŸ­ ArmazÃ©m de Carga:</label><select id="agenda3ArmazemDestino" class="w-full border-2 border-slate-300 rounded px-3 py-2 text-sm font-semibold">';
      armazensOrdenados.forEach(function(a) {
        var isPadrao = a.nome === agenda3ArmazemPadraoEquipa;
        armazemHTML += '<option value="' + a.nome + '" ' + (isPadrao ? 'selected' : '') + '>' + a.nome + (isPadrao ? ' â­ (PadrÃ£o da Equipa)' : '') + '</option>';
      });
      armazemHTML += '</select><p class="text-xs text-blue-600 mt-1">ğŸ’¡ O armazÃ©m da sua equipa aparece primeiro por defeito.</p></div>';
      
      document.getElementById('agenda3ModalTitle').textContent = 'ğŸ“¦ Enviar Ord. ArmazÃ©m';
      document.getElementById('agenda3ModalBody').innerHTML = armazemHTML + '<div class="mb-4"><h3 class="font-bold text-sm mb-2">ğŸ“¦ GRUPAGENS FECHADAS (' + grupagensFechadas.length + ')</h3><p class="text-xs text-slate-500 mb-2">Selecione a grupagem que pretende enviar para o armazÃ©m:</p>' + grupagemHTML + '</div><div class="flex justify-end gap-2"><button onclick="agenda3FecharModal()" class="px-4 py-2 bg-slate-200 hover:bg-slate-300 rounded text-sm">Cancelar</button><button onclick="agenda3ContinuarEnvioArmazem()" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded text-sm font-bold">â¡ï¸ Continuar</button></div>';
      document.getElementById('agenda3Modal').classList.remove('hidden');
    }
    
    function agenda3ActualizarSelecaoGrupagem(radio) {
      document.querySelectorAll('[name="agenda3GrupagemEnviar"]').forEach(function(r) {
        var container = r.closest('.border-2');
        if (r.checked) {
          container.classList.remove('border-slate-300', 'bg-white');
          container.classList.add('border-green-500', 'bg-green-50');
        } else {
          container.classList.remove('border-green-500', 'bg-green-50');
          container.classList.add('border-slate-300', 'bg-white');
        }
      });
    }
    
    function agenda3ContinuarEnvioArmazem() {
      var selectedRadio = document.querySelector('input[name="agenda3GrupagemEnviar"]:checked');
      if (!selectedRadio) { alert('âš ï¸ Selecione uma grupagem.'); return; }
      var distId = parseInt(selectedRadio.value);
      var armazemDestino = document.getElementById('agenda3ArmazemDestino').value;
      agenda3AbrirOrdemCarga(distId, armazemDestino);
    }
    
    function agenda3AbrirOrdemCarga(distId, armazemDestino) {
      var d = agenda3Distribuicoes.find(function(x) { return x.id === distId; });
      if (!d) return;
      
      var reservasDist = agenda3Dados.filter(function(r) { return r.distribuicaoId === d.id; });
      var totalReservas = reservasDist.length;
      var totalBultos = reservasDist.reduce(function(s, r) { return s + (parseInt(r.quantidadeBultos) || 0); }, 0);
      var totalLDM = reservasDist.reduce(function(s, r) { return s + (parseFloat(r.ldm) || 0); }, 0);
      
      var armazemDeCarga = armazemDestino;
      var destinoOriginalGrupagem = d.destino === 'ARMAZEM' ? d.armazem : 'Direto aos Clientes';
      var dataHora = new Date().toLocaleString('pt-PT', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
      
      var reservasHTML = '';
      reservasDist.forEach(function(r) {
        reservasHTML += '<tr class="border-b border-slate-200 hover:bg-slate-50"><td class="p-2 text-center font-bold">' + (r.ordenacao || '-') + '</td><td class="p-2 font-semibold text-blue-700">' + r.numeroReserva + '</td><td class="p-2">' + r.cliente + '</td><td class="p-2">' + r.cidadeCarga + '</td><td class="p-2">' + r.codigoPostalCarga + '</td><td class="p-2">' + r.cidadeDescarga + '</td><td class="p-2">' + r.codigoPostalDescarga + '</td><td class="p-2 text-center font-bold">' + r.quantidadeBultos + '</td><td class="p-2 text-center font-bold">' + r.ldm + '</td></tr>';
      });
      
      var ordemWindow = window.open('', '_blank', 'width=1000,height=800');
      ordemWindow.document.write('<!DOCTYPE html><html lang="pt"><head><meta charset="UTF-8"><title>Ordem de Carga - Grupagem #' + d.numero + '</title><script src="https://cdn.tailwindcss.com"><\/script><style>@media print { .no-print { display: none !important; } }</style></head><body class="bg-slate-100 min-h-screen"><div class="max-w-4xl mx-auto p-6"><div class="text-center mb-8"><h1 class="text-2xl font-bold text-slate-800">ğŸ“¦ ORDEM DE CARGA - ARMAZÃ‰M</h1><p class="text-slate-600 mt-1">GRUPAGEM #' + d.numero + '</p><p class="text-sm text-slate-500">Data/Hora: ' + dataHora + '</p></div><div class="bg-white rounded-lg shadow-md p-6 mb-6"><h2 class="font-bold text-lg mb-4 text-slate-700 border-b pb-2">ğŸ“¦ Dados da Grupagem</h2><div class="grid grid-cols-3 gap-4"><div class="border-2 border-blue-400 rounded p-3 bg-blue-50"><p class="text-xs text-blue-600 font-semibold">ğŸ“ ARMAZÃ‰M DE CARGA</p><p class="font-bold text-lg text-blue-800">' + armazemDeCarga + '</p></div><div class="border rounded p-3"><p class="text-xs text-slate-500 font-semibold">ğŸš› INTERMODAL</p><p class="font-bold text-lg">' + d.multimodal + '</p></div><div class="border rounded p-3"><p class="text-xs text-slate-500 font-semibold">ğŸ¢ FORNECEDOR</p><p class="font-bold text-lg">' + (d.fornecedor || '-') + '</p></div><div class="border rounded p-3"><p class="text-xs text-slate-500 font-semibold">ğŸ‘¤ MOTORISTA</p><p class="font-bold text-lg">' + d.motorista + '</p></div><div class="border rounded p-3"><p class="text-xs text-slate-500 font-semibold">ğŸš› TRATOR</p><p class="font-bold text-lg">' + d.trator + '</p></div><div class="border rounded p-3"><p class="text-xs text-slate-500 font-semibold">ğŸš REBOQUE</p><p class="font-bold text-lg">' + d.reboque + '</p></div><div class="border rounded p-3"><p class="text-xs text-slate-500 font-semibold">ğŸ“‹ BOOKING</p><p class="font-bold text-lg">' + (d.booking || '-') + '</p></div><div class="border-2 border-amber-400 rounded p-3 bg-amber-50"><p class="text-xs text-amber-600 font-semibold">ğŸ­ DESTINO GRUPAGEM (Original)</p><p class="font-bold text-lg text-amber-700">' + destinoOriginalGrupagem + '</p></div></div></div><div class="bg-white rounded-lg shadow-md p-6 mb-6"><h2 class="font-bold text-lg mb-4 text-slate-700 border-b pb-2">ğŸ“‹ Reservas a Carregar (' + totalReservas + ')</h2><table class="w-full text-sm"><thead class="bg-slate-700 text-white"><tr><th class="p-2 text-center">ORD</th><th class="p-2 text-left">NÂº RESERVA</th><th class="p-2 text-left">CLIENTE</th><th class="p-2 text-left">CIDADE CARGA</th><th class="p-2 text-left">CP CARGA</th><th class="p-2 text-left">CIDADE DESCARGA</th><th class="p-2 text-left">CP DESCARGA</th><th class="p-2 text-center">BULTOS</th><th class="p-2 text-center">LDM</th></tr></thead><tbody>' + reservasHTML + '</tbody></table><div class="mt-4 text-right"><p class="text-green-700 font-bold">Total Reservas: ' + totalReservas + '</p><p class="text-green-700 font-bold">Total Bultos: ' + totalBultos + '</p><p class="text-green-700 font-bold">Total LDM: ' + totalLDM.toFixed(1) + '</p></div></div><div class="flex justify-center gap-4 no-print"><button onclick="enviarParaArmazem()" class="px-6 py-3 bg-green-600 hover:bg-green-700 text-white rounded-lg font-bold">ğŸšš ENVIAR ARMAZÃ‰M</button><button onclick="window.print()" class="px-6 py-3 bg-slate-600 hover:bg-slate-700 text-white rounded-lg font-bold">ğŸ–¨ï¸ IMPRIMIR</button><button onclick="window.close()" class="px-6 py-3 bg-slate-400 hover:bg-slate-500 text-white rounded-lg font-bold">âœ• FECHAR</button></div></div><script>function enviarParaArmazem() { if (confirm("Confirma o envio da ordem de carga para ' + armazemDestino + '?")) { alert("âœ… Ordem enviada com sucesso para ' + armazemDestino + '!"); window.opener.agenda3ConfirmarEnvioArmazem(' + d.id + ', "' + armazemDestino + '"); window.close(); } }<\/script></body></html>');
      ordemWindow.document.close();
      agenda3FecharModal();
    }
    
    function agenda3ConfirmarEnvioArmazem(distId, armazemDestino) {
      var d = agenda3Distribuicoes.find(function(x) { return x.id === distId; });
      if (d) {
        d.ordemEnviada = true;
        d.armazemEnviado = armazemDestino;
        d.dataEnvio = new Date().toLocaleString('pt-PT');
        
        agenda3CarregarAgendaArquivo();
        
        var reservasDaGrupagem = agenda3Dados.filter(function(r) { return r.distribuicaoId === distId; });
        
        var totalLDM = reservasDaGrupagem.reduce(function(s, r) { return s + (parseFloat(r.ldm) || 0); }, 0);
        var totalBultos = reservasDaGrupagem.reduce(function(s, r) { return s + (parseInt(r.quantidadeBultos) || 0); }, 0);
        var totalValor = reservasDaGrupagem.filter(function(r) { return !r.isComplementar; }).reduce(function(s, r) { return s + (parseFloat(r.valorServico) || 0); }, 0);
        var valorComplementar = reservasDaGrupagem.filter(function(r) { return r.isComplementar; }).reduce(function(s, r) { return s + (parseFloat(r.valorServico) || 0); }, 0);
        
        var indexExistente = agenda3AgendaArquivo.findIndex(function(a) {
          return a.tipo === 'grupagem_enviada' && a.distribuicao && a.distribuicao.id === distId;
        });
        
        var registoArquivo = {
          tipo: 'grupagem_enviada',
          distribuicao: JSON.parse(JSON.stringify(d)),
          reservas: reservasDaGrupagem.map(function(r) { return JSON.parse(JSON.stringify(r)); }),
          armazemDeCarga: armazemDestino,
          armazemDestinoGrupagem: d.destino === 'ARMAZEM' ? d.armazem : 'Direto aos Clientes',
          booking: d.booking || '',
          dataArquivo: new Date().toLocaleString('pt-PT'),
          km: d.km || 0,
          totais: {
            ldm: totalLDM,
            bultos: totalBultos,
            peso: reservasDaGrupagem.reduce(function(s, r) { return s + (parseFloat(r.peso) || 0); }, 0),
            valor: totalValor,
            valorComplementar: valorComplementar,
            numReservas: reservasDaGrupagem.length,
            km: d.km || 0
          }
        };
        
        if (indexExistente >= 0) {
          agenda3AgendaArquivo[indexExistente] = registoArquivo;
          console.log('â™»ï¸ Grupagem substituÃ­da no arquivo (re-envio)');
        } else {
          agenda3AgendaArquivo.push(registoArquivo);
        }
        
        agenda3GuardarAgendaArquivo();
        
        agenda3RenderDistribuicoes();
        agenda3RenderTable();
        agenda3ValidarEnvio();
        
        agenda3ShowMessage('Ordem enviada para ' + armazemDestino + '!');
        console.log('Agenda Arquivo:', agenda3AgendaArquivo);
      }
    }

    function agenda3DevolverOrigem() {
      if (agenda3Selecionadas.size === 0) { alert('âš ï¸ Selecione reservas.'); return; }
      if (!confirm('Devolver ' + agenda3Selecionadas.size + ' reserva(s)?\n\nAs reservas serÃ£o enviadas para a Agenda 1 e ficarÃ¡ registo no arquivo.')) return;
      
      agenda3CarregarAgendaArquivo();
      
      agenda3Selecionadas.forEach(function(id) {
        var r = agenda3Dados.find(function(d) { return d.id === id; });
        if (r) { 
          agenda3AgendaArquivo.push({
            tipo: 'devolucao',
            numeroReserva: r.numeroReserva,
            reserva: JSON.parse(JSON.stringify(r)),
            dataArquivo: new Date().toLocaleString('pt-PT'),
            motivo: 'Devolvida Ã  origem',
            destino: 'Agenda 1'
          });
          
          agenda3ReservasDevolvidas.push(JSON.parse(JSON.stringify(r))); 
          r.dataDevolvida = new Date().toLocaleString();
          agenda3Dados = agenda3Dados.filter(function(d) { return d.id !== id; }); 
        }
      });
      
      agenda3GuardarAgendaArquivo();
      
      agenda3Selecionadas.clear();
      agenda3RenderTable();
      agenda3RenderDistribuicoes();
      agenda3ShowMessage('Reservas devolvidas! (Registo guardado no arquivo)');
    }

    function agenda3AbrirReverterModal() {
      if (agenda3ReservasDevolvidas.length === 0) { alert('â„¹ï¸ Sem reservas devolvidas.'); return; }
      var html = '<p class="text-sm mb-4">Selecione:</p><div class="max-h-60 overflow-auto border rounded"><table class="w-full text-sm"><thead class="bg-slate-100"><tr><th class="p-2"></th><th class="p-2 text-left">NÂº Reserva</th><th class="p-2 text-left">Cliente</th></tr></thead><tbody>';
      agenda3ReservasDevolvidas.forEach(function(r, i) { html += '<tr class="border-b hover:bg-slate-50 cursor-pointer" onclick="document.getElementById(\'agenda3Rev_' + i + '\').checked=true"><td class="p-2"><input type="radio" name="agenda3Rev" id="agenda3Rev_' + i + '" value="' + i + '"></td><td class="p-2 font-semibold">' + r.numeroReserva + '</td><td class="p-2">' + r.cliente + '</td></tr>'; });
      html += '</tbody></table></div><div class="flex justify-end gap-2 mt-4"><button onclick="agenda3FecharModal()" class="px-4 py-2 bg-slate-200 rounded text-sm">Cancelar</button><button onclick="agenda3ConfirmarReverter()" class="px-4 py-2 bg-blue-600 text-white rounded text-sm font-bold">ğŸ”„ Reverter</button></div>';
      document.getElementById('agenda3ModalTitle').textContent = 'ğŸ”„ Reverter Reserva';
      document.getElementById('agenda3ModalBody').innerHTML = html;
      document.getElementById('agenda3Modal').classList.remove('hidden');
    }

    function agenda3ConfirmarReverter() {
      var sel = document.querySelector('input[name="agenda3Rev"]:checked');
      if (!sel) { alert('âš ï¸ Selecione.'); return; }
      var idx = parseInt(sel.value);
      var r = agenda3ReservasDevolvidas[idx];
      
      agenda3LimparReservaDoArquivo(r.id, r.numeroReserva);
      
      r.distribuicaoId = null;
      r.ordenacao = null;
      agenda3Dados.push(r);
      agenda3ReservasDevolvidas.splice(idx, 1);
      agenda3FecharModal();
      agenda3RenderTable();
      agenda3ShowMessage('Reserva revertida! (Removida do arquivo)');
    }

    function agenda3AbrirReserva(id) {
      var r = agenda3Dados.find(function(d) { return d.id === id; });
      if (!r) return;
      document.getElementById('agenda3ModalTitle').textContent = 'ğŸ“‹ ' + r.numeroReserva;
      document.getElementById('agenda3ModalBody').innerHTML = '<div class="grid grid-cols-2 gap-3 text-sm"><p><strong>Cliente:</strong> ' + r.cliente + '</p><p><strong>Comercial:</strong> ' + r.comercial + '</p><p><strong>Carga:</strong> ' + r.cidadeCarga + '</p><p><strong>Descarga:</strong> ' + r.cidadeDescarga + '</p><p><strong>LDM:</strong> ' + r.ldm + '</p><p><strong>Peso:</strong> ' + r.peso + ' kg</p><p><strong>Valor:</strong> ' + agenda3FormatCurrency(r.valorServico) + (r.isComplementar ? ' <span class="text-green-600">(COMP)</span>' : '') + '</p><p><strong>Estado:</strong> ' + r.estadoEntrega + '</p></div><div class="mt-4 flex justify-end"><button onclick="agenda3FecharModal()" class="px-3 py-1.5 text-sm bg-slate-200 rounded">Fechar</button></div>';
      document.getElementById('agenda3Modal').classList.remove('hidden');
    }

    function agenda3VerificarCMRsPendentes() {
      agenda3Dados.forEach(function(r) {
        if (r.cmrDescarga && !r.timerArquivoIniciado) {
          console.log('âš ï¸ Reserva ' + r.numeroReserva + ' tem CMR Descarga marcado mas sem timer. A iniciar...');
          r.timerArquivoIniciado = true;
          var TEMPO_ARQUIVO = 10000;
          setTimeout(function() { agenda3ArquivarReserva(r.id); }, TEMPO_ARQUIVO);
          agenda3ShowMessage('â±ï¸ ' + r.numeroReserva + ' serÃ¡ arquivada em 10 seg (CMR jÃ¡ marcado)');
        }
      });
    }

    // InicializaÃ§Ã£o Agenda 3
    function inicializarAgenda3() {
      console.log('âœ… MÃ³dulo Agenda 3 v20 inicializado');
      agenda3CarregarAgendaArquivo();
      agenda3RenderDistribuicoes();
      agenda3RenderTable();
      agenda3ValidarEnvio();
      agenda3VerificarCMRsPendentes();
      
      // Zoom com Ctrl+scroll
      var agenda3Page = document.getElementById('page-agenda3');
      if (agenda3Page) {
        agenda3Page.addEventListener('wheel', function(e) {
          if (e.ctrlKey) {
            e.preventDefault();
            agenda3CurrentZoom = Math.min(200, Math.max(50, agenda3CurrentZoom + (e.deltaY > 0 ? -10 : 10)));
            var zoomContainer = document.getElementById('agenda3ZoomContainer');
            if (zoomContainer) zoomContainer.style.transform = 'scale(' + (agenda3CurrentZoom / 100) + ')';
            var zoomLevel = document.getElementById('agenda3ZoomLevel');
            if (zoomLevel) zoomLevel.textContent = agenda3CurrentZoom + '%';
          }
        }, { passive: false });
      }
      
      // NavegaÃ§Ã£o por teclado em TODOS os campos
      document.querySelectorAll('#page-agenda3 input, #page-agenda3 select').forEach(function(input) {
        input.addEventListener('keydown', agenda3NavegacaoTeclado);
      });
    }
    
    // NavegaÃ§Ã£o por Teclado Agenda 3 (TODOS os campos)
    function agenda3NavegacaoTeclado(event) {
      var key = event.key;
      var currentInput = event.target;
      
      var allInputs = Array.from(document.querySelectorAll('#page-agenda3 .agenda3-ordenacao-input:not([disabled]), #page-agenda3 input:not([disabled]), #page-agenda3 select:not([disabled])'));
      var currentIndex = allInputs.indexOf(currentInput);
      
      if (currentIndex === -1) return;
      
      var nextIndex = -1;
      
      if (key === 'Enter' || key === 'ArrowDown') {
        nextIndex = currentIndex + 1;
        event.preventDefault();
      }
      
      if (key === 'ArrowUp') {
        nextIndex = currentIndex - 1;
        event.preventDefault();
      }
      
      if (key === 'ArrowRight' && currentInput.tagName === 'SELECT') {
        nextIndex = currentIndex + 1;
        event.preventDefault();
      }
      
      if (key === 'ArrowLeft' && currentInput.tagName === 'SELECT') {
        nextIndex = currentIndex - 1;
        event.preventDefault();
      }
      
      if (nextIndex >= 0 && nextIndex < allInputs.length) {
        allInputs[nextIndex].focus();
        if (allInputs[nextIndex].select) allInputs[nextIndex].select();
      }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  AGENDA ARQUIVO - JAVASCRIPT PREFIXADO (Integrado v5.5)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    // Dados - Carregados do localStorage
    var agendaArquivoGrupagens = [];
    var agendaArquivoDevolucoes = [];
    var agendaArquivoReservas = [];
    var agendaArquivoCharts = {};
    var agendaArquivoInicializado = false;

    // InicializaÃ§Ã£o
    function inicializarAgendaArquivo() {
      if (agendaArquivoInicializado) {
        // Apenas recarregar dados se jÃ¡ estiver inicializado
        agendaArquivoRecarregarDados();
        return;
      }
      
      console.log('âœ… MÃ³dulo Agenda Arquivo v5.5 inicializado');
      agendaArquivoCarregarDadosLocalStorage();
      agendaArquivoAtualizarContadores();
      agendaArquivoRenderizarTabelaArquivo();
      agendaArquivoPreencherFiltros();
      
      var ultimaAtt = document.getElementById('agendaArquivoUltimaAtualizacao');
      if (ultimaAtt) ultimaAtt.textContent = new Date().toLocaleString('pt-PT');
      
      // NavegaÃ§Ã£o por teclado em TODOS os campos
      document.querySelectorAll('#page-agendaarquivo input, #page-agendaarquivo select').forEach(function(input) {
        input.addEventListener('keydown', agendaArquivoNavegacaoTeclado);
      });
      
      agendaArquivoInicializado = true;
    }
    
    // NavegaÃ§Ã£o por Teclado (TODOS os campos)
    function agendaArquivoNavegacaoTeclado(event) {
      var key = event.key;
      var currentInput = event.target;
      
      var allInputs = Array.from(document.querySelectorAll('#page-agendaarquivo input:not([disabled]), #page-agendaarquivo select:not([disabled])'));
      var currentIndex = allInputs.indexOf(currentInput);
      
      if (currentIndex === -1) return;
      
      var nextIndex = -1;
      
      if (key === 'Enter' || key === 'ArrowDown') {
        nextIndex = currentIndex + 1;
        event.preventDefault();
      }
      
      if (key === 'ArrowUp') {
        nextIndex = currentIndex - 1;
        event.preventDefault();
      }
      
      if (key === 'ArrowRight' && currentInput.tagName === 'SELECT') {
        nextIndex = currentIndex + 1;
        event.preventDefault();
      }
      
      if (key === 'ArrowLeft' && currentInput.tagName === 'SELECT') {
        nextIndex = currentIndex - 1;
        event.preventDefault();
      }
      
      if (nextIndex >= 0 && nextIndex < allInputs.length) {
        allInputs[nextIndex].focus();
        if (allInputs[nextIndex].select) allInputs[nextIndex].select();
      }
    }

    function agendaArquivoCarregarDadosLocalStorage() {
      // Limpar arrays antes de carregar
      agendaArquivoGrupagens = [];
      agendaArquivoDevolucoes = [];
      agendaArquivoReservas = [];
      
      var dadosArquivo = localStorage.getItem('agendaArquivo');
      
      if (dadosArquivo) {
        try {
          var parsed = JSON.parse(dadosArquivo);
          var registos = parsed.registos || [];
          
          registos.forEach(function(reg) {
            if (reg.tipo === 'grupagem_enviada') {
              var grupagem = {
                id: reg.distribuicao.id,
                tipo: 'grupagem_enviada',
                numeroGrupagem: reg.distribuicao.numero,
                dataArquivo: reg.dataArquivo,
                armazemDestino: reg.armazemDestino,
                multimodal: reg.distribuicao.multimodal,
                fornecedor: reg.distribuicao.fornecedor,
                motorista: reg.distribuicao.motorista,
                trator: reg.distribuicao.trator,
                reboque: reg.distribuicao.reboque,
                equipa: reg.distribuicao.equipa || 'Equipa Principal',
                armazemDeCarga: reg.armazemDeCarga || reg.armazemDestino || '-',
                armazemDestinoGrupagem: reg.armazemDestinoGrupagem || reg.distribuicao.armazem || 'Direto aos Clientes',
                booking: reg.booking || reg.distribuicao.booking || '-',
                km: parseFloat(reg.km) || parseFloat(reg.totais ? reg.totais.km : 0) || 0,
                reservas: reg.reservas.map(function(r) {
                  return {
                    id: r.id,
                    numeroReserva: r.numeroReserva,
                    comercial: r.comercial,
                    cliente: r.cliente,
                    ldm: parseFloat(r.ldm) || 0,
                    bultos: parseInt(r.quantidadeBultos) || 0,
                    peso: parseFloat(r.peso) || 0,
                    valor: parseFloat(r.valorServico) || 0,
                    ordenacao: r.ordenacao || '-',
                    dataPrevistaRecolha: r.dataPrevistaRecolha || '-',
                    dataRealRecolha: r.dataRealRecolha || r.dataPrevistaRecolha || '-',
                    dataPrevistaEntrega: r.dataPrevistaEntrega || '-',
                    dataRealEntrega: r.dataRealEntrega || r.dataPrevistaEntrega || '-',
                    cmrCarga: r.cmrCarga || false,
                    cmrDescarga: r.cmrDescarga || false,
                    isComplementar: r.isComplementar || false
                  };
                })
              };
              agendaArquivoGrupagens.push(grupagem);
              
            } else if (reg.tipo === 'reserva') {
              var jaExiste = agendaArquivoReservas.some(function(r) { return r.numeroReserva === reg.reserva.numeroReserva; });
              
              if (!jaExiste) {
                var reserva = {
                  id: reg.reserva.id,
                  tipo: 'reserva_arquivada',
                  numeroReserva: reg.reserva.numeroReserva,
                  dataArquivo: reg.dataArquivo,
                  comercial: reg.reserva.comercial,
                  cliente: reg.reserva.cliente,
                  ldm: parseFloat(reg.reserva.ldm) || 0,
                  bultos: parseInt(reg.reserva.quantidadeBultos) || 0,
                  peso: parseFloat(reg.reserva.peso) || 0,
                  valor: parseFloat(reg.reserva.valorServico) || 0,
                  motorista: reg.reserva.motorista || '-',
                  cmrCarga: reg.reserva.cmrCarga || false,
                  cmrDescarga: reg.reserva.cmrDescarga || true,
                  dataCMRDescarga: reg.dataArquivo,
                  motivo: reg.motivo,
                  equipa: reg.reserva.equipa || 'Equipa Principal',
                  isComplementar: reg.reserva.isComplementar || false
                };
                agendaArquivoReservas.push(reserva);
              }
              
            } else if (reg.tipo === 'devolucao') {
              var jaExisteDev = agendaArquivoDevolucoes.some(function(d) { return d.numeroReserva === reg.numeroReserva; });
              
              if (!jaExisteDev) {
                var devolucao = {
                  id: reg.reserva ? reg.reserva.id : Date.now(),
                  tipo: 'devolucao',
                  numeroReserva: reg.numeroReserva,
                  dataArquivo: reg.dataArquivo,
                  comercial: reg.reserva ? reg.reserva.comercial : '-',
                  cliente: reg.reserva ? reg.reserva.cliente : '-',
                  ldm: reg.reserva ? parseFloat(reg.reserva.ldm) || 0 : 0,
                  bultos: reg.reserva ? parseInt(reg.reserva.quantidadeBultos) || 0 : 0,
                  valor: reg.reserva ? parseFloat(reg.reserva.valorServico) || 0 : 0,
                  motivo: reg.motivo,
                  equipa: reg.reserva ? reg.reserva.equipa || 'Equipa Principal' : 'Equipa Principal'
                };
                agendaArquivoDevolucoes.push(devolucao);
              }
            }
          });
          
          console.log('âœ… Agenda Arquivo - Dados carregados:');
          console.log('   - Grupagens:', agendaArquivoGrupagens.length);
          console.log('   - Reservas:', agendaArquivoReservas.length);
          console.log('   - DevoluÃ§Ãµes:', agendaArquivoDevolucoes.length);
          
        } catch (e) {
          console.error('âŒ Erro ao carregar dados do localStorage:', e);
        }
      } else {
        console.log('â„¹ï¸ Agenda Arquivo - Sem dados no localStorage');
      }
    }

    // TABS
    function agendaArquivoMudarTab(tab) {
      document.getElementById('agendaArquivoContentArquivo').classList.add('hidden');
      document.getElementById('agendaArquivoContentDashboards').classList.add('hidden');
      document.getElementById('agendaArquivoContentSLA').classList.add('hidden');
      
      document.getElementById('agendaArquivoTabArquivo').className = 'agendaarquivo-tab-inactive text-white px-6 py-2 font-semibold text-xs';
      document.getElementById('agendaArquivoTabDashboards').className = 'agendaarquivo-tab-inactive text-white px-6 py-2 font-semibold text-xs';
      document.getElementById('agendaArquivoTabSLA').className = 'agendaarquivo-tab-inactive text-white px-6 py-2 font-semibold text-xs';
      
      if (tab === 'arquivo') {
        document.getElementById('agendaArquivoContentArquivo').classList.remove('hidden');
        document.getElementById('agendaArquivoTabArquivo').className = 'agendaarquivo-tab-active text-white px-6 py-2 font-semibold text-xs';
      } else if (tab === 'dashboards') {
        document.getElementById('agendaArquivoContentDashboards').classList.remove('hidden');
        document.getElementById('agendaArquivoTabDashboards').className = 'agendaarquivo-tab-active text-white px-6 py-2 font-semibold text-xs';
        agendaArquivoRenderizarDashboards();
      } else if (tab === 'sla') {
        document.getElementById('agendaArquivoContentSLA').classList.remove('hidden');
        document.getElementById('agendaArquivoTabSLA').className = 'agendaarquivo-tab-active text-white px-6 py-2 font-semibold text-xs';
        agendaArquivoRenderizarSLA();
      }
    }

    // Contadores e KPIs
    function agendaArquivoAtualizarContadores() {
      var totalGrupagens = agendaArquivoGrupagens.length;
      var totalReservas = agendaArquivoGrupagens.reduce(function(sum, g) { return sum + g.reservas.length; }, 0) + agendaArquivoReservas.length;
      var totalDevolucoes = agendaArquivoDevolucoes.length;
      
      var countGrup = document.getElementById('agendaArquivoCountGrupagens');
      var countRes = document.getElementById('agendaArquivoCountReservas');
      var countDev = document.getElementById('agendaArquivoCountDevolucoes');
      
      if (countGrup) countGrup.textContent = totalGrupagens;
      if (countRes) countRes.textContent = totalReservas;
      if (countDev) countDev.textContent = totalDevolucoes;
      
      var kpiTotalGrupagens = document.getElementById('agendaArquivoKpiTotalGrupagens');
      var kpiTotalReservas = document.getElementById('agendaArquivoKpiTotalReservas');
      var kpiTotalDevolucoes = document.getElementById('agendaArquivoKpiTotalDevolucoes');
      
      if (kpiTotalGrupagens) kpiTotalGrupagens.textContent = totalGrupagens;
      if (kpiTotalReservas) kpiTotalReservas.textContent = totalReservas;
      if (kpiTotalDevolucoes) kpiTotalDevolucoes.textContent = totalDevolucoes;
      
      var mediaReservas = totalGrupagens > 0 ? (totalReservas / totalGrupagens).toFixed(1) : '0';
      var kpiMedia = document.getElementById('agendaArquivoKpiMediaReservas');
      if (kpiMedia) kpiMedia.textContent = mediaReservas;
      
      var totalLDM = 0, totalBultos = 0, totalPeso = 0, totalValor = 0, totalValorComplementar = 0, totalKm = 0;
      
      agendaArquivoGrupagens.forEach(function(g) {
        totalKm += parseFloat(g.km) || 0;
        g.reservas.forEach(function(r) {
          totalLDM += parseFloat(r.ldm) || 0;
          totalBultos += parseInt(r.bultos) || 0;
          totalPeso += parseFloat(r.peso) || 0;
          totalValor += parseFloat(r.valor) || 0;
          if (r.isComplementar) totalValorComplementar += parseFloat(r.valor) || 0;
        });
      });
      
      agendaArquivoReservas.forEach(function(r) {
        totalLDM += parseFloat(r.ldm) || 0;
        totalBultos += parseInt(r.bultos) || 0;
        totalPeso += parseFloat(r.peso) || 0;
        totalValor += parseFloat(r.valor) || 0;
        if (r.isComplementar) totalValorComplementar += parseFloat(r.valor) || 0;
      });
      
      var kpiTotalLDM = document.getElementById('agendaArquivoKpiTotalLDM');
      var kpiTotalBultos = document.getElementById('agendaArquivoKpiTotalBultos');
      var kpiTotalPeso = document.getElementById('agendaArquivoKpiTotalPeso');
      var kpiValorTotal = document.getElementById('agendaArquivoKpiValorTotal');
      var kpiValorComp = document.getElementById('agendaArquivoKpiValorComplementar');
      
      if (kpiTotalLDM) kpiTotalLDM.textContent = totalLDM.toFixed(1);
      if (kpiTotalBultos) kpiTotalBultos.textContent = totalBultos;
      if (kpiTotalPeso) kpiTotalPeso.textContent = totalPeso.toLocaleString('pt-PT');
      if (kpiValorTotal) kpiValorTotal.textContent = agendaArquivoFormatCurrency(totalValor);
      if (kpiValorComp) kpiValorComp.textContent = agendaArquivoFormatCurrency(totalValorComplementar);
      
      var valorSemComplementar = totalValor - totalValorComplementar;
      
      var kpiKmTotais = document.getElementById('agendaArquivoKpiKmTotais');
      var kpiEuroKmGeral = document.getElementById('agendaArquivoKpiEuroKmGeral');
      var kpiEuroLdmMedio = document.getElementById('agendaArquivoKpiEuroLdmMedio');
      var kpiEuroKmSemComp = document.getElementById('agendaArquivoKpiEuroKmSemComp');
      var kpiEuroKmComComp = document.getElementById('agendaArquivoKpiEuroKmComComp');
      
      if (kpiKmTotais) kpiKmTotais.textContent = totalKm > 0 ? totalKm.toLocaleString('pt-PT') : '0';
      
      var euroKmGeral = totalKm > 0 ? (totalValor / totalKm) : 0;
      if (kpiEuroKmGeral) kpiEuroKmGeral.textContent = agendaArquivoFormatCurrency(euroKmGeral);
      
      var euroLdmMedio = totalLDM > 0 ? (valorSemComplementar / totalLDM) : 0;
      if (kpiEuroLdmMedio) kpiEuroLdmMedio.textContent = agendaArquivoFormatCurrency(euroLdmMedio);
      
      var euroKmSemComp = totalKm > 0 ? (valorSemComplementar / totalKm) : 0;
      if (kpiEuroKmSemComp) kpiEuroKmSemComp.textContent = agendaArquivoFormatCurrency(euroKmSemComp);
      
      var euroKmComComp = totalKm > 0 ? (totalValor / totalKm) : 0;
      if (kpiEuroKmComComp) kpiEuroKmComComp.textContent = agendaArquivoFormatCurrency(euroKmComComp);
    }

    function agendaArquivoFormatCurrency(value) {
      return parseFloat(value || 0).toLocaleString('pt-PT', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' â‚¬';
    }

    // Tabela Arquivo
    function agendaArquivoRenderizarTabelaArquivo() {
      agendaArquivoRenderizarTabelaArquivoFiltrada(agendaArquivoGrupagens, agendaArquivoReservas, agendaArquivoDevolucoes);
    }

    // Filtros
    function agendaArquivoPreencherFiltros() {
      var comerciais = new Set();
      agendaArquivoGrupagens.forEach(function(g) { g.reservas.forEach(function(r) { comerciais.add(r.comercial); }); });
      agendaArquivoReservas.forEach(function(r) { comerciais.add(r.comercial); });
      agendaArquivoDevolucoes.forEach(function(d) { comerciais.add(d.comercial); });
      
      var selectComercial = document.getElementById('agendaArquivoFiltroComercial');
      if (selectComercial) {
        selectComercial.innerHTML = '<option value="">Todos</option>';
        comerciais.forEach(function(c) {
          selectComercial.innerHTML += '<option value="' + c + '">' + c + '</option>';
        });
      }
      
      var equipas = new Set();
      agendaArquivoGrupagens.forEach(function(g) { equipas.add(g.equipa); });
      agendaArquivoDevolucoes.forEach(function(d) { equipas.add(d.equipa); });
      
      var selectEquipa = document.getElementById('agendaArquivoFiltroEquipa');
      if (selectEquipa) {
        selectEquipa.innerHTML = '<option value="">Todas</option>';
        equipas.forEach(function(e) {
          selectEquipa.innerHTML += '<option value="' + e + '">' + e + '</option>';
        });
      }
      
      var clientes = new Set();
      agendaArquivoGrupagens.forEach(function(g) { g.reservas.forEach(function(r) { clientes.add(r.cliente); }); });
      agendaArquivoReservas.forEach(function(r) { clientes.add(r.cliente); });
      agendaArquivoDevolucoes.forEach(function(d) { clientes.add(d.cliente); });
      
      var selectCliente = document.getElementById('agendaArquivoFiltroCliente');
      if (selectCliente) {
        selectCliente.innerHTML = '<option value="">Todos</option>';
        clientes.forEach(function(c) {
          selectCliente.innerHTML += '<option value="' + c + '">' + c + '</option>';
        });
      }
    }

    function agendaArquivoAplicarFiltros() {
      var pesquisa = (document.getElementById('agendaArquivoFiltroPesquisa').value || '').toLowerCase().trim();
      var armazem = document.getElementById('agendaArquivoFiltroArmazem').value;
      var comercial = document.getElementById('agendaArquivoFiltroComercial').value;
      var cliente = document.getElementById('agendaArquivoFiltroCliente').value;
      var tipo = document.getElementById('agendaArquivoFiltroTipo').value;
      
      var grupagensFiltradas = agendaArquivoGrupagens.filter(function(g) {
        if (armazem && g.armazemDeCarga !== armazem && g.armazemDestinoGrupagem !== armazem) return false;
        if (tipo === 'grupagem' && g.tipo !== 'grupagem_enviada') return false;
        
        if (pesquisa) {
          var matchGrupagem = ('#' + g.numeroGrupagem).includes(pesquisa) ||
                              (g.motorista || '').toLowerCase().includes(pesquisa) ||
                              (g.trator || '').toLowerCase().includes(pesquisa) ||
                              (g.booking || '').toLowerCase().includes(pesquisa);
          var matchReservas = g.reservas.some(function(r) {
            return (r.numeroReserva || '').toLowerCase().includes(pesquisa) ||
                   (r.cliente || '').toLowerCase().includes(pesquisa) ||
                   (r.comercial || '').toLowerCase().includes(pesquisa);
          });
          if (!matchGrupagem && !matchReservas) return false;
        }
        
        if (comercial || cliente) {
          var matchReservas2 = g.reservas.some(function(r) {
            return (!comercial || r.comercial === comercial) && (!cliente || r.cliente === cliente);
          });
          if (!matchReservas2) return false;
        }
        
        return true;
      });
      
      var reservasFiltradas = agendaArquivoReservas.filter(function(r) {
        if (tipo === 'grupagem') return false;
        if (tipo === 'reserva' && r.tipo !== 'reserva_arquivada') return false;
        if (comercial && r.comercial !== comercial) return false;
        if (cliente && r.cliente !== cliente) return false;
        if (pesquisa) {
          var match = (r.numeroReserva || '').toLowerCase().includes(pesquisa) ||
                      (r.cliente || '').toLowerCase().includes(pesquisa) ||
                      (r.comercial || '').toLowerCase().includes(pesquisa);
          if (!match) return false;
        }
        return true;
      });
      
      var devolucoesFiltradas = agendaArquivoDevolucoes.filter(function(d) {
        if (tipo === 'grupagem' || tipo === 'reserva') return false;
        if (tipo === 'devolucao' && d.tipo !== 'devolucao') return false;
        if (comercial && d.comercial !== comercial) return false;
        if (cliente && d.cliente !== cliente) return false;
        if (pesquisa) {
          var match = (d.numeroReserva || '').toLowerCase().includes(pesquisa) ||
                      (d.cliente || '').toLowerCase().includes(pesquisa) ||
                      (d.comercial || '').toLowerCase().includes(pesquisa);
          if (!match) return false;
        }
        return true;
      });
      
      agendaArquivoRenderizarTabelaArquivoFiltrada(grupagensFiltradas, reservasFiltradas, devolucoesFiltradas);
    }

    function agendaArquivoRenderizarTabelaArquivoFiltrada(grupagens, reservas, devolucoes) {
      var tbody = document.getElementById('agendaArquivoTabelaArquivo');
      if (!tbody) return;
      
      var html = '';
      
      // Grupagens
      grupagens.forEach(function(g) {
        var totalLDM = g.reservas.reduce(function(s, r) { return s + (parseFloat(r.ldm) || 0); }, 0);
        var totalBultos = g.reservas.reduce(function(s, r) { return s + (parseInt(r.bultos) || 0); }, 0);
        var totalPeso = g.reservas.reduce(function(s, r) { return s + (parseFloat(r.peso) || 0); }, 0);
        var valorNormal = g.reservas.filter(function(r) { return !r.isComplementar; }).reduce(function(s, r) { return s + (parseFloat(r.valor) || 0); }, 0);
        var valorComplementar = g.reservas.filter(function(r) { return r.isComplementar; }).reduce(function(s, r) { return s + (parseFloat(r.valor) || 0); }, 0);
        
        var armazemCarga = g.armazemDeCarga || g.armazemDestino || '-';
        var armazemDestinoGrup = g.armazemDestinoGrupagem || 'Direto aos Clientes';
        var booking = g.booking || '-';
        
        html += '<tr class="agendaarquivo-row-group-header">' +
          '<td class="p-2" colspan="19">' +
            '<div class="flex items-center justify-between">' +
              '<div class="flex items-center gap-3">' +
                '<span class="text-lg">ğŸ”’</span>' +
                '<span class="font-bold text-base">DistribuiÃ§Ã£o #' + g.numeroGrupagem + '</span>' +
                '<span class="agendaarquivo-badge-fechada px-2 py-0.5 rounded text-[10px]">FECHADA</span>' +
                '<span class="text-sm text-slate-700 font-medium">| ' + (g.multimodal || '-') + '</span>' +
                '<span class="text-sm text-slate-700">| Forn: <strong>' + (g.fornecedor || '-') + '</strong></span>' +
                '<span class="text-sm text-slate-700">| ğŸ‘¤ <strong>' + g.motorista + '</strong></span>' +
                '<span class="text-sm text-slate-700">| ğŸš› <strong>' + g.trator + '</strong></span>' +
                '<span class="text-sm text-slate-700">| ğŸš <strong>' + (g.reboque || '-') + '</strong></span>' +
                '<span class="text-sm text-slate-700">| ğŸ“‹ <strong>Booking: ' + booking + '</strong></span>' +
              '</div>' +
              '<div class="flex items-center gap-2">' +
                '<span class="bg-blue-600 text-white px-4 py-1.5 rounded text-base font-bold shadow">ğŸ­ ' + armazemCarga + '</span>' +
                '<span class="bg-amber-500 text-white px-4 py-1.5 rounded text-base font-bold shadow">ğŸ“ ' + armazemDestinoGrup + '</span>' +
                '<span class="agendaarquivo-badge-enviada px-2 py-0.5 rounded text-[10px]">âœ“ ENVIADA</span>' +
                '<span class="text-sm text-slate-600">' + g.dataArquivo + '</span>' +
              '</div>' +
            '</div>' +
          '</td>' +
        '</tr>';
        
        g.reservas.forEach(function(r) {
          var isComp = r.isComplementar;
          var rowClass = isComp ? 'agendaarquivo-row-complementar' : 'agendaarquivo-row-reserva';
          var valorClass = isComp ? 'agendaarquivo-valor-complementar' : '';
          var ordenacao = r.ordenacao || '-';
          
          html += '<tr class="' + rowClass + ' border-b border-slate-100">' +
            '<td class="p-2"><span class="text-slate-400 text-[10px]">â””â”€</span></td>' +
            '<td class="p-2 text-slate-400">#' + g.numeroGrupagem + '</td>' +
            '<td class="p-2 text-center font-bold text-purple-600">' + ordenacao + '</td>' +
            '<td class="p-2 font-medium text-blue-600">' + r.numeroReserva + (isComp ? ' <span class="bg-green-500 text-white text-[9px] px-1 rounded">COMP</span>' : '') + '</td>' +
            '<td class="p-2">' + g.dataArquivo + '</td>' +
            '<td class="p-2">' + armazemCarga + '</td>' +
            '<td class="p-2">' + armazemDestinoGrup + '</td>' +
            '<td class="p-2">' + r.cliente + '</td>' +
            '<td class="p-2">' + r.comercial + '</td>' +
            '<td class="p-2">' + g.motorista + '</td>' +
            '<td class="p-2">' + g.trator + '</td>' +
            '<td class="p-2 text-right">' + parseFloat(r.ldm || 0).toFixed(1) + '</td>' +
            '<td class="p-2 text-right">' + (r.bultos || 0) + '</td>' +
            '<td class="p-2 text-right">' + parseFloat(r.peso || 0).toLocaleString('pt-PT') + '</td>' +
            '<td class="p-2 text-right ' + valorClass + '">' + agendaArquivoFormatCurrency(r.valor) + '</td>' +
            '<td class="p-2 text-center">' + (r.cmrCarga ? '<span class="text-green-600 font-bold">âœ“</span>' : '<span class="text-slate-300">â—‹</span>') + '</td>' +
            '<td class="p-2 text-center">' + (r.cmrDescarga ? '<span class="text-green-600 font-bold">âœ“</span>' : '<span class="text-slate-300">â—‹</span>') + '</td>' +
            '<td class="p-2 text-right text-slate-300">-</td>' +
            '<td class="p-2 text-right text-slate-300">-</td>' +
          '</tr>';
        });
        
        var kmGrupagem = parseFloat(g.km) || 0;
        var valorTotal = valorNormal + valorComplementar;
        var euroKm = kmGrupagem > 0 ? (valorTotal / kmGrupagem) : 0;
        
        var todasEntregues = g.reservas.every(function(r) { return r.cmrDescarga === true; });
        var statusKm = kmGrupagem > 0 ? kmGrupagem.toLocaleString('pt-PT') + ' km' : (todasEntregues ? 'â³ A calcular...' : 'â³ Aguarda CMR');
        var statusEuroKm = euroKm > 0 ? agendaArquivoFormatCurrency(euroKm) + '/km' : (todasEntregues ? 'â³ A calcular...' : 'â³ Aguarda CMR');
        
        html += '<tr class="agendaarquivo-row-sum border-b-2 border-slate-300">' +
          '<td class="p-2" colspan="3"></td>' +
          '<td class="p-2 font-bold" colspan="6">TOTAIS #' + g.numeroGrupagem + ':</td>' +
          '<td class="p-2" colspan="2"></td>' +
          '<td class="p-2 text-right font-bold">' + totalLDM.toFixed(1) + '</td>' +
          '<td class="p-2 text-right font-bold">' + totalBultos + '</td>' +
          '<td class="p-2 text-right font-bold">' + totalPeso.toLocaleString('pt-PT') + '</td>' +
          '<td class="p-2 text-right font-bold">' + agendaArquivoFormatCurrency(valorTotal) + '</td>' +
          '<td class="p-2" colspan="2"></td>' +
          '<td class="p-2 text-right font-bold bg-cyan-100 text-cyan-700 border border-cyan-300">' + statusKm + '</td>' +
          '<td class="p-2 text-right font-bold bg-violet-100 text-violet-700 border border-violet-300">' + statusEuroKm + '</td>' +
        '</tr>';
        
        html += '<tr><td colspan="19" class="p-1 bg-slate-200"></td></tr>';
      });
      
      // Reservas
      if (reservas.length > 0) {
        html += '<tr class="bg-slate-100"><td colspan="19" class="p-2 font-bold text-slate-600">ğŸ“‹ RESERVAS ARQUIVADAS (CMR Descarga)</td></tr>';
        reservas.forEach(function(r) {
          html += '<tr class="agendaarquivo-row-reserva border-b border-slate-200">' +
            '<td class="p-2"><span class="agendaarquivo-badge-arquivada px-2 py-0.5 rounded text-[10px]">ğŸ“‹ RESERVA</span></td>' +
            '<td class="p-2 text-slate-400">-</td>' +
            '<td class="p-2 text-center">-</td>' +
            '<td class="p-2 font-medium text-blue-600">' + r.numeroReserva + '</td>' +
            '<td class="p-2">' + r.dataArquivo + '</td>' +
            '<td class="p-2">-</td>' +
            '<td class="p-2">-</td>' +
            '<td class="p-2">' + r.cliente + '</td>' +
            '<td class="p-2">' + r.comercial + '</td>' +
            '<td class="p-2">' + (r.motorista || '-') + '</td>' +
            '<td class="p-2">-</td>' +
            '<td class="p-2 text-right">' + parseFloat(r.ldm || 0).toFixed(1) + '</td>' +
            '<td class="p-2 text-right">' + (r.bultos || 0) + '</td>' +
            '<td class="p-2 text-right">' + parseFloat(r.peso || 0).toLocaleString('pt-PT') + '</td>' +
            '<td class="p-2 text-right">' + agendaArquivoFormatCurrency(r.valor) + '</td>' +
            '<td class="p-2 text-center">' + (r.cmrCarga ? '<span class="text-green-600 font-bold">âœ“</span>' : '<span class="text-slate-300">â—‹</span>') + '</td>' +
            '<td class="p-2 text-center">' + (r.cmrDescarga ? '<span class="text-green-600 font-bold">âœ“</span>' : '<span class="text-slate-300">â—‹</span>') + '</td>' +
            '<td class="p-2 text-right text-slate-300">-</td>' +
            '<td class="p-2 text-right text-slate-300">-</td>' +
          '</tr>';
        });
      }
      
      // DevoluÃ§Ãµes
      if (devolucoes.length > 0) {
        html += '<tr class="bg-amber-100"><td colspan="19" class="p-2 font-bold text-amber-700">â†©ï¸ DEVOLUÃ‡Ã•ES</td></tr>';
        devolucoes.forEach(function(d) {
          html += '<tr class="agendaarquivo-row-devolucao border-b border-slate-200">' +
            '<td class="p-2"><span class="agendaarquivo-badge-devolucao px-2 py-0.5 rounded text-[10px]">â†©ï¸ DEVOLUÃ‡ÃƒO</span></td>' +
            '<td class="p-2 text-slate-400">-</td>' +
            '<td class="p-2 text-center">-</td>' +
            '<td class="p-2 font-medium text-orange-600">' + d.numeroReserva + '</td>' +
            '<td class="p-2">' + d.dataArquivo + '</td>' +
            '<td class="p-2">-</td>' +
            '<td class="p-2">-</td>' +
            '<td class="p-2">' + d.cliente + '</td>' +
            '<td class="p-2">' + d.comercial + '</td>' +
            '<td class="p-2">-</td>' +
            '<td class="p-2">-</td>' +
            '<td class="p-2 text-right">' + parseFloat(d.ldm || 0).toFixed(1) + '</td>' +
            '<td class="p-2 text-right">' + (d.bultos || 0) + '</td>' +
            '<td class="p-2 text-right">' + parseFloat(d.peso || 0).toLocaleString('pt-PT') + '</td>' +
            '<td class="p-2 text-right">' + agendaArquivoFormatCurrency(d.valor) + '</td>' +
            '<td class="p-2 text-center">-</td>' +
            '<td class="p-2 text-center">-</td>' +
            '<td class="p-2 text-right text-slate-300">-</td>' +
            '<td class="p-2 text-right text-slate-300">-</td>' +
          '</tr>';
        });
      }
      
      tbody.innerHTML = html;
    }

    function agendaArquivoLimparFiltros() {
      document.getElementById('agendaArquivoFiltroDataInicio').value = '';
      document.getElementById('agendaArquivoFiltroDataFim').value = '';
      document.getElementById('agendaArquivoFiltroArmazem').value = '';
      document.getElementById('agendaArquivoFiltroComercial').value = '';
      document.getElementById('agendaArquivoFiltroEquipa').value = '';
      document.getElementById('agendaArquivoFiltroCliente').value = '';
      document.getElementById('agendaArquivoFiltroTipo').value = '';
      document.getElementById('agendaArquivoFiltroPesquisa').value = '';
      agendaArquivoAplicarFiltros();
    }

    // Dashboards
    function agendaArquivoRenderizarDashboards() {
      // Destruir grÃ¡ficos existentes
      Object.values(agendaArquivoCharts).forEach(function(chart) { if (chart && chart.destroy) chart.destroy(); });
      agendaArquivoCharts = {};
      
      // KPIs do mÃªs
      var totalGrupagensMes = agendaArquivoGrupagens.length;
      var totalReservasMes = agendaArquivoGrupagens.reduce(function(sum, g) { return sum + g.reservas.length; }, 0);
      var ldmMes = 0, valorMes = 0;
      agendaArquivoGrupagens.forEach(function(g) { g.reservas.forEach(function(r) { ldmMes += r.ldm || 0; valorMes += r.valor || 0; }); });
      
      var kpiGrupagensMes = document.getElementById('agendaArquivoKpiGrupagensMes');
      var kpiReservasMes = document.getElementById('agendaArquivoKpiReservasMes');
      var kpiLDMMes = document.getElementById('agendaArquivoKpiLDMMes');
      var kpiFaturacaoMes = document.getElementById('agendaArquivoKpiFaturacaoMes');
      var kpiPrecoMedioLDM = document.getElementById('agendaArquivoKpiPrecoMedioLDM');
      var kpiDevolucoesMes = document.getElementById('agendaArquivoKpiDevolucoesMes');
      
      if (kpiGrupagensMes) kpiGrupagensMes.textContent = totalGrupagensMes;
      if (kpiReservasMes) kpiReservasMes.textContent = totalReservasMes;
      if (kpiLDMMes) kpiLDMMes.textContent = ldmMes.toFixed(1);
      if (kpiFaturacaoMes) kpiFaturacaoMes.textContent = agendaArquivoFormatCurrency(valorMes);
      if (kpiPrecoMedioLDM) kpiPrecoMedioLDM.textContent = ldmMes > 0 ? agendaArquivoFormatCurrency(valorMes / ldmMes) : '0 â‚¬';
      if (kpiDevolucoesMes) kpiDevolucoesMes.textContent = agendaArquivoDevolucoes.length;
      
      // GrÃ¡ficos apenas se Chart.js estiver disponÃ­vel
      if (typeof Chart !== 'undefined') {
        // GrÃ¡fico Volume Mensal
        var ctxVolume = document.getElementById('agendaArquivoChartVolumeMensal');
        if (ctxVolume) {
          agendaArquivoCharts.volumeMensal = new Chart(ctxVolume, {
            type: 'line',
            data: {
              labels: ['Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'],
              datasets: [{ label: 'LDM', data: [45, 52, 48, 61, 55, ldmMes], borderColor: '#8b5cf6', backgroundColor: 'rgba(139, 92, 246, 0.1)', fill: true, tension: 0.4 }]
            },
            options: { responsive: true, maintainAspectRatio: false }
          });
        }
        
        // GrÃ¡fico por ArmazÃ©m
        var porArmazem = {};
        agendaArquivoGrupagens.forEach(function(g) { porArmazem[g.armazemDestino] = (porArmazem[g.armazemDestino] || 0) + 1; });
        
        var ctxArmazem = document.getElementById('agendaArquivoChartPorArmazem');
        if (ctxArmazem) {
          agendaArquivoCharts.porArmazem = new Chart(ctxArmazem, {
            type: 'doughnut',
            data: {
              labels: Object.keys(porArmazem),
              datasets: [{ data: Object.values(porArmazem), backgroundColor: ['#10b981', '#3b82f6', '#f59e0b', '#ef4444'] }]
            },
            options: { responsive: true, maintainAspectRatio: false }
          });
        }
      }
    }

    // SLA
    function agendaArquivoRenderizarSLA() {
      // Placeholder - KPIs bÃ¡sicos
      var kpiSLARecolhas = document.getElementById('agendaArquivoKpiSLARecolhas');
      var kpiSLAEntregas = document.getElementById('agendaArquivoKpiSLAEntregas');
      var kpiDesvioRecolha = document.getElementById('agendaArquivoKpiDesvioRecolha');
      var kpiDesvioEntrega = document.getElementById('agendaArquivoKpiDesvioEntrega');
      
      if (kpiSLARecolhas) kpiSLARecolhas.textContent = '92%';
      if (kpiSLAEntregas) kpiSLAEntregas.textContent = '97%';
      if (kpiDesvioRecolha) kpiDesvioRecolha.textContent = '1.2h';
      if (kpiDesvioEntrega) kpiDesvioEntrega.textContent = '2.8h';
      
      var barSLARecolhas = document.getElementById('agendaArquivoBarSLARecolhas');
      var barSLAEntregas = document.getElementById('agendaArquivoBarSLAEntregas');
      
      if (barSLARecolhas) barSLARecolhas.style.width = '92%';
      if (barSLAEntregas) barSLAEntregas.style.width = '97%';
    }

    // FunÃ§Ãµes de AcÃ§Ã£o
    function agendaArquivoExportarExcel() {
      alert('ğŸ“¥ Funcionalidade de exportaÃ§Ã£o Excel serÃ¡ implementada na integraÃ§Ã£o com backend.\n\nPor agora, use Ctrl+P para imprimir/guardar PDF.');
    }
    
    function agendaArquivoRecarregarDados() {
      agendaArquivoGrupagens = [];
      agendaArquivoDevolucoes = [];
      agendaArquivoReservas = [];
      
      agendaArquivoCarregarDadosLocalStorage();
      agendaArquivoAtualizarContadores();
      agendaArquivoRenderizarTabelaArquivo();
      agendaArquivoPreencherFiltros();
      
      var ultimaAtt = document.getElementById('agendaArquivoUltimaAtualizacao');
      if (ultimaAtt) ultimaAtt.textContent = new Date().toLocaleString('pt-PT');
      
      alert('âœ… Dados atualizados!\n\nGrupagens: ' + agendaArquivoGrupagens.length + '\nReservas: ' + agendaArquivoReservas.length + '\nDevoluÃ§Ãµes: ' + agendaArquivoDevolucoes.length);
    }
    
    function agendaArquivoVerLocalStorage() {
      var dados = localStorage.getItem('agendaArquivo');
      if (dados) {
        console.log('=== DADOS NO localStorage ===');
        console.log(JSON.parse(dados));
        alert('âœ… Dados encontrados no localStorage!\n\nAbra a consola (F12) para ver os detalhes.\n\nTamanho: ' + dados.length + ' caracteres');
      } else {
        alert('âŒ Nenhum dado encontrado no localStorage.\n\nIsso significa que a Agenda 3 ainda nÃ£o enviou nenhuma grupagem.\n\nPasso a passo:\n1. Abra a Agenda 3\n2. Selecione reservas\n3. Crie e feche uma grupagem\n4. Clique "Enviar Ord. ArmazÃ©m"\n5. Complete o envio\n6. Volte aqui e clique "Atualizar Dados"');
      }
    }
    
    function agendaArquivoLimparTodosDados() {
      if (confirm('âš ï¸ ATENÃ‡ÃƒO!\n\nIsto vai APAGAR TODOS os dados do arquivo!\n\nEsta aÃ§Ã£o Ã© irreversÃ­vel.\n\nTem a certeza?')) {
        localStorage.removeItem('agendaArquivo');
        
        agendaArquivoGrupagens = [];
        agendaArquivoDevolucoes = [];
        agendaArquivoReservas = [];
        
        agendaArquivoAtualizarContadores();
        agendaArquivoRenderizarTabelaArquivo();
        
        var ultimaAtt = document.getElementById('agendaArquivoUltimaAtualizacao');
        if (ultimaAtt) ultimaAtt.textContent = new Date().toLocaleString('pt-PT');
        
        alert('âœ… Todos os dados foram apagados!\n\nAgora pode comeÃ§ar testes limpos.');
      }
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       COTAÃ‡Ã•ES - JAVASCRIPT PREFIXADO (Integrado v5.6)
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    
    // Dados
    var cotacoesLista = [];
    var cotacoesProximoId = 1;
    var cotacoesOrdenacao = { campo: 'numero', direcao: 'desc' };
    
    // InicializaÃ§Ã£o
    function cotacoesInit() {
      cotacoesCarregarDados();
      cotacoesRenderizar();
      cotacoesSetupNavegacaoTeclado();
      
      // Definir datas padrÃ£o no modal
      var hoje = new Date().toISOString().split('T')[0];
      var validade = new Date();
      validade.setDate(validade.getDate() + 15);
      
      var dataInput = document.getElementById('cotacoesData');
      var validadeInput = document.getElementById('cotacoesValidade');
      var converterDataInput = document.getElementById('cotacoesConverterData');
      
      if (dataInput) dataInput.value = hoje;
      if (validadeInput) validadeInput.value = validade.toISOString().split('T')[0];
      if (converterDataInput) converterDataInput.value = hoje;
    }
    
    // localStorage
    function cotacoesCarregarDados() {
      try {
        var dados = localStorage.getItem('erpCotacoes');
        if (dados) {
          var parsed = JSON.parse(dados);
          cotacoesLista = parsed.lista || [];
          cotacoesProximoId = parsed.proximoId || 1;
        }
      } catch (e) {
        console.error('Erro ao carregar cotaÃ§Ãµes:', e);
      }
      
      // Dados de teste se vazio
      if (cotacoesLista.length === 0) {
        cotacoesLista = [
          { id: 1, numero: 'COT-2024-0001', data: '2024-12-18', validade: '2025-01-02', numCliente: '10234', nomeCliente: 'Transportes IbÃ©ricos Lda', emailCliente: 'comercial@ibertrans.pt', telCliente: '+351 234 567 890', descricao: 'Transporte Paletizado', localCarga: 'Lisboa, Portugal', localDescarga: 'Madrid, Espanha', km: 625, precoKm: 1.85, precoViagem: 0, extras: 50, total: 1206.25, estado: 'Pendente', obs: '' },
          { id: 2, numero: 'COT-2024-0002', data: '2024-12-17', validade: '2025-01-01', numCliente: '10456', nomeCliente: 'MetalÃºrgica do Norte SA', emailCliente: 'logistica@metalnorte.pt', telCliente: '+351 253 123 456', descricao: 'Carga Completa - AÃ§o', localCarga: 'Porto, Portugal', localDescarga: 'Barcelona, Espanha', km: 1150, precoKm: 1.75, precoViagem: 0, extras: 100, total: 2112.50, estado: 'Aceite', obs: 'Cliente habitual' },
          { id: 3, numero: 'COT-2024-0003', data: '2024-12-15', validade: '2024-12-30', numCliente: '10789', nomeCliente: 'IndÃºstrias Alimentares Centro', emailCliente: 'compras@ialcentro.pt', telCliente: '+351 239 987 654', descricao: 'Refrigerado', localCarga: 'Coimbra, Portugal', localDescarga: 'Paris, FranÃ§a', km: 1580, precoKm: 2.10, precoViagem: 0, extras: 200, total: 3518.00, estado: 'Recusada', obs: 'PreÃ§o elevado segundo cliente' },
          { id: 4, numero: 'COT-2024-0004', data: '2024-12-19', validade: '2025-01-03', numCliente: '10234', nomeCliente: 'Transportes IbÃ©ricos Lda', emailCliente: 'comercial@ibertrans.pt', telCliente: '+351 234 567 890', descricao: 'Grupagem Nacional', localCarga: 'Faro, Portugal', localDescarga: 'Braga, Portugal', km: 580, precoKm: 0, precoViagem: 850, extras: 0, total: 850.00, estado: 'Pendente', obs: '' }
        ];
        cotacoesProximoId = 5;
        cotacoesGuardarDados();
      }
    }
    
    function cotacoesGuardarDados() {
      try {
        localStorage.setItem('erpCotacoes', JSON.stringify({
          lista: cotacoesLista,
          proximoId: cotacoesProximoId
        }));
      } catch (e) {
        console.error('Erro ao guardar cotaÃ§Ãµes:', e);
      }
    }
    
    // RenderizaÃ§Ã£o
    function cotacoesRenderizar() {
      cotacoesAtualizarKPIs();
      cotacoesRenderizarTabela();
    }
    
    function cotacoesAtualizarKPIs() {
      var total = cotacoesLista.length;
      var pendentes = cotacoesLista.filter(function(c) { return c.estado === 'Pendente'; }).length;
      var aceites = cotacoesLista.filter(function(c) { return c.estado === 'Aceite' || c.estado === 'Convertida'; }).length;
      var recusadas = cotacoesLista.filter(function(c) { return c.estado === 'Recusada'; }).length;
      var valorAceites = cotacoesLista.filter(function(c) { return c.estado === 'Aceite' || c.estado === 'Convertida'; })
                                       .reduce(function(s, c) { return s + (c.total || 0); }, 0);
      
      var kpiTotal = document.getElementById('cotacoesKpiTotal');
      var kpiPendentes = document.getElementById('cotacoesKpiPendentes');
      var kpiAceites = document.getElementById('cotacoesKpiAceites');
      var kpiRecusadas = document.getElementById('cotacoesKpiRecusadas');
      var kpiValor = document.getElementById('cotacoesKpiValor');
      
      if (kpiTotal) kpiTotal.textContent = total;
      if (kpiPendentes) kpiPendentes.textContent = pendentes;
      if (kpiAceites) kpiAceites.textContent = aceites;
      if (kpiRecusadas) kpiRecusadas.textContent = recusadas;
      if (kpiValor) kpiValor.textContent = cotacoesFormatarMoeda(valorAceites);
    }
    
    function cotacoesRenderizarTabela() {
      var tbody = document.getElementById('cotacoesTabelaBody');
      var emptyState = document.getElementById('cotacoesEmptyState');
      var contador = document.getElementById('cotacoesContador');
      
      if (!tbody) return;
      
      var filtradas = cotacoesAplicarFiltros();
      filtradas = cotacoesAplicarOrdenacao(filtradas);
      
      if (filtradas.length === 0) {
        tbody.innerHTML = '';
        if (emptyState) emptyState.style.display = 'block';
        if (contador) contador.textContent = '0 cotaÃ§Ãµes';
        return;
      }
      
      if (emptyState) emptyState.style.display = 'none';
      if (contador) contador.textContent = filtradas.length + ' cotaÃ§Ã£o' + (filtradas.length !== 1 ? 'Ãµes' : '');
      
      var html = '';
      filtradas.forEach(function(c) {
        var badgeClass = 'cotacoes-badge-' + c.estado.toLowerCase();
        
        html += '<tr data-id="' + c.id + '">' +
          '<td><strong>' + c.numero + '</strong></td>' +
          '<td>' + cotacoesFormatarData(c.data) + '</td>' +
          '<td>' + cotacoesFormatarData(c.validade) + '</td>' +
          '<td><strong>' + c.numCliente + '</strong> - ' + c.nomeCliente + '</td>' +
          '<td>' + (c.descricao || '-') + '</td>' +
          '<td>' + (c.localCarga || '-') + '</td>' +
          '<td>' + (c.localDescarga || '-') + '</td>' +
          '<td style="text-align: right;">' + (c.km || 0) + '</td>' +
          '<td style="text-align: right;">' + (c.precoKm ? cotacoesFormatarMoeda(c.precoKm) : '-') + '</td>' +
          '<td style="text-align: right;">' + (c.precoViagem ? cotacoesFormatarMoeda(c.precoViagem) : '-') + '</td>' +
          '<td style="text-align: right; font-weight: 700;">' + cotacoesFormatarMoeda(c.total) + '</td>' +
          '<td style="text-align: center;"><span class="cotacoes-badge ' + badgeClass + '">' + c.estado + '</span></td>' +
          '<td class="cotacoes-no-print">' +
            '<div class="cotacoes-actions">' +
              '<button class="cotacoes-action-btn edit" onclick="cotacoesEditar(' + c.id + ')" title="Editar">âœï¸</button>' +
              '<button class="cotacoes-action-btn pdf" onclick="cotacoesGerarPDF(' + c.id + ')" title="PDF">ğŸ“„</button>' +
              '<button class="cotacoes-action-btn duplicate" onclick="cotacoesDuplicar(' + c.id + ')" title="Duplicar">ğŸ“‹</button>' +
              (c.estado === 'Aceite' ? '<button class="cotacoes-action-btn convert" onclick="cotacoesConverter(' + c.id + ')" title="Converter em Reserva">ğŸ”„</button>' : '') +
              '<button class="cotacoes-action-btn delete" onclick="cotacoesEliminar(' + c.id + ')" title="Eliminar">ğŸ—‘ï¸</button>' +
            '</div>' +
          '</td>' +
        '</tr>';
      });
      
      tbody.innerHTML = html;
    }
    
    // Filtros
    function cotacoesAplicarFiltros() {
      var cliente = (document.getElementById('cotacoesFiltroCliente')?.value || '').toLowerCase();
      var estado = document.getElementById('cotacoesFiltroEstado')?.value || '';
      var dataDe = document.getElementById('cotacoesFiltroDataDe')?.value || '';
      var dataAte = document.getElementById('cotacoesFiltroDataAte')?.value || '';
      
      return cotacoesLista.filter(function(c) {
        if (cliente && !c.nomeCliente.toLowerCase().includes(cliente) && !c.numCliente.includes(cliente)) return false;
        if (estado && c.estado !== estado) return false;
        if (dataDe && c.data < dataDe) return false;
        if (dataAte && c.data > dataAte) return false;
        return true;
      });
    }
    
    function cotacoesFiltrar() {
      cotacoesRenderizarTabela();
    }
    
    function cotacoesLimparFiltros() {
      var filtroCliente = document.getElementById('cotacoesFiltroCliente');
      var filtroEstado = document.getElementById('cotacoesFiltroEstado');
      var filtroDataDe = document.getElementById('cotacoesFiltroDataDe');
      var filtroDataAte = document.getElementById('cotacoesFiltroDataAte');
      
      if (filtroCliente) filtroCliente.value = '';
      if (filtroEstado) filtroEstado.value = '';
      if (filtroDataDe) filtroDataDe.value = '';
      if (filtroDataAte) filtroDataAte.value = '';
      
      cotacoesRenderizarTabela();
    }
    
    // OrdenaÃ§Ã£o
    function cotacoesOrdenar(campo) {
      if (cotacoesOrdenacao.campo === campo) {
        cotacoesOrdenacao.direcao = cotacoesOrdenacao.direcao === 'asc' ? 'desc' : 'asc';
      } else {
        cotacoesOrdenacao.campo = campo;
        cotacoesOrdenacao.direcao = 'asc';
      }
      cotacoesRenderizarTabela();
    }
    
    function cotacoesAplicarOrdenacao(lista) {
      var campo = cotacoesOrdenacao.campo;
      var dir = cotacoesOrdenacao.direcao === 'asc' ? 1 : -1;
      
      return lista.sort(function(a, b) {
        var valA = a[campo] || '';
        var valB = b[campo] || '';
        
        if (typeof valA === 'number' && typeof valB === 'number') {
          return (valA - valB) * dir;
        }
        return String(valA).localeCompare(String(valB)) * dir;
      });
    }
    
    // Modal Nova/Editar
    function cotacoesNova() {
      cotacoesLimparModal();
      
      var hoje = new Date().toISOString().split('T')[0];
      var validade = new Date();
      validade.setDate(validade.getDate() + 15);
      
      document.getElementById('cotacoesNumero').value = 'COT-' + new Date().getFullYear() + '-' + String(cotacoesProximoId).padStart(4, '0');
      document.getElementById('cotacoesData').value = hoje;
      document.getElementById('cotacoesValidade').value = validade.toISOString().split('T')[0];
      document.getElementById('cotacoesEstado').value = 'Pendente';
      
      document.getElementById('cotacoesModalTitulo').textContent = 'ğŸ’¶ Nova CotaÃ§Ã£o';
      document.getElementById('cotacoesModalOverlay').style.display = 'flex';
      
      setTimeout(function() {
        document.getElementById('cotacoesNumCliente')?.focus();
      }, 100);
    }
    
    function cotacoesEditar(id) {
      var cotacao = cotacoesLista.find(function(c) { return c.id === id; });
      if (!cotacao) return;
      
      document.getElementById('cotacoesEditId').value = id;
      document.getElementById('cotacoesNumero').value = cotacao.numero;
      document.getElementById('cotacoesData').value = cotacao.data;
      document.getElementById('cotacoesValidade').value = cotacao.validade;
      document.getElementById('cotacoesEstado').value = cotacao.estado;
      document.getElementById('cotacoesNumCliente').value = cotacao.numCliente;
      document.getElementById('cotacoesNomeCliente').value = cotacao.nomeCliente;
      document.getElementById('cotacoesEmailCliente').value = cotacao.emailCliente || '';
      document.getElementById('cotacoesTelCliente').value = cotacao.telCliente || '';
      document.getElementById('cotacoesDescricao').value = cotacao.descricao;
      document.getElementById('cotacoesLocalCarga').value = cotacao.localCarga;
      document.getElementById('cotacoesLocalDescarga').value = cotacao.localDescarga;
      document.getElementById('cotacoesKm').value = cotacao.km || '';
      document.getElementById('cotacoesPrecoKm').value = cotacao.precoKm || '';
      document.getElementById('cotacoesPrecoViagem').value = cotacao.precoViagem || '';
      document.getElementById('cotacoesExtras').value = cotacao.extras || '';
      document.getElementById('cotacoesObs').value = cotacao.obs || '';
      
      cotacoesCalcularTotal();
      
      document.getElementById('cotacoesModalTitulo').textContent = 'âœï¸ Editar CotaÃ§Ã£o ' + cotacao.numero;
      document.getElementById('cotacoesModalOverlay').style.display = 'flex';
    }
    
    function cotacoesFecharModal() {
      document.getElementById('cotacoesModalOverlay').style.display = 'none';
    }
    
    function cotacoesLimparModal() {
      document.getElementById('cotacoesEditId').value = '';
      document.getElementById('cotacoesNumero').value = '';
      document.getElementById('cotacoesNumCliente').value = '';
      document.getElementById('cotacoesNomeCliente').value = '';
      document.getElementById('cotacoesEmailCliente').value = '';
      document.getElementById('cotacoesTelCliente').value = '';
      document.getElementById('cotacoesDescricao').value = '';
      document.getElementById('cotacoesLocalCarga').value = '';
      document.getElementById('cotacoesLocalDescarga').value = '';
      document.getElementById('cotacoesKm').value = '';
      document.getElementById('cotacoesPrecoKm').value = '';
      document.getElementById('cotacoesPrecoViagem').value = '';
      document.getElementById('cotacoesExtras').value = '';
      document.getElementById('cotacoesObs').value = '';
      
      document.getElementById('cotacoesCalcKm').textContent = '0.00 â‚¬';
      document.getElementById('cotacoesCalcViagem').textContent = '0.00 â‚¬';
      document.getElementById('cotacoesCalcExtras').textContent = '0.00 â‚¬';
      document.getElementById('cotacoesCalcTotal').textContent = '0.00 â‚¬';
    }
    
    function cotacoesCalcularTotal() {
      var km = parseFloat(document.getElementById('cotacoesKm')?.value) || 0;
      var precoKm = parseFloat(document.getElementById('cotacoesPrecoKm')?.value) || 0;
      var precoViagem = parseFloat(document.getElementById('cotacoesPrecoViagem')?.value) || 0;
      var extras = parseFloat(document.getElementById('cotacoesExtras')?.value) || 0;
      
      var calcKm = km * precoKm;
      var total = calcKm + precoViagem + extras;
      
      document.getElementById('cotacoesCalcKm').textContent = cotacoesFormatarMoeda(calcKm);
      document.getElementById('cotacoesCalcViagem').textContent = cotacoesFormatarMoeda(precoViagem);
      document.getElementById('cotacoesCalcExtras').textContent = cotacoesFormatarMoeda(extras);
      document.getElementById('cotacoesCalcTotal').textContent = cotacoesFormatarMoeda(total);
    }
    
    function cotacoesGuardar() {
      // ValidaÃ§Ã£o
      var numCliente = document.getElementById('cotacoesNumCliente')?.value?.trim();
      var nomeCliente = document.getElementById('cotacoesNomeCliente')?.value?.trim();
      var data = document.getElementById('cotacoesData')?.value;
      var validade = document.getElementById('cotacoesValidade')?.value;
      var descricao = document.getElementById('cotacoesDescricao')?.value?.trim();
      var localCarga = document.getElementById('cotacoesLocalCarga')?.value?.trim();
      var localDescarga = document.getElementById('cotacoesLocalDescarga')?.value?.trim();
      
      if (!numCliente || !nomeCliente || !data || !validade || !descricao || !localCarga || !localDescarga) {
        alert('âš ï¸ Por favor preencha todos os campos obrigatÃ³rios.');
        return;
      }
      
      var km = parseFloat(document.getElementById('cotacoesKm')?.value) || 0;
      var precoKm = parseFloat(document.getElementById('cotacoesPrecoKm')?.value) || 0;
      var precoViagem = parseFloat(document.getElementById('cotacoesPrecoViagem')?.value) || 0;
      var extras = parseFloat(document.getElementById('cotacoesExtras')?.value) || 0;
      var total = (km * precoKm) + precoViagem + extras;
      
      var editId = document.getElementById('cotacoesEditId')?.value;
      
      if (editId) {
        // Editar existente
        var idx = cotacoesLista.findIndex(function(c) { return c.id === parseInt(editId); });
        if (idx !== -1) {
          cotacoesLista[idx] = {
            ...cotacoesLista[idx],
            data: data,
            validade: validade,
            numCliente: numCliente,
            nomeCliente: nomeCliente,
            emailCliente: document.getElementById('cotacoesEmailCliente')?.value?.trim() || '',
            telCliente: document.getElementById('cotacoesTelCliente')?.value?.trim() || '',
            descricao: descricao,
            localCarga: localCarga,
            localDescarga: localDescarga,
            km: km,
            precoKm: precoKm,
            precoViagem: precoViagem,
            extras: extras,
            total: total,
            estado: document.getElementById('cotacoesEstado')?.value || 'Pendente',
            obs: document.getElementById('cotacoesObs')?.value?.trim() || ''
          };
        }
      } else {
        // Nova cotaÃ§Ã£o
        var novaCotacao = {
          id: cotacoesProximoId,
          numero: 'COT-' + new Date().getFullYear() + '-' + String(cotacoesProximoId).padStart(4, '0'),
          data: data,
          validade: validade,
          numCliente: numCliente,
          nomeCliente: nomeCliente,
          emailCliente: document.getElementById('cotacoesEmailCliente')?.value?.trim() || '',
          telCliente: document.getElementById('cotacoesTelCliente')?.value?.trim() || '',
          descricao: descricao,
          localCarga: localCarga,
          localDescarga: localDescarga,
          km: km,
          precoKm: precoKm,
          precoViagem: precoViagem,
          extras: extras,
          total: total,
          estado: 'Pendente',
          obs: document.getElementById('cotacoesObs')?.value?.trim() || ''
        };
        
        cotacoesLista.unshift(novaCotacao);
        cotacoesProximoId++;
      }
      
      cotacoesGuardarDados();
      cotacoesRenderizar();
      cotacoesFecharModal();
      
      alert('âœ… CotaÃ§Ã£o guardada com sucesso!');
    }
    
    // AÃ§Ãµes
    function cotacoesDuplicar(id) {
      var original = cotacoesLista.find(function(c) { return c.id === id; });
      if (!original) return;
      
      var copia = {
        ...original,
        id: cotacoesProximoId,
        numero: 'COT-' + new Date().getFullYear() + '-' + String(cotacoesProximoId).padStart(4, '0'),
        data: new Date().toISOString().split('T')[0],
        validade: (function() { var d = new Date(); d.setDate(d.getDate() + 15); return d.toISOString().split('T')[0]; })(),
        estado: 'Pendente'
      };
      
      cotacoesLista.unshift(copia);
      cotacoesProximoId++;
      
      cotacoesGuardarDados();
      cotacoesRenderizar();
      
      alert('âœ… CotaÃ§Ã£o duplicada: ' + copia.numero);
    }
    
    function cotacoesEliminar(id) {
      var cotacao = cotacoesLista.find(function(c) { return c.id === id; });
      if (!cotacao) return;
      
      if (!confirm('âš ï¸ Tem certeza que deseja eliminar a cotaÃ§Ã£o ' + cotacao.numero + '?\n\nEsta aÃ§Ã£o nÃ£o pode ser desfeita.')) {
        return;
      }
      
      cotacoesLista = cotacoesLista.filter(function(c) { return c.id !== id; });
      cotacoesGuardarDados();
      cotacoesRenderizar();
      
      alert('âœ… CotaÃ§Ã£o eliminada.');
    }
    
    function cotacoesGerarPDF(id) {
      var cotacao = cotacoesLista.find(function(c) { return c.id === id; });
      if (!cotacao) return;
      
      // Simular impressÃ£o/PDF
      var conteudo = 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n' +
                     '           COTAÃ‡ÃƒO ' + cotacao.numero + '\n' +
                     'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n' +
                     'Data: ' + cotacoesFormatarData(cotacao.data) + '\n' +
                     'Validade: ' + cotacoesFormatarData(cotacao.validade) + '\n\n' +
                     'CLIENTE\n' +
                     'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n' +
                     'NÂº: ' + cotacao.numCliente + '\n' +
                     'Nome: ' + cotacao.nomeCliente + '\n' +
                     'Email: ' + (cotacao.emailCliente || '-') + '\n' +
                     'Tel: ' + (cotacao.telCliente || '-') + '\n\n' +
                     'SERVIÃ‡O\n' +
                     'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n' +
                     'DescriÃ§Ã£o: ' + cotacao.descricao + '\n' +
                     'Carga: ' + cotacao.localCarga + '\n' +
                     'Descarga: ' + cotacao.localDescarga + '\n\n' +
                     'VALORES\n' +
                     'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n' +
                     'DistÃ¢ncia: ' + cotacao.km + ' km\n' +
                     'â‚¬/Km: ' + cotacoesFormatarMoeda(cotacao.precoKm) + '\n' +
                     'â‚¬/Viagem: ' + cotacoesFormatarMoeda(cotacao.precoViagem) + '\n' +
                     'Extras: ' + cotacoesFormatarMoeda(cotacao.extras) + '\n' +
                     'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n' +
                     'TOTAL: ' + cotacoesFormatarMoeda(cotacao.total) + '\n\n' +
                     'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n' +
                     '         EMEUTRANS - Transportes\n' +
                     'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•';
      
      alert('ğŸ“„ PDF da CotaÃ§Ã£o (Preview)\n\n' + conteudo + '\n\nğŸ’¡ Na versÃ£o com backend, isto geraria um PDF real para download/email.');
    }
    
    // Converter em Reserva
    function cotacoesConverter(id) {
      var cotacao = cotacoesLista.find(function(c) { return c.id === id; });
      if (!cotacao) return;
      
      document.getElementById('cotacoesConverterId').value = id;
      document.getElementById('cotacoesConverterNumero').textContent = cotacao.numero;
      document.getElementById('cotacoesConverterCliente').textContent = cotacao.numCliente + ' - ' + cotacao.nomeCliente;
      document.getElementById('cotacoesConverterValor').textContent = cotacoesFormatarMoeda(cotacao.total);
      document.getElementById('cotacoesConverterData').value = new Date().toISOString().split('T')[0];
      
      document.getElementById('cotacoesModalConverterOverlay').style.display = 'flex';
    }
    
    function cotacoesFecharModalConverter() {
      document.getElementById('cotacoesModalConverterOverlay').style.display = 'none';
    }
    
    function cotacoesConfirmarConversao() {
      var id = parseInt(document.getElementById('cotacoesConverterId')?.value);
      var dataReserva = document.getElementById('cotacoesConverterData')?.value;
      
      if (!dataReserva) {
        alert('âš ï¸ Por favor selecione a data da reserva.');
        return;
      }
      
      var cotacao = cotacoesLista.find(function(c) { return c.id === id; });
      if (!cotacao) return;
      
      // Atualizar estado para Convertida
      cotacao.estado = 'Convertida';
      cotacoesGuardarDados();
      cotacoesRenderizar();
      
      cotacoesFecharModalConverter();
      
      alert('âœ… CotaÃ§Ã£o ' + cotacao.numero + ' convertida em reserva!\n\n' +
            'ğŸ“¦ Uma nova reserva foi criada com os dados:\n' +
            'â€¢ Cliente: ' + cotacao.numCliente + ' - ' + cotacao.nomeCliente + '\n' +
            'â€¢ Carga: ' + cotacao.localCarga + '\n' +
            'â€¢ Descarga: ' + cotacao.localDescarga + '\n' +
            'â€¢ Valor: ' + cotacoesFormatarMoeda(cotacao.total) + '\n\n' +
            'ğŸ’¡ Abra o mÃ³dulo Reservas para completar os detalhes.');
    }
    
    // Pesquisar Cliente
    function cotacoesPesquisarCliente() {
      alert('ğŸ” Pesquisa de Clientes\n\nEsta funcionalidade irÃ¡ abrir uma modal de pesquisa no mÃ³dulo Clientes.\n\nğŸ’¡ Na versÃ£o com backend, isto pesquisaria a base de dados de clientes.');
    }
    
    // Exportar Excel
    function cotacoesExportarExcel() {
      alert('ğŸ“¥ Exportar para Excel\n\nEsta funcionalidade gerarÃ¡ um ficheiro Excel com todas as cotaÃ§Ãµes.\n\nğŸ’¡ Na versÃ£o com backend, isto criaria um ficheiro .xlsx para download.\n\nPor agora, pode usar Ctrl+P para imprimir/guardar PDF.');
    }
    
    // NavegaÃ§Ã£o por Teclado
    function cotacoesSetupNavegacaoTeclado() {
      var modal = document.getElementById('cotacoesModalOverlay');
      if (!modal) return;
      
      modal.addEventListener('keydown', function(e) {
        var inputs = Array.from(modal.querySelectorAll('input:not([type="hidden"]):not([readonly]), select, textarea'));
        var idx = inputs.indexOf(document.activeElement);
        
        if (e.key === 'Enter' && !e.shiftKey && document.activeElement.tagName !== 'TEXTAREA') {
          e.preventDefault();
          if (idx < inputs.length - 1) {
            inputs[idx + 1].focus();
          }
        }
        
        if (e.key === 'ArrowDown' && document.activeElement.tagName !== 'SELECT' && document.activeElement.tagName !== 'TEXTAREA') {
          e.preventDefault();
          if (idx < inputs.length - 1) {
            inputs[idx + 1].focus();
          }
        }
        
        if (e.key === 'ArrowUp' && document.activeElement.tagName !== 'SELECT' && document.activeElement.tagName !== 'TEXTAREA') {
          e.preventDefault();
          if (idx > 0) {
            inputs[idx - 1].focus();
          }
        }
        
        if (e.key === 'Escape') {
          cotacoesFecharModal();
        }
      });
    }
    
    // UtilitÃ¡rios
    function cotacoesFormatarMoeda(valor) {
      return (valor || 0).toFixed(2).replace('.', ',') + ' â‚¬';
    }
    
    function cotacoesFormatarData(data) {
      if (!data) return '-';
      var partes = data.split('-');
      return partes[2] + '/' + partes[1] + '/' + partes[0];
    }
    
    // Inicializar quando pÃ¡gina CotaÃ§Ãµes for aberta
    var cotacoesInitializado = false;
    var originalNavegarPara = window.navegarPara;
    window.navegarPara = function(pagina) {
      originalNavegarPara(pagina);
      if (pagina === 'cotacoes' && !cotacoesInitializado) {
        setTimeout(function() {
          cotacoesInit();
          cotacoesInitializado = true;
        }, 100);
      }
      if (pagina === 'clientes') {
        setTimeout(function() {
          // Sempre chamar clientesInit e clientesAtualizarLista
          if (typeof clientesInit === 'function') {
            clientesInit();
          }
          // Garantir que a tabela Ã© atualizada mesmo se clientesInit falhar
          if (typeof clientesAtualizarLista === 'function') {
            clientesAtualizarLista();
          }
          console.log('ğŸ“‹ MÃ³dulo Clientes: navegaÃ§Ã£o concluÃ­da, clientes: ' + (window.clientesLista ? window.clientesLista.length : 0));
        }, 150);
      }
    };

    /* â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
       â•‘  â›”â›”â›” MÃ“DULO PROTEGIDO - GESTÃƒO DE CLIENTES v1.0 â›”â›”â›”                       â•‘
       â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
       â•‘  Data de CriaÃ§Ã£o: 22/12/2024                                                     â•‘
       â•‘  Ãšltima AtualizaÃ§Ã£o: 22/12/2024                                                  â•‘
       â•‘  Testado e Validado: SIM                                                         â•‘
       â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
       â•‘  âš ï¸  AVISO: Este cÃ³digo estÃ¡ PROTEGIDO e ENCAPSULADO                            â•‘
       â•‘  âš ï¸  NÃƒO MODIFICAR sem autorizaÃ§Ã£o e testes completos                           â•‘
       â•‘  âš ï¸  Qualquer alteraÃ§Ã£o pode quebrar funcionalidades crÃ­ticas                   â•‘
       â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
       â•‘  FUNCIONALIDADES IMPLEMENTADAS:                                                  â•‘
       â•‘  âœ… VisualizaÃ§Ã£o de ficha com campos bloqueados (modo OLHO)                     â•‘
       â•‘  âœ… EdiÃ§Ã£o de ficha com desbloqueio (botÃ£o ALTERAR CLIENTE)                     â•‘
       â•‘  âœ… ConfirmaÃ§Ã£o de gravaÃ§Ã£o com verificaÃ§Ã£o                                      â•‘
       â•‘  âœ… Pergunta ao sair se existem alteraÃ§Ãµes nÃ£o guardadas                        â•‘
       â•‘  âœ… Preenchimento automÃ¡tico de todos os campos                                 â•‘
       â•‘  âœ… 10 clientes de teste com dados completos                                    â•‘
       â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // INÃCIO DO MÃ“DULO PROTEGIDO - IIFE (Immediately Invoked Function Expression)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    (function(window) {
        'use strict';
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // VARIÃVEIS PRIVADAS (nÃ£o acessÃ­veis fora do mÃ³dulo)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    // VariÃ¡veis Globais
    var clientesLista = [];
    var clientesEditando = false;
    var clientesAtual = null;
    var clientesParaEliminar = null;
    var clientesProximoNumero = 1000;
    var clientesFicheirosIncidencias = [];
    var clientesFicheirosAnexosGerais = [];
    var clientesFicheirosSeguro = [];
    var clientesInitializado = false;
    var clientesModoVisualizacao = false;
    var clientesDadosAlterados = false;
    
    // Faturas em dÃ­vida (simulaÃ§Ã£o)
    var clientesFaturasDivida = {
        'C0001': [
            { data_emissao: '2025-01-15', numero: 'FT2025/001', descricao: 'ServiÃ§os logÃ­sticos Janeiro', valor: 2500.00, vencimento: '2025-02-15' },
            { data_emissao: '2025-02-10', numero: 'FT2025/015', descricao: 'Transporte internacional', valor: 4200.00, vencimento: '2025-03-12' },
        ],
        'C0002': [
            { data_emissao: '2025-01-20', numero: 'FT2025/008', descricao: 'ServiÃ§os de armazenagem', valor: 1800.00, vencimento: '2025-03-05' },
        ],
        'C0003': [
            { data_emissao: '2024-11-05', numero: 'FT2024/198', descricao: 'DistribuiÃ§Ã£o Norte', valor: 5500.00, vencimento: '2024-12-05' },
            { data_emissao: '2024-12-10', numero: 'FT2024/215', descricao: 'ServiÃ§os Dezembro', valor: 3200.00, vencimento: '2025-01-10' },
        ]
    };
    
    // InicializaÃ§Ã£o
    function clientesInit() {
        // Sempre recarregar dados para garantir que estÃ£o atualizados
        clientesCarregarDados();
        
        // Atualizar a tabela
        clientesAtualizarLista();
        
        // Atualizar nÃºmero do prÃ³ximo cliente
        var numInput = document.getElementById('clientes_numero_cliente');
        if (numInput) numInput.value = clientesObterProximoNumero();
        
        // Setup navegaÃ§Ã£o por teclado (sÃ³ uma vez)
        if (!clientesInitializado) {
            clientesSetupNavegacaoTeclado();
            clientesInitializado = true;
        }
        
        // Sincronizar lista global para outros mÃ³dulos
        window.clientesLista = clientesLista;
        console.log('âœ… MÃ³dulo Clientes inicializado: ' + clientesLista.length + ' clientes (C0001-C0010)');
    }
    
    // localStorage
    function clientesCarregarDados() {
        try {
            var dados = localStorage.getItem('erpClientes');
            if (dados) {
                var parsed = JSON.parse(dados);
                clientesLista = parsed.lista || [];
                clientesProximoNumero = parsed.proximoNumero || 1000;
            }
        } catch (e) {
            console.error('Erro ao carregar clientes:', e);
        }
        
        // SEMPRE recriar os 10 clientes de teste para garantir que existem
        // Remover clientes de teste antigos (C1001-C1010 e C0001-C0010) e recriar
        clientesLista = clientesLista.filter(function(c) {
            return !['C1001','C1002','C1003','C1004','C1005','C1006','C1007','C1008','C1009','C1010',
                     'C0001','C0002','C0003','C0004','C0005','C0006','C0007','C0008','C0009','C0010'].includes(c.numero);
        });
        
        // 10 Clientes de Teste Completos - TODOS OS CAMPOS PREENCHIDOS
        var clientesTeste = [
            {
                numero: 'C0001',
                nome_completo: 'Transportes RÃ¡pidos do Norte, Lda',
                contribuinte: '501234567',
                pais: 'Portugal',
                tipo_pais: 'nacional',
                status: 'Ativo',
                plafonds_atribuidos: 50000,
                prazo_pagamento_dias: 30,
                modo_faturacao: 'Manual',
                faturacao_prevista_mensal: 15000,
                conta_sap: '21111001',
                valor_faturado_ano: 125000,
                // Sede
                sede_rua: 'Rua da IndÃºstria',
                sede_porta: '123',
                sede_lugar: 'Zona Industrial de CeleirÃ³s',
                sede_cidade: 'Braga',
                sede_freguesia: 'CeleirÃ³s',
                sede_cp: '4705-419',
                sede_concelho: 'Braga',
                // Contactos
                telefone_geral: '+351 253 123 456',
                telefone_direto: '+351 253 123 457',
                fax: '+351 253 123 458',
                telemovel_geral: '+351 912 345 678',
                email_geral: 'geral@trn-transportes.pt',
                website: 'www.trn-transportes.pt',
                // ResponsÃ¡vel Dono/Gerente
                resp_dono_nome: 'AntÃ³nio Manuel Silva',
                resp_dono_cargo: 'Gerente',
                resp_dono_email: 'antonio.silva@trn-transportes.pt',
                resp_dono_telefone: '+351 253 123 460',
                resp_dono_telemovel: '+351 912 345 678',
                // ResponsÃ¡vel Contabilidade
                resp_contabilidade_nome: 'Maria JosÃ© Santos',
                resp_contabilidade_cargo: 'Diretora Financeira',
                resp_contabilidade_email: 'contabilidade@trn-transportes.pt',
                resp_contabilidade_telefone: '+351 253 123 461',
                resp_contabilidade_telemovel: '+351 913 456 789',
                // ResponsÃ¡vel Financeiro
                resp_financeiro_nome: 'JoÃ£o Pedro Ferreira',
                resp_financeiro_cargo: 'Controller',
                resp_financeiro_email: 'financeiro@trn-transportes.pt',
                resp_financeiro_telefone: '+351 253 123 462',
                resp_financeiro_telemovel: '+351 914 567 890',
                // ResponsÃ¡vel LogÃ­stica
                resp_logistica_nome: 'Pedro Miguel Costa',
                resp_logistica_cargo: 'Diretor de OperaÃ§Ãµes',
                resp_logistica_email: 'logistica@trn-transportes.pt',
                resp_logistica_telefone: '+351 253 123 463',
                resp_logistica_telemovel: '+351 915 678 901',
                // Comercial
                nome_angariador: 'Carlos Mendes',
                // Dados BancÃ¡rios
                banco1: 'Millennium BCP',
                iban1: 'PT50 0033 0000 12345678901 23',
                swift1: 'BCOMPTPL',
                banco2: 'CGD',
                iban2: 'PT50 0035 0000 98765432109 87',
                swift2: 'CGDIPTPL',
                num_conta_bancaria: 'PT50 0033 0000 12345678901 23',
                // Outros
                observacoes: 'Cliente desde 2015. Especializado em transporte de mercadorias para o Norte da PenÃ­nsula IbÃ©rica.',
                data_registo: '2015-03-15'
            },
            {
                numero: 'C0002',
                nome_completo: 'LogÃ­stica Centro Sul, SA',
                contribuinte: '502345678',
                pais: 'Portugal',
                tipo_pais: 'nacional',
                status: 'Ativo',
                plafonds_atribuidos: 75000,
                prazo_pagamento_dias: 45,
                modo_faturacao: 'AutomÃ¡tica',
                faturacao_prevista_mensal: 25000,
                conta_sap: '21111002',
                valor_faturado_ano: 189000,
                // Sede
                sede_rua: 'Avenida da RepÃºblica',
                sede_porta: '456',
                sede_lugar: 'EdifÃ­cio Empresarial Torre Sul',
                sede_cidade: 'Lisboa',
                sede_freguesia: 'Alvalade',
                sede_cp: '1050-191',
                sede_concelho: 'Lisboa',
                // Contactos
                telefone_geral: '+351 213 456 789',
                telefone_direto: '+351 213 456 790',
                fax: '+351 213 456 791',
                telemovel_geral: '+351 913 456 789',
                email_geral: 'geral@lcs-logistica.pt',
                website: 'www.lcs-logistica.pt',
                // ResponsÃ¡vel Dono/Gerente
                resp_dono_nome: 'Manuel AntÃ³nio Rodrigues',
                resp_dono_cargo: 'Administrador',
                resp_dono_email: 'manuel.rodrigues@lcs-logistica.pt',
                resp_dono_telefone: '+351 213 456 792',
                resp_dono_telemovel: '+351 913 456 789',
                // ResponsÃ¡vel Contabilidade
                resp_contabilidade_nome: 'Ana Cristina Pereira',
                resp_contabilidade_cargo: 'Contabilista Certificada',
                resp_contabilidade_email: 'contabilidade@lcs-logistica.pt',
                resp_contabilidade_telefone: '+351 213 456 793',
                resp_contabilidade_telemovel: '+351 924 567 890',
                // ResponsÃ¡vel Financeiro
                resp_financeiro_nome: 'Rui Miguel Almeida',
                resp_financeiro_cargo: 'CFO',
                resp_financeiro_email: 'financeiro@lcs-logistica.pt',
                resp_financeiro_telefone: '+351 213 456 794',
                resp_financeiro_telemovel: '+351 935 678 901',
                // ResponsÃ¡vel LogÃ­stica
                resp_logistica_nome: 'Carla Sofia Sousa',
                resp_logistica_cargo: 'Gestora de Frota',
                resp_logistica_email: 'operacoes@lcs-logistica.pt',
                resp_logistica_telefone: '+351 213 456 795',
                resp_logistica_telemovel: '+351 946 789 012',
                // Comercial
                nome_angariador: 'Carlos Mendes',
                // Dados BancÃ¡rios
                banco1: 'Novo Banco',
                iban1: 'PT50 0007 0000 23456789012 34',
                swift1: 'BESCPTPL',
                banco2: 'Santander',
                iban2: 'PT50 0018 0000 87654321098 76',
                swift2: 'TOTAPTPL',
                num_conta_bancaria: 'PT50 0007 0000 23456789012 34',
                // Outros
                observacoes: 'Grande cliente. Necessita de faturaÃ§Ã£o automÃ¡tica por CMR. Contrato anual renovÃ¡vel.',
                data_registo: '2018-06-20'
            },
            {
                numero: 'C0003',
                nome_completo: 'Mercadorias IbÃ©ricas, Lda',
                contribuinte: '503456789',
                pais: 'Portugal',
                tipo_pais: 'nacional',
                status: 'Ativo',
                plafonds_atribuidos: 60000,
                prazo_pagamento_dias: 30,
                modo_faturacao: 'Manual',
                faturacao_prevista_mensal: 18000,
                conta_sap: '21111003',
                valor_faturado_ano: 156000,
                // Sede
                sede_rua: 'Rua do ComÃ©rcio',
                sede_porta: '78',
                sede_lugar: 'Baixa do Porto',
                sede_cidade: 'Porto',
                sede_freguesia: 'Cedofeita',
                sede_cp: '4050-287',
                sede_concelho: 'Porto',
                // Contactos
                telefone_geral: '+351 222 567 890',
                telefone_direto: '+351 222 567 891',
                fax: '+351 222 567 892',
                telemovel_geral: '+351 914 567 890',
                email_geral: 'geral@mercadorias-ibericas.pt',
                website: 'www.mercadorias-ibericas.pt',
                // ResponsÃ¡vel Dono/Gerente
                resp_dono_nome: 'Fernando JosÃ© Oliveira',
                resp_dono_cargo: 'SÃ³cio-Gerente',
                resp_dono_email: 'fernando.oliveira@mercadorias-ibericas.pt',
                resp_dono_telefone: '+351 222 567 893',
                resp_dono_telemovel: '+351 914 567 890',
                // ResponsÃ¡vel Contabilidade
                resp_contabilidade_nome: 'Teresa Maria Lima',
                resp_contabilidade_cargo: 'ResponsÃ¡vel Contabilidade',
                resp_contabilidade_email: 'contabilidade@mercadorias-ibericas.pt',
                resp_contabilidade_telefone: '+351 222 567 894',
                resp_contabilidade_telemovel: '+351 925 678 901',
                // ResponsÃ¡vel Financeiro
                resp_financeiro_nome: 'Paulo Jorge Martins',
                resp_financeiro_cargo: 'Tesoureiro',
                resp_financeiro_email: 'tesouraria@mercadorias-ibericas.pt',
                resp_financeiro_telefone: '+351 222 567 895',
                resp_financeiro_telemovel: '+351 936 789 012',
                // ResponsÃ¡vel LogÃ­stica
                resp_logistica_nome: 'Sandra Cristina Ribeiro',
                resp_logistica_cargo: 'Coordenadora LogÃ­stica',
                resp_logistica_email: 'logistica@mercadorias-ibericas.pt',
                resp_logistica_telefone: '+351 222 567 896',
                resp_logistica_telemovel: '+351 947 890 123',
                // Comercial
                nome_angariador: 'Ana Lopes',
                // Dados BancÃ¡rios
                banco1: 'BPI',
                iban1: 'PT50 0010 0000 34567890123 45',
                swift1: 'BBPIPTPL',
                banco2: '',
                iban2: '',
                swift2: '',
                num_conta_bancaria: 'PT50 0010 0000 34567890123 45',
                // Outros
                observacoes: 'Empresa familiar. Transporte de mercadorias para Espanha (Madrid, Barcelona, Sevilha).',
                data_registo: '2017-02-10'
            },
            {
                numero: 'C0004',
                nome_completo: 'DistribuiÃ§Ã£o Expressa Porto, SA',
                contribuinte: '504567890',
                pais: 'Portugal',
                tipo_pais: 'nacional',
                status: 'Ativo',
                plafonds_atribuidos: 80000,
                prazo_pagamento_dias: 60,
                modo_faturacao: 'Manual',
                faturacao_prevista_mensal: 30000,
                conta_sap: '21111004',
                valor_faturado_ano: 267000,
                // Sede
                sede_rua: 'Avenida da Boavista',
                sede_porta: '1500',
                sede_lugar: 'EdifÃ­cio Burgo',
                sede_cidade: 'Porto',
                sede_freguesia: 'Lordelo do Ouro',
                sede_cp: '4100-130',
                sede_concelho: 'Porto',
                // Contactos
                telefone_geral: '+351 226 789 012',
                telefone_direto: '+351 226 789 013',
                fax: '+351 226 789 014',
                telemovel_geral: '+351 915 789 012',
                email_geral: 'geral@dep-express.pt',
                website: 'www.dep-express.pt',
                // ResponsÃ¡vel Dono/Gerente
                resp_dono_nome: 'Ricardo Nuno Nunes',
                resp_dono_cargo: 'Presidente do CA',
                resp_dono_email: 'ricardo.nunes@dep-express.pt',
                resp_dono_telefone: '+351 226 789 015',
                resp_dono_telemovel: '+351 915 789 012',
                // ResponsÃ¡vel Contabilidade
                resp_contabilidade_nome: 'LuÃ­sa Fernanda Cardoso',
                resp_contabilidade_cargo: 'Diretora Administrativa',
                resp_contabilidade_email: 'contabilidade@dep-express.pt',
                resp_contabilidade_telefone: '+351 226 789 016',
                resp_contabilidade_telemovel: '+351 926 890 123',
                // ResponsÃ¡vel Financeiro
                resp_financeiro_nome: 'Bruno Alexandre Fonseca',
                resp_financeiro_cargo: 'Diretor Financeiro',
                resp_financeiro_email: 'financeiro@dep-express.pt',
                resp_financeiro_telefone: '+351 226 789 017',
                resp_financeiro_telemovel: '+351 937 901 234',
                // ResponsÃ¡vel LogÃ­stica
                resp_logistica_nome: 'Marta Isabel Vieira',
                resp_logistica_cargo: 'Diretora de OperaÃ§Ãµes',
                resp_logistica_email: 'operacoes@dep-express.pt',
                resp_logistica_telefone: '+351 226 789 018',
                resp_logistica_telemovel: '+351 948 012 345',
                // Comercial
                nome_angariador: 'Ana Lopes',
                // Dados BancÃ¡rios
                banco1: 'Millennium BCP',
                iban1: 'PT50 0033 0000 45678901234 56',
                swift1: 'BCOMPTPL',
                banco2: 'CrÃ©dito AgrÃ­cola',
                iban2: 'PT50 0045 0000 65432109876 54',
                swift2: 'CCCMPTPL',
                num_conta_bancaria: 'PT50 0033 0000 45678901234 56',
                // Outros
                observacoes: 'Cliente premium. Frota prÃ³pria de 25 veÃ­culos. Necessita entregas urgentes 24h.',
                data_registo: '2016-09-05'
            },
            {
                numero: 'C0005',
                nome_completo: 'Cargas Pesadas Alentejo, Lda',
                contribuinte: '505678901',
                pais: 'Portugal',
                tipo_pais: 'nacional',
                status: 'Ativo',
                plafonds_atribuidos: 45000,
                prazo_pagamento_dias: 30,
                modo_faturacao: 'Manual',
                faturacao_prevista_mensal: 12000,
                conta_sap: '21111005',
                valor_faturado_ano: 98000,
                // Sede
                sede_rua: 'Rua de SÃ£o Francisco',
                sede_porta: '25',
                sede_lugar: 'Centro HistÃ³rico',
                sede_cidade: 'Ã‰vora',
                sede_freguesia: 'SÃ© e SÃ£o Pedro',
                sede_cp: '7000-137',
                sede_concelho: 'Ã‰vora',
                // Contactos
                telefone_geral: '+351 266 890 123',
                telefone_direto: '+351 266 890 124',
                fax: '+351 266 890 125',
                telemovel_geral: '+351 916 890 123',
                email_geral: 'geral@cpa-cargas.pt',
                website: 'www.cpa-cargas.pt',
                // ResponsÃ¡vel Dono/Gerente
                resp_dono_nome: 'Joaquim Alberto Pinto',
                resp_dono_cargo: 'Gerente',
                resp_dono_email: 'joaquim.pinto@cpa-cargas.pt',
                resp_dono_telefone: '+351 266 890 126',
                resp_dono_telemovel: '+351 916 890 123',
                // ResponsÃ¡vel Contabilidade
                resp_contabilidade_nome: 'Isabel Maria Gomes',
                resp_contabilidade_cargo: 'TOC',
                resp_contabilidade_email: 'contabilidade@cpa-cargas.pt',
                resp_contabilidade_telefone: '+351 266 890 127',
                resp_contabilidade_telemovel: '+351 927 901 234',
                // ResponsÃ¡vel Financeiro
                resp_financeiro_nome: 'Tiago Filipe Lopes',
                resp_financeiro_cargo: 'ResponsÃ¡vel Pagamentos',
                resp_financeiro_email: 'pagamentos@cpa-cargas.pt',
                resp_financeiro_telefone: '+351 266 890 128',
                resp_financeiro_telemovel: '+351 938 012 345',
                // ResponsÃ¡vel LogÃ­stica
                resp_logistica_nome: 'Filipa Alexandra Rocha',
                resp_logistica_cargo: 'Gestora Operacional',
                resp_logistica_email: 'operacoes@cpa-cargas.pt',
                resp_logistica_telefone: '+351 266 890 129',
                resp_logistica_telemovel: '+351 949 123 456',
                // Comercial
                nome_angariador: 'Miguel Santos',
                // Dados BancÃ¡rios
                banco1: 'CGD',
                iban1: 'PT50 0035 0000 56789012345 67',
                swift1: 'CGDIPTPL',
                banco2: '',
                iban2: '',
                swift2: '',
                num_conta_bancaria: 'PT50 0035 0000 56789012345 67',
                // Outros
                observacoes: 'Especialista em cargas pesadas e granÃ©is. Possui licenÃ§a ADR para mercadorias perigosas.',
                data_registo: '2019-04-22'
            },
            {
                numero: 'C0006',
                nome_completo: 'FrigorÃ­ficos do Minho, SA',
                contribuinte: '506789012',
                pais: 'Portugal',
                tipo_pais: 'nacional',
                status: 'Ativo',
                plafonds_atribuidos: 90000,
                prazo_pagamento_dias: 45,
                modo_faturacao: 'AutomÃ¡tica',
                faturacao_prevista_mensal: 35000,
                conta_sap: '21111006',
                valor_faturado_ano: 312000,
                // Sede
                sede_rua: 'Parque Industrial do Ave',
                sede_porta: 'Lote 15',
                sede_lugar: 'Zona Industrial de Lordelo',
                sede_cidade: 'GuimarÃ£es',
                sede_freguesia: 'Lordelo',
                sede_cp: '4810-429',
                sede_concelho: 'GuimarÃ£es',
                // Contactos
                telefone_geral: '+351 253 901 234',
                telefone_direto: '+351 253 901 235',
                fax: '+351 253 901 236',
                telemovel_geral: '+351 917 901 234',
                email_geral: 'geral@frigorificos-minho.pt',
                website: 'www.frigorificos-minho.pt',
                // ResponsÃ¡vel Dono/Gerente
                resp_dono_nome: 'Alberto JosÃ© Machado',
                resp_dono_cargo: 'CEO',
                resp_dono_email: 'alberto.machado@frigorificos-minho.pt',
                resp_dono_telefone: '+351 253 901 237',
                resp_dono_telemovel: '+351 917 901 234',
                // ResponsÃ¡vel Contabilidade
                resp_contabilidade_nome: 'Cristina Sofia Fernandes',
                resp_contabilidade_cargo: 'Diretora Financeira',
                resp_contabilidade_email: 'contabilidade@frigorificos-minho.pt',
                resp_contabilidade_telefone: '+351 253 901 238',
                resp_contabilidade_telemovel: '+351 928 012 345',
                // ResponsÃ¡vel Financeiro
                resp_financeiro_nome: 'Nuno Ricardo Barbosa',
                resp_financeiro_cargo: 'Controller',
                resp_financeiro_email: 'financeiro@frigorificos-minho.pt',
                resp_financeiro_telefone: '+351 253 901 239',
                resp_financeiro_telemovel: '+351 939 123 456',
                // ResponsÃ¡vel LogÃ­stica
                resp_logistica_nome: 'Vera LÃºcia Moreira',
                resp_logistica_cargo: 'Diretora LogÃ­stica',
                resp_logistica_email: 'logistica@frigorificos-minho.pt',
                resp_logistica_telefone: '+351 253 901 240',
                resp_logistica_telemovel: '+351 940 234 567',
                // Comercial
                nome_angariador: 'Miguel Santos',
                // Dados BancÃ¡rios
                banco1: 'Santander',
                iban1: 'PT50 0018 0000 67890123456 78',
                swift1: 'TOTAPTPL',
                banco2: 'BPI',
                iban2: 'PT50 0010 0000 76543210987 65',
                swift2: 'BBPIPTPL',
                num_conta_bancaria: 'PT50 0018 0000 67890123456 78',
                // Outros
                observacoes: 'Transporte refrigerado. Necessita veÃ­culos com controlo de temperatura -18Â°C a +4Â°C.',
                data_registo: '2014-11-30'
            },
            {
                numero: 'C0007',
                nome_completo: 'TransLusitÃ¢nia - Transportes Internacionais, Lda',
                contribuinte: '507890123',
                pais: 'Portugal',
                tipo_pais: 'nacional',
                status: 'Ativo',
                plafonds_atribuidos: 120000,
                prazo_pagamento_dias: 60,
                modo_faturacao: 'AutomÃ¡tica',
                faturacao_prevista_mensal: 45000,
                conta_sap: '21111007',
                valor_faturado_ano: 423000,
                // Sede
                sede_rua: 'Zona Industrial da Maia',
                sede_porta: 'ArmazÃ©m 8',
                sede_lugar: 'Parque Empresarial da Maia',
                sede_cidade: 'Maia',
                sede_freguesia: 'Moreira',
                sede_cp: '4470-177',
                sede_concelho: 'Maia',
                // Contactos
                telefone_geral: '+351 229 012 345',
                telefone_direto: '+351 229 012 346',
                fax: '+351 229 012 347',
                telemovel_geral: '+351 918 012 345',
                email_geral: 'geral@translusitania.pt',
                website: 'www.translusitania.pt',
                // ResponsÃ¡vel Dono/Gerente
                resp_dono_nome: 'VÃ­tor Manuel Campos',
                resp_dono_cargo: 'Administrador Delegado',
                resp_dono_email: 'vitor.campos@translusitania.pt',
                resp_dono_telefone: '+351 229 012 348',
                resp_dono_telemovel: '+351 918 012 345',
                // ResponsÃ¡vel Contabilidade
                resp_contabilidade_nome: 'PatrÃ­cia Alexandra Reis',
                resp_contabilidade_cargo: 'Diretora Administrativa',
                resp_contabilidade_email: 'contabilidade@translusitania.pt',
                resp_contabilidade_telefone: '+351 229 012 349',
                resp_contabilidade_telemovel: '+351 929 123 456',
                // ResponsÃ¡vel Financeiro
                resp_financeiro_nome: 'SÃ©rgio Paulo Teixeira',
                resp_financeiro_cargo: 'CFO',
                resp_financeiro_email: 'financeiro@translusitania.pt',
                resp_financeiro_telefone: '+351 229 012 350',
                resp_financeiro_telemovel: '+351 930 234 567',
                // ResponsÃ¡vel LogÃ­stica
                resp_logistica_nome: 'Helena Cristina Cunha',
                resp_logistica_cargo: 'COO',
                resp_logistica_email: 'operacoes@translusitania.pt',
                resp_logistica_telefone: '+351 229 012 351',
                resp_logistica_telemovel: '+351 941 345 678',
                // Comercial
                nome_angariador: 'Carlos Mendes',
                // Dados BancÃ¡rios
                banco1: 'Novo Banco',
                iban1: 'PT50 0007 0000 78901234567 89',
                swift1: 'BESCPTPL',
                banco2: 'CGD',
                iban2: 'PT50 0035 0000 87654321098 76',
                swift2: 'CGDIPTPL',
                num_conta_bancaria: 'PT50 0007 0000 78901234567 89',
                // Outros
                observacoes: 'Maior cliente. Transporte internacional para toda a Europa. GPS Frotcom ativo. FaturaÃ§Ã£o automÃ¡tica.',
                data_registo: '2012-01-15'
            },
            {
                numero: 'C0008',
                nome_completo: 'Cimentos & Inertes do Douro, SA',
                contribuinte: '508901234',
                pais: 'Portugal',
                tipo_pais: 'nacional',
                status: 'Bloqueado',
                plafonds_atribuidos: 40000,
                prazo_pagamento_dias: 30,
                modo_faturacao: 'Manual',
                faturacao_prevista_mensal: 10000,
                conta_sap: '21111008',
                valor_faturado_ano: 67000,
                // Sede
                sede_rua: 'Estrada Nacional 222',
                sede_porta: 'Km 45',
                sede_lugar: 'Pedreira de Godim',
                sede_cidade: 'Peso da RÃ©gua',
                sede_freguesia: 'Godim',
                sede_cp: '5050-255',
                sede_concelho: 'Peso da RÃ©gua',
                // Contactos
                telefone_geral: '+351 254 123 456',
                telefone_direto: '+351 254 123 457',
                fax: '+351 254 123 458',
                telemovel_geral: '+351 919 123 456',
                email_geral: 'geral@cid-cimentos.pt',
                website: 'www.cid-cimentos.pt',
                // ResponsÃ¡vel Dono/Gerente
                resp_dono_nome: 'Artur Miguel Branco',
                resp_dono_cargo: 'Diretor Geral',
                resp_dono_email: 'artur.branco@cid-cimentos.pt',
                resp_dono_telefone: '+351 254 123 459',
                resp_dono_telemovel: '+351 919 123 456',
                // ResponsÃ¡vel Contabilidade
                resp_contabilidade_nome: 'Dulce Maria Amaral',
                resp_contabilidade_cargo: 'Contabilista',
                resp_contabilidade_email: 'contabilidade@cid-cimentos.pt',
                resp_contabilidade_telefone: '+351 254 123 460',
                resp_contabilidade_telemovel: '+351 920 234 567',
                // ResponsÃ¡vel Financeiro
                resp_financeiro_nome: 'Henrique JosÃ© Vaz',
                resp_financeiro_cargo: 'Gestor Financeiro',
                resp_financeiro_email: 'financeiro@cid-cimentos.pt',
                resp_financeiro_telefone: '+351 254 123 461',
                resp_financeiro_telemovel: '+351 931 345 678',
                // ResponsÃ¡vel LogÃ­stica
                resp_logistica_nome: 'Rosa Maria Monteiro',
                resp_logistica_cargo: 'ResponsÃ¡vel ExpediÃ§Ã£o',
                resp_logistica_email: 'expedicao@cid-cimentos.pt',
                resp_logistica_telefone: '+351 254 123 462',
                resp_logistica_telemovel: '+351 942 456 789',
                // Comercial
                nome_angariador: 'Ana Lopes',
                // Dados BancÃ¡rios
                banco1: 'CrÃ©dito AgrÃ­cola',
                iban1: 'PT50 0045 0000 89012345678 90',
                swift1: 'CCCMPTPL',
                banco2: '',
                iban2: '',
                swift2: '',
                num_conta_bancaria: 'PT50 0045 0000 89012345678 90',
                // Outros
                observacoes: 'âš ï¸ CLIENTE BLOQUEADO - DÃ­vida em atraso de 45 dias. Contactar financeiro antes de nova reserva.',
                data_registo: '2020-08-10'
            },
            {
                numero: 'C0009',
                nome_completo: 'Produtos AgrÃ­colas Ribatejo, Lda',
                contribuinte: '509012345',
                pais: 'Portugal',
                tipo_pais: 'nacional',
                status: 'Ativo',
                plafonds_atribuidos: 55000,
                prazo_pagamento_dias: 30,
                modo_faturacao: 'Manual',
                faturacao_prevista_mensal: 16000,
                conta_sap: '21111009',
                valor_faturado_ano: 145000,
                // Sede
                sede_rua: 'Rua dos Agricultores',
                sede_porta: '200',
                sede_lugar: 'Zona AgrÃ­cola de Marvila',
                sede_cidade: 'SantarÃ©m',
                sede_freguesia: 'Marvila',
                sede_cp: '2005-177',
                sede_concelho: 'SantarÃ©m',
                // Contactos
                telefone_geral: '+351 243 234 567',
                telefone_direto: '+351 243 234 568',
                fax: '+351 243 234 569',
                telemovel_geral: '+351 920 234 567',
                email_geral: 'geral@par-agricola.pt',
                website: 'www.par-agricola.pt',
                // ResponsÃ¡vel Dono/Gerente
                resp_dono_nome: 'Guilherme AntÃ³nio Tavares',
                resp_dono_cargo: 'ProprietÃ¡rio',
                resp_dono_email: 'guilherme.tavares@par-agricola.pt',
                resp_dono_telefone: '+351 243 234 570',
                resp_dono_telemovel: '+351 920 234 567',
                // ResponsÃ¡vel Contabilidade
                resp_contabilidade_nome: 'Elvira Rosa Correia',
                resp_contabilidade_cargo: 'Administrativa',
                resp_contabilidade_email: 'contabilidade@par-agricola.pt',
                resp_contabilidade_telefone: '+351 243 234 571',
                resp_contabilidade_telemovel: '+351 931 345 678',
                // ResponsÃ¡vel Financeiro
                resp_financeiro_nome: 'Ã“scar Manuel Dias',
                resp_financeiro_cargo: 'Tesoureiro',
                resp_financeiro_email: 'tesouraria@par-agricola.pt',
                resp_financeiro_telefone: '+351 243 234 572',
                resp_financeiro_telemovel: '+351 942 456 789',
                // ResponsÃ¡vel LogÃ­stica
                resp_logistica_nome: 'NatÃ¡lia Sofia Freitas',
                resp_logistica_cargo: 'Gestora de ArmazÃ©m',
                resp_logistica_email: 'armazem@par-agricola.pt',
                resp_logistica_telefone: '+351 243 234 573',
                resp_logistica_telemovel: '+351 953 567 890',
                // Comercial
                nome_angariador: 'Miguel Santos',
                // Dados BancÃ¡rios
                banco1: 'Millennium BCP',
                iban1: 'PT50 0033 0000 90123456789 01',
                swift1: 'BCOMPTPL',
                banco2: '',
                iban2: '',
                swift2: '',
                num_conta_bancaria: 'PT50 0033 0000 90123456789 01',
                // Outros
                observacoes: 'Produtos agrÃ­colas e hortofrutÃ­colas. Necessita transporte refrigerado sazonal (Maio-Outubro).',
                data_registo: '2021-03-18'
            },
            {
                numero: 'C0010',
                nome_completo: 'ExportaÃ§Ãµes Algarve Premium, SA',
                contribuinte: '510123456',
                pais: 'Portugal',
                tipo_pais: 'nacional',
                status: 'Ativo',
                plafonds_atribuidos: 100000,
                prazo_pagamento_dias: 45,
                modo_faturacao: 'Manual',
                faturacao_prevista_mensal: 40000,
                conta_sap: '21111010',
                valor_faturado_ano: 378000,
                // Sede
                sede_rua: 'Avenida 5 de Outubro',
                sede_porta: '350',
                sede_lugar: 'Centro Empresarial Faro',
                sede_cidade: 'Faro',
                sede_freguesia: 'SÃ©',
                sede_cp: '8000-077',
                sede_concelho: 'Faro',
                // Contactos
                telefone_geral: '+351 289 345 678',
                telefone_direto: '+351 289 345 679',
                fax: '+351 289 345 680',
                telemovel_geral: '+351 921 345 678',
                email_geral: 'geral@eap-exportacoes.pt',
                website: 'www.eap-exportacoes.pt',
                // ResponsÃ¡vel Dono/Gerente
                resp_dono_nome: 'AmÃ©rico JosÃ© Soares',
                resp_dono_cargo: 'Presidente',
                resp_dono_email: 'americo.soares@eap-exportacoes.pt',
                resp_dono_telefone: '+351 289 345 681',
                resp_dono_telemovel: '+351 921 345 678',
                // ResponsÃ¡vel Contabilidade
                resp_contabilidade_nome: 'GraÃ§a Maria Pires',
                resp_contabilidade_cargo: 'Diretora Financeira',
                resp_contabilidade_email: 'contabilidade@eap-exportacoes.pt',
                resp_contabilidade_telefone: '+351 289 345 682',
                resp_contabilidade_telemovel: '+351 932 456 789',
                // ResponsÃ¡vel Financeiro
                resp_financeiro_nome: 'Leandro Miguel Cruz',
                resp_financeiro_cargo: 'Controller',
                resp_financeiro_email: 'financeiro@eap-exportacoes.pt',
                resp_financeiro_telefone: '+351 289 345 683',
                resp_financeiro_telemovel: '+351 943 567 890',
                // ResponsÃ¡vel LogÃ­stica
                resp_logistica_nome: 'OlÃ­via Cristina Marques',
                resp_logistica_cargo: 'Diretora de ExportaÃ§Ãµes',
                resp_logistica_email: 'exportacoes@eap-exportacoes.pt',
                resp_logistica_telefone: '+351 289 345 684',
                resp_logistica_telemovel: '+351 954 678 901',
                // Comercial
                nome_angariador: 'Carlos Mendes',
                // Dados BancÃ¡rios
                banco1: 'BPI',
                iban1: 'PT50 0010 0000 01234567890 12',
                swift1: 'BBPIPTPL',
                banco2: 'Santander',
                iban2: 'PT50 0018 0000 21098765432 10',
                swift2: 'TOTAPTPL',
                num_conta_bancaria: 'PT50 0010 0000 01234567890 12',
                // Outros
                observacoes: 'ExportaÃ§Ã£o de produtos portugueses para Europa e UK. Necessita documentaÃ§Ã£o aduaneira para Reino Unido pÃ³s-Brexit.',
                data_registo: '2013-07-25'
            }
        ];
        
        // Adicionar clientes de teste Ã  lista
        clientesLista = clientesLista.concat(clientesTeste);
        clientesProximoNumero = Math.max(clientesProximoNumero, 11);
        clientesGuardarDados();
    }
    
    function clientesGuardarDados() {
        try {
            localStorage.setItem('erpClientes', JSON.stringify({
                lista: clientesLista,
                proximoNumero: clientesProximoNumero
            }));
            // Atualizar referÃªncia global para outros mÃ³dulos (Reservas, etc.)
            window.clientesLista = clientesLista;
            console.log('âœ… Clientes guardados: ' + clientesLista.length + ' clientes');
        } catch (e) {
            console.error('Erro ao guardar clientes:', e);
        }
    }
    
    function clientesObterProximoNumero() {
        return 'C' + clientesProximoNumero;
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // MODO VISUALIZAÃ‡ÃƒO / EDIÃ‡ÃƒO
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    // Abrir ficha completa em modo visualizaÃ§Ã£o (campos bloqueados)
    function clientesVerFichaCompleta(numero) {
        var cliente = clientesLista.find(function(c) { return c.numero === numero; });
        if (!cliente) return;
        
        clientesEditando = false;
        clientesModoVisualizacao = true;
        clientesDadosAlterados = false;
        clientesAtual = cliente;
        
        // Preencher todos os campos
        clientesPreencherFormularioCompleto(cliente);
        
        // Bloquear todos os campos
        clientesBloquearCampos();
        
        // Mostrar botÃ£o Alterar, esconder Guardar
        document.getElementById('btnClientesAlterar').style.display = 'inline-block';
        document.getElementById('btnClientesGuardar').style.display = 'none';
        
        // Mostrar vista do formulÃ¡rio
        clientesMostrarVista('novo');
    }
    
    // Preencher formulÃ¡rio completo com dados do cliente
    function clientesPreencherFormularioCompleto(cliente) {
        // IdentificaÃ§Ã£o
        document.getElementById('clientes_numero_cliente').value = cliente.numero || '';
        document.getElementById('clientes_contribuinte').value = cliente.contribuinte || '';
        document.getElementById('clientes_nome_completo').value = cliente.nome_completo || '';
        document.getElementById('clientes_pais').value = cliente.pais || '';
        clientesReconhecerTipoPais();
        
        // Status
        document.querySelectorAll('input[name="clientes_status"]').forEach(function(r) {
            if (r.value === cliente.status) { r.checked = true; r.parentElement.classList.add('selected'); }
            else { r.parentElement.classList.remove('selected'); }
        });
        
        // Morada Sede
        document.getElementById('clientes_sede_rua').value = cliente.sede_rua || '';
        document.getElementById('clientes_sede_porta').value = cliente.sede_porta || '';
        document.getElementById('clientes_sede_lugar').value = cliente.sede_lugar || '';
        document.getElementById('clientes_sede_cidade').value = cliente.sede_cidade || '';
        document.getElementById('clientes_sede_freguesia').value = cliente.sede_freguesia || '';
        document.getElementById('clientes_sede_cp').value = cliente.sede_cp || '';
        document.getElementById('clientes_sede_concelho').value = cliente.sede_concelho || '';
        
        // Contactos
        document.getElementById('clientes_telefone_geral').value = cliente.telefone_geral || '';
        if (document.getElementById('clientes_fax')) document.getElementById('clientes_fax').value = cliente.fax || '';
        document.getElementById('clientes_email_geral').value = cliente.email_geral || '';
        
        // ResponsÃ¡veis
        document.getElementById('clientes_resp_dono_nome').value = cliente.resp_dono_nome || '';
        document.getElementById('clientes_resp_dono_email').value = cliente.resp_dono_email || '';
        document.getElementById('clientes_resp_dono_telemovel').value = cliente.resp_dono_telemovel || '';
        document.getElementById('clientes_resp_contacto_nome').value = cliente.resp_contacto_nome || '';
        document.getElementById('clientes_resp_contacto_email').value = cliente.resp_contacto_email || '';
        document.getElementById('clientes_resp_contacto_telefone').value = cliente.resp_contacto_telefone || '';
        document.getElementById('clientes_resp_comercial_nome').value = cliente.resp_comercial_nome || '';
        document.getElementById('clientes_resp_comercial_email').value = cliente.resp_comercial_email || '';
        document.getElementById('clientes_resp_comercial_telefone').value = cliente.resp_comercial_telefone || '';
        document.getElementById('clientes_resp_contabilidade_nome').value = cliente.resp_contabilidade_nome || '';
        document.getElementById('clientes_resp_contabilidade_email').value = cliente.resp_contabilidade_email || '';
        document.getElementById('clientes_resp_contabilidade_telefone').value = cliente.resp_contabilidade_telefone || '';
        document.getElementById('clientes_resp_financeiro_nome').value = cliente.resp_financeiro_nome || '';
        document.getElementById('clientes_resp_financeiro_email').value = cliente.resp_financeiro_email || '';
        document.getElementById('clientes_resp_financeiro_telefone').value = cliente.resp_financeiro_telefone || '';
        document.getElementById('clientes_resp_logistica_nome').value = cliente.resp_logistica_nome || '';
        document.getElementById('clientes_resp_logistica_email').value = cliente.resp_logistica_email || '';
        document.getElementById('clientes_resp_logistica_telefone').value = cliente.resp_logistica_telefone || '';
        
        // Financeiro
        document.getElementById('clientes_plafonds_atribuidos').value = cliente.plafonds_atribuidos || 0;
        document.getElementById('clientes_prazo_pagamento_dias').value = cliente.prazo_pagamento_dias || 30;
        document.getElementById('clientes_modo_faturacao').value = cliente.modo_faturacao || 'Manual';
        if (document.getElementById('clientes_faturacao_prevista_mensal')) {
            document.getElementById('clientes_faturacao_prevista_mensal').value = cliente.faturacao_prevista_mensal || 0;
        }
        document.getElementById('clientes_conta_sap').value = cliente.conta_sap || '';
        document.getElementById('clientes_valor_faturado_ano').value = 'â‚¬ ' + (cliente.valor_faturado_ano || 0).toLocaleString('pt-PT');
        
        // Outros
        if (document.getElementById('clientes_nome_angariador')) {
            document.getElementById('clientes_nome_angariador').value = cliente.nome_angariador || '';
        }
        if (document.getElementById('clientes_num_conta_bancaria')) {
            document.getElementById('clientes_num_conta_bancaria').value = cliente.num_conta_bancaria || cliente.iban1 || '';
        }
        document.getElementById('clientes_cliente_com_login').checked = cliente.cliente_com_login || false;
        document.getElementById('clientes_observacoes').value = cliente.observacoes || '';
    }
    
    // Bloquear todos os campos do formulÃ¡rio (modo visualizaÃ§Ã£o)
    function clientesBloquearCampos() {
        var form = document.getElementById('clientesFormCliente');
        if (!form) return;
        
        // Bloquear TODOS os inputs, textareas e selects
        form.querySelectorAll('input, textarea, select').forEach(function(campo) {
            campo.disabled = true;
            campo.readOnly = true;
            campo.style.backgroundColor = '#f0f0f0';
            campo.style.cursor = 'not-allowed';
            campo.style.pointerEvents = 'none';
            campo.style.opacity = '0.8';
        });
        
        // Bloquear radio buttons e seus labels
        form.querySelectorAll('input[type="radio"]').forEach(function(radio) {
            radio.disabled = true;
            radio.style.pointerEvents = 'none';
            var label = radio.parentElement;
            if (label) {
                label.style.cursor = 'not-allowed';
                label.style.pointerEvents = 'none';
                label.style.opacity = '0.7';
            }
        });
        
        // Bloquear checkboxes e seus labels
        form.querySelectorAll('input[type="checkbox"]').forEach(function(cb) {
            cb.disabled = true;
            cb.style.pointerEvents = 'none';
            var label = cb.parentElement;
            if (label) {
                label.style.cursor = 'not-allowed';
                label.style.pointerEvents = 'none';
            }
        });
        
        // Bloquear todos os botÃµes DENTRO do formulÃ¡rio (exceto os de aÃ§Ã£o no fundo)
        form.querySelectorAll('button').forEach(function(btn) {
            // NÃ£o bloquear os botÃµes de aÃ§Ã£o (Voltar, Alterar, Guardar)
            if (btn.id === 'btnClientesAlterar' || btn.id === 'btnClientesGuardar' || 
                btn.classList.contains('clientes-btn-cancelar')) {
                return;
            }
            btn.disabled = true;
            btn.style.pointerEvents = 'none';
            btn.style.opacity = '0.5';
            btn.style.cursor = 'not-allowed';
        });
        
        // Bloquear labels clicÃ¡veis (para status)
        form.querySelectorAll('.clientes-status-option, .clientes-radio-label, label').forEach(function(lbl) {
            lbl.style.pointerEvents = 'none';
            lbl.style.cursor = 'not-allowed';
        });
        
        // Bloquear file inputs
        form.querySelectorAll('input[type="file"]').forEach(function(fileInput) {
            fileInput.disabled = true;
            fileInput.style.pointerEvents = 'none';
            var container = fileInput.closest('.clientes-file-upload, .file-upload-container');
            if (container) {
                container.style.pointerEvents = 'none';
                container.style.opacity = '0.6';
            }
        });
        
        // Adicionar indicador visual de modo visualizaÃ§Ã£o
        var header = form.querySelector('.clientes-section-header, h3, h4');
        if (header && !document.getElementById('modoVisualizacaoIndicador')) {
            var indicador = document.createElement('span');
            indicador.id = 'modoVisualizacaoIndicador';
            indicador.innerHTML = ' <span style="background:#6c757d;color:white;padding:4px 12px;border-radius:15px;font-size:11px;margin-left:10px;">ğŸ‘ï¸ MODO VISUALIZAÃ‡ÃƒO</span>';
            header.appendChild(indicador);
        }
        
        console.log('ğŸ‘ï¸ Ficha em modo visualizaÃ§Ã£o - TODOS os campos bloqueados');
    }
    
    // Desbloquear todos os campos (modo ediÃ§Ã£o)
    function clientesDesbloquearCampos() {
        var form = document.getElementById('clientesFormCliente');
        if (!form) return;
        
        clientesModoVisualizacao = false;
        clientesEditando = true;
        
        // Desbloquear TODOS os inputs, textareas e selects
        form.querySelectorAll('input, textarea, select').forEach(function(campo) {
            // Manter alguns campos sempre bloqueados
            if (campo.id === 'clientes_numero_cliente' || campo.id === 'clientes_valor_faturado_ano') {
                return; // NÃ£o desbloquear nÃºmero e valor faturado
            }
            campo.disabled = false;
            campo.readOnly = false;
            campo.style.backgroundColor = '';
            campo.style.cursor = '';
            campo.style.pointerEvents = '';
            campo.style.opacity = '';
        });
        
        // Habilitar radio buttons e seus labels
        form.querySelectorAll('input[type="radio"]').forEach(function(radio) {
            radio.disabled = false;
            radio.style.pointerEvents = '';
            var label = radio.parentElement;
            if (label) {
                label.style.cursor = 'pointer';
                label.style.pointerEvents = '';
                label.style.opacity = '1';
            }
        });
        
        // Habilitar checkboxes e seus labels
        form.querySelectorAll('input[type="checkbox"]').forEach(function(cb) {
            cb.disabled = false;
            cb.style.pointerEvents = '';
            var label = cb.parentElement;
            if (label) {
                label.style.cursor = 'pointer';
                label.style.pointerEvents = '';
            }
        });
        
        // Desbloquear todos os botÃµes
        form.querySelectorAll('button').forEach(function(btn) {
            if (btn.id === 'btnClientesAlterar' || btn.id === 'btnClientesGuardar' || 
                btn.classList.contains('clientes-btn-cancelar')) {
                return;
            }
            btn.disabled = false;
            btn.style.pointerEvents = '';
            btn.style.opacity = '';
            btn.style.cursor = '';
        });
        
        // Desbloquear labels clicÃ¡veis
        form.querySelectorAll('.clientes-status-option, .clientes-radio-label, label').forEach(function(lbl) {
            lbl.style.pointerEvents = '';
            lbl.style.cursor = '';
        });
        
        // Desbloquear file inputs
        form.querySelectorAll('input[type="file"]').forEach(function(fileInput) {
            fileInput.disabled = false;
            fileInput.style.pointerEvents = '';
            var container = fileInput.closest('.clientes-file-upload, .file-upload-container');
            if (container) {
                container.style.pointerEvents = '';
                container.style.opacity = '';
            }
        });
        
        // Remover indicador de modo visualizaÃ§Ã£o
        var indicador = document.getElementById('modoVisualizacaoIndicador');
        if (indicador) indicador.remove();
        
        // Esconder botÃ£o Alterar, mostrar Guardar
        document.getElementById('btnClientesAlterar').style.display = 'none';
        document.getElementById('btnClientesGuardar').style.display = 'inline-block';
        
        // Marcar que hÃ¡ alteraÃ§Ãµes pendentes ao modificar qualquer campo
        form.querySelectorAll('input, textarea, select').forEach(function(campo) {
            campo.addEventListener('change', function() {
                clientesDadosAlterados = true;
            });
            campo.addEventListener('input', function() {
                clientesDadosAlterados = true;
            });
        });
        
        alert('âœï¸ Modo de ediÃ§Ã£o ativado!\n\nOs campos estÃ£o agora desbloqueados para ediÃ§Ã£o.\n\nClique em "ğŸ’¾ Guardar Cliente" para salvar as alteraÃ§Ãµes.');
        console.log('âœï¸ Ficha em modo ediÃ§Ã£o - campos desbloqueados');
    }
    
    // Sair da ficha de cliente (perguntar se quer guardar)
    function clientesSairFicha() {
        if (clientesDadosAlterados && !clientesModoVisualizacao) {
            var confirmar = confirm('âš ï¸ Existem alteraÃ§Ãµes nÃ£o guardadas!\n\nDeseja guardar as alteraÃ§Ãµes antes de sair?');
            if (confirmar) {
                // Guardar diretamente
                clientesGuardarDireto();
                return;
            }
        }
        
        // Reset estados
        clientesModoVisualizacao = false;
        clientesDadosAlterados = false;
        clientesEditando = false;
        clientesAtual = null;
        
        // Voltar Ã  lista
        clientesMostrarVista('lista');
    }
    
    // Guardar cliente diretamente (quando clica OK na janela de confirmaÃ§Ã£o)
    function clientesGuardarDireto() {
        var numero = document.getElementById('clientes_numero_cliente').value;
        var nomeCompleto = document.getElementById('clientes_nome_completo')?.value || '';
        var status = document.querySelector('input[name="clientes_status"]:checked')?.value || 'Ativo';
        var paisSelect = document.getElementById('clientes_pais');
        var tipoPais = paisSelect?.options[paisSelect.selectedIndex]?.getAttribute('data-tipo') || '';
        
        var dados = {
            numero: numero,
            nome_completo: nomeCompleto,
            contribuinte: document.getElementById('clientes_contribuinte')?.value || '',
            pais: document.getElementById('clientes_pais')?.value || '',
            tipo_pais: tipoPais,
            conta_sap: document.getElementById('clientes_conta_sap')?.value || '',
            status: status,
            sede_rua: document.getElementById('clientes_sede_rua')?.value || '',
            sede_porta: document.getElementById('clientes_sede_porta')?.value || '',
            sede_lugar: document.getElementById('clientes_sede_lugar')?.value || '',
            sede_cidade: document.getElementById('clientes_sede_cidade')?.value || '',
            sede_freguesia: document.getElementById('clientes_sede_freguesia')?.value || '',
            sede_cp: document.getElementById('clientes_sede_cp')?.value || '',
            sede_concelho: document.getElementById('clientes_sede_concelho')?.value || '',
            telefone_geral: document.getElementById('clientes_telefone_geral')?.value || '',
            email_geral: document.getElementById('clientes_email_geral')?.value || '',
            resp_dono_nome: document.getElementById('clientes_resp_dono_nome')?.value || '',
            resp_dono_email: document.getElementById('clientes_resp_dono_email')?.value || '',
            resp_dono_telemovel: document.getElementById('clientes_resp_dono_telemovel')?.value || '',
            resp_contacto_nome: document.getElementById('clientes_resp_contacto_nome')?.value || '',
            resp_contacto_email: document.getElementById('clientes_resp_contacto_email')?.value || '',
            resp_contacto_telefone: document.getElementById('clientes_resp_contacto_telefone')?.value || '',
            resp_comercial_nome: document.getElementById('clientes_resp_comercial_nome')?.value || '',
            resp_comercial_email: document.getElementById('clientes_resp_comercial_email')?.value || '',
            resp_comercial_telefone: document.getElementById('clientes_resp_comercial_telefone')?.value || '',
            resp_contabilidade_nome: document.getElementById('clientes_resp_contabilidade_nome')?.value || '',
            resp_contabilidade_email: document.getElementById('clientes_resp_contabilidade_email')?.value || '',
            resp_contabilidade_telefone: document.getElementById('clientes_resp_contabilidade_telefone')?.value || '',
            resp_financeiro_nome: document.getElementById('clientes_resp_financeiro_nome')?.value || '',
            resp_financeiro_email: document.getElementById('clientes_resp_financeiro_email')?.value || '',
            resp_financeiro_telefone: document.getElementById('clientes_resp_financeiro_telefone')?.value || '',
            resp_logistica_nome: document.getElementById('clientes_resp_logistica_nome')?.value || '',
            resp_logistica_email: document.getElementById('clientes_resp_logistica_email')?.value || '',
            resp_logistica_telefone: document.getElementById('clientes_resp_logistica_telefone')?.value || '',
            plafonds_atribuidos: parseFloat(document.getElementById('clientes_plafonds_atribuidos')?.value) || 0,
            quem_atribui_plafonds: document.getElementById('clientes_quem_atribui_plafonds')?.value || '',
            prazo_pagamento_dias: parseInt(document.getElementById('clientes_prazo_pagamento_dias')?.value) || 30,
            modo_faturacao: document.getElementById('clientes_modo_faturacao')?.value || 'AutomÃ¡tica',
            faturacao_prevista_mensal: parseFloat(document.getElementById('clientes_faturacao_prevista_mensal')?.value) || 0,
            percentagem_desc: parseFloat(document.getElementById('clientes_percentagem_desc')?.value) || 0,
            desconto_na_fatura: document.getElementById('clientes_desconto_na_fatura')?.value || 'NÃ£o',
            num_conta_bancaria: document.getElementById('clientes_num_conta_bancaria')?.value || '',
            nome_angariador: document.getElementById('clientes_nome_angariador')?.value || '',
            aceita_desc_pp: document.getElementById('clientes_aceita_desc_pp')?.checked || false,
            incidencias: document.getElementById('clientes_incidencias')?.value || '',
            conta_contab_1: document.getElementById('clientes_conta_contab_1')?.value || '',
            conta_contab_2: document.getElementById('clientes_conta_contab_2')?.value || '',
            conta_contab_3: document.getElementById('clientes_conta_contab_3')?.value || '',
            conta_contab_4: document.getElementById('clientes_conta_contab_4')?.value || '',
            valor_faturado_ano: clientesAtual ? (clientesAtual.valor_faturado_ano || 0) : 0,
            cliente_com_login: document.getElementById('clientes_cliente_com_login')?.checked || false,
            observacoes: document.getElementById('clientes_observacoes')?.value || ''
        };
        
        // Atualizar na lista
        if (clientesEditando && clientesAtual) {
            var idx = clientesLista.findIndex(function(c) { return c.numero === clientesAtual.numero; });
            if (idx !== -1) {
                clientesLista[idx] = dados;
            }
        } else {
            clientesLista.push(dados);
            clientesProximoNumero++;
        }
        
        // Guardar e verificar
        var guardadoComSucesso = clientesGuardarDadosComVerificacao();
        
        if (guardadoComSucesso) {
            alert('âœ… GUARDADO COM SUCESSO!\n\nO cliente "' + nomeCompleto + '" foi guardado com sucesso na base de dados.\n\nNÂº Cliente: ' + numero);
            clientesMostrarAlerta('âœ… Cliente guardado com sucesso!', 'success');
            console.log('âœ… Cliente guardado:', numero, nomeCompleto);
        } else {
            alert('âŒ ERRO AO GUARDAR!\n\nOcorreu um erro ao guardar o cliente.\nPor favor tente novamente.');
            clientesMostrarAlerta('âŒ Erro ao guardar cliente!', 'error');
            return;
        }
        
        // Reset estados
        clientesModoVisualizacao = false;
        clientesDadosAlterados = false;
        clientesEditando = false;
        clientesAtual = null;
        
        // Voltar Ã  lista
        clientesMostrarVista('lista');
    }
    
    // Vistas
    function clientesMostrarVista(vista) {
        document.querySelectorAll('.clientes-view-section').forEach(function(s) { s.classList.remove('active'); });
        document.querySelectorAll('.clientes-nav-tab').forEach(function(t) { t.classList.remove('active'); });
        
        if (vista === 'lista') {
            document.getElementById('clientesVistaLista').classList.add('active');
            document.querySelector('.clientes-nav-tab:nth-child(1)').classList.add('active');
            document.getElementById('clientesTabDetalhes').style.display = 'none';
            clientesAtualizarLista();
            // Reset estados ao voltar Ã  lista
            clientesModoVisualizacao = false;
            clientesDadosAlterados = false;
        } else if (vista === 'novo') {
            document.getElementById('clientesVistaNovo').classList.add('active');
            document.querySelector('.clientes-nav-tab:nth-child(2)').classList.add('active');
            
            // Se nÃ£o estiver em modo visualizaÃ§Ã£o, Ã© um novo cliente
            if (!clientesModoVisualizacao && !clientesEditando) {
                clientesLimparFormulario();
                // Para novo cliente: mostrar Guardar, esconder Alterar
                document.getElementById('btnClientesAlterar').style.display = 'none';
                document.getElementById('btnClientesGuardar').style.display = 'inline-block';
                // Desbloquear campos para novo cliente
                clientesDesbloquearCamposNovoCliente();
            }
        } else if (vista === 'detalhes') {
            document.getElementById('clientesVistaDetalhes').classList.add('active');
            document.getElementById('clientesTabDetalhes').style.display = 'inline-block';
            document.getElementById('clientesTabDetalhes').classList.add('active');
        }
    }
    
    // Desbloquear campos para novo cliente (sem alert)
    function clientesDesbloquearCamposNovoCliente() {
        var form = document.getElementById('clientesFormCliente');
        if (!form) return;
        
        // Remover indicador de modo visualizaÃ§Ã£o se existir
        var indicador = document.getElementById('modoVisualizacaoIndicador');
        if (indicador) indicador.remove();
        
        form.querySelectorAll('input, textarea, select').forEach(function(campo) {
            if (campo.id === 'clientes_numero_cliente' || campo.id === 'clientes_valor_faturado_ano') {
                return;
            }
            campo.disabled = false;
            campo.readOnly = false;
            campo.style.backgroundColor = '';
            campo.style.cursor = '';
            campo.style.pointerEvents = '';
            campo.style.opacity = '';
        });
        
        form.querySelectorAll('input[type="radio"]').forEach(function(radio) {
            radio.disabled = false;
            radio.style.pointerEvents = '';
            var label = radio.parentElement;
            if (label) {
                label.style.cursor = 'pointer';
                label.style.pointerEvents = '';
                label.style.opacity = '1';
            }
        });
        
        form.querySelectorAll('input[type="checkbox"]').forEach(function(cb) {
            cb.disabled = false;
            cb.style.pointerEvents = '';
            var label = cb.parentElement;
            if (label) {
                label.style.cursor = 'pointer';
                label.style.pointerEvents = '';
            }
        });
        
        // Desbloquear labels
        form.querySelectorAll('.clientes-status-option, .clientes-radio-label, label').forEach(function(lbl) {
            lbl.style.pointerEvents = '';
            lbl.style.cursor = '';
        });
        
        // Desbloquear botÃµes
        form.querySelectorAll('button').forEach(function(btn) {
            if (btn.id === 'btnClientesAlterar' || btn.id === 'btnClientesGuardar' || 
                btn.classList.contains('clientes-btn-cancelar')) {
                return;
            }
            btn.disabled = false;
            btn.style.pointerEvents = '';
            btn.style.opacity = '';
            btn.style.cursor = '';
        });
        
        // Desbloquear file inputs
        form.querySelectorAll('input[type="file"]').forEach(function(fileInput) {
            fileInput.disabled = false;
            fileInput.style.pointerEvents = '';
            var container = fileInput.closest('.clientes-file-upload, .file-upload-container');
            if (container) {
                container.style.pointerEvents = '';
                container.style.opacity = '';
            }
        });
    }
    
    // Lista
    function clientesAtualizarLista() {
        var tbody = document.getElementById('clientesTabelaClientes');
        if (!tbody) return;
        
        var total = clientesLista.length;
        var ativos = clientesLista.filter(function(c) { return c.status === 'Ativo'; }).length;
        var bloqueados = clientesLista.filter(function(c) { return c.status === 'Bloqueado'; }).length;
        var faturacao = clientesLista.reduce(function(s, c) { return s + (c.valor_faturado_ano || 0); }, 0);
        
        var statTotal = document.getElementById('clientesStatTotal');
        var statAtivos = document.getElementById('clientesStatAtivos');
        var statBloqueados = document.getElementById('clientesStatBloqueados');
        var statFaturacao = document.getElementById('clientesStatFaturacao');
        
        if (statTotal) statTotal.textContent = total;
        if (statAtivos) statAtivos.textContent = ativos;
        if (statBloqueados) statBloqueados.textContent = bloqueados;
        if (statFaturacao) statFaturacao.textContent = 'â‚¬' + faturacao.toLocaleString('pt-PT');
        
        if (clientesLista.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 40px; color: #666;">Nenhum cliente registado. Clique em "Novo Cliente" para adicionar.</td></tr>';
            return;
        }
        
        tbody.innerHTML = clientesLista.map(function(c) {
            var badgeClass = c.status === 'Ativo' ? 'clientes-badge-success' : (c.status === 'Bloqueado' ? 'clientes-badge-danger' : 'clientes-badge-secondary');
            var tipoClass = c.tipo_pais === 'nacional' ? 'clientes-tipo-nacional' : (c.tipo_pais === 'europeu' ? 'clientes-tipo-europeu' : 'clientes-tipo-terceiro');
            var tipoLabel = c.tipo_pais === 'nacional' ? 'Nacional' : (c.tipo_pais === 'europeu' ? 'Europeu' : 'Terceiro');
            
            return '<tr>' +
                '<td><strong>' + c.numero + '</strong></td>' +
                '<td>' + c.nome_completo + '</td>' +
                '<td>' + c.contribuinte + '</td>' +
                '<td>' + c.pais + '</td>' +
                '<td><span class="clientes-tipo-pais-badge ' + tipoClass + '">' + tipoLabel + '</span></td>' +
                '<td>â‚¬' + (c.plafonds_atribuidos || 0).toLocaleString('pt-PT') + '</td>' +
                '<td><span class="clientes-badge ' + badgeClass + '">' + c.status + '</span></td>' +
                '<td class="clientes-table-actions">' +
                    '<button class="clientes-btn clientes-btn-azul clientes-btn-sm" onclick="clientesVerFichaCompleta(\'' + c.numero + '\')" title="Ver ficha completa">ğŸ‘ï¸</button>' +
                    '<button class="clientes-btn clientes-btn-vermelho clientes-btn-sm" onclick="clientesConfirmarEliminar(\'' + c.numero + '\')" title="Eliminar">ğŸ—‘ï¸</button>' +
                '</td>' +
            '</tr>';
        }).join('');
    }
    
    function clientesPesquisar() {
        var campoPesquisa = document.getElementById('clientesCampoPesquisa');
        if (!campoPesquisa) {
            console.log('Campo de pesquisa nÃ£o encontrado');
            return;
        }
        
        var termo = (campoPesquisa.value || '').toLowerCase().trim();
        var tbody = document.getElementById('clientesTabelaClientes');
        if (!tbody) {
            console.log('Tabela de clientes nÃ£o encontrada');
            return;
        }
        
        // Se termo vazio, mostrar todos
        if (termo === '') {
            clientesAtualizarLista();
            return;
        }
        
        var filtrados = clientesLista.filter(function(c) {
            return (c.numero || '').toLowerCase().includes(termo) ||
                   (c.nome_completo || '').toLowerCase().includes(termo) ||
                   (c.contribuinte || '').toLowerCase().includes(termo) ||
                   (c.pais || '').toLowerCase().includes(termo) ||
                   (c.status || '').toLowerCase().includes(termo) ||
                   (c.sede_cidade || '').toLowerCase().includes(termo) ||
                   (c.email_geral || '').toLowerCase().includes(termo);
        });
        
        if (filtrados.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 40px; color: #666;">Nenhum cliente encontrado para: <strong>"' + termo + '"</strong></td></tr>';
            return;
        }
        
        tbody.innerHTML = filtrados.map(function(c) {
            var badgeClass = c.status === 'Ativo' ? 'clientes-badge-success' : (c.status === 'Bloqueado' ? 'clientes-badge-danger' : 'clientes-badge-secondary');
            var tipoClass = c.tipo_pais === 'nacional' ? 'clientes-tipo-nacional' : (c.tipo_pais === 'europeu' ? 'clientes-tipo-europeu' : 'clientes-tipo-terceiro');
            var tipoLabel = c.tipo_pais === 'nacional' ? 'Nacional' : (c.tipo_pais === 'europeu' ? 'Europeu' : 'Terceiro');
            
            return '<tr>' +
                '<td><strong>' + c.numero + '</strong></td>' +
                '<td>' + c.nome_completo + '</td>' +
                '<td>' + c.contribuinte + '</td>' +
                '<td>' + c.pais + '</td>' +
                '<td><span class="clientes-tipo-pais-badge ' + tipoClass + '">' + tipoLabel + '</span></td>' +
                '<td>â‚¬' + (c.plafonds_atribuidos || 0).toLocaleString('pt-PT') + '</td>' +
                '<td><span class="clientes-badge ' + badgeClass + '">' + c.status + '</span></td>' +
                '<td class="clientes-table-actions">' +
                    '<button class="clientes-btn clientes-btn-azul clientes-btn-sm" onclick="clientesVerFichaCompleta(\'' + c.numero + '\')" title="Ver ficha completa">ğŸ‘ï¸</button>' +
                    '<button class="clientes-btn clientes-btn-vermelho clientes-btn-sm" onclick="clientesConfirmarEliminar(\'' + c.numero + '\')" title="Eliminar">ğŸ—‘ï¸</button>' +
                '</td>' +
            '</tr>';
        }).join('');
    }
    
    // FormulÃ¡rio
    function clientesLimparFormulario() {
        document.getElementById('clientes_numero_cliente').value = clientesObterProximoNumero();
        document.getElementById('clientes_contribuinte').value = '';
        document.getElementById('clientes_nome_completo').value = '';
        document.getElementById('clientes_pais').value = '';
        document.getElementById('clientesTipoPaisBadge').innerHTML = '';
        document.getElementById('clientes_ficha_abertura_nome').value = '';
        document.getElementById('clientes_saldo_divida').value = 'â‚¬ 0.00';
        
        document.querySelectorAll('input[name="clientes_status"]').forEach(function(r) {
            if (r.value === 'Ativo') { r.checked = true; r.parentElement.classList.add('selected'); }
            else { r.parentElement.classList.remove('selected'); }
        });
        
        // Limpar moradas
        ['sede', 'filial', 'faturacao'].forEach(function(tipo) {
            ['rua', 'porta', 'lugar', 'cidade', 'freguesia', 'cp', 'concelho'].forEach(function(campo) {
                var el = document.getElementById('clientes_' + tipo + '_' + campo);
                if (el) el.value = '';
            });
        });
        
        document.getElementById('clientes_telefone_geral').value = '';
        document.getElementById('clientes_email_geral').value = '';
        document.getElementById('clientes_fax').value = '';
        
        // Limpar responsÃ¡veis
        ['dono', 'contacto', 'comercial', 'contabilidade', 'financeiro', 'logistica'].forEach(function(resp) {
            var nomeEl = document.getElementById('clientes_resp_' + resp + '_nome');
            var emailEl = document.getElementById('clientes_resp_' + resp + '_email');
            var telEl = document.getElementById('clientes_resp_' + resp + '_telemovel') || document.getElementById('clientes_resp_' + resp + '_telefone');
            if (nomeEl) nomeEl.value = '';
            if (emailEl) emailEl.value = '';
            if (telEl) telEl.value = '';
        });
        
        // Limpar condiÃ§Ãµes comerciais
        document.getElementById('clientes_plafonds_atribuidos').value = '0';
        document.getElementById('clientes_quem_atribui_plafonds').value = '';
        document.getElementById('clientes_prazo_pagamento_dias').value = '30';
        document.getElementById('clientes_modo_faturacao').value = 'AutomÃ¡tica';
        document.getElementById('clientes_faturacao_prevista_mensal').value = '';
        document.getElementById('clientes_percentagem_desc').value = '0';
        document.getElementById('clientes_desconto_na_fatura').value = 'NÃ£o';
        document.getElementById('clientes_num_conta_bancaria').value = '';
        document.getElementById('clientes_nome_angariador').value = '';
        document.getElementById('clientes_anexos_seguro_nome').value = '';
        document.getElementById('clientes_aceita_desc_pp').checked = false;
        document.getElementById('clientes_incidencias').value = '';
        
        // Limpar contabilidade
        document.getElementById('clientes_conta_contab_1').value = '';
        document.getElementById('clientes_conta_contab_2').value = '';
        document.getElementById('clientes_conta_contab_3').value = '';
        document.getElementById('clientes_conta_contab_4').value = '';
        document.getElementById('clientes_conta_sap').value = '';
        document.getElementById('clientes_valor_faturado_ano').value = 'â‚¬ 0.00';
        document.getElementById('clientes_cliente_com_login').checked = false;
        document.getElementById('clientes_observacoes').value = '';
        document.getElementById('clientes_anexos_gerais_nome').value = '';
        
        clientesFicheirosIncidencias = [];
        clientesFicheirosAnexosGerais = [];
        clientesFicheirosSeguro = [];
        clientesEditando = false;
        clientesAtual = null;
    }
    
    function clientesReconhecerTipoPais() {
        var paisSelect = document.getElementById('clientes_pais');
        var badge = document.getElementById('clientesTipoPaisBadge');
        if (!paisSelect || !badge) return;
        
        var option = paisSelect.options[paisSelect.selectedIndex];
        var tipo = option?.getAttribute('data-tipo') || '';
        
        if (tipo === 'nacional') {
            badge.innerHTML = '<span class="clientes-tipo-pais-badge clientes-tipo-nacional">Nacional</span>';
        } else if (tipo === 'europeu') {
            badge.innerHTML = '<span class="clientes-tipo-pais-badge clientes-tipo-europeu">Europeu</span>';
        } else if (tipo === 'terceiro') {
            badge.innerHTML = '<span class="clientes-tipo-pais-badge clientes-tipo-terceiro">PaÃ­s Terceiro</span>';
        } else {
            badge.innerHTML = '';
        }
    }
    
    function clientesAtualizarEstado(radio) {
        document.querySelectorAll('.clientes-radio-wrapper').forEach(function(r) { r.classList.remove('selected'); });
        radio.parentElement.classList.add('selected');
    }
    
    function clientesCopiarMorada(origem, destino) {
        var campos = ['rua', 'porta', 'lugar', 'cidade', 'freguesia', 'cp', 'concelho'];
        campos.forEach(function(c) {
            var val = document.getElementById('clientes_' + origem + '_' + c)?.value || '';
            var destEl = document.getElementById('clientes_' + destino + '_' + c);
            if (destEl) destEl.value = val;
        });
        clientesMostrarAlerta('âœ… Morada copiada!', 'success');
    }
    
    function clientesGuardar(event) {
        event.preventDefault();
        
        var numero = document.getElementById('clientes_numero_cliente').value;
        var status = document.querySelector('input[name="clientes_status"]:checked')?.value || 'Ativo';
        var paisSelect = document.getElementById('clientes_pais');
        var tipoPais = paisSelect?.options[paisSelect.selectedIndex]?.getAttribute('data-tipo') || '';
        
        var dados = {
            numero: numero,
            nome_completo: document.getElementById('clientes_nome_completo')?.value || '',
            contribuinte: document.getElementById('clientes_contribuinte')?.value || '',
            pais: document.getElementById('clientes_pais')?.value || '',
            tipo_pais: tipoPais,
            conta_sap: document.getElementById('clientes_conta_sap')?.value || '',
            status: status,
            sede_rua: document.getElementById('clientes_sede_rua')?.value || '',
            sede_porta: document.getElementById('clientes_sede_porta')?.value || '',
            sede_lugar: document.getElementById('clientes_sede_lugar')?.value || '',
            sede_cidade: document.getElementById('clientes_sede_cidade')?.value || '',
            sede_freguesia: document.getElementById('clientes_sede_freguesia')?.value || '',
            sede_cp: document.getElementById('clientes_sede_cp')?.value || '',
            sede_concelho: document.getElementById('clientes_sede_concelho')?.value || '',
            telefone_geral: document.getElementById('clientes_telefone_geral')?.value || '',
            email_geral: document.getElementById('clientes_email_geral')?.value || '',
            // ResponsÃ¡veis - Campos C31-C48 (necessÃ¡rios para Trigger C52)
            resp_dono_nome: document.getElementById('clientes_resp_dono_nome')?.value || '',
            resp_dono_email: document.getElementById('clientes_resp_dono_email')?.value || '',
            resp_dono_telemovel: document.getElementById('clientes_resp_dono_telemovel')?.value || '',
            resp_contacto_nome: document.getElementById('clientes_resp_contacto_nome')?.value || '',
            resp_contacto_email: document.getElementById('clientes_resp_contacto_email')?.value || '',
            resp_contacto_telefone: document.getElementById('clientes_resp_contacto_telefone')?.value || '',
            resp_comercial_nome: document.getElementById('clientes_resp_comercial_nome')?.value || '',
            resp_comercial_email: document.getElementById('clientes_resp_comercial_email')?.value || '',
            resp_comercial_telefone: document.getElementById('clientes_resp_comercial_telefone')?.value || '',
            resp_contabilidade_nome: document.getElementById('clientes_resp_contabilidade_nome')?.value || '',
            resp_contabilidade_email: document.getElementById('clientes_resp_contabilidade_email')?.value || '', // C41 - Trigger C52
            resp_contabilidade_telefone: document.getElementById('clientes_resp_contabilidade_telefone')?.value || '',
            resp_financeiro_nome: document.getElementById('clientes_resp_financeiro_nome')?.value || '',
            resp_financeiro_email: document.getElementById('clientes_resp_financeiro_email')?.value || '', // C44 - Trigger C52
            resp_financeiro_telefone: document.getElementById('clientes_resp_financeiro_telefone')?.value || '',
            resp_logistica_nome: document.getElementById('clientes_resp_logistica_nome')?.value || '',
            resp_logistica_email: document.getElementById('clientes_resp_logistica_email')?.value || '', // C47 - Trigger C52
            resp_logistica_telefone: document.getElementById('clientes_resp_logistica_telefone')?.value || '',
            plafonds_atribuidos: parseFloat(document.getElementById('clientes_plafonds_atribuidos')?.value) || 0,
            quem_atribui_plafonds: document.getElementById('clientes_quem_atribui_plafonds')?.value || '',
            prazo_pagamento_dias: parseInt(document.getElementById('clientes_prazo_pagamento_dias')?.value) || 30,
            modo_faturacao: document.getElementById('clientes_modo_faturacao')?.value || 'AutomÃ¡tica',
            faturacao_prevista_mensal: parseFloat(document.getElementById('clientes_faturacao_prevista_mensal')?.value) || 0,
            percentagem_desc: parseFloat(document.getElementById('clientes_percentagem_desc')?.value) || 0,
            desconto_na_fatura: document.getElementById('clientes_desconto_na_fatura')?.value || 'NÃ£o',
            num_conta_bancaria: document.getElementById('clientes_num_conta_bancaria')?.value || '',
            nome_angariador: document.getElementById('clientes_nome_angariador')?.value || '',
            aceita_desc_pp: document.getElementById('clientes_aceita_desc_pp')?.checked || false,
            incidencias: document.getElementById('clientes_incidencias')?.value || '',
            conta_contab_1: document.getElementById('clientes_conta_contab_1')?.value || '',
            conta_contab_2: document.getElementById('clientes_conta_contab_2')?.value || '',
            conta_contab_3: document.getElementById('clientes_conta_contab_3')?.value || '',
            conta_contab_4: document.getElementById('clientes_conta_contab_4')?.value || '',
            valor_faturado_ano: 0,
            cliente_com_login: document.getElementById('clientes_cliente_com_login')?.checked || false,
            observacoes: document.getElementById('clientes_observacoes')?.value || ''
        };
        
        if (clientesEditando && clientesAtual) {
            var idx = clientesLista.findIndex(function(c) { return c.numero === clientesAtual.numero; });
            if (idx !== -1) {
                dados.valor_faturado_ano = clientesAtual.valor_faturado_ano || 0;
                clientesLista[idx] = dados;
            }
        } else {
            clientesLista.push(dados);
            clientesProximoNumero++;
        }
        
        // Guardar dados e verificar se foi guardado com sucesso
        var guardadoComSucesso = clientesGuardarDadosComVerificacao();
        
        if (guardadoComSucesso) {
            // Mostrar mensagem de sucesso
            alert('âœ… GUARDADO COM SUCESSO!\n\nO cliente "' + dados.nome_completo + '" foi guardado com sucesso na base de dados.\n\nNÂº Cliente: ' + dados.numero);
            clientesMostrarAlerta('âœ… Cliente guardado com sucesso!', 'success');
            console.log('âœ… Cliente guardado:', dados.numero, dados.nome_completo);
        } else {
            alert('âŒ ERRO AO GUARDAR!\n\nOcorreu um erro ao guardar o cliente.\nPor favor tente novamente.');
            clientesMostrarAlerta('âŒ Erro ao guardar cliente!', 'error');
            return; // NÃ£o sair da ficha se houve erro
        }
        
        clientesEditando = false;
        clientesAtual = null;
        clientesModoVisualizacao = false;
        clientesDadosAlterados = false;
        clientesMostrarVista('lista');
    }
    
    // Guardar dados com verificaÃ§Ã£o
    function clientesGuardarDadosComVerificacao() {
        try {
            var dadosParaGuardar = JSON.stringify({
                lista: clientesLista,
                proximoNumero: clientesProximoNumero
            });
            
            localStorage.setItem('erpClientes', dadosParaGuardar);
            
            // Verificar se foi realmente guardado
            var dadosGuardados = localStorage.getItem('erpClientes');
            if (dadosGuardados === dadosParaGuardar) {
                console.log('âœ… VerificaÃ§Ã£o: Dados guardados corretamente no localStorage');
                return true;
            } else {
                console.error('âŒ VerificaÃ§Ã£o falhou: Dados nÃ£o coincidem');
                return false;
            }
        } catch (e) {
            console.error('âŒ Erro ao guardar clientes:', e);
            return false;
        }
    }
    
    function clientesEditar(numero) {
        var cliente = clientesLista.find(function(c) { return c.numero === numero; });
        if (!cliente) return;
        
        clientesEditando = true;
        clientesAtual = cliente;
        
        document.getElementById('clientes_numero_cliente').value = cliente.numero;
        document.getElementById('clientes_contribuinte').value = cliente.contribuinte || '';
        document.getElementById('clientes_nome_completo').value = cliente.nome_completo || '';
        document.getElementById('clientes_pais').value = cliente.pais || '';
        clientesReconhecerTipoPais();
        
        document.querySelectorAll('input[name="clientes_status"]').forEach(function(r) {
            if (r.value === cliente.status) { r.checked = true; r.parentElement.classList.add('selected'); }
            else { r.parentElement.classList.remove('selected'); }
        });
        
        document.getElementById('clientes_sede_rua').value = cliente.sede_rua || '';
        document.getElementById('clientes_sede_porta').value = cliente.sede_porta || '';
        document.getElementById('clientes_sede_lugar').value = cliente.sede_lugar || '';
        document.getElementById('clientes_sede_cidade').value = cliente.sede_cidade || '';
        document.getElementById('clientes_sede_freguesia').value = cliente.sede_freguesia || '';
        document.getElementById('clientes_sede_cp').value = cliente.sede_cp || '';
        document.getElementById('clientes_sede_concelho').value = cliente.sede_concelho || '';
        document.getElementById('clientes_telefone_geral').value = cliente.telefone_geral || '';
        document.getElementById('clientes_fax').value = cliente.fax || '';
        document.getElementById('clientes_email_geral').value = cliente.email_geral || '';
        document.getElementById('clientes_nome_angariador').value = cliente.nome_angariador || '';
        document.getElementById('clientes_num_conta_bancaria').value = cliente.num_conta_bancaria || cliente.iban1 || '';
        document.getElementById('clientes_faturacao_prevista_mensal').value = cliente.faturacao_prevista_mensal || 0;
        // ResponsÃ¡veis - Campos C31-C48 (necessÃ¡rios para Trigger C52)
        document.getElementById('clientes_resp_dono_nome').value = cliente.resp_dono_nome || '';
        document.getElementById('clientes_resp_dono_email').value = cliente.resp_dono_email || '';
        document.getElementById('clientes_resp_dono_telemovel').value = cliente.resp_dono_telemovel || '';
        document.getElementById('clientes_resp_contacto_nome').value = cliente.resp_contacto_nome || '';
        document.getElementById('clientes_resp_contacto_email').value = cliente.resp_contacto_email || '';
        document.getElementById('clientes_resp_contacto_telefone').value = cliente.resp_contacto_telefone || '';
        document.getElementById('clientes_resp_comercial_nome').value = cliente.resp_comercial_nome || '';
        document.getElementById('clientes_resp_comercial_email').value = cliente.resp_comercial_email || '';
        document.getElementById('clientes_resp_comercial_telefone').value = cliente.resp_comercial_telefone || '';
        document.getElementById('clientes_resp_contabilidade_nome').value = cliente.resp_contabilidade_nome || '';
        document.getElementById('clientes_resp_contabilidade_email').value = cliente.resp_contabilidade_email || ''; // C41
        document.getElementById('clientes_resp_contabilidade_telefone').value = cliente.resp_contabilidade_telefone || '';
        document.getElementById('clientes_resp_financeiro_nome').value = cliente.resp_financeiro_nome || '';
        document.getElementById('clientes_resp_financeiro_email').value = cliente.resp_financeiro_email || ''; // C44
        document.getElementById('clientes_resp_financeiro_telefone').value = cliente.resp_financeiro_telefone || '';
        document.getElementById('clientes_resp_logistica_nome').value = cliente.resp_logistica_nome || '';
        document.getElementById('clientes_resp_logistica_email').value = cliente.resp_logistica_email || ''; // C47
        document.getElementById('clientes_resp_logistica_telefone').value = cliente.resp_logistica_telefone || '';
        document.getElementById('clientes_plafonds_atribuidos').value = cliente.plafonds_atribuidos || 0;
        document.getElementById('clientes_prazo_pagamento_dias').value = cliente.prazo_pagamento_dias || 30;
        document.getElementById('clientes_modo_faturacao').value = cliente.modo_faturacao || 'AutomÃ¡tica';
        document.getElementById('clientes_conta_sap').value = cliente.conta_sap || '';
        document.getElementById('clientes_valor_faturado_ano').value = 'â‚¬ ' + (cliente.valor_faturado_ano || 0).toLocaleString('pt-PT');
        document.getElementById('clientes_cliente_com_login').checked = cliente.cliente_com_login || false;
        document.getElementById('clientes_observacoes').value = cliente.observacoes || '';
        
        clientesMostrarVista('novo');
    }
    
    function clientesAlterar() {
        document.getElementById('clientesFormCliente').dispatchEvent(new Event('submit'));
    }
    
    // Detalhes
    function clientesVerDetalhes(numero) {
        // Redirecionar para a nova funÃ§Ã£o de ficha completa
        clientesVerFichaCompleta(numero);
    }
    
    // EliminaÃ§Ã£o
    function clientesConfirmarEliminar(numero) {
        var cliente = clientesLista.find(function(c) { return c.numero === numero; });
        if (!cliente) return;
        clientesParaEliminar = numero;
        document.getElementById('clientesModalMensagem').textContent = 'Eliminar "' + cliente.nome_completo + '" (' + numero + ')?';
        document.getElementById('clientesModalConfirmacao').classList.add('active');
    }
    
    function clientesFecharModal() {
        document.getElementById('clientesModalConfirmacao').classList.remove('active');
        clientesParaEliminar = null;
    }
    
    function clientesConfirmarEliminacao() {
        if (clientesParaEliminar) {
            clientesLista = clientesLista.filter(function(c) { return c.numero !== clientesParaEliminar; });
            clientesGuardarDados();
            clientesMostrarAlerta('âœ… Cliente eliminado com sucesso!', 'success');
            clientesFecharModal();
            clientesMostrarVista('lista');
        }
    }
    
    // DÃ­vidas
    function clientesAbrirListagemDividas() {
        var numero = document.getElementById('clientes_numero_cliente')?.value;
        var nome = document.getElementById('clientes_nome_completo')?.value || 'Cliente nÃ£o identificado';
        var nif = document.getElementById('clientes_contribuinte')?.value || '-';
        var pais = document.getElementById('clientes_pais')?.value || 'Portugal';
        
        var faturas = clientesFaturasDivida[numero] || [];
        var total = faturas.reduce(function(sum, f) { return sum + f.valor; }, 0);
        
        document.getElementById('clientesDividaClienteNome').textContent = nome;
        document.getElementById('clientesDividaClienteNIF').textContent = nif;
        document.getElementById('clientesDividaClientePais').textContent = pais;
        document.getElementById('clientesDividaTotalValor').textContent = 'â‚¬ ' + total.toLocaleString('pt-PT', {minimumFractionDigits: 2});
        
        var tbody = document.getElementById('clientesTabelaDividas');
        if (faturas.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" style="padding: 16px; text-align: center; color: #27ae60;">âœ… Sem faturas em dÃ­vida</td></tr>';
        } else {
            tbody.innerHTML = faturas.map(function(f) {
                var hoje = new Date();
                var venc = new Date(f.vencimento);
                var diasAtraso = Math.max(0, Math.floor((hoje - venc) / (1000 * 60 * 60 * 24)));
                var corAtraso = diasAtraso > 30 ? '#c0392b' : diasAtraso > 0 ? '#e67e22' : '#27ae60';
                
                return '<tr style="border-bottom: 1px solid #dee2e6;">' +
                    '<td style="padding: 8px;">' + f.data_emissao + '</td>' +
                    '<td style="padding: 8px; font-weight: bold;">' + f.numero + '</td>' +
                    '<td style="padding: 8px;">' + f.descricao + '</td>' +
                    '<td style="padding: 8px; text-align: right; font-weight: bold;">â‚¬ ' + f.valor.toLocaleString('pt-PT', {minimumFractionDigits: 2}) + '</td>' +
                    '<td style="padding: 8px;">' + f.vencimento + '</td>' +
                    '<td style="padding: 8px; text-align: center; color: ' + corAtraso + '; font-weight: bold;">' + (diasAtraso > 0 ? diasAtraso + ' dias' : 'Em dia') + '</td>' +
                '</tr>';
            }).join('');
        }
        
        document.getElementById('clientesModalDividas').classList.add('active');
    }
    
    function clientesFecharModalDividas() {
        document.getElementById('clientesModalDividas').classList.remove('active');
    }
    
    // Ficheiros
    function clientesFichaAnexada(input) {
        if (input.files.length > 0) {
            document.getElementById('clientes_ficha_abertura_nome').value = input.files[0].name;
            clientesMostrarAlerta('âœ… Ficha de abertura anexada!', 'success');
        }
    }
    
    function clientesAbrirFicha() {
        var input = document.getElementById('clientes_ficha_abertura');
        if (input.files.length > 0) {
            window.open(URL.createObjectURL(input.files[0]), '_blank');
        } else {
            clientesMostrarAlerta('âš ï¸ Nenhuma ficha anexada', 'error');
        }
    }
    
    function clientesSeguroAnexado(input) {
        if (input.files.length > 0) {
            clientesFicheirosSeguro = Array.from(input.files);
            document.getElementById('clientes_anexos_seguro_nome').value = input.files.length + ' ficheiro(s)';
        }
    }
    
    function clientesAbrirAnexosSeguro() {
        if (clientesFicheirosSeguro.length > 0) {
            clientesFicheirosSeguro.forEach(function(f) { window.open(URL.createObjectURL(f), '_blank'); });
        } else {
            clientesMostrarAlerta('âš ï¸ Nenhum ficheiro de seguro anexado', 'error');
        }
    }
    
    function clientesIncidenciaAnexada(input) {
        if (input.files.length > 0) {
            clientesFicheirosIncidencias = Array.from(input.files);
            clientesMostrarAlerta('âœ… ' + input.files.length + ' ficheiro(s) de incidÃªncias anexado(s)!', 'success');
        }
    }
    
    function clientesAbrirIncidencias() {
        if (clientesFicheirosIncidencias.length > 0) {
            clientesFicheirosIncidencias.forEach(function(f) { window.open(URL.createObjectURL(f), '_blank'); });
        } else {
            clientesMostrarAlerta('âš ï¸ Nenhum ficheiro de incidÃªncias anexado', 'error');
        }
    }
    
    function clientesAnexosGeraisCarregados(input) {
        if (input.files.length > 0) {
            clientesFicheirosAnexosGerais = Array.from(input.files);
            document.getElementById('clientes_anexos_gerais_nome').value = input.files.length + ' ficheiro(s)';
        }
    }
    
    function clientesAbrirAnexosGerais() {
        if (clientesFicheirosAnexosGerais.length > 0) {
            clientesFicheirosAnexosGerais.forEach(function(f) { window.open(URL.createObjectURL(f), '_blank'); });
        } else {
            clientesMostrarAlerta('âš ï¸ Nenhum ficheiro anexado', 'error');
        }
    }
    
    function clientesVerificarLogin() {
        var comLogin = document.getElementById('clientes_cliente_com_login')?.checked;
        if (comLogin) {
            clientesMostrarAlerta('âœ… Login ativado! Cliente pode aceder ao portal.', 'success');
        } else {
            clientesMostrarAlerta('ğŸ”’ Login desativado!', 'info');
        }
    }
    
    function clientesPesquisarPorNIF() {
        clientesMostrarAlerta('ğŸ” Pesquisa por NIF - funcionalidade de integraÃ§Ã£o SAP', 'info');
    }
    
    // Auxiliares
    function clientesMostrarAlerta(mensagem, tipo) {
        var container = document.getElementById('clientesAlertContainer');
        if (!container) return;
        var id = 'clientesAlert-' + Date.now();
        var alertClass = tipo === 'success' ? 'clientes-alert-success' : (tipo === 'error' ? 'clientes-alert-error' : 'clientes-alert-info');
        container.innerHTML = '<div class="clientes-alert ' + alertClass + '" id="' + id + '">' + mensagem + '<button class="clientes-alert-close" onclick="document.getElementById(\'' + id + '\').remove()">Ã—</button></div>';
        setTimeout(function() { var a = document.getElementById(id); if (a) a.remove(); }, 5000);
    }
    
    function clientesExportarLista() {
        var csv = [['NÃºmero','Nome','NIF','PaÃ­s','Tipo','Plafond','Estado','Conta SAP']].concat(
            clientesLista.map(function(c) { return [c.numero, c.nome_completo, c.contribuinte, c.pais, c.tipo_pais, c.plafonds_atribuidos, c.status, c.conta_sap]; })
        ).map(function(r) { return r.join(';'); }).join('\n');
        
        var blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
        var link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = 'clientes_' + new Date().toISOString().split('T')[0] + '.csv';
        link.click();
        clientesMostrarAlerta('âœ… Lista exportada!', 'success');
    }
    
    function clientesVerHistoricoEmails() {
        // Carregar histÃ³rico de emails do localStorage ou usar dados de demonstraÃ§Ã£o
        var historicoEmails = JSON.parse(localStorage.getItem('erpHistoricoEmails') || '[]');
        
        // Se nÃ£o houver emails, criar dados de demonstraÃ§Ã£o
        if (historicoEmails.length === 0) {
            historicoEmails = [
                { id: 1, data: '2024-12-22 14:30', cliente: 'Transportes RÃ¡pidos do Norte, Lda', clienteNumero: 'C0001', destinatario: 'contabilidade@trn-transportes.pt', tipo: 'Fatura', assunto: 'Fatura FT2024/198 - Transporte Nacional', estado: 'Enviado' },
                { id: 2, data: '2024-12-22 10:15', cliente: 'LogÃ­stica Centro Sul, SA', clienteNumero: 'C0002', destinatario: 'financeiro@lcs-logistica.pt', tipo: 'CMR', assunto: 'CMR Carga - Reserva RES-2024-089', estado: 'Enviado' },
                { id: 3, data: '2024-12-21 16:45', cliente: 'Mercadorias IbÃ©ricas, Lda', clienteNumero: 'C0003', destinatario: 'contabilidade@mercadorias-ibericas.pt', tipo: 'CobranÃ§a', assunto: 'Aviso de CobranÃ§a - Faturas em Atraso', estado: 'Enviado' },
                { id: 4, data: '2024-12-21 09:20', cliente: 'Transportes RÃ¡pidos do Norte, Lda', clienteNumero: 'C0001', destinatario: 'logistica@trn-transportes.pt', tipo: 'CMR', assunto: 'CMR Descarga - Reserva RES-2024-087', estado: 'Enviado' },
                { id: 5, data: '2024-12-20 11:00', cliente: 'LogÃ­stica Centro Sul, SA', clienteNumero: 'C0002', destinatario: 'operacoes@lcs-logistica.pt', tipo: 'NotificaÃ§Ã£o', assunto: 'ConfirmaÃ§Ã£o de Reserva RES-2024-085', estado: 'Lido' },
                { id: 6, data: '2024-12-19 15:30', cliente: 'Mercadorias IbÃ©ricas, Lda', clienteNumero: 'C0003', destinatario: 'logistica@mercadorias-ibericas.pt', tipo: 'Fatura', assunto: 'Fatura FT2024/195 - Transporte Internacional', estado: 'Falhou' },
                { id: 7, data: '2024-12-18 08:45', cliente: 'Transportes RÃ¡pidos do Norte, Lda', clienteNumero: 'C0001', destinatario: 'geral@trn-transportes.pt', tipo: 'NotificaÃ§Ã£o', assunto: 'AtualizaÃ§Ã£o de Dados Cadastrais', estado: 'Enviado' },
            ];
            localStorage.setItem('erpHistoricoEmails', JSON.stringify(historicoEmails));
        }
        
        clientesRenderizarHistoricoEmails(historicoEmails);
        document.getElementById('clientesModalHistoricoEmails').classList.add('active');
    }
    
    function clientesRenderizarHistoricoEmails(emails) {
        var tbody = document.getElementById('clientesTabelaHistoricoEmails');
        if (!tbody) return;
        
        if (emails.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: #666;">Nenhum email encontrado.</td></tr>';
            document.getElementById('clientesContadorEmails').textContent = '0 emails';
            return;
        }
        
        tbody.innerHTML = emails.map(function(e) {
            var tipoIcon = e.tipo === 'Fatura' ? 'ğŸ“„' : (e.tipo === 'CMR' ? 'ğŸš›' : (e.tipo === 'CobranÃ§a' ? 'ğŸ’°' : 'ğŸ””'));
            var estadoClass = e.estado === 'Enviado' ? 'background: #d4edda; color: #155724;' : 
                              (e.estado === 'Lido' ? 'background: #cce5ff; color: #004085;' : 'background: #f8d7da; color: #721c24;');
            var estadoIcon = e.estado === 'Enviado' ? 'âœ…' : (e.estado === 'Lido' ? 'ğŸ‘ï¸' : 'âŒ');
            
            return '<tr style="border-bottom: 1px solid #eee;">' +
                '<td style="padding: 8px;">' + e.data + '</td>' +
                '<td style="padding: 8px;"><strong>' + e.clienteNumero + '</strong><br><small>' + e.cliente + '</small></td>' +
                '<td style="padding: 8px;">' + e.destinatario + '</td>' +
                '<td style="padding: 8px;">' + tipoIcon + ' ' + e.tipo + '</td>' +
                '<td style="padding: 8px;">' + e.assunto + '</td>' +
                '<td style="padding: 8px; text-align: center;"><span style="padding: 3px 8px; border-radius: 12px; font-size: 11px; ' + estadoClass + '">' + estadoIcon + ' ' + e.estado + '</span></td>' +
                '<td style="padding: 8px; text-align: center;">' +
                    '<button class="clientes-btn clientes-btn-azul clientes-btn-sm" onclick="clientesReenviarEmail(' + e.id + ')" title="Reenviar">ğŸ”„</button>' +
                '</td>' +
            '</tr>';
        }).join('');
        
        document.getElementById('clientesContadorEmails').textContent = emails.length + ' email' + (emails.length !== 1 ? 's' : '');
    }
    
    function clientesFiltrarHistoricoEmails() {
        var termo = (document.getElementById('clientesPesquisaEmails')?.value || '').toLowerCase();
        var tipo = document.getElementById('clientesFiltroTipoEmail')?.value || '';
        
        var historicoEmails = JSON.parse(localStorage.getItem('erpHistoricoEmails') || '[]');
        
        var filtrados = historicoEmails.filter(function(e) {
            var matchTermo = termo === '' || 
                e.cliente.toLowerCase().includes(termo) ||
                e.destinatario.toLowerCase().includes(termo) ||
                e.assunto.toLowerCase().includes(termo);
            var matchTipo = tipo === '' || e.tipo === tipo;
            return matchTermo && matchTipo;
        });
        
        clientesRenderizarHistoricoEmails(filtrados);
    }
    
    function clientesReenviarEmail(emailId) {
        clientesMostrarAlerta('ğŸ“§ Email reenviado com sucesso!', 'success');
    }
    
    function clientesFecharModalHistoricoEmails() {
        document.getElementById('clientesModalHistoricoEmails').classList.remove('active');
    }
    
    // FunÃ§Ã£o para filtrar clientes por contador
    function clientesFiltrarPorContador(tipo) {
        var titulo = '';
        var clientesFiltrados = [];
        
        if (tipo === 'todos') {
            titulo = 'ğŸ‘¥ Todos os Clientes';
            clientesFiltrados = clientesLista;
        } else if (tipo === 'ativos') {
            titulo = 'âœ… Clientes Ativos';
            clientesFiltrados = clientesLista.filter(function(c) { return c.status === 'Ativo'; });
        } else if (tipo === 'bloqueados') {
            titulo = 'ğŸ”’ Clientes Bloqueados';
            clientesFiltrados = clientesLista.filter(function(c) { return c.status === 'Bloqueado'; });
        } else if (tipo === 'faturacao') {
            titulo = 'ğŸ’° Clientes por FaturaÃ§Ã£o Anual';
            clientesFiltrados = clientesLista.slice().sort(function(a, b) { 
                return (b.valor_faturado_ano || 0) - (a.valor_faturado_ano || 0); 
            });
        }
        
        document.getElementById('clientesTituloFiltrados').textContent = titulo;
        clientesRenderizarFiltrados(clientesFiltrados);
        document.getElementById('clientesModalFiltrados').classList.add('active');
    }
    
    function clientesRenderizarFiltrados(clientes) {
        var tbody = document.getElementById('clientesTabelaFiltrados');
        if (!tbody) return;
        
        if (clientes.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: #666;">Nenhum cliente encontrado.</td></tr>';
            document.getElementById('clientesContadorFiltrados').textContent = '0 clientes';
            return;
        }
        
        tbody.innerHTML = clientes.map(function(c) {
            var estadoClass = c.status === 'Ativo' ? 'background: #d4edda; color: #155724;' : 
                              (c.status === 'Bloqueado' ? 'background: #f8d7da; color: #721c24;' : 'background: #e9ecef; color: #495057;');
            var estadoIcon = c.status === 'Ativo' ? 'âœ…' : (c.status === 'Bloqueado' ? 'ğŸ”’' : 'â¸ï¸');
            
            return '<tr style="border-bottom: 1px solid #eee; cursor: pointer;" onclick="clientesFecharModalFiltrados(); clientesEditar(\'' + c.numero + '\');">' +
                '<td style="padding: 10px;"><strong>' + c.numero + '</strong></td>' +
                '<td style="padding: 10px;">' + c.nome_completo + '</td>' +
                '<td style="padding: 10px;">' + c.contribuinte + '</td>' +
                '<td style="padding: 10px;">' + c.pais + '</td>' +
                '<td style="padding: 10px; text-align: right;">â‚¬' + (c.plafonds_atribuidos || 0).toLocaleString('pt-PT') + '</td>' +
                '<td style="padding: 10px; text-align: right; font-weight: bold; color: #27ae60;">â‚¬' + (c.valor_faturado_ano || 0).toLocaleString('pt-PT') + '</td>' +
                '<td style="padding: 10px; text-align: center;"><span style="padding: 4px 10px; border-radius: 12px; font-size: 11px; ' + estadoClass + '">' + estadoIcon + ' ' + c.status + '</span></td>' +
            '</tr>';
        }).join('');
        
        document.getElementById('clientesContadorFiltrados').textContent = clientes.length + ' cliente' + (clientes.length !== 1 ? 's' : '');
    }
    
    function clientesFecharModalFiltrados() {
        document.getElementById('clientesModalFiltrados').classList.remove('active');
    }
    
    function clientesReceberDadosSAP() {
        clientesMostrarAlerta('ğŸ“¥ ImportaÃ§Ã£o SAP - funcionalidade de integraÃ§Ã£o', 'info');
    }
    
    // NavegaÃ§Ã£o por Teclado
    function clientesSetupNavegacaoTeclado() {
        var form = document.getElementById('clientesFormCliente');
        if (!form) return;
        
        form.addEventListener('keydown', function(e) {
            var inputs = Array.from(form.querySelectorAll('input:not([type="hidden"]):not([type="file"]):not([type="radio"]):not([type="checkbox"]):not([disabled]):not([readonly]), select, textarea'));
            var idx = inputs.indexOf(document.activeElement);
            
            if (e.key === 'Enter' && !e.shiftKey && document.activeElement.tagName !== 'TEXTAREA') {
                e.preventDefault();
                if (idx < inputs.length - 1) {
                    inputs[idx + 1].focus();
                }
            }
            
            if (e.key === 'ArrowDown' && document.activeElement.tagName !== 'SELECT' && document.activeElement.tagName !== 'TEXTAREA') {
                e.preventDefault();
                if (idx < inputs.length - 1) {
                    inputs[idx + 1].focus();
                }
            }
            
            if (e.key === 'ArrowUp' && document.activeElement.tagName !== 'SELECT' && document.activeElement.tagName !== 'TEXTAREA') {
                e.preventDefault();
                if (idx > 0) {
                    inputs[idx - 1].focus();
                }
            }
        });
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // EXPOSIÃ‡ÃƒO DE FUNÃ‡Ã•ES PÃšBLICAS (acessÃ­veis pelo HTML)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    // FunÃ§Ãµes que precisam ser chamadas pelo HTML (onclick, onsubmit, etc.)
    window.clientesInit = clientesInit;
    window.clientesMostrarVista = clientesMostrarVista;
    window.clientesVerFichaCompleta = clientesVerFichaCompleta;
    window.clientesVerDetalhes = clientesVerDetalhes;
    window.clientesEditar = clientesEditar;
    window.clientesAlterar = clientesAlterar;
    window.clientesGuardar = clientesGuardar;
    window.clientesSairFicha = clientesSairFicha;
    window.clientesDesbloquearCampos = clientesDesbloquearCampos;
    window.clientesConfirmarEliminar = clientesConfirmarEliminar;
    window.clientesFecharModal = clientesFecharModal;
    window.clientesConfirmarEliminacao = clientesConfirmarEliminacao;
    window.clientesPesquisar = clientesPesquisar;
    window.clientesLimparFormulario = clientesLimparFormulario;
    window.clientesReconhecerTipoPais = clientesReconhecerTipoPais;
    window.clientesAtualizarEstado = clientesAtualizarEstado;
    window.clientesCopiarMorada = clientesCopiarMorada;
    window.clientesSeguroAnexado = clientesSeguroAnexado;
    window.clientesAbrirAnexosSeguro = clientesAbrirAnexosSeguro;
    window.clientesIncidenciaAnexada = clientesIncidenciaAnexada;
    window.clientesAbrirIncidencias = clientesAbrirIncidencias;
    window.clientesAnexosGeraisCarregados = clientesAnexosGeraisCarregados;
    window.clientesAbrirAnexosGerais = clientesAbrirAnexosGerais;
    window.clientesVerificarLogin = clientesVerificarLogin;
    window.clientesPesquisarPorNIF = clientesPesquisarPorNIF;
    window.clientesMostrarAlerta = clientesMostrarAlerta;
    window.clientesExportarLista = clientesExportarLista;
    window.clientesVerHistoricoEmails = clientesVerHistoricoEmails;
    window.clientesFiltrarHistoricoEmails = clientesFiltrarHistoricoEmails;
    window.clientesReenviarEmail = clientesReenviarEmail;
    window.clientesFecharModalHistoricoEmails = clientesFecharModalHistoricoEmails;
    window.clientesFiltrarPorContador = clientesFiltrarPorContador;
    window.clientesFecharModalFiltrados = clientesFecharModalFiltrados;
    window.clientesReceberDadosSAP = clientesReceberDadosSAP;
    window.clientesAtualizarLista = clientesAtualizarLista;
    
    // Exportar a lista de clientes para acesso global (usado nas Reservas e outros mÃ³dulos)
    window.clientesLista = clientesLista;
    
    // FunÃ§Ã£o para atualizar a referÃªncia global apÃ³s mudanÃ§as na lista
    window.clientesAtualizarListaGlobal = function() {
        window.clientesLista = clientesLista;
    };
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // VERIFICAÃ‡ÃƒO DE INTEGRIDADE DO MÃ“DULO
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    var _clientesModuloVersao = '1.0';
    var _clientesModuloData = '22/12/2024';
    var _clientesFuncoesObrigatorias = [
        'clientesInit',
        'clientesVerFichaCompleta',
        'clientesBloquearCampos',
        'clientesDesbloquearCampos',
        'clientesSairFicha',
        'clientesGuardar',
        'clientesGuardarDadosComVerificacao'
    ];
    
    // Verificar integridade ao carregar
    window.clientesVerificarIntegridade = function() {
        var problemas = [];
        _clientesFuncoesObrigatorias.forEach(function(fn) {
            if (typeof window[fn] !== 'function' && typeof eval(fn) !== 'function') {
                problemas.push('FunÃ§Ã£o em falta: ' + fn);
            }
        });
        
        if (problemas.length > 0) {
            console.error('â›” ERRO DE INTEGRIDADE NO MÃ“DULO DE CLIENTES:');
            problemas.forEach(function(p) { console.error('  - ' + p); });
            return false;
        }
        
        console.log('âœ… MÃ³dulo de Clientes v' + _clientesModuloVersao + ' (' + _clientesModuloData + ') - Integridade OK');
        return true;
    };
    
    // InformaÃ§Ã£o do mÃ³dulo
    window.clientesModuloInfo = function() {
        return {
            nome: 'GestÃ£o de Clientes',
            versao: _clientesModuloVersao,
            data: _clientesModuloData,
            protegido: true,
            funcoesPublicas: Object.keys(window).filter(function(k) { return k.startsWith('clientes'); }).length
        };
    };
    
    console.log('â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—');
    console.log('â•‘  âœ… MÃ“DULO PROTEGIDO: GestÃ£o de Clientes v' + _clientesModuloVersao + ' carregado      â•‘');
    console.log('â•‘  ğŸ“… Data: ' + _clientesModuloData + '                                          â•‘');
    console.log('â•‘  ğŸ”’ Estado: PROTEGIDO E ENCAPSULADO                              â•‘');
    console.log('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');

    })(window);
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // FIM DO MÃ“DULO PROTEGIDO - GESTÃƒO DE CLIENTES
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    // INICIALIZAÃ‡ÃƒO GARANTIDA DOS CLIENTES
    // Esta funÃ§Ã£o corre depois do IIFE estar definido e garante que os clientes sÃ£o carregados
    (function() {
        // Carregar clientes do localStorage ou criar os de teste
        function carregarClientesIniciais() {
            try {
                var dados = localStorage.getItem('erpClientes');
                if (dados) {
                    var parsed = JSON.parse(dados);
                    if (parsed.lista && parsed.lista.length > 0) {
                        window.clientesLista = parsed.lista;
                        console.log('âœ… Clientes carregados do localStorage: ' + parsed.lista.length);
                        return;
                    }
                }
            } catch (e) {
                console.error('Erro ao carregar clientes:', e);
            }
            
            // Se nÃ£o hÃ¡ clientes no localStorage, criar os 10 de teste
            var clientesTeste = [
                { numero: 'C0001', nome_completo: 'Transportes RÃ¡pidos do Norte, Lda', contribuinte: '501234567', pais: 'Portugal', tipo_pais: 'nacional', status: 'Ativo', modo_faturacao: 'Manual', plafonds_atribuidos: 50000, valor_faturado_ano: 125000, sede_rua: 'Rua da IndÃºstria', sede_porta: '123', sede_lugar: 'Zona Industrial de CeleirÃ³s', sede_cidade: 'Braga', sede_freguesia: 'CeleirÃ³s', sede_cp: '4705-419', sede_concelho: 'Braga', telefone_geral: '+351 253 123 456', email_geral: 'geral@trn-transportes.pt' },
                { numero: 'C0002', nome_completo: 'LogÃ­stica Centro Sul, SA', contribuinte: '502345678', pais: 'Portugal', tipo_pais: 'nacional', status: 'Ativo', modo_faturacao: 'AutomÃ¡tica', plafonds_atribuidos: 75000, valor_faturado_ano: 189000, sede_rua: 'Avenida da RepÃºblica', sede_porta: '456', sede_lugar: 'EdifÃ­cio Empresarial Torre Sul', sede_cidade: 'Lisboa', sede_freguesia: 'Alvalade', sede_cp: '1050-191', sede_concelho: 'Lisboa', telefone_geral: '+351 213 456 789', email_geral: 'geral@lcs-logistica.pt' },
                { numero: 'C0003', nome_completo: 'Mercadorias IbÃ©ricas, Lda', contribuinte: '503456789', pais: 'Portugal', tipo_pais: 'nacional', status: 'Ativo', modo_faturacao: 'Manual', plafonds_atribuidos: 60000, valor_faturado_ano: 156000, sede_rua: 'Rua do ComÃ©rcio', sede_porta: '78', sede_lugar: 'Baixa do Porto', sede_cidade: 'Porto', sede_freguesia: 'Cedofeita', sede_cp: '4050-287', sede_concelho: 'Porto', telefone_geral: '+351 222 567 890', email_geral: 'geral@mercadorias-ibericas.pt' },
                { numero: 'C0004', nome_completo: 'DistribuiÃ§Ã£o Expressa Porto, SA', contribuinte: '504567890', pais: 'Portugal', tipo_pais: 'nacional', status: 'Ativo', modo_faturacao: 'Manual', plafonds_atribuidos: 80000, valor_faturado_ano: 267000, sede_rua: 'Avenida da Boavista', sede_porta: '1500', sede_lugar: 'EdifÃ­cio Burgo', sede_cidade: 'Porto', sede_freguesia: 'Lordelo do Ouro', sede_cp: '4100-130', sede_concelho: 'Porto', telefone_geral: '+351 226 789 012', email_geral: 'geral@dep-express.pt' },
                { numero: 'C0005', nome_completo: 'Cargas Pesadas Alentejo, Lda', contribuinte: '505678901', pais: 'Portugal', tipo_pais: 'nacional', status: 'Ativo', modo_faturacao: 'Manual', plafonds_atribuidos: 45000, valor_faturado_ano: 98000, sede_rua: 'Rua de SÃ£o Francisco', sede_porta: '25', sede_lugar: 'Centro HistÃ³rico', sede_cidade: 'Ã‰vora', sede_freguesia: 'SÃ© e SÃ£o Pedro', sede_cp: '7000-137', sede_concelho: 'Ã‰vora', telefone_geral: '+351 266 890 123', email_geral: 'geral@cpa-cargas.pt' },
                { numero: 'C0006', nome_completo: 'FrigorÃ­ficos do Minho, SA', contribuinte: '506789012', pais: 'Portugal', tipo_pais: 'nacional', status: 'Ativo', modo_faturacao: 'AutomÃ¡tica', plafonds_atribuidos: 90000, valor_faturado_ano: 312000, sede_rua: 'Parque Industrial do Ave', sede_porta: 'Lote 15', sede_lugar: 'Zona Industrial de Lordelo', sede_cidade: 'GuimarÃ£es', sede_freguesia: 'Lordelo', sede_cp: '4810-429', sede_concelho: 'GuimarÃ£es', telefone_geral: '+351 253 901 234', email_geral: 'geral@frigorificos-minho.pt' },
                { numero: 'C0007', nome_completo: 'TransLusitÃ¢nia - Transportes Internacionais, Lda', contribuinte: '507890123', pais: 'Portugal', tipo_pais: 'nacional', status: 'Ativo', modo_faturacao: 'AutomÃ¡tica', plafonds_atribuidos: 120000, valor_faturado_ano: 423000, sede_rua: 'Zona Industrial da Maia', sede_porta: 'ArmazÃ©m 8', sede_lugar: 'Parque Empresarial da Maia', sede_cidade: 'Maia', sede_freguesia: 'Moreira', sede_cp: '4470-177', sede_concelho: 'Maia', telefone_geral: '+351 229 012 345', email_geral: 'geral@translusitania.pt' },
                { numero: 'C0008', nome_completo: 'Cimentos & Inertes do Douro, SA', contribuinte: '508901234', pais: 'Portugal', tipo_pais: 'nacional', status: 'Bloqueado', modo_faturacao: 'Manual', plafonds_atribuidos: 40000, valor_faturado_ano: 67000, sede_rua: 'Estrada Nacional 108', sede_porta: 'Km 45', sede_lugar: 'Zona Industrial de Gondomar', sede_cidade: 'Gondomar', sede_freguesia: 'SÃ£o Cosme', sede_cp: '4420-193', sede_concelho: 'Gondomar', telefone_geral: '+351 224 123 456', email_geral: 'geral@cid-cimentos.pt' },
                { numero: 'C0009', nome_completo: 'Produtos AgrÃ­colas Ribatejo, Lda', contribuinte: '509012345', pais: 'Portugal', tipo_pais: 'nacional', status: 'Ativo', modo_faturacao: 'Manual', plafonds_atribuidos: 55000, valor_faturado_ano: 145000, sede_rua: 'Rua dos Agricultores', sede_porta: '200', sede_lugar: 'Zona AgrÃ­cola de Marvila', sede_cidade: 'SantarÃ©m', sede_freguesia: 'Marvila', sede_cp: '2005-177', sede_concelho: 'SantarÃ©m', telefone_geral: '+351 243 234 567', email_geral: 'geral@par-agricola.pt' },
                { numero: 'C0010', nome_completo: 'ExportaÃ§Ãµes Algarve Premium, SA', contribuinte: '510123456', pais: 'Portugal', tipo_pais: 'nacional', status: 'Ativo', modo_faturacao: 'Manual', plafonds_atribuidos: 100000, valor_faturado_ano: 378000, sede_rua: 'Avenida 5 de Outubro', sede_porta: '350', sede_lugar: 'Centro Empresarial Faro', sede_cidade: 'Faro', sede_freguesia: 'SÃ©', sede_cp: '8000-077', sede_concelho: 'Faro', telefone_geral: '+351 289 345 678', email_geral: 'geral@eap-exportacoes.pt' }
            ];
            
            // Guardar no localStorage
            localStorage.setItem('erpClientes', JSON.stringify({
                lista: clientesTeste,
                proximoNumero: 11
            }));
            
            window.clientesLista = clientesTeste;
            console.log('âœ… 10 clientes de teste criados (C0001-C0010)');
        }
        
        // Carregar imediatamente
        carregarClientesIniciais();
    })();


    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // MÃ“DULO GESTÃƒO DE FROTA v5.8 - JAVASCRIPT PREFIXADO
    // Prefixo: frota
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    // Dados da Frota
    let frotaCamioes = [
      { matricula: '11-AB-22', marca: 'Volvo', ano: 2021, pneus: '315/55/22.5', adr: 'Sim', estado: 'Ativo', inspecao_data: '2025-06-15', tacografo_data: '2025-08-20', licenca_data: '2025-12-01', seguro_data: '2025-03-10', revisao_km: 150000, proxima_revisao_km: 200000, km_atual: 175000, intervencoes: [] },
      { matricula: '33-CD-44', marca: 'Scania', ano: 2020, pneus: '315/60/22.5', adr: 'NÃ£o', estado: 'Ativo', inspecao_data: '2025-04-10', tacografo_data: '2025-05-15', licenca_data: '2025-11-20', seguro_data: '2025-02-28', revisao_km: 180000, proxima_revisao_km: 230000, km_atual: 210000, intervencoes: [{data: '2025-01-15', km: 200000, descricao: 'Troca embraiagem', motivo: 'Desgaste'}] },
      { matricula: '55-EF-66', marca: 'Mercedes', ano: 2019, pneus: '315/55/22.5', adr: 'Sim', estado: 'ManutenÃ§Ã£o', inspecao_data: '2025-01-15', tacografo_data: '2025-03-01', licenca_data: '2025-10-15', seguro_data: '2025-01-20', revisao_km: 220000, proxima_revisao_km: 270000, km_atual: 265000, intervencoes: [] }
    ];

    let frotaReboques = [
      { matricula: 'A-123456', marca: 'Schmitz', ano: 2022, pneus: '385/55/22.5', bobines: 'NÃ£o', mega: 'Sim', teto: 'Sim', adr: 'NÃ£o', estado: 'Ativo', inspecao_data: '2025-07-15', tacografo_data: '2025-09-20', licenca_data: '2025-12-01', seguro_data: '2025-04-10', revisao_km: 100000, proxima_revisao_km: 150000, observacoes: 'Bom estado', intervencoes: [] },
      { matricula: 'A-234567', marca: 'Krone', ano: 2021, pneus: '385/65/22.5', bobines: 'Sim', mega: 'NÃ£o', teto: 'NÃ£o', adr: 'Sim', estado: 'Ativo', inspecao_data: '2025-05-10', tacografo_data: '2025-06-15', licenca_data: '2025-11-20', seguro_data: '2025-03-28', revisao_km: 80000, proxima_revisao_km: 130000, observacoes: 'Porta bobines', intervencoes: [{data: '2025-02-10', km: 75000, descricao: 'Troca de lonas', motivo: 'Desgaste'}] },
      { matricula: 'A-345678', marca: 'Kogel', ano: 2020, pneus: '385/55/22.5', bobines: 'NÃ£o', mega: 'NÃ£o', teto: 'Sim', adr: 'NÃ£o', estado: 'ManutenÃ§Ã£o', inspecao_data: '2025-01-20', tacografo_data: '2025-03-01', licenca_data: '2025-10-15', seguro_data: '2025-02-15', revisao_km: 120000, proxima_revisao_km: 170000, observacoes: 'Em reparaÃ§Ã£o', intervencoes: [] }
    ];

    let frotaCamioesTerceiros = [
      { transportador: 'F1001', transportador_nome: 'Transportes Silva Lda', matricula: '22-XY-33', ano: 2020, seguro_data: '2025-03-15', licenca_data: '2025-06-20', cmr_data: '2025-04-10', estado: 'Ativo' },
      { transportador: 'F1002', transportador_nome: 'LogÃ­stica RÃ¡pida SA', matricula: '44-ZZ-55', ano: 2019, seguro_data: '2025-02-28', licenca_data: '2025-05-15', cmr_data: '2025-03-20', estado: 'Ativo' }
    ];

    let frotaReboquesTerceiros = [
      { transportador: 'F1001', transportador_nome: 'Transportes Silva Lda', matricula: 'R-111222', ano: 2021, seguro_data: '2025-04-20', licenca_data: '2025-07-15', cmr_data: '2025-05-10', estado: 'Ativo' },
      { transportador: 'F1002', transportador_nome: 'LogÃ­stica RÃ¡pida SA', matricula: 'R-333444', ano: 2020, seguro_data: '2025-03-10', licenca_data: '2025-06-01', cmr_data: '2025-04-25', estado: 'Ativo' }
    ];

    let frotaFornecedores = [
      { numero: 'F1001', nome: 'Transportes Silva Lda' },
      { numero: 'F1002', nome: 'LogÃ­stica RÃ¡pida SA' },
      { numero: 'F1003', nome: 'Express Cargo Lda' },
      { numero: 'F1004', nome: 'TransNorte SA' },
      { numero: 'F1005', nome: 'IbÃ©rica Transportes' }
    ];

    let frotaConfigAlertas = { emailOficina: 'oficina@emeutrans.pt', emailCustos: 'controlo.custos@emeutrans.pt', popupLogistica: true, popupCustos: true, diasAntecedencia: 60 };
    let frotaAlertasVistos = [];
    let frotaCamiaoAtual = null, frotaReboqueAtual = null, frotaEditandoCamiao = false, frotaEditandoReboque = false, frotaAcaoConfirmacao = null, frotaIntervencoesTmp = [], frotaIntervencoesRebTmp = [];
    let frotaCamiaoTerAtual = null, frotaReboqueTerAtual = null, frotaEditandoCamiaoTer = false, frotaEditandoReboqueTer = false;

    // InicializaÃ§Ã£o do mÃ³dulo
    function frotaInit() {
      frotaCarregarDados();
      frotaAtualizarListaCamioes();
      frotaAtualizarListaReboques();
      frotaAtualizarListaCamioesTer();
      frotaAtualizarListaReboquesTer();
      frotaAtualizarListaInt();
      frotaAtualizarListaIntReb();
      frotaInitDragAndDrop();
      frotaCarregarOrdemTabs();
      frotaInitRadiosAll();
      frotaInitNavegacaoTeclado();
    }

    function frotaCarregarDados() {
      const saved = localStorage.getItem('frotaDados');
      if (saved) {
        const dados = JSON.parse(saved);
        frotaCamioes = dados.camioes || frotaCamioes;
        frotaReboques = dados.reboques || frotaReboques;
        frotaCamioesTerceiros = dados.camioesTerceiros || frotaCamioesTerceiros;
        frotaReboquesTerceiros = dados.reboquesTerceiros || frotaReboquesTerceiros;
      }
    }

    function frotaGuardarDados() {
      localStorage.setItem('frotaDados', JSON.stringify({
        camioes: frotaCamioes,
        reboques: frotaReboques,
        camioesTerceiros: frotaCamioesTerceiros,
        reboquesTerceiros: frotaReboquesTerceiros
      }));
    }

    function frotaMostrarVista(vista) {
      document.querySelectorAll('.frota-view-section').forEach(v => v.classList.remove('active'));
      document.querySelectorAll('.frota-nav-tab').forEach(t => t.classList.remove('active'));
      const tabAtiva = document.querySelector('.frota-nav-tab[data-vista="' + vista + '"]');
      if (tabAtiva) tabAtiva.classList.add('active');
      
      if (vista === 'listaCamioes') { document.getElementById('frotaVistaListaCamioes').classList.add('active'); frotaAtualizarListaCamioes(); }
      else if (vista === 'novoCamiao') { document.getElementById('frotaVistaNovoCamiao').classList.add('active'); if (!frotaEditandoCamiao) frotaLimparFormCamiao(); }
      else if (vista === 'listaCamioesTerceiros') { document.getElementById('frotaVistaListaCamioesTerceiros').classList.add('active'); frotaAtualizarListaCamioesTer(); }
      else if (vista === 'novoCamiaoTerceiro') { document.getElementById('frotaVistaNovoCamiaoTerceiro').classList.add('active'); if (!frotaEditandoCamiaoTer) frotaLimparFormCamiaoTer(); frotaCarregarFornecedores('frotaCamter_transportador'); }
      else if (vista === 'listaReboques') { document.getElementById('frotaVistaListaReboques').classList.add('active'); frotaAtualizarListaReboques(); }
      else if (vista === 'novoReboque') { document.getElementById('frotaVistaNovoReboque').classList.add('active'); if (!frotaEditandoReboque) frotaLimparFormReboque(); }
      else if (vista === 'listaReboquesTerceiros') { document.getElementById('frotaVistaListaReboquesTerceiros').classList.add('active'); frotaAtualizarListaReboquesTer(); }
      else if (vista === 'novoReboqueTerceiro') { document.getElementById('frotaVistaNovoReboqueTerceiro').classList.add('active'); if (!frotaEditandoReboqueTer) frotaLimparFormReboqueTer(); frotaCarregarFornecedores('frotaRebter_transportador'); }
    }

    function frotaCarregarFornecedores(selectId) {
      let sel = document.getElementById(selectId);
      sel.innerHTML = '<option value="">Selecione o fornecedor...</option>' + frotaFornecedores.map(f => '<option value="' + f.numero + '">' + f.numero + ' - ' + f.nome + '</option>').join('');
    }

    // ========== CAMIÃ•ES PRÃ“PRIOS ==========
    function frotaAtualizarListaCamioes() {
      document.getElementById('frotaTabelaCamioes').innerHTML = frotaCamioes.map(c => {
        let est = c.estado === 'Ativo' ? '<span class="frota-badge frota-badge-success">âœ…</span>' : c.estado === 'ManutenÃ§Ã£o' ? '<span class="frota-badge frota-badge-warning">ğŸ”§</span>' : '<span class="frota-badge frota-badge-danger">â¸ï¸</span>';
        let adr = c.adr === 'Sim' ? '<span class="frota-badge frota-badge-info">â˜¢ï¸</span>' : '<span class="frota-badge frota-badge-secondary">-</span>';
        let insp = frotaVerificarVenc(c.inspecao_data) ? 'color:#c0392b;font-weight:bold;' : '';
        let taco = frotaVerificarVenc(c.tacografo_data) ? 'color:#c0392b;font-weight:bold;' : '';
        return '<tr><td><strong style="color:#e74c3c;">'+c.matricula+'</strong></td><td>'+c.marca+'</td><td>'+c.ano+'</td><td>'+adr+'</td><td style="'+insp+'">'+frotaFmtData(c.inspecao_data)+'</td><td style="'+taco+'">'+frotaFmtData(c.tacografo_data)+'</td><td>'+est+'</td><td class="frota-table-actions"><button class="frota-btn frota-btn-azul frota-btn-icon" onclick="frotaVerCamiao(\''+c.matricula+'\')">ğŸ‘ï¸</button><button class="frota-btn frota-btn-laranja frota-btn-icon" onclick="frotaEditarCamiao(\''+c.matricula+'\')">âœï¸</button><button class="frota-btn frota-btn-vermelho frota-btn-icon" onclick="frotaEliminarCamiao(\''+c.matricula+'\')">ğŸ—‘ï¸</button></td></tr>';
      }).join('');
      document.getElementById('frotaStatTotalCamioes').textContent = frotaCamioes.length;
      document.getElementById('frotaStatCamioesAtivos').textContent = frotaCamioes.filter(c => c.estado === 'Ativo').length;
      document.getElementById('frotaStatCamioesADR').textContent = frotaCamioes.filter(c => c.adr === 'Sim').length;
      document.getElementById('frotaStatCamioesVencer').textContent = frotaCamioes.filter(c => frotaVerificarVenc(c.inspecao_data) || frotaVerificarVenc(c.tacografo_data) || frotaVerificarVenc(c.licenca_data) || frotaVerificarVenc(c.seguro_data)).length;
    }

    function frotaPesquisarCamioes() {
      let t = document.getElementById('frotaPesquisaCamioes').value.toLowerCase();
      let f = frotaCamioes.filter(c => c.matricula.toLowerCase().includes(t) || c.marca.toLowerCase().includes(t));
      document.getElementById('frotaTabelaCamioes').innerHTML = f.map(c => {
        let est = c.estado === 'Ativo' ? '<span class="frota-badge frota-badge-success">âœ…</span>' : c.estado === 'ManutenÃ§Ã£o' ? '<span class="frota-badge frota-badge-warning">ğŸ”§</span>' : '<span class="frota-badge frota-badge-danger">â¸ï¸</span>';
        let adr = c.adr === 'Sim' ? '<span class="frota-badge frota-badge-info">â˜¢ï¸</span>' : '<span class="frota-badge frota-badge-secondary">-</span>';
        return '<tr><td><strong style="color:#e74c3c;">'+c.matricula+'</strong></td><td>'+c.marca+'</td><td>'+c.ano+'</td><td>'+adr+'</td><td>'+frotaFmtData(c.inspecao_data)+'</td><td>'+frotaFmtData(c.tacografo_data)+'</td><td>'+est+'</td><td class="frota-table-actions"><button class="frota-btn frota-btn-azul frota-btn-icon" onclick="frotaVerCamiao(\''+c.matricula+'\')">ğŸ‘ï¸</button><button class="frota-btn frota-btn-laranja frota-btn-icon" onclick="frotaEditarCamiao(\''+c.matricula+'\')">âœï¸</button><button class="frota-btn frota-btn-vermelho frota-btn-icon" onclick="frotaEliminarCamiao(\''+c.matricula+'\')">ğŸ—‘ï¸</button></td></tr>';
      }).join('');
    }

    function frotaLimparFormCamiao() { document.getElementById('frotaFormCamiao').reset(); frotaIntervencoesTmp = []; frotaAtualizarListaInt(); frotaInitRadios('frotaFormCamiao'); frotaEditandoCamiao = false; frotaCamiaoAtual = null; }

    function frotaGuardarCamiao(e) {
      e.preventDefault();
      let d = { 
        matricula: document.getElementById('frotaCam_matricula').value.toUpperCase(), 
        marca: document.getElementById('frotaCam_marca').value, 
        ano: parseInt(document.getElementById('frotaCam_ano').value), 
        pneus: document.getElementById('frotaCam_pneus').value,
        adr: document.querySelector('input[name="frotaCam_adr"]:checked').value, 
        estado: document.querySelector('input[name="frotaCam_estado"]:checked').value, 
        inspecao_data: document.getElementById('frotaCam_inspecao_data').value,
        tacografo_data: document.getElementById('frotaCam_tacografo_data').value,
        licenca_data: document.getElementById('frotaCam_licenca_data').value,
        seguro_data: document.getElementById('frotaCam_seguro_data').value,
        revisao_km: parseInt(document.getElementById('frotaCam_revisao_km').value) || 0,
        revisao_tipo: document.getElementById('frotaCam_revisao_tipo').value,
        proxima_revisao_km: parseInt(document.getElementById('frotaCam_proxima_revisao_km').value) || 0,
        km_atual: parseInt(document.getElementById('frotaCam_km_atual').value) || 0,
        observacoes: document.getElementById('frotaCam_observacoes').value,
        intervencoes: frotaIntervencoesTmp
      };
      if (frotaEditandoCamiao) { let i = frotaCamioes.findIndex(c => c.matricula === frotaCamiaoAtual.matricula); frotaCamioes[i] = d; frotaMostrarAlerta('âœ… Trator atualizado!', 'success'); }
      else { if (frotaCamioes.find(c => c.matricula === d.matricula)) { frotaMostrarAlerta('âš ï¸ MatrÃ­cula jÃ¡ existe!', 'error'); return; } frotaCamioes.push(d); frotaMostrarAlerta('âœ… Trator criado!', 'success'); }
      frotaEditandoCamiao = false; frotaCamiaoAtual = null; frotaGuardarDados(); frotaMostrarVista('listaCamioes');
    }

    function frotaEditarCamiao(m) {
      let c = frotaCamioes.find(x => x.matricula === m); if (!c) return;
      frotaEditandoCamiao = true; frotaCamiaoAtual = c; frotaIntervencoesTmp = [...(c.intervencoes || [])];
      document.getElementById('frotaCam_matricula').value = c.matricula;
      document.getElementById('frotaCam_marca').value = c.marca;
      document.getElementById('frotaCam_ano').value = c.ano;
      document.getElementById('frotaCam_pneus').value = c.pneus || '';
      document.getElementById('frotaCam_inspecao_data').value = c.inspecao_data || '';
      document.getElementById('frotaCam_tacografo_data').value = c.tacografo_data || '';
      document.getElementById('frotaCam_licenca_data').value = c.licenca_data || '';
      document.getElementById('frotaCam_seguro_data').value = c.seguro_data || '';
      document.getElementById('frotaCam_revisao_km').value = c.revisao_km || '';
      document.getElementById('frotaCam_revisao_tipo').value = c.revisao_tipo || '';
      document.getElementById('frotaCam_proxima_revisao_km').value = c.proxima_revisao_km || '';
      document.getElementById('frotaCam_km_atual').value = c.km_atual || '';
      document.getElementById('frotaCam_observacoes').value = c.observacoes || '';
      frotaSetRadio('frotaCam_adr', c.adr); frotaSetRadio('frotaCam_estado', c.estado);
      frotaAtualizarListaInt(); frotaMostrarVista('novoCamiao');
    }

    function frotaVerCamiao(m) {
      let c = frotaCamioes.find(x => x.matricula === m); if (!c) return;
      let msg = 'ğŸš› ' + c.matricula + '\n' + c.marca + ' (' + c.ano + ')\nADR: ' + c.adr + '\nEstado: ' + c.estado + '\n\nInspeÃ§Ã£o: ' + frotaFmtData(c.inspecao_data) + '\nTacÃ³grafo: ' + frotaFmtData(c.tacografo_data) + '\nLicenÃ§a: ' + frotaFmtData(c.licenca_data) + '\nSeguro: ' + frotaFmtData(c.seguro_data) + '\n\nKm: ' + (c.km_atual || '-') + '\nIntervenÃ§Ãµes: ' + (c.intervencoes?.length || 0);
      alert(msg);
    }

    function frotaEliminarCamiao(m) {
      frotaAcaoConfirmacao = () => { frotaCamioes = frotaCamioes.filter(c => c.matricula !== m); frotaGuardarDados(); frotaMostrarAlerta('âœ… Eliminado!', 'success'); frotaMostrarVista('listaCamioes'); };
      document.getElementById('frotaModalMensagem').textContent = 'Eliminar ' + m + '?';
      document.getElementById('frotaModalConfirmacao').classList.add('active');
    }

    // ========== REBOQUES PRÃ“PRIOS ==========
    function frotaAtualizarListaReboques() {
      document.getElementById('frotaTabelaReboques').innerHTML = frotaReboques.map(r => {
        let est = r.estado === 'Ativo' ? '<span class="frota-badge frota-badge-success">âœ…</span>' : r.estado === 'ManutenÃ§Ã£o' ? '<span class="frota-badge frota-badge-warning">ğŸ”§</span>' : '<span class="frota-badge frota-badge-danger">â¸ï¸</span>';
        let bob = r.bobines === 'Sim' ? '<span class="frota-badge frota-badge-purple">ğŸ¯</span>' : '<span class="frota-badge frota-badge-secondary">-</span>';
        let meg = r.mega === 'Sim' ? '<span class="frota-badge frota-badge-info">ğŸ“</span>' : '<span class="frota-badge frota-badge-secondary">-</span>';
        let teto = r.teto === 'Sim' ? '<span class="frota-badge frota-badge-success">â¬†ï¸</span>' : '<span class="frota-badge frota-badge-secondary">-</span>';
        let adr = r.adr === 'Sim' ? '<span class="frota-badge frota-badge-warning">â˜¢ï¸</span>' : '<span class="frota-badge frota-badge-secondary">-</span>';
        let insp = frotaVerificarVenc(r.inspecao_data) ? 'color:#c0392b;font-weight:bold;' : '';
        return '<tr><td><strong style="color:#9b59b6;">'+r.matricula+'</strong></td><td>'+r.marca+'</td><td>'+r.ano+'</td><td>'+bob+'</td><td>'+meg+'</td><td>'+teto+'</td><td>'+adr+'</td><td style="'+insp+'">'+frotaFmtData(r.inspecao_data)+'</td><td>'+est+'</td><td class="frota-table-actions"><button class="frota-btn frota-btn-azul frota-btn-icon" onclick="frotaVerReboque(\''+r.matricula+'\')">ğŸ‘ï¸</button><button class="frota-btn frota-btn-laranja frota-btn-icon" onclick="frotaEditarReboque(\''+r.matricula+'\')">âœï¸</button><button class="frota-btn frota-btn-vermelho frota-btn-icon" onclick="frotaEliminarReboque(\''+r.matricula+'\')">ğŸ—‘ï¸</button></td></tr>';
      }).join('');
      document.getElementById('frotaStatTotalReboques').textContent = frotaReboques.length;
      document.getElementById('frotaStatReboquesAtivos').textContent = frotaReboques.filter(r => r.estado === 'Ativo').length;
      document.getElementById('frotaStatReboquesBobines').textContent = frotaReboques.filter(r => r.bobines === 'Sim').length;
      document.getElementById('frotaStatReboquesMega').textContent = frotaReboques.filter(r => r.mega === 'Sim').length;
      document.getElementById('frotaStatReboquesTeto').textContent = frotaReboques.filter(r => r.teto === 'Sim').length;
      document.getElementById('frotaStatReboquesADR').textContent = frotaReboques.filter(r => r.adr === 'Sim').length;
      document.getElementById('frotaStatReboquesVencer').textContent = frotaReboques.filter(r => frotaVerificarVenc(r.inspecao_data) || frotaVerificarVenc(r.tacografo_data) || frotaVerificarVenc(r.licenca_data) || frotaVerificarVenc(r.seguro_data)).length;
    }

    function frotaPesquisarReboques() {
      let t = document.getElementById('frotaPesquisaReboques').value.toLowerCase();
      let f = frotaReboques.filter(r => r.matricula.toLowerCase().includes(t) || r.marca.toLowerCase().includes(t));
      document.getElementById('frotaTabelaReboques').innerHTML = f.map(r => {
        let est = r.estado === 'Ativo' ? '<span class="frota-badge frota-badge-success">âœ…</span>' : r.estado === 'ManutenÃ§Ã£o' ? '<span class="frota-badge frota-badge-warning">ğŸ”§</span>' : '<span class="frota-badge frota-badge-danger">â¸ï¸</span>';
        let bob = r.bobines === 'Sim' ? '<span class="frota-badge frota-badge-purple">ğŸ¯</span>' : '<span class="frota-badge frota-badge-secondary">-</span>';
        let meg = r.mega === 'Sim' ? '<span class="frota-badge frota-badge-info">ğŸ“</span>' : '<span class="frota-badge frota-badge-secondary">-</span>';
        let teto = r.teto === 'Sim' ? '<span class="frota-badge frota-badge-success">â¬†ï¸</span>' : '<span class="frota-badge frota-badge-secondary">-</span>';
        let adr = r.adr === 'Sim' ? '<span class="frota-badge frota-badge-warning">â˜¢ï¸</span>' : '<span class="frota-badge frota-badge-secondary">-</span>';
        return '<tr><td><strong style="color:#9b59b6;">'+r.matricula+'</strong></td><td>'+r.marca+'</td><td>'+r.ano+'</td><td>'+bob+'</td><td>'+meg+'</td><td>'+teto+'</td><td>'+adr+'</td><td>'+frotaFmtData(r.inspecao_data)+'</td><td>'+est+'</td><td class="frota-table-actions"><button class="frota-btn frota-btn-azul frota-btn-icon" onclick="frotaVerReboque(\''+r.matricula+'\')">ğŸ‘ï¸</button><button class="frota-btn frota-btn-laranja frota-btn-icon" onclick="frotaEditarReboque(\''+r.matricula+'\')">âœï¸</button><button class="frota-btn frota-btn-vermelho frota-btn-icon" onclick="frotaEliminarReboque(\''+r.matricula+'\')">ğŸ—‘ï¸</button></td></tr>';
      }).join('');
    }

    function frotaLimparFormReboque() { document.getElementById('frotaFormReboque').reset(); frotaIntervencoesRebTmp = []; frotaAtualizarListaIntReb(); frotaInitRadios('frotaFormReboque'); frotaEditandoReboque = false; frotaReboqueAtual = null; }

    function frotaGuardarReboque(e) {
      e.preventDefault();
      let d = { 
        matricula: document.getElementById('frotaReb_matricula').value.toUpperCase(), 
        marca: document.getElementById('frotaReb_marca').value, 
        ano: parseInt(document.getElementById('frotaReb_ano').value), 
        pneus: document.getElementById('frotaReb_pneus').value,
        bobines: document.querySelector('input[name="frotaReb_bobines"]:checked').value, 
        mega: document.querySelector('input[name="frotaReb_mega"]:checked').value, 
        teto: document.querySelector('input[name="frotaReb_teto"]:checked').value,
        adr: document.querySelector('input[name="frotaReb_adr"]:checked').value,
        estado: document.querySelector('input[name="frotaReb_estado"]:checked').value, 
        inspecao_data: document.getElementById('frotaReb_inspecao_data').value,
        tacografo_data: document.getElementById('frotaReb_tacografo_data').value,
        licenca_data: document.getElementById('frotaReb_licenca_data').value,
        seguro_data: document.getElementById('frotaReb_seguro_data').value,
        revisao_km: parseInt(document.getElementById('frotaReb_revisao_km').value) || 0,
        revisao_tipo: document.getElementById('frotaReb_revisao_tipo').value,
        proxima_revisao_km: parseInt(document.getElementById('frotaReb_proxima_revisao_km').value) || 0,
        observacoes: document.getElementById('frotaReb_observacoes').value,
        intervencoes: frotaIntervencoesRebTmp
      };
      if (frotaEditandoReboque) { let i = frotaReboques.findIndex(r => r.matricula === frotaReboqueAtual.matricula); frotaReboques[i] = d; frotaMostrarAlerta('âœ… Reboque atualizado!', 'success'); }
      else { if (frotaReboques.find(r => r.matricula === d.matricula)) { frotaMostrarAlerta('âš ï¸ MatrÃ­cula jÃ¡ existe!', 'error'); return; } frotaReboques.push(d); frotaMostrarAlerta('âœ… Reboque criado!', 'success'); }
      frotaEditandoReboque = false; frotaReboqueAtual = null; frotaGuardarDados(); frotaMostrarVista('listaReboques');
    }

    function frotaEditarReboque(m) {
      let r = frotaReboques.find(x => x.matricula === m); if (!r) return;
      frotaEditandoReboque = true; frotaReboqueAtual = r; frotaIntervencoesRebTmp = [...(r.intervencoes || [])];
      document.getElementById('frotaReb_matricula').value = r.matricula;
      document.getElementById('frotaReb_marca').value = r.marca;
      document.getElementById('frotaReb_ano').value = r.ano;
      document.getElementById('frotaReb_pneus').value = r.pneus || '';
      document.getElementById('frotaReb_inspecao_data').value = r.inspecao_data || '';
      document.getElementById('frotaReb_tacografo_data').value = r.tacografo_data || '';
      document.getElementById('frotaReb_licenca_data').value = r.licenca_data || '';
      document.getElementById('frotaReb_seguro_data').value = r.seguro_data || '';
      document.getElementById('frotaReb_revisao_km').value = r.revisao_km || '';
      document.getElementById('frotaReb_revisao_tipo').value = r.revisao_tipo || '';
      document.getElementById('frotaReb_proxima_revisao_km').value = r.proxima_revisao_km || '';
      document.getElementById('frotaReb_observacoes').value = r.observacoes || '';
      frotaSetRadio('frotaReb_bobines', r.bobines); frotaSetRadio('frotaReb_mega', r.mega); frotaSetRadio('frotaReb_teto', r.teto);
      frotaSetRadio('frotaReb_adr', r.adr); frotaSetRadio('frotaReb_estado', r.estado);
      frotaAtualizarListaIntReb(); frotaMostrarVista('novoReboque');
    }

    function frotaVerReboque(m) {
      let r = frotaReboques.find(x => x.matricula === m); if (!r) return;
      let msg = 'ğŸšƒ ' + r.matricula + '\n' + r.marca + ' (' + r.ano + ')\nBobines: ' + r.bobines + '\nMega: ' + r.mega + '\nTeto: ' + r.teto + '\nADR: ' + r.adr + '\nEstado: ' + r.estado + '\n\nInspeÃ§Ã£o: ' + frotaFmtData(r.inspecao_data) + '\nTacÃ³grafo: ' + frotaFmtData(r.tacografo_data) + '\nLicenÃ§a: ' + frotaFmtData(r.licenca_data) + '\nSeguro: ' + frotaFmtData(r.seguro_data);
      alert(msg);
    }

    function frotaEliminarReboque(m) {
      frotaAcaoConfirmacao = () => { frotaReboques = frotaReboques.filter(r => r.matricula !== m); frotaGuardarDados(); frotaMostrarAlerta('âœ… Eliminado!', 'success'); frotaMostrarVista('listaReboques'); };
      document.getElementById('frotaModalMensagem').textContent = 'Eliminar ' + m + '?';
      document.getElementById('frotaModalConfirmacao').classList.add('active');
    }

    // ========== CAMIÃ•ES TERCEIROS ==========
    function frotaAtualizarListaCamioesTer() {
      document.getElementById('frotaTabelaCamioesTer').innerHTML = frotaCamioesTerceiros.map(c => {
        let est = c.estado === 'Ativo' ? '<span class="frota-badge frota-badge-success">âœ…</span>' : '<span class="frota-badge frota-badge-danger">â¸ï¸</span>';
        return '<tr><td>'+c.transportador_nome+'</td><td><strong>'+c.matricula+'</strong></td><td>'+c.ano+'</td><td>'+frotaFmtData(c.seguro_data)+'</td><td>'+frotaFmtData(c.licenca_data)+'</td><td>'+frotaFmtData(c.cmr_data)+'</td><td>'+est+'</td><td class="frota-table-actions"><button class="frota-btn frota-btn-azul frota-btn-icon" onclick="frotaVerCamiaoTer(\''+c.matricula+'\')">ğŸ‘ï¸</button><button class="frota-btn frota-btn-laranja frota-btn-icon" onclick="frotaEditarCamiaoTer(\''+c.matricula+'\')">âœï¸</button><button class="frota-btn frota-btn-vermelho frota-btn-icon" onclick="frotaEliminarCamiaoTer(\''+c.matricula+'\')">ğŸ—‘ï¸</button></td></tr>';
      }).join('');
      document.getElementById('frotaStatTotalCamioesTer').textContent = frotaCamioesTerceiros.length;
      document.getElementById('frotaStatCamioesTerAtivos').textContent = frotaCamioesTerceiros.filter(c => c.estado === 'Ativo').length;
      document.getElementById('frotaStatCamioesTerVencer').textContent = frotaCamioesTerceiros.filter(c => frotaVerificarVenc(c.seguro_data) || frotaVerificarVenc(c.licenca_data) || frotaVerificarVenc(c.cmr_data)).length;
    }

    function frotaPesquisarCamioesTer() {
      let t = document.getElementById('frotaPesquisaCamioesTer').value.toLowerCase();
      let f = frotaCamioesTerceiros.filter(c => c.matricula.toLowerCase().includes(t) || c.transportador_nome.toLowerCase().includes(t));
      document.getElementById('frotaTabelaCamioesTer').innerHTML = f.map(c => {
        let est = c.estado === 'Ativo' ? '<span class="frota-badge frota-badge-success">âœ…</span>' : '<span class="frota-badge frota-badge-danger">â¸ï¸</span>';
        return '<tr><td>'+c.transportador_nome+'</td><td><strong>'+c.matricula+'</strong></td><td>'+c.ano+'</td><td>'+frotaFmtData(c.seguro_data)+'</td><td>'+frotaFmtData(c.licenca_data)+'</td><td>'+frotaFmtData(c.cmr_data)+'</td><td>'+est+'</td><td class="frota-table-actions"><button class="frota-btn frota-btn-azul frota-btn-icon" onclick="frotaVerCamiaoTer(\''+c.matricula+'\')">ğŸ‘ï¸</button><button class="frota-btn frota-btn-laranja frota-btn-icon" onclick="frotaEditarCamiaoTer(\''+c.matricula+'\')">âœï¸</button><button class="frota-btn frota-btn-vermelho frota-btn-icon" onclick="frotaEliminarCamiaoTer(\''+c.matricula+'\')">ğŸ—‘ï¸</button></td></tr>';
      }).join('');
    }

    function frotaLimparFormCamiaoTer() { document.getElementById('frotaFormCamiaoTer').reset(); frotaInitRadios('frotaFormCamiaoTer'); frotaEditandoCamiaoTer = false; frotaCamiaoTerAtual = null; }

    function frotaGuardarCamiaoTer(e) {
      e.preventDefault();
      let sel = document.getElementById('frotaCamter_transportador');
      let d = { 
        transportador: sel.value,
        transportador_nome: sel.options[sel.selectedIndex].text.split(' - ')[1] || sel.value,
        matricula: document.getElementById('frotaCamter_matricula').value.toUpperCase(), 
        ano: parseInt(document.getElementById('frotaCamter_ano').value),
        seguro_data: document.getElementById('frotaCamter_seguro_data').value,
        licenca_data: document.getElementById('frotaCamter_licenca_data').value,
        cmr_data: document.getElementById('frotaCamter_cmr_data').value,
        estado: document.querySelector('input[name="frotaCamter_estado"]:checked').value
      };
      if (frotaEditandoCamiaoTer) { let i = frotaCamioesTerceiros.findIndex(c => c.matricula === frotaCamiaoTerAtual.matricula); frotaCamioesTerceiros[i] = d; frotaMostrarAlerta('âœ… Trator contratado atualizado!', 'success'); }
      else { if (frotaCamioesTerceiros.find(c => c.matricula === d.matricula)) { frotaMostrarAlerta('âš ï¸ MatrÃ­cula jÃ¡ existe!', 'error'); return; } frotaCamioesTerceiros.push(d); frotaMostrarAlerta('âœ… Trator contratado criado!', 'success'); }
      frotaEditandoCamiaoTer = false; frotaCamiaoTerAtual = null; frotaGuardarDados(); frotaMostrarVista('listaCamioesTerceiros');
    }

    function frotaEditarCamiaoTer(m) { let c = frotaCamioesTerceiros.find(x => x.matricula === m); if (!c) return; frotaEditandoCamiaoTer = true; frotaCamiaoTerAtual = c; frotaCarregarFornecedores('frotaCamter_transportador'); document.getElementById('frotaCamter_transportador').value = c.transportador; document.getElementById('frotaCamter_matricula').value = c.matricula; document.getElementById('frotaCamter_ano').value = c.ano; document.getElementById('frotaCamter_seguro_data').value = c.seguro_data || ''; document.getElementById('frotaCamter_licenca_data').value = c.licenca_data || ''; document.getElementById('frotaCamter_cmr_data').value = c.cmr_data || ''; frotaSetRadio('frotaCamter_estado', c.estado); frotaMostrarVista('novoCamiaoTerceiro'); }
    function frotaVerCamiaoTer(m) { let c = frotaCamioesTerceiros.find(x => x.matricula === m); if (!c) return; alert('ğŸšš ' + c.matricula + '\nTransportador: ' + c.transportador_nome + '\nAno: ' + c.ano + '\nSeguro: ' + frotaFmtData(c.seguro_data) + '\nLicenÃ§a: ' + frotaFmtData(c.licenca_data) + '\nCMR: ' + frotaFmtData(c.cmr_data) + '\nEstado: ' + c.estado); }
    function frotaEliminarCamiaoTer(m) { frotaAcaoConfirmacao = () => { frotaCamioesTerceiros = frotaCamioesTerceiros.filter(c => c.matricula !== m); frotaGuardarDados(); frotaMostrarAlerta('âœ… Eliminado!', 'success'); frotaMostrarVista('listaCamioesTerceiros'); }; document.getElementById('frotaModalMensagem').textContent = 'Eliminar ' + m + '?'; document.getElementById('frotaModalConfirmacao').classList.add('active'); }

    // ========== REBOQUES TERCEIROS ==========
    function frotaAtualizarListaReboquesTer() {
      document.getElementById('frotaTabelaReboquesTer').innerHTML = frotaReboquesTerceiros.map(r => {
        let est = r.estado === 'Ativo' ? '<span class="frota-badge frota-badge-success">âœ…</span>' : '<span class="frota-badge frota-badge-danger">â¸ï¸</span>';
        return '<tr><td>'+r.transportador_nome+'</td><td><strong style="color:#9b59b6;">'+r.matricula+'</strong></td><td>'+r.ano+'</td><td>'+frotaFmtData(r.seguro_data)+'</td><td>'+frotaFmtData(r.licenca_data)+'</td><td>'+frotaFmtData(r.cmr_data)+'</td><td>'+est+'</td><td class="frota-table-actions"><button class="frota-btn frota-btn-azul frota-btn-icon" onclick="frotaVerReboqueTer(\''+r.matricula+'\')">ğŸ‘ï¸</button><button class="frota-btn frota-btn-laranja frota-btn-icon" onclick="frotaEditarReboqueTer(\''+r.matricula+'\')">âœï¸</button><button class="frota-btn frota-btn-vermelho frota-btn-icon" onclick="frotaEliminarReboqueTer(\''+r.matricula+'\')">ğŸ—‘ï¸</button></td></tr>';
      }).join('');
      document.getElementById('frotaStatTotalReboquesTer').textContent = frotaReboquesTerceiros.length;
      document.getElementById('frotaStatReboquesTerAtivos').textContent = frotaReboquesTerceiros.filter(r => r.estado === 'Ativo').length;
      document.getElementById('frotaStatReboquesTerVencer').textContent = frotaReboquesTerceiros.filter(r => frotaVerificarVenc(r.seguro_data) || frotaVerificarVenc(r.licenca_data) || frotaVerificarVenc(r.cmr_data)).length;
    }

    function frotaPesquisarReboquesTer() { let t = document.getElementById('frotaPesquisaReboquesTer').value.toLowerCase(); let f = frotaReboquesTerceiros.filter(r => r.matricula.toLowerCase().includes(t) || r.transportador_nome.toLowerCase().includes(t)); document.getElementById('frotaTabelaReboquesTer').innerHTML = f.map(r => { let est = r.estado === 'Ativo' ? '<span class="frota-badge frota-badge-success">âœ…</span>' : '<span class="frota-badge frota-badge-danger">â¸ï¸</span>'; return '<tr><td>'+r.transportador_nome+'</td><td><strong style="color:#9b59b6;">'+r.matricula+'</strong></td><td>'+r.ano+'</td><td>'+frotaFmtData(r.seguro_data)+'</td><td>'+frotaFmtData(r.licenca_data)+'</td><td>'+frotaFmtData(r.cmr_data)+'</td><td>'+est+'</td><td class="frota-table-actions"><button class="frota-btn frota-btn-azul frota-btn-icon" onclick="frotaVerReboqueTer(\''+r.matricula+'\')">ğŸ‘ï¸</button><button class="frota-btn frota-btn-laranja frota-btn-icon" onclick="frotaEditarReboqueTer(\''+r.matricula+'\')">âœï¸</button><button class="frota-btn frota-btn-vermelho frota-btn-icon" onclick="frotaEliminarReboqueTer(\''+r.matricula+'\')">ğŸ—‘ï¸</button></td></tr>'; }).join(''); }
    function frotaLimparFormReboqueTer() { document.getElementById('frotaFormReboqueTer').reset(); frotaInitRadios('frotaFormReboqueTer'); frotaEditandoReboqueTer = false; frotaReboqueTerAtual = null; }

    function frotaGuardarReboqueTer(e) {
      e.preventDefault();
      let sel = document.getElementById('frotaRebter_transportador');
      let d = { transportador: sel.value, transportador_nome: sel.options[sel.selectedIndex].text.split(' - ')[1] || sel.value, matricula: document.getElementById('frotaRebter_matricula').value.toUpperCase(), ano: parseInt(document.getElementById('frotaRebter_ano').value), seguro_data: document.getElementById('frotaRebter_seguro_data').value, licenca_data: document.getElementById('frotaRebter_licenca_data').value, cmr_data: document.getElementById('frotaRebter_cmr_data').value, estado: document.querySelector('input[name="frotaRebter_estado"]:checked').value };
      if (frotaEditandoReboqueTer) { let i = frotaReboquesTerceiros.findIndex(r => r.matricula === frotaReboqueTerAtual.matricula); frotaReboquesTerceiros[i] = d; frotaMostrarAlerta('âœ… Reboque contratado atualizado!', 'success'); }
      else { if (frotaReboquesTerceiros.find(r => r.matricula === d.matricula)) { frotaMostrarAlerta('âš ï¸ MatrÃ­cula jÃ¡ existe!', 'error'); return; } frotaReboquesTerceiros.push(d); frotaMostrarAlerta('âœ… Reboque contratado criado!', 'success'); }
      frotaEditandoReboqueTer = false; frotaReboqueTerAtual = null; frotaGuardarDados(); frotaMostrarVista('listaReboquesTerceiros');
    }

    function frotaEditarReboqueTer(m) { let r = frotaReboquesTerceiros.find(x => x.matricula === m); if (!r) return; frotaEditandoReboqueTer = true; frotaReboqueTerAtual = r; frotaCarregarFornecedores('frotaRebter_transportador'); document.getElementById('frotaRebter_transportador').value = r.transportador; document.getElementById('frotaRebter_matricula').value = r.matricula; document.getElementById('frotaRebter_ano').value = r.ano; document.getElementById('frotaRebter_seguro_data').value = r.seguro_data || ''; document.getElementById('frotaRebter_licenca_data').value = r.licenca_data || ''; document.getElementById('frotaRebter_cmr_data').value = r.cmr_data || ''; frotaSetRadio('frotaRebter_estado', r.estado); frotaMostrarVista('novoReboqueTerceiro'); }
    function frotaVerReboqueTer(m) { let r = frotaReboquesTerceiros.find(x => x.matricula === m); if (!r) return; alert('ğŸš‹ ' + r.matricula + '\nTransportador: ' + r.transportador_nome + '\nAno: ' + r.ano + '\nSeguro: ' + frotaFmtData(r.seguro_data) + '\nLicenÃ§a: ' + frotaFmtData(r.licenca_data) + '\nCMR: ' + frotaFmtData(r.cmr_data) + '\nEstado: ' + r.estado); }
    function frotaEliminarReboqueTer(m) { frotaAcaoConfirmacao = () => { frotaReboquesTerceiros = frotaReboquesTerceiros.filter(r => r.matricula !== m); frotaGuardarDados(); frotaMostrarAlerta('âœ… Eliminado!', 'success'); frotaMostrarVista('listaReboquesTerceiros'); }; document.getElementById('frotaModalMensagem').textContent = 'Eliminar ' + m + '?'; document.getElementById('frotaModalConfirmacao').classList.add('active'); }

    // ========== INTERVENÃ‡Ã•ES ==========
    function frotaAbrirModalIntervencao() { document.getElementById('frotaInt_data').value = new Date().toISOString().split('T')[0]; document.getElementById('frotaInt_km').value = ''; document.getElementById('frotaInt_descricao').value = ''; document.getElementById('frotaInt_motivo').value = ''; document.getElementById('frotaInt_docs_nome').value = ''; document.getElementById('frotaModalIntervencao').classList.add('active'); }
    function frotaFecharModalIntervencao() { document.getElementById('frotaModalIntervencao').classList.remove('active'); }
    function frotaSalvarIntervencao() { let int = { data: document.getElementById('frotaInt_data').value, km: parseInt(document.getElementById('frotaInt_km').value) || 0, descricao: document.getElementById('frotaInt_descricao').value, motivo: document.getElementById('frotaInt_motivo').value }; if (!int.descricao) { frotaMostrarAlerta('âš ï¸ Preencha a descriÃ§Ã£o!', 'error'); return; } frotaIntervencoesTmp.push(int); frotaAtualizarListaInt(); frotaFecharModalIntervencao(); frotaMostrarAlerta('âœ… IntervenÃ§Ã£o adicionada!', 'success'); }
    function frotaAtualizarListaInt() { let c = document.getElementById('frotaListaIntervencoes'); if (!c) return; if (frotaIntervencoesTmp.length === 0) { c.innerHTML = '<p style="color:#666;font-size:11px;">Nenhuma intervenÃ§Ã£o.</p>'; } else { c.innerHTML = frotaIntervencoesTmp.map((i, idx) => '<div class="frota-intervencao-item"><div class="frota-intervencao-header"><strong>' + frotaFmtData(i.data) + ' - ' + i.km + ' Km</strong><button type="button" class="frota-btn frota-btn-vermelho frota-btn-sm" onclick="frotaRemoverInt(' + idx + ')">ğŸ—‘ï¸</button></div><p style="font-size:11px;"><b>DescriÃ§Ã£o:</b> ' + i.descricao + '</p><p style="font-size:11px;"><b>Motivo:</b> ' + i.motivo + '</p></div>').join(''); } }
    function frotaRemoverInt(i) { frotaIntervencoesTmp.splice(i, 1); frotaAtualizarListaInt(); }

    function frotaAbrirModalIntervencaoReb() { document.getElementById('frotaIntReb_data').value = new Date().toISOString().split('T')[0]; document.getElementById('frotaIntReb_km').value = ''; document.getElementById('frotaIntReb_descricao').value = ''; document.getElementById('frotaIntReb_motivo').value = ''; document.getElementById('frotaIntReb_docs_nome').value = ''; document.getElementById('frotaModalIntervencaoReb').classList.add('active'); }
    function frotaFecharModalIntervencaoReb() { document.getElementById('frotaModalIntervencaoReb').classList.remove('active'); }
    function frotaSalvarIntervencaoReb() { let int = { data: document.getElementById('frotaIntReb_data').value, km: parseInt(document.getElementById('frotaIntReb_km').value) || 0, descricao: document.getElementById('frotaIntReb_descricao').value, motivo: document.getElementById('frotaIntReb_motivo').value }; if (!int.descricao) { frotaMostrarAlerta('âš ï¸ Preencha a descriÃ§Ã£o!', 'error'); return; } frotaIntervencoesRebTmp.push(int); frotaAtualizarListaIntReb(); frotaFecharModalIntervencaoReb(); frotaMostrarAlerta('âœ… IntervenÃ§Ã£o adicionada!', 'success'); }
    function frotaAtualizarListaIntReb() { let c = document.getElementById('frotaListaIntervencoesReb'); if (!c) return; if (frotaIntervencoesRebTmp.length === 0) { c.innerHTML = '<p style="color:#666;font-size:11px;">Nenhuma intervenÃ§Ã£o.</p>'; } else { c.innerHTML = frotaIntervencoesRebTmp.map((i, idx) => '<div class="frota-intervencao-item"><div class="frota-intervencao-header"><strong>' + frotaFmtData(i.data) + ' - ' + i.km + ' Km</strong><button type="button" class="frota-btn frota-btn-vermelho frota-btn-sm" onclick="frotaRemoverIntReb(' + idx + ')">ğŸ—‘ï¸</button></div><p style="font-size:11px;"><b>DescriÃ§Ã£o:</b> ' + i.descricao + '</p><p style="font-size:11px;"><b>Motivo:</b> ' + i.motivo + '</p></div>').join(''); } }
    function frotaRemoverIntReb(i) { frotaIntervencoesRebTmp.splice(i, 1); frotaAtualizarListaIntReb(); }

    // ========== ALERTAS ==========
    function frotaAbrirConfigAlertas() { document.getElementById('frotaModalConfigAlertas').classList.add('active'); }
    function frotaFecharConfigAlertas() { document.getElementById('frotaModalConfigAlertas').classList.remove('active'); }
    function frotaGuardarConfigAlertas() { frotaConfigAlertas = { emailOficina: document.getElementById('frotaAlertaEmailOficina').value, emailCustos: document.getElementById('frotaAlertaEmailCustos').value, popupLogistica: document.getElementById('frotaAlertaPopupLogistica').checked, popupCustos: document.getElementById('frotaAlertaPopupCustos').checked, diasAntecedencia: parseInt(document.getElementById('frotaAlertaDias').value) || 60 }; frotaFecharConfigAlertas(); frotaMostrarAlerta('âœ… ConfiguraÃ§Ã£o guardada!', 'success'); }
    function frotaTestarAlertas() { frotaVerificarAlertasCompletos(); }
    function frotaFecharAlertaVencimentos() { document.getElementById('frotaModalAlertaVencimentos').classList.remove('active'); }
    function frotaMarcarAlertasVistos() { let hoje = new Date().toDateString(); frotaAlertasVistos.push(hoje); frotaFecharAlertaVencimentos(); frotaMostrarAlerta('âœ… Alertas marcados como vistos!', 'success'); }

    function frotaVerificarAlertasCompletos() {
      let alertas = [];
      let dias = frotaConfigAlertas.diasAntecedencia || 60;
      frotaCamioes.forEach(c => { if (frotaVerificarVencDias(c.inspecao_data, dias)) alertas.push({tipo:'ğŸš› Trator', matricula: c.matricula, documento: 'InspeÃ§Ã£o', data: c.inspecao_data, diasRestantes: frotaCalcDias(c.inspecao_data)}); if (frotaVerificarVencDias(c.tacografo_data, dias)) alertas.push({tipo:'ğŸš› Trator', matricula: c.matricula, documento: 'TacÃ³grafo', data: c.tacografo_data, diasRestantes: frotaCalcDias(c.tacografo_data)}); if (frotaVerificarVencDias(c.licenca_data, dias)) alertas.push({tipo:'ğŸš› Trator', matricula: c.matricula, documento: 'LicenÃ§a', data: c.licenca_data, diasRestantes: frotaCalcDias(c.licenca_data)}); if (frotaVerificarVencDias(c.seguro_data, dias)) alertas.push({tipo:'ğŸš› Trator', matricula: c.matricula, documento: 'Seguro', data: c.seguro_data, diasRestantes: frotaCalcDias(c.seguro_data)}); });
      frotaReboques.forEach(r => { if (frotaVerificarVencDias(r.inspecao_data, dias)) alertas.push({tipo:'ğŸšƒ Reboque', matricula: r.matricula, documento: 'InspeÃ§Ã£o', data: r.inspecao_data, diasRestantes: frotaCalcDias(r.inspecao_data)}); if (frotaVerificarVencDias(r.tacografo_data, dias)) alertas.push({tipo:'ğŸšƒ Reboque', matricula: r.matricula, documento: 'TacÃ³grafo', data: r.tacografo_data, diasRestantes: frotaCalcDias(r.tacografo_data)}); if (frotaVerificarVencDias(r.licenca_data, dias)) alertas.push({tipo:'ğŸšƒ Reboque', matricula: r.matricula, documento: 'LicenÃ§a', data: r.licenca_data, diasRestantes: frotaCalcDias(r.licenca_data)}); if (frotaVerificarVencDias(r.seguro_data, dias)) alertas.push({tipo:'ğŸšƒ Reboque', matricula: r.matricula, documento: 'Seguro', data: r.seguro_data, diasRestantes: frotaCalcDias(r.seguro_data)}); });
      if (alertas.length > 0) { frotaMostrarPopupAlertas(alertas); } else { frotaMostrarAlerta('âœ… Todos os documentos estÃ£o em dia! (prÃ³ximos ' + dias + ' dias)', 'success'); }
    }

    function frotaMostrarPopupAlertas(alertas) {
      let html = '<table style="width:100%;border-collapse:collapse;font-size:12px;"><thead style="background:#2c3e50;color:white;"><tr><th style="padding:10px;text-align:left;">Tipo</th><th style="padding:10px;">MatrÃ­cula</th><th style="padding:10px;">Documento</th><th style="padding:10px;">Data</th><th style="padding:10px;">Dias</th></tr></thead><tbody>';
      alertas.sort((a,b) => a.diasRestantes - b.diasRestantes).forEach(a => { let cor = a.diasRestantes <= 15 ? '#c0392b' : a.diasRestantes <= 30 ? '#e67e22' : '#27ae60'; html += '<tr style="border-bottom:1px solid #dee2e6;"><td style="padding:8px;">' + a.tipo + '</td><td style="padding:8px;font-weight:bold;">' + a.matricula + '</td><td style="padding:8px;">' + a.documento + '</td><td style="padding:8px;">' + frotaFmtData(a.data) + '</td><td style="padding:8px;color:' + cor + ';font-weight:bold;">' + a.diasRestantes + ' dias</td></tr>'; });
      html += '</tbody></table>';
      document.getElementById('frotaListaAlertasVencimentos').innerHTML = html;
      document.getElementById('frotaModalAlertaVencimentos').classList.add('active');
    }

    // ========== UTILITÃRIOS ==========
    function frotaVerificarVenc(d) { if (!d) return false; return Math.ceil((new Date(d) - new Date()) / 86400000) <= 30; }
    function frotaVerificarVencDias(d, dias) { if (!d) return false; let diff = Math.ceil((new Date(d) - new Date()) / 86400000); return diff <= dias && diff >= 0; }
    function frotaCalcDias(d) { if (!d) return 999; return Math.ceil((new Date(d) - new Date()) / 86400000); }
    function frotaFmtData(d) { if (!d) return '-'; return new Date(d).toLocaleDateString('pt-PT'); }
    function frotaSetRadio(name, val) { document.querySelectorAll('input[name="' + name + '"]').forEach(r => { if (r.value === val) { r.checked = true; r.parentElement.classList.add('selected'); } else { r.parentElement.classList.remove('selected'); } }); }
    function frotaInitRadios(formId) { document.querySelectorAll('#' + formId + ' .frota-radio-wrapper').forEach(r => r.classList.remove('selected')); document.querySelectorAll('#' + formId + ' input[type="radio"]:checked').forEach(r => r.parentElement.classList.add('selected')); }
    function frotaInitRadiosAll() { document.querySelectorAll('#page-gestaofrota input[type="radio"]').forEach(r => r.addEventListener('change', function() { this.closest('.frota-radio-group').querySelectorAll('.frota-radio-wrapper').forEach(w => w.classList.remove('selected')); this.parentElement.classList.add('selected'); })); }

    function frotaAnexarDoc(inp, nomeId) { if (inp.files.length > 0) { document.getElementById(nomeId).value = inp.files[0].name; frotaMostrarAlerta('âœ… Anexado!', 'success'); } }
    function frotaAnexarMultDoc(inp, nomeId) { if (inp.files.length > 0) { document.getElementById(nomeId).value = inp.files.length + ' ficheiro(s)'; frotaMostrarAlerta('âœ… ' + inp.files.length + ' anexado(s)!', 'success'); } }
    function frotaAbrirDoc(id) { let inp = document.getElementById(id); if (inp.files.length > 0) window.open(URL.createObjectURL(inp.files[0]), '_blank'); else frotaMostrarAlerta('âš ï¸ Nenhum documento!', 'error'); }
    function frotaAbrirMultDoc(id) { let inp = document.getElementById(id); if (inp.files.length > 0) Array.from(inp.files).forEach(f => window.open(URL.createObjectURL(f), '_blank')); else frotaMostrarAlerta('âš ï¸ Nenhum documento!', 'error'); }

    function frotaFecharModal() { document.getElementById('frotaModalConfirmacao').classList.remove('active'); frotaAcaoConfirmacao = null; }
    function frotaConfirmarAcao() { if (frotaAcaoConfirmacao) frotaAcaoConfirmacao(); frotaFecharModal(); }
    function frotaMostrarAlerta(msg, tipo) { let c = document.getElementById('frotaAlertContainer'); if (!c) return; let id = 'frota-alert-' + Date.now(); c.innerHTML = '<div class="frota-alert frota-alert-' + tipo + '" id="' + id + '">' + msg + '<button class="frota-alert-close" onclick="document.getElementById(\'' + id + '\').remove()">Ã—</button></div>'; setTimeout(() => { let a = document.getElementById(id); if (a) a.remove(); }, 4000); }

    function frotaExportarCamioes() { let csv = [['MatrÃ­cula','Marca','Ano','ADR','Estado','InspeÃ§Ã£o','TacÃ³grafo','LicenÃ§a','Seguro'], ...frotaCamioes.map(c => [c.matricula,c.marca,c.ano,c.adr,c.estado,c.inspecao_data,c.tacografo_data,c.licenca_data,c.seguro_data])].map(r => r.join(';')).join('\n'); let b = new Blob([csv], {type:'text/csv'}); let l = document.createElement('a'); l.href = URL.createObjectURL(b); l.download = 'tratores.csv'; l.click(); frotaMostrarAlerta('âœ… Exportado!', 'success'); }
    function frotaExportarReboques() { let csv = [['MatrÃ­cula','Marca','Ano','Pneus','Bobines','Mega','Teto','ADR','Estado','InspeÃ§Ã£o','TacÃ³grafo','LicenÃ§a','Seguro'], ...frotaReboques.map(r => [r.matricula,r.marca,r.ano,r.pneus||'',r.bobines,r.mega,r.teto||'NÃ£o',r.adr||'NÃ£o',r.estado,r.inspecao_data||'',r.tacografo_data||'',r.licenca_data||'',r.seguro_data||''])].map(r => r.join(';')).join('\n'); let b = new Blob([csv], {type:'text/csv'}); let l = document.createElement('a'); l.href = URL.createObjectURL(b); l.download = 'reboques.csv'; l.click(); frotaMostrarAlerta('âœ… Exportado!', 'success'); }
    function frotaExportarCamioesTer() { let csv = [['Transportador','MatrÃ­cula','Ano','Seguro','LicenÃ§a','CMR','Estado'], ...frotaCamioesTerceiros.map(c => [c.transportador_nome,c.matricula,c.ano,c.seguro_data,c.licenca_data,c.cmr_data,c.estado])].map(r => r.join(';')).join('\n'); let b = new Blob([csv], {type:'text/csv'}); let l = document.createElement('a'); l.href = URL.createObjectURL(b); l.download = 'tratores_contratados.csv'; l.click(); frotaMostrarAlerta('âœ… Exportado!', 'success'); }
    function frotaExportarReboquesTer() { let csv = [['Transportador','MatrÃ­cula','Ano','Seguro','LicenÃ§a','CMR','Estado'], ...frotaReboquesTerceiros.map(r => [r.transportador_nome,r.matricula,r.ano,r.seguro_data,r.licenca_data,r.cmr_data,r.estado])].map(r => r.join(';')).join('\n'); let b = new Blob([csv], {type:'text/csv'}); let l = document.createElement('a'); l.href = URL.createObjectURL(b); l.download = 'reboques_contratados.csv'; l.click(); frotaMostrarAlerta('âœ… Exportado!', 'success'); }

    // ========== DRAG AND DROP TABS ==========
    let frotaDraggedTab = null;
    function frotaInitDragAndDrop() { document.querySelectorAll('.frota-nav-tab').forEach(tab => { tab.addEventListener('dragstart', frotaHandleDragStart); tab.addEventListener('dragend', frotaHandleDragEnd); tab.addEventListener('dragover', frotaHandleDragOver); tab.addEventListener('dragenter', frotaHandleDragEnter); tab.addEventListener('dragleave', frotaHandleDragLeave); tab.addEventListener('drop', frotaHandleDrop); }); }
    function frotaHandleDragStart(e) { frotaDraggedTab = this; this.classList.add('frota-dragging'); e.dataTransfer.effectAllowed = 'move'; }
    function frotaHandleDragEnd(e) { this.classList.remove('frota-dragging'); document.querySelectorAll('.frota-nav-tab').forEach(tab => tab.classList.remove('frota-drag-over')); frotaDraggedTab = null; frotaGuardarOrdemTabs(); }
    function frotaHandleDragOver(e) { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; return false; }
    function frotaHandleDragEnter(e) { if (this !== frotaDraggedTab) this.classList.add('frota-drag-over'); }
    function frotaHandleDragLeave(e) { this.classList.remove('frota-drag-over'); }
    function frotaHandleDrop(e) { e.stopPropagation(); e.preventDefault(); if (frotaDraggedTab !== this) { const navTabs = document.getElementById('frotaNavTabs'); const allTabs = [...navTabs.querySelectorAll('.frota-nav-tab')]; const draggedIndex = allTabs.indexOf(frotaDraggedTab); const targetIndex = allTabs.indexOf(this); if (draggedIndex < targetIndex) navTabs.insertBefore(frotaDraggedTab, this.nextSibling); else navTabs.insertBefore(frotaDraggedTab, this); frotaMostrarAlerta('âœ… Tab reorganizada!', 'success'); } this.classList.remove('frota-drag-over'); return false; }
    function frotaGuardarOrdemTabs() { const tabs = document.querySelectorAll('.frota-nav-tab'); const ordem = []; tabs.forEach(tab => ordem.push(tab.getAttribute('data-vista'))); localStorage.setItem('frotaOrdemTabs', JSON.stringify(ordem)); }
    function frotaCarregarOrdemTabs() { const ordemGuardada = localStorage.getItem('frotaOrdemTabs'); if (ordemGuardada) { const ordem = JSON.parse(ordemGuardada); const navTabs = document.getElementById('frotaNavTabs'); if (!navTabs) return; const tabs = [...navTabs.querySelectorAll('.frota-nav-tab')]; ordem.forEach(vista => { const tab = tabs.find(t => t.getAttribute('data-vista') === vista); if (tab) navTabs.appendChild(tab); }); } }

    // ========== NAVEGAÃ‡ÃƒO POR TECLADO ==========
    function frotaInitNavegacaoTeclado() {
      document.getElementById('page-gestaofrota')?.addEventListener('keydown', function(e) {
        const inputs = Array.from(this.querySelectorAll('input:not([type="hidden"]):not([type="file"]):not([type="radio"]):not([disabled]), select:not([disabled]), textarea:not([disabled])'));
        const idx = inputs.indexOf(document.activeElement);
        if (idx === -1) return;
        if (e.key === 'Enter' && document.activeElement.tagName !== 'TEXTAREA') { e.preventDefault(); if (idx < inputs.length - 1) inputs[idx + 1].focus(); }
        if (e.key === 'ArrowDown' && document.activeElement.tagName !== 'SELECT' && document.activeElement.tagName !== 'TEXTAREA') { e.preventDefault(); if (idx < inputs.length - 1) inputs[idx + 1].focus(); }
        if (e.key === 'ArrowUp' && document.activeElement.tagName !== 'SELECT' && document.activeElement.tagName !== 'TEXTAREA') { e.preventDefault(); if (idx > 0) inputs[idx - 1].focus(); }
      });
    }


    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // MÃ“DULO FORNECEDORES v5.9 - JAVASCRIPT PREFIXADO (LAYOUT ORIGINAL)
    // Prefixo: fornecedores
    // â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    // â•‘  ğŸ”’ MÃ“DULO BLOQUEADO - NÃƒO ALTERAR SEM AUTORIZAÃ‡ÃƒO ğŸ”’                      â•‘
    // â•‘  VersÃ£o: 5.9 | Data: 21/12/2024                                            â•‘
    // â•‘  Este mÃ³dulo estÃ¡ completo e testado.                                      â•‘
    // â•‘  Qualquer alteraÃ§Ã£o pode causar problemas de funcionamento.                â•‘
    // â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    let fornecedoresLista = JSON.parse(localStorage.getItem('erpFornecedores') || '[]');
    let fornecedoresAtual = null;
    let fornecedoresEditando = false;
    let fornecedoresParaEliminar = null;

    // Dados demo
    if (fornecedoresLista.length === 0) {
      fornecedoresLista = [
        { numero: "F1000", nome: "Transportes RÃ¡pidos Lda", contribuinte: "501234567", rua: "Rua da IndÃºstria", numero_porta: "150", localidade: "Maia", freguesia: "Ãguas Santas", codigo_postal: "4425-000", cidade: "Porto", concelho: "Maia", pais: "Portugal", tipo_pais: "nacional", conta_sap: "221111000", telefone1: "+351 220 000 001", telefone2: "+351 920 000 001", contacto1_nome: "JoÃ£o Silva", contacto2_nome: "Maria Santos", email_geral: "geral@transportesrapidos.pt", email_contabilidade: "contabilidade@transportesrapidos.pt", email_financeiro: "financeiro@transportesrapidos.pt", iban1: "PT50 0000 0000 0000 0000 0001 1", iban2: "PT50 0000 0000 0000 0000 0001 2", retencao_fonte: "sem_retencao", conta_contab1: "221100001", conta_contab2: "221100002", conta_contab3: "", conta_contab4: "", conta_contab5: "", conta_contab6: "", fornecedor_cativo: true, fornecedor_bloqueado: false, fornecedor_inativo: false, fornecedor_com_login: false, observacoes: "Fornecedor preferencial para transporte nacional.", valor_divida: 1250.50, total_compras: 45780.00 },
        { numero: "F1001", nome: "LogÃ­stica Express SA", contribuinte: "502345678", rua: "Av. Central", numero_porta: "500", localidade: "Lisboa", freguesia: "Parque das NaÃ§Ãµes", codigo_postal: "1990-000", cidade: "Lisboa", concelho: "Lisboa", pais: "Portugal", tipo_pais: "nacional", conta_sap: "221111001", telefone1: "+351 210 000 002", telefone2: "+351 910 000 002", contacto1_nome: "AntÃ³nio Costa", contacto2_nome: "Ana Ferreira", email_geral: "info@logisticaexpress.pt", email_contabilidade: "contabilidade@logisticaexpress.pt", email_financeiro: "tesouraria@logisticaexpress.pt", iban1: "PT50 0000 0000 0000 0000 0002 1", iban2: "PT50 0000 0000 0000 0000 0002 2", retencao_fonte: "com_retencao", conta_contab1: "221100003", conta_contab2: "", conta_contab3: "", conta_contab4: "", conta_contab5: "", conta_contab6: "", fornecedor_cativo: false, fornecedor_bloqueado: false, fornecedor_inativo: false, fornecedor_com_login: true, observacoes: "", valor_divida: 0, total_compras: 125000.00 },
        { numero: "F1002", nome: "TransEuropa Services", contribuinte: "ES12345678", rua: "Calle Principal", numero_porta: "45", localidade: "Madrid", freguesia: "Centro", codigo_postal: "28001", cidade: "Madrid", concelho: "Madrid", pais: "Espanha", tipo_pais: "europeu", conta_sap: "221121002", telefone1: "+34 910 000 001", telefone2: "+34 620 000 001", contacto1_nome: "Carlos GarcÃ­a", contacto2_nome: "Elena MartÃ­nez", email_geral: "info@transeuropa.es", email_contabilidade: "contab@transeuropa.es", email_financeiro: "pagos@transeuropa.es", iban1: "ES91 0000 0000 0000 0000 0001", iban2: "ES91 0000 0000 0000 0000 0002", retencao_fonte: "sem_retencao", conta_contab1: "221200001", conta_contab2: "", conta_contab3: "", conta_contab4: "", conta_contab5: "", conta_contab6: "", fornecedor_cativo: false, fornecedor_bloqueado: true, fornecedor_inativo: false, fornecedor_com_login: false, observacoes: "Fornecedor europeu - bloqueado temporariamente", valor_divida: 5200.00, total_compras: 89000.00 }
      ];
      localStorage.setItem('erpFornecedores', JSON.stringify(fornecedoresLista));
    }

    const fornecedoresDadosSAP = {
      "501234567": { nome: "Transportes RÃ¡pidos Lda", rua: "Rua da IndÃºstria", numero_porta: "150", localidade: "Maia", freguesia: "Ãguas Santas", codigo_postal: "4425-000", cidade: "Porto", concelho: "Maia", pais: "Portugal" },
      "509876543": { nome: "Empresa Teste SA", rua: "Avenida da RepÃºblica", numero_porta: "200", localidade: "Lisboa", freguesia: "Avenidas Novas", codigo_postal: "1050-000", cidade: "Lisboa", concelho: "Lisboa", pais: "Portugal" }
    };

    function fornecedoresInit() {
      fornecedoresAtualizarLista();
      document.getElementById('fornecedores_numero').value = fornecedoresObterProximoNumero();
    }

    function fornecedoresMostrarVista(vista) {
      document.querySelectorAll('#page-fichasfornecedores .fornecedores-view-section').forEach(v => v.classList.remove('active'));
      document.querySelectorAll('#page-fichasfornecedores .fornecedores-nav-tab').forEach(t => t.classList.remove('active'));
      
      if (vista === 'lista') {
        document.getElementById('fornecedoresVistaLista').classList.add('active');
        document.querySelectorAll('#page-fichasfornecedores .fornecedores-nav-tab')[0].classList.add('active');
        document.getElementById('fornecedoresTabDetalhes').style.display = 'none';
        fornecedoresAtualizarLista();
      } else if (vista === 'novo') {
        document.getElementById('fornecedoresVistaNovo').classList.add('active');
        document.querySelectorAll('#page-fichasfornecedores .fornecedores-nav-tab')[1].classList.add('active');
        document.getElementById('fornecedoresTabDetalhes').style.display = 'none';
        if (!fornecedoresEditando) {
          fornecedoresLimparFormulario();
          document.getElementById('fornecedores_numero').value = fornecedoresObterProximoNumero();
        }
      } else if (vista === 'detalhes') {
        document.getElementById('fornecedoresVistaDetalhes').classList.add('active');
        document.getElementById('fornecedoresTabDetalhes').style.display = 'flex';
        document.getElementById('fornecedoresTabDetalhes').classList.add('active');
      }
    }

    function fornecedoresAtualizarLista() {
      const tbody = document.getElementById('fornecedoresTabelaFornecedores');
      const estadoVazio = document.getElementById('fornecedoresEstadoVazio');
      const tableContainer = document.getElementById('fornecedoresTableContainer');
      
      if (fornecedoresLista.length === 0) {
        tableContainer.style.display = 'none';
        estadoVazio.style.display = 'block';
      } else {
        tableContainer.style.display = 'block';
        estadoVazio.style.display = 'none';
        tbody.innerHTML = fornecedoresLista.map(f => {
          let estadoBadge = '<span class="fornecedores-badge fornecedores-badge-success">âœ… Ativo</span>';
          if (f.fornecedor_bloqueado) estadoBadge = '<span class="fornecedores-badge fornecedores-badge-danger">ğŸ”’ Bloqueado</span>';
          else if (f.fornecedor_inativo) estadoBadge = '<span class="fornecedores-badge fornecedores-badge-secondary">â¸ï¸ Inativo</span>';
          else if (f.fornecedor_cativo) estadoBadge = '<span class="fornecedores-badge fornecedores-badge-warning">â­ Cativo</span>';
          return `<tr><td><strong style="color: #c0392b;">${f.numero}</strong></td><td>${f.nome}</td><td>${f.contribuinte}</td><td>${f.cidade}</td><td>${f.pais}</td><td><code>${f.conta_sap}</code></td><td>${estadoBadge}</td><td class="fornecedores-table-actions"><button class="fornecedores-btn fornecedores-btn-vermelho fornecedores-btn-icon" onclick="fornecedoresVerDetalhes('${f.numero}')" title="Ver detalhes">ğŸ‘ï¸</button><button class="fornecedores-btn fornecedores-btn-amarelo fornecedores-btn-icon" onclick="fornecedoresEditar('${f.numero}')" title="Editar">âœï¸</button><button class="fornecedores-btn fornecedores-btn-vermelho fornecedores-btn-icon" onclick="fornecedoresConfirmarEliminar('${f.numero}')" title="Eliminar">ğŸ—‘ï¸</button></td></tr>`;
        }).join('');
      }
      fornecedoresAtualizarEstatisticas();
    }

    function fornecedoresAtualizarEstatisticas() {
      document.getElementById('fornecedoresStatTotal').textContent = fornecedoresLista.length;
      document.getElementById('fornecedoresStatAtivos').textContent = fornecedoresLista.filter(f => !f.fornecedor_bloqueado && !f.fornecedor_inativo).length;
      document.getElementById('fornecedoresStatBloqueados').textContent = fornecedoresLista.filter(f => f.fornecedor_bloqueado).length;
      const totalDivida = fornecedoresLista.reduce((sum, f) => sum + (f.valor_divida || 0), 0);
      document.getElementById('fornecedoresStatDivida').textContent = 'â‚¬' + totalDivida.toFixed(2);
    }

    function fornecedoresPesquisar() {
      const termo = document.getElementById('fornecedoresCampoPesquisa').value.toLowerCase();
      const tbody = document.getElementById('fornecedoresTabelaFornecedores');
      const filtrados = fornecedoresLista.filter(f => f.numero.toLowerCase().includes(termo) || f.nome.toLowerCase().includes(termo) || f.contribuinte.toLowerCase().includes(termo) || f.cidade.toLowerCase().includes(termo) || f.pais.toLowerCase().includes(termo));
      tbody.innerHTML = filtrados.map(f => {
        let estadoBadge = '<span class="fornecedores-badge fornecedores-badge-success">âœ… Ativo</span>';
        if (f.fornecedor_bloqueado) estadoBadge = '<span class="fornecedores-badge fornecedores-badge-danger">ğŸ”’ Bloqueado</span>';
        else if (f.fornecedor_inativo) estadoBadge = '<span class="fornecedores-badge fornecedores-badge-secondary">â¸ï¸ Inativo</span>';
        else if (f.fornecedor_cativo) estadoBadge = '<span class="fornecedores-badge fornecedores-badge-warning">â­ Cativo</span>';
        return `<tr><td><strong style="color: #c0392b;">${f.numero}</strong></td><td>${f.nome}</td><td>${f.contribuinte}</td><td>${f.cidade}</td><td>${f.pais}</td><td><code>${f.conta_sap}</code></td><td>${estadoBadge}</td><td class="fornecedores-table-actions"><button class="fornecedores-btn fornecedores-btn-vermelho fornecedores-btn-icon" onclick="fornecedoresVerDetalhes('${f.numero}')" title="Ver detalhes">ğŸ‘ï¸</button><button class="fornecedores-btn fornecedores-btn-amarelo fornecedores-btn-icon" onclick="fornecedoresEditar('${f.numero}')" title="Editar">âœï¸</button><button class="fornecedores-btn fornecedores-btn-vermelho fornecedores-btn-icon" onclick="fornecedoresConfirmarEliminar('${f.numero}')" title="Eliminar">ğŸ—‘ï¸</button></td></tr>`;
      }).join('');
    }

    function fornecedoresObterProximoNumero() {
      if (fornecedoresLista.length === 0) return 'F1000';
      const numeros = fornecedoresLista.map(f => parseInt(f.numero.substring(1)));
      return 'F' + (Math.max(...numeros) + 1);
    }

    function fornecedoresLimparFormulario() {
      document.getElementById('fornecedoresFormFornecedor').reset();
      document.getElementById('fornecedores_conta_sap').value = '';
      document.getElementById('fornecedores_tipo').value = '';
      fornecedoresEditando = false;
      fornecedoresAtual = null;
    }

    function fornecedoresPesquisarPorNIF() {
      const nif = document.getElementById('fornecedores_contribuinte').value.trim();
      if (fornecedoresDadosSAP[nif]) {
        const dados = fornecedoresDadosSAP[nif];
        document.getElementById('fornecedores_nome').value = dados.nome;
        document.getElementById('fornecedores_rua').value = dados.rua;
        document.getElementById('fornecedores_numero_porta').value = dados.numero_porta;
        document.getElementById('fornecedores_localidade').value = dados.localidade;
        document.getElementById('fornecedores_freguesia').value = dados.freguesia;
        document.getElementById('fornecedores_codigo_postal').value = dados.codigo_postal;
        document.getElementById('fornecedores_cidade').value = dados.cidade;
        document.getElementById('fornecedores_concelho').value = dados.concelho;
        document.getElementById('fornecedores_pais').value = dados.pais;
        fornecedoresDefinirContaSAP();
        fornecedoresMostrarAlerta('âœ… Dados importados do SAP com sucesso!', 'success');
        fornecedoresEnviarParaSAP('CONSULTA', { nif: nif });
      } else {
        fornecedoresMostrarAlerta('â„¹ï¸ NIF nÃ£o encontrado no SAP. Preencha os dados manualmente.', 'info');
      }
    }

    function fornecedoresDefinirContaSAP() {
      const paisSelect = document.getElementById('fornecedores_pais');
      const selectedOption = paisSelect.options[paisSelect.selectedIndex];
      const tipoPais = selectedOption ? selectedOption.getAttribute('data-tipo') : '';
      const numeroForn = document.getElementById('fornecedores_numero').value.substring(1);
      let contaBase = '', tipoTexto = '';
      switch(tipoPais) {
        case 'nacional': contaBase = '22111'; tipoTexto = 'Nacional'; break;
        case 'europeu': contaBase = '22112'; tipoTexto = 'Europeu (UE)'; break;
        case 'terceiro': contaBase = '22113'; tipoTexto = 'PaÃ­s Terceiro'; break;
      }
      if (contaBase) {
        document.getElementById('fornecedores_conta_sap').value = contaBase + numeroForn;
        document.getElementById('fornecedores_tipo').value = tipoTexto;
        document.getElementById('fornecedoresSapContaInfo').innerHTML = 'ğŸ”— Conta SAP definida: <strong>' + contaBase + numeroForn + '</strong> (' + tipoTexto + ')';
      }
    }

    function fornecedoresSelecionarEstado(estadoId) {
      ['fornecedores_cativo', 'fornecedores_bloqueado', 'fornecedores_inativo'].forEach(id => {
        if (id !== estadoId) document.getElementById(id).checked = false;
      });
    }

    function fornecedoresVerificarLogin() {
      const comLogin = document.getElementById('fornecedores_com_login').checked;
      if (comLogin) fornecedoresMostrarAlerta('âœ… Login ativado! O fornecedor poderÃ¡ aceder ao portal com a password que definir.', 'success');
      else fornecedoresMostrarAlerta('ğŸ”’ Login desativado! O fornecedor nÃ£o terÃ¡ acesso ao portal.', 'info');
    }

    function fornecedoresAnexoIbanCarregado(num) {
      const input = document.getElementById('fornecedores_anexo_iban' + num);
      if (input.files.length > 0) fornecedoresMostrarAlerta('âœ… Ficheiro anexado ao IBAN ' + num + ': ' + input.files[0].name, 'success');
    }

    function fornecedoresAbrirAnexoIban(num) {
      const input = document.getElementById('fornecedores_anexo_iban' + num);
      if (input.files.length > 0) window.open(URL.createObjectURL(input.files[0]), '_blank');
      else fornecedoresMostrarAlerta('âš ï¸ Nenhum ficheiro anexado ao IBAN ' + num, 'error');
    }

    function fornecedoresGuardar(event) {
      event.preventDefault();
      const numero = document.getElementById('fornecedores_numero').value;
      if (!fornecedoresEditando && fornecedoresLista.find(f => f.numero === numero)) {
        fornecedoresMostrarAlerta('âŒ Erro: O nÃºmero de fornecedor ' + numero + ' jÃ¡ existe.', 'error');
        return;
      }
      const dados = {
        numero: numero, nome: document.getElementById('fornecedores_nome').value, contribuinte: document.getElementById('fornecedores_contribuinte').value,
        rua: document.getElementById('fornecedores_rua').value, numero_porta: document.getElementById('fornecedores_numero_porta').value,
        localidade: document.getElementById('fornecedores_localidade').value, freguesia: document.getElementById('fornecedores_freguesia').value,
        codigo_postal: document.getElementById('fornecedores_codigo_postal').value, cidade: document.getElementById('fornecedores_cidade').value,
        concelho: document.getElementById('fornecedores_concelho').value, pais: document.getElementById('fornecedores_pais').value,
        tipo_pais: document.getElementById('fornecedores_pais').options[document.getElementById('fornecedores_pais').selectedIndex]?.getAttribute('data-tipo') || '',
        conta_sap: document.getElementById('fornecedores_conta_sap').value, telefone1: document.getElementById('fornecedores_telefone1').value,
        telefone2: document.getElementById('fornecedores_telefone2').value, contacto1_nome: document.getElementById('fornecedores_contacto1_nome').value,
        contacto2_nome: document.getElementById('fornecedores_contacto2_nome').value, email_geral: document.getElementById('fornecedores_email_geral').value,
        email_contabilidade: document.getElementById('fornecedores_email_contabilidade').value, email_financeiro: document.getElementById('fornecedores_email_financeiro').value,
        iban1: document.getElementById('fornecedores_iban1').value, iban2: document.getElementById('fornecedores_iban2').value,
        retencao_fonte: document.getElementById('fornecedores_retencao_fonte').value,
        conta_contab1: document.getElementById('fornecedores_conta_contab1').value, conta_contab2: document.getElementById('fornecedores_conta_contab2').value,
        conta_contab3: document.getElementById('fornecedores_conta_contab3').value, conta_contab4: document.getElementById('fornecedores_conta_contab4').value,
        conta_contab5: document.getElementById('fornecedores_conta_contab5').value, conta_contab6: document.getElementById('fornecedores_conta_contab6').value,
        fornecedor_cativo: document.getElementById('fornecedores_cativo').checked, fornecedor_bloqueado: document.getElementById('fornecedores_bloqueado').checked,
        fornecedor_inativo: document.getElementById('fornecedores_inativo').checked, fornecedor_com_login: document.getElementById('fornecedores_com_login').checked,
        observacoes: document.getElementById('fornecedores_observacoes').value,
        valor_divida: fornecedoresEditando ? fornecedoresAtual.valor_divida : 0, total_compras: fornecedoresEditando ? fornecedoresAtual.total_compras : 0
      };
      if (fornecedoresEditando) {
        const index = fornecedoresLista.findIndex(f => f.numero === fornecedoresAtual.numero);
        fornecedoresLista[index] = dados;
        fornecedoresMostrarAlerta('âœ… Fornecedor atualizado com sucesso!', 'success');
        fornecedoresEnviarParaSAP('ATUALIZAR', dados);
      } else {
        fornecedoresLista.push(dados);
        fornecedoresMostrarAlerta('âœ… Fornecedor criado com sucesso!', 'success');
        fornecedoresEnviarParaSAP('CRIAR', dados);
      }
      localStorage.setItem('erpFornecedores', JSON.stringify(fornecedoresLista));
      fornecedoresEditando = false;
      fornecedoresAtual = null;
      fornecedoresMostrarVista('lista');
    }

    function fornecedoresEditar(numero) {
      const f = fornecedoresLista.find(forn => forn.numero === numero);
      if (!f) return;
      fornecedoresAtual = f;
      fornecedoresEditando = true;
      document.getElementById('fornecedores_numero').value = f.numero;
      document.getElementById('fornecedores_contribuinte').value = f.contribuinte;
      document.getElementById('fornecedores_nome').value = f.nome;
      document.getElementById('fornecedores_rua').value = f.rua;
      document.getElementById('fornecedores_numero_porta').value = f.numero_porta;
      document.getElementById('fornecedores_localidade').value = f.localidade;
      document.getElementById('fornecedores_freguesia').value = f.freguesia;
      document.getElementById('fornecedores_codigo_postal').value = f.codigo_postal;
      document.getElementById('fornecedores_cidade').value = f.cidade;
      document.getElementById('fornecedores_concelho').value = f.concelho;
      document.getElementById('fornecedores_pais').value = f.pais;
      document.getElementById('fornecedores_conta_sap').value = f.conta_sap;
      document.getElementById('fornecedores_tipo').value = f.tipo_pais === 'nacional' ? 'Nacional' : f.tipo_pais === 'europeu' ? 'Europeu (UE)' : 'PaÃ­s Terceiro';
      document.getElementById('fornecedores_telefone1').value = f.telefone1;
      document.getElementById('fornecedores_telefone2').value = f.telefone2;
      document.getElementById('fornecedores_contacto1_nome').value = f.contacto1_nome;
      document.getElementById('fornecedores_contacto2_nome').value = f.contacto2_nome;
      document.getElementById('fornecedores_email_geral').value = f.email_geral;
      document.getElementById('fornecedores_email_contabilidade').value = f.email_contabilidade;
      document.getElementById('fornecedores_email_financeiro').value = f.email_financeiro;
      document.getElementById('fornecedores_iban1').value = f.iban1;
      document.getElementById('fornecedores_iban2').value = f.iban2;
      document.getElementById('fornecedores_retencao_fonte').value = f.retencao_fonte;
      document.getElementById('fornecedores_conta_contab1').value = f.conta_contab1 || '';
      document.getElementById('fornecedores_conta_contab2').value = f.conta_contab2 || '';
      document.getElementById('fornecedores_conta_contab3').value = f.conta_contab3 || '';
      document.getElementById('fornecedores_conta_contab4').value = f.conta_contab4 || '';
      document.getElementById('fornecedores_conta_contab5').value = f.conta_contab5 || '';
      document.getElementById('fornecedores_conta_contab6').value = f.conta_contab6 || '';
      document.getElementById('fornecedores_cativo').checked = f.fornecedor_cativo || false;
      document.getElementById('fornecedores_bloqueado').checked = f.fornecedor_bloqueado || false;
      document.getElementById('fornecedores_inativo').checked = f.fornecedor_inativo || false;
      document.getElementById('fornecedores_com_login').checked = f.fornecedor_com_login || false;
      document.getElementById('fornecedores_observacoes').value = f.observacoes || '';
      fornecedoresMostrarVista('novo');
    }

    function fornecedoresAlterar() {
      if (!fornecedoresEditando || !fornecedoresAtual) {
        fornecedoresMostrarAlerta('âš ï¸ Selecione um fornecedor para alterar.', 'error');
        return;
      }
      fornecedoresMostrarAlerta('â„¹ï¸ Modo de ediÃ§Ã£o ativo. Altere os dados e clique em Guardar.', 'info');
    }

    function fornecedoresVerDetalhes(numero) {
      const f = fornecedoresLista.find(forn => forn.numero === numero);
      if (!f) return;
      let estadoTexto = 'âœ… Ativo';
      if (f.fornecedor_bloqueado) estadoTexto = 'ğŸ”’ Bloqueado';
      else if (f.fornecedor_inativo) estadoTexto = 'â¸ï¸ Inativo';
      else if (f.fornecedor_cativo) estadoTexto = 'â­ Cativo';
      document.getElementById('fornecedoresConteudoDetalhes').innerHTML = `
        <div class="fornecedores-detail-header">
          <div><h2>${f.nome}</h2><p>Fornecedor ${f.numero} | NIF: ${f.contribuinte}</p></div>
          <div style="display: flex; gap: 10px;">
            <button class="fornecedores-btn fornecedores-btn-amarelo" onclick="fornecedoresEditar('${f.numero}')">âœï¸ Editar</button>
            <button class="fornecedores-btn fornecedores-btn-vermelho" onclick="fornecedoresConfirmarEliminar('${f.numero}')">ğŸ—‘ï¸ Eliminar</button>
          </div>
        </div>
        <div class="fornecedores-detail-section"><h3>ğŸ¢ IdentificaÃ§Ã£o</h3><div class="fornecedores-detail-grid">
          <div class="fornecedores-detail-item"><div class="fornecedores-detail-label">NÂº Fornecedor</div><div class="fornecedores-detail-value">${f.numero}</div></div>
          <div class="fornecedores-detail-item"><div class="fornecedores-detail-label">NIF</div><div class="fornecedores-detail-value">${f.contribuinte}</div></div>
          <div class="fornecedores-detail-item"><div class="fornecedores-detail-label">Nome</div><div class="fornecedores-detail-value">${f.nome}</div></div>
          <div class="fornecedores-detail-item"><div class="fornecedores-detail-label">Estado</div><div class="fornecedores-detail-value">${estadoTexto}</div></div>
        </div></div>
        <div class="fornecedores-detail-section"><h3>ğŸ“ Morada</h3><div class="fornecedores-detail-grid">
          <div class="fornecedores-detail-item"><div class="fornecedores-detail-label">Rua</div><div class="fornecedores-detail-value">${f.rua}, ${f.numero_porta}</div></div>
          <div class="fornecedores-detail-item"><div class="fornecedores-detail-label">CÃ³digo Postal</div><div class="fornecedores-detail-value">${f.codigo_postal}</div></div>
          <div class="fornecedores-detail-item"><div class="fornecedores-detail-label">Localidade</div><div class="fornecedores-detail-value">${f.localidade}</div></div>
          <div class="fornecedores-detail-item"><div class="fornecedores-detail-label">Cidade</div><div class="fornecedores-detail-value">${f.cidade}</div></div>
          <div class="fornecedores-detail-item"><div class="fornecedores-detail-label">PaÃ­s</div><div class="fornecedores-detail-value">${f.pais}</div></div>
        </div></div>
        <div class="fornecedores-detail-section"><h3>ğŸ“ Contactos</h3><div class="fornecedores-detail-grid">
          <div class="fornecedores-detail-item"><div class="fornecedores-detail-label">Telefone 1</div><div class="fornecedores-detail-value">${f.telefone1}</div></div>
          <div class="fornecedores-detail-item"><div class="fornecedores-detail-label">Telefone 2</div><div class="fornecedores-detail-value">${f.telefone2}</div></div>
          <div class="fornecedores-detail-item"><div class="fornecedores-detail-label">Email Geral</div><div class="fornecedores-detail-value">${f.email_geral}</div></div>
          <div class="fornecedores-detail-item"><div class="fornecedores-detail-label">Email Contabilidade</div><div class="fornecedores-detail-value">${f.email_contabilidade}</div></div>
        </div></div>
        <div class="fornecedores-detail-section"><h3>ğŸ’° Dados ContabilÃ­sticos</h3><div class="fornecedores-detail-grid">
          <div class="fornecedores-detail-item"><div class="fornecedores-detail-label">Conta SAP</div><div class="fornecedores-detail-value" style="color: #27ae60; font-weight: bold;">${f.conta_sap}</div></div>
          <div class="fornecedores-detail-item"><div class="fornecedores-detail-label">Tipo</div><div class="fornecedores-detail-value">${f.tipo_pais === 'nacional' ? 'Nacional' : f.tipo_pais === 'europeu' ? 'Europeu (UE)' : 'PaÃ­s Terceiro'}</div></div>
          <div class="fornecedores-detail-item"><div class="fornecedores-detail-label">Total Compras</div><div class="fornecedores-detail-value" style="color: #27ae60;">â‚¬${(f.total_compras || 0).toFixed(2)}</div></div>
          <div class="fornecedores-detail-item"><div class="fornecedores-detail-label">Em DÃ­vida</div><div class="fornecedores-detail-value" style="color: #c0392b;">â‚¬${(f.valor_divida || 0).toFixed(2)}</div></div>
        </div></div>
        ${f.observacoes ? `<div class="fornecedores-detail-section"><h3>ğŸ“ ObservaÃ§Ãµes</h3><p>${f.observacoes}</p></div>` : ''}
      `;
      fornecedoresMostrarVista('detalhes');
    }

    function fornecedoresConfirmarEliminar(numero) {
      const f = fornecedoresLista.find(forn => forn.numero === numero);
      if (!f) return;
      fornecedoresParaEliminar = numero;
      document.getElementById('fornecedoresModalMensagem').textContent = 'Tem a certeza que deseja eliminar o fornecedor "' + f.nome + '" (' + numero + ')?';
      document.getElementById('fornecedoresModalConfirmacao').classList.add('active');
    }

    function fornecedoresFecharModal() {
      document.getElementById('fornecedoresModalConfirmacao').classList.remove('active');
      fornecedoresParaEliminar = null;
    }

    function fornecedoresConfirmarEliminacao() {
      if (fornecedoresParaEliminar !== null) {
        const f = fornecedoresLista.find(forn => forn.numero === fornecedoresParaEliminar);
        fornecedoresEnviarParaSAP('ELIMINAR', { fornecedor: fornecedoresParaEliminar, nome: f.nome, nif: f.contribuinte });
        fornecedoresLista = fornecedoresLista.filter(forn => forn.numero !== fornecedoresParaEliminar);
        localStorage.setItem('erpFornecedores', JSON.stringify(fornecedoresLista));
        fornecedoresMostrarAlerta('âœ… Fornecedor eliminado com sucesso!', 'success');
        fornecedoresFecharModal();
        fornecedoresMostrarVista('lista');
      }
    }

    function fornecedoresMostrarAlerta(mensagem, tipo) {
      const container = document.getElementById('fornecedoresAlertContainer');
      const id = 'fornecedores-alert-' + Date.now();
      container.innerHTML = '<div class="fornecedores-alert fornecedores-alert-' + tipo + '" id="' + id + '">' + mensagem + '<button class="fornecedores-alert-close" onclick="document.getElementById(\'' + id + '\').remove()">Ã—</button></div>';
      setTimeout(() => { const alert = document.getElementById(id); if (alert) alert.remove(); }, 5000);
    }

    function fornecedoresExportarLista() {
      const csv = [['NÃºmero', 'Nome', 'NIF', 'Cidade', 'PaÃ­s', 'Conta SAP', 'Estado'], ...fornecedoresLista.map(f => {
        let estado = 'Ativo';
        if (f.fornecedor_bloqueado) estado = 'Bloqueado';
        else if (f.fornecedor_inativo) estado = 'Inativo';
        else if (f.fornecedor_cativo) estado = 'Cativo';
        return [f.numero, f.nome, f.contribuinte, f.cidade, f.pais, f.conta_sap, estado];
      })].map(row => row.join(';')).join('\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'fornecedores_' + new Date().toISOString().split('T')[0] + '.csv';
      link.click();
      fornecedoresMostrarAlerta('âœ… Lista exportada com sucesso!', 'success');
    }

    function fornecedoresEnviarParaSAP(operacao, dados) {
      console.log('ğŸ”— SAP [' + operacao + ']:', dados);
      document.getElementById('fornecedoresModalSAPMensagem').innerHTML = '<strong>OperaÃ§Ã£o:</strong> ' + operacao + '<br><strong>Fornecedor:</strong> ' + (dados.numero || dados.fornecedor || 'N/A') + '<br><br>âœ… Dados enviados com sucesso para o SAP!';
      document.getElementById('fornecedoresModalSAP').classList.add('active');
      setTimeout(() => { fornecedoresFecharModalSAP(); }, 2000);
    }

    function fornecedoresFecharModalSAP() { document.getElementById('fornecedoresModalSAP').classList.remove('active'); }

    function fornecedoresObterPorNumero(numero) { return fornecedoresLista.find(f => f.numero === numero); }

    function fornecedoresVerificarAtivo(numero) {
      const f = fornecedoresLista.find(forn => forn.numero === numero);
      if (!f) return { ativo: false, motivo: 'Fornecedor nÃ£o encontrado' };
      if (f.fornecedor_bloqueado) return { ativo: false, motivo: 'Fornecedor estÃ¡ BLOQUEADO' };
      if (f.fornecedor_inativo) return { ativo: false, motivo: 'Fornecedor estÃ¡ INATIVO' };
      return { ativo: true, motivo: 'Fornecedor ativo' };
    }

    if (document.getElementById('page-fichasfornecedores')) { fornecedoresInit(); }
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // FIM MÃ“DULO FORNECEDORES v5.9
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•


    // Inicializar mÃ³dulo GestÃ£o de Frota
    if (typeof frotaInit === 'function') { frotaInit(); }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // PORTAL CENTRAL v6.0 - JAVASCRIPT PREFIXADO
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    // VariÃ¡veis globais do Portal
    let portalUtilizadorAtual = null;
    let portalIdiomaAtual = 'pt';
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // SISTEMA DE TRADUÃ‡Ã•ES i18next - 30 IDIOMAS COMPLETO
    // MÃ³dulo: LOGÃSTICA (CotaÃ§Ãµes, Reservas, Agenda 1, 2, 3)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    // Inicializar i18next
    let i18nextReady = false;
    
    const i18nResources = {
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // PORTUGUÃŠS (Default)
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      pt: {
        translation: {
          // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ MENU LATERAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          menu_administration: 'âš™ï¸ AdministraÃ§Ã£o',
          menu_logistics: 'ğŸš› LogÃ­stica',
          menu_financial: 'ğŸ’° Financeiro',
          menu_suppliers: 'ğŸ­ Fornecedores',
          menu_cost_control: 'ğŸ“Š Controlo de Custos',
          menu_accounting: 'ğŸ“š Contabilidade',
          menu_hr: 'ğŸ‘¥ Recursos Humanos',
          
          // Sub-menus
          dashboard: 'Dashboard Geral',
          settings: 'ConfiguraÃ§Ãµes',
          users: 'Utilizadores',
          permissions: 'PermissÃµes',
          commercial: 'Comerciais',
          teams: 'Equipas',
          routes: 'Rotas',
          warehouses: 'ArmazÃ©ns',
          archive_agenda: 'Agenda Arquivo',
          logs: 'Logs / HistÃ³rico',
          backup: 'Backup',
          quotations: 'CotaÃ§Ãµes',
          bookings: 'Reservas',
          agenda1: 'Agenda 1',
          agenda2: 'Agenda 2',
          agenda3: 'Agenda 3',
          customers: 'Clientes',
          invoices: 'Faturas',
          pre_invoicing: 'PrÃ©-FaturaÃ§Ã£o',
          invoicing_control: 'Controlo FaturaÃ§Ã£o',
          credit_notes: 'Notas de CrÃ©dito',
          receipts: 'Recibos',
          current_accounts: 'Contas Correntes',
          supplier_files: 'Fichas Fornecedores',
          purchases: 'Compras',
          payments: 'Pagamentos',
          fleet_management: 'GestÃ£o de Frota',
          vehicles: 'VeÃ­culos',
          drivers: 'Motoristas',
          fuel: 'CombustÃ­vel',
          maintenance: 'ManutenÃ§Ã£o',
          tolls: 'Portagens',
          document_series: 'SÃ©ries Documentos',
          saft: 'SAF-T',
          reports: 'RelatÃ³rios',
          employees: 'FuncionÃ¡rios',
          contracts: 'Contratos',
          salaries: 'SalÃ¡rios',
          vacations: 'FÃ©rias',
          hr_documents: 'Documentos',
          
          // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ MÃ“DULO COTAÃ‡Ã•ES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          quotations_management: 'GestÃ£o de CotaÃ§Ãµes',
          quotations_subtitle: 'Propostas de preÃ§o para clientes',
          new_quotation: 'Nova CotaÃ§Ã£o',
          export: 'Exportar',
          total_quotations: 'Total CotaÃ§Ãµes',
          pending: 'Pendentes',
          accepted: 'Aceites',
          rejected: 'Recusadas',
          total_value_accepted: 'Valor Total (Aceites)',
          search_customer: 'Pesquisar cliente...',
          all_statuses: 'Todos os estados',
          status_pending: 'Pendente',
          status_accepted: 'Aceite',
          status_rejected: 'Recusada',
          status_converted: 'Convertida',
          status_expired: 'Expirada',
          date_from: 'Data de',
          date_to: 'Data atÃ©',
          clear: 'Limpar',
          quotations_count: 'cotaÃ§Ãµes',
          number: 'NÂº',
          date: 'Data',
          validity: 'Validade',
          customer_number_name: 'NÂº/Nome Cliente',
          description: 'DescriÃ§Ã£o',
          loading_location: 'Local Carga',
          unloading_location: 'Local Descarga',
          km: 'Km',
          price_per_km: 'â‚¬/Km',
          price_per_trip: 'â‚¬/Viagem',
          total: 'Total',
          status: 'Estado',
          actions: 'AÃ§Ãµes',
          no_quotation_found: 'Nenhuma cotaÃ§Ã£o encontrada',
          click_new_quotation: 'Clique em "Nova CotaÃ§Ã£o" para criar a primeira.',
          
          // Modal CotaÃ§Ã£o
          general_data: 'Dados Gerais',
          quotation_number: 'NÂº CotaÃ§Ã£o',
          customer: 'Cliente',
          customer_number: 'NÂº Cliente',
          customer_name: 'Nome Cliente',
          email: 'Email',
          phone: 'Telefone',
          service_details: 'Detalhes do ServiÃ§o',
          transport_type: 'Tipo de transporte/mercadoria',
          city_country: 'Cidade, PaÃ­s',
          observations: 'ObservaÃ§Ãµes',
          additional_notes: 'Notas adicionais...',
          price_calculation: 'CÃ¡lculo de PreÃ§o',
          distance_km: 'DistÃ¢ncia (Km)',
          extras: 'Extras',
          cancel: 'Cancelar',
          save_quotation: 'Guardar CotaÃ§Ã£o',
          
          // Modal Converter
          convert_to_booking: 'Converter em Reserva',
          quotation: 'CotaÃ§Ã£o',
          value: 'Valor',
          convert_action_text: 'Esta aÃ§Ã£o irÃ¡ criar uma nova reserva baseada nesta cotaÃ§Ã£o e alterar o estado para "Convertida".',
          booking_date: 'Data da Reserva',
          confirm_conversion: 'Confirmar ConversÃ£o',
          
          // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ MÃ“DULO RESERVAS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          bookings_management: 'GestÃ£o de Reservas',
          bookings_subtitle: 'Controlo de reservas de transporte',
          bookings_open_cargo: 'ğŸ“‹ Abertura de Reserva de Carga',
          required_fields_note: 'Os campos com (*) sÃ£o obrigatÃ³rios',
          invoice_number: 'ğŸ“„ NÂº Fatura',
          booking_editable: 'ğŸ”“ Reserva EditÃ¡vel',
          new_booking: 'Nova Reserva',
          save_booking: 'Guardar Reserva',
          create_booking: 'âœ“ Criar Reserva',
          edit_booking: 'âœï¸ Alterar Reserva',
          booking_number: 'NÂº Reserva',
          booking_date: 'Data Reserva',
          service_type: 'Tipo ServiÃ§o',
          priority: 'Prioridade',
          priority_normal: 'Normal',
          priority_urgent: 'Urgente',
          priority_very_urgent: 'Muito Urgente',
          commercial_rep: 'Comercial',
          team: 'Equipa',
          
          // SecÃ§Ãµes Reserva
          section1_customer_data: 'ğŸ‘¤ SecÃ§Ã£o 1 - Dados do Cliente',
          section2_cargo_details: 'ğŸ“¦ SecÃ§Ã£o 2 - Detalhes da Carga',
          section3_loading_location: 'ğŸšš SecÃ§Ã£o 3 - Local de Carga',
          section4_unloading_location: 'ğŸ“ SecÃ§Ã£o 4 - Local de Descarga',
          section5_documentation: 'ğŸ“„ SecÃ§Ã£o 5 - DocumentaÃ§Ã£o e IncidÃªncias',
          section6_subcontracting: 'ğŸ¤ SecÃ§Ã£o 6 - SubcontrataÃ§Ã£o',
          section_general: 'Dados Gerais',
          section_customer: 'Cliente',
          section_loading: 'Carga',
          section_unloading: 'Descarga',
          section_cargo: 'Mercadoria',
          section_transport: 'Transporte',
          section_billing: 'FaturaÃ§Ã£o',
          section_observations: 'ObservaÃ§Ãµes',
          
          // BotÃµes Reservas
          copy_customer_address: 'ğŸ“‹ Copiar Morada Cliente',
          driver_message: 'ğŸ’¬ Mensagem Motorista',
          collections: 'ğŸ“¦ Recolhas',
          create_cmr: 'ğŸ“„ Criar CMR',
          view_map: 'ğŸ—ºï¸ Ver Mapa',
          send_labels: 'ğŸ·ï¸ Enviar Etiquetas',
          
          // Campos Reserva
          loading_date: 'Data Carga',
          loading_time: 'Hora Carga',
          loading_address: 'Morada Carga',
          loading_postal_code: 'CÃ³digo Postal',
          loading_city: 'Cidade Carga',
          loading_country: 'PaÃ­s Carga',
          loading_contact: 'Contacto Carga',
          loading_phone: 'Telefone Carga',
          unloading_date: 'Data Descarga',
          unloading_time: 'Hora Descarga',
          unloading_address: 'Morada Descarga',
          unloading_postal_code: 'CÃ³digo Postal',
          unloading_city: 'Cidade Descarga',
          unloading_country: 'PaÃ­s Descarga',
          unloading_contact: 'Contacto Descarga',
          unloading_phone: 'Telefone Descarga',
          cargo_description: 'DescriÃ§Ã£o Mercadoria',
          packages: 'Volumes',
          weight_kg: 'Peso (Kg)',
          volume_m3: 'Volume (mÂ³)',
          ldm: 'LDM',
          stackable: 'EmpilhÃ¡vel',
          yes: 'Sim',
          no: 'NÃ£o',
          adr: 'ADR (Perigoso)',
          temperature_controlled: 'Temperatura Controlada',
          
          // Transporte
          driver: 'Motorista',
          tractor: 'Trator',
          trailer: 'Reboque',
          select_driver: 'Selecionar Motorista',
          select_tractor: 'Selecionar Trator',
          select_trailer: 'Selecionar Reboque',
          
          // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ AGENDAS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          agenda_groupings: 'Grupagens',
          agenda_direct_loads: 'Cargas Diretas',
          agenda_destinations: 'Destinos',
          agenda_distributions: 'DistribuiÃ§Ãµes',
          agenda_deliveries: 'Entregas',
          
          // Agenda 1
          agenda1_title: 'Agenda 1 - Recolhas',
          agenda1_subtitle: 'GestÃ£o de grupagens e recolhas',
          
          // Agenda 2
          agenda2_title: 'Agenda 2 - Planeamento',
          agenda2_subtitle: 'Planeamento de cargas',
          listing: 'Listagem',
          dashboards: 'Dashboards',
          type: 'Tipo',
          intermodal: 'Intermodal',
          route: 'Rota',
          dates: 'Datas',
          search: 'Pesquisa',
          pass_to_agenda3: 'Passar para Agenda 3',
          pass_agenda2: 'PASSAR AGENDA 2',
          booking: 'Booking',
          ship: 'Navio',
          train: 'Comboio',
          
          // Agenda 1
          agenda1_header: 'AGENDA 1',
          groupings: 'Grupagens',
          direct_loads: 'Cargas Diretas',
          status_all: 'Estado: Todos',
          select_all: 'â˜‘ Selec. Todas',
          clear_selection: 'â˜ Limpar',
          blank_line: 'â• Linha Branco',
          remove_blanks: 'âœ• Remover Brancos',
          direct_load: 'ğŸš› Carga Direta',
          create_grouping: 'ğŸ“¦ Criar Grupagem',
          open_grouping: 'ğŸ”“ Abrir Grupagem',
          cancel_direct_load: 'ğŸ—‘ Anular C.Direta',
          close_grouping: 'ğŸ”’ Fechar Grupagem',
          destination: 'Destino',
          direct_customers: 'ğŸšš DIRETO CLIENTES',
          direct_warehouse: 'ğŸ­ DIRETO ARMAZÃ‰M',
          
          // Agenda 2
          agenda2_header: 'AGENDA 2',
          pending_send: 'Por enviar',
          
          // Agenda 3
          agenda3_header: 'AGENDA 3 - DISTRIBUIÃ‡ÃƒO E ENTREGA',
          distributions: 'DistribuiÃ§Ãµes',
          delivery_driver: 'ğŸ‘¤ Motorista Entrega',
          delivery_tractor: 'ğŸš› Trator Entrega',
          delivery_trailer: 'ğŸš Reboque Entrega',
          agenda3_title: 'Agenda 3 - Entregas',
          agenda3_subtitle: 'GestÃ£o de entregas e distribuiÃ§Ãµes',
          cmr_loading: 'CMR Carga',
          cmr_unloading: 'CMR Descarga',
          send_warehouse_order: 'ğŸ“‹ Enviar Ord. ArmazÃ©m',
          return_to_origin: 'â†© Devolver Ã  Origem',
          revert_booking: 'ğŸ”„ Reverter Reserva',
          complementary: 'Complementar',
          gps_frotcom: 'GPS Frotcom',
          
          // Campos Agenda
          grouping_number: 'NÂº Grupagem',
          departure_date: 'Data SaÃ­da',
          departure_time: 'Hora SaÃ­da',
          arrival_date: 'Data Chegada',
          arrival_time: 'Hora Chegada',
          origin_warehouse: 'ArmazÃ©m Origem',
          destination_warehouse: 'ArmazÃ©m Destino',
          total_packages: 'Total Volumes',
          total_weight: 'Peso Total',
          total_ldm: 'LDM Total',
          observations_internal: 'ObservaÃ§Ãµes Internas',
          
          // Estados Agenda
          status_scheduled: 'Agendado',
          status_in_loading: 'Em Carga',
          status_in_transit: 'Em TrÃ¢nsito',
          status_in_unloading: 'Em Descarga',
          status_delivered: 'Entregue',
          status_incident: 'Incidente',
          
          // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ COMUNS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          logout: 'Sair',
          save: 'Guardar',
          edit: 'Editar',
          delete: 'Eliminar',
          view: 'Ver',
          print: 'Imprimir',
          close: 'Fechar',
          confirm: 'Confirmar',
          loading: 'A carregar...',
          no_data: 'Sem dados',
          required: 'ObrigatÃ³rio',
          optional: 'Opcional',
          select: 'Selecionar',
          select_option: '-- Selecione --',
          all: 'Todos',
          none: 'Nenhum',
          from: 'De',
          to: 'AtÃ©',
          total_records: 'Total de registos',
          
          // Mensagens
          msg_saved_success: 'Guardado com sucesso!',
          msg_deleted_success: 'Eliminado com sucesso!',
          msg_confirm_delete: 'Tem certeza que deseja eliminar?',
          msg_required_fields: 'Preencha os campos obrigatÃ³rios',
          msg_error: 'Ocorreu um erro',
          msg_no_results: 'Nenhum resultado encontrado',
          
          // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ MÃ“DULO CLIENTES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          customers_management: 'ğŸ‘¥ GestÃ£o de Clientes',
          customers_subtitle: 'Sistema de GestÃ£o LogÃ­stica Global - IntegraÃ§Ã£o SAP',
          customers_module: 'MÃ³dulo Clientes',
          customer_list: 'ğŸ“‹ Lista de Clientes',
          new_customer: 'â• Novo Cliente',
          total_customers: 'Total Clientes',
          annual_revenue: 'FaturaÃ§Ã£o Anual',
          customer_number: 'NÂº Cliente',
          search_customer_nif: 'Pesquisar por nÃºmero, nome, NIF...',
          email_history: 'ğŸ“§ HistÃ³rico Emails',
          section_customer_identification: 'ğŸ¢ SecÃ§Ã£o 1 - IdentificaÃ§Ã£o do Cliente',
          credit_limit: 'Plafond',
          import_sap: 'ğŸ“¥ Importar SAP',
          sap_connected: 'SAP Conectado',
          
          // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ MÃ“DULO FORNECEDORES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          suppliers_management: 'ğŸ¢ GestÃ£o de Fornecedores',
          suppliers_subtitle: 'Sistema de GestÃ£o LogÃ­stica Global',
          suppliers_module: 'MÃ³dulo Fornecedores',
          supplier_list: 'ğŸ“‹ Lista de Fornecedores',
          new_supplier: 'â• Novo Fornecedor',
          total_suppliers: 'Total Fornecedores',
          supplier_number: 'NÂº Fornecedor',
          search_supplier_nif: 'Pesquisar por nÃºmero, nome, NIF, cidade...',
          total_debt: 'Total em DÃ­vida',
          sap_account: 'Conta SAP',
          city: 'Cidade',
          
          // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ MÃ“DULO FATURAS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          invoices_management: 'ğŸ“„ GestÃ£o de Faturas',
          new_invoice: 'â• Nova Fatura',
          invoice_number_ph: 'NÂº Fatura...',
          all_types: 'Todos os tipos',
          automatic: 'AutomÃ¡tica',
          manual_with_booking: 'Manual c/ Reserva',
          standalone: 'Avulso (s/ Reserva)',
          due_date: 'Vencimento',
          base: 'Base',
          vat: 'IVA',
          paid: 'Pago',
          balance: 'Saldo',
          status_paid: 'Pago',
          status_partial: 'Parcialmente Pago',
          status_overdue: 'Vencido',
          
          // Campos comuns adicionais
          name: 'Nome',
          tax_id: 'NIF',
          country: 'PaÃ­s',
          type: 'Tipo',
          details: 'ğŸ‘ï¸ Detalhes',
          active: 'Ativos',
          blocked: 'Bloqueados',
          export: 'ğŸ“¥ Exportar',
          
          // Dias da semana
          monday: 'Segunda',
          tuesday: 'TerÃ§a',
          wednesday: 'Quarta',
          thursday: 'Quinta',
          friday: 'Sexta',
          saturday: 'SÃ¡bado',
          sunday: 'Domingo',
          
          // Meses
          january: 'Janeiro',
          february: 'Fevereiro',
          march: 'MarÃ§o',
          april: 'Abril',
          may: 'Maio',
          june: 'Junho',
          july: 'Julho',
          august: 'Agosto',
          september: 'Setembro',
          october: 'Outubro',
          november: 'Novembro',
          december: 'Dezembro'
        }
      },
      
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // ENGLISH
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      en: {
        translation: {
          // Menu
          menu_administration: 'âš™ï¸ Administration',
          menu_logistics: 'ğŸš› Logistics',
          menu_financial: 'ğŸ’° Financial',
          menu_suppliers: 'ğŸ­ Suppliers',
          menu_cost_control: 'ğŸ“Š Cost Control',
          menu_accounting: 'ğŸ“š Accounting',
          menu_hr: 'ğŸ‘¥ Human Resources',
          dashboard: 'General Dashboard',
          settings: 'Settings',
          users: 'Users',
          permissions: 'Permissions',
          commercial: 'Sales Team',
          teams: 'Teams',
          routes: 'Routes',
          warehouses: 'Warehouses',
          archive_agenda: 'Archive Agenda',
          logs: 'Logs / History',
          backup: 'Backup',
          quotations: 'Quotations',
          bookings: 'Bookings',
          agenda1: 'Agenda 1',
          agenda2: 'Agenda 2',
          agenda3: 'Agenda 3',
          customers: 'Customers',
          invoices: 'Invoices',
          pre_invoicing: 'Pre-Invoicing',
          invoicing_control: 'Invoicing Control',
          credit_notes: 'Credit Notes',
          receipts: 'Receipts',
          current_accounts: 'Current Accounts',
          supplier_files: 'Supplier Files',
          purchases: 'Purchases',
          payments: 'Payments',
          fleet_management: 'Fleet Management',
          vehicles: 'Vehicles',
          drivers: 'Drivers',
          fuel: 'Fuel',
          maintenance: 'Maintenance',
          tolls: 'Tolls',
          document_series: 'Document Series',
          saft: 'SAF-T',
          reports: 'Reports',
          employees: 'Employees',
          contracts: 'Contracts',
          salaries: 'Salaries',
          vacations: 'Vacations',
          hr_documents: 'Documents',
          
          // Quotations Module
          quotations_management: 'Quotations Management',
          quotations_subtitle: 'Price proposals for customers',
          new_quotation: 'New Quotation',
          export: 'Export',
          total_quotations: 'Total Quotations',
          pending: 'Pending',
          accepted: 'Accepted',
          rejected: 'Rejected',
          total_value_accepted: 'Total Value (Accepted)',
          search_customer: 'Search customer...',
          all_statuses: 'All statuses',
          status_pending: 'Pending',
          status_accepted: 'Accepted',
          status_rejected: 'Rejected',
          status_converted: 'Converted',
          status_expired: 'Expired',
          date_from: 'Date from',
          date_to: 'Date to',
          clear: 'Clear',
          quotations_count: 'quotations',
          number: 'No.',
          date: 'Date',
          validity: 'Validity',
          customer_number_name: 'Customer No./Name',
          description: 'Description',
          loading_location: 'Loading Location',
          unloading_location: 'Unloading Location',
          km: 'Km',
          price_per_km: 'â‚¬/Km',
          price_per_trip: 'â‚¬/Trip',
          total: 'Total',
          status: 'Status',
          actions: 'Actions',
          no_quotation_found: 'No quotation found',
          click_new_quotation: 'Click "New Quotation" to create the first one.',
          general_data: 'General Data',
          quotation_number: 'Quotation No.',
          customer: 'Customer',
          customer_number: 'Customer No.',
          customer_name: 'Customer Name',
          email: 'Email',
          phone: 'Phone',
          service_details: 'Service Details',
          transport_type: 'Transport type/goods',
          city_country: 'City, Country',
          observations: 'Observations',
          additional_notes: 'Additional notes...',
          price_calculation: 'Price Calculation',
          distance_km: 'Distance (Km)',
          extras: 'Extras',
          cancel: 'Cancel',
          save_quotation: 'Save Quotation',
          convert_to_booking: 'Convert to Booking',
          quotation: 'Quotation',
          value: 'Value',
          convert_action_text: 'This action will create a new booking based on this quotation and change the status to "Converted".',
          booking_date: 'Booking Date',
          confirm_conversion: 'Confirm Conversion',
          
          // Bookings Module
          bookings_management: 'Bookings Management',
          bookings_subtitle: 'Transport booking control',
          bookings_open_cargo: 'ğŸ“‹ Cargo Booking Opening',
          required_fields_note: 'Fields with (*) are required',
          invoice_number: 'ğŸ“„ Invoice No.',
          booking_editable: 'ğŸ”“ Editable Booking',
          new_booking: 'New Booking',
          save_booking: 'Save Booking',
          create_booking: 'âœ“ Create Booking',
          edit_booking: 'âœï¸ Edit Booking',
          booking_number: 'Booking No.',
          service_type: 'Service Type',
          priority: 'Priority',
          priority_normal: 'Normal',
          priority_urgent: 'Urgent',
          priority_very_urgent: 'Very Urgent',
          commercial_rep: 'Sales Rep',
          team: 'Team',
          section1_customer_data: 'ğŸ‘¤ Section 1 - Customer Data',
          section2_cargo_details: 'ğŸ“¦ Section 2 - Cargo Details',
          section3_loading_location: 'ğŸšš Section 3 - Loading Location',
          section4_unloading_location: 'ğŸ“ Section 4 - Unloading Location',
          section5_documentation: 'ğŸ“„ Section 5 - Documentation and Incidents',
          section6_subcontracting: 'ğŸ¤ Section 6 - Subcontracting',
          section_general: 'General Data',
          section_customer: 'Customer',
          section_loading: 'Loading',
          section_unloading: 'Unloading',
          section_cargo: 'Cargo',
          section_transport: 'Transport',
          section_billing: 'Billing',
          section_observations: 'Observations',
          copy_customer_address: 'ğŸ“‹ Copy Customer Address',
          driver_message: 'ğŸ’¬ Driver Message',
          collections: 'ğŸ“¦ Collections',
          create_cmr: 'ğŸ“„ Create CMR',
          view_map: 'ğŸ—ºï¸ View Map',
          send_labels: 'ğŸ·ï¸ Send Labels',
          loading_date: 'Loading Date',
          loading_time: 'Loading Time',
          loading_address: 'Loading Address',
          loading_postal_code: 'Postal Code',
          loading_city: 'Loading City',
          loading_country: 'Loading Country',
          loading_contact: 'Loading Contact',
          loading_phone: 'Loading Phone',
          unloading_date: 'Unloading Date',
          unloading_time: 'Unloading Time',
          unloading_address: 'Unloading Address',
          unloading_postal_code: 'Postal Code',
          unloading_city: 'Unloading City',
          unloading_country: 'Unloading Country',
          unloading_contact: 'Unloading Contact',
          unloading_phone: 'Unloading Phone',
          cargo_description: 'Cargo Description',
          packages: 'Packages',
          weight_kg: 'Weight (Kg)',
          volume_m3: 'Volume (mÂ³)',
          ldm: 'LDM',
          stackable: 'Stackable',
          yes: 'Yes',
          no: 'No',
          adr: 'ADR (Dangerous)',
          temperature_controlled: 'Temperature Controlled',
          driver: 'Driver',
          tractor: 'Tractor',
          trailer: 'Trailer',
          select_driver: 'Select Driver',
          select_tractor: 'Select Tractor',
          select_trailer: 'Select Trailer',
          
          // Agendas
          agenda_groupings: 'Groupings',
          agenda_direct_loads: 'Direct Loads',
          agenda_destinations: 'Destinations',
          agenda_distributions: 'Distributions',
          agenda_deliveries: 'Deliveries',
          
          // Agenda 1
          agenda1_header: 'AGENDA 1',
          agenda1_title: 'Agenda 1 - Collections',
          agenda1_subtitle: 'Groupings and collections management',
          groupings: 'Groupings',
          direct_loads: 'Direct Loads',
          status_all: 'Status: All',
          select_all: 'â˜‘ Select All',
          clear_selection: 'â˜ Clear',
          blank_line: 'â• Blank Line',
          remove_blanks: 'âœ• Remove Blanks',
          direct_load: 'ğŸš› Direct Load',
          create_grouping: 'ğŸ“¦ Create Grouping',
          open_grouping: 'ğŸ”“ Open Grouping',
          cancel_direct_load: 'ğŸ—‘ Cancel D.Load',
          close_grouping: 'ğŸ”’ Close Grouping',
          destination: 'Destination',
          direct_customers: 'ğŸšš DIRECT CUSTOMERS',
          direct_warehouse: 'ğŸ­ DIRECT WAREHOUSE',
          pass_agenda2: 'PASS TO AGENDA 2',
          
          // Agenda 2
          agenda2_header: 'AGENDA 2',
          agenda2_title: 'Agenda 2 - Planning',
          agenda2_subtitle: 'Load planning',
          pending_send: 'Pending send',
          listing: 'Listing',
          dashboards: 'Dashboards',
          type: 'Type',
          intermodal: 'Intermodal',
          route: 'Route',
          dates: 'Dates',
          search: 'Search',
          pass_to_agenda3: 'Pass to Agenda 3',
          booking: 'Booking',
          ship: 'Ship',
          train: 'Train',
          
          // Agenda 3
          agenda3_header: 'AGENDA 3 - DISTRIBUTION & DELIVERY',
          agenda3_title: 'Agenda 3 - Deliveries',
          agenda3_subtitle: 'Deliveries and distributions management',
          distributions: 'Distributions',
          delivery_driver: 'ğŸ‘¤ Delivery Driver',
          delivery_tractor: 'ğŸš› Delivery Tractor',
          delivery_trailer: 'ğŸš Delivery Trailer',
          cmr_loading: 'CMR Loading',
          cmr_unloading: 'CMR Unloading',
          send_warehouse_order: 'ğŸ“‹ Send Warehouse Order',
          return_to_origin: 'â†© Return to Origin',
          revert_booking: 'ğŸ”„ Revert Booking',
          complementary: 'Complementary',
          gps_frotcom: 'GPS Frotcom',
          grouping_number: 'Grouping No.',
          departure_date: 'Departure Date',
          departure_time: 'Departure Time',
          arrival_date: 'Arrival Date',
          arrival_time: 'Arrival Time',
          origin_warehouse: 'Origin Warehouse',
          destination_warehouse: 'Destination Warehouse',
          total_packages: 'Total Packages',
          total_weight: 'Total Weight',
          total_ldm: 'Total LDM',
          observations_internal: 'Internal Notes',
          status_scheduled: 'Scheduled',
          status_in_loading: 'Loading',
          status_in_transit: 'In Transit',
          status_in_unloading: 'Unloading',
          status_delivered: 'Delivered',
          status_incident: 'Incident',
          
          // Common
          logout: 'Logout',
          save: 'Save',
          edit: 'Edit',
          delete: 'Delete',
          view: 'View',
          print: 'Print',
          close: 'Close',
          confirm: 'Confirm',
          loading: 'Loading...',
          no_data: 'No data',
          required: 'Required',
          optional: 'Optional',
          select: 'Select',
          select_option: '-- Select --',
          all: 'All',
          none: 'None',
          from: 'From',
          to: 'To',
          total_records: 'Total records',
          msg_saved_success: 'Saved successfully!',
          msg_deleted_success: 'Deleted successfully!',
          msg_confirm_delete: 'Are you sure you want to delete?',
          msg_required_fields: 'Please fill in the required fields',
          msg_error: 'An error occurred',
          msg_no_results: 'No results found',
          
          // Customers Module
          customers_management: 'ğŸ‘¥ Customer Management',
          customers_subtitle: 'Global Logistics Management System - SAP Integration',
          customers_module: 'Customers Module',
          customer_list: 'ğŸ“‹ Customer List',
          new_customer: 'â• New Customer',
          total_customers: 'Total Customers',
          annual_revenue: 'Annual Revenue',
          customer_number: 'Customer No.',
          search_customer_nif: 'Search by number, name, VAT...',
          email_history: 'ğŸ“§ Email History',
          section_customer_identification: 'ğŸ¢ Section 1 - Customer Identification',
          credit_limit: 'Credit Limit',
          import_sap: 'ğŸ“¥ Import SAP',
          sap_connected: 'SAP Connected',
          
          // Suppliers Module
          suppliers_management: 'ğŸ¢ Supplier Management',
          suppliers_subtitle: 'Global Logistics Management System',
          suppliers_module: 'Suppliers Module',
          supplier_list: 'ğŸ“‹ Supplier List',
          new_supplier: 'â• New Supplier',
          total_suppliers: 'Total Suppliers',
          supplier_number: 'Supplier No.',
          search_supplier_nif: 'Search by number, name, VAT, city...',
          total_debt: 'Total Debt',
          sap_account: 'SAP Account',
          city: 'City',
          
          // Invoices Module
          invoices_management: 'ğŸ“„ Invoice Management',
          new_invoice: 'â• New Invoice',
          invoice_number_ph: 'Invoice No...',
          all_types: 'All types',
          automatic: 'Automatic',
          manual_with_booking: 'Manual w/ Booking',
          standalone: 'Standalone (no Booking)',
          due_date: 'Due Date',
          base: 'Base',
          vat: 'VAT',
          paid: 'Paid',
          balance: 'Balance',
          status_paid: 'Paid',
          status_partial: 'Partially Paid',
          status_overdue: 'Overdue',
          
          // Additional common fields
          name: 'Name',
          tax_id: 'VAT No.',
          country: 'Country',
          type: 'Type',
          details: 'ğŸ‘ï¸ Details',
          active: 'Active',
          blocked: 'Blocked',
          export: 'ğŸ“¥ Export',
          
          monday: 'Monday',
          tuesday: 'Tuesday',
          wednesday: 'Wednesday',
          thursday: 'Thursday',
          friday: 'Friday',
          saturday: 'Saturday',
          sunday: 'Sunday',
          january: 'January',
          february: 'February',
          march: 'March',
          april: 'April',
          may: 'May',
          june: 'June',
          july: 'July',
          august: 'August',
          september: 'September',
          october: 'October',
          november: 'November',
          december: 'December'
        }
      },
      
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // ESPAÃ‘OL
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      es: {
        translation: {
          menu_administration: 'âš™ï¸ AdministraciÃ³n',
          menu_logistics: 'ğŸš› LogÃ­stica',
          menu_financial: 'ğŸ’° Financiero',
          menu_suppliers: 'ğŸ­ Proveedores',
          menu_cost_control: 'ğŸ“Š Control de Costes',
          menu_accounting: 'ğŸ“š Contabilidad',
          menu_hr: 'ğŸ‘¥ Recursos Humanos',
          dashboard: 'Panel General',
          settings: 'ConfiguraciÃ³n',
          users: 'Usuarios',
          permissions: 'Permisos',
          quotations: 'Cotizaciones',
          bookings: 'Reservas',
          customers: 'Clientes',
          invoices: 'Facturas',
          quotations_management: 'GestiÃ³n de Cotizaciones',
          quotations_subtitle: 'Propuestas de precio para clientes',
          new_quotation: 'Nueva CotizaciÃ³n',
          export: 'Exportar',
          total_quotations: 'Total Cotizaciones',
          pending: 'Pendientes',
          accepted: 'Aceptadas',
          rejected: 'Rechazadas',
          search_customer: 'Buscar cliente...',
          all_statuses: 'Todos los estados',
          status_pending: 'Pendiente',
          status_accepted: 'Aceptada',
          status_rejected: 'Rechazada',
          status_converted: 'Convertida',
          status_expired: 'Expirada',
          clear: 'Limpiar',
          number: 'NÂº',
          date: 'Fecha',
          validity: 'Validez',
          description: 'DescripciÃ³n',
          loading_location: 'Lugar de Carga',
          unloading_location: 'Lugar de Descarga',
          total: 'Total',
          status: 'Estado',
          actions: 'Acciones',
          no_quotation_found: 'Ninguna cotizaciÃ³n encontrada',
          general_data: 'Datos Generales',
          customer: 'Cliente',
          service_details: 'Detalles del Servicio',
          observations: 'Observaciones',
          price_calculation: 'CÃ¡lculo de Precio',
          cancel: 'Cancelar',
          save_quotation: 'Guardar CotizaciÃ³n',
          convert_to_booking: 'Convertir en Reserva',
          bookings_management: 'GestiÃ³n de Reservas',
          new_booking: 'Nueva Reserva',
          save_booking: 'Guardar Reserva',
          priority: 'Prioridad',
          priority_normal: 'Normal',
          priority_urgent: 'Urgente',
          section_loading: 'Carga',
          section_unloading: 'Descarga',
          section_cargo: 'MercancÃ­a',
          loading_date: 'Fecha de Carga',
          unloading_date: 'Fecha de Descarga',
          packages: 'Bultos',
          weight_kg: 'Peso (Kg)',
          driver: 'Conductor',
          tractor: 'Tractor',
          trailer: 'Remolque',
          agenda_groupings: 'Agrupaciones',
          agenda_deliveries: 'Entregas',
          logout: 'Salir',
          save: 'Guardar',
          edit: 'Editar',
          delete: 'Eliminar',
          close: 'Cerrar',
          confirm: 'Confirmar',
          yes: 'SÃ­',
          no: 'No',
          msg_saved_success: 'Â¡Guardado con Ã©xito!',
          msg_confirm_delete: 'Â¿EstÃ¡ seguro de que desea eliminar?'
        }
      },
      
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // FRANÃ‡AIS
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      fr: {
        translation: {
          menu_administration: 'âš™ï¸ Administration',
          menu_logistics: 'ğŸš› Logistique',
          menu_financial: 'ğŸ’° Financier',
          menu_suppliers: 'ğŸ­ Fournisseurs',
          dashboard: 'Tableau de Bord',
          settings: 'ParamÃ¨tres',
          users: 'Utilisateurs',
          quotations: 'Devis',
          bookings: 'RÃ©servations',
          customers: 'Clients',
          invoices: 'Factures',
          quotations_management: 'Gestion des Devis',
          quotations_subtitle: 'Propositions de prix pour les clients',
          new_quotation: 'Nouveau Devis',
          export: 'Exporter',
          total_quotations: 'Total Devis',
          pending: 'En attente',
          accepted: 'AcceptÃ©s',
          rejected: 'RefusÃ©s',
          search_customer: 'Rechercher client...',
          all_statuses: 'Tous les statuts',
          status_pending: 'En attente',
          status_accepted: 'AcceptÃ©',
          status_rejected: 'RefusÃ©',
          clear: 'Effacer',
          number: 'NÂ°',
          date: 'Date',
          description: 'Description',
          loading_location: 'Lieu de Chargement',
          unloading_location: 'Lieu de DÃ©chargement',
          total: 'Total',
          status: 'Statut',
          actions: 'Actions',
          general_data: 'DonnÃ©es GÃ©nÃ©rales',
          customer: 'Client',
          observations: 'Remarques',
          cancel: 'Annuler',
          save_quotation: 'Enregistrer Devis',
          bookings_management: 'Gestion des RÃ©servations',
          new_booking: 'Nouvelle RÃ©servation',
          priority: 'PrioritÃ©',
          section_loading: 'Chargement',
          section_unloading: 'DÃ©chargement',
          section_cargo: 'Marchandise',
          loading_date: 'Date de Chargement',
          packages: 'Colis',
          weight_kg: 'Poids (Kg)',
          driver: 'Chauffeur',
          logout: 'DÃ©connexion',
          save: 'Enregistrer',
          edit: 'Modifier',
          delete: 'Supprimer',
          close: 'Fermer',
          yes: 'Oui',
          no: 'Non',
          msg_saved_success: 'EnregistrÃ© avec succÃ¨s!'
        }
      },
      
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // DEUTSCH
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      de: {
        translation: {
          menu_administration: 'âš™ï¸ Verwaltung',
          menu_logistics: 'ğŸš› Logistik',
          menu_financial: 'ğŸ’° Finanzen',
          dashboard: 'Ãœbersicht',
          users: 'Benutzer',
          quotations: 'Angebote',
          bookings: 'Buchungen',
          customers: 'Kunden',
          quotations_management: 'Angebotsverwaltung',
          new_quotation: 'Neues Angebot',
          export: 'Exportieren',
          total_quotations: 'Angebote Gesamt',
          pending: 'Ausstehend',
          accepted: 'Akzeptiert',
          rejected: 'Abgelehnt',
          search_customer: 'Kunde suchen...',
          all_statuses: 'Alle Status',
          clear: 'LÃ¶schen',
          number: 'Nr.',
          date: 'Datum',
          description: 'Beschreibung',
          total: 'Gesamt',
          status: 'Status',
          actions: 'Aktionen',
          customer: 'Kunde',
          cancel: 'Abbrechen',
          bookings_management: 'Buchungsverwaltung',
          new_booking: 'Neue Buchung',
          priority: 'PrioritÃ¤t',
          driver: 'Fahrer',
          logout: 'Abmelden',
          save: 'Speichern',
          edit: 'Bearbeiten',
          delete: 'LÃ¶schen',
          close: 'SchlieÃŸen',
          yes: 'Ja',
          no: 'Nein'
        }
      },
      
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // POLSKI (Polish) - EXPANDED
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      pl: {
        translation: {
          // Menu
          menu_administration: 'âš™ï¸ Administracja',
          menu_logistics: 'ğŸš› Logistyka',
          menu_financial: 'ğŸ’° Finanse',
          menu_suppliers: 'ğŸ­ Dostawcy',
          menu_cost_control: 'ğŸ“Š Kontrola KosztÃ³w',
          menu_accounting: 'ğŸ“š KsiÄ™gowoÅ›Ä‡',
          menu_hr: 'ğŸ‘¥ Kadry',
          dashboard: 'Panel GÅ‚Ã³wny',
          settings: 'Ustawienia',
          users: 'UÅ¼ytkownicy',
          permissions: 'Uprawnienia',
          quotations: 'Wyceny',
          bookings: 'Rezerwacje',
          agenda1: 'Agenda 1',
          agenda2: 'Agenda 2',
          agenda3: 'Agenda 3',
          customers: 'Klienci',
          invoices: 'Faktury',
          
          // Quotations
          quotations_management: 'ğŸ’¶ ZarzÄ…dzanie Wycenami',
          quotations_subtitle: 'Propozycje cenowe dla klientÃ³w',
          new_quotation: 'â• Nowa Wycena',
          export: 'ğŸ“¥ Eksport',
          total_quotations: 'ÅÄ…czna liczba wycen',
          pending: 'OczekujÄ…ce',
          accepted: 'Zaakceptowane',
          rejected: 'Odrzucone',
          total_value_accepted: 'WartoÅ›Ä‡ (Zaakceptowane)',
          search_customer: 'Szukaj klienta...',
          all_statuses: 'Wszystkie statusy',
          status_pending: 'OczekujÄ…cy',
          status_accepted: 'Zaakceptowany',
          status_rejected: 'Odrzucony',
          status_converted: 'Przekonwertowany',
          status_expired: 'WygasÅ‚y',
          clear: 'âœ– WyczyÅ›Ä‡',
          number: 'Nr',
          date: 'Data',
          validity: 'WaÅ¼noÅ›Ä‡',
          customer_number_name: 'Nr/Nazwa Klienta',
          description: 'Opis',
          loading_location: 'Miejsce ZaÅ‚adunku',
          unloading_location: 'Miejsce RozÅ‚adunku',
          total: 'Razem',
          status: 'Status',
          actions: 'Akcje',
          general_data: 'ğŸ“‹ Dane OgÃ³lne',
          customer: 'Klient',
          customer_number: 'Nr Klienta',
          customer_name: 'Nazwa Klienta',
          email: 'Email',
          phone: 'Telefon',
          service_details: 'ğŸšš SzczegÃ³Å‚y UsÅ‚ugi',
          observations: 'Uwagi',
          price_calculation: 'ğŸ’° Kalkulacja Ceny',
          cancel: 'Anuluj',
          save_quotation: 'ğŸ’¾ Zapisz WycenÄ™',
          convert_to_booking: 'ğŸ”„ Przekonwertuj na RezerwacjÄ™',
          
          // Bookings
          bookings_management: 'ZarzÄ…dzanie Rezerwacjami',
          bookings_open_cargo: 'ğŸ“‹ Otwarcie Rezerwacji Åadunku',
          required_fields_note: 'Pola oznaczone (*) sÄ… wymagane',
          invoice_number: 'ğŸ“„ Nr Faktury',
          booking_editable: 'ğŸ”“ Rezerwacja Edytowalna',
          new_booking: 'â• Nowa Rezerwacja',
          save_booking: 'Zapisz RezerwacjÄ™',
          create_booking: 'âœ“ UtwÃ³rz RezerwacjÄ™',
          edit_booking: 'âœï¸ Edytuj RezerwacjÄ™',
          booking_number: 'Nr Rezerwacji',
          section1_customer_data: 'ğŸ‘¤ Sekcja 1 - Dane Klienta',
          section2_cargo_details: 'ğŸ“¦ Sekcja 2 - SzczegÃ³Å‚y Åadunku',
          section3_loading_location: 'ğŸšš Sekcja 3 - Miejsce ZaÅ‚adunku',
          section4_unloading_location: 'ğŸ“ Sekcja 4 - Miejsce RozÅ‚adunku',
          section5_documentation: 'ğŸ“„ Sekcja 5 - Dokumentacja i Incydenty',
          copy_customer_address: 'ğŸ“‹ Kopiuj Adres Klienta',
          driver_message: 'ğŸ’¬ WiadomoÅ›Ä‡ do Kierowcy',
          collections: 'ğŸ“¦ Odbiory',
          
          // Agendas
          agenda1_header: 'AGENDA 1',
          agenda2_header: 'AGENDA 2',
          agenda3_header: 'AGENDA 3 - DYSTRYBUCJA I DOSTAWA',
          groupings: 'Grupowania',
          direct_loads: 'Åadunki BezpoÅ›rednie',
          distributions: 'Dystrybucje',
          select_all: 'â˜‘ Zaznacz Wszystkie',
          clear_selection: 'â˜ WyczyÅ›Ä‡',
          blank_line: 'â• Pusta Linia',
          remove_blanks: 'âœ• UsuÅ„ Puste',
          direct_load: 'ğŸš› Åadunek BezpoÅ›redni',
          create_grouping: 'ğŸ“¦ UtwÃ³rz Grupowanie',
          open_grouping: 'ğŸ”“ OtwÃ³rz Grupowanie',
          close_grouping: 'ğŸ”’ Zamknij Grupowanie',
          pass_agenda2: 'â¡ PRZEÅšLIJ DO AGENDA 2',
          send_warehouse_order: 'ğŸ“‹ WyÅ›lij Zlecenie Magazynowe',
          return_to_origin: 'â†© ZwrÃ³Ä‡ do Pochodzenia',
          revert_booking: 'ğŸ”„ Cofnij RezerwacjÄ™',
          delivery_driver: 'ğŸ‘¤ Kierowca Dostawy',
          delivery_tractor: 'ğŸš› CiÄ…gnik Dostawy',
          delivery_trailer: 'ğŸš Przyczepa Dostawy',
          ship: 'Statek',
          train: 'PociÄ…g',
          pending_send: 'Do wysÅ‚ania',
          
          // Customers
          customers_management: 'ğŸ‘¥ ZarzÄ…dzanie Klientami',
          customer_list: 'ğŸ“‹ Lista KlientÃ³w',
          new_customer: 'â• Nowy Klient',
          total_customers: 'ÅÄ…czna liczba KlientÃ³w',
          active: 'Aktywni',
          blocked: 'Zablokowani',
          annual_revenue: 'Roczny ObrÃ³t',
          
          // Suppliers
          suppliers_management: 'ğŸ¢ ZarzÄ…dzanie Dostawcami',
          supplier_list: 'ğŸ“‹ Lista DostawcÃ³w',
          new_supplier: 'â• Nowy Dostawca',
          total_suppliers: 'ÅÄ…czna liczba DostawcÃ³w',
          total_debt: 'CaÅ‚kowite ZadÅ‚uÅ¼enie',
          
          // Invoices
          invoices_management: 'ğŸ“„ ZarzÄ…dzanie Fakturami',
          new_invoice: 'â• Nowa Faktura',
          due_date: 'Termin PÅ‚atnoÅ›ci',
          vat: 'VAT',
          paid: 'ZapÅ‚acone',
          balance: 'Saldo',
          status_paid: 'ZapÅ‚acony',
          status_overdue: 'Przeterminowany',
          
          // Common
          logout: 'Wyloguj',
          save: 'Zapisz',
          edit: 'Edytuj',
          delete: 'UsuÅ„',
          view: 'Zobacz',
          print: 'Drukuj',
          close: 'Zamknij',
          confirm: 'PotwierdÅº',
          yes: 'Tak',
          no: 'Nie',
          name: 'Nazwa',
          type: 'Typ',
          country: 'Kraj',
          city: 'Miasto',
          details: 'ğŸ‘ï¸ SzczegÃ³Å‚y',
          select_option: '-- Wybierz --',
          msg_saved_success: 'Zapisano pomyÅ›lnie!',
          msg_confirm_delete: 'Czy na pewno chcesz usunÄ…Ä‡?'
        }
      },
      
      // Idiomas simplificados (herdam do EN com algumas chaves traduzidas)
      it: { translation: { menu_logistics: 'ğŸš› Logistica', menu_administration: 'âš™ï¸ Amministrazione', menu_financial: 'ğŸ’° Finanziario', quotations: 'Preventivi', bookings: 'Prenotazioni', customers: 'Clienti', invoices: 'Fatture', save: 'Salva', cancel: 'Annulla', logout: 'Esci', edit: 'Modifica', delete: 'Elimina', close: 'Chiudi', yes: 'SÃ¬', no: 'No', total: 'Totale', status: 'Stato', actions: 'Azioni', date: 'Data', name: 'Nome' } },
      nl: { translation: { menu_logistics: 'ğŸš› Logistiek', menu_administration: 'âš™ï¸ Administratie', menu_financial: 'ğŸ’° Financieel', quotations: 'Offertes', bookings: 'Boekingen', customers: 'Klanten', invoices: 'Facturen', save: 'Opslaan', cancel: 'Annuleren', logout: 'Uitloggen', edit: 'Bewerken', delete: 'Verwijderen', close: 'Sluiten', yes: 'Ja', no: 'Nee', total: 'Totaal', status: 'Status', actions: 'Acties', date: 'Datum', name: 'Naam' } },
      ro: { translation: { menu_logistics: 'ğŸš› LogisticÄƒ', quotations: 'CotaÈ›ii', bookings: 'RezervÄƒri', customers: 'ClienÈ›i', save: 'SalveazÄƒ', cancel: 'AnuleazÄƒ', logout: 'Deconectare' } },
      bg: { translation: { menu_logistics: 'ğŸš› Ğ›Ğ¾Ğ³Ğ¸ÑÑ‚Ğ¸ĞºĞ°', quotations: 'ĞÑ„ĞµÑ€Ñ‚Ğ¸', bookings: 'Ğ ĞµĞ·ĞµÑ€Ğ²Ğ°Ñ†Ğ¸Ğ¸', save: 'Ğ—Ğ°Ğ¿Ğ°Ğ·Ğ¸', cancel: 'ĞÑ‚ĞºĞ°Ğ·', logout: 'Ğ˜Ğ·Ñ…Ğ¾Ğ´' } },
      cs: { translation: { menu_logistics: 'ğŸš› Logistika', quotations: 'NabÃ­dky', bookings: 'Rezervace', save: 'UloÅ¾it', cancel: 'ZruÅ¡it', logout: 'OdhlÃ¡sit' } },
      hu: { translation: { menu_logistics: 'ğŸš› Logisztika', quotations: 'ÃrajÃ¡nlatok', bookings: 'FoglalÃ¡sok', save: 'MentÃ©s', cancel: 'MÃ©gse', logout: 'KijelentkezÃ©s' } },
      el: { translation: { menu_logistics: 'ğŸš› Î•Ï†Î¿Î´Î¹Î±ÏƒÏ„Î¹ÎºÎ®', quotations: 'Î ÏÎ¿ÏƒÏ†Î¿ÏÎ­Ï‚', bookings: 'ÎšÏÎ±Ï„Î®ÏƒÎµÎ¹Ï‚', save: 'Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·', cancel: 'Î‘ÎºÏÏÏ‰ÏƒÎ·', logout: 'Î‘Ï€Î¿ÏƒÏÎ½Î´ÎµÏƒÎ·' } },
      sv: { translation: { menu_logistics: 'ğŸš› Logistik', quotations: 'Offerter', bookings: 'Bokningar', save: 'Spara', cancel: 'Avbryt', logout: 'Logga ut' } },
      da: { translation: { menu_logistics: 'ğŸš› Logistik', quotations: 'Tilbud', bookings: 'Bookinger', save: 'Gem', cancel: 'Annuller', logout: 'Log ud' } },
      fi: { translation: { menu_logistics: 'ğŸš› Logistiikka', quotations: 'Tarjoukset', bookings: 'Varaukset', save: 'Tallenna', cancel: 'Peruuta', logout: 'Kirjaudu ulos' } },
      no: { translation: { menu_logistics: 'ğŸš› Logistikk', quotations: 'Tilbud', bookings: 'Bestillinger', save: 'Lagre', cancel: 'Avbryt', logout: 'Logg ut' } },
      hr: { translation: { menu_logistics: 'ğŸš› Logistika', quotations: 'Ponude', bookings: 'Rezervacije', save: 'Spremi', cancel: 'Odustani', logout: 'Odjava' } },
      sk: { translation: { menu_logistics: 'ğŸš› Logistika', quotations: 'Ponuky', bookings: 'RezervÃ¡cie', save: 'UloÅ¾iÅ¥', cancel: 'ZruÅ¡iÅ¥', logout: 'OdhlÃ¡siÅ¥' } },
      sl: { translation: { menu_logistics: 'ğŸš› Logistika', quotations: 'Ponudbe', bookings: 'Rezervacije', save: 'Shrani', cancel: 'PrekliÄi', logout: 'Odjava' } },
      lt: { translation: { menu_logistics: 'ğŸš› Logistika', quotations: 'PasiÅ«lymai', bookings: 'Rezervacijos', save: 'IÅ¡saugoti', cancel: 'AtÅ¡aukti', logout: 'Atsijungti' } },
      lv: { translation: { menu_logistics: 'ğŸš› LoÄ£istika', quotations: 'PiedÄvÄjumi', bookings: 'RezervÄcijas', save: 'SaglabÄt', cancel: 'Atcelt', logout: 'Iziet' } },
      et: { translation: { menu_logistics: 'ğŸš› Logistika', quotations: 'Pakkumised', bookings: 'Broneeringud', save: 'Salvesta', cancel: 'TÃ¼hista', logout: 'Logi vÃ¤lja' } },
      uk: { translation: { menu_logistics: 'ğŸš› Ğ›Ğ¾Ğ³Ñ–ÑÑ‚Ğ¸ĞºĞ°', quotations: 'ĞšĞ¾Ñ‚Ğ¸Ñ€ÑƒĞ²Ğ°Ğ½Ğ½Ñ', bookings: 'Ğ‘Ñ€Ğ¾Ğ½ÑĞ²Ğ°Ğ½Ğ½Ñ', save: 'Ğ—Ğ±ĞµÑ€ĞµĞ³Ñ‚Ğ¸', cancel: 'Ğ¡ĞºĞ°ÑÑƒĞ²Ğ°Ñ‚Ğ¸', logout: 'Ğ’Ğ¸Ñ…Ñ–Ğ´' } },
      ru: { translation: { menu_logistics: 'ğŸš› Ğ›Ğ¾Ğ³Ğ¸ÑÑ‚Ğ¸ĞºĞ°', quotations: 'ĞšĞ¾Ñ‚Ğ¸Ñ€Ğ¾Ğ²ĞºĞ¸', bookings: 'Ğ‘Ñ€Ğ¾Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ', save: 'Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ', cancel: 'ĞÑ‚Ğ¼ĞµĞ½Ğ°', logout: 'Ğ’Ñ‹Ñ…Ğ¾Ğ´' } },
      tr: { translation: { menu_logistics: 'ğŸš› Lojistik', quotations: 'Teklifler', bookings: 'Rezervasyonlar', save: 'Kaydet', cancel: 'Ä°ptal', logout: 'Ã‡Ä±kÄ±ÅŸ' } },
      ar: { translation: { menu_logistics: 'ğŸš› Ø§Ù„Ù„ÙˆØ¬Ø³ØªÙŠØ§Øª', quotations: 'Ø¹Ø±ÙˆØ¶ Ø§Ù„Ø£Ø³Ø¹Ø§Ø±', bookings: 'Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª', save: 'Ø­ÙØ¸', cancel: 'Ø¥Ù„ØºØ§Ø¡', logout: 'Ø®Ø±ÙˆØ¬' } },
      zh: { translation: { menu_logistics: 'ğŸš› ç‰©æµ', quotations: 'æŠ¥ä»·', bookings: 'é¢„è®¢', save: 'ä¿å­˜', cancel: 'å–æ¶ˆ', logout: 'é€€å‡º' } },
      ja: { translation: { menu_logistics: 'ğŸš› ç‰©æµ', quotations: 'è¦‹ç©', bookings: 'äºˆç´„', save: 'ä¿å­˜', cancel: 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«', logout: 'ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ' } },
      ko: { translation: { menu_logistics: 'ğŸš› ë¬¼ë¥˜', quotations: 'ê²¬ì ', bookings: 'ì˜ˆì•½', save: 'ì €ì¥', cancel: 'ì·¨ì†Œ', logout: 'ë¡œê·¸ì•„ì›ƒ' } }
    };
    
    // Inicializar i18next
    function initI18next() {
      if (typeof i18next === 'undefined') {
        console.warn('i18next nÃ£o carregado. A usar sistema de fallback.');
        return false;
      }
      
      i18next.init({
        lng: portalIdiomaAtual || 'pt',
        fallbackLng: 'pt',
        debug: false,
        resources: i18nResources,
        interpolation: {
          escapeValue: false
        },
        returnEmptyString: false,
        returnNull: false,
        missingKeyHandler: function(lng, ns, key) {
          console.log('Missing key:', key, 'for language:', lng);
        }
      }).then(function() {
        i18nextReady = true;
        console.log('âœ… i18next inicializado com sucesso - Idioma:', portalIdiomaAtual || 'pt');
        i18nApplyTranslations();
      });
      
      return true;
    }
    
    // FunÃ§Ã£o de traduÃ§Ã£o (wrapper para i18next)
    function t(key, options) {
      if (i18nextReady && typeof i18next !== 'undefined') {
        var result = i18next.t(key, options);
        // Se o resultado Ã© igual Ã  chave, tentar fallback manual
        if (result === key && i18nResources['pt'] && i18nResources['pt'].translation[key]) {
          return i18nResources['pt'].translation[key];
        }
        return result;
      }
      // Fallback se i18next nÃ£o estiver pronto
      var lang = portalIdiomaAtual || 'pt';
      var langData = i18nResources[lang];
      if (langData && langData.translation && langData.translation[key]) {
        return langData.translation[key];
      }
      // Fallback final para portuguÃªs
      if (i18nResources['pt'] && i18nResources['pt'].translation[key]) {
        return i18nResources['pt'].translation[key];
      }
      return key;
    }
    
    // Mudar idioma
    function i18nChangeLanguage(lang) {
      portalIdiomaAtual = lang;
      
      if (i18nextReady && typeof i18next !== 'undefined') {
        i18next.changeLanguage(lang).then(function() {
          i18nApplyTranslations();
          console.log('ğŸŒ Idioma alterado para:', lang);
        });
      } else {
        i18nApplyTranslations();
      }
      
      // Guardar na sessÃ£o
      if (portalUtilizadorAtual) {
        portalUtilizadorAtual.idioma = lang;
        var sessao = {
          user: portalUtilizadorAtual,
          idioma: lang,
          timestamp: Date.now()
        };
        localStorage.setItem('erpSessaoPortal', JSON.stringify(sessao));
      }
    }
    
    // Aplicar traduÃ§Ãµes a toda a interface
    function i18nApplyTranslations() {
      // Traduzir elementos com data-i18n
      document.querySelectorAll('[data-i18n]').forEach(function(el) {
        var key = el.getAttribute('data-i18n');
        var translated = t(key);
        
        if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
          if (el.hasAttribute('placeholder')) {
            el.placeholder = translated;
          } else {
            el.value = translated;
          }
        } else if (el.tagName === 'OPTION') {
          el.textContent = translated;
        } else {
          // Preservar Ã­cones/emojis no inÃ­cio
          var currentText = el.textContent;
          var emojiMatch = currentText.match(/^[\u{1F300}-\u{1F9FF}]|^[âš™ï¸ğŸš›ğŸ’°ğŸ­ğŸ“ŠğŸ“šğŸ‘¥ğŸ“…ğŸ’¶ğŸ“¦ğŸ“„ğŸ“‹ğŸ“‘ğŸ§¾ğŸ“’ğŸ“‡ğŸ›’ğŸ’³ğŸššğŸ”§â›½ğŸ›£ï¸ğŸ”¢ğŸ“ˆğŸ‘·ğŸ“ğŸ’µğŸ–ï¸ğŸ“‚ğŸ”ğŸ’¼ğŸ—„ï¸ğŸ“œğŸ’¾ğŸ¢]/u);
          if (emojiMatch) {
            el.textContent = emojiMatch[0] + ' ' + translated;
          } else {
            el.textContent = translated;
          }
        }
      });
      
      // Traduzir placeholders com data-i18n-placeholder
      document.querySelectorAll('[data-i18n-placeholder]').forEach(function(el) {
        var key = el.getAttribute('data-i18n-placeholder');
        el.placeholder = t(key);
      });
      
      // Traduzir tÃ­tulos com data-i18n-title
      document.querySelectorAll('[data-i18n-title]').forEach(function(el) {
        var key = el.getAttribute('data-i18n-title');
        el.title = t(key);
      });
      
      // Traduzir menu lateral
      i18nTranslateMenu();
      
      // Traduzir botÃ£o de logout
      var logoutBtn = document.querySelector('.portal-btn-logout');
      if (logoutBtn) logoutBtn.innerHTML = 'ğŸšª ' + t('logout');
    }
    
    // Traduzir menu lateral
    function i18nTranslateMenu() {
      var menuMappings = {
        'menu-administracao': { title: 'menu_administration', items: ['dashboard', 'settings', 'users', 'permissions', 'commercial', 'teams', 'routes', 'warehouses', 'archive_agenda', 'logs', 'backup'] },
        'menu-logistica': { title: 'menu_logistics', items: ['quotations', 'bookings', 'agenda1', 'agenda2', 'agenda3'] },
        'menu-financeiro': { title: 'menu_financial', items: ['dashboard', 'customers', 'invoices', 'pre_invoicing', 'invoicing_control', 'credit_notes', 'receipts', 'current_accounts'] },
        'menu-fornecedores': { title: 'menu_suppliers', items: ['supplier_files', 'purchases', 'invoices', 'credit_notes', 'payments', 'current_accounts'] },
        'menu-custos': { title: 'menu_cost_control', items: ['fleet_management', 'vehicles', 'drivers', 'fuel', 'maintenance', 'tolls'] },
        'menu-contabilidade': { title: 'menu_accounting', items: ['dashboard', 'document_series', 'saft', 'reports'] },
        'menu-rh': { title: 'menu_hr', items: ['employees', 'contracts', 'salaries', 'vacations', 'hr_documents'] }
      };
      
      Object.keys(menuMappings).forEach(function(menuId) {
        var mapping = menuMappings[menuId];
        var menuEl = document.getElementById(menuId);
        if (!menuEl) return;
        
        // Traduzir tÃ­tulo do menu
        var parentSection = menuEl.closest('.menu-section');
        if (parentSection) {
          var titleEl = parentSection.querySelector('.menu-title > span:first-child');
          if (titleEl) {
            titleEl.textContent = t(mapping.title);
          }
        }
        
        // Traduzir itens do menu
        var items = menuEl.querySelectorAll('.nav-item');
        items.forEach(function(item, index) {
          if (mapping.items[index]) {
            var textSpan = item.querySelector('span:last-child');
            if (textSpan) {
              textSpan.textContent = t(mapping.items[index]);
            }
          }
        });
      });
    }
    
    // Inicializar quando DOM estiver pronto
    document.addEventListener('DOMContentLoaded', function() {
      setTimeout(initI18next, 100);
    });
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // FIM SISTEMA DE TRADUÃ‡Ã•ES i18next
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    // DefiniÃ§Ã£o de Utilizadores Demo (em produÃ§Ã£o seria API/base de dados)
    const portalUtilizadoresDemo = [
      {
        id: 1,
        username: 'admin',
        password: 'admin123',
        nome: 'Administrador Sistema',
        email: 'admin@emeutrans.pt',
        perfil: 'Administrador',
        idioma: 'pt',
        passwordTrocada: true  // Permite login direto sem trocar password
      },
      {
        id: 2,
        username: 'operador',
        password: 'oper123',
        nome: 'JoÃ£o Operador',
        email: 'operador@emeutrans.pt',
        perfil: 'Operador LogÃ­stica',
        idioma: 'pt',
        passwordTrocada: true
      },
      {
        id: 3,
        username: 'faturacao',
        password: 'fat123',
        nome: 'Maria FaturaÃ§Ã£o',
        email: 'faturacao@emeutrans.pt',
        perfil: 'FaturaÃ§Ã£o',
        idioma: 'pt',
        passwordTrocada: true
      },
      {
        id: 4,
        username: 'gestor',
        password: 'gest123',
        nome: 'Carlos Gestor',
        email: 'gestor@emeutrans.pt',
        perfil: 'Gestor',
        idioma: 'pt',
        passwordTrocada: true
      },
      {
        id: 5,
        username: 'consulta',
        password: 'cons123',
        nome: 'Ana Consulta',
        email: 'consulta@emeutrans.pt',
        perfil: 'VisualizaÃ§Ã£o',
        idioma: 'pt',
        passwordTrocada: true
      }
    ];
    
    // DefiniÃ§Ã£o de PermissÃµes por Perfil
    const portalPermissoes = {
      'Administrador': {
        modulos: ['*'], // Todos os mÃ³dulos
        acoes: ['criar', 'editar', 'eliminar', 'exportar', 'configurar', 'consultar']
      },
      'Gestor': {
        modulos: ['dashboard', 'logistica', 'financeiro', 'clientes', 'fornecedores', 'relatorios', 
                  'cotacoes', 'reservas', 'agenda1', 'agenda2', 'agenda3', 'agendaarquivo',
                  'faturas', 'prefaturacao', 'recibos', 'notascredito', 'contascorrentes',
                  'fichasfornecedores'],
        acoes: ['criar', 'editar', 'eliminar', 'exportar', 'consultar']
      },
      'Operador LogÃ­stica': {
        modulos: ['*'], // TEMPORÃRIO: Acesso total durante fase de testes (21-31 Dez)
        acoes: ['criar', 'editar', 'eliminar', 'exportar', 'consultar']
      },
      'FaturaÃ§Ã£o': {
        modulos: ['*'], // TEMPORÃRIO: Acesso total durante fase de testes (21-31 Dez)
        acoes: ['criar', 'editar', 'eliminar', 'exportar', 'consultar']
      },
      'VisualizaÃ§Ã£o': {
        modulos: ['*'], // TEMPORÃRIO: Acesso total durante fase de testes (21-31 Dez)
        acoes: ['criar', 'editar', 'eliminar', 'exportar', 'consultar']
      }
    };
    
    // Mapeamento de pÃ¡ginas para categorias de mÃ³dulos
    const portalModulosPorPagina = {
      // AdministraÃ§Ã£o
      'dashboard': 'dashboard',
      'configuracoes': 'administracao',
      'utilizadores': 'administracao',
      'permissoes': 'administracao',
      'comerciais': 'administracao',
      'equipas': 'administracao',
      'rotas': 'administracao',
      'armazens': 'administracao',
      'logs': 'administracao',
      'backup': 'administracao',
      // LogÃ­stica
      'cotacoes': 'cotacoes',
      'reservas': 'reservas',
      'agenda1': 'agenda1',
      'agenda2': 'agenda2',
      'agenda3': 'agenda3',
      'agendaarquivo': 'agendaarquivo',
      // Financeiro
      'clientes': 'clientes',
      'faturas': 'faturas',
      'prefaturacao': 'prefaturacao',
      'controlofaturacao': 'controlofaturacao',
      'recibos': 'recibos',
      'notascredito': 'notascredito',
      'contascorrentes': 'contascorrentes',
      // Fornecedores
      'fichasfornecedores': 'fichasfornecedores',
      'compras': 'compras',
      'faturasfornecedores': 'faturasfornecedores',
      'ncfornecedores': 'ncfornecedores',
      'pagamentos': 'pagamentos',
      'ccfornecedores': 'ccfornecedores',
      // Custos
      'gestaofrota': 'gestaofrota',
      'veiculos': 'veiculos',
      'motoristas': 'motoristas',
      'combustivel': 'combustivel',
      'manutencao': 'manutencao',
      'portagens': 'portagens'
    };
    
    // FunÃ§Ã£o de Login
    function portalFazerLogin(e) {
      e.preventDefault();
      
      const username = document.getElementById('portalLoginUser').value.trim().toLowerCase();
      const password = document.getElementById('portalLoginPassword').value;
      const idioma = document.getElementById('portalLoginIdioma').value;
      
      // Esconder erro anterior
      document.getElementById('portalLoginError').classList.remove('portal-show');
      
      // Procurar utilizador nos dados demo
      let user = portalUtilizadoresDemo.find(u => 
        (u.username.toLowerCase() === username || u.email.toLowerCase() === username) && 
        u.password === password
      );
      
      // TambÃ©m verificar utilizadores guardados no localStorage
      if (!user) {
        const utilizadoresGuardados = JSON.parse(localStorage.getItem('erpUtilizadores') || '[]');
        user = utilizadoresGuardados.find(u => 
          (u.username?.toLowerCase() === username || u.email?.toLowerCase() === username) && 
          u.password === password
        );
      }
      
      if (user) {
        // Usar o idioma guardado do utilizador, ou o selecionado no login se nÃ£o houver
        portalIdiomaAtual = user.idioma || idioma;
        
        // Verificar se precisa trocar password (apenas para utilizadores NÃƒO demo)
        // Os utilizadores demo (ids 1-5) nunca precisam trocar password
        const isUtilizadorDemo = portalUtilizadoresDemo.some(u => u.username === user.username);
        
        if (!isUtilizadorDemo && !user.passwordTrocada) {
          console.log('ğŸ” Portal: Primeiro login - utilizador deve trocar password');
          portalMostrarTrocarPassword(user);
          return;
        }
        
        // Login com sucesso
        portalUtilizadorAtual = user;
        
        // Guardar sessÃ£o
        const sessao = {
          user: portalUtilizadorAtual,
          idioma: portalIdiomaAtual,
          timestamp: Date.now()
        };
        localStorage.setItem('erpSessaoPortal', JSON.stringify(sessao));
        
        // Mostrar ERP
        portalMostrarERP();
        
        console.log('ğŸ” Portal: Login com sucesso -', user.nome, '(' + user.perfil + ')');
      } else {
        // Erro de login
        document.getElementById('portalLoginErrorMsg').textContent = 'âŒ Utilizador ou password incorretos!';
        document.getElementById('portalLoginError').classList.add('portal-show');
      }
    }
    
    // FunÃ§Ã£o de Logout
    /**
     * FunÃ§Ã£o de entrada direta (bypass) para quando o login normal nÃ£o funciona
     * Remove para produÃ§Ã£o
     */
    function entrarDiretamente() {
      // Limpar qualquer sessÃ£o anterior
      localStorage.removeItem('erpSessaoPortal');
      
      // Criar utilizador admin diretamente
      portalUtilizadorAtual = {
        id: 1,
        username: 'admin',
        nome: 'Administrador Sistema',
        email: 'admin@emeutrans.pt',
        perfil: 'Administrador',
        idioma: 'pt',
        passwordTrocada: true
      };
      
      portalIdiomaAtual = 'pt';
      
      // Guardar sessÃ£o
      const sessao = {
        user: portalUtilizadorAtual,
        idioma: portalIdiomaAtual,
        timestamp: Date.now()
      };
      localStorage.setItem('erpSessaoPortal', JSON.stringify(sessao));
      
      // Mostrar ERP diretamente
      portalMostrarERP();
      
      console.log('âš¡ Entrada direta como Administrador');
    }
    
    function portalFazerLogout() {
      localStorage.removeItem('erpSessaoPortal');
      portalUtilizadorAtual = null;
      
      // Esconder ERP
      document.getElementById('portalErpContainer').classList.remove('portal-active');
      
      // Mostrar Login
      document.getElementById('portalLoginScreen').classList.remove('portal-hidden');
      
      // Limpar campos
      document.getElementById('portalLoginUser').value = '';
      document.getElementById('portalLoginPassword').value = '';
      
      console.log('ğŸšª Portal: Logout efetuado');
    }
    
    // Mostrar ERP apÃ³s login
    function portalMostrarERP() {
      // Esconder login
      document.getElementById('portalLoginScreen').classList.add('portal-hidden');
      
      // Mostrar ERP
      document.getElementById('portalErpContainer').classList.add('portal-active');
      
      // Atualizar dados do utilizador na barra
      const iniciais = portalUtilizadorAtual.nome.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
      document.getElementById('portalUserAvatar').textContent = iniciais;
      document.getElementById('portalUserName').textContent = portalUtilizadorAtual.nome;
      document.getElementById('portalUserRole').textContent = portalUtilizadorAtual.perfil;
      document.getElementById('portalIdiomaSelect').value = portalIdiomaAtual;
      
      // Aplicar permissÃµes ao menu
      portalAplicarPermissoesMenu();
      
      // Aplicar traduÃ§Ãµes ao idioma do utilizador
      i18nApplyTranslations();
      
      // INICIALIZAR CLIENTES ao arrancar o ERP (para que estejam disponÃ­veis em todos os mÃ³dulos)
      setTimeout(function() {
        if (typeof clientesInit === 'function') {
          clientesInit();
          console.log('âœ… Clientes inicializados no arranque do ERP');
        }
      }, 200);
    }
    
    // Aplicar permissÃµes ao menu lateral
    function portalAplicarPermissoesMenu() {
      const perfil = portalUtilizadorAtual.perfil;
      const permissoes = portalPermissoes[perfil];
      
      if (!permissoes) return;
      
      // Se tem acesso a tudo, nÃ£o bloquear nada
      if (permissoes.modulos.includes('*')) return;
      
      // Percorrer todos os itens do menu
      const menuItems = document.querySelectorAll('.nav-item');
      menuItems.forEach(item => {
        const onclick = item.getAttribute('onclick') || '';
        const match = onclick.match(/navegarPara\('([^']+)'\)/);
        if (match) {
          const pagina = match[1];
          const modulo = portalModulosPorPagina[pagina] || pagina;
          
          // Verificar se tem permissÃ£o
          const temPermissao = permissoes.modulos.includes(modulo) || 
                               permissoes.modulos.includes(pagina);
          
          if (!temPermissao) {
            item.classList.add('portal-menu-blocked');
            item.onclick = function(e) {
              e.preventDefault();
              alert('ğŸ”’ Acesso Restrito\n\nNÃ£o tem permissÃ£o para aceder a este mÃ³dulo.\nPerfil atual: ' + perfil);
            };
          }
        }
      });
      
      console.log('ğŸ” Portal: PermissÃµes aplicadas para perfil', perfil);
    }
    
    // Verificar permissÃ£o para uma aÃ§Ã£o especÃ­fica
    function portalTemPermissao(acao) {
      if (!portalUtilizadorAtual) return false;
      
      const perfil = portalUtilizadorAtual.perfil;
      const permissoes = portalPermissoes[perfil];
      
      if (!permissoes) return false;
      if (permissoes.acoes.includes('*')) return true;
      
      return permissoes.acoes.includes(acao);
    }
    
    // Verificar permissÃ£o para um mÃ³dulo
    function portalTemPermissaoModulo(modulo) {
      if (!portalUtilizadorAtual) return false;
      
      const perfil = portalUtilizadorAtual.perfil;
      const permissoes = portalPermissoes[perfil];
      
      if (!permissoes) return false;
      if (permissoes.modulos.includes('*')) return true;
      
      return permissoes.modulos.includes(modulo);
    }
    
    // Mudar idioma
    function portalMudarIdioma(codigo) {
      // Usar o sistema i18next
      i18nChangeLanguage(codigo);
      
      // Atualizar idioma no localStorage de utilizadores
      if (portalUtilizadorAtual) {
        var utilizadores = JSON.parse(localStorage.getItem('erpUtilizadores') || '[]');
        var idx = utilizadores.findIndex(function(u) { return u.id === portalUtilizadorAtual.id || u.username === portalUtilizadorAtual.username; });
        if (idx >= 0) {
          utilizadores[idx].idioma = codigo;
          localStorage.setItem('erpUtilizadores', JSON.stringify(utilizadores));
        }
      }
    }
    
    // Verificar sessÃ£o existente ao carregar
    function portalVerificarSessao() {
      const sessaoStr = localStorage.getItem('erpSessaoPortal');
      
      if (sessaoStr) {
        try {
          const sessao = JSON.parse(sessaoStr);
          
          // Verificar se sessÃ£o nÃ£o expirou (8 horas)
          const agora = Date.now();
          const tempoSessao = 8 * 60 * 60 * 1000; // 8 horas em ms
          
          if (sessao.user && (agora - sessao.timestamp) < tempoSessao) {
            portalUtilizadorAtual = sessao.user;
            portalIdiomaAtual = sessao.idioma || 'pt';
            
            console.log('ğŸ” Portal: SessÃ£o recuperada -', portalUtilizadorAtual.nome);
            portalMostrarERP();
            return true;
          } else {
            // SessÃ£o expirada
            localStorage.removeItem('erpSessaoPortal');
            console.log('â° Portal: SessÃ£o expirada');
          }
        } catch (e) {
          console.error('Portal: Erro ao ler sessÃ£o', e);
          localStorage.removeItem('erpSessaoPortal');
        }
      }
      
      return false;
    }
    
    // Obter utilizador atual (para uso noutros mÃ³dulos)
    function portalObterUtilizador() {
      return portalUtilizadorAtual;
    }
    
    // InicializaÃ§Ã£o do Portal
    document.addEventListener('DOMContentLoaded', function() {
      // Verificar se jÃ¡ tem sessÃ£o vÃ¡lida
      if (!portalVerificarSessao()) {
        // Mostrar ecrÃ£ de login
        document.getElementById('portalLoginScreen').classList.remove('portal-hidden');
      }
      
      // Guardar idioma preferido
      const idiomaGuardado = localStorage.getItem('portalIdiomaPreferido');
      if (idiomaGuardado) {
        document.getElementById('portalLoginIdioma').value = idiomaGuardado;
      }
    });
    

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // MÃ“DULO ADMINISTRAÃ‡ÃƒO - JAVASCRIPT v6.1
    // Prefixo: admin
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // DADOS E CONFIGURAÃ‡ÃƒO
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    var adminArmazens = JSON.parse(localStorage.getItem('erpArmazens') || '[]');
    var adminUtilizadores = JSON.parse(localStorage.getItem('erpUtilizadores') || '[]');
    var adminComerciais = JSON.parse(localStorage.getItem('erpComerciais') || '[]');
    var adminEquipas = JSON.parse(localStorage.getItem('erpEquipas') || '[]');
    var adminRotas = JSON.parse(localStorage.getItem('erpRotas') || '[]');
    var adminPermissoesCustom = JSON.parse(localStorage.getItem('erpPermissoesCustom') || '{}');
    
    // ConfiguraÃ§Ã£o de mÃ³dulos e aÃ§Ãµes para permissÃµes
    var adminModulosConfig = [
      { id: 'dashboard', nome: 'ğŸ“Š Dashboard' },
      { id: 'cotacoes', nome: 'ğŸ’¶ CotaÃ§Ãµes' },
      { id: 'reservas', nome: 'ğŸ“¦ Reservas' },
      { id: 'agenda1', nome: 'ğŸ“… Agenda 1' },
      { id: 'agenda2', nome: 'ğŸ“… Agenda 2' },
      { id: 'agenda3', nome: 'ğŸ“… Agenda 3' },
      { id: 'agendaarquivo', nome: 'ğŸ“š Agenda Arquivo' },
      { id: 'clientes', nome: 'ğŸ‘¥ Clientes' },
      { id: 'faturas', nome: 'ğŸ“„ Faturas' },
      { id: 'prefaturacao', nome: 'ğŸ“‹ PrÃ©-FaturaÃ§Ã£o' },
      { id: 'recibos', nome: 'ğŸ§¾ Recibos' },
      { id: 'notascredito', nome: 'ğŸ“ Notas CrÃ©dito' },
      { id: 'contascorrentes', nome: 'ğŸ’³ Contas Correntes' },
      { id: 'fichasfornecedores', nome: 'ğŸ­ Fornecedores' },
      { id: 'compras', nome: 'ğŸ›’ Compras' },
      { id: 'faturasfornecedores', nome: 'ğŸ“„ Fat. Fornec.' },
      { id: 'pagamentos', nome: 'ğŸ’³ Pagamentos' },
      { id: 'gestaofrota', nome: 'ğŸš› GestÃ£o Frota' },
      { id: 'combustivel', nome: 'â›½ CombustÃ­vel' },
      { id: 'manutencao', nome: 'ğŸ”§ ManutenÃ§Ã£o' },
      { id: 'armazens', nome: 'ğŸ¢ ArmazÃ©ns' },
      { id: 'utilizadores', nome: 'ğŸ‘¤ Utilizadores' },
      { id: 'comerciais', nome: 'ğŸ’¼ Comerciais' },
      { id: 'equipas', nome: 'ğŸ‘¥ Equipas' },
      { id: 'rotas', nome: 'ğŸ›£ï¸ Rotas' },
      { id: 'permissoes', nome: 'ğŸ” PermissÃµes' }
    ];
    
    var adminAcoesConfig = [
      { id: 'consultar', nome: 'ğŸ‘ï¸ Consultar' },
      { id: 'criar', nome: 'â• Criar' },
      { id: 'editar', nome: 'âœï¸ Editar' },
      { id: 'eliminar', nome: 'ğŸ—‘ï¸ Eliminar' },
      { id: 'exportar', nome: 'ğŸ“¥ Exportar' },
      { id: 'configurar', nome: 'âš™ï¸ Configurar' }
    ];
    
    var adminPermissoesPorPerfil = {
      'Administrador': { modulos: ['*'], acoes: ['*'] },
      'Gestor': { 
        modulos: ['dashboard', 'cotacoes', 'reservas', 'agenda1', 'agenda2', 'agenda3', 'clientes', 'faturas', 'gestaofrota'],
        acoes: ['consultar', 'criar', 'editar', 'eliminar', 'exportar']
      },
      'Gestor LogÃ­stica': {
        modulos: ['dashboard', 'cotacoes', 'reservas', 'agenda1', 'agenda2', 'agenda3', 'agendaarquivo', 'gestaofrota'],
        acoes: ['consultar', 'criar', 'editar', 'exportar']
      },
      'Gestor ArmazÃ©m': {
        modulos: ['dashboard', 'reservas', 'agenda1', 'agenda2', 'agenda3', 'agendaarquivo', 'gestaofrota'],
        acoes: ['consultar', 'criar', 'editar', 'exportar']
      },
      'Comercial': {
        modulos: ['dashboard', 'cotacoes', 'reservas', 'clientes'],
        acoes: ['consultar', 'criar', 'editar']
      },
      'Operador LogÃ­stica': {
        modulos: ['dashboard', 'reservas', 'agenda1', 'agenda2', 'agenda3', 'agendaarquivo'],
        acoes: ['consultar', 'criar', 'editar']
      },
      'FaturaÃ§Ã£o': {
        modulos: ['dashboard', 'clientes', 'faturas', 'prefaturacao', 'controlofaturacao', 'recibos', 'notascredito', 'contascorrentes'],
        acoes: ['consultar', 'criar', 'editar', 'eliminar', 'exportar']
      },
      'VisualizaÃ§Ã£o': {
        modulos: ['dashboard', 'agendaarquivo'],
        acoes: ['consultar']
      }
    };
    
    // Carregar permissÃµes customizadas do localStorage
    var adminPermissoesPorPerfilCustom = JSON.parse(localStorage.getItem('erpPermissoesPorPerfil') || 'null') || adminPermissoesPorPerfil;
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // FUNÃ‡Ã•ES UTILITÃRIAS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    function adminGerarId() {
      return Date.now().toString(36) + Math.random().toString(36).substr(2);
    }
    
    function adminTogglePassword(inputId, btn) {
      var input = document.getElementById(inputId);
      if (input.type === 'password') {
        input.type = 'text';
        btn.textContent = 'ğŸ™ˆ';
      } else {
        input.type = 'password';
        btn.textContent = 'ğŸ‘ï¸';
      }
    }
    
    function adminGerarPassword() {
      var chars = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%';
      var password = '';
      for (var i = 0; i < 12; i++) {
        password += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      document.getElementById('adminUsrPassword').value = password;
      document.getElementById('adminUsrPassword').type = 'text';
    }
    
    function adminSalvarDados() {
      localStorage.setItem('erpArmazens', JSON.stringify(adminArmazens));
      localStorage.setItem('erpUtilizadores', JSON.stringify(adminUtilizadores));
      localStorage.setItem('erpComerciais', JSON.stringify(adminComerciais));
      localStorage.setItem('erpEquipas', JSON.stringify(adminEquipas));
      localStorage.setItem('erpRotas', JSON.stringify(adminRotas));
      localStorage.setItem('erpPermissoesCustom', JSON.stringify(adminPermissoesCustom));
      localStorage.setItem('erpPermissoesPorPerfil', JSON.stringify(adminPermissoesPorPerfilCustom));
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ARMAZÃ‰NS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    function adminArmazensRenderizar() {
      var tbody = document.getElementById('adminArmTabelaBody');
      var filtrados = adminArmazensFiltrados();
      
      // KPIs
      document.getElementById('adminArmKpiTotal').textContent = adminArmazens.length;
      document.getElementById('adminArmKpiAtivos').textContent = adminArmazens.filter(function(a) { return a.estado === 'Ativo'; }).length;
      var capacidade = adminArmazens.reduce(function(sum, a) { return sum + (parseFloat(a.capacidade) || 0); }, 0);
      document.getElementById('adminArmKpiCapacidade').textContent = capacidade.toLocaleString('pt-PT');
      
      // Contador
      document.getElementById('adminArmContador').textContent = filtrados.length + ' registos';
      
      // Tabela
      if (filtrados.length === 0) {
        tbody.innerHTML = '';
        document.getElementById('adminArmEmpty').style.display = 'block';
        document.getElementById('adminArmTabela').style.display = 'none';
        return;
      }
      
      document.getElementById('adminArmEmpty').style.display = 'none';
      document.getElementById('adminArmTabela').style.display = 'table';
      
      tbody.innerHTML = filtrados.map(function(a) {
        var badgeClass = a.estado === 'Ativo' ? 'admin-badge-ativo' : 
                         a.estado === 'Inativo' ? 'admin-badge-inativo' : 'admin-badge-manutencao';
        var badgeIcon = a.estado === 'Ativo' ? 'âœ…' : a.estado === 'Inativo' ? 'â¸ï¸' : 'ğŸ”§';
        
        return '<tr>' +
          '<td><strong>' + a.codigo + '</strong></td>' +
          '<td>' + a.nome + '</td>' +
          '<td>' + a.localidade + '</td>' +
          '<td>' + a.pais + '</td>' +
          '<td>' + (a.capacidade ? a.capacidade + ' mÂ²' : '-') + '</td>' +
          '<td>' + (a.responsavel || '-') + '</td>' +
          '<td><span class="admin-badge ' + badgeClass + '">' + badgeIcon + ' ' + a.estado + '</span></td>' +
          '<td class="admin-actions">' +
            '<button class="admin-btn-action admin-btn-edit" onclick="adminArmazensEditar(\'' + a.id + '\')" title="Editar">âœï¸</button>' +
            '<button class="admin-btn-action admin-btn-delete" onclick="adminArmazensEliminar(\'' + a.id + '\')" title="Eliminar">ğŸ—‘ï¸</button>' +
          '</td>' +
        '</tr>';
      }).join('');
    }
    
    function adminArmazensFiltrados() {
      var pesquisa = (document.getElementById('adminArmPesquisa').value || '').toLowerCase();
      var estado = document.getElementById('adminArmFiltroEstado').value;
      var pais = document.getElementById('adminArmFiltroPais').value;
      
      return adminArmazens.filter(function(a) {
        var matchPesquisa = !pesquisa || 
          a.codigo.toLowerCase().includes(pesquisa) ||
          a.nome.toLowerCase().includes(pesquisa) ||
          a.localidade.toLowerCase().includes(pesquisa);
        var matchEstado = !estado || a.estado === estado;
        var matchPais = !pais || a.pais === pais;
        return matchPesquisa && matchEstado && matchPais;
      });
    }
    
    function adminArmazensFiltrar() {
      adminArmazensRenderizar();
    }
    
    function adminArmazensNovo() {
      document.getElementById('adminArmId').value = '';
      document.getElementById('adminArmCodigo').value = 'ARM' + String(adminArmazens.length + 1).padStart(3, '0');
      document.getElementById('adminArmNome').value = '';
      document.getElementById('adminArmMorada').value = '';
      document.getElementById('adminArmCodigoPostal').value = '';
      document.getElementById('adminArmLocalidade').value = '';
      document.getElementById('adminArmPais').value = 'Portugal';
      document.getElementById('adminArmCapacidade').value = '';
      document.getElementById('adminArmTelefone').value = '';
      document.getElementById('adminArmEmail').value = '';
      document.getElementById('adminArmResponsavel').value = '';
      document.getElementById('adminArmEstado').value = 'Ativo';
      document.getElementById('adminArmHorario').value = '';
      document.getElementById('adminArmObservacoes').value = '';
      document.getElementById('adminArmModalTitulo').textContent = 'ğŸ¢ Novo ArmazÃ©m';
      document.getElementById('adminArmModal').classList.add('active');
    }
    
    function adminArmazensEditar(id) {
      var arm = adminArmazens.find(function(a) { return a.id === id; });
      if (!arm) return;
      
      document.getElementById('adminArmId').value = arm.id;
      document.getElementById('adminArmCodigo').value = arm.codigo;
      document.getElementById('adminArmNome').value = arm.nome;
      document.getElementById('adminArmMorada').value = arm.morada || '';
      document.getElementById('adminArmCodigoPostal').value = arm.codigoPostal || '';
      document.getElementById('adminArmLocalidade').value = arm.localidade;
      document.getElementById('adminArmPais').value = arm.pais;
      document.getElementById('adminArmCapacidade').value = arm.capacidade || '';
      document.getElementById('adminArmTelefone').value = arm.telefone || '';
      document.getElementById('adminArmEmail').value = arm.email || '';
      document.getElementById('adminArmResponsavel').value = arm.responsavel || '';
      document.getElementById('adminArmEstado').value = arm.estado;
      document.getElementById('adminArmHorario').value = arm.horario || '';
      document.getElementById('adminArmObservacoes').value = arm.observacoes || '';
      document.getElementById('adminArmModalTitulo').textContent = 'ğŸ¢ Editar ArmazÃ©m';
      document.getElementById('adminArmModal').classList.add('active');
    }
    
    function adminArmazensGuardar() {
      var codigo = document.getElementById('adminArmCodigo').value.trim();
      var nome = document.getElementById('adminArmNome').value.trim();
      var morada = document.getElementById('adminArmMorada').value.trim();
      var localidade = document.getElementById('adminArmLocalidade').value.trim();
      var pais = document.getElementById('adminArmPais').value;
      var estado = document.getElementById('adminArmEstado').value;
      
      if (!codigo || !nome || !morada || !localidade) {
        alert('âš ï¸ Preencha os campos obrigatÃ³rios: CÃ³digo, Nome, Morada e Localidade');
        return;
      }
      
      var id = document.getElementById('adminArmId').value;
      var dados = {
        id: id || adminGerarId(),
        codigo: codigo,
        nome: nome,
        morada: morada,
        codigoPostal: document.getElementById('adminArmCodigoPostal').value.trim(),
        localidade: localidade,
        pais: pais,
        capacidade: document.getElementById('adminArmCapacidade').value,
        telefone: document.getElementById('adminArmTelefone').value.trim(),
        email: document.getElementById('adminArmEmail').value.trim(),
        responsavel: document.getElementById('adminArmResponsavel').value.trim(),
        estado: estado,
        horario: document.getElementById('adminArmHorario').value.trim(),
        observacoes: document.getElementById('adminArmObservacoes').value.trim()
      };
      
      if (id) {
        var idx = adminArmazens.findIndex(function(a) { return a.id === id; });
        if (idx >= 0) adminArmazens[idx] = dados;
      } else {
        adminArmazens.push(dados);
      }
      
      adminSalvarDados();
      adminArmazensFecharModal();
      adminArmazensRenderizar();
      alert('âœ… ArmazÃ©m guardado com sucesso!');
    }
    
    function adminArmazensEliminar(id) {
      if (!confirm('âš ï¸ Tem certeza que deseja eliminar este armazÃ©m?')) return;
      adminArmazens = adminArmazens.filter(function(a) { return a.id !== id; });
      adminSalvarDados();
      adminArmazensRenderizar();
      alert('âœ… ArmazÃ©m eliminado!');
    }
    
    function adminArmazensFecharModal() {
      document.getElementById('adminArmModal').classList.remove('active');
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // UTILIZADORES
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    function adminUtilizadoresRenderizar() {
      var tbody = document.getElementById('adminUsrTabelaBody');
      var filtrados = adminUtilizadoresFiltrados();
      
      // KPIs
      document.getElementById('adminUsrKpiTotal').textContent = adminUtilizadores.length;
      document.getElementById('adminUsrKpiAtivos').textContent = adminUtilizadores.filter(function(u) { return u.estado === 'Ativo'; }).length;
      document.getElementById('adminUsrKpiBloqueados').textContent = adminUtilizadores.filter(function(u) { return u.estado === 'Bloqueado'; }).length;
      
      // Contador
      document.getElementById('adminUsrContador').textContent = filtrados.length + ' registos';
      
      // Preencher selects de equipas e armazÃ©ns no modal
      var selectEquipa = document.getElementById('adminUsrEquipa');
      var selectArmazem = document.getElementById('adminUsrArmazem');
      selectEquipa.innerHTML = '<option value="">-- Sem equipa --</option>' + 
        adminEquipas.filter(function(e) { return e.estado === 'Ativo'; }).map(function(e) {
          return '<option value="' + e.codigo + '">' + e.nome + '</option>';
        }).join('');
      selectArmazem.innerHTML = '<option value="">-- Sem armazÃ©m --</option>' + 
        adminArmazens.filter(function(a) { return a.estado === 'Ativo'; }).map(function(a) {
          return '<option value="' + a.codigo + '">' + a.nome + '</option>';
        }).join('');
      
      // Tabela
      if (filtrados.length === 0) {
        tbody.innerHTML = '';
        document.getElementById('adminUsrEmpty').style.display = 'block';
        document.getElementById('adminUsrTabela').style.display = 'none';
        return;
      }
      
      document.getElementById('adminUsrEmpty').style.display = 'none';
      document.getElementById('adminUsrTabela').style.display = 'table';
      
      var idiomas = { 
        pt: 'ğŸ‡µğŸ‡¹', en: 'ğŸ‡¬ğŸ‡§', es: 'ğŸ‡ªğŸ‡¸', fr: 'ğŸ‡«ğŸ‡·', de: 'ğŸ‡©ğŸ‡ª', 
        it: 'ğŸ‡®ğŸ‡¹', nl: 'ğŸ‡³ğŸ‡±', pl: 'ğŸ‡µğŸ‡±', ro: 'ğŸ‡·ğŸ‡´', bg: 'ğŸ‡§ğŸ‡¬',
        cs: 'ğŸ‡¨ğŸ‡¿', hu: 'ğŸ‡­ğŸ‡º', el: 'ğŸ‡¬ğŸ‡·', sv: 'ğŸ‡¸ğŸ‡ª', da: 'ğŸ‡©ğŸ‡°',
        fi: 'ğŸ‡«ğŸ‡®', no: 'ğŸ‡³ğŸ‡´', hr: 'ğŸ‡­ğŸ‡·', sk: 'ğŸ‡¸ğŸ‡°', sl: 'ğŸ‡¸ğŸ‡®',
        lt: 'ğŸ‡±ğŸ‡¹', lv: 'ğŸ‡±ğŸ‡»', et: 'ğŸ‡ªğŸ‡ª', uk: 'ğŸ‡ºğŸ‡¦', ru: 'ğŸ‡·ğŸ‡º',
        tr: 'ğŸ‡¹ğŸ‡·', ar: 'ğŸ‡¸ğŸ‡¦', zh: 'ğŸ‡¨ğŸ‡³', ja: 'ğŸ‡¯ğŸ‡µ', ko: 'ğŸ‡°ğŸ‡·'
      };
      
      tbody.innerHTML = filtrados.map(function(u) {
        var badgeClass = u.estado === 'Ativo' ? 'admin-badge-ativo' : 
                         u.estado === 'Inativo' ? 'admin-badge-inativo' : 'admin-badge-bloqueado';
        var badgeIcon = u.estado === 'Ativo' ? 'âœ…' : u.estado === 'Inativo' ? 'â¸ï¸' : 'ğŸ”’';
        var idiomaIcon = idiomas[u.idioma] || 'ğŸŒ';
        var departamento = u.departamento || '-';
        
        return '<tr>' +
          '<td><strong>' + u.username + '</strong></td>' +
          '<td>' + u.nome + '</td>' +
          '<td>' + u.perfil + '</td>' +
          '<td>' + departamento + '</td>' +
          '<td><button class="admin-btn-action admin-btn-view" onclick="adminUtilizadoresVerPassword(\'' + u.id + '\')" title="Ver Password" style="font-size:0.75rem;padding:4px 8px;">ğŸ”‘ Ver</button>' + (u.passwordTrocada ? ' <span style="color:#10b981;font-size:0.7rem;">âœ“</span>' : ' <span style="color:#f59e0b;font-size:0.7rem;">â³</span>') + '</td>' +
          '<td><span class="admin-badge ' + badgeClass + '">' + badgeIcon + ' ' + u.estado + '</span></td>' +
          '<td class="admin-actions">' +
            '<button class="admin-btn-action admin-btn-edit" onclick="adminUtilizadoresEditar(\'' + u.id + '\')" title="Editar">âœï¸</button>' +
            '<button class="admin-btn-action admin-btn-delete" onclick="adminUtilizadoresEliminar(\'' + u.id + '\')" title="Eliminar">ğŸ—‘ï¸</button>' +
          '</td>' +
        '</tr>';
      }).join('');
    }
    
    function adminUtilizadoresFiltrados() {
      var pesquisa = (document.getElementById('adminUsrPesquisa').value || '').toLowerCase();
      var estado = document.getElementById('adminUsrFiltroEstado').value;
      var perfil = document.getElementById('adminUsrFiltroPerfil').value;
      
      return adminUtilizadores.filter(function(u) {
        var matchPesquisa = !pesquisa || 
          u.username.toLowerCase().includes(pesquisa) ||
          u.nome.toLowerCase().includes(pesquisa) ||
          u.email.toLowerCase().includes(pesquisa);
        var matchEstado = !estado || u.estado === estado;
        var matchPerfil = !perfil || u.perfil === perfil;
        return matchPesquisa && matchEstado && matchPerfil;
      });
    }
    
    function adminUtilizadoresFiltrar() {
      adminUtilizadoresRenderizar();
    }
    
    function adminUtilizadoresNovo() {
      document.getElementById('adminUsrId').value = '';
      document.getElementById('adminUsrUsername').value = '';
      document.getElementById('adminUsrPassword').value = '';
      document.getElementById('adminUsrPassword').type = 'password';
      document.getElementById('adminUsrNome').value = '';
      document.getElementById('adminUsrEmail').value = '';
      document.getElementById('adminUsrTelefone').value = '';
      document.getElementById('adminUsrIdioma').value = 'pt';
      document.getElementById('adminUsrPerfil').value = 'Comercial';
      document.getElementById('adminUsrDepartamento').value = '';
      document.getElementById('adminUsrEstado').value = 'Ativo';
      document.getElementById('adminUsrEquipa').value = '';
      document.getElementById('adminUsrArmazem').value = '';
      document.getElementById('adminUsrObservacoes').value = '';
      document.getElementById('adminUsrForcarTrocaPassword').checked = true; // Novo utilizador deve trocar password
      document.getElementById('adminUsrModalTitulo').textContent = 'ğŸ‘¤ Novo Utilizador';
      document.getElementById('adminUsrModal').classList.add('active');
    }
    
    function adminUtilizadoresEditar(id) {
      var usr = adminUtilizadores.find(function(u) { return u.id === id; });
      if (!usr) return;
      
      document.getElementById('adminUsrId').value = usr.id;
      document.getElementById('adminUsrUsername').value = usr.username;
      document.getElementById('adminUsrPassword').value = usr.password;
      document.getElementById('adminUsrPassword').type = 'password';
      document.getElementById('adminUsrNome').value = usr.nome;
      document.getElementById('adminUsrEmail').value = usr.email;
      document.getElementById('adminUsrTelefone').value = usr.telefone || '';
      document.getElementById('adminUsrIdioma').value = usr.idioma;
      document.getElementById('adminUsrPerfil').value = usr.perfil;
      document.getElementById('adminUsrDepartamento').value = usr.departamento || '';
      document.getElementById('adminUsrEstado').value = usr.estado;
      document.getElementById('adminUsrEquipa').value = usr.equipa || '';
      document.getElementById('adminUsrArmazem').value = usr.armazem || '';
      document.getElementById('adminUsrObservacoes').value = usr.observacoes || '';
      document.getElementById('adminUsrForcarTrocaPassword').checked = !usr.passwordTrocada;
      document.getElementById('adminUsrModalTitulo').textContent = 'ğŸ‘¤ Editar Utilizador';
      document.getElementById('adminUsrModal').classList.add('active');
    }
    
    function adminUtilizadoresGuardar() {
      var username = document.getElementById('adminUsrUsername').value.trim().toLowerCase();
      var password = document.getElementById('adminUsrPassword').value;
      var nome = document.getElementById('adminUsrNome').value.trim();
      var email = document.getElementById('adminUsrEmail').value.trim();
      var idioma = document.getElementById('adminUsrIdioma').value;
      var perfil = document.getElementById('adminUsrPerfil').value;
      var departamento = document.getElementById('adminUsrDepartamento').value;
      var estado = document.getElementById('adminUsrEstado').value;
      
      if (!username || !password || !nome || !email) {
        alert('âš ï¸ Preencha os campos obrigatÃ³rios: Username, Password, Nome e Email');
        return;
      }
      
      var id = document.getElementById('adminUsrId').value;
      
      // Verificar username duplicado
      var duplicado = adminUtilizadores.find(function(u) { return u.username === username && u.id !== id; });
      if (duplicado) {
        alert('âš ï¸ Este username jÃ¡ existe!');
        return;
      }
      
      var dados = {
        id: id || adminGerarId(),
        username: username,
        password: password,
        nome: nome,
        email: email,
        telefone: document.getElementById('adminUsrTelefone').value.trim(),
        idioma: idioma,
        perfil: perfil,
        departamento: departamento,
        estado: estado,
        equipa: document.getElementById('adminUsrEquipa').value,
        armazem: document.getElementById('adminUsrArmazem').value,
        observacoes: document.getElementById('adminUsrObservacoes').value.trim(),
        passwordTrocada: !document.getElementById('adminUsrForcarTrocaPassword').checked
      };
      
      if (id) {
        var idx = adminUtilizadores.findIndex(function(u) { return u.id === id; });
        if (idx >= 0) adminUtilizadores[idx] = dados;
      } else {
        adminUtilizadores.push(dados);
      }
      
      adminSalvarDados();
      adminUtilizadoresFecharModal();
      adminUtilizadoresRenderizar();
      alert('âœ… Utilizador guardado com sucesso!');
    }
    
    function adminUtilizadoresEliminar(id) {
      if (!confirm('âš ï¸ Tem certeza que deseja eliminar este utilizador?')) return;
      adminUtilizadores = adminUtilizadores.filter(function(u) { return u.id !== id; });
      adminSalvarDados();
      adminUtilizadoresRenderizar();
      alert('âœ… Utilizador eliminado!');
    }
    

    function adminUtilizadoresVerPassword(id) {
      var usr = adminUtilizadores.find(function(u) { return u.id === id; });
      if (!usr) return;
      
      var info = 'ğŸ‘¤ Utilizador: ' + usr.nome + '\n';
      info += 'ğŸ“§ Username: ' + usr.username + '\n\n';
      info += 'ğŸ”‘ Password Atual: ' + usr.password + '\n';
      
      if (usr.passwordTrocada) {
        info += '\nâœ… Password jÃ¡ foi alterada pelo utilizador';
        info += '\nğŸ“… Data: ' + new Date(usr.dataTrocaPassword).toLocaleString('pt-PT');
        if (usr.passwordAnterior) {
          info += '\n\nğŸ”’ Password Original (atribuÃ­da pelo admin): ' + usr.passwordAnterior;
        }
      } else {
        info += '\nâ³ Utilizador ainda nÃ£o trocou a password';
        info += '\nâš ï¸ SerÃ¡ obrigado a trocar no primeiro login';
      }
      
      alert(info);
    }
    
    function adminUtilizadoresFecharModal() {
      document.getElementById('adminUsrModal').classList.remove('active');
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // COMERCIAIS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    function adminComerciaisRenderizar() {
      var tbody = document.getElementById('adminComTabelaBody');
      var filtrados = adminComerciaisFiltrados();
      
      // KPIs
      document.getElementById('adminComKpiTotal').textContent = adminComerciais.length;
      document.getElementById('adminComKpiAtivos').textContent = adminComerciais.filter(function(c) { return c.estado === 'Ativo'; }).length;
      var comissaoMedia = adminComerciais.length > 0 ? 
        (adminComerciais.reduce(function(sum, c) { return sum + (parseFloat(c.comissao) || 0); }, 0) / adminComerciais.length).toFixed(1) : 0;
      document.getElementById('adminComKpiComissao').textContent = comissaoMedia + '%';
      
      // Contador
      document.getElementById('adminComContador').textContent = filtrados.length + ' registos';
      
      // Preencher select de equipas no modal
      var selectEquipa = document.getElementById('adminComEquipa');
      selectEquipa.innerHTML = '<option value="">-- Sem equipa --</option>' + 
        adminEquipas.filter(function(e) { return e.estado === 'Ativo'; }).map(function(e) {
          return '<option value="' + e.codigo + '">' + e.nome + '</option>';
        }).join('');
      
      // Preencher select de utilizadores no modal
      var selectUtilizador = document.getElementById('adminComUtilizador');
      selectUtilizador.innerHTML = '<option value="">-- Sem utilizador --</option>' + 
        adminUtilizadores.filter(function(u) { return u.estado === 'Ativo'; }).map(function(u) {
          return '<option value="' + u.username + '">' + u.nome + ' (' + u.username + ')</option>';
        }).join('');
      
      // Tabela
      if (filtrados.length === 0) {
        tbody.innerHTML = '';
        document.getElementById('adminComEmpty').style.display = 'block';
        document.getElementById('adminComTabela').style.display = 'none';
        return;
      }
      
      document.getElementById('adminComEmpty').style.display = 'none';
      document.getElementById('adminComTabela').style.display = 'table';
      
      tbody.innerHTML = filtrados.map(function(c) {
        var badgeClass = c.estado === 'Ativo' ? 'admin-badge-ativo' : 'admin-badge-inativo';
        var badgeIcon = c.estado === 'Ativo' ? 'âœ…' : 'â¸ï¸';
        
        return '<tr>' +
          '<td><strong>' + c.codigo + '</strong></td>' +
          '<td>' + c.nome + '</td>' +
          '<td>' + c.email + '</td>' +
          '<td>' + (c.telefone || '-') + '</td>' +
          '<td>' + (c.zona || '-') + '</td>' +
          '<td>' + (c.equipa || '-') + '</td>' +
          '<td>' + (c.comissao ? c.comissao + '%' : '-') + '</td>' +
          '<td><span class="admin-badge ' + badgeClass + '">' + badgeIcon + ' ' + c.estado + '</span></td>' +
          '<td class="admin-actions">' +
            '<button class="admin-btn-action admin-btn-edit" onclick="adminComerciaisEditar(\'' + c.id + '\')" title="Editar">âœï¸</button>' +
            '<button class="admin-btn-action admin-btn-delete" onclick="adminComerciaisEliminar(\'' + c.id + '\')" title="Eliminar">ğŸ—‘ï¸</button>' +
          '</td>' +
        '</tr>';
      }).join('');
    }
    
    function adminComerciaisFiltrados() {
      var pesquisa = (document.getElementById('adminComPesquisa').value || '').toLowerCase();
      var estado = document.getElementById('adminComFiltroEstado').value;
      var zona = document.getElementById('adminComFiltroZona').value;
      
      return adminComerciais.filter(function(c) {
        var matchPesquisa = !pesquisa || 
          c.codigo.toLowerCase().includes(pesquisa) ||
          c.nome.toLowerCase().includes(pesquisa) ||
          c.email.toLowerCase().includes(pesquisa);
        var matchEstado = !estado || c.estado === estado;
        var matchZona = !zona || c.zona === zona;
        return matchPesquisa && matchEstado && matchZona;
      });
    }
    
    function adminComerciaisFiltrar() {
      adminComerciaisRenderizar();
    }
    
    function adminComerciaisNovo() {
      document.getElementById('adminComId').value = '';
      document.getElementById('adminComCodigo').value = 'COM' + String(adminComerciais.length + 1).padStart(3, '0');
      document.getElementById('adminComNome').value = '';
      document.getElementById('adminComEmail').value = '';
      document.getElementById('adminComTelefone').value = '';
      document.getElementById('adminComZona').value = '';
      document.getElementById('adminComComissao').value = '';
      document.getElementById('adminComEquipa').value = '';
      document.getElementById('adminComUtilizador').value = '';
      document.getElementById('adminComEstado').value = 'Ativo';
      document.getElementById('adminComObservacoes').value = '';
      document.getElementById('adminComModalTitulo').textContent = 'ğŸ’¼ Novo Comercial';
      document.getElementById('adminComModal').classList.add('active');
    }
    
    function adminComerciaisEditar(id) {
      var com = adminComerciais.find(function(c) { return c.id === id; });
      if (!com) return;
      
      document.getElementById('adminComId').value = com.id;
      document.getElementById('adminComCodigo').value = com.codigo;
      document.getElementById('adminComNome').value = com.nome;
      document.getElementById('adminComEmail').value = com.email;
      document.getElementById('adminComTelefone').value = com.telefone || '';
      document.getElementById('adminComZona').value = com.zona || '';
      document.getElementById('adminComComissao').value = com.comissao || '';
      document.getElementById('adminComEquipa').value = com.equipa || '';
      document.getElementById('adminComUtilizador').value = com.utilizador || '';
      document.getElementById('adminComEstado').value = com.estado;
      document.getElementById('adminComObservacoes').value = com.observacoes || '';
      document.getElementById('adminComModalTitulo').textContent = 'ğŸ’¼ Editar Comercial';
      document.getElementById('adminComModal').classList.add('active');
    }
    
    function adminComerciaisGuardar() {
      var codigo = document.getElementById('adminComCodigo').value.trim();
      var nome = document.getElementById('adminComNome').value.trim();
      var email = document.getElementById('adminComEmail').value.trim();
      var estado = document.getElementById('adminComEstado').value;
      
      if (!codigo || !nome || !email) {
        alert('âš ï¸ Preencha os campos obrigatÃ³rios: CÃ³digo, Nome e Email');
        return;
      }
      
      var id = document.getElementById('adminComId').value;
      var dados = {
        id: id || adminGerarId(),
        codigo: codigo,
        nome: nome,
        email: email,
        telefone: document.getElementById('adminComTelefone').value.trim(),
        zona: document.getElementById('adminComZona').value,
        comissao: document.getElementById('adminComComissao').value,
        equipa: document.getElementById('adminComEquipa').value,
        utilizador: document.getElementById('adminComUtilizador').value,
        estado: estado,
        observacoes: document.getElementById('adminComObservacoes').value.trim()
      };
      
      if (id) {
        var idx = adminComerciais.findIndex(function(c) { return c.id === id; });
        if (idx >= 0) adminComerciais[idx] = dados;
      } else {
        adminComerciais.push(dados);
      }
      
      adminSalvarDados();
      adminComerciaisFecharModal();
      adminComerciaisRenderizar();
      alert('âœ… Comercial guardado com sucesso!');
    }
    
    function adminComerciaisEliminar(id) {
      if (!confirm('âš ï¸ Tem certeza que deseja eliminar este comercial?')) return;
      adminComerciais = adminComerciais.filter(function(c) { return c.id !== id; });
      adminSalvarDados();
      adminComerciaisRenderizar();
      alert('âœ… Comercial eliminado!');
    }
    
    function adminComerciaisFecharModal() {
      document.getElementById('adminComModal').classList.remove('active');
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // EQUIPAS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    function adminEquipasRenderizar() {
      var tbody = document.getElementById('adminEqpTabelaBody');
      var filtrados = adminEquipasFiltrados();
      
      // KPIs
      document.getElementById('adminEqpKpiTotal').textContent = adminEquipas.length;
      document.getElementById('adminEqpKpiAtivas').textContent = adminEquipas.filter(function(e) { return e.estado === 'Ativo'; }).length;
      var totalMembros = adminEquipas.reduce(function(sum, e) { return sum + (e.membros ? e.membros.length : 0); }, 0);
      document.getElementById('adminEqpKpiMembros').textContent = totalMembros;
      
      // Contador
      document.getElementById('adminEqpContador').textContent = filtrados.length + ' registos';
      
      // Preencher select de armazÃ©m no modal
      var selectArmazem = document.getElementById('adminEqpArmazem');
      selectArmazem.innerHTML = '<option value="">-- Sem armazÃ©m --</option>' + 
        adminArmazens.filter(function(a) { return a.estado === 'Ativo'; }).map(function(a) {
          return '<option value="' + a.codigo + '">' + a.nome + '</option>';
        }).join('');
      
      // O responsÃ¡vel Ã© preenchido dinamicamente baseado nos membros selecionados
      
      // Tabela
      if (filtrados.length === 0) {
        tbody.innerHTML = '';
        document.getElementById('adminEqpEmpty').style.display = 'block';
        document.getElementById('adminEqpTabela').style.display = 'none';
        return;
      }
      
      document.getElementById('adminEqpEmpty').style.display = 'none';
      document.getElementById('adminEqpTabela').style.display = 'table';
      
      var tipoIcons = { 'LogÃ­stica': 'ğŸš›', 'ArmazÃ©m': 'ğŸ¢', 'Comercial': 'ğŸ’¼', 'FaturaÃ§Ã£o': 'ğŸ’°', 'AdministraÃ§Ã£o': 'âš™ï¸' };
      
      tbody.innerHTML = filtrados.map(function(e) {
        var badgeClass = e.estado === 'Ativo' ? 'admin-badge-ativo' : 'admin-badge-inativo';
        var badgeIcon = e.estado === 'Ativo' ? 'âœ…' : 'â¸ï¸';
        var tipoIcon = tipoIcons[e.tipo] || 'ğŸ‘¥';
        var numMembros = e.membros ? e.membros.length : 0;
        
        return '<tr>' +
          '<td><strong>' + e.codigo + '</strong></td>' +
          '<td>' + e.nome + '</td>' +
          '<td>' + tipoIcon + ' ' + e.tipo + '</td>' +
          '<td>' + (e.responsavel || '-') + '</td>' +
          '<td>' + (e.armazem || '-') + '</td>' +
          '<td>' + numMembros + ' ğŸ‘¤</td>' +
          '<td><span class="admin-badge ' + badgeClass + '">' + badgeIcon + ' ' + e.estado + '</span></td>' +
          '<td class="admin-actions">' +
            '<button class="admin-btn-action admin-btn-view" onclick="adminEquipasVerMembros(\'' + e.id + '\')" title="Ver Membros">ğŸ‘¥</button>' +
            '<button class="admin-btn-action admin-btn-edit" onclick="adminEquipasEditar(\'' + e.id + '\')" title="Editar">âœï¸</button>' +
            '<button class="admin-btn-action admin-btn-delete" onclick="adminEquipasEliminar(\'' + e.id + '\')" title="Eliminar">ğŸ—‘ï¸</button>' +
          '</td>' +
        '</tr>';
      }).join('');
    }
    
    function adminEquipasFiltrados() {
      var pesquisa = (document.getElementById('adminEqpPesquisa').value || '').toLowerCase();
      var estado = document.getElementById('adminEqpFiltroEstado').value;
      var tipo = document.getElementById('adminEqpFiltroTipo').value;
      
      return adminEquipas.filter(function(e) {
        var matchPesquisa = !pesquisa || 
          e.codigo.toLowerCase().includes(pesquisa) ||
          e.nome.toLowerCase().includes(pesquisa);
        var matchEstado = !estado || e.estado === estado;
        var matchTipo = !tipo || e.tipo === tipo;
        return matchPesquisa && matchEstado && matchTipo;
      });
    }
    
    function adminEquipasFiltrar() {
      adminEquipasRenderizar();
    }
    
    function adminEquipasNovo() {
      document.getElementById('adminEqpId').value = '';
      document.getElementById('adminEqpCodigo').value = 'EQP' + String(adminEquipas.length + 1).padStart(3, '0');
      document.getElementById('adminEqpNome').value = '';
      document.getElementById('adminEqpTipo').value = 'LogÃ­stica';
      document.getElementById('adminEqpEstado').value = 'Ativo';
      document.getElementById('adminEqpResponsavel').value = '';
      document.getElementById('adminEqpArmazem').value = '';
      document.getElementById('adminEqpObservacoes').value = '';
      adminEquipasCarregarMembros([]);
      document.getElementById('adminEqpModalTitulo').textContent = 'ğŸ‘¥ Nova Equipa';
      document.getElementById('adminEqpModal').classList.add('active');
    }
    
    function adminEquipasCarregarMembros(selecionados) {
      var container = document.getElementById('adminEqpMembrosLista');
      container.innerHTML = adminUtilizadores.filter(function(u) { return u.estado === 'Ativo'; }).map(function(u) {
        var checked = selecionados.includes(u.username) ? 'checked' : '';
        return '<div class="admin-checkbox-item">' +
          '<input type="checkbox" id="eqp_member_' + u.username + '" value="' + u.username + '" ' + checked + ' onchange="adminEquipasAtualizarResponsavel()">' +
          '<label for="eqp_member_' + u.username + '">' + u.nome + '</label>' +
        '</div>';
      }).join('');
      
      // Atualizar o select de responsÃ¡vel com os membros selecionados
      adminEquipasAtualizarResponsavel();
    }
    
    function adminEquipasAtualizarResponsavel() {
      var membrosSelecionados = [];
      document.querySelectorAll('#adminEqpMembrosLista input[type="checkbox"]:checked').forEach(function(cb) {
        membrosSelecionados.push(cb.value);
      });
      
      var selectResponsavel = document.getElementById('adminEqpResponsavel');
      var valorAtual = selectResponsavel.value;
      
      selectResponsavel.innerHTML = '<option value="">-- Selecionar --</option>' + 
        membrosSelecionados.map(function(username) {
          var usr = adminUtilizadores.find(function(u) { return u.username === username; });
          return usr ? '<option value="' + usr.username + '">' + usr.nome + '</option>' : '';
        }).join('');
      
      // Manter o valor selecionado se ainda estiver disponÃ­vel
      if (membrosSelecionados.includes(valorAtual)) {
        selectResponsavel.value = valorAtual;
      }
    }
    
    function adminEquipasEditar(id) {
      var eqp = adminEquipas.find(function(e) { return e.id === id; });
      if (!eqp) return;
      
      document.getElementById('adminEqpId').value = eqp.id;
      document.getElementById('adminEqpCodigo').value = eqp.codigo;
      document.getElementById('adminEqpNome').value = eqp.nome;
      document.getElementById('adminEqpTipo').value = eqp.tipo;
      document.getElementById('adminEqpEstado').value = eqp.estado;
      document.getElementById('adminEqpResponsavel').value = eqp.responsavel || '';
      document.getElementById('adminEqpArmazem').value = eqp.armazem || '';
      document.getElementById('adminEqpObservacoes').value = eqp.observacoes || '';
      adminEquipasCarregarMembros(eqp.membros || []);
      document.getElementById('adminEqpModalTitulo').textContent = 'ğŸ‘¥ Editar Equipa';
      document.getElementById('adminEqpModal').classList.add('active');
    }
    
    function adminEquipasGuardar() {
      var codigo = document.getElementById('adminEqpCodigo').value.trim();
      var nome = document.getElementById('adminEqpNome').value.trim();
      var tipo = document.getElementById('adminEqpTipo').value;
      var estado = document.getElementById('adminEqpEstado').value;
      
      if (!codigo || !nome) {
        alert('âš ï¸ Preencha os campos obrigatÃ³rios: CÃ³digo e Nome');
        return;
      }
      
      // Obter membros selecionados
      var membros = [];
      document.querySelectorAll('#adminEqpMembrosLista input[type="checkbox"]:checked').forEach(function(cb) {
        membros.push(cb.value);
      });
      
      var id = document.getElementById('adminEqpId').value;
      var dados = {
        id: id || adminGerarId(),
        codigo: codigo,
        nome: nome,
        tipo: tipo,
        estado: estado,
        responsavel: document.getElementById('adminEqpResponsavel').value,
        armazem: document.getElementById('adminEqpArmazem').value,
        membros: membros,
        observacoes: document.getElementById('adminEqpObservacoes').value.trim()
      };
      
      if (id) {
        var idx = adminEquipas.findIndex(function(e) { return e.id === id; });
        if (idx >= 0) adminEquipas[idx] = dados;
      } else {
        adminEquipas.push(dados);
      }
      
      adminSalvarDados();
      adminEquipasFecharModal();
      adminEquipasRenderizar();
      alert('âœ… Equipa guardada com sucesso!');
    }
    
    function adminEquipasEliminar(id) {
      if (!confirm('âš ï¸ Tem certeza que deseja eliminar esta equipa?')) return;
      adminEquipas = adminEquipas.filter(function(e) { return e.id !== id; });
      adminSalvarDados();
      adminEquipasRenderizar();
      alert('âœ… Equipa eliminada!');
    }
    
    function adminEquipasVerMembros(id) {
      var eqp = adminEquipas.find(function(e) { return e.id === id; });
      if (!eqp || !eqp.membros || eqp.membros.length === 0) {
        alert('Esta equipa nÃ£o tem membros.');
        return;
      }
      
      var membrosNomes = eqp.membros.map(function(username) {
        var usr = adminUtilizadores.find(function(u) { return u.username === username; });
        return usr ? usr.nome : username;
      }).join('\nâ€¢ ');
      
      alert('ğŸ‘¥ Membros da equipa "' + eqp.nome + '":\n\nâ€¢ ' + membrosNomes);
    }
    
    function adminEquipasFecharModal() {
      document.getElementById('adminEqpModal').classList.remove('active');
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ROTAS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    function adminRotasRenderizar() {
      var tbody = document.getElementById('adminRotTabelaBody');
      var filtrados = adminRotasFiltrados();
      
      // KPIs
      document.getElementById('adminRotKpiTotal').textContent = adminRotas.length;
      document.getElementById('adminRotKpiNacionais').textContent = adminRotas.filter(function(r) { return r.tipo === 'Nacional'; }).length;
      document.getElementById('adminRotKpiInternacionais').textContent = adminRotas.filter(function(r) { return r.tipo === 'Internacional'; }).length;
      
      // Contador
      document.getElementById('adminRotContador').textContent = filtrados.length + ' registos';
      
      // Tabela
      if (filtrados.length === 0) {
        tbody.innerHTML = '';
        document.getElementById('adminRotEmpty').style.display = 'block';
        document.getElementById('adminRotTabela').style.display = 'none';
        return;
      }
      
      document.getElementById('adminRotEmpty').style.display = 'none';
      document.getElementById('adminRotTabela').style.display = 'table';
      
      tbody.innerHTML = filtrados.map(function(r) {
        var estadoBadge = r.estado === 'Ativo' ? 'admin-badge-ativo' : 'admin-badge-inativo';
        var estadoIcon = r.estado === 'Ativo' ? 'âœ…' : 'â¸ï¸';
        var tipoBadge = r.tipo === 'Nacional' ? 'admin-badge-nacional' : 'admin-badge-internacional';
        var tipoIcon = r.tipo === 'Nacional' ? 'ğŸ‡µğŸ‡¹' : 'ğŸŒ';
        
        return '<tr>' +
          '<td><strong>' + r.codigo + '</strong></td>' +
          '<td>' + r.nome + '</td>' +
          '<td>' + r.origem + '</td>' +
          '<td>' + r.destino + '</td>' +
          '<td>' + r.km + ' km</td>' +
          '<td>' + (r.precoKm ? r.precoKm + ' â‚¬' : '-') + '</td>' +
          '<td>' + (r.tempo || '-') + '</td>' +
          '<td><span class="admin-badge ' + tipoBadge + '">' + tipoIcon + ' ' + r.tipo + '</span></td>' +
          '<td><span class="admin-badge ' + estadoBadge + '">' + estadoIcon + ' ' + r.estado + '</span></td>' +
          '<td class="admin-actions">' +
            '<button class="admin-btn-action admin-btn-edit" onclick="adminRotasEditar(\'' + r.id + '\')" title="Editar">âœï¸</button>' +
            '<button class="admin-btn-action admin-btn-delete" onclick="adminRotasEliminar(\'' + r.id + '\')" title="Eliminar">ğŸ—‘ï¸</button>' +
          '</td>' +
        '</tr>';
      }).join('');
    }
    
    function adminRotasFiltrados() {
      var pesquisa = (document.getElementById('adminRotPesquisa').value || '').toLowerCase();
      var estado = document.getElementById('adminRotFiltroEstado').value;
      var tipo = document.getElementById('adminRotFiltroTipo').value;
      
      return adminRotas.filter(function(r) {
        var matchPesquisa = !pesquisa || 
          r.codigo.toLowerCase().includes(pesquisa) ||
          r.nome.toLowerCase().includes(pesquisa) ||
          r.origem.toLowerCase().includes(pesquisa) ||
          r.destino.toLowerCase().includes(pesquisa);
        var matchEstado = !estado || r.estado === estado;
        var matchTipo = !tipo || r.tipo === tipo;
        return matchPesquisa && matchEstado && matchTipo;
      });
    }
    
    function adminRotasFiltrar() {
      adminRotasRenderizar();
    }
    
    function adminRotasNovo() {
      document.getElementById('adminRotId').value = '';
      document.getElementById('adminRotCodigo').value = 'ROT' + String(adminRotas.length + 1).padStart(3, '0');
      document.getElementById('adminRotNome').value = '';
      document.getElementById('adminRotOrigem').value = '';
      document.getElementById('adminRotDestino').value = '';
      document.getElementById('adminRotKm').value = '';
      document.getElementById('adminRotTempo').value = '';
      document.getElementById('adminRotPrecoKm').value = '';
      document.getElementById('adminRotPrecoFixo').value = '';
      document.getElementById('adminRotTipo').value = 'Nacional';
      document.getElementById('adminRotEstado').value = 'Ativo';
      document.getElementById('adminRotPontos').value = '';
      document.getElementById('adminRotObservacoes').value = '';
      document.getElementById('adminRotModalTitulo').textContent = 'ğŸ›£ï¸ Nova Rota';
      document.getElementById('adminRotModal').classList.add('active');
    }
    
    function adminRotasEditar(id) {
      var rot = adminRotas.find(function(r) { return r.id === id; });
      if (!rot) return;
      
      document.getElementById('adminRotId').value = rot.id;
      document.getElementById('adminRotCodigo').value = rot.codigo;
      document.getElementById('adminRotNome').value = rot.nome;
      document.getElementById('adminRotOrigem').value = rot.origem;
      document.getElementById('adminRotDestino').value = rot.destino;
      document.getElementById('adminRotKm').value = rot.km;
      document.getElementById('adminRotTempo').value = rot.tempo || '';
      document.getElementById('adminRotPrecoKm').value = rot.precoKm || '';
      document.getElementById('adminRotPrecoFixo').value = rot.precoFixo || '';
      document.getElementById('adminRotTipo').value = rot.tipo;
      document.getElementById('adminRotEstado').value = rot.estado;
      document.getElementById('adminRotPontos').value = rot.pontos || '';
      document.getElementById('adminRotObservacoes').value = rot.observacoes || '';
      document.getElementById('adminRotModalTitulo').textContent = 'ğŸ›£ï¸ Editar Rota';
      document.getElementById('adminRotModal').classList.add('active');
    }
    
    function adminRotasGuardar() {
      var codigo = document.getElementById('adminRotCodigo').value.trim();
      var nome = document.getElementById('adminRotNome').value.trim();
      var origem = document.getElementById('adminRotOrigem').value.trim();
      var destino = document.getElementById('adminRotDestino').value.trim();
      var km = document.getElementById('adminRotKm').value;
      var tipo = document.getElementById('adminRotTipo').value;
      var estado = document.getElementById('adminRotEstado').value;
      
      if (!codigo || !nome || !origem || !destino || !km) {
        alert('âš ï¸ Preencha os campos obrigatÃ³rios: CÃ³digo, Nome, Origem, Destino e Km');
        return;
      }
      
      var id = document.getElementById('adminRotId').value;
      var dados = {
        id: id || adminGerarId(),
        codigo: codigo,
        nome: nome,
        origem: origem,
        destino: destino,
        km: parseFloat(km),
        tempo: document.getElementById('adminRotTempo').value.trim(),
        precoKm: parseFloat(document.getElementById('adminRotPrecoKm').value) || 0,
        precoFixo: parseFloat(document.getElementById('adminRotPrecoFixo').value) || 0,
        tipo: tipo,
        estado: estado,
        pontos: document.getElementById('adminRotPontos').value.trim(),
        observacoes: document.getElementById('adminRotObservacoes').value.trim()
      };
      
      if (id) {
        var idx = adminRotas.findIndex(function(r) { return r.id === id; });
        if (idx >= 0) adminRotas[idx] = dados;
      } else {
        adminRotas.push(dados);
      }
      
      adminSalvarDados();
      adminRotasFecharModal();
      adminRotasRenderizar();
      alert('âœ… Rota guardada com sucesso!');
    }
    
    function adminRotasEliminar(id) {
      if (!confirm('âš ï¸ Tem certeza que deseja eliminar esta rota?')) return;
      adminRotas = adminRotas.filter(function(r) { return r.id !== id; });
      adminSalvarDados();
      adminRotasRenderizar();
      alert('âœ… Rota eliminada!');
    }
    
    function adminRotasFecharModal() {
      document.getElementById('adminRotModal').classList.remove('active');
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // PERMISSÃ•ES
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    function adminPermissoesRenderizar() {
      // Carregar mÃ³dulos
      var modulosHtml = adminModulosConfig.map(function(m) {
        return '<div class="admin-perm-item">' +
          '<input type="checkbox" id="perm_mod_' + m.id + '" value="' + m.id + '">' +
          '<span>' + m.nome + '</span>' +
        '</div>';
      }).join('');
      document.getElementById('adminPermModulos').innerHTML = modulosHtml;
      
      // Carregar aÃ§Ãµes
      var acoesHtml = adminAcoesConfig.map(function(a) {
        return '<div class="admin-perm-item">' +
          '<input type="checkbox" id="perm_acao_' + a.id + '" value="' + a.id + '">' +
          '<span>' + a.nome + '</span>' +
        '</div>';
      }).join('');
      document.getElementById('adminPermAcoes').innerHTML = acoesHtml;
      
      // Carregar utilizadores
      var usersHtml = '<option value="">-- Selecionar utilizador --</option>' + 
        adminUtilizadores.map(function(u) {
          return '<option value="' + u.id + '">' + u.nome + ' (' + u.perfil + ')</option>';
        }).join('');
      document.getElementById('adminPermUserSelect').innerHTML = usersHtml;
      
      // MÃ³dulos e aÃ§Ãµes para utilizadores
      document.getElementById('adminPermUserModulos').innerHTML = modulosHtml.replace(/perm_mod_/g, 'perm_user_mod_');
      document.getElementById('adminPermUserAcoes').innerHTML = acoesHtml.replace(/perm_acao_/g, 'perm_user_acao_');
      
      // Carregar permissÃµes do perfil selecionado
      adminPermissoesCarregarPerfil();
    }
    
    function adminPermissoesTab(tab) {
      document.querySelectorAll('.admin-tab').forEach(function(t) { t.classList.remove('active'); });
      document.querySelectorAll('.admin-tab-content').forEach(function(c) { c.classList.remove('active'); });
      
      if (tab === 'perfis') {
        document.querySelector('.admin-tab:nth-child(1)').classList.add('active');
        document.getElementById('adminPermTabPerfis').classList.add('active');
      } else {
        document.querySelector('.admin-tab:nth-child(2)').classList.add('active');
        document.getElementById('adminPermTabUtilizadores').classList.add('active');
      }
    }
    
    function adminPermissoesCarregarPerfil() {
      var perfil = document.getElementById('adminPermPerfilSelect').value;
      var perms = adminPermissoesPorPerfilCustom[perfil] || { modulos: [], acoes: [] };
      
      // Marcar mÃ³dulos
      document.querySelectorAll('#adminPermModulos input').forEach(function(cb) {
        cb.checked = perms.modulos.includes('*') || perms.modulos.includes(cb.value);
      });
      
      // Marcar aÃ§Ãµes
      document.querySelectorAll('#adminPermAcoes input').forEach(function(cb) {
        cb.checked = perms.acoes.includes('*') || perms.acoes.includes(cb.value);
      });
    }
    
    function adminPermissoesCarregarUser() {
      var userId = document.getElementById('adminPermUserSelect').value;
      if (!userId) {
        document.getElementById('adminPermUserPerfil').textContent = '';
        return;
      }
      
      var user = adminUtilizadores.find(function(u) { return u.id === userId; });
      if (!user) return;
      
      document.getElementById('adminPermUserPerfil').textContent = 'Perfil base: ' + user.perfil;
      
      // Carregar permissÃµes customizadas do utilizador
      var customPerms = adminPermissoesCustom[userId] || { modulos: [], acoes: [] };
      
      // Marcar mÃ³dulos
      document.querySelectorAll('#adminPermUserModulos input').forEach(function(cb) {
        cb.checked = customPerms.modulos.includes(cb.value);
      });
      
      // Marcar aÃ§Ãµes
      document.querySelectorAll('#adminPermUserAcoes input').forEach(function(cb) {
        cb.checked = customPerms.acoes.includes(cb.value);
      });
    }
    
    function adminPermissoesSalvarTudo() {
      // Salvar permissÃµes do perfil
      var perfil = document.getElementById('adminPermPerfilSelect').value;
      var modulos = [];
      var acoes = [];
      
      document.querySelectorAll('#adminPermModulos input:checked').forEach(function(cb) {
        modulos.push(cb.value);
      });
      document.querySelectorAll('#adminPermAcoes input:checked').forEach(function(cb) {
        acoes.push(cb.value);
      });
      
      adminPermissoesPorPerfilCustom[perfil] = { modulos: modulos, acoes: acoes };
      
      // Salvar permissÃµes do utilizador
      var userId = document.getElementById('adminPermUserSelect').value;
      if (userId) {
        var userModulos = [];
        var userAcoes = [];
        
        document.querySelectorAll('#adminPermUserModulos input:checked').forEach(function(cb) {
          userModulos.push(cb.value);
        });
        document.querySelectorAll('#adminPermUserAcoes input:checked').forEach(function(cb) {
          userAcoes.push(cb.value);
        });
        
        adminPermissoesCustom[userId] = { modulos: userModulos, acoes: userAcoes };
      }
      
      adminSalvarDados();
      alert('âœ… PermissÃµes guardadas com sucesso!');
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // INICIALIZAÃ‡ÃƒO AO NAVEGAR
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    // Adicionar dados de exemplo se estiver vazio
    function adminInicializarDadosExemplo() {
      if (adminArmazens.length === 0) {
        adminArmazens = [
          { id: adminGerarId(), codigo: 'ARM001', nome: 'ArmazÃ©m Central Lisboa', morada: 'Rua Industrial, 100', codigoPostal: '2695-000', localidade: 'Bobadela', pais: 'Portugal', capacidade: 5000, telefone: '+351 219 000 001', responsavel: 'JoÃ£o Silva', estado: 'Ativo', horario: 'Seg-Sex 08:00-18:00' },
          { id: adminGerarId(), codigo: 'ARM002', nome: 'ArmazÃ©m Norte Porto', morada: 'Zona Industrial Maia, Lote 25', codigoPostal: '4470-000', localidade: 'Maia', pais: 'Portugal', capacidade: 3500, telefone: '+351 229 000 002', responsavel: 'Maria Santos', estado: 'Ativo', horario: 'Seg-Sex 07:00-19:00' },
          { id: adminGerarId(), codigo: 'ARM003', nome: 'ArmazÃ©m Madrid', morada: 'PolÃ­gono Industrial San Fernando, Nave 12', codigoPostal: '28830', localidade: 'Madrid', pais: 'Espanha', capacidade: 4000, telefone: '+34 91 000 0003', responsavel: 'Carlos GarcÃ­a', estado: 'Ativo', horario: 'Lun-Vie 06:00-22:00' }
        ];
      }
      
      if (adminRotas.length === 0) {
        adminRotas = [
          { id: adminGerarId(), codigo: 'ROT001', nome: 'Lisboa - Porto', origem: 'Lisboa', destino: 'Porto', km: 315, precoKm: 1.20, precoFixo: 0, tempo: '3h00', tipo: 'Nacional', estado: 'Ativo', pontos: 'Coimbra, Aveiro' },
          { id: adminGerarId(), codigo: 'ROT002', nome: 'Lisboa - Madrid', origem: 'Lisboa', destino: 'Madrid', km: 625, precoKm: 1.35, precoFixo: 50, tempo: '6h00', tipo: 'Internacional', estado: 'Ativo', pontos: 'Badajoz' },
          { id: adminGerarId(), codigo: 'ROT003', nome: 'Porto - Barcelona', origem: 'Porto', destino: 'Barcelona', km: 1100, precoKm: 1.30, precoFixo: 100, tempo: '11h00', tipo: 'Internacional', estado: 'Ativo', pontos: 'Madrid, Zaragoza' }
        ];
      }
      
      adminSalvarDados();
    }
    
    // Hook para navegarPara
    var adminOriginalNavegarPara = typeof navegarPara === 'function' ? navegarPara : null;
    
    function adminHookNavegarPara(pagina) {
      // Chamar funÃ§Ã£o original se existir
      if (adminOriginalNavegarPara) {
        adminOriginalNavegarPara(pagina);
      }
      
      // Inicializar mÃ³dulos de administraÃ§Ã£o
      setTimeout(function() {
        switch(pagina) {
          case 'armazens':
            adminInicializarDadosExemplo();
            adminArmazensRenderizar();
            break;
          case 'utilizadores':
            adminUtilizadoresRenderizar();
            break;
          case 'comerciais':
            adminComerciaisRenderizar();
            break;
          case 'equipas':
            adminEquipasRenderizar();
            break;
          case 'rotas':
            adminInicializarDadosExemplo();
            adminRotasRenderizar();
            break;
          case 'permissoes':
            adminPermissoesRenderizar();
            break;
        }
      }, 100);
    }
    
    // Substituir funÃ§Ã£o navegarPara
    if (typeof navegarPara !== 'undefined') {
      var _navegarParaOriginal = navegarPara;
      navegarPara = function(pagina) {
        _navegarParaOriginal(pagina);
        adminHookNavegarPara(pagina);
      };
    }
    
    // Inicializar dados de exemplo ao carregar
    document.addEventListener('DOMContentLoaded', function() {
      adminInicializarDadosExemplo();
    });
    
    console.log('âœ… MÃ³dulo de AdministraÃ§Ã£o v6.1 carregado');
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // FIM MÃ“DULO ADMINISTRAÃ‡ÃƒO v6.1
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•



    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // SISTEMA DE TROCA DE PASSWORD OBRIGATÃ“RIA
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    var portalUtilizadorPendenteTroca = null;
    
    function portalToggleNovaPassword(num) {
      var input = document.getElementById('portalNovaPassword' + num);
      input.type = input.type === 'password' ? 'text' : 'password';
    }
    
    function portalMostrarTrocarPassword(user) {
      portalUtilizadorPendenteTroca = user;
      document.getElementById('portalNovaPassword1').value = '';
      document.getElementById('portalNovaPassword2').value = '';
      document.getElementById('portalTrocarPasswordErro').style.display = 'none';
      document.getElementById('portalLoginScreen').classList.add('portal-hidden');
      document.getElementById('portalTrocarPasswordModal').style.display = 'flex';
      document.getElementById('portalNovaPassword1').focus();
    }
    
    function portalConfirmarNovaPassword() {
      var password1 = document.getElementById('portalNovaPassword1').value;
      var password2 = document.getElementById('portalNovaPassword2').value;
      var erroDiv = document.getElementById('portalTrocarPasswordErro');
      
      // ValidaÃ§Ãµes
      if (!password1 || !password2) {
        erroDiv.textContent = 'âš ï¸ Preencha os dois campos de password.';
        erroDiv.style.display = 'block';
        return;
      }
      
      if (password1.length < 6) {
        erroDiv.textContent = 'âš ï¸ A password deve ter pelo menos 6 caracteres.';
        erroDiv.style.display = 'block';
        return;
      }
      
      if (password1 !== password2) {
        erroDiv.textContent = 'âš ï¸ As passwords nÃ£o coincidem.';
        erroDiv.style.display = 'block';
        return;
      }
      
      if (!portalUtilizadorPendenteTroca) {
        erroDiv.textContent = 'âš ï¸ Erro interno. Tente fazer login novamente.';
        erroDiv.style.display = 'block';
        return;
      }
      
      // Atualizar a password do utilizador no localStorage
      var utilizadores = JSON.parse(localStorage.getItem('erpUtilizadores') || '[]');
      var idx = utilizadores.findIndex(function(u) { return u.id === portalUtilizadorPendenteTroca.id; });
      
      if (idx >= 0) {
        utilizadores[idx].password = password1;
        utilizadores[idx].passwordTrocada = true;
        utilizadores[idx].dataTrocaPassword = new Date().toISOString();
        utilizadores[idx].passwordAnterior = portalUtilizadorPendenteTroca.password; // Guardar a password original
        localStorage.setItem('erpUtilizadores', JSON.stringify(utilizadores));
        
        // Atualizar tambÃ©m a variÃ¡vel global do admin
        if (typeof adminUtilizadores !== 'undefined') {
          adminUtilizadores = utilizadores;
        }
        
        // Fechar modal e fazer login
        document.getElementById('portalTrocarPasswordModal').style.display = 'none';
        
        // Atualizar o utilizador atual com a nova password
        portalUtilizadorPendenteTroca.password = password1;
        portalUtilizadorPendenteTroca.passwordTrocada = true;
        
        // Completar o login
        portalUtilizadorAtual = portalUtilizadorPendenteTroca;
        portalUtilizadorPendenteTroca = null;
        
        // Guardar sessÃ£o
        var sessao = {
          user: portalUtilizadorAtual,
          idioma: portalIdiomaAtual,
          timestamp: Date.now()
        };
        localStorage.setItem('erpSessaoPortal', JSON.stringify(sessao));
        
        alert('âœ… Password alterada com sucesso!\n\nBem-vindo(a), ' + portalUtilizadorAtual.nome + '!');
        portalMostrarERP();
      } else {
        erroDiv.textContent = 'âš ï¸ Utilizador nÃ£o encontrado. Contacte o administrador.';
        erroDiv.style.display = 'block';
      }
    }
    

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // FIM PORTAL CENTRAL v6.0
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  </script>
  
  </div><!-- Fim portalErpContainer -->
  
</body>
</html>
